function Set_Eff_Text(id, txwz, str)
if str == nil then
str = ""
end
	if WAR.Person[id][txwz] ~= nil then
	    str = "+"..str
		WAR.Person[id][txwz] = WAR.Person[id][txwz]..str
	else
		WAR.Person[id][txwz] = str
	end
end

--返回两人之间的实际距离
function War_realjl(ida, idb)
	if ida == nil then
		ida = WAR.CurID
	end
	CleanWarMap(3, 255)
	local x = WAR.Person[ida]["坐标X"]
	local y = WAR.Person[ida]["坐标Y"]
	local steparray = {}
	steparray[0] = {}
	steparray[0].bushu = {}
	steparray[0].x = {}
	steparray[0].y = {}
	SetWarMap(x, y, 3, 0)
	steparray[0].num = 1
	steparray[0].bushu[1] = 0		--还能移动的步数
	steparray[0].x[1] = x
	steparray[0].y[1] = y
	return War_FindNextStep1(steparray, 0, ida, idb)
end

--AI选择目标的函数
function unnamed(kfid)
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local kungfuid = JY.Person[pid]["武功" .. kfid]
	local kungfulv = JY.Person[pid]["武功等级" .. kfid]
	if kungfulv == 999 then
		kungfulv = 11
	else
		kungfulv = math.modf(kungfulv / 100) + 1
	end
	local m1, m2, a1, a2, a3, a4, a5 = refw(kungfuid, kungfulv)
	local mfw = {m1, m2}
	local atkfw = {a1, a2, a3, a4, a5}
	if kungfulv == 11 then
		kungfulv = 10
	end
	--AI也用新的威力判定
	local kungfuatk = get_skill_power(pid, kungfuid, kungfulv)
	local atkarray = {}
	local num = 0
	CleanWarMap(4, -1)
	local movearray = War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
	if pid ~= 596 then
		WarDrawMap(1)
	end
	ShowScreen()

	for i = 0, WAR.Person[WAR.CurID]["移动步数"] do
		local step_num = movearray[i].num
		if step_num ~= nil then
			for j = 1, step_num do
				local xx = movearray[i].x[j]
				local yy = movearray[i].y[j]
				num = num + 1
				atkarray[num] = {}
				atkarray[num].x, atkarray[num].y = xx, yy
				atkarray[num].p, atkarray[num].ax, atkarray[num].ay = GetAtkNum(xx, yy, mfw, atkfw, kungfuatk)
			end
		end
	end
	for i = 1, num - 1 do
		for j = i + 1, num do
			if atkarray[i].p < atkarray[j].p then
				atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
			end
		end
	end
	if atkarray[1].p > 0 then
		for i = 2, num do
			if atkarray[i].p == 0 or atkarray[i].p < atkarray[1].p / 2 then
				num = i - 1
				break;
			end
		end
		for i = 1, num do
			if WAR.Person[WAR.CurID]["我方"] == true then
				--flag: approach enemies.
				atkarray[i].p = atkarray[i].p + GetMovePoint(atkarray[i].x, atkarray[i].y)
			else
				--flag: aviod enemies. avoiding as many enemies as possible while retaining targeting the spot with higher threat
				atkarray[i].p = atkarray[i].p + GetMovePoint(atkarray[i].x, atkarray[i].y, 1)
			end
		end
		for i = 1, num - 1 do
			for j = i + 1, num do
				if atkarray[i].p < atkarray[j].p then
					atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
				elseif atkarray[i].p == atkarray[j].p and math.random(2) > 1 then
					atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
				end
			end
		end
		for i = 2, num do
			if atkarray[i].p < atkarray[1].p *4/5 then
				num = i - 1
				break;
			end
		end
		
		local select = 1
		
		War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
		War_MovePerson(atkarray[select].x, atkarray[select].y)
		War_Fight_Sub(WAR.CurID, kfid, atkarray[select].ax, atkarray[select].ay)
		--阿凡提攻击完躲开
		if pid == 606 then
			WAR.Person[WAR.CurID]["移动步数"] = 10
			War_AutoEscape()
			War_RestMenu()
		end
	else
		--葵花尊者，打不到人会瞬移
		if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and pid == 27 and kuihuameiying() then
			unnamed(kfid)
		else
			--打不到人，考虑吃药
			local jl, nx, ny = War_realjl()
			AutoMove()
			--默认为休息
			local what_to_do = 0
			local can_eat_drug = 0
			--非我方，会考虑吃药
			if WAR.Person[WAR.CurID]["我方"] == false then
				can_eat_drug = 1
			--如果是我方，只有在队且允许才会吃药
			else
				if inteam(pid) and JY.Person[pid]["是否吃药"] == 1 then
					can_eat_drug = 1
				end
			end
			--侠客正岛主战不吃药
			--洪七公居洪七公不吃药
			if WAR.Person[WAR.CurID]["我方"] == false and (WAR.ZDDH == 188 or WAR.ZDDH == 257) then
				can_eat_drug = 0
			end
			--左右第二下，不能吃药
			if WAR.ZYHB == 2 or WAR.CLBF == 2 or WAR.HSSD == 2 or WAR.XFXY == 1 then
				can_eat_drug = 0
			end
			--1:吃体力药 2：吃血 3：医疗 4：吃内力 5：吃解毒
			if can_eat_drug == 1 then
				local r = -1
				--体力低于10，吃体力药
				if JY.Person[pid]["体力"] < 10 then
					r = War_ThinkDrug(4)
					if r >= 0 then
						what_to_do = 1
					end
				end
				local rate = -1
				if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 5 then
					rate = 90
				elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 4 then
					rate = 70
				elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 3 then
					rate = 50
				elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 then
					rate = 25
				end
				--内伤也增加吃血药几率
				if JY.Person[pid]["受伤程度"] > 50 then
					rate = rate + 50
				end
				if Rnd(100) < rate then
					r = War_ThinkDrug(2)
					if r >= 0 then				--如果有药吃药
						what_to_do = 2
					else
						r = War_ThinkDoctor()		--如果没有药，考虑医疗
						if r >= 0 then
							what_to_do = 3
						end
					end
				end
				--考虑内力
				rate = -1
				if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 6 then
					rate = 100
				elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 5 then
					rate = 75
				elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 4 then
					rate = 50
				end
				if Rnd(100) < rate then
					r = War_ThinkDrug(3)
					if r >= 0 then
						what_to_do = 4
					end
				end
				rate = -1
				if CC.PersonAttribMax["中毒程度"] * 3 / 4 < JY.Person[pid]["中毒程度"] then
					rate = 60
				else
					if CC.PersonAttribMax["中毒程度"] / 2 < JY.Person[pid]["中毒程度"] then
						rate = 30
					end
				end
				--半血以下，才吃解毒药
				if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 and Rnd(100) < rate then
					r = War_ThinkDrug(6)
					if r >= 0 then
						what_to_do = 5
					end
				end
			end
			--吃药flag 2：生命 3：内力 4：体力 6：解毒
			if what_to_do == 0 then
				War_RestMenu()
			elseif what_to_do == 1 then
				War_AutoEatDrug(4)
			elseif what_to_do == 2 then
				War_AutoEatDrug(2)
			elseif what_to_do == 3 then
				War_AutoDoctor()
			elseif what_to_do == 4 then
				War_AutoEatDrug(3)
			elseif what_to_do == 5 then
				War_AutoEatDrug(6)
			end
		end
	end
end

function AutoMove()
	local x, y = nil, nil
	local minDest = math.huge
	local enemyid=War_AutoSelectEnemy()   --选择最近敌人

	War_CalMoveStep(WAR.CurID,100,0);   --计算移动步数 假设最大100步

	for i=0,CC.WarWidth-1 do
		for j=0,CC.WarHeight-1 do
			local dest=GetWarMap(i,j,3);
			if dest <128 then
				local dx=math.abs(i-WAR.Person[enemyid]["坐标X"])
				local dy=math.abs(j-WAR.Person[enemyid]["坐标Y"])
				if minDest>(dx+dy) then        --此时x,y是距离敌人的最短路径，虽然可能被围住
					minDest=dx+dy;
					x=i;
					y=j;
				elseif minDest==(dx+dy) then
					if Rnd(2)==0 then
						x=i;
						y=j;
					end
				end
			end
		end
	end

	if minDest<math.huge then   --有路可走
	    while true do    --从目的位置反着找到可以移动的位置，作为移动的次序
			local i=GetWarMap(x,y,3);
			if i<=WAR.Person[WAR.CurID]["移动步数"] then
				break;
			end

			if GetWarMap(x-1,y,3)==i-1 then
				x=x-1;
			elseif GetWarMap(x+1,y,3)==i-1 then
				x=x+1;
			elseif GetWarMap(x,y-1,3)==i-1 then
				y=y-1;
			elseif GetWarMap(x,y+1,3)==i-1 then
				y=y+1;
			end
	    end
		War_MovePerson(x,y);    --移动到相应的位置
	end
end

function GetMovePoint(x, y, flag)
	local point = 0
	local wofang = WAR.Person[WAR.CurID]["我方"]
	local movearray = MY_CalMoveStep(x, y, 16, 1)
	for i = 1, 16 do
		local step_num = movearray[i].num
		if step_num ~= nil then
			if step_num == 0 then
				break;
			end
			for j = 1, step_num do
				local xx = movearray[i].x[j]
				local yy = movearray[i].y[j]
				local v = GetWarMap(xx, yy, 2)
				if v ~= -1 then
					if v == WAR.CurID then
						break;
					else   
						if WAR.Person[v]["我方"] == wofang then
							point = point + i * 2 - 26
						elseif WAR.Person[v]["我方"] ~= wofang then
							if flag ~= nil then
								point = point + i - 17
							else
								point = point + 26 - i
							end
						end
					end
				end
			end
		end
	end
	return point
end

function MY_CalMoveStep(x, y, stepmax, flag)
	CleanWarMap(3, 255)
	local steparray = {}
	for i = 0, stepmax do
		steparray[i] = {}
		steparray[i].bushu = {}
		steparray[i].x = {}
		steparray[i].y = {}
	end
	SetWarMap(x, y, 3, 0)
	steparray[0].num = 1
	steparray[0].bushu[1] = stepmax
	steparray[0].x[1] = x
	steparray[0].y[1] = y
	War_FindNextStep(steparray, 0, flag)
	return steparray
end

function GetAtkNum(x, y, movfw, atkfw, atk)
  local point = {}
  local num = 0
  local kind, len = movfw[1], movfw[2]
  
  if kind == 0 then
    local array = MY_CalMoveStep(x, y, len, 1)
    for i = 0, len do
      local step_num = array[i].num
      if step_num ~= nil then
        if step_num == 0 then
          break;
        end
	      for j = 1, step_num do
	        num = num + 1
	        point[num] = {array[i].x[j], array[i].y[j]}
	      end
	    end
    end
  elseif kind == 1 then
    local array = MY_CalMoveStep(x, y, len * 2, 1)
    for r = 1, len * 2 do
      for i = 0, r do
        local j = r - i
        if len < i or len < j then
          SetWarMap(x + i, y + j, 3, 255)
          SetWarMap(x + i, y - j, 3, 255)
          SetWarMap(x - i, y + j, 3, 255)
          SetWarMap(x - i, y - j, 3, 255)
        end
      end
    end
    for i = 0, len do
      local step_num = array[i].num
      if step_num ~= nil then
        if step_num == 0 then
          break;
        end
	      for j = 1, step_num do
	        if GetWarMap(array[i].x[j], array[i].y[j], 3) < 128 then
	          num = num + 1
	          point[num] = {array[i].x[j], array[i].y[j]}
	        end
	      end
	    end
    end
  elseif kind == 2 then
    if not len then
      len = 1
    end
    for i = 1, len do
      if x + i < CC.WarWidth - 1 and GetWarMap(x + i, y, 1) > 0 and CC.WarWater[GetWarMap(x + i, y, 0)] == nil then
        break;
      end
      num = num + 1
      point[num] = {x + i, y}
    end
    for i = 1, len do
      if x - i > 0 and GetWarMap(x - i, y, 1) > 0 and CC.WarWater[GetWarMap(x - i, y, 0)] == nil then
        break;
      end
      num = num + 1
      point[num] = {x - i, y}
    end
    for i = 1, len do
      if y + i < CC.WarHeight - 1 and GetWarMap(x, y + i, 1) > 0 and CC.WarWater[GetWarMap(x, y + i, 0)] == nil then
        break;
      end
      num = num + 1
      point[num] = {x, y + i}
    end
    for i = 1, len do
      if y - i > 0 and GetWarMap(x, y - i, 1) > 0 and CC.WarWater[GetWarMap(x, y - i, 0)] == nil then
        break;
      end
      num = num + 1
      point[num] = {x, y - i}
    end
  elseif kind == 3 then
    if x + 1 < CC.WarWidth - 1 and GetWarMap(x + 1, y, 1) == 0 and CC.WarWater[GetWarMap(x + 1, y, 0)] == nil then
      num = num + 1
      point[num] = {x + 1, y}
    end
    if x - 1 > 0 and GetWarMap(x - 1, y, 1) == 0 and CC.WarWater[GetWarMap(x - 1, y, 0)] == nil then
      num = num + 1
      point[num] = {x - 1, y}
    end
    if y + 1 < CC.WarHeight - 1 and GetWarMap(x, y + 1, 1) == 0 and CC.WarWater[GetWarMap(x, y + 1, 0)] == nil then
      num = num + 1
      point[num] = {x, y + 1}
    end
    if y - 1 > 0 and GetWarMap(x, y - 1, 1) == 0 and CC.WarWater[GetWarMap(x, y - 1, 0)] == nil then
      num = num + 1
      point[num] = {x, y - 1}
    end
    if x + 1 < CC.WarWidth - 1 and y + 1 < CC.WarHeight - 1 and GetWarMap(x + 1, y + 1, 1) == 0 and CC.WarWater[GetWarMap(x + 1, y + 1, 0)] == nil then
      num = num + 1
      point[num] = {x + 1, y + 1}
    end
    if x - 1 > 0 and y + 1 < CC.WarHeight - 1 and GetWarMap(x - 1, y + 1, 1) == 0 and CC.WarWater[GetWarMap(x - 1, y + 1, 0)] == nil then
      num = num + 1
      point[num] = {x - 1, y + 1}
    end
    if x + 1 < CC.WarWidth - 1 and y - 1 > 0 and GetWarMap(x + 1, y - 1, 1) == 0 and CC.WarWater[GetWarMap(x + 1, y - 1, 0)] == nil then
      num = num + 1
      point[num] = {x + 1, y - 1}
    end
    if x - 1 > 0 and y - 1 > 0 and GetWarMap(x - 1, y - 1, 1) == 0 and CC.WarWater[GetWarMap(x - 1, y - 1, 0)] == nil then
    	num = num + 1
    	point[num] = {x - 1, y - 1}
  	end
  end
  local maxx, maxy, maxnum, atknum = 0, 0, 0, 0
  

  for i = 1, num do
    atknum = GetWarMap(point[i][1], point[i][2], 4)
    
    if atknum == -1 or atkfw[1] > 9 then
      atknum = WarDrawAtt(point[i][1], point[i][2], atkfw, 2, x, y, atk)
      SetWarMap(point[i][1], point[i][2], 4, atknum)
    end
    if atknum~= nil and maxnum < atknum then
      maxnum, maxx, maxy = atknum, point[i][1], point[i][2]
    end
  end
  
  return maxnum, maxx, maxy
end

function War_FindNextStep1(steparray,step,id,idb)      --设置下一步可移动的坐标
	--被上面的函数调用   
	local num=0;
	local step1=step+1;
	
	steparray[step1]={};
	steparray[step1].bushu={};
	steparray[step1].x={};
	steparray[step1].y={};
	
	local function fujinnum(tx,ty)
		local tnum=0
		local wofang=WAR.Person[id]["我方"]
		local tv;
		tv=GetWarMap(tx+1,ty,2);
		if idb==nil then
			if tv~=-1 then
				if WAR.Person[tv]["我方"]~=wofang then
					return -1
				end
			end
		elseif tv==idb then
			return -1
		end
		if tv~=-1 then
			if WAR.Person[tv]["我方"]~=wofang then
				tnum=tnum+1
			end
		end
		tv=GetWarMap(tx-1,ty,2);
		if idb==nil then
			if tv~=-1 then
				if WAR.Person[tv]["我方"]~=wofang then
					return -1
				end
			end
		elseif tv==idb then
			return -1
		end
		if tv~=-1 then
			if WAR.Person[tv]["我方"]~=wofang then
				tnum=tnum+1
			end
		end
		tv=GetWarMap(tx,ty+1,2);
		if idb==nil then
			if tv~=-1 then
				if WAR.Person[tv]["我方"]~=wofang then
					return -1
				end
			end
		elseif tv==idb then
			return -1
		end
		if tv~=-1 then
			if WAR.Person[tv]["我方"]~=wofang then
				tnum=tnum+1
			end
		end
		tv=GetWarMap(tx,ty-1,2);
		if idb==nil then
			if tv~=-1 then
				if WAR.Person[tv]["我方"]~=wofang then
					return -1
				end
			end
		elseif tv==idb then
			return -1
		end
		if tv~=-1 then
			if WAR.Person[tv]["我方"]~=wofang then
				tnum=tnum+1
			end
		end
		return tnum
	end
	
	for i=1,steparray[step].num do
		--if steparray[step].bushu[i]<128 then
		steparray[step].bushu[i]=steparray[step].bushu[i]+1;
	    local x=steparray[step].x[i];
	    local y=steparray[step].y[i];
	    if x+1<CC.WarWidth-1 then                        --当前步数的相邻格
		    local v=GetWarMap(x+1,y,3);
			if v ==255 and War_CanMoveXY(x+1,y,0)==true then
                num= num+1;
                steparray[step1].x[num]=x+1;
                steparray[step1].y[num]=y;
				SetWarMap(x+1,y,3,step1);
				local mnum=fujinnum(x+1,y);
				if mnum==-1 then 
					return steparray[step].bushu[i],x+1,y
				else
					steparray[step1].bushu[num]=steparray[step].bushu[i]+mnum;
				end
			end
		end

	    if x-1>0 then                        --当前步数的相邻格
		    local v=GetWarMap(x-1,y,3);
			if v ==255 and War_CanMoveXY(x-1,y,0)==true then
                 num=num+1;
                steparray[step1].x[num]=x-1;
                steparray[step1].y[num]=y;
				SetWarMap(x-1,y,3,step1);
				local mnum=fujinnum(x-1,y);
				if mnum==-1 then 
					return steparray[step].bushu[i],x-1,y
				else
					steparray[step1].bushu[num]=steparray[step].bushu[i]+mnum;
				end
			end
		end

	    if y+1<CC.WarHeight-1 then                        --当前步数的相邻格
		    local v=GetWarMap(x,y+1,3);
			if v ==255 and War_CanMoveXY(x,y+1,0)==true then
                 num= num+1;
                steparray[step1].x[num]=x;
                steparray[step1].y[num]=y+1;
				SetWarMap(x,y+1,3,step1);
				local mnum=fujinnum(x,y+1);
				if mnum==-1 then 
					return steparray[step].bushu[i],x,y+1
				else
					steparray[step1].bushu[num]=steparray[step].bushu[i]+mnum;
				end
			end
		end

	    if y-1>0 then                        --当前步数的相邻格
		    local v=GetWarMap(x ,y-1,3);
			if v ==255 and War_CanMoveXY(x,y-1,0)==true then
                num= num+1;
                steparray[step1].x[num]=x ;
                steparray[step1].y[num]=y-1;
				SetWarMap(x ,y-1,3,step1);
				local mnum=fujinnum(x,y-1);
				if mnum==-1 then 
					return steparray[step].bushu[i],x,y-1
				else
					steparray[step1].bushu[num]=steparray[step].bushu[i]+mnum;
				end
			end
		end
		--end
	end
	if num==0 then return -1 end;
    steparray[step1].num=num;
	for i=1,num-1 do
		for j=i+1,num do
			if steparray[step1].bushu[i]>steparray[step1].bushu[j] then
				steparray[step1].bushu[i],steparray[step1].bushu[j]=steparray[step1].bushu[j],steparray[step1].bushu[i]
				steparray[step1].x[i],steparray[step1].x[j]=steparray[step1].x[j],steparray[step1].x[i]
				steparray[step1].y[i],steparray[step1].y[j]=steparray[step1].y[j],steparray[step1].y[i]
			end
		end
	end

	return War_FindNextStep1(steparray,step1,id,idb)
end
--修炼物品
function War_PersonTrainDrug(pid)
	local p = JY.Person[pid]
	local thingid = p["修炼物品"]
	if thingid < 0 then
		return 
	end
	if JY.Thing[thingid]["练出物品需经验"] <= 0 then
		return 
	end
	local needpoint = (7 - math.modf(p["资质"] / 15)) * JY.Thing[thingid]["练出物品需经验"]
	if p["物品修炼点数"] < needpoint then
		return 
	end
	  
	local haveMaterial = 0
	local MaterialNum = -1
	for i = 1, CC.MyThingNum do
		if JY.Base["物品" .. i] == JY.Thing[thingid]["需材料"] then
			haveMaterial = 1
			MaterialNum = JY.Base["物品数量" .. i]
		end
	end
  
	--材料足够
	if haveMaterial == 1 then
		local enough = {}
		local canMake = 0
		for i = 1, 5 do
			if JY.Thing[thingid]["练出物品" .. i] >= 0 and JY.Thing[thingid]["需要物品数量" .. i] <= MaterialNum then
				canMake = 1
				enough[i] = 1
			else
				enough[i] = 0
			end
		end
		--可以练出
		if canMake == 1 then
			local makeID = nil
			while true do
				makeID = Rnd(5) + 1
				if thingid == 221 and pid == 88 and enough[4] == 1 then
					makeID = 4
				end
				if thingid == 220 and pid == 89 and enough[4] == 1 then
					makeID = 4
				end
				if enough[makeID] == 1 then
					break;
				end
			end
			
			local newThingID = JY.Thing[thingid]["练出物品" .. makeID]
			DrawStrBoxWaitKey(string.format("%s 制造出 %s", p["姓名"], JY.Thing[newThingID]["名称"]), C_WHITE, CC.DefaultFont)
			if instruct_18(newThingID) == true then
				instruct_32(newThingID, 1)
			else
				instruct_32(newThingID, 1)
			end
			instruct_32(JY.Thing[thingid]["需材料"], -JY.Thing[thingid]["需要物品数量" .. makeID])
			p["物品修炼点数"] = 0
		end
	end
end
--计算敌人中毒点数
--pid 使毒人，
--enemyid  中毒人
function War_PoisonHurt(pid, enemyid)
	local vv = math.modf((JY.Person[pid]["用毒能力"] - JY.Person[enemyid]["抗毒能力"]) / 4)
	--胡青牛在场王难姑用毒+50
	if JY.Status == GAME_WMAP then
		for i,v in pairs(CC.AddPoi) do
			if match_ID(pid, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						vv = vv + v[3] / 4
					end
				end
			end
		end
	end
	vv = vv - JY.Person[enemyid]["内力"] / 200
	for i = 1, 10 do
		if JY.Person[enemyid]["武功" .. i] == 108 then
			vv = 0
		end
	end
	vv = math.modf(vv)
	if vv < 0 then
		vv = 0
	end
	
	return AddPersonAttrib(enemyid, "中毒程度", vv)
end

function War_IncantationPoison(pid, enemyid)--math.modf((JY.Person[pid]["解毒能力"] + JY.Person[pid]["用毒能力"] + JY.Person[pid]["医疗能力"])/80)
	local vv = (JY.Person[pid]["解毒能力"] + JY.Person[pid]["用毒能力"] + JY.Person[pid]["医疗能力"] - JY.Person[enemyid]["抗毒能力"]) / 8

	vv = vv - JY.Person[enemyid]["内力"] / 200
	vv = math.modf(vv)
	if vv < 0 then
		vv = 0
	end
	if JY.Person[694]["天3"] == 2 then
	   vv = math.modf(vv*1.2)
	end
	return AddPersonAttrib(enemyid, "中毒程度", vv)
end

function War_IncantationHurt(pid, enemyid)
	local vv = (JY.Person[pid]["解毒能力"] + JY.Person[pid]["用毒能力"] + JY.Person[pid]["医疗能力"] - JY.Person[enemyid]["抗毒能力"]) / 2
    vv = vv + JY.Person[enemyid]["生命"]*0.1
	vv = vv - JY.Person[enemyid]["内力"] / 50
	vv = math.modf(vv)
	if vv < 0 then
		vv = 0
	end
	if JY.Person[694]["天3"] == 2 then
	   vv = math.modf(vv*1.2)
	end
	vv = -vv
	return AddPersonAttrib(enemyid, "生命", vv)
end

function War_IncantationHeal(id1, id2)
	local add = (JY.Person[id1]["解毒能力"] + JY.Person[id1]["用毒能力"] + JY.Person[id1]["医疗能力"])/2 + (JY.Person[id2]["生命最大值"] - JY.Person[id2]["生命"])*0.1
	local value = JY.Person[id2]["受伤程度"]
	if add + 20 < value then
		return 0
	end
  
	add = add - (add) * value / 200
	add = add + Rnd(5)
  
	local n = AddPersonAttrib(id2, "受伤程度", -math.modf((add) / 10))
	local m = AddPersonAttrib(id2, "中毒程度", -math.modf((add) / 8))
	--蓝烟清：医疗时显示内伤减少
	if JY.Status == GAME_WMAP then
		local p = -1;
		for wid = 0, WAR.PersonNum - 1 do
			if WAR.Person[wid]["人物编号"] == id2 and WAR.Person[wid]["死亡"] == false then
				p = wid;
				break;
			end
		end
		if p ~= nil then
		WAR.Person[p]["解毒点数"] = -m
		WAR.Person[p]["内伤点数"] = n
		end
	end
	if JY.Person[694]["天3"] == 2 then
	   add = add*1.2
	end
	add = math.modf(add)
	AddPersonAttrib(id2, "体力", 6)
	return AddPersonAttrib(id2, "生命", add)
end

--人物按轻功进行排序
function WarPersonSort(flag)
	for i = 0, WAR.PersonNum - 1 do
		local id = WAR.Person[i]["人物编号"]
		local add = 0
		local p = JY.Person[id]
		if p["武器"] > -1 then
			local agi_gain = 0	
			if JY.Thing[p["武器"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["武器"]]["加轻功"]*10 + JY.Thing[p["武器"]]["加轻功"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			elseif JY.Thing[p["武器"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["武器"]]["加轻功"]*10 - JY.Thing[p["武器"]]["加轻功"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			end
			add = add + agi_gain
		end
		if p["防具"] > -1 then
			local agi_gain = 0	
			if JY.Thing[p["防具"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["防具"]]["加轻功"]*10 + JY.Thing[p["防具"]]["加轻功"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			elseif JY.Thing[p["防具"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["防具"]]["加轻功"]*10 - JY.Thing[p["防具"]]["加轻功"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			end
			add = add + agi_gain
		end
		if p["动物"] > -1 then
			local agi_gain = 0	
			if JY.Thing[p["动物"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["动物"]]["加轻功"]*10 + JY.Thing[p["动物"]]["加轻功"]*(JY.Thing[p["动物"]]["装备等级"]-1)*2
			elseif JY.Thing[p["动物"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["动物"]]["加轻功"]*10 - JY.Thing[p["动物"]]["加轻功"]*(JY.Thing[p["动物"]]["装备等级"]-1)*2
			end
			add = add + agi_gain
		end
		WAR.Person[i]["轻功"] = JY.Person[id]["轻功"] + (add)
		--敌方的战场轻功会根据内力和等级加成
		if WAR.Person[i]["我方"] then
		  
		else
			WAR.Person[i]["轻功"] = WAR.Person[i]["轻功"] + math.modf(JY.Person[id]["内力最大值"] / 50) + JY.Person[id]["等级"]
		end
		if Curr_NG(id,166) then		--天池心法基础轻功*1.2
		   WAR.Person[i]["轻功"] = math.modf(WAR.Person[i]["轻功"]*1.2)
		end	
		if JY.Base["特殊"] ==1 and JY.Person[40]["血量翻倍"]==1 and id==0 then		--天池心法基础轻功*1.1
		   WAR.Person[i]["轻功"] = math.modf(WAR.Person[i]["轻功"]*1.1)
		end
		if WAR.YWDJ[id]~=nil and Curr_QG(id, 182) then
			WAR.Person[i]["轻功"] = WAR.Person[i]["轻功"]+WAR.YWDJ[id]	
		end
		if match_ID(id, 112) and WAR.ZHRM[id] == nil and WAR.XYS > 0 then	--萧远山杀破狼基础轻功*1.5
			WAR.Person[i]["轻功"] = math.modf(WAR.Person[i]["轻功"]*1.5)	
		end		
		--情侣加成
		for ii,v in pairs(CC.AddSpd) do
			if match_ID(id, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						WAR.Person[i]["轻功"] = WAR.Person[i]["轻功"] + v[3]
					end
				end
			end
		end
	end
	if flag ~= nil then
		return 
	end
	for i = 0, WAR.PersonNum - 2 do
		local maxid = i
		for j = i, WAR.PersonNum - 1 do
			if WAR.Person[maxid]["轻功"] < WAR.Person[j]["轻功"] then
				maxid = j;
			end
		end
		WAR.Person[maxid], WAR.Person[i] = WAR.Person[i], WAR.Person[maxid]
	end
end

--显示非攻击时的点数
function War_Show_Count(id, str)
	if JY.Restart == 1 then
		return
	end
	
	local pid = WAR.Person[id]["人物编号"];
	local x = WAR.Person[id]["坐标X"];
	local y = WAR.Person[id]["坐标Y"];
	
	local hp = WAR.Person[id]["生命点数"];
	local mp = WAR.Person[id]["内力点数"];
	local tl = WAR.Person[id]["体力点数"];
	local ed = WAR.Person[id]["中毒点数"];
	local dd = WAR.Person[id]["解毒点数"];
	local ns = WAR.Person[id]["内伤点数"];
  
	local show = {x, y, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil};		--x, y, 生命, 内力, 体力, 封穴, 流血, 中毒, 解毒, 内伤，冰封，灼烧
	
	if hp ~= nil and hp ~= 0 then		--显示生命
		if hp > 0 then
			show[3] = "生命+"..hp;
		else
			show[3] = "生命"..hp;
		end
	end
	
	if mp ~= nil and mp ~= 0 then		--显示内力
		if mp > 0 then
			show[5] = "内力+"..mp;
		else
			show[5] = "内力"..mp;
		end
	end
	
	if tl ~= nil and tl ~= 0 then		--显示体力
		if tl > 0 then
			show[6] = "体力+"..tl;
		else
			show[6] = "体力"..tl;
		end
	end
	
    if WAR.FXXS[WAR.Person[id]["人物编号"]] ~= nil and WAR.FXXS[WAR.Person[id]["人物编号"]] == 1 and WAR.FXDS[WAR.Person[id]["人物编号"]] ~= nil then			--显示是否封穴
       	show[7] = "封穴 "..WAR.FXDS[WAR.Person[id]["人物编号"]];
       	WAR.FXXS[WAR.Person[id]["人物编号"]] = 0
    end
      
    if WAR.LXXS[WAR.Person[id]["人物编号"]] ~=nil and WAR.LXXS[WAR.Person[id]["人物编号"]] == 1 and WAR.LXZT[WAR.Person[id]["人物编号"]] ~= nil then		--显示是否被流血
      	show[8] = "流血 "..WAR.LXZT[WAR.Person[id]["人物编号"]];
        WAR.LXXS[WAR.Person[id]["人物编号"]] = 0
    end
	
	if ed ~= nil and ed ~= 0 then		--显示中毒
		show[9] = "中毒+"..ed;
	end
	
	if dd ~= nil and dd ~= 0 then		--显示解毒
		show[4] = "中毒-"..dd;
	end
	
	if ns ~= nil and ns ~= 0 then		--显示内伤
		if ns > 0 then
			show[10] = "内伤↑"..ns;
		else
			show[10] = "内伤↓"..-ns;
		end
	end
	
	if WAR.BFXS[WAR.Person[id]["人物编号"]] == 1 then		--显示是否被冰封
		show[11] = "冰封 "..JY.Person[WAR.Person[id]["人物编号"]]["冰封程度"];
		WAR.BFXS[WAR.Person[id]["人物编号"]] = 0
	end
		
	if WAR.ZSXS[WAR.Person[id]["人物编号"]] == 1 then		--显示是否被灼烧
		show[12] = "灼烧 "..JY.Person[WAR.Person[id]["人物编号"]]["灼烧程度"];
		WAR.ZSXS[WAR.Person[id]["人物编号"]] = 0
	end
	
	--记录哪个位置上有点数
	local showValue = {};
	local showNum = 0;
	for i=3, 12 do
		if show[i] ~= nil then
			showNum = showNum + 1;
			showValue[showNum] = i;
		end
	end

	if showNum == 0 then
		return;
	end
	
	local hb = GetS(JY.SubScene, x, y, 4);
  
	local ll = string.len(show[showValue[1]]);	--长度
	
	local w = ll * CC.DefaultFont / 2 + 1
	local clip = {x1 = CC.ScreenW / 2 - w/2 - CC.XScale/2, y1 = CC.YScale + CC.ScreenH / 2 - hb, x2 = CC.XScale + CC.ScreenW / 2 + w, y2 = CC.YScale + CC.ScreenH / 2 + CC.DefaultFont + 1}
	local area = (clip.x2 - clip.x1) * (clip.y2 - clip.y1) + CC.DefaultFont*4		--绘画的范围
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)		--绘画句柄

	for i = 5, 18 do
		if JY.Restart == 1 then
			break
		end
		local tstart = lib.GetTime()
		local y_off = i * 2
		
		lib.SetClip(0, 0, CC.ScreenW, CC.ScreenH)
		lib.LoadSur(surid, 0, 0)
		--显示文字
		if str ~= nil then
			DrawString(clip.x1 - #str*CC.Fontsmall/5 + 30, clip.y1 - y_off - CC.DefaultFont*4, str, C_WHITE, CC.Fontsmall);
		end
		for j=1, showNum do
			local c = showValue[j] - 1;
			if showValue[j] == 3 and (string.sub(show[3],1,1) == "-" or string.sub(show[3],2,2) == "-") then		--减少生命，显示为红色
				c = 1;
			end
			DrawString(clip.x1, clip.y1 - y_off - (showNum-j+1)*CC.DefaultFont, show[showValue[j]], WAR.L_EffectColor[c], CC.DefaultFont); 	
		end 

		ShowScreen(1)
		lib.SetClip(0, 0, 0, 0)		--清除
		local tend = lib.GetTime()
		if tend - tstart < CC.BattleDelay then
			lib.Delay(CC.BattleDelay - (tend - tstart))
		end
	end
  
	lib.SetClip(0, 0, 0, 0)		--清除
	WAR.Person[id]["生命点数"] = nil;
	WAR.Person[id]["内力点数"] = nil;
	WAR.Person[id]["体力点数"] = nil;
	WAR.Person[id]["中毒点数"] = nil;
	WAR.Person[id]["解毒点数"] = nil;
	WAR.Person[id]["内伤点数"] = nil;
  
	lib.FreeSur(surid)
end

--计算医疗量
--id1 医疗id2, 返回id2生命增加点数
function ExecDoctor(id1, id2)
	if JY.Person[id1]["体力"] < 50 then
		return 0
	end
	local add = JY.Person[id1]["医疗能力"]
	local value = JY.Person[id2]["受伤程度"]
	if add + 20 < value then
		return 0
	end
  
	-- 平一指，医疗量和杀人数有关
	if match_ID(id1, 28) and JY.Status == GAME_WMAP then
		add = JY.Person[id1]["医疗能力"] * (1 + WAR.PYZ / 10)
		if JY.Person[28]["阶"] >= 1 then
		   add = add*1.3
		end
	end
  
	--战斗状态的医疗
	--胡斐在场程灵素医疗+120
	--王难姑在场胡青牛医疗+50
	if JY.Status == GAME_WMAP then
		for i,v in pairs(CC.AddDoc) do
			if match_ID(id1, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						add = add + v[3]
					end
				end
			end
		end
	end
  
	add = add - (add) * value / 200
	add = add + Rnd(5)
  
	local n = AddPersonAttrib(id2, "受伤程度", -math.modf((add) / 10))
	--蓝烟清：医疗时显示内伤减少
	if JY.Status == GAME_WMAP then
		local p = -1;
		for wid = 0, WAR.PersonNum - 1 do
			if WAR.Person[wid]["人物编号"] == id2 and WAR.Person[wid]["死亡"] == false then
				p = wid;
				break;
			end
		end
		if p ~= nil then
		WAR.Person[p]["内伤点数"] = n
		end
	end
	add = math.modf(add)
	if match_ID(id1, 28) and JY.Person[28]["阶"] >= 3 then
	local a = add
	   if JY.Person[id2]["生命"] + a > JY.Person[id2]["生命最大值"] then
	      a = JY.Person[id2]["生命最大值"] - JY.Person[id2]["生命"]
	   end
	   if WAR.JYSY[id1] ~= nil then
	   WAR.JYSY[id1] = WAR.JYSY[id1] + a
	   else
	   WAR.JYSY[id1] = a
	   end
	end
	return AddPersonAttrib(id2, "生命", add)
end

--无酒不欢：计算武功伤害，WAR.CurID为攻击方
function War_WugongHurtLife(enemyid, wugong, level, ang, x, y)

	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local eid = WAR.Person[enemyid]["人物编号"]
	--气防
	local dng = 0
	local WGLX = JY.Wugong[wugong]["武功类型"]
	local yin, yang, tg = NeiL(pid)
	local fx = yin + yang
	local yin2, yang2, tg2 = NeiL(eid)
	local fx2 = yin2 + yang2
	
	--无酒不欢：记录人物血量
	WAR.Person[enemyid]["Life_Before_Hit"] = JY.Person[eid]["生命"]
	
	--是否为敌人
	local function DWPD()
		--逆转乾坤状态下默认为敌人
		if match_ID(eid, 135) then
			return false
		elseif WAR.JYSH == 1 and WAR.LQZ[pid] == 100 then
		   return true
		elseif WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] or WAR.NZQK > 0 then
		   return true
		elseif Wush1() and WAR.Person[enemyid]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[WAR.CurID]["我方"] == false then
           return true
		elseif Wush2() and WAR.Person[enemyid]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[WAR.CurID]["我方"] == true then
           return true   
		else
		   return false
		end
	end
  
	local mywuxue = 0
	local emenywuxue = 0
	for i = 0, WAR.PersonNum - 1 do
		local id = WAR.Person[i]["人物编号"]
		
		--武学常识共用
		if WAR.Person[i]["死亡"] == false and JY.Person[id]["武学常识"] > 10 then
			if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and mywuxue < JY.Person[id]["武学常识"] then
				mywuxue = JY.Person[id]["武学常识"]
			end
			if WAR.Person[enemyid]["我方"] == WAR.Person[i]["我方"] and emenywuxue < JY.Person[id]["武学常识"] then
				emenywuxue = JY.Person[id]["武学常识"]
			end
		end
		
		if emenywuxue < 50 then
			emenywuxue = 50
		end
	end
	
	local hwxonbf = mywuxue
	if hwxonbf < emenywuxue then
		hwxonbf = emenywuxue
	end
	
	if match_ID(pid, 592) then
		if WAR.Person[WAR.CurID]["我方"] then
			mywuxue = hwxonbf
		else
			emenywuxue = hwxonbf
		end
	elseif match_ID(eid, 592) then
		if WAR.Person[WAR.CurID]["我方"] then
			emenywuxue = hwxonbf
		else
			mywuxue = hwxonbf
		end
	end
	
	--计算实际使用武功等级
	while true do
		if JY.Person[pid]["内力"] < math.modf((level + 1) / 2) * JY.Wugong[wugong]["消耗内力点数"] then
			level = level - 1
		else
			break;
		end
	end

	--防止出现左右互博时第一次攻击完毕，第二次攻击没有内力的情况。
	if level <= 0 then
	  level = 1
	end
	
	--豪鬼
    if wugong == 203 and (WAR.MSHSL == 1 and JY.Person[673]["外号2"] == "烈") == false then

      local nx, ny = WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]
	  WAR.SLX = nx
	  WAR.SLY = ny
	else
	   WAR.SLX = nil
	   WAR.SLY = nil
	end
	
	--瞬狱杀
    if wugong == 204 then
	PlayWavAtk(46)
	CurIDTXDH(WAR.CurID, 6, 1, " ", C_RED)
	local display = "瞬狱杀"
	local color = C_RED
	for i = 1, 40 do
		DrawStrBox(-1, 24, display, color, 10 + i)
		ShowScreen()
		lib.Delay(10)
	end
	WarDrawMap(0)
	
	lib.Delay(200)
	WAR.SYS = 1
    local nx, ny = WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]
	War_MovePerson(nx, ny)
	instruct_14()
	WarDrawMap(0)
	    
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
		lib.SetWarMap(nx, ny, 5, WAR.Person[enemyid]["贴图"])
		lib.SetWarMap(nx, ny, 2, enemyid)
		WarDrawMap(0)
		WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny	
        		
		WarDrawMap(0)
		CurIDTXDH(WAR.CurID, 123, 1, " ", C_RED)
		
	    instruct_13()
		WarDrawMap(0)
		CurIDTXDH(WAR.CurID, 125, 1, "一", C_RED)
		CurIDTXDH(WAR.CurID, 125, 1, "瞬", C_RED)
		CurIDTXDH(WAR.CurID, 125, 1, "千", C_RED)
		CurIDTXDH(WAR.CurID, 125, 1, "击", C_RED)
		lib.SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 5, -1)
		lib.SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 2, -1)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
		WAR.Person[enemyid]["死亡"] = true
		WAR.SYS = 0
		WAR.NLZ[pid] = nil
		WAR.SYBD[pid] = nil
	end	
	   

	--无酒不欢：计算内功护体，互为敌方才会触发
	if (match_ID(eid, 114) or match_ID(eid, 652) or match_ID(eid, 149)) and math.random(100) < 20 then
		WAR.SJDR = 1
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = "舍己度人・"..WAR.Person[enemyid]["特效文字1"]
		else
			WAR.Person[enemyid]["特效文字1"] = "舍己度人"
		end
		WAR.JQDT[pid] = 6
    end
	--周伯通空明之武道使敌方不会护体  先天乾坤功使敌方不会护体
	if DWPD() and WAR.KMZWD == 0 and WAR.XTQKG== 0 and WAR.SJDR == 0 and WAR.JESS[eid] == nil then
		local ht = {};		
		local num = 0;	--当前学了多少个内功
		for i = 1, JY.Person[671]["品德"] do
			local kfid = JY.Person[eid]["武功" .. i]
			local kflvl = JY.Person[eid]["武功等级" .. i]
			if kflvl == 999 then
				kflvl = 11
			else
				kflvl = math.modf(kflvl / 100) + 1
			end
			--先把内功都存入表格，吸功，金刚不坏，五岳剑诀，太极神功不护体
			if JY.Wugong[kfid]["武功类型"] == 6 and kfid ~= 85 and kfid ~= 87 and kfid ~= 88 and kfid ~= 144 and kfid ~= 175 and kfid ~= 171 then
				num = num + 1;
				ht[num] = {kfid,i,get_skill_power(eid, kfid, kflvl)};
			elseif JY.Person[eid]["主运内功"]>0 then
				num = num + 1;
				ht[num] = {JY.Person[eid]["主运内功"],i+1,get_skill_power(eid, JY.Person[eid]["主运内功"], 11)};			
			end
		end
				
		--如果学有内功
		if num > 0 then	
			--按照威力从大到小排序，威力一样的话按照面板的先后顺序
			for i = 1, num - 1 do
				for j = i + 1, num do
					if ht[i][3] < ht[j][3] or (ht[i][3] == ht[j][3] and ht[i][2] > ht[j][2])then
						ht[i], ht[j] = ht[j], ht[i]
					end
				end
			end
			--按顺序判定触发
			for i = 1, num do
				if myrandom(10, eid) then
					dng = ht[i][3];
					WAR.Person[enemyid]["特效文字2"] = JY.Wugong[ht[i][1]]["名称"] .. "护体"
					WAR.Person[enemyid]["特效动画"] =  87 + math.random(6)
					WAR.NGHT = ht[i][1];
					break;
				end
			end
		end
	
		--运行天赋内功气防+200，有35%几率再+300
		if JY.Person[eid]["主运内功"] > 0 and JY.Person[eid]["主运内功"] == JY.Person[eid]["天赋内功"] and WAR.JESS[eid] == nil then
			dng = dng + 200;
			if JLSD(30, 65, eid) then
				dng = dng + 300;
				Set_Eff_Text(enemyid, "特效文字3", "天赋内功护体")
			end
		end
	
		--蛤蟆功补偿护体
		if WAR.NGHT == 0 and PersonKF(eid, 95) and WAR.JESS[eid] == nil then
			dng = dng + 900;
			WAR.Person[enemyid]["特效文字2"] = "蛤蟆功补偿护体"
			WAR.Person[enemyid]["特效动画"] = 87 + math.random(6)
		end
	end
	
	--张无忌 九阳神功护体
	if match_ID(eid, 9) and WAR.NGHT == 0 and PersonKF(eid, 106)  and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = 87 + math.random(6)
		WAR.Person[enemyid]["特效文字2"] = "九阳神功护体"
		dng = dng + 1200
	end
	
	--NPC内功补完系统
	if not inteam(eid) and WAR.NGHT == 0 and WAR.KMZWD == 0 and WAR.XTQKG== 0 and WAR.SJDR == 0 and WAR.JESS[eid] == nil then
		local htName, htPower = G["NPC内功补完系统"](eid)
		if htName then
			WAR.Person[enemyid]["特效动画"] = 87 + math.random(6)
			WAR.Person[enemyid]["特效文字2"] = htName.."护体"
			dng = dng + htPower
		end
	end
	--武功数气防加成
	if not inteam(eid) and JY.Base["难度"] > 3 then
	local add1 = 1.1 + (JY.Person[671]["品德"] - 12) * 0.05 * (JY.Base["天书数量"]/14)
	local add2 = 150*(1.7^JY.Person[123]["天1"])*(JY.Base["天书数量"]/14)
	--local add2 = JY.Person[671]["品德"] - 12
	   dng = math.modf(dng*add1 + add2)
	end
	
	--[[论剑打赢阿青的奖励，气防永久提高800点
	if eid == 0 and JY.Person[604]["论剑奖励"] == 1 and WAR.JESS[eid] == nil then
		dng = dng + 1200
	end]]
	if JY.Person[637]["声望"] >= 5 and match_ID(eid, 637) then
	   dng = dng + 1000
	end
	if match_ID(eid, 638) then
	   dng = dng + 1500
	end
	if JY.Person[eid]["人12"] == 1 then
		dng = dng + 500
	end
	if JY.Person[eid]["人13"] == 1 then
		dng = dng + 1000
	end
	
	if JY.Person[eid]["内力性质"] > 0 then
	   dng = dng + 500
	end
	
	if JY.Person[eid]["地3"] == 5 and WAR.JESS[eid] == nil then
	   dng = dng + 1500
	end   
	
	--易筋经
	if PersonKF(eid, 108) and JY.Person[eid]["天赋内功"] == 108 and WAR.JESS[eid] == nil then
       dng = dng + 1000
	end
	if WAR.TSSJ[eid] ~= nil then
	   dng = dng + 1800
	end
	--木
	if match_ID(eid, 40) and JY.Person[40]["阶"] >= 2 then
	   dng = dng + 2000
	end
	
	if JY.Person[670]["无用"] == 1 and eid == 0 and WAR.JESS[eid] == nil then
	   dng = dng + 600
	   Set_Eff_Text(enemyid, "特效文字2", "稳如泰山")
	end
	
	--蒙哥，气防+2000点
	if eid == 627 and WAR.JESS[eid] == nil then
		dng = dng + 2000
	end
	
	if WAR.TQFY[eid] ~= nil then
	   dng = dng + 2000
	end
	
	if JY.Base["标准"] == 6 and eid == 0 and JY.Person[0]["阶"] >= 1 then
	   dng = dng + 1000
	end
	
	--雷震，气防
	if match_ID(eid, 670) and JY.Person[eid]["御剑能力"]>= 80 and WAR.JESS[eid] == nil then
	   dng = dng + 500
	   if JY.Person[eid]["御剑能力"]>= 200 then
	      dng = dng + JY.Person[eid]["御剑能力"]*4
	   end
	   WAR.Person[enemyid]["特效动画"] = 72
	   Set_Eff_Text(enemyid, "特效文字2", "剑气护体")
	end
	
	
	--防御状态
	if WAR.Defup[eid] == 1 and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = 90
		Set_Eff_Text(enemyid, "特效文字1", "防御状态")
		if PersonKF(eid, 101) then     --八荒气防+1000
			dng = dng + 500
			if JY.Person[171]["阶"] >= 1 and match_ID(eid, 171) then
		       dng = dng + 500
		    end
		end
			dng = dng + 500
		if JY.Person[171]["阶"] >= 1 and match_ID(eid, 171) then
		   dng = dng + 500
		end
	end
	
	if Curr_NG(eid, 218) and WAR.JESS[eid] == nil then
	   dng = dng + 2000
	end
	
	--除却四相，本次被攻击受到的内伤/封穴/冰封/灼烧减半
	if ChuQueSX(eid) ~= nil and ChuQueSX(eid)>=2 then
		WAR.CQSX = 1
		WAR.Person[enemyid]["特效动画"] = 79
		Set_Eff_Text(enemyid, "特效文字1", "除却四相")
	end
	
	--冰心诀
	if PersonKF(eid, 218) and WAR.JESS[eid] == nil then
		WAR.BXJ = 1
		WAR.Person[enemyid]["特效动画"] = 66
		local str = {"心若冰清，天塌不惊", 
		"万变犹定，神怡气静",
		"忘我守一，六根大定",
		"戒点养气，无私无为",
		"上下相顾，神色相依",
		"蓄意玄关，降伏思虑",
		"内外无物，若浊冰清",
		"尘垢不沾，俗相不染",
		"虚空甯宓，浑然无物",
		"无有相生，难易相成",
		"份与物忘，同乎浑涅",
		"天地无涯，万物齐一",
		"飞花落叶，虚怀若谷",
		"千般烦忧，才下心头",
		"即展眉头，灵台清幽",
		"心无G碍，意无所执",
		"解心释神，莫然无魂",
		"灵净归一，气协魄消",
		"水流心不惊，云在意俱迟",
		"一心不赘物，古今自逍遥"}
		local ss = 6 + JY.Base["天书数量"]
		if ss > 20 then
		   ss = 20
		end   
		Set_Eff_Text(enemyid, "特效文字5", str[math.random(ss)])
	end
	
	--紫霞神功	
	   if Curr_NG(eid,89) and DWPD() and WAR.JESS[eid] == nil then
	   WAR.ZXSG = 1
	   WAR.Person[enemyid]["特效动画"] = 79
	   Set_Eff_Text(enemyid, "特效文字1", "华山九功・紫霞称雄")
	   end	
	
	--六如的林山阴
	if eid==0 and JY.Person[eid]["六如觉醒"] > 0 and WAR.JESS[eid] == nil then
		local rate = limitX(math.modf(20 + (101-JY.Person[eid]["资质"])/10 + JY.Person[eid]["实战"]/50 + JY.Person[eid]["防御力"]/40 + JY.Person[eid]["武学常识"]/10),0,100)
		local low = 10

		local rl = 0
		local rs = 0
		local ry = 0
		local times = 1
		--仁者二次判定+循环两次，即一次可以触发两种六如特效
		if JY.Base["标准"] == 7 or match_ID(eid, 189) then
			times = 2
		end
		for i = 1, times do
			if JLSD(low, rate, eid) or ((JY.Base["标准"] == 7 or match_ID(eid, 189)) and JLSD(low, rate, eid)) then
				local lr = math.random(3)
				if lr == 1 then
					rl = 1
				elseif lr == 2 then
					rs = 1
				elseif lr == 3 then
					ry = 1
				end
			end
		end
		
		--其徐如林
		if rl == 1 and JY.Person[2]["血量翻倍"] == 1 then
			WAR.Person[enemyid]["特效动画"] = 6
			Set_Eff_Text(enemyid, "特效文字2", "其徐如林")
			WAR.FLHS2 = WAR.FLHS2 + math.random(1, 3)+WAR.FLHS2C*WAR.FLHS2C
			WAR.FLHS2C = WAR.FLHS2C - 1
			if WAR.FLHS2C < 0 then
			   WAR.FLHS2C = 0
			end
			if WAR.FLHS2 > 25 then
				WAR.FLHS2 = 25 
			end
		end
		--不动如山
		if rs == 1 and JY.Person[4]["血量翻倍"] == 1 then
			WAR.Person[enemyid]["特效动画"] = 6
			Set_Eff_Text(enemyid, "特效文字2", "不动如山")
			WAR.FLHS4 = 1
		end
		--难知如阴
		if ry == 1 and JY.Person[5]["血量翻倍"] == 1 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			WAR.Person[enemyid]["特效动画"] = 6
			Set_Eff_Text(enemyid, "特效文字2", "难知如阴")
			WAR.ACT = 10
			--如果是由斗转或暗香触发的如阴，则不打断左右
			if WAR.DZXY == 0 and WAR.AXFJ == 0 then
				WAR.ZYHB = 0
				WAR.CLBF = 0
				WAR.HSSD = 0
			end
			WAR.FLHS5 = 1
		end
	end
	if WAR.NSDF[eid] ~= nil and match_ID(eid, 133) and WAR.JESS[eid] == nil then	--南山刀法，使用后10时序内不动如山
		WAR.Person[enemyid]["特效动画"] = 6
		Set_Eff_Text(enemyid, "特效文字2", "不动如山")
	end
	
	--无酒不欢：NPC的真气效果为2倍
	
	--鸠摩智
	if match_ID(eid, 103) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = math.fmod(98, 10) + 85
		Set_Eff_Text(enemyid, "特效文字2", "明王真气")
		WAR.ZQHT = 1
	end
	
	--成昆
	if match_ID(eid, 18) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = math.fmod(106, 10) + 85
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+混元霹雳功"
		else
			WAR.Person[enemyid]["特效文字2"] = "混元霹雳功护体"
		end
		WAR.ZQHT = 1
	end

	--洪七公
    if match_ID(eid, 69) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end	
		WAR.Person[enemyid]["特效动画"] = 67
		Set_Eff_Text(enemyid, "特效文字2", "丐王真气")
		WAR.ZQHT = 1
    end
	
	 --无酒不欢 放荡不羁 
    if JY.Base["特殊"] ==1 and JY.Person[33]["血量翻倍"]==1 and eid==0 and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) and WAR.JESS[eid] == nil then
		dng = dng + 600
		WAR.Person[enemyid]["特效动画"] = math.fmod(106, 10) + 85
		Set_Eff_Text(enemyid, "特效文字2", "放荡不羁");
		WAR.ZQHT = 1
    end
	
	--四大恶人
    if match_ID(eid, 98) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 200
		if not inteam(eid) then
			dng = dng + 200
		end	
		WAR.Person[enemyid]["特效动画"] = math.fmod(106, 10) + 85
		Set_Eff_Text(enemyid, "特效文字2", "恶贯满盈")
		WAR.ZQHT = 1
    end
	
	if match_ID(eid, 99) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 200
		if not inteam(eid) then
			dng = dng + 200
		end	
		WAR.Person[enemyid]["特效动画"] = math.fmod(106, 10) + 85
		Set_Eff_Text(enemyid, "特效文字2", "无恶不作")
		WAR.ZQHT = 1
    end
	
	if match_ID(eid, 100) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 200
		if not inteam(eid) then
			dng = dng + 200
		end	
		WAR.Person[enemyid]["特效动画"] = math.fmod(106, 10) + 85
		Set_Eff_Text(enemyid, "特效文字2", "穷凶极恶")
		WAR.ZQHT = 1
    end
	
	if match_ID(eid, 44) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 200
		if not inteam(eid) then
			dng = dng + 200
		end	
		WAR.Person[enemyid]["特效动画"] = math.fmod(106, 10) + 85
		Set_Eff_Text(enemyid, "特效文字2", "凶神恶煞")
		WAR.ZQHT = 1
    end
 
	--黄药师
    if match_ID(eid, 57) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = 95
		Set_Eff_Text(enemyid, "特效文字2", "奇门奥义")
		WAR.ZQHT = 1
    end
	
	--谢烟客
    if match_ID(eid, 164) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = 23
		Set_Eff_Text(enemyid, "特效文字2", "控鹤功")
		WAR.ZQHT = 1
    end
	
	--任我行
	if match_ID(eid, 26) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = 6
		Set_Eff_Text(enemyid, "特效文字2", "日月・同辉")
		WAR.ZQHT = 1
	end
	
	--戚长发
    if match_ID(eid, 594) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = 93
		Set_Eff_Text(enemyid, "特效文字2", "铁锁横江")
		WAR.ZQHT = 1
    end
	
	--慕容博
    if match_ID(eid, 113) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = 93
		Set_Eff_Text(enemyid, "特效文字2", "参合真气")
		WAR.ZQHT = 1
    end
	
	--阿紫曼珠沙华，每杀一个人+200气防
	if match_ID(eid, 47) then
		dng = dng + 200*WAR.MZSH
	end
	
	--枯荣
    if match_ID(eid, 102) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = 93
		Set_Eff_Text(enemyid, "特效文字2", "枯荣真气")
		WAR.ZQHT = 1
    end
	
	--余沧海
    if match_ID(eid, 24) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 100
		if match_ID_awakened(eid, 24, 1) or match_ID_awakened(eid, 24, 2) then
		   dng = dng + 1900
		end
		if not inteam(eid) then
			dng = dng + 100
		end
		WAR.Person[enemyid]["特效动画"] = 93
		Set_Eff_Text(enemyid, "特效文字2", "松风剑神")
		WAR.ZQHT = 1
    end
	
	--何铁手
    if match_ID(eid, 83) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 500
		if not inteam(eid) then
			dng = dng + 500
		end
		WAR.Person[enemyid]["特效动画"] = 92
		Set_Eff_Text(enemyid, "特效文字2", "红袖拂风")
		WAR.ZQHT = 1
    end
	
	--左冷禅
    if match_ID(eid, 22) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 500
		if not inteam(eid) then
			dng = dng + 500
		end
		WAR.Person[enemyid]["特效动画"] = 1
		Set_Eff_Text(enemyid, "特效文字2", "寒冰真气")
		WAR.ZQHT = 1
    end
	
	--殷天正
    if match_ID(eid, 12) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + 500
		if not inteam(eid) then
			dng = dng + 500
		end
		WAR.Person[enemyid]["特效动画"] = 92
		Set_Eff_Text(enemyid, "特效文字2", "鹰王真气")
		WAR.ZQHT = 1
    end
	
	--阿青
    if match_ID(eid, 604) and (inteam(eid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.JESS[eid] == nil then
		dng = dng + TrueYJ(eid)*10
		if not inteam(eid) then
			dng = dng + TrueYJ(eid)*10
		end
		WAR.Person[enemyid]["特效动画"] = 121
		Set_Eff_Text(enemyid, "特效文字2", "九霄仙息")
		WAR.ZQHT = 1
    end

	--北冥真气，无崖子必发动，学有北冥/虚竹觉醒后几率发动
	if (PersonKF(eid, 85) or match_ID_awakened(eid, 49, 1)) and (JLSD(20, 70, eid) or match_ID(eid, 116)) and WAR.JESS[eid] == nil then
		dng = dng + 800
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 85
		end
		Set_Eff_Text(enemyid, "特效文字2", "北冥真气")
		WAR.ZQHT = 1
	end
	
	
	
	--斗转星移
	--50%几率发动，慕容复，慕容博必发动
    if WAR.AXFJ == 0 and WAR.JESS[eid] == nil and match_ID(pid, 673) == false and match_ID(pid, 693) == false and match_ID(pid, 689) == false and wugong ~= 198 and wugong ~= 197 and wugong ~= 187 
	and wugong ~= 214 and wugong ~= 253 and JY.Person[eid]["出战"]==1 and JY.Person[eid]["体力"] > 10 and WAR.DZXY ~= 1 
	and WAR.Person[enemyid]["反击武功"] == -1 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] 
	and (JLSD(30, 65+math.modf(JY.Person[eid]["资质"]/4), eid) or (match_ID(eid, 670) and (JLSD(20, 70+math.modf(JY.Person[eid]["资质"]/4), eid))) or match_ID(eid, 51) or match_ID(eid, 113)) and match_ID(eid, 689) == false then
		local dzlv = Xishu_sum(eid)
		local dzwz = nil
		--兵器值之和大于等于450出离合参商
		--慕容复，慕容博，天罡必出
		if JY.Person[eid]["专2"] == 997 or (match_ID(eid, 113) and JY.Person[113]["阶"]>=1) then
		   WAR.WGJY2[pid] = 1
		   WAR.WGJY3[pid] = wugong
		end
		if dzlv >= 500 or match_ID(eid, 51) or match_ID(eid, 113) or (eid == 0 and JY.Base["标准"] == 6) then
			local hm = 0
			--慕容复指令，幻梦星辰反击
			if WAR.TZ_MRF == 1 and match_ID(eid, 51) then
				hm = 1				
			end
			if WAR.tmp[7000 + eid] ~= nil then
			  if WAR.tmp[7000 + eid] >= 10 then
				hm = 1
				WAR.tmp[7000 + eid] = WAR.tmp[7000 + eid] - 10
			  end
			end
			if hm == 1 then
				dzwz = "幻梦星辰"
				WAR.DZXYLV[eid] = 4
			else
				dzwz = "离合参商"
				WAR.DZXYLV[eid] = 3
			end
		--兵器值之和大于等于300出斗转星移
		elseif dzlv >= 350 then
			dzwz = "斗转星移"
			WAR.DZXYLV[eid] = 2
		--都不满足，则是北斗移辰
		else
			dzwz = "北斗移辰"
			WAR.DZXYLV[eid] = 1
		end
		Set_Eff_Text(enemyid, "特效文字2", dzwz)
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 93
		end
		WAR.Person[enemyid]["反击武功"] = wugong
    end
  
	--无酒不欢：伤害公式从这里开始，计算受到的伤害
	local hurt = nil
		
	--几率抽签函数：X值大于1时，随机返回X值的50%~100%
	local function myrnd(x)
		if x <= 1 then
			return 0
		end
		return math.random(x * 0.5, x)
	end
	
	--获取武功的真实威力
	local true_WL = get_skill_power(pid, wugong, level)
		
	--当守方为玩家时，基础伤害一 = 30 + (攻方攻击 + 攻方内力/50)/1.5 + 武功威力/2.5
	if inteam(eid) then
		hurt =  30 + (JY.Person[pid]["攻击力"] + getnl(pid)/50)/1.5 + true_WL/3
	--当守方为NPC时，基础伤害一 = (攻方攻击 + 攻方内力/50 + 武功威力)/3
	else
		hurt = (JY.Person[pid]["攻击力"] + getnl(pid)/50 + true_WL)/3.5
	end

	--无酒不欢：攻方基础攻击
	local atk = JY.Person[pid]["攻击力"]
	--无酒不欢：守方基础防御
	local def = JY.Person[eid]["防御力"]
  
	if JY.Status == GAME_WMAP then
		--队友攻击力加成
		for i,v in pairs(CC.AddAtk) do
			if match_ID(pid, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						atk = atk + v[3]
					end
				end
			end
		end
		--队友防御力加成
		for i,v in pairs(CC.AddDef) do
			if match_ID(eid, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						def = def + v[3]
					end
				end
			end
		end
	end

	--基础伤害一 = 基础伤害一 + (攻方武常 - 守方武常)/2
	hurt = hurt + (mywuxue - emenywuxue) / 1
	
	--攻方的内力/50加成到攻方基础攻击
	atk = atk + getnl(pid) / 50	
	  
	--攻方的气攻/20，加成到攻方基础攻击
	--攻方的武常，加成到攻方基础攻击
	atk = atk + mywuxue + ang / 20
	
	--守方的内力/40，加成到守方基础防御
	--守方的武常，加成到守方基础防御
	def = def + getnl(eid) / 40 + emenywuxue * 1.5
	
	if Curr_NG(pid,166) then	--天池心法基础攻击*1.2
	atk = math.modf(atk*1.2)
	end
	
	if JY.Base["特殊"] ==1 and JY.Person[40]["血量翻倍"]==1 and pid==0 then	--无酒不欢一柱擎天
	atk = math.modf(atk*1.1)
	end
	
	if match_ID(pid, 112) and WAR.ZHRM[pid] == nil and WAR.XYS > 0 then	--萧远山杀破狼基础攻击*1.5
	atk = math.modf(atk*1.5)
	end	
	
	if Curr_NG(eid,166) then	--天池心法基础防御*1.2
	def = math.modf(def*1.2)
	end	
	
	if JY.Base["特殊"] ==1 and JY.Person[40]["血量翻倍"]==1 and eid==0 then	--无酒不欢一柱擎天
	def = math.modf(def*1.1)
	end
	
	if match_ID(eid, 112) and WAR.ZHRM[eid] == nil and WAR.XYS > 0 then	--萧远山杀破狼基础防御*1.5
	def = math.modf(def*1.5)
	end		
	
	
	--怒涛海潮无视敌方20%防御
	if PersonKF(pid, 177) or PersonKF(pid, 172) then
	local add = 0.8
	    if JY.Person[pid]["天赋内功"] == 177 then
		   add = add - 0.3
		end
		if JY.Person[pid]["专1"] == 172 then 
		   add = add - 0.3
		end
		def = math.modf(def * add)
	end	
	if match_ID(pid, 91) and WAR.BJ == 1 then
	   def = 0
	end
	if match_ID(pid, 692) and JY.Person[692]["天4"] == 1 and wugong == 26 then
	   def = math.modf(def*0.2)
	end
	if match_ID(pid, 646) and JY.Person[646]["天3"] == 1 then
	   def = 0
	end
	--北斗神拳
	if WAR.BDSQ == 3 then
	   def = math.modf(def * 0.5)
	end
	--
	if JY.Person[pid]["人5"] == 1 then
	   def = math.modf(def * 0.65)
	end
	--少商剑
	if match_ID(pid, 687) and wugong == 49 and WAR.LMZS == 6 then
	   def = 0
	end
	
	if match_ID(pid, 688) and JY.Person[688]["天2"] == 1 then
	   def = math.modf(def * 0.3)
	end
	
	if match_ID(pid, 691) and wugong == 189 then
	local d = 0.7-JY.Person[pid]["实战"]*0.001
	   def = math.modf(def * d)
	end
	
	if wugong == 232 or wugong == 238 then
	   def = 0
	end
	
	--天魔功无视敌方40%防御
	if Curr_NG(pid, 160) then
		def = math.modf(def * 0.6)
	end
	
	if JY.Person[pid]["武器"] == 362 and JY.Thing[362]["装备等级"] == 6 then 
	   def = math.modf(def * 0.75)
	end
	
	--绵掌
	if wugong == 7 and JY.Person[pid]["专1"] == 7 then
	   def = math.modf(def * 0.3)
	end
	--火枪
	if wugong == 155 and JY.Person[pid]["专1"] == 155 then
	   def = math.modf(def * 0.4)
	end
	--化骨绵掌
	if wugong == 118 and (JY.Person[pid]["专2"] == 118 or match_ID(pid, 602)) then
	   def = math.modf(def * 0.3)
	end
	
	--空明拳
	if wugong == 15 and JY.Person[pid]["专2"] == 15 then
	   def = math.modf(def * 0.65)
	end
	
	--玄铁
	if wugong == 45 and JY.Person[pid]["专2"] == 45 then
	   def = math.modf(def * 0.5)
	end
	
	--九阴白骨爪
	if wugong == 11 and JY.Person[pid]["专2"] == 11 then
	   def = math.modf(def * 0.5)
	end
	
	if WAR.WLDF == 2 then
	   def = math.modf(def * 0.5)
	end
	if WAR.XYJ == 1 then
	   def = math.modf(def * 0.8)
	end
	
	if wugong == 217 and WAR.AHZS == 4 then
	   local x = 0.4
	   if tg ~= 1 then
		  if fx >= 0 then
		     x = x - 0.04*fx
		  end
	   else
	      x = x - 0.04*yang
	   end
	   if x < 0 then
	      x = 0
	   end
	   def = math.modf(def * x)
	end
	
	--无坚不摧
	if WAR.WJBC == 1 then
	   def = math.modf(def * 0.3)
	   WAR.WJBC = 0
	end
	
	--剑血浮生，无视剑法 /1000防御
	if wugong == 200 and match_ID(pid, 671) then
	local fy = 1 - (JY.Person[eid]["御剑能力"]/1000)
	   if fy < 0 then
	      fy = 0
	   end
	   def = math.modf(def*fy)
	end
	
	--陈家洛庖丁解牛无视敌方70%防御
	if match_ID(pid,75) and pid == 0 and WAR.PDJN == 1 then
		def = math.modf(def * 0.3)
	end
	--所向披靡
	if pid == 0 and JY.Person[0]["天3"] == 3 then
	   def = math.modf(def * 0.5)
	end
	
	if JY.Person[pid]["地7"] == 2 and (JY.Wugong[wugong]["武功类型"] == 1 or JY.Wugong[wugong]["武功类型"] == 2) then
	   def = 0
	end
	
	if JY.Person[pid]["地7"] == 3 and JY.Person[pid]["武器"] > 0 and (JY.Wugong[wugong]["武功类型"] == 3 or JY.Wugong[wugong]["武功类型"] == 4 or JY.Wugong[wugong]["武功类型"] == 5) then
	   def = 0
	end
	
	if PersonKF(pid, 166) then		--天池心法无视敌方20%防御
		def = math.modf(def * 0.8)
	end
	
	--葵花尊者，基础攻击*1.5
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and pid == 27 then
		atk = atk * 1.5
	end

	--金轮十层龙象，基础攻击*2	
	if (WAR.ZDDH == 275 or WAR.ZDDH == 277 or WAR.ZDDH == 278) and pid == 62 then
		atk = atk * 2
	end

	--金轮九层龙象，基础攻击*1.5	
	if WAR.ZDDH == 75 and pid == 62 then
		atk = atk * 1.5
	end
		
	--葵花尊者，基础防御*1.5
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and eid == 27 then
		def = def * 1.5
	end
	
	--金轮十层龙象，基础防御*2
	if (WAR.ZDDH == 275 or WAR.ZDDH == 277 or WAR.ZDDH == 278) and eid == 62 then
		def = def * 2
	end

	--金轮九层龙象，基础防御*1.5	
	if WAR.ZDDH == 75 and eid == 62 then
		def = def * 1.5
	end
	
	--太极蓄力增加防御
	if PersonKF(eid,171) and WAR.tmp[3000 + eid]~= nil  then
		def = def + math.modf(WAR.tmp[3000 + eid]/10)
	end   
	
	--伤害一 = 基础伤害一 * 攻方基础攻击/(攻方基础攻击 + 守方基础防御)
	hurt = (hurt) * (atk) / (atk + def)
  
	--伤害一 = 伤害一 - 守方基础防御/5
	hurt = hurt - (def) / 3
	
	--伤害一 = 伤害一 + (攻方体力 - 守方体力)/5 - (攻方内伤 - 守方内伤)/3 - (攻方中毒 - 守方中毒)/2
	hurt = hurt - (dng) / 30 + JY.Person[pid]["体力"] / 5 - JY.Person[eid]["体力"] / 5 + JY.Person[eid]["受伤程度"] / 3 - JY.Person[pid]["受伤程度"] / 3 + JY.Person[eid]["中毒程度"] / 2 - JY.Person[pid]["中毒程度"] / 2

	--无酒不欢：系数减伤
	local defadd = 0
	local wgtype = JY.Wugong[wugong]["武功类型"];
	local NPCgxf = 1;
	local NPCfxf = 1;
	--NPC系数*3计算
	if inteam(pid) then
		NPCfxf = 3
		if match_ID(eid, 670) or match_ID(eid, 671) then
		   NPCfxf = 1
		end
	else
		NPCgxf = 3
		if match_ID(pid, 670) or match_ID(pid, 671) then
		   NPCgxf = 1
		end
	end
	if wgtype == 6 then
		--太玄可以手动选择系数
		if wugong == 102 and WAR.TXZS > 0 then
			WAR.NGXS = WAR.TXZS
		else
			WAR.NGXS = math.random(5)
		end
		wgtype = WAR.NGXS
		if wugong == 213 then
		   WAR.NGXS = 3
		end   
	end
	if wugong == 225 then
	local mx = Xishu_max(pid)
	if TrueQZ(pid) == mx then
    wgtype = 1
	elseif TrueZF(pid) == mx then
    wgtype = 2
	elseif TrueYJ(pid) == mx then
    wgtype = 3
	elseif TrueSD(pid) == mx then
    wgtype = 4
	elseif TrueTS(pid) == mx then
    wgtype = 5
	end
	end
	--风清扬任何武功攻击算剑系
	if match_ID(pid, 140) or (pid==604 and WAR.ZDDH == 291) or JY.Person[pid]["武器"] == 353 then
		wgtype = 3
	end
	if match_ID(pid, 691) and JY.Person[691]["天3"] > 0 then
		wgtype = 4
	end
	if match_ID(eid, 691) and JY.Person[691]["天3"] == 2 then
		wgtype = 4
	end
	--风清扬被任何武功攻击算剑系
	if match_ID(eid, 140) or (eid==604 and WAR.ZDDH == 291) or JY.Person[eid]["武器"] == 353 then
		wgtype = 3
	end
	
	--lxf
	if match_ID(pid, 678) and JY.Person[678]["天4"] == 2 then
		wgtype = 2
	end
	--lxf
	if match_ID(eid, 678) and JY.Person[678]["天4"] == 2 then
		wgtype = 2
	end
	
	--无酒不欢 剑术通神
	if JY.Base["特殊"] ==1 and JY.Person[37]["血量翻倍"]==1 and eid==0 then
		wgtype = 3
	end
	if wgtype == 1 and wugong ~= 109 then
		local quan_gong = TrueQZ(pid)*NPCgxf
		local quan_fang = TrueQZ(eid)*NPCfxf
		--丁典
        if match_ID(pid, 672) and wugong == 94 and JY.Person[672]["声望"] == 100 then
		   quan_gong = quan_gong + TrueQZ(pid)
        end
		--无酒不欢：被拳法攻击，取拳指较高者计算减伤
		if quan_fang < TrueZF(eid)*NPCfxf then
			quan_fang = TrueZF(eid)*NPCfxf
		end
		--怒涛海潮无视敌方50%系数
		if Curr_NG(pid, 177) or PersonKF(pid, 172) then
			quan_fang = quan_fang/2
		end
		--dfmq
	    if Curr_NG(pid, 107) and JY.Person[pid]["拳掌功夫"] >= 240 then
	       quan_fang = quan_fang/3
	    end
		if Curr_NG(pid, 172) then
		defadd = quan_gong+320	
		else
		defadd = quan_gong - quan_fang
		end
	elseif wgtype == 2 or wugong == 109 then
		local zhi_gong = TrueZF(pid)*NPCgxf
		local zhi_fang = TrueZF(eid)*NPCfxf
		--丁典
        if match_ID(pid, 672) and wugong == 94 and JY.Person[672]["声望"] == 100 then
		   zhi_gong = zhi_gong + TrueQZ(pid)
        end
		--无酒不欢：被指法攻击，取拳指较高者计算减伤
		if zhi_fang < TrueQZ(eid)*NPCfxf then
			zhi_fang = TrueQZ(eid)*NPCfxf
		end
		--dfmq
	    if Curr_NG(pid, 107) and JY.Person[pid]["拳掌功夫"] >= 240 then
	       zhi_fang = zhi_fang/3
	    end
		--六脉剑气碧烟横，敌方指法系数按50%算
		if WAR.JQBYH == 1 then
			zhi_fang = zhi_fang / 2
		end
		--怒涛海潮无视敌方50%系数
		if Curr_NG(pid, 177) or PersonKF(pid, 172) then
			zhi_fang = zhi_fang/2
		end
		if Curr_NG(pid, 172) then
		defadd = zhi_gong+320	
		else	
		defadd = zhi_gong - zhi_fang
		end
	elseif wgtype == 3 then
		local jian_gong = TrueYJ(pid)*NPCgxf
		local jian_fang = TrueYJ(eid)*NPCfxf
		--丁典
        if match_ID(pid, 672) and wugong == 94 and JY.Person[672]["声望"] == 100 then
		   jian_gong = jian_gong + TrueQZ(pid)
        end
		--怒涛海潮无视敌方50%系数
		if Curr_NG(pid, 177) or PersonKF(pid, 172) then
			jian_fang = jian_fang/2
		end	
		--阿青天元剑气，敌方御剑系数按0算
		if WAR.TYJQ == 1 then
			jian_fang = 0
		end
		if wugong == 156 and JY.Person[pid]["专2"] == 156 then
	       jian_fang = 0
	    end
		if Curr_NG(pid, 172) then
		defadd = jian_gong+320	
		else
		defadd = jian_gong - jian_fang
		end
	elseif wgtype == 4 then
		local dao_gong = TrueSD(pid)*NPCgxf
		local dao_fang = TrueSD(eid)*NPCfxf
		--丁典
        if match_ID(pid, 672) and wugong == 94 and JY.Person[672]["声望"] == 100 then
		   dao_gong = dao_gong + TrueQZ(pid)
        end
		--怒涛海潮无视敌方50%系数
		if Curr_NG(pid, 177) or PersonKF(pid, 172) then
			dao_fang = dao_fang/2
		end
		if Curr_NG(pid, 172) then
		defadd = dao_gong+320	
		else
		defadd = dao_gong - dao_fang
		end
		if WAR.RJSD == 1 then
		   dao_fang = dao_fang/3
		end
		if WAR.NFCD == 1 then
		   dao_fang = 0
		end
	elseif wgtype == 5 then
		local qi_gong = TrueTS(pid)*NPCgxf
		local qi_fang = TrueTS(eid)*NPCfxf
		--丁典
        if match_ID(pid, 672) and wugong == 94 and JY.Person[672]["声望"] == 100 then
		   qi_gong = qi_gong + TrueQZ(pid)
        end
		--怒涛海潮无视敌方50%系数
		if Curr_NG(pid, 177) or PersonKF(pid, 172) then
			qi_fang = qi_fang/2
		end
		if Curr_NG(pid, 172) then
		defadd = qi_gong+320	
		else
		defadd = qi_gong - qi_fang
		end
	end
	--每4点系数优势增加/劣势减少1%伤害
	defadd = defadd / 5
	if defadd > 99 then
	   defadd = 99
	end   
	
	local xishu_str;
	if defadd >= 10 then
		xishu_str = "本系优势・伤害加深"..math.modf(defadd).."%"
	elseif defadd <= - 10 then
		xishu_str = "本系劣势・伤害减少"..math.modf(-defadd).."%"
	end
	
	
	--小昭，圣火，系数不会劣势
    if match_ID(pid, 672) and wugong == 94 and defadd < 0 then
		defadd = 10
    end
	if match_ID(pid, 689) and defadd < 0 then
		defadd = 0
    end
	
	--天罡大招，不会劣势
	if WAR.JSTG == 1 and defadd < 10 and JY.Wugong[wugong]["武功类型"] == 6 then
		defadd = 10
		xishu_str = "遇强则强"
	end
	
	--小无相功，系数不会劣势
	if Curr_NG(pid, 98) and defadd >= 10 then
		defadd = defadd+10
		xishu_str = "无我无相"
	end
	
	--小无相功，系数不会劣势
	if Curr_NG(pid, 98) and defadd < 10 then
		defadd = 10
		xishu_str = "无我无相"
	end
	
	
	--天元剑气和怒涛海潮无视无我无相
	if Curr_NG(eid, 98) and defadd <= -10 and WAR.TYJQ ~= 1 and WAR.NFCD ~= 1 and WAR.RJSD ~= 1 and Curr_NG(pid, 177) == false and PersonKF(pid, 172) == false then
		defadd = defadd-10
	end
	
	--天元剑气和怒涛海潮无视无我无相
	if Curr_NG(eid, 98) and defadd > -10 and WAR.TYJQ ~= 1 and WAR.NFCD ~= 1 and WAR.RJSD ~= 1 and Curr_NG(pid, 177) == false and PersonKF(pid, 172) == false then
		defadd = -10
	end
	
	hurt = math.modf(hurt * (1 + defadd/100))
	
	if defadd >= 10 then
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 63
		end
		Set_Eff_Text(enemyid, "特效文字0", xishu_str)
	elseif defadd <= - 10 then
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 63
		end
		Set_Eff_Text(enemyid, "特效文字3", xishu_str)
	end
	
	--毒王的中毒补偿
	--每5点中毒程度增伤1%
	if pid == 0 and JY.Base["标准"] == 9 then
		hurt = hurt + JY.Person[pid]["中毒程度"] / 2
		hurt = math.modf(hurt * (1 + JY.Person[pid]["中毒程度"]/500))
	end
	--每5点中毒程度减伤1%
	if eid == 0 and JY.Base["标准"] == 9 then
		hurt = hurt - JY.Person[eid]["中毒程度"] / 2
		hurt = math.modf(hurt * (1 - JY.Person[eid]["中毒程度"]/500))
	end
	--中毒
	if JY.Person[eid]["中毒程度"] > 0 and (eid == 0 and JY.Base["标准"] == 9)==false then
	    local add = JY.Person[eid]["中毒程度"]*0.001
		hurt = math.modf(hurt*(1+add))
	end
	--一剑无血
	if match_ID(pid, 150) and wgtype == 3 then
	   hurt = math.modf(hurt*1.25)
	end
	
	
	--伤害一 = 伤害一 + 装备攻击 * 装备加成系数
	--NPC的装备不带等级
	if inteam(pid) then
		if JY.Person[pid]["武器"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["武器"]]["加攻击力"]*10+JY.Thing[JY.Person[pid]["武器"]]["加攻击力"]*(JY.Thing[JY.Person[pid]["武器"]]["装备等级"]-1)*2
		end
		if JY.Person[pid]["防具"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["防具"]]["加攻击力"]*10+JY.Thing[JY.Person[pid]["防具"]]["加攻击力"]*(JY.Thing[JY.Person[pid]["防具"]]["装备等级"]-1)*2
		end
		if JY.Person[pid]["动物"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["动物"]]["加攻击力"]*10+JY.Thing[JY.Person[pid]["动物"]]["加攻击力"]*(JY.Thing[JY.Person[pid]["动物"]]["装备等级"]-1)*2
		end
	else
		if JY.Person[pid]["武器"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["武器"]]["加攻击力"]*10
		end
		if JY.Person[pid]["防具"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["防具"]]["加攻击力"]*10
		end
		if JY.Person[pid]["动物"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["动物"]]["加攻击力"]*10
		end
	end
	
	if inteam(eid) then
		if JY.Person[eid]["武器"] >= 0 then
			hurt = hurt - (JY.Thing[JY.Person[eid]["武器"]]["加防御力"]*10+JY.Thing[JY.Person[eid]["武器"]]["加防御力"]*(JY.Thing[JY.Person[eid]["武器"]]["装备等级"]-1)*2)
		end
		if JY.Person[eid]["防具"] >= 0 then
			hurt = hurt - (JY.Thing[JY.Person[eid]["防具"]]["加防御力"]*10+JY.Thing[JY.Person[eid]["防具"]]["加防御力"]*(JY.Thing[JY.Person[eid]["防具"]]["装备等级"]-1)*2)
		end
		if JY.Person[eid]["动物"] >= 0 then
			hurt = hurt - (JY.Thing[JY.Person[eid]["动物"]]["加防御力"]*10+JY.Thing[JY.Person[eid]["动物"]]["加防御力"]*(JY.Thing[JY.Person[eid]["动物"]]["装备等级"]-1)*2)
		end
	else
		if JY.Person[eid]["武器"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["武器"]]["加防御力"]*10
		end
		if JY.Person[eid]["防具"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["防具"]]["加防御力"]*10
		end
		if JY.Person[eid]["动物"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["动物"]]["加防御力"]*10
		end
	end
	
	--伤害随距离递减，上限11格差值，最多衰减30%
	--九剑真传，离剑式不递减
	--主运梯云纵横不递减
	--NPC不递减,白虹掌力不递减
	if inteam(pid) and WAR.JJZC ~= 1 and Curr_QG(pid,149) == false and match_ID(pid, 164) == false and wugong~=184 and JY.Person[pid]["地10"] ~= 4 and ((match_ID(pid, 670)
	and JY.Person[pid]["特殊兵器"] >= 200) == false) and wugong ~= 24 then
		local offset = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[enemyid]["坐标X"]) + math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[enemyid]["坐标Y"])
		if offset > 11 then
			offset = 11
		end
		hurt = (hurt) * (100 - (offset - 1) * 3) / 100
	end

	--谢烟客递增
	if match_ID(pid, 164) then
		local offset = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[enemyid]["坐标X"]) + math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[enemyid]["坐标Y"])
		if offset > 11 then
			offset = 11
		end
		hurt = (hurt) * (100 + (offset - 1) * 3) / 100
	end	
	
	--[[雷震，奇门320递增
	if match_ID(pid, 670) and JY.Person[pid]["特殊兵器"] >= 320 then
		local offset = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[enemyid]["坐标X"]) + math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[enemyid]["坐标Y"])
		if offset > 11 then
			offset = 11
		end
		hurt = (hurt) * (100 + (offset - 1) * 3) / 100
	end	]]
  
	--暴击
	if WAR.BJ == 1 then
		if Curr_NG(eid, 108) then
			WAR.Person[enemyid]["特效动画"] = 6
			Set_Eff_Text(enemyid, "特效文字1", "森罗万象")
			--免疫会心之一击的额外杀气
			if WAR.HXZYJ == 1 then
				dng = dng + 1200
			end
		--暴击伤害结算
		else
			local fac = 1.5
			--怒涛海潮，会心一击暴击效果+50%
			if (Curr_NG(pid, 177) or PersonKF(pid, 172)) and WAR.HXZYJ == 1 then
				fac = fac + 0.5
			end
			if match_ID(pid, 678) and JY.Person[678]["天2"] == 2 and JY.Wugong[wugong]["武功类型"] == 2 then
				fac = fac + JY.Person[pid]["指法技巧"]*0.001
			end
			if JY.Base["标准"] == 4 and pid == 0 and JY.Wugong[wugong]["武功类型"] == 4 and JY.Person[0]["阶"] >= 3 then
			   fac = fac + 1
			end
			--四大恶人，暴击效果+50%
			if match_ID(pid, 44) or match_ID(pid, 98) or match_ID(pid, 99) or match_ID(pid, 100) then
				fac = fac + 0.5
			end
			
			--袁承志，暴击效果随天书数量提高，仅限我方
			if match_ID(pid, 54) and inteam(pid) then
				fac = fac + 0.1 * JY.Base["天书数量"]
			end
			if match_ID(pid, 677) and JY.Person[677]["天2"] == 1 then
				fac = fac + math.modf(((JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"])/JY.Person[pid]["生命最大值"])*50)/100
			end
			--逆运经脉，暴击效果+20%
			if Curr_NG(pid, 104) then
		        fac = fac + 0.2
				if JY.Person[pid]["天赋内功"] == 104 then
					 fac = fac + 0.2
				end
				if tg ~= 1 then
				   if fx < 0 then
				      fac = fac - fx*0.01
				   end
				else
				      fac = fac - yin*0.01
				end   
	        end
			if JY.Person[pid]["专2"] == 104 and PersonKF(pid, 104) then
		       fac = fac + 0.2
		    end
			if JY.Person[60]["阶"] >= 3 and match_ID(pid, 60) then
		        fac = fac + 0.5
		    end
			if JY.Person[81]["阶"] >= 1 and match_ID(pid, 81) then
		        fac = fac + 0.1*JY.Person[81]["阶"]^2 + 0.2
		    end
			if JY.Person[pid]["人33"] == 1 then
	           fac = fac + 0.20
	        end
			if JY.Person[pid]["地2"] == 8 then
		       fac = fac + 0.01*JY.Person[124]["天1"] + 0.3
		    end
			if PersonKF(pid, 104) and PersonKF(pid, 95) then
				fac = fac + 0.1
			end
			if match_ID_awakened(pid, 81, 1) and wugong==17 then
				hurt = hurt * WAR.ZJZBJ
			else
				hurt = hurt * fac
			end
			--铁面侠
	        if match_ID(eid, 48) then
	           hurt = math.modf(hurt*0.8)
	        end
		end
	end
	
	--蓝烟清：燃木刀法，普通内功加力额外增加伤害--c
	if wugong == 65 and WAR.NGJL > 0 then
		hurt  = hurt + math.modf(get_skill_power(pid, WAR.NGJL, 11)/12);
	end
	
	--[[20大
	if JY.Person[104]["品德"] == 90 or JY.Person[104]["品德"] == 100 then
	   if pid == 0 then
	      hurt = math.modf(hurt*1.3)
	   end
	   if eid == 0 then
	      hurt = math.modf(hurt*0.7)
	   end
	end]]
	
	--灭杀豪升龙
	if WAR.MSHSL == 1 then
	   hurt = math.modf(hurt * 1.3)
	end
	
	--金庸
	if match_ID(eid, 669) then
	   if WAR.JYPJ[pid] ~= nil then
	   WAR.JYPJ[pid] = WAR.JYPJ[pid] + 1
	   else
	   WAR.JYPJ[pid] = 1
	   end
	end
	
	if match_ID(pid, 669) then
	   if WAR.JYPJ[eid] ~= nil then
	   WAR.JYPJ[eid] = WAR.JYPJ[eid] + 1
	   else
	   WAR.JYPJ[eid] = 1
	   end
	end
	
	if JY.Person[pid]["地1"] == 3 and JY.Person[eid]["生命"] < JY.Person[eid]["生命最大值"]/2 then
	   hurt = math.modf(hurt * 1.35)
	end
	
	if JY.Person[pid]["地3"] == 3 and WAR.MCRS == 1 then
		hurt = math.modf(hurt * 1.15)
	end
	
	if JY.Person[eid]["地3"] == 3 and WAR.MCRS == 1 then
		hurt = math.modf(hurt * 0.85)
	end
	
	if JY.Person[eid]["地3"] == 4 then
		hurt = math.modf(hurt * 0.85)
	end
	    
	--谢逊，被攻击时伤害一*60%
	if match_ID(eid, 13) then
		hurt = math.modf(hurt * 0.6)
	end
	if WAR.MXD[eid] ~= nil then
	   hurt = math.modf(hurt * 0.6)
	end
	if WAR.MXD[pid] ~= nil then
	   hurt = math.modf(hurt * 1.4)
	end
	--聂风
	if match_ID(eid, 681) and WAR.LQZ[eid] == 100 then
	   hurt = math.modf(hurt * 0.8)
	end

	--丁春秋北冥重生前降低25%攻击力		
	if WAR.WCY[eid] == 1 and match_ID(eid, 46) then
		hurt = math.modf(hurt * 0.75)	
	end

	--丁春秋北冥重生前降低25%防御力		
	if WAR.WCY[eid] == nil and match_ID(eid, 46) then
		hurt = math.modf(hurt * 1.25)	
	end

	--丁春秋北冥重生后提高25%攻击力		
	if WAR.WCY[pid] == 1 and match_ID(pid, 46) then
		hurt = math.modf(hurt * 1.25)	
	end

	--丁春秋北冥重生后提高25%防御力		
	if WAR.WCY[pid] == nil and match_ID(pid, 46) then
		hurt = math.modf(hurt * 0.75)	
	end
		
	if WAR.WCY[eid] == 1 and match_ID(pid, 692) then
		hurt = math.modf(hurt * 1.2)	
	end
	
	if WAR.EFLH[pid] == 1 then
		hurt = math.modf(hurt * 1.35)	
	end
	--刹活孔
	if WAR.SHK[pid] ~= nil then
		hurt = math.modf(hurt * 1.5)	
	end
	if WAR.NQK[pid] ~= nil then
		hurt = math.modf(hurt * (1.35^WAR.NQK[pid]))	
	end
	if WAR.NQK[eid] ~= nil then
		hurt = math.modf(hurt * (0.65^WAR.NQK[eid]))	
	end
	
	if eid == 0 and JY.Person[0]["天4"] == 2 and math.random(100) <= 25 then
	   hurt = math.modf(hurt * 0.75)
	end

	--玉女心经加力，提高古墓武学伤害		
	if WAR.NGJL==154 and (wugong == 6 or wugong == 42 or wugong == 79 or wugong == 139) then
		hurt = hurt + math.modf(JY.Wugong[wugong]["攻击力10"]/4)
	end
  
	--程英，半血以下，攻击时伤害一*120%
	if match_ID(pid, 63) and JY.Person[pid]["生命"] < math.modf(JY.Person[pid]["生命最大值"] / 2) then
		hurt = math.modf(hurt * 1.2)
	end
	
	if PersonKF(eid, 15) and JY.Person[eid]["专2"] == 15 and (JY.Wugong[wugong]["武功类型"] == 1 or JY.Wugong[wugong]["武功类型"] == 2) then
	   hurt = math.modf(hurt * 0.65)
	end
	
	--柯镇恶
	if match_ID(eid, 130) and JY.Person[eid]["生命"] < math.modf(JY.Person[eid]["生命最大值"]*0.3) then
		hurt = math.modf(hurt * 0.9)
		if math.random(2) == 1 then
		Set_Eff_Text(enemyid, "特效文字2", "杀要剐，悉听尊便")
		else
		Set_Eff_Text(enemyid, "特效文字2", "柯某皱一下眉头，便不算好汉")
		end
	end
					
	if JY.Person[pid]["地1"] == 4 then
	local n = 1
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				n = n + 1
			end
		end
		hurt = math.modf(hurt*(1+n*0.03))
	end
	
	if JY.Person[eid]["地3"] == 6 then
	local n = 1
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				n = n + 1
			end
		end
		hurt = math.modf(hurt*(1-n*0.05))
	end
	
	if JY.Person[pid]["地8"] == 1 and JY.Person[0]["品德"] <= 30 then
	   hurt = math.modf(hurt * 1.2)
	end
	
	if JY.Person[pid]["地5"] == 5 and JY.Person[pid]["灼烧程度"] ~= nil then
	   hurt = math.modf(hurt * 1.15)
	end
	
	if JY.Person[eid]["地5"] == 5 and JY.Person[eid]["灼烧程度"] ~= nil then
	   hurt = math.modf(hurt * 0.85)
	end
	
	if JY.Person[pid]["地5"] == 6 then
	local add = (JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"])/JY.Person[pid]["生命最大值"]
	   hurt = math.modf(hurt * (1+add))
	end
  
	--brolycjw：龙岛主，攻击时伤害一*120%
	if match_ID(pid, 39) then
		hurt = math.modf(hurt * 1.2)
	end
  
	--brolycjw: 木岛主，被攻击时伤害一*80%
	if match_ID(eid, 40) then
		hurt = math.modf(hurt * 0.8)
	end
	
	--龙岛主减少20%
	if not inteam(pid) then
		for j = 0, WAR.PersonNum - 1 do
			if match_ID(WAR.Person[j]["人物编号"], 39) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				hurt = math.modf(hurt * 0.8)
			end
		end
	end
	
	--木岛主提高20%
	if inteam(pid) then
		for j = 0, WAR.PersonNum - 1 do
			if match_ID(WAR.Person[j]["人物编号"], 40) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				hurt = math.modf(hurt * 1.2)
			end
		end
	end
  
	--刀剑归真，攻击时伤害一*140%
	if WAR.DJGZ == 1 then
		hurt = math.modf(hurt * 1.2)
	end
	
	if pid == 0 and JY.Person[0]["天2"] == 3 then
	local x = 1+(JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])*0.7/JY.Person[pid]["生命最大值"]
	   hurt = math.modf(hurt*x)
	end
  
	--蓝凤凰，攻击时伤害一*110%
	if match_ID(pid, 25) then
		hurt = math.modf(hurt * 1.1)
	end

	--周伯通，每行动一次，攻击时伤害一+10%
	if match_ID(pid, 64) then
		hurt = math.modf(hurt * (1 + WAR.ZBT / 10))
	end
	
	--丁典，神照
	if match_ID(pid, 672) and Curr_NG(pid, 94) then
		hurt = math.modf(hurt * 1.1)
	end
	
	if match_ID(eid, 672) and Curr_NG(eid, 94) then
		hurt = math.modf(hurt * 0.9)
		if WAR.ZMSZ[eid] ~= nil then
		   WAR.ZMSZ[eid] = WAR.ZMSZ[eid] - math.random(3) - 1
		   if WAR.ZMSZ[eid] < 0 then
		      WAR.ZMSZ[eid] = nil
		   end
		end
	end

	--无酒不欢 持之以恒
	if JY.Base["特殊"] ==1 and JY.Person[31]["血量翻倍"]==1 and pid==0 then
		hurt = math.modf(hurt * (1 + WAR.WJBH / 20))
	end
	
	--先天功，非连击伤害减20%，连击伤害加40%
	if Curr_NG(eid, 100) then
		if WAR.ACT==1 then
		hurt = math.modf(hurt * 0.8)
		end
	end
	
	if JY.Person[eid]["地6"] == 4 and WAR.ACT>1 then
	   hurt = math.modf(hurt * 0.4)
	end
	
	if JY.Person[eid]["人35"] == 1 and WAR.ACT > 1 then
	   hurt = math.modf(hurt * 0.8)
	end
	
	if JY.Person[pid]["地4"] == 5 then
	   hurt = math.modf(hurt * (1.1 +WAR.ACT*0.1))
	end
	
	if JY.Person[pid]["地6"] == 5 then
	   hurt = math.modf(hurt * 0.7)
	end
	
	--张三丰：无根无形减伤
	if match_ID(eid, 5) and JLSD(20, 70, eid) then
		hurt = math.modf(hurt * 0.5)	
		Set_Eff_Text(enemyid, "特效文字2", "无根无形")
	end
	
	
	--无名，圣灵剑法
	if match_ID(pid, 671) and JY.Wugong[wugong]["武功类型"] == 3 and WAR.SLJF > 10 then
	local i = (WAR.SLJF-10)*0.02
	   hurt = math.modf(hurt*(1+i))
	end
	if match_ID(pid, 682) and JY.Wugong[wugong]["武功类型"] == 3 and WAR.SLJF > 10 then
	local i = (WAR.SLJF-10)*0.015
	   hurt = math.modf(hurt*(1+i))
	end
	
	--黯然
	if wugong == 25 and JY.Person[pid]["专2"] == 25 then
	   hurt = math.modf(hurt*1.25)
	end
	
	--七相拳
	if match_ID(pid, 676) and WAR.QXQ == 1 then
	   hurt = math.modf(hurt*1.25)
	end
  
	--宋青书 一个女的+5%伤害一
	if match_ID(pid, 82) then
		local s = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and JY.Person[WAR.Person[j]["人物编号"]]["性别"] == 1 then
				s = s + 1
			end
		end
		hurt = math.modf(hurt * (1 + s*0.05))
	end
	
	--朱九真 一个男的+5%伤害一
	if match_ID(pid, 81) then
		local s = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and JY.Person[WAR.Person[j]["人物编号"]]["性别"] == 0 then
				s = s + 1
			end
		end
		hurt = math.modf(hurt * (1 + s*0.05))
	end
	
	--无酒不欢 无女不欢
	if JY.Base["特殊"] ==1 and JY.Person[24]["血量翻倍"]==1 and eid==0 then
		local s = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and JY.Person[WAR.Person[j]["人物编号"]]["性别"] == 1 then
				s = s + 1
			end
		end
		hurt = math.modf(hurt * (1 - s*0.05))
	end
	
	--无酒不欢 无基不欢
	if JY.Base["特殊"] ==1 and JY.Person[25]["血量翻倍"]==1 and eid==0 then
		local s = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and JY.Person[WAR.Person[j]["人物编号"]]["性别"] == 0 then
				s = s + 1
			end
		end
		hurt = math.modf(hurt * (1 - s*0.05))
	end
	
	
	
	--骆冰 一个男的+5%伤害一
	if match_ID(pid, 154) then
		local s = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and JY.Person[WAR.Person[j]["人物编号"]]["性别"] == 0 then
				s = s + 1
			end
		end
		hurt = math.modf(hurt * (1 + s*0.05))
	end
  
	--岳灵珊 每个剑法提高伤害一10%
	if match_ID(pid, 79) then
		hurt = math.modf(hurt * (1 + JianNum(pid)*0.1))
	end
	
	--宁中则 每个剑法提高免伤一5%
	if match_ID(eid, 649) then
		hurt = math.modf(hurt * (1 - JianNum(eid)*0.05))
		Set_Eff_Text(enemyid, "特效文字2", "坐地能吸土")
	end
  
	--苏荃为守方，在战场时，伤害一减少10%
	if not inteam(pid) then
		for j = 0, WAR.PersonNum - 1 do
			if match_ID(WAR.Person[j]["人物编号"], 87) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				hurt = math.modf(hurt * 0.9)
			end
		end
	end
  
	--阿珂和张召重为攻方，在战场时，伤害一提高10%
	if inteam(pid) then
		for j = 0, WAR.PersonNum - 1 do
			if (match_ID(WAR.Person[j]["人物编号"], 86) or match_ID(WAR.Person[j]["人物编号"], 80)) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				hurt = math.modf(hurt * 1.1)
			end
		end
	end
	
	--达尔巴，被死战锁定的目标，伤害一+50%
	if match_ID(pid, 160) and WAR.SZSD == eid then
		hurt = math.modf(hurt * 1.5)
	end
	
	
		--金刚伏魔圈，伤害一减少，气防提高
	if PersonKF(eid, 82) then
		local jgfmq = 0
		local effstr = "金刚伏魔圈"
		for j = 0, WAR.PersonNum - 1 do
			if PersonKF(WAR.Person[j]["人物编号"], 82) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
				jgfmq = jgfmq + 1
			end
		end
		--上限3人
		if jgfmq > 3 then
			jgfmq = 3
		end
		if jgfmq == 3 then
			effstr = "真."..effstr
		end
		if match_ID(eid, 597) then
			jgfmq = 3
		effstr = "真."..effstr
		end
		if jgfmq > 1 then
			hurt = math.modf(hurt * (1-0.15*(jgfmq-1)))
			dng = dng + 500 * (jgfmq-1)
			Set_Eff_Text(enemyid, "特效文字3", effstr)
		end
	end
	
	--太极蓄力增加气御
	if PersonKF(eid,171) and WAR.tmp[3000 + eid]~= nil  then
		dng = dng + math.modf(WAR.tmp[3000 + eid]/10)
	end   
	
	--七夕黄蓉，打狗棒法，缠字诀，下回合不可移动
	if wugong == 80 and match_ID(pid, 613) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
		WAR.L_NOT_MOVE[eid] = 1
	end
	
	--七伤拳，离
	if wugong == 23 and (WAR.YZQS == 4 or WAR.YZQS == 7) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
	   WAR.L_NOT_MOVE[eid] = 1
	   if JY.Person[pid]["内力"] < 5000 and JY.Person[pid]["内力最大值"] < 9999 then
	      WAR.L_NOT_MOVE[pid] = 1
	   end
	end
	--名动江湖
	if wugong == 199 and match_ID(pid, 671) and WAR.MMZS == 9 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
		WAR.L_NOT_MOVE[eid] = 1;
	end
	--名动江湖
	if wugong == 217 and WAR.AHZS == 2 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
		WAR.L_NOT_MOVE[eid] = 1;
	end
	--黄沙万里
	if wugong == 78 and (JY.Person[pid]["专2"] == 78 or (match_ID(pid, 25) and JY.Person[25]["阶"] >= 1)) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
		WAR.L_NOT_MOVE[eid] = 1;
	end
	if JY.Wugong[wugong]["武功类型"] == 5 and JY.Person[pid]["专2"] == 164 and math.random(100) > 74 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
		WAR.L_NOT_MOVE[eid] = 1;
	end
	
	--琴棋书画，倚天屠龙功，下回合不可移动
	if wugong == 84 and QinqiSH(pid) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
		WAR.L_NOT_MOVE[eid] = 1
	end

	--满洲摔跤，下回合不可移动
	if wugong == 119  and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
		WAR.L_NOT_MOVE[eid] = 1
	end

	--花开花落，下回合不可移动
	if (HuaKHL(pid) and (wugong ==10 or wugong ==30 or wugong ==115)) 
	or (wugong==157 and match_ID(pid, 617)) 
	or (wugong==30 and match_ID(pid, 21) and JY.Person[21]["阶"] >= 1) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then	
		WAR.Person[enemyid]["特效动画"] = 104
			WAR.HKHL[eid] = 10
	end
	
	--天罗地网，柔网势
	if Curr_QG(pid,148) then
		WAR.TLDW[eid] = 1;
	end
  
	--斗转星移伤害和杀集气计算
	if WAR.DZXYLV[pid] ~= nil and WAR.DZXYLV[pid] > 10 then
		hurt = math.modf(hurt * WAR.DZXYLV[pid] / 130)--100
		ang = ang + WAR.DZXYLV[pid] * 7--10
		if match_ID(pid, 51) or match_ID(pid, 113) then
		   hurt = hurt*1.3
		   ang = ang*1.3
		end
		if match_ID(pid, 51) and JY.Person[51]["阶"] >= 3 then
		   hurt = hurt*2
		   ang = ang*2
		end
	end
  
	--逆运走火
	--伤害一加成
	if WAR.tmp[1000 + pid] == 1 then
		hurt = math.modf(hurt * 1.1)
	end
  
	if WAR.tmp[1000 + eid] == 1 then
		hurt = math.modf(hurt * 0.9)
	end
	
	--攻方为玩家时，伤害一 = 伤害一 * (1 - 攻方内伤 * 0.002)
	if inteam(pid) then
		hurt = math.modf(hurt * (1 - JY.Person[pid]["受伤程度"] * 0.003))	  
	--攻方为NPC时，伤害一 = 伤害一 * (1 - 攻方内伤 * 0.0015)
	else
		hurt = math.modf(hurt * (1 - JY.Person[pid]["受伤程度"] * 0.0022))
	end
	
	--无影神拳
	if WAR.DDSQ == 1 then
	   hurt = math.modf(hurt * 1.1)
	   if JY.Person[672]["品德"] == 100 then
		   hurt = math.modf(hurt * 1.3)
	   end
	   if JY.Person[672]["阶"] >= 2 then
	      hurt = math.modf(hurt * 1.3)
	   end
	end
  
	--欧阳锋  战斗171 伤害减少
	if pid == 60 and WAR.ZDDH == 171 then
		hurt = math.modf(hurt * 0.8)
	end
	  
	--欧阳锋  战斗171 受伤害提高
	if eid == 60 and WAR.ZDDH == 171 then
		hurt = math.modf(hurt * 1.2)
	end
	  
	--圣火三使 伤害提高
	if WAR.ZDDH == 14 and (pid == 173 or pid == 174 or pid == 175) then
		local shz = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
			shz = shz + 1
			end
		end
		if shz == 3 then
			hurt = math.modf(hurt * 1.5)
		end
	end
	
	if JY.Person[eid]["地6"] == 4 then
	   hurt = math.modf(hurt*0.8)
	end
	
	if WAR.JQSDXS[pid] ~= nil and JY.Person[pid]["地5"] == 2 then
	   hurt = math.modf(hurt*(1+0.006*WAR.JQSDXS[pid]))
	end
	
	--diamond
	if JY.Person[eid]["地3"] == 8 then
	   hurt = math.modf(hurt*(0.85-math.random(100)*0.01))
	end
	
	if JY.Person[eid]["地4"] == 1 and pid == 642 then
	   hurt = math.modf(hurt * 0.8)
	end
	
	if JY.Person[pid]["地10"] == 5 then
	   hurt = math.modf(hurt * 2)
	end
	
	if JY.Person[pid]["地9"] == 3 and eid == 642 then
	   hurt = math.modf(hurt * 2)
	end
  
	--圣火三使 受伤害减少、气防提高
	if WAR.ZDDH == 14 and (eid == 173 or eid == 174 or eid == 175) then
		local shz = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
			shz = shz + 1
			end
		end
		if shz == 3 then
			hurt = math.modf(hurt * 0.5)
			dng = dng + 1000
		end
	end

	--落花流水,气攻增加，气防增加
	if WAR.ZDDH == 42 then
		if pid==94 or pid==95 or pid == 96 or pid == 52 then
			ang = ang + 500
		end
	end
	
	if WAR.ZDDH == 42 then
		if eid==94 or eid==95 or eid == 96 or eid == 52 then
			dng = dng + 500
		end
	end
   
	--全真七子，天罡北斗阵，增加伤害和气攻
	if WAR.ZDDH == 73 then
		if (pid >= 123 and pid <= 128) or pid == 68 then
			hurt = math.modf(hurt * (1+0.30))
			ang = ang + 1200
		end
	end
	
	--阿黄
	if JY.Person[pid]["动物"] == 347 then
	   ang = ang + 250*JY.Thing[347]["装备等级"]
	end
	
	if match_ID(pid, 675) and JY.Wugong[wugong]["武功类型"] == 3 then
		JY.Person[675]["声望"] = JY.Person[675]["声望"] + math.random(3) + 1
		if JY.Person[675]["声望"]>600 then
			JY.Person[675]["声望"]=600
		end
	end
	
	if eid==0 and Curr_NG(eid,144) then
	JY.Person[596]["声望"] = JY.Person[596]["声望"] + 230 + math.random(50)
	if JY.Person[596]["声望"]>30000 then
		JY.Person[596]["声望"]=30000
		end
	end
	
	if pid==0 and wugong==140 then
	JY.Person[595]["声望"] = JY.Person[595]["声望"] + 270 + math.random(50)
	if JY.Person[595]["声望"]>30000 then
		JY.Person[595]["声望"]=30000
		end
	end
	
	--神刀斩
	if inteam(pid) and wugong==189 and JY.Person[pid]["武器"]==319 and (match_ID(pid, 691) or JY.Person[pid]["专2"] == 189)==false then
		JY.Person[pid]["无用"]=JY.Person[pid]["无用"]+1
		AddPersonAttrib(pid, "生命最大值", -1)
	end	
	
	--丁典，觉醒
	if match_ID(pid, 672) then
	  if JY.Person[672]["品德"] == 70 then
		ang = ang + 800
		hurt = math.modf(hurt * 1.1)  
	  end
	end
	
	if match_ID(eid, 672) then
	  if JY.Person[672]["品德"] == 100 then
		dng = dng + 800
		hurt = math.modf(hurt * 0.9)  
	  end
	end
	  
	--全真七子，天罡北斗阵，受伤害减少和增加气防
	if WAR.ZDDH == 73 then
		if (eid >= 123 and eid <= 128) or eid == 68 then
			hurt = math.modf(hurt * 0.7)
			dng = dng + 1200
			WAR.Person[enemyid]["特效动画"] = 93
			Set_Eff_Text(enemyid, "特效文字2", "天罡北斗阵护体")
		end
	end

	--金刚伏魔圈
	if WAR.ZDDH == 253 then
		if eid == 597 or eid == 598 or eid == 599 then
			hurt = math.modf(hurt * 0.7)
			dng = dng + 3000
		end
	end
	
	if WAR.ZDDH == 253 then
		if pid == 597 or pid == 598 or pid == 599 then
			hurt = math.modf(hurt * 1.3)
			ang = ang + 3000
		end
	end
	
	--桃谷六仙，气防+600
	if JY.Base["畅想"]==147 then
		if eid >= 143 and eid <= 148 then
			dng = dng + 600
			WAR.Person[enemyid]["特效动画"] = 134
			Set_Eff_Text(enemyid, "特效文字2", "桃谷六仙")
		end
	end
	
	--如果学有五岳剑诀，且未发动真气护体，则有(御剑-220)%几率触发以剑御气，气防+600
	if PersonKF(eid, 175) and WAR.ZQHT == 0 then
		local yj = limitX(TrueYJ(eid),0,320)
		local chance = yj - 220
		if math.random(100) <= chance or inteam(eid) == false then
			dng = dng + 600
			WAR.Person[enemyid]["特效动画"] = 137
			Set_Eff_Text(enemyid, "特效文字1", "以剑御气")
		end
	end
	
	WAR.ZQHT = 0	
	
	--无酒不欢：小无相功增加气防
	--主运
	if Curr_NG(eid, 98) then
	  if match_ID(eid, 670) and JY.Person[eid]["天赋内功"] == 98 then
	     dng = dng * 2
	  else
		dng = dng * 1.3
	  end
	--被动
	elseif PersonKF(eid, 98) then
	  if match_ID(eid, 670) and JY.Person[eid]["天赋内功"] == 98 then
	     dng = dng * 1.3
	  else
		dng = dng * 1.1
	  end
	end
	
	if JY.Person[eid]["天赋内功"] == 98 and Curr_NG(pid, 98) then
	   ang = ang*1.2
	   if match_ID(pid, 670) then
	      ang = ang * 1.3
	   end	  
	end
	
	--踏雪无痕，根据移动+气防
	if Curr_QG(eid, 178) then
		local fac = 0
		if WAR.TXWH[eid] then
			fac = WAR.TXWH[eid][3]
		end
		local js = fac*0.04
		dng = math.modf(dng*(1+js))
	end
	
	--单枪匹马组合，气防+10%
	if (JY.Person[eid]["武器"] == 54 or JY.Person[eid]["武器"] == 344) and (JY.Person[eid]["动物"] == 230 or JY.Person[eid]["动物"] == 349) and WAR.MCRS == 1 then
		dng = dng * 1.1
		if match_ID(eid, 688) then
		dng = dng * 1.1
		end
	end
	
	--单枪匹马组合，气攻+10%
	if (JY.Person[pid]["武器"] == 54 or JY.Person[pid]["武器"] == 344) and (JY.Person[pid]["动物"] == 230 or JY.Person[pid]["动物"] == 349) and WAR.MCRS == 1 then
		ang = ang * 1.1
		if match_ID(pid, 688) then
		ang = ang * 1.1
		end
	end
	
	--林朝英增加总气攻
	if match_ID(pid, 605) then
		ang = ang * 1.1
	end
	
	--霍都随机上毒
	if WAR.HDWZ == 1 then
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", math.random(13, 16));
	end
	
	if wugong == 3 and JY.Person[pid]["专1"] == 3 then
	   WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 50)
	end
	
	if JY.Person[pid]["人22"] == 1 and math.random(100) <= 20 then
	   WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 10+math.random(25))
	end
	
	if match_ID(pid, 646) and JY.Person[646]["天3"] == 1 then
	   WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 100)
	end
	
	if wugong == 19 and JY.Person[pid]["专2"] == 19 then
	   WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 50)
	end
	
	if match_ID(pid, 2) and JY.Person[2]["阶"] >= 2 then
	   WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", (JY.Person[2]["阶"]-1)*50)
	end
	
	--欧阳锋根据蛤蟆蓄力增加伤害
	if (match_ID(pid, 60) or JY.Person[pid]["天赋内功"] == 95) and WAR.OYFXL > 0 then
		hurt = hurt + WAR.OYFXL/4
		if match_ID(pid, 60) then
		   hurt = hurt + WAR.OYFXL/4
		end   
	end
  
	--乔峰，防御加成提升30%，半血时防御加成提升50%，血量低于25%防御加成提升75%
	if match_ID(eid, 50) and inteam(eid)==false then
		hurt = math.modf(hurt * 0.7)
		local minhurt = math.modf(hurt * 0.25)
		hurt = math.modf(hurt * JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"])
		if hurt < minhurt then
			hurt = minhurt
		end
	end
  
	--蓄力攻击
	if WAR.Actup[pid] ~= nil then
		--主运蛤蟆，伤害一*150%
		if Curr_NG(pid, 95) then
			hurt = math.modf(hurt * 1.5)
		--常态，伤害一*125%
		else
			hurt = math.modf(hurt * 1.25)
		end
	end
	
	--蛤蟆功蓄力
	if PersonKF(eid, 95) and WAR.JESS[eid] == nil then
		--蓄力机制
		if WAR.tmp[200 + eid] == nil or WAR.tmp[200 + eid] == 0 then
			WAR.tmp[200 + eid] = 50;
		else
			WAR.tmp[200 + eid] = WAR.tmp[200 + eid] + 35;
		end
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "・蛤蟆蓄力";
		else
			WAR.Person[enemyid]["特效文字2"] = "蛤蟆蓄力";
		end
	end
	
	--主运太极神功，60%几率累积太极之形
	if PersonKF(eid, 171) and JLSD(20,80,eid) then
		WAR.TJZX[eid] = (WAR.TJZX[eid] or 0) + 1
		if match_ID(eid, 5) and JY.Person[5]["阶"] >= 3 then
		WAR.TJZX[eid] = WAR.TJZX[eid] + math.random(5)
		   if WAR.TJZX[eid] > 30 then
			WAR.TJZX[eid] = 30
		   end
		else
		if WAR.TJZX[eid] > 10 then
			WAR.TJZX[eid] = 10
		end
		end
		Set_Eff_Text(enemyid, "特效文字3", "太极之形")
	end
	
	--被无招胜有招击中
	if WAR.FQY == 1 then
		if WAR.WZSYZ[eid] == nil then
			WAR.WZSYZ[eid] = 10
		else
			WAR.WZSYZ[eid] = WAR.WZSYZ[eid] + 10
		end
	end
	
	--无名。怨愤莫名
	if match_ID(pid, 671) and WAR.MMZS == 10 and math.random(200)<JY.Person[pid]["内力"]*0.01 then
	    WAR.YFMM[eid] = 3 + math.modf(JY.Person[pid]["内力"]*0.0005+JY.Person[pid]["御剑能力"]*0.005)
		Set_Eff_Text(enemyid, "特效文字1", "怨气缠身")
	end
	
	--被灵蛇拳击中
	if WAR.OYK == 1 then
		WAR.LSQ[eid] = 20
		if JY.Person[61]["阶"] >= 2 and match_ID(pid, 61) then
		   WAR.LSQ2[eid] = 20
		end
		if JY.Person[61]["阶"] >= 3 and match_ID(pid, 61) then
		   WAR.LSQ2[eid] = 30
		end
	end
	
	--被海大富化骨绵掌击中
	if WAR.HDF == 1 then
		WAR.HGMZ[eid] = 20
	end

	--阿大八臂神剑
	if WAR.ADA == 1 then
		if WAR.BBSJ[eid] == nil then
			WAR.BBSJ[eid] = 20
		else
			WAR.BBSJ[eid] = WAR.BBSJ[eid] + 20
		end
	end
	
	--丁典，无影神拳
	if WAR.DDSQ == 1 and DWPD() then
	   if WAR.WYSQ[eid] ~= nil then
	      WAR.WYSQ[eid] = WAR.WYSQ[eid] + 5
	   else
	      WAR.WYSQ[eid] = 10
	   end
	end
	
	if WAR.LMSJ == 6 and DWPD() then
	   if WAR.WYSQ[eid] ~= nil then
	      WAR.WYSQ[eid] = WAR.WYSQ[eid] + 5
	   else
	      WAR.WYSQ[eid] = 10
	   end
	end
	
	--魔刀
	if WAR.NFMD == 1 and DWPD() then
	   if WAR.MDLX[eid] ~= nil then
	      WAR.MDLX[eid] = WAR.MDLX[eid] + 2
	   else
	      WAR.MDLX[eid] = 5
	   end
	end
	
	--范遥挨打加减伤，上限20%
	if match_ID(eid,10) and WAR.GMYS < 50 and WAR.JESS[eid] == nil then
		WAR.GMYS = WAR.GMYS + 3
	end
	
	--般若掌 一空到底
	if WAR.YKDD == 1 then
		if WAR.YKDD1[eid] == nil then
			WAR.YKDD1[eid] = 10
		else
			WAR.YKDD1[eid] = WAR.YKDD1[eid] + 10
		end
	end
	
	--被杨逍击中的人，伤害增加1%，上限20%
	if match_ID(pid, 11) then
		WAR.GMZS[eid] = (WAR.GMZS[eid] or 0) + 3
		if WAR.GMZS[eid] > 50 then
			WAR.GMZS[eid] = 50
		end
	end

	--精心打磨，伤害增加1%，上限10000%	
	if JY.Base["难度"] >= 7 and inteam(pid)== false then
		WAR.ZZZS[eid] = (WAR.ZZZS[eid] or 0) + 1
		if WAR.ZZZS[eid] > 10000 then
			WAR.ZZZS[eid] = 10000
		end
	end
	
	--防御状态
	if WAR.Defup[eid] == 1 then
	    hurt = math.modf(hurt * 0.75)
	    if JY.Person[pid]["人5"] == 1 then
		   hurt = math.modf(hurt*1.25)
		end
		
		if PersonKF(eid, 101) then
		ang = math.modf(ang * 0.5)
		end
		if JY.Person[670]["无用"] == 1 and eid == 0 then
		   hurt = math.modf(hurt*0.75)
	    end
		if match_ID(eid, 673) then
		   hurt = math.modf(hurt * 0.2)
		end
		if JY.Person[171]["阶"] >= 1 and match_ID(eid, 171) then
		   hurt = math.modf(hurt*0.75)
		end
	end
   
	--连击，伤害，气攻计算
	if WAR.ACT > 1 then
		local LJ_fac = 0.7	--通常为70%
		--东方不败不减少
		--六脉神剑，夫妻刀法不减少
		--夭矫空碧不减少
		--温青青大暴不减少
		if match_ID(pid, 27) or wugong == 49 or wugong == 62 or WAR.YNXJ == 1 or WAR.WQQ == 1 then
			LJ_fac = 1
		end
		--雷震，刀法连击
		if match_ID(pid, 670) then
		   LJ_fac = 0.7+(TrueSD(pid)*0.0011)
		   if WAR.ACT == 3 and JY.Person[pid]["耍刀技巧"] >= 200 then
		      LJ_fac = LJ_fac + JY.Person[pid]["耍刀技巧"]*0.003
		   end
		   if JY.Person[pid]["耍刀技巧"] >= 80 then
		      LJ_fac = LJ_fac + 0.2
		   end
		   if JY.Person[pid]["耍刀技巧"] >= 320 then
		      LJ_fac = LJ_fac*1.2
		   end
		end
		
		if JY.Person[pid]["人9"] == 1 then
		   LJ_fac = LJ_fac+WAR.ACT*0.2
		end
		
		if match_ID(pid, 91) then
		   LJ_fac = LJ_fac + 0.35
		end
		
		--聂风连击
		if match_ID(pid, 681) then
		   LJ_fac = LJ_fac + JY.Person[681]["品德"]*0.1
		end
		--丁鹏
		if match_ID(pid, 691) and JY.Wugong[wugong]["武功类型"] == 4 then
		   LJ_fac = LJ_fac + JY.Person[pid]["实战"]*0.001
		end
		
		if wugong == 221 and WAR.YSZZS == 3 then
		   LJ_fac = LJ_fac + 0.65
		end
		
		--玉女剑法
	    if wugong == 42 and JY.Person[pid]["专1"] == 42 then
	       LJ_fac = LJ_fac + 0.3
	    end
		
		--瑜伽密乘减少被连击的伤害，气攻
		--主运减少40%
		--被动减少20%
		if Curr_NG(eid, 169) or (PersonKF(eid, 169) and Curr_NG(eid, 103)) then
			LJ_fac = LJ_fac - 0.3
		elseif PersonKF(eid, 169) then
			LJ_fac = LJ_fac - 0.15
		end
		
		hurt = math.modf(hurt * LJ_fac)
		ang = math.modf(ang * LJ_fac)
	end
  
	--无酒不欢：这里引入伤害二，计算保底伤害
	local hurt2 = 0

	--攻击方为我方，伤害二 = INT(攻方基础攻击/7 + 随机1~5) + INT(武功威力/15)
	if inteam(pid) then
		hurt2 = math.modf(math.random(5) + (atk) / 7) + math.modf(true_WL / 15)
	--攻击方为NPC，伤害二 = INT(攻方基础攻击/6 + 随机1~20) + INT(武功威力/13)
	else
		hurt2 = math.modf(math.random(20) + (atk) / 6) + math.modf(true_WL / 13)
	end
	--攻击方为NPC，伤害二 = 伤害二 * 1.2
	if not inteam(pid) then
		hurt2 = math.modf(hurt2 * 1.2)
	end
	
	--如果伤害一小于伤害二，则采用伤害二继续计算
	if hurt < hurt2 then
		hurt = hurt2
	end
	
	--无酒不欢：最终伤害计算，难度系数
	local difficulty_factor = 1;
	--我方攻击时
	if inteam(pid) then
		--难1，难2
		if JY.Base["难度"] == 1 or JY.Base["难度"] == 2 then
			difficulty_factor = 0.9;
		--难6
		elseif JY.Base["难度"] == 6 then
			difficulty_factor = 1.1;
		elseif JY.Base["难度"] >= 7 then
			difficulty_factor = 1.1;		
		end
		--武功数量
		if JY.Base["难度"] > 3 then
		local add1 = (JY.Person[671]["品德"]-12)*0.01*(JY.Base["难度"]-3)*(JY.Base["天书数量"]/14)
		     difficulty_factor = difficulty_factor - add1
		end
	--NPC攻击时
	else
		--难1
		if JY.Base["难度"] == 1 then
			difficulty_factor = 0.6;
		--难2
		elseif JY.Base["难度"] == 2 then
			difficulty_factor = 0.8;
		--难3，难4
		elseif JY.Base["难度"] == 3 or JY.Base["难度"] == 4 then
			difficulty_factor = 1.1;
		--难5
		elseif JY.Base["难度"] == 5 then
			difficulty_factor = 1.3;
		--难6
		elseif JY.Base["难度"] == 6 then
		difficulty_factor = 1.5
		elseif JY.Base["难度"] >= 7 then
		difficulty_factor = 1.5;
		end
		local add3 = 0.04*(JY.Base["天书数量"]-4)
		difficulty_factor = difficulty_factor + JY.Person[123]["天1"]*0.06*(JY.Base["天书数量"]/14) + add3
		
		--武功数量
		if JY.Base["难度"] > 3 then
		local add1 = (JY.Person[671]["品德"]-12)*0.015*(JY.Base["难度"]-3)*(JY.Base["天书数量"]/14)
		local add2 = (JY.Person[671]["品德"]-12)*0.005*JY.Base["难度"]
		
		     difficulty_factor = difficulty_factor + add1 + add2
		end
	end
	hurt = math.modf(hurt * 0.7 * difficulty_factor)
	
	--最终伤害 = 最终伤害 * (1 - 守方防御/5000)
	hurt =  math.modf(hurt * (1 - JY.Person[eid]["防御力"]/5000))
	
	--九阳神功主运，攻方面板上每个内功+3%伤害
	if Curr_NG(pid, 106) then
		local NG = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[pid]["武功" .. i]]["武功类型"] == 6 then
				NG = NG + 1
			end
		end
		hurt = math.modf(hurt * (1 + NG*0.03))
	end
	
	--九阳神功主运，守方面板每个内功-3%伤害	
	if Curr_NG(eid, 106) then
		local NG = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[eid]["武功" .. i]]["武功类型"] == 6 then
				NG = NG + 1
			end
		end
		hurt = math.modf(hurt * (1 - NG*0.03))
	end
		
	--攻方面板上每个极+3%伤害，守方面板每个极-3%伤害
	hurt =  math.modf(hurt * (1 + (calc_mas_num(pid) - calc_mas_num(eid))* 0.03))
	
	--击中破绽，25%最高优先级伤害和气攻加成，行动前没有破绽，最多击中3次破绽
	--防御状态无破绽
	--凌波微步无破绽
	--主运圣火60%几率无视位置
	if WAR.Defup[eid] == nil and Curr_QG(eid, 147) == false and (PersonKF(eid, 97) and PersonKF(eid, 93)) == false and (match_ID(eid, 57) and JY.Person[57]["阶"]>=3) == false and JY.Person[eid]["人16"] ~= 1 
	and ((WAR.Person[enemyid].Time >= -200 and WAR.Person[enemyid].Time <= 200) 
	or (Curr_NG(pid, 93) and match_ID(pid, 175)) 
	or (wugong == 199 and match_ID(pid, 671) and WAR.MMZS == 3 and JLSD(20,100,pid)) 
	or (match_ID(pid, 670) and WAR.SPSJ == 1)
	or (Curr_NG(pid, 93) and match_ID(pid, 174)) 
	or (Curr_NG(pid, 93) and match_ID(pid, 173)) 
	or (wugong==10 and match_ID(pid, 635))
	or (match_ID(pid, 47) and JY.Person[47]["阶"] >= 3)
	or (match_ID(pid, 18) and JY.Person[18]["阶"] >= 3 and math.random(100) < 51)
	or (match_ID(pid, 35) and JY.Person[35]["阶"] >= 2 and math.random(100) < 81 and JY.Wugong[wugong]["武功类型"] == 3)
	or (match_ID(pid, 66) and JY.Person[66]["阶"] >= 1 and wugong == 93)
	or (match_ID(pid, 691) and JY.Person[691]["天4"] == 2 and math.random(100) < 52)
	or (WAR.GJCG[eid] ~= nil and JLSD(20,80,pid))
	or (Curr_NG(pid, 93) and JLSD(20,80,pid)))--无视集气条 
	and ((WAR.Weakspot[eid] ~= nil and WAR.Weakspot[eid] < 3) 
	or (match_ID(pid, 47) and JY.Person[47]["阶"]>=3) 
	or JY.Person[pid]["地7"] == 4 
	or (match_ID(pid, 687) and wugong == 49 and WAR.LMZS == 2) 
	or ((JY.Person[pid]["专1"] == 74 or (PersonKF(pid, 74) and PersonKF(pid, 4))) and wugong == 74)
	or (match_ID(pid, 57) and JY.Person[57]["阶"]>=3) 
	or (match_ID(pid, 66) and JY.Person[66]["阶"] >= 1 and wugong == 93)
	or (JY.Person[pid]["人29"] == 1 and (JY.Person[eid]["冰封程度"] > 0 or JY.Person[eid]["灼烧程度"] > 0 or JY.Person[eid]["中毒程度"] > 0 or JY.Person[eid]["受伤程度"] > 0)))
	then
	if JY.Person[pid]["地7"] == 4 then
	   WAR.Weakspot[eid] = 0
	   hurt = math.modf(hurt * 1.15)
	end
	if match_ID(pid, 66) and JY.Person[66]["阶"] >= 1 and wugong == 93 then
	   WAR.Weakspot[eid] = 0
	end
	if match_ID(pid, 18) and JY.Person[18]["阶"] >= 3 then
	   hurt = math.modf(hurt * 1.8)
	   ang = math.modf(ang * 1.8)
	end
	if match_ID(pid, 47) and JY.Person[47]["阶"] >= 3 then
	   WAR.Weakspot[eid] = 0
	   hurt = math.modf(hurt * 1.5)
	end
	if match_ID(pid, 57) and JY.Person[57]["阶"] >= 3 then
	   WAR.Weakspot[eid] = 0
	end
	if JY.Person[pid]["人29"] == 1 and (JY.Person[eid]["冰封程度"] > 0 or JY.Person[eid]["灼烧程度"] > 0 or JY.Person[eid]["中毒程度"] > 0 or JY.Person[eid]["受伤程度"] > 0) then
	   WAR.Weakspot[eid] = 0
	   hurt = math.modf(hurt * 1.3)
	   ang = math.modf(ang * 1.3)
	end
	if match_ID(pid, 670) and WAR.SPSJ == 1 then
	   WAR.Weakspot[eid] = 0
	end
    if JY.Person[pid]["专1"] == 74 and wugong == 74 then
	   WAR.Weakspot[eid] = 0
	end
	if (PersonKF(pid, 74) and PersonKF(pid, 4)) and wugong == 74 then
	   WAR.Weakspot[eid] = 0
	end
	if match_ID(pid, 687) and wugong == 49 and WAR.LMZS == 2 then
	   WAR.Weakspot[eid] = 0
	end
		hurt = math.modf(hurt * 1.25)
		ang = math.modf(ang * 1.25)
		if PersonKF(pid, 93) then --圣火击中破绽
		   hurt = math.modf(hurt*1.2)
		   ang = math.modf(ang*1.2)
		   if JY.Person[pid]["专1"] == 93 then
		      hurt = math.modf(hurt*1.15)
		      ang = math.modf(ang*1.15)
		   end
		   if JY.Person[pid]["武器"] == 337 then
		      hurt = math.modf(hurt*1.15)
		      ang = math.modf(ang*1.15)
		   end	  
		end
		local pz_str = "击中破绽";
		if WAR.Weakspot[eid] == 1 then
			pz_str = "再中破绽";
		elseif WAR.Weakspot[eid] == 2 then
			pz_str = "三中破绽";
		end
		WAR.Weakspot[eid] = WAR.Weakspot[eid] + 1
		if WAR.Person[enemyid]["特效文字0"] ~= nil then
			WAR.Person[enemyid]["特效文字0"] = pz_str.."+"..WAR.Person[enemyid]["特效文字0"]
		else
			WAR.Person[enemyid]["特效文字0"] = pz_str
		end
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 63
		end
	end
	
	--落英神剑掌，配合桃花绝技，根据敌方内力耗损量追加伤害，上限+100%
	if wugong == 12 and TaohuaJJ(pid) then
		local mp_percentage = (JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])/JY.Person[eid]["内力最大值"]
		hurt = math.modf(hurt * (1 + mp_percentage))
	end
	
	--虚弱状态，伤害和杀气都减半
	if WAR.XRZT[pid] ~= nil or (DuZ() and JY.Person[pid]["中毒程度"] > 0 and not inteam(pid)) then
		hurt = math.modf(hurt * 0.5)
		ang = math.modf(ang * 0.5)
	end
	if WAR.GWG[pid] ~= nil then
		hurt = math.modf(hurt * 0.8)
		ang = math.modf(ang * 0.8)
	end
	
	--张无忌
	if match_ID(pid, 9) and math.random(100) <= 25 and WAR.LQZ[pid] ~= 100 and inteam(pid) then
	   hurt = math.modf(hurt * 0.75)
	   ang = math.modf(ang * 0.75)
	end	
	
	--七伤拳，意恍惚
	if WAR.QSQ6[pid] ~= nil then
		hurt = math.modf(hurt * 0.7)
		ang = math.modf(ang * 0.7)
	end
	
	--豪鬼，烈
	if JY.Person[673]["外号2"] == "烈" then
	for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.SYBD[WAR.Person[j]["人物编号"]] ~= nil then
			hurt = math.modf(hurt * 0.6)
		    ang = math.modf(ang * 0.6)
		end
	end
	end
	
	
	--雷震，寒
	if WAR.LZ_H[pid] ~= nil then
	local n = 0.8
	  if JY.Person[pid]["冰封程度"] ~= nil then
	      n = n - JY.Person[pid]["冰封程度"]*0.0002
	  end
		hurt = math.modf(hurt * n)
		ang = math.modf(ang * n)
	end
	
	--烈
	if WAR.LZ_L[eid] ~= nil then
	local n = 1.1
	  if JY.Person[eid]["灼烧程度"] ~= nil then
	      n = n + JY.Person[eid]["灼烧程度"]*0.0001
	  end
		hurt = math.modf(hurt * n)
		ang = math.modf(ang * n)
	end
	
	if WAR.CZSB[eid] ~= nil then
	local add = 1+(10+JY.Person[689]["天1"]*3)*0.01
		hurt = math.modf(hurt * add)
		ang = math.modf(ang * add)
	end

	--化骨绵掌，伤害和杀气降低25%
	if WAR.HGMZ[pid] ~= nil then
		hurt = math.modf(hurt * 0.75)
		ang = math.modf(ang * 0.75)
	end

	--龙爪手+灵蛇仗法 龙蛇演义 水笙自带
	if (LongShe(eid) or match_ID(eid, 589)) and JLSD(20,40,eid) then
		Set_Eff_Text(enemyid, "特效文字5", "龙蛇演义・不见不闻，觉险而避")
		War_Focus()
	end
	
	--集中状态，伤害和杀气都减半
	if WAR.Focus[pid] ~= nil then
		hurt = math.modf(hurt * 0.5)
		ang = math.modf(ang * 0.5)
	end
	
	--尼摩星伤害永久提高1.5倍
	if match_ID(pid, 159) then
		hurt = math.modf(hurt * 1.5)
	end
	
	--无酒不欢 天下无双
	if JY.Base["特殊"] ==1 and JY.Person[26]["血量翻倍"]==1 and pid==0 then
		hurt = math.modf(hurt * 1.25)
	end
	
	--范遥挨打加减伤，上限20%
	if match_ID(eid,10) then
		local rd = 100 - WAR.GMYS
		hurt = math.modf(hurt * rd/100)
	end
	
	--被杨逍击中的人，伤害增加1%，上限20%
	if WAR.GMZS[eid] ~= nil then
		local bn = 100 + WAR.GMZS[eid]
		hurt = math.modf(hurt * bn/100)
	end
	
	--精心打磨，伤害增加1%，上限10000%
	if WAR.ZZZS[eid] ~= nil then
		local cn = 100 + WAR.ZZZS[eid]
		hurt = math.modf(hurt * cn/100)
	end
	
	--灭绝的玉石俱焚状态
	if WAR.YSJF[pid] ~= nil then
		hurt = math.modf(hurt * 1.5)
	end
	if WAR.YSJF[eid] ~= nil then
		hurt = math.modf(hurt * 1.5)
	end

	--神刀斩
	if wugong==189 and (JY.Person[pid]["生命最大值"]==JY.Person[pid]["生命"] or JY.Person[pid]["武器"]==319) then
		hurt=math.modf(hurt*1.5)
	end
	
	--dylm
	if wugong == 49 and match_ID(pid, 53) then
	local t = 50 + JY.Person[pid]["实战"]*0.1
    local f = 130 + JY.Person[pid]["实战"]*0.15
	local h = math.random(t, f)/100
	if WAR.LQZ[pid] == 100 then
	   h = f/100
	end   
	hurt = hurt*h
	--Set_Eff_Text(WAR.CurID, "特效文字1", h)
	end
	
	if WAR.LXYZG == 1 and JY.Person[678]["天3"] == 1 then
	   hurt = math.modf(hurt*(1+JY.Person[pid]["指法技巧"]/1600))
	end   
	
	if match_ID(eid, 669) then
	   hurt = math.modf(hurt * (1-(JY.Base["天书数量"] - 14)*0.03))
	   if JY.Base["天书数量"] >= 28 then
	      Set_Eff_Text(enemyid, "特效文字5", "飞雪连天射白鹿 笑书神侠倚碧鸳")
	   end	  
	end
    
    if match_ID(eid, 681) then
	   if math.random(100) < 13 then
	      WAR.ZWZX[pid] = 30
		  Set_Eff_Text(enemyid, "特效文字1", "此人功力不在我之下")	  
	   elseif math.random(100) < 16 + JY.Base["天书数量"] then
	      local x = math.random(30)
	      if WAR.ZWZX[pid] == nil then
		     WAR.ZWZX[pid] = x
		  else
		     if WAR.ZWZX[pid] < x then
			    WAR.ZWZX[pid] = x
			 end	
		  end 
 		  Set_Eff_Text(enemyid, "特效文字1", "此人功力不在我之下")	  
       end	   
	   
	end

	if WAR.ZWZX[pid] ~= nil then
	   hurt = math.modf(hurt*0.7)
	end
	if WAR.ZWZX[eid] ~= nil then
	   hurt = math.modf(hurt*1.3)
	end
	
	--周芷若，每个内功减少受到的4%伤害
	if match_ID(eid, 631) then
		local zzr = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 6 then
				zzr = zzr + 1
			end
		end
		hurt = math.modf(hurt * (1 - 0.04 * zzr));
	end
	
	--主角拳系，每个拳法练到极，增加造成的5%伤害
	if JY.Base["标准"] == 1 and pid == 0 then
		local lxzq = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 1 and JY.Person[0]["武功等级" .. i] == 999 then
				lxzq = lxzq + 1
			end
		end
		if lxzq > 7 then
			lxzq = 7
		end
		hurt = math.modf(hurt * (1 + 0.05 * lxzq))
	end
	
	--无酒不欢 盖世神拳
	if JY.Base["特殊"] ==1 and JY.Person[16]["血量翻倍"]==1 and pid==0 then
		local lxzq = 5
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 1 and JY.Person[0]["武功等级" .. i] == 999 then
				lxzq = lxzq + 1
			end
		end
		hurt = math.modf(hurt * (1 + 0.01 * lxzq))
	end
	
	--主角拳系，每个拳法练到极，减少受到的5%伤害
	if JY.Base["标准"] == 1 and eid == 0 then
		local lxzq = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 1 and JY.Person[0]["武功等级" .. i] == 999 then
				lxzq = lxzq + 1
			end
		end
		if lxzq > 7 then
			lxzq = 7
		end
		hurt = math.modf(hurt * (1 - 0.05 * lxzq));
	end
	
	--无酒不欢 盖世神拳
	if  JY.Base["特殊"] ==1 and JY.Person[16]["血量翻倍"]==1 and eid==0 then
		local lxzq = 5
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 1 and JY.Person[0]["武功等级" .. i] == 999 then
				lxzq = lxzq + 1
			end
		end
		hurt = math.modf(hurt * (1 - 0.01 * lxzq));
	end
	  
	--主角刀系，每个刀法练到极，减少受到的5%伤害
	if JY.Base["标准"] == 4 and eid == 0 then
		local askd = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 4 and JY.Person[0]["武功等级" .. i] == 999 then
				askd = askd + 1
			end
		end
		if askd > 7 then
			askd = 7
		end
		hurt = math.modf(hurt * (1 - 0.05 * askd))
	end
	
	--无酒不欢 傲世狂刀
	if JY.Base["特殊"] ==1 and JY.Person[19]["血量翻倍"]==1 and eid==0 then
		local askd = 5
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 4 and JY.Person[0]["武功等级" .. i] == 999 then
				askd = askd + 1
			end
		end
		hurt = math.modf(hurt * (1 - 0.01 * askd))
	end
	
	--罗汉伏魔提升伤害和杀气效果为：[(当前内力值/500)×(武功消耗内力/140)]%
	if WAR.NGJL == 96 or (Curr_NG(pid, 108) and PersonKF(pid, 96)) or (match_ID(pid,38) and PersonKF(pid,96)) then
	local x = 0
		if tg ~= 1 then
			if fx > 0 then
			   x = x + math.modf(fx*0.7)
			end
		else
			x = x + math.modf(yang*0.7)
		end   
		local nlmod = JY.Person[pid]["内力"]/(5000-30*x)
		local wgmod = JY.Wugong[wugong]["消耗内力点数"]/(200-x*2)
		local totalmod = 1 + nlmod * wgmod
		--石破天效果提高1.1倍
		if match_ID(pid, 38) then
			totalmod = totalmod * 1.1
		end
		ang = math.modf(ang * totalmod)
		hurt = math.modf(hurt * totalmod)
	end
	
	--进阶云雾，对于半血以下敌人伤害*2
	if wugong == 32 and PersonKF(pid,175) and JY.Person[eid]["生命"]<JY.Person[eid]["生命最大值"]/2 then
		hurt = hurt * 2
	end
	
	if JY.Wugong[wugong]["武功类型"] == 3 and match_ID(pid, 683) and JY.Person[683]["天2"] == 2 then
	local m = (JY.Person[eid]["生命最大值"]-JY.Person[eid]["生命"])*2/JY.Person[eid]["生命最大值"]
		hurt = math.modf(hurt * (1+m))
	end
	
	if WAR.JSAY == 1 then
	   hurt = hurt + 300
	end

	if WAR.LHQ_BNZ == 1 then	--般若掌 伤害+200

		hurt = hurt + 200
		if tg ~= 1 then
		   if fx > 0 then
		   hurt = hurt + fx*8
		   end
		   if fx > 9 then
		   hurt = hurt + 100
		   end
		else  
		   hurt = hurt + yang*8 + 100
		end
	end
	if WAR.YZC_MKZ == 1 then		--摩柯指 伤害+150
		hurt = hurt + 150
	end
	if WAR.JGZ_DMZ == 1 then		--达摩掌 伤害+100
		hurt = hurt + 100
		if tg ~= 1 then
		   if fx > 0 then
		   hurt = hurt + fx*12
		   end
		else  
		   hurt = hurt + yang*12
		end
	end
	if WAR.FMZ_BFSC == 1 then		--八法神禅 伤害+100
		hurt = hurt + 100
	end
	if WAR.WD_CLSZ == 1 then		--赤练神掌 伤害+70
		hurt = hurt + 70
		if tg ~= 1 then
		   if fx < 0 then
		   hurt = hurt - fx*17
		   end
		else  
		   hurt = hurt - yin*17
		end
	end		
	if WAR.LHQ_YKDD==1 then			--一空到底 伤害+250
		hurt = hurt + 200
	end
	
	if match_ID(pid, 671) then 
	   if JY.Person[pid]["生命最大值"]*0.5 <= JY.Person[pid]["生命"] then 
	      hurt = math.modf(hurt*0.7)
	   end
	end
	
	if match_ID(eid, 671) then 
	   if JY.Person[eid]["生命最大值"]*0.3 >= JY.Person[eid]["生命"] then --and JY.Person[pid]["内力最大值"]*0.1 >= JY.Person[pid]["内力"] then
	      hurt = math.modf(hurt*0.7)
	   end
	   if JY.Person[eid]["生命最大值"]*0.5 <= JY.Person[eid]["生命"] then 
	      hurt = math.modf(hurt*1.3)
	   end
	end
	
	--无名，减伤
	if match_ID(eid, 671) and hurt > 30 then
	local x = 1 - TrueYJ(eid)*0.00015
	   hurt = math.modf(hurt*x)
	   if hurt < 30 then
	      hurt = 30
	   end
	   WAR.Person[enemyid]["特效动画"] = 120
		Set_Eff_Text(enemyid, "特效文字2", "九天剑气")
		if WAR.YXMM[eid] ~= nil then --隐姓埋名
		   WAR.YXMM[eid] = WAR.YXMM[eid] - 5
		   if WAR.YXMM[eid] < 1 then
		      WAR.YXMM[eid] = nil
		   end
		end
	end
	if match_ID(eid, 638) then
	   WAR.DJSS = WAR.DJSS + 1
	end
	--杀意状态
	if match_ID(pid, 673) then
	   
	   --杀意
	   if WAR.SYBD[pid] ~= nil and JY.Person[673]["外号2"] == "怒" and WAR.SYBD[pid] > 1 then
	      hurt = math.modf(hurt*1.2) + math.floor(JY.Person[eid]["生命"]*0.1)
		  WAR.SYBD[pid] = WAR.SYBD[pid] - 1
		  if WAR.SYBD[pid] < 1 then
		     WAR.SYBD[pid] = 1
			 --PlayMIDI(math.random(10)+99)
		  end
		  --升龙
	      if wugong == 203 then
	         hurt = hurt + math.modf(JY.Person[pid]["拳掌功夫"]*0.2)   	  
	      end
	   end
	   
	   local n = 16+math.random(4)-WAR.HNLZ
	   local z = math.ceil(50-JY.Person[pid]["资质"]/2)
	   local s = QuanNum(pid)*10 + 80 + z
		
	   if WAR.NLZ[pid] ~= nil then
	   WAR.NLZ[pid] = WAR.NLZ[pid] + n
	   else
	   WAR.NLZ[pid] = n
	   end
	   
	   if WAR.NLZ[pid] > s then
	      WAR.NLZ[pid] = s
	   end
	end
	
	--豪鬼，能量值
	if match_ID(eid, 673) and hurt > 30 then
	local n = math.max(9,math.modf(hurt*0.05))+math.random(7) + 4
	n = n - JY.Base["难度"]
	
	local s = 0
	for i = 1, JY.Person[671]["品德"] do
		if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 1 and JY.Person[0]["武功" .. i] > 0 then
			s = s + 1
		end
	end
	local z = math.ceil(50-JY.Person[eid]["资质"]/2)
	s = s*10 + 80 + z
	   if WAR.NLZ[eid] ~= nil then
	   WAR.NLZ[eid] = WAR.NLZ[eid] + n
	   else
	   WAR.NLZ[eid] = n
	   end
	   if WAR.NLZ[eid] > s then
	      WAR.NLZ[eid] = s
	   end
	end
	
	if match_ID(pid, 673) and wugong == 205 then
	   hurt = hurt + math.modf(JY.Person[eid]["生命最大值"]*0.18)
	   WAR.HMZT[eid] = 1
	   WAR.JHLY[eid] = 15
	end
	
	if match_ID(pid, 673) and WAR.SYBD[pid] ~= nil and JY.Person[pid]["外号2"] == "怒" and math.random(100) < 35 then
	   WAR.WYSQ[eid] = math.random(12)
	end
	
	if match_ID(pid, 673) and JY.Person[673]["外号2"] == "烈" and WAR.MSHBD == 1 and wugong == 202 then
	   WAR.JHLY[eid] = 8
	end 
	
	if match_ID(pid, 673) and JY.Person[673]["外号2"] == "怒" and WAR.MSHSL == 1 and wugong == 203 then
	   WAR.JHLY[eid] = 8
	end
	--中华傲诀
	if wugong == 213 and math.random(100) < 50 then
	   WAR.HMZT[eid] = 1
	end
	--谢烟客，碧针清掌
	if match_ID(pid, 164) and wugong == 206 then
		WAR.LSQ[eid] = math.random(15)+7
	end
	
	--查克拉
	if JY.Person[pid]["武器"] == 338 and wugong == 158 then
	    if WAR.LRHF[eid] ~= nil then
		WAR.LRHF[eid] = WAR.LRHF[eid] + JY.Thing[338]["装备等级"]
		else
		WAR.LRHF[eid] = JY.Thing[338]["装备等级"]
		end
		if match_ID(pid, 62) then
		   WAR.LRHF[eid] = WAR.LRHF[eid] + JY.Thing[338]["装备等级"]
		end 
	end
	
	
	--雷震，火焰刀
	if match_ID(pid, 670) and wugong == 66 then
		hurt = hurt + JY.Person[eid]["灼烧程度"]*3
	end
	
	 --雷震天内
	if match_ID(pid, 670) then 
	    if WAR.BMXH == 1  and JY.Person[0]["天赋内功"] == 85 then
	        if JY.Person[eid]["内力"] < math.modf(JY.Person[eid]["内力最大值"] * 0.09) then
		       hurt = hurt + math.modf(JY.Person[eid]["内力最大值"] * 0.09)-JY.Person[eid]["内力"]
		    end
		elseif WAR.BMXH == 3 and JY.Person[eid]["中毒程度"] > 0  and JY.Person[0]["天赋内功"] == 87 then
		       hurt = hurt + JY.Person[eid]["中毒程度"]
		end
	end
	
	
	
	
	--[[雷震，指法
	if match_ID(pid, 670) and JY.Wugong[wugong]["武功类型"] == 2 then
	   hurt = math.modf(hurt*1.1)
	end]]
	
	--持国无敌
	if (JY.Person[eid]["防具"] == 326 or JY.Person[eid]["防具"] == 327) and JY.Base["天书数量"] >= 1 then
	    hurt = hurt - JY.Base["天书数量"]*5
		if JY.Person[eid]["防具"] == 327 then
		   hurt = math.modf(hurt * 0.9)
		end
		WAR.Person[enemyid]["特效动画"] = 136
		if JY.Person[eid]["防具"] == 326 then
		   Set_Eff_Text(enemyid, "特效文字2", "持国无敌")
		else
		   Set_Eff_Text(enemyid, "特效文字2", "天怒十方")
		end
		if hurt <= 0 then
		   hurt = 1
		end
	end
	
	
	--九剑真传，倒剑式强制杀集气
	if WAR.JJZC == 2 then
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 200
	end
	if wugong == 217 and WAR.AHZS == 3 then
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 200
	end
	if match_ID(pid, 673) and JY.Wugong[wugong]["武功类型"] == 1 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - math.modf(get_skill_power(pid, wugong, 11)*0.1)
	end
	if WAR.LIBAI == 3 or WAR.LIBAI == 4 or WAR.LIBAI == 5 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 400
	end

	if match_ID(pid, 693) and wugong == 248 then
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 1500
	end
	
	--升龙拳
	if wugong == 203 then
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 150
		if WAR.MSHSL == 1 then
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 250
		end
	end
	   
	--铁掌
	if wugong == 13 and JY.Person[pid]["专2"] == 13 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 150 - math.random(10)*10
	end
	
	--灭绝，倚天剑
	if JY.Person[pid]["武器"] == 37 and match_ID(pid, 6) then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 100
	end
	if WAR.WLDF == 5 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 400
	end
	if wugong == 221 and WAR.YSZZS == 1 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 200
	end
	
	if match_ID(pid, 687) and wugong == 49 and WAR.LMZS == 3 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 300
	end
	--强袭飓风
	if wugong == 228 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 190*math.modf(JY.Person[689]["天1"]*0.5) - 400
	end
	if match_ID(pid, 689) and not inteam(pid) then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 200
	end
	
	--北斗神拳
	if WAR.BDSQ == 1 then
	local jl = 11
	if WAR.LQZ[pid] == 100 then
	   jl = jl + 25
	end
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 100 - JY.Person[pid]["拳掌功夫"]
	   if math.random(100) < jl then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 1000
	   end
	   WAR.BDSQ = 0
	end
	--
	if wugong == 201 and JY.Person[pid]["专2"] == 201 then
	    if tg ~= 1 then
		   if fx < 0 then
		   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 120 + fx*15
		   end
		else  
		   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 120 + yin*15
		end
	end
	
	--紫霞
	if PersonKF(pid, 89) and JY.Person[pid]["专1"] == 89 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 100
	   if WAR.LQZ[pid] == 100 then
	      WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 100
	   end
	end
	--百胜刀法
	if PersonKF(pid, 141) and JY.Person[pid]["专2"] == 141 and JY.Wugong[wugong]["武功类型"] == 4 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 150
	end
	if match_ID(pid, 36) and JY.Person[36]["天3"] == 1 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 200
	end
	
	if pid == 0 and JY.Person[0]["天2"] == 2 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 150
	end
	
	if JY.Person[pid]["人6"] == 1 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - math.modf(get_skill_power(pid, wugong, 11)/10)
	end
	
	if JY.Person[pid]["人30"] == 1 and JY.Person[eid]["受伤程度"] > 0 then
	   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 200
	end
	
	--无酒不欢：最高优先级的增减伤
	
	--阿紫曼珠沙华，血量越低伤害越高，100%血无加成，0血100%加成
	if match_ID(pid, 47) and WAR.JYZT[pid]~=nil then
		local bonus_perctge = 0
		bonus_perctge = 2 - JY.Person[pid]["生命"] / JY.Person[pid]["生命最大值"]
		hurt = math.modf(hurt * bonus_perctge)
	end
	
	--装备鸳鸯刀，6级，夫妻伤害提高20%
	if JY.Person[pid]["武器"] == 217 and wugong == 62 and JY.Thing[217]["装备等级"] == 6 then
		hurt = math.modf(hurt*1.2);
	end
	if JY.Person[pid]["武器"] == 218 and wugong == 62 and JY.Thing[218]["装备等级"] == 6 then
		hurt = math.modf(hurt*1.2);
	end
	
	--琴棋书画之倚天屠龙功，增伤20%
	if WAR.QQSH3 == 1 then
		hurt = math.modf(hurt*1.2);
	end
	
	--九剑真传，撩剑式伤害+30%
	if WAR.JJZC == 3 then
		hurt = math.modf(hurt*1.3);
	end
	
	--天怒十方
	if match_ID(pid, 670) and WAR.LQZ[pid] ~= nil then
	   if WAR.TNSF == 2 then
	      hurt = math.modf(hurt*(1+WAR.LQZ[pid]/200))
	   end
	   if WAR.TNSF == 1 then
	      hurt = math.modf(hurt*(1+WAR.LQZ[pid]/320))
	   end
	end
	
	--郭靖的降龙十八掌，有余不尽
	if WAR.YYBJ > 0 then
		hurt = math.modf(hurt*(1+0.08*WAR.YYBJ));
	end
	
	--紫气天罗组合减伤10%，反冰20点
	if ZiqiTL(eid) and DWPD() then
		hurt = math.modf(hurt*0.9);
		WAR.BFXS[pid] = 1
		JY.Person[pid]["冰封程度"] = JY.Person[pid]["冰封程度"] + 20
		if JY.Person[pid]["冰封程度"] > 100 then
			JY.Person[pid]["冰封程度"] = 100
		end
	end

	--左冷禅
	if match_ID(eid, 22) and JY.Person[22]["阶"] >= 3 and DWPD() then
		hurt = math.modf(hurt*0.8)
		WAR.BFXS[pid] = 1
		JY.Person[pid]["冰封程度"] = 100
	end
	
	
	--踏雪无痕，根据移动+气防
	if Curr_QG(eid, 178) then
		local fac = 0
		if WAR.TXWH[eid] then
			fac = WAR.TXWH[eid][3]
		end
		local js = fac*0.04
		hurt = math.modf(hurt*(1-js))
	end
	
	--稳如泰山
	if JY.Person[670]["无用"] == 1 and eid == 0 then
		hurt = math.modf(hurt*0.9)
	end
	
	--稳如泰山
	if match_ID(eid, 420) and eid == 0 then
		hurt = math.modf(hurt*0.9)
	end

	if WAR.ZDDH == 321 and not inteam(eid) then
	   hurt = math.modf(hurt*(1-JY.Person[124]["天1"]*0.006))
	end
	
	--九阳减伤30%
	if Curr_NG(eid, 106) then
		hurt = math.modf(hurt*0.7)
		--主角主运，生生不息，每降低2%生命，减伤增加1%
		if eid == 0 and JY.Person[eid]["生命"] < JY.Person[eid]["生命最大值"]/2 then 
		   local n = 1-(JY.Person[eid]["生命最大值"]/2-JY.Person[eid]["生命"])/(JY.Person[eid]["生命最大值"]/100)*0.005
		   hurt = math.modf(hurt*n)
		end
	--被动减伤10%
	elseif PersonKF(eid, 106) then
		hurt = math.modf(hurt*0.9)
	end
	
	--纯阳
	if Curr_NG(eid, 99) then
		hurt = math.modf(hurt*0.85)
	--被动减伤10%
	elseif PersonKF(eid, 99) then
		hurt = math.modf(hurt*0.9)
	end
	--纯阳
	if PersonKF(eid, 99) and JY.Person[eid]["专1"] == 99 then
		hurt = math.modf(hurt*0.8)
	end
	--罗汉伏魔
	if PersonKF(eid, 96) and JY.Person[eid]["专1"] == 96 then
		hurt = math.modf(hurt*0.85)
	end
	--金刚不坏
	if PersonKF(eid, 144) and JY.Person[eid]["专1"] == 144 then
		hurt = math.modf(hurt*0.9)-100
		if hurt < 0 then
		   hurt = 0
		end
	end
	--暗香
	if PersonKF(pid, 180) and JY.Person[pid]["专1"] == 180 then
		hurt = math.modf(hurt*1.1)
	end
	
	if JY.Person[eid]["专1"] == 36 and PersonKF(eid, 36) and JY.Wugong[wugong]["武功类型"] ~= 1 and JY.Wugong[wugong]["武功类型"] ~= 2 then
	   Set_Eff_Text(enemyid, "特效文字2", "以柔克刚")
	   hurt = math.modf(hurt*0.8)
	end
	
	
	
	--金刚不坏神功，挨打100次减少1点伤害
	if eid==0 and (Curr_NG(eid,144) or PersonKF(eid, 144) and Curr_NG(eid, 108)) and JY.Person[596]["声望"]>99 then
		hurt = hurt-math.modf(JY.Person[596]["声望"]/600)
		if Curr_NG(eid, 144) then
		hurt = hurt-math.modf(JY.Person[596]["声望"]/600)
		end
		if hurt<1 then
			hurt=1
		end
	local JGBH = math.modf(JY.Person[596]["声望"]/2500)
	if JGBH==1 then
	JGBH="一"
	elseif JGBH==2 then
	JGBH="二"
	elseif JGBH==3 then
	JGBH="三"
	elseif JGBH==4 then
	JGBH="四"
	elseif JGBH==5 then
	JGBH="五"
	elseif JGBH==6 then
	JGBH="六"
	elseif JGBH==7 then
	JGBH="七"
	elseif JGBH==8 then
	JGBH="八"
	elseif JGBH==9 then
	JGBH="九"
	elseif JGBH==10 then
	JGBH="十"
	elseif JGBH==11 then
	JGBH="十一"
	elseif JGBH==12 then
	JGBH="十二"
	end
	Set_Eff_Text(enemyid, "特效文字2", "金刚不坏神功".." 第"..JGBH.."层")
	end
	
	--先知先觉
	if match_ID(eid, 676) and JY.Person[676]["天1"] == 1 then
		hurt = math.modf(hurt*0.8)
	end
	if match_ID(eid, 689) and JY.Person[690]["天1"] == 2 then
		hurt = math.modf(hurt*0.8)
	end
    if PersonKF(eid, 237) then
	   hurt = math.modf(hurt*0.8)
	end
	if match_ID(pid, 676) and JY.Person[676]["天3"] == 2 then
		hurt = math.modf(hurt*1.15)
		local add = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				add = add + 0.02
			end
		end
		hurt = math.modf(hurt*(1+add))
	end		
	
	--无量神掌，四季剑法
	if match_ID(pid, 675) then
		local qz = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[pid]["武功" .. i]]["武功类型"] == 3 then
				qz = qz + 1
			end
		end
		if qz > 6 then
		   qz = 6
		end   
		hurt = math.modf(hurt * (1 + qz*0.05))
	end 

	if match_ID(eid, 675) then
	   hurt = math.modf(hurt*(1-JY.Person[675]["品德"]*0.03))
	end
	
	--华英雄
	if match_ID(eid, 675) then
		local qz = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[pid]["武功" .. i]]["武功类型"] == 1 then
				qz = qz + 1
			end
		end
		if qz > 6 then
		   qz = 6
		end   
		hurt = math.modf(hurt * (1 - qz*0.05))
	end
	
	if JY.Person[pid]["防具"] == 355 and WAR.QNFJ[pid] ~= nil then
	local kt = JY.Wugong[wugong]["武功类型"]
	   if WAR.QNFJ[pid] >= 81 and WAR.QNFJ[pid] < 101 and kt == 5 then
	      hurt = math.modf(hurt * (1.4 + JY.Thing[355]["装备等级"]*0.1))
	   end	  
	   if WAR.QNFJ[pid] >= 61 and WAR.QNFJ[pid] < 81 and kt == 4 then
	      hurt = math.modf(hurt * (1.4 + JY.Thing[355]["装备等级"]*0.1))
	   end	  
	   if WAR.QNFJ[pid] >= 41 and WAR.QNFJ[pid] < 61 and kt == 3 then
	      hurt = math.modf(hurt * (1.4 + JY.Thing[355]["装备等级"]*0.1))
	   end	  
	   if WAR.QNFJ[pid] >= 21 and WAR.QNFJ[pid] < 41 and kt == 2 then
	      hurt = math.modf(hurt * (1.4 + JY.Thing[355]["装备等级"]*0.1))
	   end	  
       if WAR.QNFJ[pid] >= 1 and WAR.QNFJ[pid] < 21 and kt == 1 then
	      hurt = math.modf(hurt * (1.4 + JY.Thing[355]["装备等级"]*0.1))
	   end
	end   

	--九阴增伤30%
	if Curr_NG(pid, 107) then
	local add = 0
		if tg ~= 1 then
		   if fx < 0 then
		   add = add - fx*0.01
		   end
		else  
		   hurt = hurt - yin*0.01
		end
		hurt = math.modf(hurt*(1.2+add))	
	--被动增伤10%
	elseif PersonKF(pid, 107) then
		hurt = math.modf(hurt*1.1)
	end
	if JY.Person[pid]["天赋内功"] == 107 and PersonKF(pid, 107) then
		hurt = math.modf(hurt*1.1)
	end
	
	if match_ID(pid, 681) and JY.Person[681]["天4"] == 2 then
	   hurt = math.modf(hurt*1.75)
	   if WAR.MXD[pid] ~= nil then
	      hurt = math.modf(hurt*2.5)
	   end
	end
	if match_ID(pid, 682) and JY.Person[682]["天3"] == 2 then
	   hurt = math.modf(hurt*1.75)
	end
	
	--龙象之力
	if PersonKF(pid, 103) and JY.Person[pid]["专2"] == 103 then
	   hurt = math.modf(hurt*1.25)
	end
	
	
	if JY.Wugong[wugong]["啊"] < 0 then
	local add = 0
	if tg == 1 then
	    add = 0.01*yin
	elseif fx < 0 then
	    add = 0.01*fx
	end	
	   hurt = math.modf(hurt*(1-add))

	   if fx < -9 or tg == 1 then
	      hurt = math.modf(hurt*1.1)
	   end	  
	end
	
	--瑜伽密乘
	if PersonKF(pid, 169) and JY.Person[pid]["天赋内功"] == 169 then
	   hurt = math.modf(hurt*1.05)
	end 
    if PersonKF(eid, 169) and JY.Person[eid]["天赋内功"] == 169 then
	   hurt = math.modf(hurt*0.95)
	end 
	--易筋经
	if PersonKF(pid, 108) and JY.Person[pid]["专2"] == 108 then
	   hurt = math.modf(hurt*1.15)
	end 
    if PersonKF(eid, 108) and JY.Person[eid]["专2"] == 108 then
	   hurt = math.modf(hurt*0.85)
	end
	--颖悟绝伦
	if JY.Person[670]["无用"] == 2 and pid == 0 then
	   hurt = math.modf(hurt*1.1)
	end

    --混元
    if PersonKF(pid, 90) and JY.Person[pid]["天赋内功"] == 90 then
	   hurt = math.modf(hurt*(JY.Person[pid]["体力"]*0.0015+1))
	end 
    if PersonKF(eid, 90) and JY.Person[eid]["天赋内功"] == 90 then
	   hurt = math.modf(hurt*(1-JY.Person[pid]["体力"]*0.0015))
	end	
	
	--葵花天内
	if JY.Person[pid]["天赋内功"] == 105 and PersonKF(pid, 105) then
		hurt = math.modf(hurt*1.1)
	end
	
	--龙象减伤10%
	if Curr_NG(eid, 103) or (PersonKF(eid, 103) and Curr_NG(eid, 169)) then
		hurt = math.modf(hurt*0.9)
	end
	
	--龙象增伤10%
	if Curr_NG(pid, 103) or (PersonKF(pid, 103) and Curr_NG(pid, 169)) then
		hurt = math.modf(hurt*1.1)
	end
	
	--无名内功减伤5%
	if Curr_NG(eid, 190) then
		hurt = math.modf(hurt*0.95)
	end
	
	--无名内功增伤5%
	if Curr_NG(pid, 190) then
		hurt = math.modf(hurt*1.05)
	end
	
	--阴内或调和的枯禅, 减伤10%
	if PersonKF(eid, 186) and (fx2 <= 0 or tg2 == 1) then
		hurt = math.modf(hurt*0.9)
	end
	
	--阳内或调和的枯禅, 增伤10%
	if PersonKF(pid, 186) and (tg == 1 or fx >= 0) then
		hurt = math.modf(hurt*1.1)
	end
	
	--单枪匹马组合，减伤10%
	if (JY.Person[eid]["武器"] == 54 or JY.Person[eid]["武器"] == 344) and (JY.Person[eid]["动物"] == 230 or JY.Person[eid]["动物"] == 349) and WAR.MCRS == 1 then
		hurt = math.modf(hurt*0.9)
		if match_ID(eid, 688) then
		hurt = math.modf(hurt*0.9)
		end
		
	end
	
	--单枪匹马组合，增伤10%
	if (JY.Person[pid]["武器"] == 54 or JY.Person[pid]["武器"] == 344) and (JY.Person[pid]["动物"] == 230 or JY.Person[pid]["动物"] == 349) and WAR.MCRS == 1 then
		hurt = math.modf(hurt*1.1)
		if match_ID(pid, 688) then
		hurt = math.modf(hurt*1.1)
		end
	end
	
	--擒龙功, 根据敌我血量差距增伤
	if Curr_NG(pid, 188) then
	local x = 0
	if tg ~= 1 then
       if fx > 0 then
	      x = fx
	   end
	else
	      x = yang
	end
	   
		local rate = (JY.Person[eid]["生命"] - JY.Person[pid]["生命"])/(4000-x*100)
		if rate > 0 then
			hurt = hurt + math.modf(hurt*rate)
		end
	end
	
	--霍青桐固若金汤，减伤30%
	if WAR.HQT_GRJT and WAR.HQT_GRJT[eid] then
		hurt = math.modf(hurt*0.7)
	end
	
	--登萍渡水根据打击人数增加伤害
	if Curr_QG(pid, 179) then
		local fac = 1.6 - WAR.DPDS*0.1
		if fac < 1 then
			fac = 1
		end
		hurt = math.modf(hurt*fac)
	end

	--NPC弱化版登萍根据打击人数增加伤害	
	if inteam(eid) then
		local fac = 1.3 - WAR.DPDS2*0.05
		if fac < 1 then
			fac = 1
		end
		hurt = math.modf(hurt*fac)
	end		
	
	--血河神鉴增伤10%
	if Curr_NG(pid, 163) then
		hurt = math.modf(hurt*1.1)
	end
	
	--侵略如火增伤20%
	if pid == 0 and WAR.FLHS3 == 1 then
		hurt = math.modf(hurt*1.2)
	end

	--无崖子被女性攻击减伤20%
	if match_ID(eid, 116) and JY.Person[pid]["性别"] == 1 then
		hurt = math.modf(hurt*0.8)
	end
	
	--无崖子对男性攻击增伤20%
	if match_ID(pid, 116) and JY.Person[eid]["性别"] == 0 then
		hurt = math.modf(hurt*1.2)
	end
	
	--陈家洛被女性攻击伤害*200%
	if match_ID(eid, 75) and JY.Person[pid]["性别"] == 1 then
		hurt = math.modf(hurt*1.5)
	end
	
	--陈家洛对女性攻击伤害*50%
	if match_ID(pid, 75) and JY.Person[eid]["性别"] == 1 then
		hurt = math.modf(hurt*0.75)
	end
	
	--李莫愁对男性攻击增伤10%
	if match_ID(pid, 161) and JY.Person[eid]["性别"] == 0 then
		hurt = math.modf(hurt*1.1)
	end
	
	--空性的抢攻
	if WAR.KX_DD and WAR.KX_DD[pid] == eid then
		hurt = math.modf(hurt*1.3)
	end
	if WAR.KX_DD and WAR.KX_DD[eid] == pid then
		hurt = math.modf(hurt*1.3)
	end
	
	--空性的游斗
	if WAR.KX_RS and WAR.KX_RS[eid] == pid then
		hurt = math.modf(hurt*0.7)
	end
	if WAR.KX_RS and WAR.KX_RS[pid] == eid then
		hurt = math.modf(hurt*0.7)
	end
	
	--扫地老僧
	if match_ID(eid, 114) and JLSD(25, 50 + math.modf(JY.Person[eid]["实战"]/20),eid) then
		hurt = math.modf(hurt*0.5);
		Set_Eff_Text(enemyid, "特效文字3", "天佛化生・金刚护体")
	end
	
	--马王神装备白马
	if match_ID(eid, 132) then
	if JY.Person[eid]["动物"] == 230 then
	hurt = math.modf(hurt*0.75);	
	Set_Eff_Text(enemyid, "特效文字3", "人马合一")
	end
	end	
	
	--马王神装备黄马
	if match_ID(pid, 132) then
	if JY.Person[pid]["动物"] == 284 then
	hurt = math.modf(hurt*1.25);	
	Set_Eff_Text(enemyid, "特效文字3", "人马合一")
	end
	end	
	
	--方证 金身不灭
	if WAR.JSBM[eid] ~= nil then
		hurt = math.modf(hurt*0.5)
	end
	
	--赵敏在场，此方蓄力时20%减伤
	local ZM = {0}
	if inteam(eid) then
		for i = 0, WAR.PersonNum - 1 do
			local zid = WAR.Person[i]["人物编号"]
			if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] and match_ID(zid, 609) then
				ZM[1] = 1
				ZM[2] = WAR.Person[i]["我方"]
				break
			end
		end
	end
	if ZM[1] == 1 and ZM[2] == WAR.Person[enemyid]["我方"] then
		if WAR.Actup[eid] ~= nil then
			hurt = math.modf(hurt*0.8)
		end
	end
	
	if JY.Person[123]["天2"] == 2 then
	   hurt = math.modf(hurt*0.8)
	end
	
	--黄蓉奇门遁甲，红色增伤
	if WAR.Person[WAR.CurID]["我方"] == true and GetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"],6) == 2 then
		hurt = math.modf(hurt*1.2)
	end
	
	--黄蓉奇门遁甲，绿色减伤
	if WAR.Person[enemyid]["我方"] == true and GetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"],6) == 1 then
		hurt = math.modf(hurt*0.8)
	end
	
	--黄蓉奇门遁甲，蓝色增加杀气
	if WAR.Person[WAR.CurID]["我方"] == true and GetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"],6) == 3 then
		ang = ang + 2000
	end
	
	--狂刀大招，伤害增加30%
	if WAR.ASKD == 1 then
		hurt = math.modf(hurt*1.3)
	end

    --陨石星浪，伤害增加30%
	if WAR.YSXL == 1 then
		hurt = math.modf(hurt*1.5)
	end
	
	
	--毒王大招，伤害增加30%
	if WAR.YTML == 1 then
		hurt = math.modf(hurt*1.3)
	end
	if wugong == 226 and WAR.JSLQ[eid] ~= nil then
	   hurt = hurt*2
	end
	
	--灼烧追加真实伤害
	if JY.Person[eid]["灼烧程度"] > 0 then
	local add = JY.Person[eid]["灼烧程度"]
	  if Curr_NG(pid, 106) then
	     if tg ~= 1 then
		    if fx > 0 then
			   add = math.modf(add*(1+0.1*fx))
			end
		 else
			   add = math.modf(add*(1+0.1*yang))
		 end
	  end
	  if JY.Person[eid]["灼烧程度"] > 25 then
	   add = add * 2
	  end
	  hurt = hurt + add  
	end

	--九阳纯阳额外追加真实伤害
	if JY.Person[eid]["灼烧程度"] > 25 and (Curr_NG(pid, 99) or Curr_NG(pid, 106)) then
		hurt = hurt + JY.Person[eid]["灼烧程度"]*2
	elseif JY.Person[eid]["灼烧程度"] > 0 and (Curr_NG(pid, 99) or Curr_NG(pid, 106)) then
		hurt = hurt + JY.Person[eid]["灼烧程度"]
	end	
	
	--殷离千蛛万毒，根据敌方中毒追加真实伤害
	if match_ID(pid, 646) and JY.Person[eid]["中毒程度"] > 0 then
		hurt = hurt + JY.Person[eid]["中毒程度"]
	end
	
	--归辛树，使用拳法攻击追加100点真实伤害，如未装备武器，则此加成翻倍
	if match_ID(pid, 186) and JY.Wugong[wugong]["武功类型"] == 1 then
		hurt = hurt + 100 + math.modf(TrueQZ(pid)*0.25)
		if JY.Person[pid]["武器"] == -1 then
			hurt = hurt + math.modf(TrueQZ(pid)*0.25)
		end
		if JY.Person[186]["阶"] >= 3 then
		   hurt = hurt + 100 + math.modf(TrueQZ(pid)*0.5)
		end
	end
	
	if JY.Person[pid]["地6"] == 5 then
	   hurt = hurt + 300
	end
	
	
	if match_ID(pid, 678) and WAR.LXYZG == 1 then
	   hurt = hurt + math.modf(JY.Person[pid]["指法技巧"]*0.5)
	end
	
	if WAR.SHMY[eid] ~= nil and wugong == 209 then
	   hurt = hurt + math.modf(JY.Person[eid]["生命最大值"]*0.15)
	end 
	
	if pid == 0 and JY.Person[0]["天3"] == 2 then
	   hurt = hurt + math.modf(JY.Person[eid]["生命"]*0.02)
	end
	
	--中华傲诀
	if Curr_NG(eid, 213) then
		hurt = math.modf(hurt*0.8)
	end	
	
	--冬寒刺骨
	if match_ID(pid, 675) and WAR.DHCG == 1 then
	   hurt = math.modf(hurt*1.5)
	end   
	
	if Curr_NG(pid, 207) and JY.Person[eid]["冰封程度"] ~= nil then
	   hurt = hurt + JY.Person[eid]["冰封程度"]
	   if tg ~= 1 then
	      if fx < 0 then
		     hurt = hurt - fx*10
	      end
	   else
		     hurt = hurt - yin*10
	   end
	end
	

	if wugong == 214 then
	hurt = math.modf(hurt*(1.006^JY.Person[pid]["资质"]))
	if WAR.LQZ[pid] == 100 then
	   hurt = hurt + math.modf(JY.Person[eid]["生命"]*0.3)
	end   
	end

	--苗人凤，实战
	if match_ID(pid, 3) then
	local add = math.modf(JY.Person[pid]["实战"]*0.1)
		hurt = hurt + add
	end
	
	if match_ID(eid, 3) then
	local add = math.modf(JY.Person[eid]["实战"]*0.1)
		hurt = hurt - add
	end
	
	--七伤拳，心
	if wugong == 23 and (WAR.YZQS == 1 or WAR.YZQS == 7) then
	   hurt = hurt + 77
	   if JY.Person[pid]["内力"] < 5000  and JY.Person[pid]["内力最大值"] < 9999 then
	      WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -17)
		  if JY.Person[pid]["生命"] < 1 then
		     JY.Person[pid]["生命"] = 1
		  end
	   end
	end
	
	--七伤拳，精
	if wugong == 23 and (WAR.YZQS == 5 or WAR.YZQS == 7) then
	   WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid, "体力", -17)
	   if JY.Person[pid]["内力"] < 5000 and JY.Person[pid]["内力最大值"] < 9999 then
		  WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + AddPersonAttrib(pid, "体力", -2)
	   end
	end
	
	--七伤拳，意恍惚
	if wugong == 23 and (WAR.YZQS == 6 or WAR.YZQS == 7) then
	if WAR.QSQ6[eid] ~= nil then
	   WAR.QSQ6[eid] = WAR.QSQ6[eid] + 17
	   if JY.Person[pid]["内力"] < 5000 and JY.Person[pid]["内力最大值"] < 9999 then
		  WAR.QSQ6[pid] = 17
	   end
	else
	   WAR.QSQ6[eid] = 17
	   if JY.Person[pid]["内力"] < 5000 and JY.Person[pid]["内力最大值"] < 9999 then
		  WAR.QSQ6[pid] = 17
	   end
	end
	end
	
	
	--紫气天罗
	if wugong == 3 or wugong == 9 or wugong == 5 or wugong == 21 or wugong == 118 then
	local z = 0
	    for i = 1, JY.Person[671]["品德"] do
	       local kfid = JY.Person[pid]["武功"..i]
		   if kfid == 3 or kfid == 9 or kfid == 5 or kfid == 21 or kfid == 118 then
			   z = z + 1
		   end
		end
		if z > 1 then
		   if z == 2 then
		      hurt = hurt + 40
		   end
		   if z == 3 then
		      hurt = hurt + 70
		   end
		   if z == 4 then
		      hurt = hurt + 90
		   end
		   if z >= 5 then
		      hurt = hurt + 100
		   end
		end
	end
	
	--雷震，增长无量
	if JY.Person[pid]["防具"] == 325 or JY.Person[pid]["防具"] == 327 then
	local add = 1 + JY.Base["天书数量"] * 0.02
	   hurt = math.modf(hurt * add)
	   if JY.Person[pid]["防具"] == 327 and WAR.LQZ[pid] ~= nil then
	      hurt = hurt + 2*WAR.LQZ[pid]
	   end
	end
	--暗杀拳
	if match_ID(pid, 686) and JY.Person[686]["天2"] == 1 then
	   local x0 = WAR.Person[WAR.CurID]["坐标X"]
	   local y0 = WAR.Person[WAR.CurID]["坐标Y"]
	   if WAR.Person[enemyid]["人方向"] == 0 then
	      if y0 > WAR.Person[enemyid]["坐标Y"] and x0+y0 > WAR.Person[enemyid]["坐标Y"]+WAR.Person[enemyid]["坐标X"] and y0-x0 > WAR.Person[enemyid]["坐标Y"]-WAR.Person[enemyid]["坐标X"] then
		     hurt = math.modf(hurt*1.8)
		  end	 
	   elseif WAR.Person[enemyid]["人方向"] == 1 then
	      if x0 < WAR.Person[enemyid]["坐标X"] and x0+y0 < WAR.Person[enemyid]["坐标Y"]+WAR.Person[enemyid]["坐标X"] and y0-x0 > WAR.Person[enemyid]["坐标Y"]-WAR.Person[enemyid]["坐标X"] then
		     hurt = math.modf(hurt*1.8)
		  end
	   elseif WAR.Person[enemyid]["人方向"] == 2 then
	      if x0 > WAR.Person[enemyid]["坐标X"] and x0+y0 > WAR.Person[enemyid]["坐标Y"]+WAR.Person[enemyid]["坐标X"] and y0-x0 < WAR.Person[enemyid]["坐标Y"]-WAR.Person[enemyid]["坐标X"] then
		     hurt = math.modf(hurt*1.8)
		  end
	   elseif WAR.Person[enemyid]["人方向"] == 3 then
	      if y0 < WAR.Person[enemyid]["坐标Y"] and x0+y0 < WAR.Person[enemyid]["坐标Y"]+WAR.Person[enemyid]["坐标X"] and y0-x0 < WAR.Person[enemyid]["坐标Y"]-WAR.Person[enemyid]["坐标X"] then
		     hurt = math.modf(hurt*1.8)
		  end  
	   end	   		  
	end
	
	--倚天剑法
	if wugong == 41 and JY.Person[pid]["专2"] == 41 and DWPD() then
	   hurt = math.modf(hurt*1.25)
	   if JY.Person[pid]["武器"] == 37 then
	      hurt = math.modf(hurt*1.25)
	   end
	end
	if wugong == 75 and JY.Person[pid]["专1"] == 75 and WAR.LQZ[pid] == 100 and DWPD() then
	   hurt = math.modf(hurt*3)
	end
	--iron fist
	if match_ID(pid, 693) then
	   hurt = math.modf(hurt*0.75)
	end
	if WAR.TQGJ[pid] ~= nil and DWPD() then
	   hurt = math.modf(hurt*1.25)
	end
	if WAR.TQFY[eid] ~= nil then
	   hurt = math.modf(hurt*0.75)
	end
	if match_ID(eid, 693) and JY.Person[693]["天1"] == 1 then
	   hurt = math.modf(hurt*0.9)
	end
	if wugong == 79 and JY.Person[pid]["专2"] == 79 then
	   hurt = math.modf(hurt*0.4)
	end
	if Azhu() and JY.Person[646]["阶"] >= 3 and not inteam(pid) and JY.Person[pid]["中毒程度"] > 0 then
	   hurt = math.modf(hurt*0.5)
	end
	--回春大力
	if WAR.HCDLW[pid] ~= nil then
	   hurt = math.modf(hurt*1.25)
	end
	--鬼头
	if wugong == 52 and JY.Person[pid]["专1"] == 52 then
	   hurt = math.modf(hurt*1.5)
	end
	if JY.Person[JY.Base["畅想"]]["阶"] >= 3 and JY.Base["畅想"] > 0 and Tier[JY.Base["畅想"]] == nil and match_ID(pid, JY.Base["畅想"]) and DWPD() then
		hurt = math.modf(hurt*1.1)
	end
	if JY.Person[JY.Base["畅想"]]["阶"] >= 3 and JY.Base["畅想"] > 0 and Tier[JY.Base["畅想"]] == nil and match_ID(eid, JY.Base["畅想"]) and DWPD() then
		hurt = math.modf(hurt*0.9)
	end
	--张角
	if match_ID(pid, 694) and DWPD() then
	local n = (GetTeamNum() - 1)*0.03
	if JY.Base["天书数量"] >= 14 then
	   n = 0.45
	end
	hurt = math.modf(hurt*(1+n))
	end
	if match_ID(eid, 694) then
	local n = (GetTeamNum() - 1)*0.03
	if JY.Base["天书数量"] >= 14 then
	   n = 0.45
	end
	hurt = math.modf(hurt*(1-n))
	end
	--王语嫣
	if match_ID(pid, 76) and JY.Person[76]["阶"] >= 2 and DWPD() then
	local w = 0
	    for i = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. i] > 0 then
				w = w + 1
			end
	    end
		hurt = math.modf(hurt*(1+w*0.05))
	end
	
	
	
	if match_ID(pid, 58) and JY.Person[58]["阶"] >= 3 and DWPD() then
	local s = 1+((JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])/JY.Person[pid]["生命最大值"])*2
		hurt = math.modf(hurt*s)
	end
	--慕容复
	if match_ID(pid, 51) and JY.Person[51]["阶"] >= 2 and DWPD() then
	   hurt = hurt + math.modf(Xishu_sum(pid)/10)
	end
	if match_ID(eid, 51) and JY.Person[51]["阶"] >= 2 then
	   hurt = hurt - math.modf(Xishu_sum(pid)/10)
	   if hurt < 1 then
	   hurt = 1
	   end
	end
	
	--梅超风
	if match_ID(eid, 78) and JY.Person[78]["阶"] >= 2 then
	   hurt = math.modf(hurt*0.75)
	end
	--平一指
	if match_ID(pid, 28) and JY.Person[28]["阶"] >= 1 and DWPD() then
	   hurt = math.modf(hurt*1.3)
	end
	
	if match_ID(pid, 60) and JY.Person[60]["阶"] >= 2 and wugong == 81 and DWPD() then
	   hurt = hurt+math.modf(JY.Person[eid]["生命最大值"]*0.1)
	end
	
	if match_ID(pid, 14) and JY.Person[14]["阶"] >= 2 and WAR.JQSDXS[pid] ~= nil and DWPD() then
	local p = (WAR.JQSDXS[pid]/200)
	   hurt = math.modf(hurt*(1+p))
	   if JY.Person[14]["阶"] >= 3 and JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"]*0.3 then
	      hurt = hurt*2
	   end
	end
	if match_ID(pid, 11) and JY.Person[11]["阶"] >= 3 and DWPD() then
	   hurt = math.modf(hurt*1.25)
	end
	if wugong == 23 and JY.Person[8]["阶"] >= 3 and match_ID(pid, 8) and DWPD() then
	   hurt = math.modf(hurt*2)
	end
	if JY.Person[pid]["人24"] == 1 and WAR.FXDS[eid] ~= nil and DWPD() then
	   hurt = math.modf(hurt*1.08)
	end
	if JY.Person[pid]["人28"] == 1 and WAR.FXDS[eid] ~= nil and DWPD() then
	   hurt = math.modf(hurt*1.35)
	end
	if JY.Person[pid]["人1"] == 1 and DWPD() then
	   hurt = math.modf(hurt*1.06)
	end
	if match_ID(pid, 636) and JY.Person[636]["天3"] == 2 and DWPD() then
	   hurt = math.modf(hurt*1.35)
	end
	if match_ID(eid, 636) and JY.Person[636]["天3"] == 1 and DWPD() then
	   hurt = math.modf(hurt*0.75)
	end
	if match_ID(pid, 36) and JY.Person[36]["天3"] == 1 and DWPD() then
	   hurt = math.modf(hurt*1.3)
	end
	if match_ID(pid, 691) and JY.Person[691]["天2"] == 2 and DWPD() then
	   hurt = math.modf(hurt*1.2)
	end
	if WAR.LDXJ[pid] ~= nil and DWPD() then
	   if JY.Person[pid]["专1"] == 230 then
	      hurt = math.modf(hurt*(2+(10+JY.Person[689]["天3"]*3)*0.01))
	   else
	      hurt = math.modf(hurt*(1+(10+JY.Person[689]["天3"]*3)*0.01))
	   end
	end
	if wugong == 86 and JY.Person[pid]["专2"] == 86 and DWPD() then
	   hurt = math.modf(hurt*1.33)
	end
	if PersonKF(pid, 128) and JY.Wugong[wugong]["武功类型"] == 2 and JY.Person[pid]["专1"] == 128 and DWPD() then
	   hurt = math.modf(hurt*1.1)
	end
	if WAR.WLDF == 4 and DWPD() then
	   hurt = math.modf(hurt*1.33)
	end
	if WAR.XYJ == 1 and DWPD() then
	   hurt = math.modf(hurt*1.2)
	end
	if JY.Person[638]["声望"] >= 4 and match_ID(eid, 638) then
	   hurt = math.modf(hurt*0.8)
	end
	if match_ID(eid, 638) then
	   hurt = math.modf(hurt*0.99^WAR.DJSS)
	end
	--西门吹雪
	if match_ID(pid, 683) and JY.Wugong[wugong]["武功类型"] == 3 and DWPD() then
	   hurt = math.modf(hurt*(1+0.03*JianNum(pid)))
	end
	if match_ID(eid, 683) and JY.Wugong[wugong]["武功类型"] == 3 and DWPD() then
	   hurt = math.modf(hurt*0.50)
	end
	--天魔功
	if PersonKF(pid, 160) and JY.Person[pid]["专2"] == 160 and WAR.LQZ[pid] == 100 and WAR.ACT == 1 and DWPD() then
	   hurt = math.modf(hurt*1.33)
	   Set_Eff_Text(WAR.CurID, "特效文字1", "天魔震怒")
    end
	
	--林平之
	if match_ID(pid, 36) and wugong == 48 and DWPD() then
	   hurt = hurt + WAR.JQSDXS[pid]
	   if WAR.LQZ[pid] == 100 then
	      hurt = hurt + WAR.JQSDXS[pid]
	   end
	end
	if (JY.Person[pid]["专2"] == 48 or (match_ID(pid, 36) and JY.Person[36]["阶"] >= 1)) and JY.Wugong[wugong]["武功类型"] == 3 and DWPD() then
	   hurt = hurt + WAR.JQSDXS[pid]
	end
	
	--无名，名不经传
	if match_ID(pid, 671) and wugong == 199 and WAR.MMZS == 7 and DWPD() then
		hurt = hurt + math.modf(JY.Person[pid]["御剑能力"]*0.3)
		if match_ID(pid, 671) and JY.Person[pid]["六如觉醒"] >= 6 then
		   hurt = hurt + math.modf(JY.Person[eid]["生命最大值"]*0.1)
	    end
	end
	
	
	
	--黯然销魂掌
	if wugong==25 and JY.Person[pid]["生命最大值"]/2 > JY.Person[pid]["生命"] and DWPD() then
	    local s = 0
		s=math.floor((JY.Person[pid]["生命最大值"]/2 - JY.Person[pid]["生命"])/5)
		if s>200 then
		s=200
		end
		hurt=hurt+s
	end
	
    --开太极
	if WAR.WDKTJ == 1 and DWPD() then
	    local s = 0
        local s1 = 1-JY.Person[pid]["生命"]/JY.Person[pid]["生命最大值"]
		local s2 = JY.Person[pid]["内力"]/JY.Person[pid]["内力最大值"]		
        local s3 = JY.Person[pid]["内力"]*0.05
		local s4 = s1+s2
		 s = math.modf(s3*s4) 
		if s > 400 then
		hurt = hurt+s
		 else
		hurt = hurt+400
       end		
	end
	--韦小宝机敏无双，开场前50时序，受伤害不超过50
	if match_ID(eid, 601) and WAR.SXTJ <= 50 and hurt > 50 then
		hurt = math.random(40,50)
		WAR.Person[enemyid]["特效动画"] = 90
		Set_Eff_Text(enemyid, "特效文字1", "机敏无双")
	end
	
	--瞬息千里，暴怒受伤降低20%
	if Curr_QG(eid,150) and WAR.LQZ[eid] == 100 and WAR.JESS[eid] == nil then
		hurt = math.modf(hurt *0.8)
	end
	
	--无名，隐姓埋名
	if match_ID(eid, 671) and WAR.YXMM[eid] ~= nil then
	local aj = 0.9 - TrueYJ(eid)/1200
	    if aj < 0.1 then
		   aj = 0.1
		end
		ang = math.modf(ang *aj)
		hurt = math.modf(hurt *aj)
		WAR.Person[enemyid]["特效动画"] = 107
		Set_Eff_Text(enemyid, "特效文字1", "剑意纵横")
	end
	
	--杨过，左右
	if match_ID(pid, 58) and WAR.ZYHB == 2 then
	   hurt = math.floor(hurt*0.5)
	end
	if match_ID(pid, 58) and WAR.ZYHB == 1 then
	   hurt = math.floor(hurt*1.35)
	   ang = math.floor(hurt*1.35)
	end
	if match_ID(pid, 55) and JY.Person[55]["阶"] >= 1 and WAR.ZYHB == 1 then
	   hurt = math.floor(hurt*1.35)
	   ang = math.floor(hurt*1.35)
	end
	if match_ID(pid, 682) and WAR.ZYHB == 2 then
	   hurt = math.floor(hurt*1.35)
	end
	if JY.Person[pid]["专2"] == 996 and (WAR.ZYHB == 1 or WAR.ZYHB == 2) then
	   hurt = math.floor(hurt*1.25)
	end
	--托奇
	if match_ID(eid, 686) then
	   hurt = math.floor(hurt*0.65)
	   ang = math.modf(ang *0.65)
	   WAR.Person[enemyid]["特效动画"] = 153
	   Set_Eff_Text(enemyid, "特效文字2", "柔拳")
	end
	
	--梯云纵，40%几率减少40%所受气攻
	if Curr_QG(eid,149) and JLSD(20, 60, eid) and WAR.JESS[eid] == nil then
		ang = math.modf(ang *0.6)
		WAR.Person[enemyid]["特效动画"] = 153
		Set_Eff_Text(enemyid, "特效文字2", "梯云纵横")
	end
	
	if (WAR.ZDDH == 275 or WAR.ZDDH == 277 or WAR.ZDDH == 278) and eid == 62 and WAR.JESS[eid] == nil then
		ang = math.modf(ang *0.5)
		WAR.Person[enemyid]["特效动画"] = 90
		Set_Eff_Text(enemyid, "特效文字1", "龙象般若功第十层")
	end
	
	if WAR.ZDDH == 75 and eid == 62 and WAR.JESS[eid] == nil then
		ang = math.modf(ang *0.75)
		WAR.Person[enemyid]["特效动画"] = 90
		Set_Eff_Text(enemyid, "特效文字1", "龙象般若功第九层")
	end
	
	--被刺目，伤害杀气降低15%，有15%几率miss
	if WAR.KHCM[pid] == 2 then
		hurt = math.modf(hurt *0.85)
		ang = math.modf(ang *0.85)
	end
  
	--无酒不欢：葵花移行
	if PersonKF(eid, 105) and WAR.JESS[eid] == nil then
		--葵花尊者必定移形
		local khzz = 0
		if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and eid == 27 then
			khzz = 1
		end
		if khzz == 1 or JLSD(50, 80, eid) then
			hurt = math.modf(hurt *0.7)
			ang = math.modf(ang *0.7)
			WAR.Person[enemyid]["特效动画"] = 51
			Set_Eff_Text(enemyid, "特效文字2", "葵花移形")
		end
	end
	
	--无酒不欢：神行百变，40%几率减伤30%
	if Curr_QG(eid, 146) and WAR.JESS[eid] == nil then
		local c_up = 0
		--袁承志觉醒后，减伤率+10%
		if match_ID_awakened(eid, 54, 1) then
			c_up = 10
		end
		if match_ID(eid, 184) then 		--玉真子，减伤率+10%
			c_up = 10
		end
		if JLSD(30, 70+c_up, eid) then
			hurt = math.modf(hurt *0.7)
			ang = math.modf(ang *0.7)
			WAR.Person[enemyid]["特效动画"] = 51
			Set_Eff_Text(enemyid, "特效文字2", "神行百变减伤")
		end
	end
	
	--无酒不欢：凌波微步，30%几率减伤40%
	if Curr_QG(eid, 147) and WAR.JESS[eid] == nil then
		if JLSD(40, 70, eid) then
			hurt = math.modf(hurt *0.6)
			ang = math.modf(ang *0.6)
			WAR.Person[enemyid]["特效动画"] = 51
			Set_Eff_Text(enemyid, "特效文字2", "凌波微步减伤")
		end
	end
	
	--紫霞神功，用内力抵消20%伤害
	if PersonKF(eid, 89) and WAR.ZXSG == 1 and DWPD() and WAR.JESS[eid] == nil then
		hurt = math.modf(hurt * 0.8)
	end
	
	--空而明之用内力抵消35%伤害
	if match_ID(eid, 677) and JY.Person[677]["天2"] == 2 and JY.Person[eid]["内力"] > JY.Person[eid]["内力最大值"]*0.35 and DWPD() and WAR.JESS[eid] == nil then
		hurt = math.modf(hurt * 0.65)
		Set_Eff_Text(enemyid, "特效文字2", "空而明之")
	end
	
	--流沙覆
	if WAR.LSF[eid] ~= nil then
	   hurt = math.modf(hurt * 0.6)
	end   

	--适应攻击，伤害降低
	if hurt > 0 then
	   if WAR.Adapt[eid][wugong] ~= nil then
	      if inteam(eid) then
		     if math.random(3) == 1 then
	         WAR.Adapt[eid][wugong] = WAR.Adapt[eid][wugong] + 1
             if WAR.Adapt[eid][wugong] ~= nil and WAR.Adapt[eid][wugong] > 12 then
		      WAR.Adapt[eid][wugong] = 12
		     elseif WAR.Adapt[eid][wugong] ~= nil and WAR.Adapt[eid][wugong] > 0 then
		      Set_Eff_Text(enemyid, "特效文字2", "适应攻击")
             end			 
		     end
		  else
             if math.random(5) < 3 then
             WAR.Adapt[eid][wugong] = WAR.Adapt[eid][wugong] + 1
			 if WAR.Adapt[eid][wugong] ~= nil and WAR.Adapt[eid][wugong] > 8 + JY.Base["难度"] then
		      WAR.Adapt[eid][wugong] = 8 + JY.Base["难度"]
		     elseif WAR.Adapt[eid][wugong] ~= nil and WAR.Adapt[eid][wugong] > 0 then
		      Set_Eff_Text(enemyid, "特效文字2", "适应攻击")
             end
             end
          end 			 
	   else
	      if inteam(eid) then
		     if math.random(3) == 1 then
	         WAR.Adapt[eid][wugong] = 1
			 Set_Eff_Text(enemyid, "特效文字2", "适应攻击")
		     end
		  else
             if math.random(1) == 1 then
             WAR.Adapt[eid][wugong] = 1
			 Set_Eff_Text(enemyid, "特效文字2", "适应攻击")
             end
          end			  
	           
	   end  
	end
	
	if WAR.Adapt[eid][wugong] ~= nil then
	   if inteam(eid) then
	   hurt = math.modf(hurt*(1-WAR.Adapt[eid][wugong]*0.015))
	   else
	   hurt = math.modf(hurt*(1-WAR.Adapt[eid][wugong]*0.03))
	   end
	   if inteam(eid) and WAR.Adapt[eid][wugong] >= 12 then
	      Set_Eff_Text(enemyid, "特效文字1", "招式看破")
	   elseif WAR.Adapt[eid][wugong] >= 8 + JY.Base["难度"] then
	      Set_Eff_Text(enemyid, "特效文字1", "招式看破") 	   
       end		  
	end

	--难7NPC光环，50%概率杀气减半	
	if (inteam(eid) == false and JY.Base["难度"] >= 7) or (inteam(eid) == true and JY.Person[642]["血量翻倍"] == 1) or JY.Person[eid]["地10"] == 2 then
	if JLSD(35, 85, eid) then
	local add = (JY.Person[671]["品德"]-12)*0.06
			ang = math.modf(ang *(0.5-add))
			if math.random(2) == 1 then
			Set_Eff_Text(enemyid, "特效文字5", "儿时的梦想")
			else
			Set_Eff_Text(enemyid, "特效文字5", "心中的江湖")
			end
		end
	end

	--难7NPC光环，50%概率伤害降低25%
	if inteam(eid) == false and JY.Base["难度"] >= 7 or (inteam(eid) == true and JY.Person[642]["血量翻倍"] == 1) or JY.Person[eid]["地10"] == 2 then
	
	if JLSD(25, 75, eid) then
	local add = (JY.Person[671]["品德"]-12)*0.06
			hurt = math.modf(hurt *(0.75-add))
			if math.random(2) == 1 then
			Set_Eff_Text(enemyid, "特效文字5", "沧海桑田情犹在")
			else
			Set_Eff_Text(enemyid, "特效文字5", "六年弹指一挥间")
			end
		end
	end
	
	if WAR.Siphon[eid] ~= nil then
	local dam = hurt
	
	   if hurt >= WAR.Siphon[eid] then
	      hurt = hurt - WAR.Siphon[eid]
	   else
	      hurt = 0
	   end 
	   WAR.Siphon[eid] = WAR.Siphon[eid] - dam
	   if WAR.Siphon[eid] <= 0 then
	      WAR.Siphon[eid] = nil
	   end
	end
	
	--一灯复活后，不受连击伤害
	if (match_ID(eid, 65) or JY.Person[eid]["地8"] == 2) and DWPD() and WAR.WCY[eid] ~= nil and (WAR.ACT == 2 or WAR.ACT == 3) and WAR.JESS[eid] == nil then
		hurt = 0
		WAR.Person[enemyid]["特效动画"] = 136
		Set_Eff_Text(enemyid, "特效文字2", "不动明王")
	end
	
	if match_ID(eid, 40) and DWPD() and WAR.ACT >= 2 and WAR.JESS[eid] == nil then
		hurt = 0
	end
	
	--小虾米连击伤害
	if match_ID(eid, 677) and DWPD() and WAR.ACT >= 2 and JY.Person[677]["天1"] == 2 and WAR.JESS[eid] == nil then
		hurt = math.modf(hurt*0.5)
		WAR.Person[enemyid]["特效动画"] = 136
		Set_Eff_Text(enemyid, "特效文字2", "静如止水")
	end
	
	--豪鬼，罗汉
	if match_ID(eid, 673) and JY.Person[673]["天1"] == 1 and WAR.JESS[eid] == nil and JY.Person[eid]["生命"] > hurt and DWPD() then
	    local jl = 30 + math.modf(JY.Person[eid]["实战"]/15)
        if WAR.SYBD[eid] ~= nil then
           jl = 15 + math.modf(JY.Person[eid]["实战"]/50)
	    end
		if eid ~= 0 then
		jl = jl + 30
		end
		
        if math.random(101) < jl then
		   WAR.ALH = 1	
		   WAR.ACT = 10
		   WAR.LHHF[eid] = hurt
		   hurt = 0
		   if WAR.FLHS4 > 0 then		
		      WAR.LHHF[eid] = 1
		   end
	
	       WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -WAR.LHHF[eid])
		   WAR.Person[enemyid]["特效动画"] = 159
		   Set_Eff_Text(enemyid, "特效文字1", "罗汉断塔刃")
		   
		      if math.random(100) < jl - 20 then
		         WAR.Person[enemyid].Time = 999
		      end  
		else
		   WAR.LHHF[eid] = nil
		end
	end
	
	--枯荣
	if WAR.ACT == 1 and Curr_NG(eid, 186) and ((match_ID(eid, 102) and JY.Base["天书数量"] > 6) or (match_ID(eid, 687) and JY.Person[687]["天3"] == 1)) and DWPD() then
	   local add = hurt
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", add) 
	   WAR.Person[enemyid]["特效动画"] = 10
		Set_Eff_Text(enemyid, "特效文字1", "亦枯亦荣")
	end
	
	if JY.Person[eid]["地9"] == 7 and JY.Person[eid]["内力"] > hurt*3 then
	local dam = math.modf(hurt*2.4)
	hurt = math.modf(hurt*0.2)
	WAR.Person[enemyid]["特效动画"] = 162
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -dam) 
	end

	--鸠摩智，30%概率不受非连击伤害	
	if match_ID(eid, 103) and DWPD() and WAR.ACT == 1 and WAR.JESS[eid] == nil then
	local jl = 30
	if JY.Person[103]["阶"] >= 2 then
	   jl = 50
	end
	    if math.random(100) <= jl then
		hurt = 0
		WAR.Person[enemyid]["特效动画"] = 136
		Set_Eff_Text(enemyid, "特效文字2", "大轮明王")
		end
	end
	

	--封不平夺命三仙剑
	if match_ID(pid, 142) and wugong==185 and WAR.ACT > 1 then
		local s = WAR.ACT	
		while s>1 do
		hurt =math.modf(hurt*1.2)	
		s=s-1
		end
	end

	--慕容复幻梦，降低25%伤害		
	if WAR.TZ_MRF == 1 and match_ID(eid, 51) and DWPD() and WAR.JESS[eid] == nil then
		hurt = math.modf(hurt *0.75)			
	end
 
	--主角 不动如山，伤害强制为30
	if eid == 0 and WAR.FLHS4 > 0 and hurt > 30 then
		hurt = 30
	end
	
	-- 张三丰蓄力减伤
     if match_ID(eid,5) and WAR.tmp[3000+eid]~= nil and WAR.JESS[eid] == nil then
         hurt = math.modf(hurt*(1-WAR.tmp[3000+eid]/5000))
		 end	
	
	if WAR.NSDF[eid] ~= nil and WAR.JESS[eid] == nil then	--南山刀法，使用后10时序内不动如山
		hurt = 30
	end
	
	--天地玄黄 穆人清自带
	if (TiandiXH(eid) or match_ID(eid,185)) and DWPD() and math.random(100) < 6 and WAR.JESS[eid] == nil then
		hurt = 30
		Set_Eff_Text(enemyid, "特效文字5", "天地玄黄・地")
	end		
		
	if (eid==46 or (match_ID(eid, 46) and JY.Person[642]["血量翻倍"] == 1)) and DWPD() and JLSD(21, 22, eid) and WAR.JESS[eid] == nil then	--丁春秋欺师灭祖
		hurt = 0
		Set_Eff_Text(enemyid, "特效文字1", "星河真气・免疫伤害")
	end
	
	--四大山，杂鱼不死不受伤害
	if eid == 642 and (WAR.ZDDH == 290 or WAR.ZDDH == 321 or WAR.ZDDH == 315) then
		local s = 0
		for j = 0, WAR.PersonNum - 1 do
			if j ~= enemyid and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
				s = 1
				break
			end
		end
		if s == 1 then
			hurt = 0
			Set_Eff_Text(enemyid, "特效文字1", "星河真气・免疫伤害")
		end
	end
	
	if match_ID(eid, 46) and DWPD() and JY.Person[0]["品德"]==0 and hurt>30 and WAR.JESS[eid] == nil then	--丁春秋欺师灭祖
		hurt=math.modf(hurt*0.8)
	end
	
	--太极拳
	if (JY.Person[eid]["专2"] == 16 or (JY.Person[171]["阶"] >= 3 and match_ID(eid, 171))) and PersonKF(eid, 16) and WAR.JESS[eid] == nil and DWPD() then
	local dam = math.modf(hurt*0.15)
	   if JY.Wugong[wugong]["武功类型"] == 1 or JY.Wugong[wugong]["武功类型"] == 1 then
	      dam = math.modf(hurt*0.35)
	   end
	   if dam > JY.Person[eid]["拳掌功夫"] then
	      dam = JY.Person[eid]["拳掌功夫"]
	   end	  
	      Set_Eff_Text(enemyid, "特效文字1", "太极拳") 
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - dam
				
				--无酒不欢：记录人物血量
				WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - dam
				if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] < 1 then
				   JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = 1
				end   
		
	end
	--反弹
	if JY.Person[638]["声望"] >= 5 and match_ID(eid, 638) and eid == 0 and DWPD() then
	local dam = math.modf(hurt*0.2)	   
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2);	--反弹者标识为被命中
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - dam
				
				--无酒不欢：记录人物血量
				WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - dam
				if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] < 1 then
				   JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = 1
				end   
		
	end
	
	--太极剑
	if (JY.Person[eid]["专2"] == 46 or (JY.Person[171]["阶"] >= 3 and match_ID(eid, 171))) and PersonKF(eid, 46) and WAR.JESS[eid] == nil and DWPD() then
	local dam = math.modf(hurt*0.15)
	   if JY.Wugong[wugong]["武功类型"] == 3 or JY.Wugong[wugong]["武功类型"] == 4 or JY.Wugong[wugong]["武功类型"] == 4 then
	      dam = math.modf(hurt*0.3)
	   end
       if dam > JY.Person[eid]["御剑能力"] then
	      dam = JY.Person[eid]["御剑能力"]
	   end	   
	      Set_Eff_Text(enemyid, "特效文字1", "太极剑") 
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - dam
				
				--无酒不欢：记录人物血量
				WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - dam
				if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] < 1 then
				   JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = 1
				end  
		
	end
	--太极神功
	if JY.Person[eid]["专2"] == 171 and PersonKF(eid, 171) and WAR.JESS[eid] == nil and DWPD() then
	local dam = math.modf(hurt*0.15)	
	      Set_Eff_Text(enemyid, "特效文字1", "太极神功") 
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - dam
				
				--无酒不欢：记录人物血量
				WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - dam
				if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] < 1 then
				   JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = 1
				end 
		
	end
	
	--以下减伤效果，只在伤害大于30时才会触发
	if hurt > 30 and WAR.JESS[eid] == nil then
		--乾坤大挪移反弹，内力高于对方才触发
		--误伤不触发
		if (PersonKF(eid, 97) or (eid == 0 and WAR.NZQK == 1)) and DWPD() then
			WAR.fthurt = 0
			local nydx = {}
			local nynum = 1
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.Person[i]["死亡"] == false then
					nydx[nynum] = i
					nynum = nynum + 1
				end
			end
			
			--反弹的人
			local nyft = nydx[math.random(nynum - 1)]
			--张无忌可以反弹两人
			local nyft2 = nydx[math.random(nynum - 1)]
			
			local h = 0;
			--被动反弹几率50%，弹伤20%
			--主运反弹几率75%，弹伤30%
			local chance = 51
			local cfr = 0.8
			if Curr_NG(eid, 97) then
				chance = 76
				cfr = 0.7
			end
			
			--我方，每本天书增加3%反弹几率
			if inteam(eid) then
				chance = chance + JY.Base["天书数量"]*3
			end
			--张无忌反弹40%
			if match_ID(eid, 9) then
				cfr = 0.6
			end
			--逆转乾坤，必定反弹50%
			if WAR.NZQK == 1 then
				chance = 101
				cfr = 0.5
			end
			if JY.Person[eid]["天赋内功"] == 97 or match_ID(eid, 9) then
			   chance = chance + 10
			   cfr = cfr - 0.1
			end
			if fx == 0 then
			   chance = chance + yang + 1
			   cfr = cfr - 0.007*(yang + 1)
			end
			if (math.random(100) < chance) and WAR.L_QKDNY[WAR.Person[nyft]["人物编号"]] == nil then
				WAR.fthurt = math.modf(hurt*(1-cfr))			
				h = math.modf(WAR.fthurt + Rnd(10));		--反弹的伤害
				if hurt > 600 then
				   h = math.modf(h^0.88)
				end  
				hurt = math.modf(hurt*cfr)
				SetWarMap(WAR.Person[nyft]["坐标X"], WAR.Person[nyft]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				WAR.L_QKDNY[WAR.Person[nyft]["人物编号"]] = 1;
				
				WAR.Person[nyft]["生命点数"] = (WAR.Person[nyft]["生命点数"] or 0) - h;
				--无酒不欢：记录人物血量
				WAR.Person[nyft]["Life_Before_Hit"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] - h
				
				if JY.Person[eid]["专2"] == 97 then
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - h-100;
				--无酒不欢：记录人物血量
				WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - h-100
				end
				
				if JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] < 1 then
					JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = 1
				end
				
				Set_Eff_Text(enemyid, "特效文字3", "乾坤大挪移・反弹")
				  
				--张无忌，可以反弹两个人
				if match_ID(eid, 9) and nyft ~= nyft2 then
					WAR.Person[nyft2]["生命点数"] = (WAR.Person[nyft2]["生命点数"] or 0) - h;
					--无酒不欢：记录人物血量
					WAR.Person[nyft2]["Life_Before_Hit"] = JY.Person[WAR.Person[nyft2]["人物编号"]]["生命"]	
					JY.Person[WAR.Person[nyft2]["人物编号"]]["生命"] = JY.Person[WAR.Person[nyft2]["人物编号"]]["生命"] - h;
					if JY.Person[WAR.Person[nyft2]["人物编号"]]["生命"] < 1 then
						JY.Person[WAR.Person[nyft2]["人物编号"]]["生命"] = 1
					end
					WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"] .. "・双"
					SetWarMap(WAR.Person[nyft2]["坐标X"], WAR.Person[nyft2]["坐标Y"], 4, 2);	--反弹者标识为被命中
				end
			end
		end
		
		--雷震，挪移掌
	if match_ID(eid, 670) and DWPD() then
			local nydx = {}
			local nynum = 1
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.Person[i]["死亡"] == false then
					nydx[nynum] = i
					nynum = nynum + 1
				end
			end
			
			--反弹
            local nyft = nydx[math.random(nynum - 1)]
			local h = 0;
			
			local chance = 20
			local cfr = 0.9
			
			if inteam(eid) then
				chance = chance + JY.Person[eid]["拳掌功夫"]*0.07
				cfr = cfr - JY.Person[eid]["拳掌功夫"]*0.0007
			end
			if JY.Person[eid]["拳掌功夫"] >= 80 then
			   chance = chance + 10
			end
			if (math.random(100) < chance) then
				local n = math.modf(hurt*(1-cfr))			
				hurt = math.modf(hurt*cfr)
				h = math.modf(n + Rnd(10));		--反弹的伤害
				if JY.Person[eid]["拳掌功夫"] >= 200 then
				   hurt = math.modf(hurt * 0.9)
				   h = math.modf(h * 1.33)
				end
				if JY.Person[eid]["拳掌功夫"] >= 320 then
				   hurt = math.modf(hurt * 0.9)
				end
				SetWarMap(WAR.Person[nyft]["坐标X"], WAR.Person[nyft]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				local n = 0
				if JY.Person[eid]["拳掌功夫"] >= 320 then
			       n = math.modf(JY.Person[WAR.Person[nyft]["人物编号"]]["生命最大值"]*0.03)
				   if WAR.LQZ[eid] == 100 then
				      n = n + math.modf(JY.Person[WAR.Person[nyft]["人物编号"]]["生命"]*0.05)
				   end
				end
				
				WAR.Person[nyft]["生命点数"] = (WAR.Person[nyft]["生命点数"] or 0) - h - n;
				
				--无酒不欢：记录人物血量
				WAR.Person[nyft]["Life_Before_Hit"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] - h - n
				
				
				if JY.Person[eid]["拳掌功夫"] >= 320 then
				   Set_Eff_Text(enemyid, "特效文字6", "掌风・挪移掌")
				else
				   Set_Eff_Text(enemyid, "特效文字1", "挪移掌")
				end
				 
			end
		
	end
	
	if JY.Person[eid]["防具"] == 356 and DWPD() and math.random(100) <= 30 + 3*JY.Thing[356]["装备等级"] then
	   if math.random(2) == 1 then
	      Set_Eff_Text(enemyid, "特效文字1", "两极夜叉・阳")
	      hurt = math.modf(hurt*(0.84 - JY.Thing[356]["装备等级"]*0.04))
	   else	
	      Set_Eff_Text(enemyid, "特效文字1", "两极夜叉・阴") 
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - math.modf(hurt*(0.16 + JY.Thing[356]["装备等级"]*0.04))
				
				--无酒不欢：记录人物血量
				WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - math.modf(hurt*(0.16 + JY.Thing[356]["装备等级"]*0.04))
				if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] < 1 then
				   JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = 1
				end  
			end
		
	end
	
	if JY.Person[eid]["地3"] == 7 then
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2);	--反弹者标识为被命中
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - math.modf(hurt*0.1)
				--无酒不欢：记录人物血量
				WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - math.modf(hurt*0.1)
		
	end
	
	--豪鬼，气合
	if match_ID(eid, 673) and JY.Person[673]["天1"] == 2 and WAR.JESS[eid] == nil and DWPD() then
	    local jl = 20 + math.modf(JY.Person[eid]["实战"]/20)
        if WAR.SYBD[eid] ~= nil then
           jl = 15 + math.modf(JY.Person[eid]["实战"]/50)
	    end
		if eid ~= 0 then
		jl = jl + 15
		end
		
        if math.random(101) < jl then
		WAR.QHTR[eid] = 1
		local dam = math.modf(hurt*0.15+JY.Person[eid]["内力"]*0.03)
		hurt = 0
		        WAR.Person[enemyid]["特效动画"] = 159
	            Set_Eff_Text(enemyid, "特效文字1", "气合") 
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - dam
				
				--无酒不欢：记录人物血量
				WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - dam
		   
		   
		      if math.random(100) < jl then
		         WAR.Person[enemyid].Time = WAR.Person[enemyid].Time + JY.Person[eid]["实战"]
		      end  
		end
	end
	
	--以牙还牙
	if JY.Person[eid]["人20"] == 1 and DWPD() then
		local dam = math.modf(hurt*0.15)
		if dam < 50 then
		   dam = 40 + math.random(10)
		end   
		WAR.Person[enemyid]["特效动画"] = 71
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - dam
		WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
		JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - dam
		for i = 0, WAR.PersonNum - 1 do
		    if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 2)
				WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
				
				WAR.Person[i]["Life_Before_Hit"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[i]["人物编号"]]["生命"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"] - dam
				
			end	
		end		
	end
	--iron 
	if JY.Person[693]["阶"] >= 3 and match_ID(eid, 693) and DWPD() then
		local dam = math.modf(hurt*0.2)
		if dam < 40 then
		   dam = 40
		end  
		WAR.Person[enemyid]["特效动画"] = 39
		WAR.PTGJ[WAR.Person[WAR.CurID]["人物编号"]] = 1
		for i = 0, WAR.PersonNum - 1 do
		    if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 2)
				WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
				
				WAR.Person[i]["Life_Before_Hit"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[i]["人物编号"]]["生命"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"] - dam
			end	
		end		
	end
	--spt
	if JY.Person[38]["阶"] >= 2 and match_ID(eid, 38) and DWPD() then
		local dam = math.modf(hurt*0.1*math.random(1, 4))
  
		WAR.Person[enemyid]["特效动画"] = 71
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - dam
		WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
		JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - dam
		if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] < 1 then
			JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = 1
		end 
	end
	--黄蓉
	if JY.Person[56]["阶"] >= 3 and match_ID(eid, 56) and JY.Person[eid]["防具"] == 58 and DWPD() then
		local dam = math.modf(hurt*0.4)
  
		WAR.Person[enemyid]["特效动画"] = 29
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - dam
		WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
		JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - dam
		if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] < 1 then
			JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = 1
		end 
	end
	
	--star ter
    if JY.Person[eid]["地10"] == 8 then
	   if WAR.Person[WAR.CurID]["人物编号"] == 642 then
	    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - hurt
		WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
		JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - hurt
	   end
	end
		
		--无酒不欢：金刚不坏主运
		--鳌拜主运必出金钟罩
		if hurt > 30 and Curr_NG(eid, 144) and (JLSD(30, 70, eid) or match_ID(eid, 603)) then
			hurt = math.modf(hurt *0.5)
			ang = math.modf(ang *0.5)
			Set_Eff_Text(enemyid, "特效文字0", "金钟罩护体")
			WAR.Person[enemyid]["特效动画"] = 88
		--被动
		--同时学有易筋神功+金刚不坏体，主运易筋神功必出“金刚不坏”特效
		elseif hurt > 30 and PersonKF(eid, 144) and (JLSD(20, 60, eid) or Curr_NG(eid, 108)) then
		local x = 0.75
	    if tg2 ~= 1 then
		   if fx2 > 0 then
		      x = x - 0.02*fx2
		   end
		else
		      x = x - 0.02*yang2	
		end   
			hurt = math.modf(hurt * x)
			ang = math.modf(ang * x)
			Set_Eff_Text(enemyid, "特效文字0", "金刚不坏")
			WAR.Person[enemyid]["特效动画"] = 88
		end
	
		--论剑打赢独孤，九剑真传70%几率减伤20%，并降低攻方下回合集气位置
		--七夕令狐冲自带
		if ((eid == 0 and JY.Person[592]["论剑奖励"] == 1 and JLSD(15, 85,eid)) 
			or match_ID(eid, 667) or match_ID_awakened(eid, 35, 2))
			and DWPD() and WAR.JESS[eid] == nil then
			local jpwz;
			if JY.Wugong[wugong]["武功类型"] == 1 or JY.Wugong[wugong]["武功类型"] == 2 then
				jpwz = "九剑真传・破掌式"
			elseif JY.Wugong[wugong]["武功类型"] == 3 then
				jpwz = "九剑真传・破剑式"
			elseif JY.Wugong[wugong]["武功类型"] == 4 then
				jpwz = "九剑真传・破刀式"
			elseif JY.Wugong[wugong]["武功类型"] == 5 then
				jpwz = "九剑真传・破棍式"
			elseif JY.Wugong[wugong]["武功类型"] == 6 then
				jpwz = "九剑真传・破气式"
			end
			WAR.Person[enemyid]["特效动画"] = 83
			hurt = math.modf(hurt * 0.8)
			WAR.JJPZ[pid] = 1	--九剑破招
			Set_Eff_Text(enemyid, "特效文字1", jpwz)
		end
		
		--松风真传，伤害加倍	  
	if (match_ID(eid, 592) and match_ID(pid, 24)) and wugong == 27 then
		WAR.HTS = 2
		hurt = math.modf(hurt * 2)
    end
	
	--雷震，减伤
	
	if match_ID(eid, 670) and JLSD(30, 50+JY.Person[eid]["耍刀技巧"]*0.1, eid) then
	    hurt = math.modf(hurt *0.7)
	    ang = math.modf(ang *0.7)
		if JY.Person[eid]["耍刀技巧"] >= 320 then
		   hurt = math.modf(hurt *0.8)
	       ang = math.modf(ang *0.8)
		   if math.random(100) <= 30 then
		   hurt = math.modf(hurt * 0.7)
		   ang = 0
		   end
		   WAR.Person[enemyid]["特效动画"] = 162
		   Set_Eff_Text(enemyid, "特效文字6", "刀罡・金钟罩")
		else
		   WAR.Person[enemyid]["特效动画"] = 88
		   Set_Eff_Text(enemyid, "特效文字1", "金钟罩")
		end
    end
  
		--无酒不欢：八荒六合功
		if ((PersonKF(eid, 101) and JLSD(40, 60, eid)) or (Curr_NG(eid, 101) and JLSD(20, 80, eid)) or WAR.NGHT == 101) and DWPD() and WAR.JESS[eid] == nil then
			local reduction = math.modf(hurt * 0.333)
			--雷震天内
			if match_ID(eid, 670) and JY.Person[eid]["天赋内功"] == 101 then
			    reduction = math.modf(reduction*1.35)
			end
			hurt = hurt - reduction
			WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)+reduction
			AddPersonAttrib(eid, "内力", reduction)
			local bhwz;
			if math.random(2) == 1 then
				bhwz = "八荒六合.唯我独尊"
			else
				bhwz = "天长地久.不老长春"
			end
			Set_Eff_Text(enemyid, "特效文字3", bhwz)
		end

		--主运混元30%，被动3%概率三分归元气			
	if ((Curr_NG(eid, 90) and JLSD(20,50,eid)) or (PersonKF(eid, 90) and JLSD(30, 33, eid))) and DWPD() and WAR.JESS[eid] == nil then
		if WAR.SFGYQ[eid] == nil then
			WAR.SFGYQ[eid] = 33
		else
			WAR.SFGYQ[eid] = WAR.SFGYQ[eid] + 33
		end
		WAR.Person[enemyid]["特效文字2"] = "三分归元气"
		WAR.Person[enemyid]["特效动画"] = 145
	end

		--学有三分剑法，主运混元30%，被动3%概率七分靠打拼	
	if ((Curr_NG(eid, 90) and JLSD(40,70,eid)) or (PersonKF(eid, 90) and JLSD(20, 23, eid))) and PersonKF(eid, 29) and DWPD() and WAR.JESS[eid] == nil then
		if WAR.QFKDP[eid] == nil then
			WAR.QFKDP[eid] = 77
		else
			WAR.QFKDP[eid] = WAR.QFKDP[eid] + 77
		end
		WAR.Person[enemyid]["特效文字1"] = "七分靠打拼"
		WAR.Person[enemyid]["特效动画"] = 143
	end
	
	
	
		--紫霞神功，用内力抵消20%伤害
		if PersonKF(eid, 89) and WAR.ZXSG == 1 and DWPD() and WAR.JESS[eid] == nil and PersonKF(eid, 90) == false then
	    if JY.Person[eid]["内力"] >= math.modf(hurt*0.2) then
			   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)-math.modf(hurt*0.2) ;
			   AddPersonAttrib(eid, "内力", -math.modf(hurt*0.2));
	         end	
	    if JY.Person[eid]["内力"] < math.modf(hurt*0.2)  then
		     WAR.ZXSG =0 
            end
        end

        --空而明之，用内力抵消35%伤害
		if  match_ID(eid, 677) and JY.Person[677]["天2"] == 2 and DWPD() and WAR.JESS[eid] == nil then
	        if JY.Person[eid]["内力"] >= math.modf(hurt*0.35) then
			   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)-math.modf(hurt*0.35) ;
			   AddPersonAttrib(eid, "内力", -math.modf(hurt*0.35));
	        end	
        end		
		
		--天地玄黄 穆人清自带
		if (TiandiXH(eid) or match_ID(eid,185)) and DWPD() and math.random(100) > 94 and WAR.JESS[eid] == nil then
			if JY.Person[eid]["内力"] >= math.modf(hurt*0.5) then
				WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)-math.modf(hurt*0.5) ;
			    AddPersonAttrib(eid, "内力", -math.modf(hurt*0.5));
	         end
			hurt = math.modf(hurt * 0.5)
			WAR.Person[enemyid]["特效动画"] = 111
			Set_Eff_Text(enemyid, "特效文字5", "天地玄黄・黄")	
		end
		
		--无酒不欢：太空卸劲35%几率，减伤30%，敌方下回合集气位置-100
		if TaiKong(eid) and WAR.JESS[eid] == nil then
		local jl = 65
		if tg2 ~= 1 then
		   if fx2 < 0 then
		      jl = jl - fx2*2
		   end
		else
		   if yin2 < 0 then
		      jl = jl - yin2*2
		   end
		end
		   
		if JLSD(30, jl, eid) then
			hurt = math.modf(hurt * 0.6)
			WAR.TKJQ[pid] = 1	--太空卸劲
			WAR.Person[enemyid]["特效动画"] = 113
			Set_Eff_Text(enemyid, "特效文字3", "太空卸劲")
		end
		end
		
		--七伤拳，肺
		if wugong == 23 and (WAR.YZQS == 2 or WAR.YZQS == 7) then
		   WAR.QSQ[eid] = 17
		   if JY.Person[pid]["内力"] < 5000 and JY.Person[pid]["内力最大值"] < 9999 then
		      WAR.QSQ[pid] = 7
		   end
		end
		
		--雷震，借气回元
		if match_ID(eid, 670) and (math.random(100) < 10 + JY.Base["天书数量"] + math.modf(JY.Person[eid]["指法技巧"] * 0.05) or (WAR.LQZ[eid] == 100 and math.random(100) < 70 + JY.Base["天书数量"] + math.modf(JY.Person[eid]["指法技巧"] * 0.05))) then
		   WAR.JQJQ = math.modf(hurt*(0.5+JY.Person[eid]["指法技巧"]*0.001)) + 100
		   WAR.JQHY[pid] = 1
		   WAR.JQHY2[eid] = 1
		   WAR.Person[enemyid]["特效动画"] = 113
	       Set_Eff_Text(enemyid, "特效文字1", "借气回元")
		end
		
		
		
		--碧落九重剑：重
		if match_ID(pid, 670) and JY.Person[pid]["御剑能力"] >= 320 and (JY.Wugong[wugong]["武功类型"] == 3 or wugong == 49) then
		   local jl = 25
		   if JY.Person[pid]["生命"] <= JY.Person[pid]["生命最大值"]*0.5 then
		      jl = jl + 25
		   end
		   if WAR.LQZ[pid] ~= nil then
		      jl = jl + math.modf(WAR.LQZ[pid] * 0.66)
		   end
		   if math.random(100) < jl then
		      WAR.LZ_Z[eid] = 15
			  Set_Eff_Text(enemyid, "特效文字6", "重")
		   end
		end
		
		
		--雷震，蚀
		if match_ID(pid, 670) and JY.Person[pid]["特殊兵器"] >= 320 and JY.Wugong[wugong]["武功类型"] == 5 then
		   local jl = 25
		   if JY.Person[pid]["生命"] <= JY.Person[pid]["生命最大值"]*0.5 then
		      jl = jl + 10
		   end
		   if WAR.LQZ[pid] ~= nil then
		      jl = jl + math.modf(WAR.LQZ[pid] * 0.4)
		   end
		   if math.random(100) < jl then
		      WAR.LZ_S[eid] = 6
			  JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"] + 25
			  WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(enemyid, "中毒程度", 25);
			  Set_Eff_Text(enemyid, "特效文字6", "蚀")
		   end
		end
		
		--雷震，寒
		if match_ID(pid, 670) and JY.Person[pid]["指法技巧"] >= 320 and JY.Wugong[wugong]["武功类型"] == 2 
		or (JY.Person[pid]["武器"] == 345 and JY.Wugong[wugong]["武功类型"] == 1 and (fx < 0 or tg == 1) and math.random(11) < JY.Thing[345]["装备等级"]+6) then
		   local jl = 20
		   if JY.Person[pid]["生命"] <= JY.Person[pid]["生命最大值"]*0.5 then
		      jl = jl + 15
		   end
		   if WAR.LQZ[pid] ~= nil then
		      jl = jl + math.modf(WAR.LQZ[pid] * 0.3)
		   end
		   if math.random(100) < jl then
		      WAR.LZ_H[eid] = 20
			  if WAR.LZ_HH[eid] == nil then
			     WAR.LZ_HH[eid] = JY.Person[eid]["主运轻功"]
			     JY.Person[eid]["主运轻功"] = 0
			  end
			  Set_Eff_Text(enemyid, "特效文字6", "寒")
		   end
		end
		
		--雷震，烈
		if match_ID(pid, 670) and JY.Person[pid]["耍刀技巧"] >= 320 and JY.Wugong[wugong]["武功类型"] == 4 
		or (JY.Person[pid]["武器"] == 345 and JY.Wugong[wugong]["武功类型"] == 1 and (fx > 0 or tg == 1) and math.random(11) < JY.Thing[345]["装备等级"]+6) then
		   local jl = 25
		   if JY.Person[pid]["生命"] <= JY.Person[pid]["生命最大值"]*0.5 then
		      jl = jl + 10
		   end
		   if WAR.LQZ[pid] ~= nil then
		      jl = jl + math.modf(WAR.LQZ[pid] * 0.5)
		   end
		   if math.random(100) < jl then
		      WAR.LZ_L[eid] = 30
			  Set_Eff_Text(enemyid, "特效文字6", "烈")
		   end
		end
		
		--雷震，夺
		if match_ID(pid, 670) and JY.Person[pid]["拳掌功夫"] >= 320 and JY.Wugong[wugong]["武功类型"] == 1 then
		   local jl = 20
		   if JY.Person[pid]["生命"] <= JY.Person[pid]["生命最大值"]*0.5 then
		      jl = jl + 10
		   end
		   if WAR.LQZ[pid] ~= nil then
		      jl = jl + math.modf(WAR.LQZ[pid] * 0.4)
		   end
		   if math.random(100) < jl then
		      WAR.LZ_D[eid] = 30
			  Set_Eff_Text(enemyid, "特效文字6", "夺")
		   end
		end
	end
	
	if match_ID(eid, 678) and JY.Person[678]["天3"] ~= 0 then
	local jl = JY.Person[eid]["指法技巧"]*0.1
	  if math.random(100) < jl then
	    if JY.Person[eid]["内力"] > 500 or JY.Person[678]["天3"] == 2 then
		WAR.LXYZF = 1
		hurt = math.modf(hurt*(70-jl)*0.01)
		WAR.Person[enemyid]["特效动画"] = 159
		Set_Eff_Text(enemyid,"特效文字6","灵犀一指")
		if JY.Person[678]["天3"] == 1 then
		   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)-300
		   AddPersonAttrib(eid, "内力", -300)
		end
		end
		if math.random(100) < jl then
		   WAR.ACT = 10
		end   
	  end
	end
	
	if hurt > 30 and WAR.JQSDXS[eid] ~= nil then
	--飞絮
	if Curr_NG(eid, 107) and JLSD(20, 50, eid) then
	   hurt = math.modf(hurt*0.75)- WAR.JQSDXS[eid]
	   Set_Eff_Text(enemyid,"特效文字3","飞絮劲")
	   if hurt < 1 then
	      hurt = math.random(5)
	   end	  
	end
	end
	
	if wugong == 123 and math.random(100) >= 90 and JY.Person[pid]["专1"] == 123 then
	   WAR.SHMY[eid] = 1
	   Set_Eff_Text(enemyid,"特效文字1","夺魄噬魂")
	end
	--任我行
	if JY.Person[26]["阶"] >= 3 and match_ID(pid, 26) then
	   if WAR.JQSDXS[eid] ~= nil and WAR.JQSDXS[eid] > 10 then
	   if WAR.XQJQ[pid] == nil then
	      WAR.XQJQ[pid][eid] = 1
	   else
	      WAR.XQJQ[pid][eid] = (WAR.XQJQ[pid][eid] or 0) + 1
	   if WAR.XQJQ[pid][eid] > 17 then
	      WAR.XQJQ[pid][eid] = 17
	   end
	   end
	   end
	end
	
	
	--无名
	if JY.Person[671]["阶"] >= 3 and match_ID(eid, 671) and DWPD() then
	   if WAR.WMJY[eid] == nil then
	   WAR.WMJY[eid] = 1
	   else
	   WAR.WMJY[eid] = WAR.WMJY[eid] + 1 + math.random(5)
	   if WAR.WMJY[eid] > 100 then
	      WAR.WMJY[eid] = 100
	   end
	   end
	end
	
	--丁典
	if JY.Person[672]["阶"] >= 3 and match_ID(eid, 672) and DWPD() then
	   if WAR.DDJQ[eid] == nil then
	   WAR.DDJQ[eid] = 1
	   else
	   WAR.DDJQ[eid] = WAR.DDJQ[eid] + 1 + math.random(2)
	   end
	end
	
	--张角 
	if match_ID(eid, 694) and DWPD() then
	   if WAR.ZJSB[eid] == nil then
	   WAR.ZJSB[eid] = 7 + JY.Base["天书数量"]
	   else
	   WAR.ZJSB[eid] = WAR.ZJSB[eid] + 7 + JY.Base["天书数量"]
	   end
	end
	
	--tq 
	if JY.Person[693]["阶"] >= 2 and match_ID(eid, 693) and DWPD() then
	   if WAR.TQJQ[eid] == nil then
	   WAR.TQJQ[eid] = 1
	   else
	   WAR.TQJQ[eid] = WAR.TQJQ[eid] + math.random(7)
	   end
	end
	
	--钟灵
	if JY.Person[90]["阶"] >= 1 and match_ID(pid, 90) and JY.Person[pid]["动物"] == 350 then
	   WAR.SDD[eid] = 1
	end
	--skill--lotus whip,dragon's touch,surging fist,dragon tail,crescent heel,twin snake,rising fang*,wall of kun-lun*,iron rage**,volcanic roar**,dragon's prey***
	if match_ID(pid, 693) and DWPD() then
	
	   if wugong == 242 then
	   WAR.L_NOT_MOVE[eid] = 1
	   end
	   if wugong == 243 then
	   WAR.FXDS[eid] = 25
	   end

	   if wugong == 246 then
	      WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)-500
		  AddPersonAttrib(eid, "内力", -500)
	   end
	   
	   if wugong == 249 then
	      WAR.HMZT[eid] = 1
	   end
	end
	
	--桃谷六仙
	if (JY.Person[147]["阶"] >= 1 and match_ID(pid, 147)) or (
	(match_ID(pid, 143) or match_ID(pid, 144) or match_ID(pid, 145) or match_ID(pid, 146) or match_ID(pid, 147) or match_ID(pid, 148)) and JY.Person[147]["阶"] >= 3
	) then
	   WAR.TGLX[eid] = 1
	end
	
	
	--蓝凤凰
	if JY.Person[25]["阶"] >= 2 and match_ID(pid, 25) then
	local jl = 50
	if JY.Person[25]["阶"] >= 3 then
	   jl = 100
	end
	local g
	local GU = {"蛇蛊","金蚕蛊","蔑片蛊","石头蛊","泥瞅蛊","惘蛊","肿蛊","癫蛊","姑蛊"}
	
	if math.random(100) <= jl then
	
    g = math.random(9)
       if g == 1 then
	      if WAR.GSG[eid] == nil then
		     WAR.GSG[eid] = 1
		  end
	   elseif g == 2 then
	      if WAR.GJCG[eid] == nil then
		     WAR.GJCG[eid] = 1
		  end
	   elseif g == 3 then
	      if WAR.GMPG[eid] == nil then
		     WAR.GMPG[eid] = 1
		  end
	   elseif g == 4 then
	      if WAR.GSTG[eid] == nil then
		     WAR.GSTG[eid] = 1
		  end
	   elseif g == 5 then
	      if WAR.GNQG[eid] == nil then
		     WAR.GNQG[eid] = 1
		  end
	   elseif g == 6 then
	      if WAR.GWG[eid] == nil then
		     WAR.GWG[eid] = 1
		  end
	   elseif g == 7 then
	      if WAR.GZG[eid] == nil then
		     WAR.GZG[eid] = 1
		  end
	   elseif g == 8 then
	      if WAR.GDG[eid] == nil then
		     WAR.GDG[eid] = 1
		  end
	   elseif g == 9 then
	      if WAR.GGG[eid] == nil then
		     WAR.GGG[eid] = 1
		  end
	   end
	   Set_Eff_Text(enemyid,"特效文字1",GU[g])
	   
	end

	   
	end
	
	--闪避不触发两仪守护，或张家辉的护身戒指
	if hurt > 0 and WAR.JESS[eid] == nil then
		--无酒不欢：两仪守护64%几率，固定降低32点伤害
		--switchfunct
		if LiangYi(eid) and JLSD(20, 84, eid) then
		   WAR.LYSH = 3
			--32%几率变两仪守护・极
		   if JLSD(30,62,eid) or (match_ID(eid, 7) and JY.Person[7]["阶"] >= 3) then 
		      WAR.LYSH = 4
			  hurt = hurt - 256
			  --至少留1血
			  if hurt < 1 then
				 hurt = 1
			  end
			  WAR.Person[enemyid]["特效动画"] = 21
			  Set_Eff_Text(enemyid, "特效文字3", "两仪守护・极")
		   else  
			  hurt = hurt - 64
			  --至少留1血
			  if hurt < 1 then
				  hurt = 1
			  end
			  WAR.Person[enemyid]["特效动画"] = 21
			  Set_Eff_Text(enemyid, "特效文字3", "两仪守护")
		   end
		end
		if (PersonKF(eid, 37) and JY.Person[eid]["专2"] == 37) or (PersonKF(eid, 60) and JY.Person[eid]["专2"] == 60) then
		    hurt = hurt - 40
		end
		--至阴至柔
		if ZhiYZR(eid) > 0 and hurt > 50 then
		   hurt = hurt - ZhiYZR(eid)*15
		   if hurt < 30 then
		      hurt = 1
		   end	  
		end
		--张家辉的护身戒指
		if JY.Person[eid]["防具"] == 302 then
			local factor = 3
			if JY.Thing[302]["装备等级"] >=5 then
				factor = 1
			elseif JY.Thing[302]["装备等级"] >=3 then
				factor = 2
			end
			local hn = math.modf(hurt/2*factor)
			if JY.Person[eid]["内力"] > hn then
				hurt = math.modf(hurt/2)
				WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)+AddPersonAttrib(eid, "内力", -hn)
				WAR.Person[enemyid]["特效动画"] = 144
			end
		end
		if JY.Person[pid]["中毒程度"] > 0 and JY.Person[eid]["人30"] == 1 then
	       WAR.HLJS = 1
	    end
	end
	
	
	
	
	--无酒不欢：太极奥义，降低25%杀气，真太奥免疫杀气
	if TaiJi(eid) and WAR.JESS[eid] == nil then
		--张三丰75%几率
		local jl = 45 + math.modf(JY.Person[eid]["资质"] / 4)	
		if match_ID(eid, 5) then
		   jl = 85
		end   
		if JLSD(10, jl, eid) then
			--杀气降低25%
		    ang = ang * 0.75
		    --学有太极神功，触发太极奥义减伤10%
		    if PersonKF(eid, 171) then
			    hurt = math.modf(hurt * 0.9)
		    end
		    WAR.Person[enemyid]["特效动画"] = 21
		    --学有太极神功必出真太奥，否则有25%几率发动
		    if PersonKF(eid, 171) or JLSD(40, 65, eid) then
			    WAR.TJAY = 4
			    Set_Eff_Text(enemyid,"特效文字1","太极真义・四两拨千斤");
		    else
			    Set_Eff_Text(enemyid,"特效文字2","太极奥义");
		    end
	    end
			
	end
	
	if (match_ID(eid, 36) and JY.Person[36]["天1"] == 1) or (match_ID(eid, 48) and JY.Person[48]["天1"] == 1) then
	   ang = ang * 0.85
	   hurt = math.modf(hurt * 0.85)
	end
	
	
	--逍遥御风
	if XiaoYaoYF(eid) and JLSD(20,70,eid) and (WAR.XYYF[eid] == nil or WAR.XYYF[eid] < 9) and WAR.YFCS < 3 and WAR.JESS[eid] == nil then
		WAR.YFCS = WAR.YFCS + 1
		WAR.XYYF[eid] = (WAR.XYYF[eid] or 0) + 1
		Set_Eff_Text(enemyid,"特效文字2","逍遥御风")
		if WAR.XYYF[eid] == 9 then
			WAR.XYYF[eid] = 11
			WAR.XYYF_10 = 1
		end
	end
		
	--欧阳锋逆运走火
	--有逆运才会
	if WAR.tmp[1000+eid] ~= 1 and match_ID(eid, 60) and PersonKF(eid, 104) and WAR.JESS[eid] == nil then
		if JY.Person[eid]["体力"] > 50 then
			WAR.Person[enemyid]["特效动画"] = math.fmod(wugong, 10) + 85
			WAR.Person[enemyid]["特效文字3"] = "真--逆运筋脉走火入魔"
			WAR.tmp[1000+eid] = 1
		end
	end
	
	--石破天，50%几率给攻击方上封穴
	if (match_ID_awakened(eid, 38, 1) and DWPD() and JLSD(20,70,eid)) or (match_ID(eid, 636) and DWPD() and JLSD(20,70,eid)) or (Curr_NG(eid, 102) and DWPD() and JLSD(20,30,eid) and JY.Person[7]["血量翻倍"] == 1) and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = math.fmod(wugong, 10) + 85
		Set_Eff_Text(enemyid, "特效文字3", "太玄神功・反震")
		WAR.FXXS[WAR.Person[WAR.CurID]["人物编号"]] = 1
       	WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] = (WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] or 0) + 10
		--封穴上限50点
		if 25 < WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] then
			WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] = 25
		end
	end
	
	if JY.Person[eid]["人38"] == 1 and DWPD() then
		WAR.Person[enemyid]["特效动画"] = math.fmod(wugong, 10) + 85
		Set_Eff_Text(enemyid, "特效文字3", "后发制人")
		local t = math.random(5,10)
		WAR.FXXS[WAR.Person[WAR.CurID]["人物编号"]] = 1
       	WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] = (WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] or 0) + t
		if JY.Person[eid]["人28"] == 1 then
		WAR.LJXS[WAR.Person[WAR.CurID]["人物编号"]] = t
		end
		--封穴上限50点
		if 25 < WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] then
			WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] = 25
		end
	end
	
	--九阳神功，25%几率给攻击方上封穴
	if (Curr_NG(eid, 106) and DWPD() and JLSD(20,45,eid)) or (eid==9 and DWPD() and WAR.ZDDH == 288) and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = math.fmod(wugong, 10) + 85
		Set_Eff_Text(enemyid, "特效文字0", "九阳神功・反震")
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		--无酒不欢：记录人物血量
		WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[pid]["生命"]
		local selfhurt = math.modf(hurt * 0.3)
		JY.Person[pid]["生命"] = JY.Person[pid]["生命"] - math.modf(selfhurt)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)-math.modf(selfhurt)
		if JY.Person[pid]["生命"] < 1 then
		JY.Person[pid]["生命"] = 1
		end
		WAR.FXXS[WAR.Person[WAR.CurID]["人物编号"]] = 1
       	WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] = (WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] or 0) + 5
		--封穴上限50点
		if 25 < WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] then
			WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] = 25
		end
	end
	
	--煞星
	if JY.Person[eid]["地7"] == 7 and DWPD() and WAR.JESS[eid] == nil then
		WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度", 100)
		JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["冰封程度"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["冰封程度"] + 100
	    WAR.BFXS[WAR.Person[WAR.CurID]["人物编号"]] = 1
			if 100 < JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["冰封程度"] then
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["冰封程度"] = 100
			end
		JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["灼烧程度"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["灼烧程度"] + 50
	    WAR.ZSXS[WAR.Person[WAR.CurID]["人物编号"]] = 1
			if 50 < JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["灼烧程度"] then
				JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["灼烧程度"] = 50
			end	
		WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", 100)
	end
	--祸乱
	if JY.Person[eid]["人30"] == 1 and DWPD() then
	   WAR.Person[enemyid]["特效动画"] = 163
	   for i = 0, WAR.PersonNum - 1 do
	    if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false then
		WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
		
		WAR.Person[i]["中毒点数"] = (WAR.Person[i]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "中毒程度", math.random(25,50))
		JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] = JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] + math.random(25,46)
	    WAR.BFXS[WAR.Person[i]["人物编号"]] = 1
			if 100 < JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] then
				JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] = 100
			end
		JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] = JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] + math.random(17,25)
	    WAR.ZSXS[WAR.Person[i]["人物编号"]] = 1
			if 50 < JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] then
				JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] = 50
			end	
		WAR.Person[i]["内伤点数"] = (WAR.Person[i]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "受伤程度", math.random(25,45))
		end
	   end
	end
	
	--何铁手，给攻击方强制上毒
	if match_ID(eid, 83) and DWPD() and WAR.JESS[eid] == nil then
		WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度", math.random(45, 50))
		if JY.Person[83]["阶"] >= 2 then
		local dam = math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命最大值"]*0.05)
		   SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - dam
		   WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"]	
		   JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - dam
		end
	end
	
	
	--宁中则，降低攻击方体力
	if match_ID(eid, 649) and DWPD() and WAR.JESS[eid] == nil then
		WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + AddPersonAttrib(pid, "体力", -math.random(5,10))
		Set_Eff_Text(enemyid,"特效文字5","如狼又似虎")
	end
	
	--何太冲，攻击时60%几率附加琴音状态，上限20层
	if match_ID(pid, 7) and DWPD() and JLSD(20,80,pid) then
		if WAR.QYZT[eid] == nil then
			WAR.QYZT[eid] = math.random(3)
		else
			WAR.QYZT[eid] = WAR.QYZT[eid] + math.random(3)
			if WAR.QYZT[eid] > 20 then
				WAR.QYZT[eid] = 20
			end
		end
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 63
		end
		Set_Eff_Text(enemyid,"特效文字0","铁琴琴音")
	end
	
	--剑胆琴心，挨打增加御剑
	if JiandanQX(eid) and DWPD() then
		local max_bonus = 320 - JY.Person[eid]["御剑能力"]
		if max_bonus < 0 then
		   max_bonus = 0
		end
		if WAR.JDYJ[eid] == nil then
			WAR.JDYJ[eid] = 0
		end
		if WAR.JDYJ[eid] < max_bonus then
			WAR.JDYJ[eid] = WAR.JDYJ[eid] + math.modf(hurt/20)
			WAR.Person[enemyid]["特效动画"] = 125
			Set_Eff_Text(enemyid,"特效文字3","剑胆琴心")
			if WAR.JDYJ[eid] > max_bonus then
				WAR.JDYJ[eid] = max_bonus
			end
		end
	end
	
	--一苇渡江，挨打增加轻功
	if Curr_QG(eid, 182) and DWPD() and WAR.JESS[eid] == nil then
		local max_bonus1 = 520 - JY.Person[eid]["轻功"]
		if WAR.YWDJ[eid] == nil then
			WAR.YWDJ[eid] = 0
		end
		if WAR.YWDJ[eid] < max_bonus1 then
			WAR.YWDJ[eid] = WAR.YWDJ[eid] + hurt
			WAR.Person[enemyid]["特效动画"] = 125
			Set_Eff_Text(enemyid,"特效文字3","一苇渡江")
			if WAR.YWDJ[eid] > max_bonus1 then
				WAR.YWDJ[eid] = max_bonus1
			end
		end
	end
	
	--苗人凤指令 破军
	if match_ID(pid, 3) and WAR.MRF == 1 then
		WAR.PJZT[eid] = 50
		if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		end
		JY.Person[eid]["主运内功"] = 0
	end
	
	--金轮，十龙十象蓄力
	if WAR.SLSX[pid] ~= nil and DWPD() then
		WAR.HMZT[eid] = 1
	end
	
	--太极推手
	if PersonKF(pid, 171) and DWPD() and WAR.tmp[3000 + pid] == 1080 and (wugong == 16 or wugong == 46) then
		WAR.HMZT[eid] = 1
		WAR.Person[enemyid]["特效动画"] = 94
		Set_Eff_Text(enemyid, "特效文字1", "易有太极，是生两仪")
		hurt = hurt+270
		if match_ID(pid, 80) and JY.Person[80]["阶"] >= 3 then
		else
		WAR.tmp[3000 + pid] = 0
		end
	end
	
	--一灯用一阳指，无明业火
	if match_ID(pid, 65) and wugong == 17 and DWPD() then
		WAR.WMYH[eid] = 30
	end
	
	--无酒不欢：举火燎原，金乌+燃木+火焰刀，暴怒造成引燃效果
	if WAR.JuHuo == 1 and DWPD() then
		WAR.JHLY[eid] = 10
		WAR.Person[enemyid]["特效动画"] = 112
	end
	
	--噬魂
	if wugong == 209 and DWPD() then
	   WAR.SHMY[eid] = 1
	end
	--狂犬病
	if WAR.AHGJ == 1 then
	   if WAR.KQB[eid] ~= nil then
	   WAR.KQB[eid] = WAR.KQB[eid] + math.random(3)
	   else 
	   WAR.KQB[eid] = math.random(3)
	   end
	end   
	
	--无酒不欢：利刃寒锋，修罗+阴风+沧溟，暴怒造成冻结效果
	if WAR.LiRen == 1 and DWPD() then
		WAR.LRHF[eid] = 10
		WAR.Person[enemyid]["特效动画"] = 116
	end
	
	if WAR.HBZQ == 1 and DWPD() then
	   if WAR.HBZQJS[eid] == nil then
	      WAR.HBZQJS[eid] = 35
		  WAR.HBZQDJ[eid] = 1
	   else
	      WAR.HBZQJS[eid] = WAR.HBZQJS[eid] + 35 - WAR.HBZQDJ[eid]*2
		  WAR.HBZQDJ[eid] = WAR.HBZQDJ[eid] + 1
		  if WAR.HBZQDJ[eid] > 10 then
		     WAR.HBZQDJ[eid] = 10
		  end
	   end 
	end
	
	if DWPD() then
	if WAR.YZHH == 1 then
	   if WAR.LRHF[eid] == nil then
	      WAR.LRHF[eid] = 13
	   else
          WAR.LRHF[eid] = WAR.LRHF[eid] + 10
	   end
	elseif WAR.YZHH == 2 then
	   if WAR.JHLY[eid] == nil then
	      WAR.JHLY[eid] = 13
	   else
          WAR.JHLY[eid] = WAR.JHLY[eid] + 10
	   end
	elseif WAR.YZHH == 3 then
	   WAR.HMZT[eid] = 1
	  
	elseif WAR.YZHH == 4 then
	   if WAR.JESS[eid] == nil then
	      WAR.JESS[eid] = 8
	   else
          WAR.JESS[eid] = WAR.JESS[eid] + 8
	   end
	   
	elseif WAR.YZHH == 5 then
	   if WAR.XRZT[eid] == nil then
	      WAR.XRZT[eid] = 16
	   else
          WAR.XRZT[eid] = WAR.XRZT[eid] + 16
	   end
	   
	elseif WAR.YZHH == 6 then
	   if WAR.LSQ[eid] == nil then
	      WAR.LSQ[eid] = 25
	   else
          WAR.LSQ[eid] = WAR.LSQ[eid] + 20
	   end
	   
	elseif WAR.YZHH == 7 then
	   if WAR.WYSQ[eid] == nil then
	      WAR.WYSQ[eid] = 11
	   else
          WAR.WYSQ[eid] = WAR.WYSQ[eid] + 10
	   end
	   
	end
	end
	
	if wugong == 176 and JY.Person[pid]["专2"] == 176 and DWPD() then
	   if WAR.JHLY[eid] == nil then
	      WAR.JHLY[eid] = 50
	   else
          WAR.JHLY[eid] = WAR.JHLY[eid] + 50
	   end
	end
	
	--五轮大法
	if WAR.WLDF == 1 and DWPD() then
	   WAR.HMZT[eid] = 1  
	end
	
	if match_ID(eid, 691) then
	   WAR.PPWQ[eid] = math.random(30-JY.Base["天书数量"])
    end
	if WAR.PPWQ[pid] ~= nil then
	   WAR.PPWQ[pid] = nil
	end
	--林平之
	if match_ID(eid, 36) and JY.Person[36]["天1"] == 1 then
	   WAR.FCZX[eid] = pid
	end
	--慈悲刀法
	if WAR.CBDF == 1 and DWPD() then
	   if WAR.XRZT[eid] == nil then
	      WAR.XRZT[eid] = 15
	   else
          WAR.XRZT[eid] = WAR.XRZT[eid] + 15
	   end
	end
	
	--三花聚顶
	if WAR.SHJD == 1 and DWPD() then
	      WAR.JESS[eid] = 8
	end
	
	if match_ID(pid, 676) and DWPD() then
	   if WAR.DJJ == 1 then
	   if WAR.LRHF[eid] == nil then
		WAR.LRHF[eid] = 7
	   else
	    WAR.LRHF[eid] = WAR.LRHF[eid] + 7
	   end
	   end
	   if WAR.SDLT == 1 then
	      WAR.BLZ[eid] = 1
	   end
	end  

    if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 692) and wugong == 26 and JY.Person[692]["天4"] == 1 and DWPD() then
	   WAR.KLYHB[eid] = 1
	end	

	
	--游坦之攻击冰封大于50的敌人，有60%几率将其冻结10时序
	if match_ID(pid,48) and JY.Person[eid]["冰封程度"] > 50 and JLSD(20,80,pid) or (JY.Person[pid]["动物"] == 351 and math.random(100) <= 4 + JY.Thing[351]["装备等级"] * 2) then
	    if WAR.LRHF[eid] == nil then
		WAR.LRHF[eid] = 10
		else
		   if WAR.LRHF[eid] < 15 then
		      WAR.LRHF[eid] = 15
		   end
		end
		WAR.Person[enemyid]["特效动画"] = 116
		Set_Eff_Text(enemyid, "特效文字3", "千年冰蚕・冻结")
	end
	--陨石
	if match_ID(pid, 689) and wugong == 231 and DWPD() then
	    if WAR.WYSQ[eid] ~= nil then
		WAR.WYSQ[eid] = WAR.WYSQ[eid] + 5
		else
		WAR.WYSQ[eid] = 5+JY.Person[689]["天3"]*2
		end
	end
	--超震声波
	if match_ID(pid, 689) and wugong == 235 and DWPD() then
	    if WAR.CZSB[eid] ~= nil then
		WAR.CZSB[eid] = WAR.CZSB[eid] + JY.Person[689]["天2"]*2
		else
		WAR.CZSB[eid] = 15+JY.Person[689]["天2"]*3
		end
		WAR.Jiaox[eid] = 1
	end
	
	--急速冷却
	if match_ID(pid, 689) and wugong == 226 and DWPD() then
	    if WAR.LRHF[eid] ~= nil then
		WAR.LRHF[eid] = WAR.LRHF[eid] + 5
		else
		WAR.LRHF[eid] = 10
		end
		WAR.JSLQ[eid] = 30+JY.Person[689]["天1"]*5
	end
	
	if WAR.JSLQ[eid] ~= nil then
	    if WAR.LRHF[eid] ~= nil then
		WAR.LRHF[eid] = WAR.LRHF[eid] + 3
		else
		WAR.LRHF[eid] = 3
		end
	end
	
	if JY.Person[pid]["地4"] == 8 and math.random(85) < 45 and DWPD() then
	   WAR.KJZ[eid] = 1
	   Set_Eff_Text(enemyid, "特效文字6", "Yieks!")
	end
	
	if wugong == 240 and math.random(3) == 1 and DWPD() then
	   WAR.KJZ[eid] = 1
	end
	
	--移魂大法
	if DWPD() then
	if WAR.YHDF == 1 then
	   WAR.KJZ[eid] = 1	   
	elseif WAR.YHDF == 2 then
	   if JY.Person[eid]["生命"] < JY.Person[eid]["生命最大值"]*0.2 then
	   WAR.KXS[eid] = 20
	   WAR.Person[enemyid]["我方"] = WAR.Person[WAR.CurID]["我方"]
	   else
	   WAR.KJZ[eid] = 1
	   end
    end   
	end
	
	if JY.Person[pid]["武器"] == 354 and math.random(100) <= 10 + JY.Thing[354]["装备等级"] then
	    if WAR.QJJB[pid] == nil then
		WAR.QJJB[pid] = 4 + JY.Thing[351]["装备等级"]
		else
		   if WAR.QJJB[pid] < 15 then
		      WAR.QJJB[pid] = 15
		   end
		end
		WAR.Person[WAR.CurID]["特效动画"] = 53
		Set_Eff_Text(WAR.CurID, "特效文字1", "龙翔九天")
	end	
	
	if wugong == 245 then
	   WAR.Person[WAR.CurID]["特效动画"] = 111
	end
	if wugong == 249 then
	   WAR.Person[WAR.CurID]["特效动画"] = 92
	end
	
	--冻结	
	if JY.Person[pid]["地1"] == 6 then
		WAR.BDZX[eid] = 10
		WAR.Person[enemyid]["特效动画"] = 116
		Set_Eff_Text(enemyid, "特效文字1", "冰冻之息")
	end

	--阿三大力金刚指，30%概率冻结10时序	
	if match_ID(pid,645) and wugong == 135 and JLSD(10,40,pid) then
		WAR.LRHF[eid] = 10
		WAR.Person[enemyid]["特效动画"] = 98
		Set_Eff_Text(enemyid, "特效文字1", "大力金刚指・碎金断石")
	end
	
	--白万剑使用雪山剑法，有30%几率将其冻结10时序
	if match_ID(pid,43) and wugong == 35 and JLSD(20,50,pid) then
		WAR.LRHF[eid] = 10
		WAR.Person[enemyid]["特效动画"] = 116
		Set_Eff_Text(enemyid, "特效文字3", "雪花神剑")
	end
	
	--流星剑冰封
	--初始50%，6级100%
	if hurt > 0 and JY.Person[pid]["武器"] == 38 and DWPD() then
		if JLSD(0, 40 + JY.Thing[38]["装备等级"] * 10, pid) then
			JY.Person[eid]["冰封程度"] = JY.Person[eid]["冰封程度"] + 10
			if JY.Person[eid]["冰封程度"] > 100 then
				JY.Person[eid]["冰封程度"] = 100
			end
			WAR.BFXS[eid] = 1
			if WAR.Person[enemyid]["特效动画"] == -1 or WAR.Person[enemyid]["特效动画"] == 63 then
				WAR.Person[enemyid]["特效动画"] = 80
			end
			Set_Eff_Text(enemyid, "特效文字3", "霜冷剑气")
		end
	end
	
	--赵敏反震
	if match_ID(eid, 609) and DWPD() and hurt > 10 and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = 144
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		--无酒不欢：记录人物血量
		WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[pid]["生命"]
		local selfhurt = math.modf(hurt * 0.3)
		JY.Person[pid]["生命"] = JY.Person[pid]["生命"] - math.modf(selfhurt)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)-math.modf(selfhurt)
		if JY.Person[pid]["生命"] < 1 then
			JY.Person[pid]["生命"] = 1
		end
	end
	
		--赵敏反震
	if JY.Base["特殊"] ==1 and JY.Person[34]["血量翻倍"]==1 and eid==0 and DWPD() and hurt > 10 then
		WAR.Person[enemyid]["特效动画"] = 144
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		--无酒不欢：记录人物血量
		WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[pid]["生命"]
		local selfhurt = math.modf(hurt * 0.15)
		JY.Person[pid]["生命"] = JY.Person[pid]["生命"] - math.modf(selfhurt)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)-math.modf(selfhurt)
		if JY.Person[pid]["生命"] < 1 then
			JY.Person[pid]["生命"] = 1
		end
	end
	
	if match_ID(pid, 46) and DWPD() then	--丁春秋欺师灭祖
		hurt=math.modf(hurt+hurt*(60-JY.Person[0]["品德"])/120)
	end
	
	--达摩剑法
	if pid==0 and wugong==140 then
		hurt = hurt+math.modf(JY.Person[595]["声望"]/300)
	end
	if wugong == 140 and JY.Person[pid]["专2"] == 140 then
	   hurt = hurt + 120
	end   

	--达摩祖师达摩剑法化境
	if match_ID(pid, 652) and wugong==140 then
		hurt = hurt+150
	end
	
	--扫地僧慈悲刀法
	if match_ID(pid, 114) and wugong==57 then
		if inteam(pid) then
		hurt = hurt+JY.Person[0]["品德"]
		else
		hurt = hurt+(120-JY.Person[0]["品德"])
		end
	end
	
	--无酒不欢 功德无量
	if JY.Base["特殊"] ==1 and JY.Person[27]["血量翻倍"]==1 and pid==0 then
		hurt = hurt+math.modf(JY.Person[0]["品德"]/2)
	end
  
	--软猬甲减伤20点，被拳指系武功攻击，会给攻击方强制上10点流血
	--闪避不会触发软猬甲
	if JY.Person[eid]["防具"] == 58 and hurt > 50 and DWPD() then
		local hurt_reduction = 20 + 2 * (JY.Thing[58]["装备等级"]-1)
		hurt = hurt - hurt_reduction
		--触发软猬甲之后至少留1血
		if hurt < 1 then
			hurt = 1
		end
		
		if WGLX == 1 or WGLX == 2 then
			WAR.LXXS[pid] = 1
			if WAR.LXZT[pid] == nil then
				WAR.LXZT[pid] = 10
			else
				WAR.LXZT[pid] = WAR.LXZT[pid] + 10
			end
			if WAR.LXZT[pid] > 100 then
				WAR.LXZT[pid] = 100
			end
			Set_Eff_Text(enemyid, "特效文字3", "软猬甲尖刺伤拳")
		end
	end

	--龙象+瑜伽，50%概率减伤48点	
	if PersonKF(eid, 103) and PersonKF(eid, 169) and hurt > 50 and DWPD() and JLSD(20,70,eid) and WAR.JESS[eid] == nil then
		hurt = hurt-48
		Set_Eff_Text(enemyid, "特效文字2", "般若波若密")
	end
	if match_ID(eid, 134) then
	   hurt = math.modf(hurt*(90-math.random(40))/100)
	   Set_Eff_Text(enemyid, "特效文字1", "铁布衫")
	end
	
	if JY.Person[eid]["地8"] == 6 then
	local WL = get_skill_power(pid, wugong, level)
	if WL > 1800 then
	   WL = 1800
	end   
	   local r = 0.6 * WL/1800
	   hurt = math.modf(hurt * (1-r))
	end
	
	if WAR.MXD[pid] ~= nil and JY.Wugong[wugong]["武功类型"] == 4 then
	   hurt = hurt + math.modf(get_skill_power(pid, wugong, 11)*0.15)
	   if wugong == 217 then
	      hurt = hurt + 200
	   end
	end
	
	--北斗神拳
	if WAR.BDSQ == 2 and WAR.FXDS[eid] ~= nil then
	   hurt = hurt + WAR.FXDS[eid]*30
	end
	
	if match_ID(pid, 677) and JY.Person[677]["阶"] >= 3 and wugong == 214 and DWPD() then
	   hurt = hurt + math.modf((JY.Person[eid]["生命最大值"]-JY.Person[eid]["生命"])*0.6)
	end
	
	--舍命
	if JY.Person[pid]["地5"] == 4 then
	local dam = math.modf((JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])*0.3)
	   hurt = hurt + dam
	end
	if JY.Person[pid]["武器"] == 360 and JY.Person[eid]["冰封程度"] ~= nil then
	   hurt = hurt + JY.Person[eid]["冰封程度"]
	   if tg ~= 1 then
	      if fx < 0 then
		     hurt = hurt - fx*10
	      end
	   else
		     hurt = hurt - yin*10
	   end
	end
	
	if JY.Person[pid]["人2"] == 1 and DWPD() then
	   hurt = hurt + 30
	end
	
	if (WAR.LIBAI == 6 or WAR.LIBAI == 13 or WAR.LIBAI == 14) and DWPD() then
	   hurt = hurt + 300
	end
	if WAR.LIBAI == 18 and DWPD() then
	   hurt = hurt + 200
	end
	if WAR.LIBAI == 7 and DWPD() then
	   hurt = hurt + 500
	end
	
	if ZhiGZY(pid) > 0 then
	   hurt = hurt + ZhiGZY(pid)*20
	end
	
	if JY.Person[eid]["人30"] == 1 and DWPD() then
	   if JY.Person[pid]["冰封程度"] > 0 then
	      hurt = hurt - 100
		  if hurt < 1 then
		     hurt = 1
		  end
	   end
	end
	
	if JY.Person[pid]["人30"] == 1 and DWPD() then
	   if JY.Person[eid]["灼烧程度"] > 0 then
	      hurt = hurt + 100
	   end
	end
	
	if JY.Person[pid]["人9"] == 1 and DWPD() then
	   hurt = hurt + math.modf((JY.Person[eid]["生命最大值"]-JY.Person[eid]["生命"])*0.05)
	end
	if JY.Person[pid]["人33"] == 1 and DWPD() then
	   hurt = hurt + 100
	end
	if JY.Person[pid]["人31"] == 1 and DWPD() then
	   hurt = hurt + WAR.SXTJ
	end
	if JY.Person[638]["声望"] >= 6 and match_ID(pid, 638) and DWPD() then
	   hurt = hurt + WAR.SXTJ
	end
	
	if JY.Person[10]["阶"] >= 3 then
	    local n = 0
	        for i = 1, JY.Person[671]["品德"] do
				if JY.Person[pid]["武功等级" .. i] == 999 then
					n = n + 1
				end
			end
		if match_ID(pid, 10) and DWPD() then
		hurt = hurt + n*20
		end
		if match_ID(eid, 10) then
		hurt = hurt - n*20
		if hurt < 1 then
		hurt = 1
		end
		end
	end		
	
	--杨康的杨家枪法，增加伤害和气攻
	if match_ID_awakened(pid, 650, 1) and wugong == 68 and DWPD() then
		JY.Person[650]["声望"] = JY.Person[650]["声望"] + 1
		if JY.Person[650]["声望"]>2000 then
			JY.Person[650]["声望"]=2000
		end
		hurt = hurt + JY.Person[650]["声望"]
	end
	--段思平一阳指
	if match_ID(pid, 687) and wugong == 17 then
		JY.Person[687]["声望"] = JY.Person[687]["声望"] + math.random(3)+1
		if JY.Person[687]["声望"]>1000 then
			JY.Person[687]["声望"]=1000
		end
	end
	--yunshijian
	if wugong == 222 and (WAR.YSJZS == 1 or WAR.YSJZS == 4) then
	   hurt = hurt + 200
	   if WAR.YSJZS == 4 then
	      hurt = math.modf(hurt*1.35)
	   end
	end
	--烈火剑法
	if wugong == 176 and JY.Person[pid]["专2"] == 176 and WAR.JHLY[eid] ~= nil then
	   hurt = hurt + WAR.JHLY[eid]*5
	end
	--无相劫指
	if wugong == 136 and JY.Person[pid]["专2"] == 136 and DWPD() then
	   hurt = hurt + 200
	end	
	--豪鬼，拳法追加伤害
	if match_ID(pid, 673) and JY.Wugong[wugong]["武功类型"] == 1 and DWPD() then
	   hurt = hurt + math.modf(get_skill_power(pid, wugong, 11)*0.1)
	end
	if JY.Person[pid]["武器"] == 346 then
	   hurt = hurt + math.modf(JY.Person[eid]["生命"]*0.01*(JY.Thing[346]["装备等级"]+3))
	end 
	if wugong == 210 then
	   hurt = hurt + math.modf(JY.Person[eid]["生命"]*0.05)
	end
	if PersonKF(pid, 213) then
		hurt = hurt + math.modf(JY.Person[pid]["御剑能力"]*0.3)
	end
	
	if match_ID(pid, 689) and JY.Person[690]["天2"] == 2 then
	local add = math.modf(get_skill_power(pid, wugong, 11)/4)
	   if add > 400 then
	   add = 400
	   end   
	   hurt = hurt + add
	end
	if JY.Person[pid]["防具"] == 369 then
	local add = math.modf(get_skill_power(pid, wugong, 11)/5)
	   if add > 300 then
	   add = 300
	   end   
	   hurt = hurt + add
	end
	
	--复仇之心
	if match_ID(pid, 36) and WAR.FCZX[pid] == eid then
	   hurt = math.modf(hurt*1.5)
	end
	if JY.Person[pid]["地8"] == 5 and JY.Person[pid]["武器"] > 0 and JY.Person[pid]["防具"] > 0 then
	   hurt = hurt + 180
	end
	if JY.Person[eid]["地8"] == 5 and JY.Person[eid]["武器"] > 0 and JY.Person[eid]["防具"] > 0 then
	   hurt = hurt - 180
	   if hurt < 1 then
	      hurt = 1
	   end	  
	end
	
	--步惊云
	if match_ID(pid, 682) and hurt < 250 then
	   hurt = 250
	end
	--dfbb
	if match_ID(pid, 27) and JY.Person[27]["阶"] >= 3 and hurt < 200 then
	   hurt = 200
	end
	--李秋水
	if match_ID(pid, 118) and JY.Person[118]["阶"] >= 3 and hurt < math.modf(JY.Person[eid]["生命最大值"]*0.15) then
	   hurt = math.modf(JY.Person[eid]["生命最大值"]*0.1)
	end
	
	--论剑打赢扫地
	if eid == 0 and JY.Person[114]["论剑奖励"] == 1 then
		hurt = math.modf(hurt*0.8)
	end
	if JY.Person[eid]["人14"] == 1 then
	   hurt = math.modf(hurt*0.88)
	end
	if JY.Person[eid]["人19"] == 1 then
	   hurt = hurt - 50
	   if hurt < 1 then
	      hurt = 1
	   end
	end
	
	if not inteam(pid) then
	local x = 1 + JY.Person[0]["感悟点"]*0.00007+JY.Base["难度"]*0.01
	   hurt = math.modf(hurt*x)
	end
	
	if not inteam(eid) then
	local x = 1 - JY.Person[0]["感悟点"]*0.00007-JY.Base["难度"]*0.01
	   hurt = math.modf(hurt*x)
	end
	
	if match_ID(eid, 634) and JY.Person[634]["天4"] == 2 and math.random(100) <= 10 then
	   if hurt > 499 then
	   hurt = 499 + math.modf((hurt - 499)^0.98)
	    if hurt > 999 then
		   hurt = 999 + math.modf((hurt - 999)^0.9)
		   if hurt > 1999 then
		      hurt = 1999 + math.modf((hurt - 1999)^0.95)
		   end
		end
	   end
	   hurt = -hurt
	   WAR.Person[enemyid]["特效动画"] = 147
	   Set_Eff_Text(enemyid, "特效文字1", "鹏游蝶梦")
	end

	--最终伤害
	if match_ID(pid, 671) and JY.Person[671]["阶"] >= 2 and DWPD() then
	hurt = hurt+math.modf(TrueYJ(pid)*0.2)
	end
	
	if (JY.Base["标准"] == 1 and pid == 0) and JY.Wugong[wugong]["武功类型"] == 1 and JY.Person[0]["阶"] >= 1 and DWPD() then
       hurt = hurt+100
	   if JY.Person[0]["阶"] >= 2 and WAR.LXZQ == 1 then
	      hurt = math.modf(hurt*1.5)
	   end
	   if JY.Person[0]["阶"] >= 3 then
	      hurt = hurt + hurt*math.modf(2*(JY.Person[eid]["生命最大值"] - JY.Person[eid]["生命"])/JY.Person[eid]["生命最大值"])
	   end
    end
	if WAR.ZJDbuff[pid] ~= nil then
	   hurt = math.modf(hurt*0.8)
	end
	if WAR.ZJbuff[pid] ~= nil then
	   hurt = math.modf(hurt*1.2)
	end
	if (JY.Base["标准"] == 2 and pid == 0) and JY.Wugong[wugong]["武功类型"] == 2 and JY.Person[0]["阶"] >= 3 and DWPD() then
       local jl = 5 + JY.Base["天书数量"]
	   jl = jl + math.modf(10*(JY.Person[eid]["生命最大值"] - JY.Person[eid]["生命"])/JY.Person[eid]["生命最大值"])
	   if math.random(100) <= jl then
	      hurt = hurt*5
		  if hurt < 600 then
		     hurt = 600
		  end
		  Set_Eff_Text(enemyid, "特效文字1", "点中死穴")
	   end
    end
	if match_ID(pid, 129) and JY.Person[129]["阶"] >= 3 and WAR.BDQS > 0 and DWPD() then
       hurt = hurt*2
    end
	if wugong == 13 and match_ID(pid, 67) and JY.Person[67]["阶"] >= 3 and DWPD() then
       hurt = hurt + 240
    end
	if match_ID(pid, 164) and JY.Person[164]["阶"] >= 3 and DWPD() then
       hurt = hurt + math.modf(JY.Person[pid]["内力"]*0.05)
    end
	
	if match_ID(pid, 420) and JY.Person[420]["阶"] >= 3 and DWPD() then
       hurt = hurt + math.modf(JY.Person[pid]["生命"]*0.05)
    end
	--温青青
	if match_ID(pid, 91) and JY.Person[91]["阶"] >= 1 and DWPD() then
	   if WAR.BJ == 1 then
	      hurt = hurt + math.modf(JY.Person[eid]["生命最大值"]*math.random(5,20)*0.01)
	   end
    end
	if match_ID(pid, 90) and JY.Person[90]["阶"] >= 2 and DWPD() then
       hurt = hurt + 100
    end
	
	if wugong == 11 and match_ID(pid, 78) and JY.Person[78]["阶"] >= 1 and DWPD() then
       hurt = hurt + 200
	   if JY.Person[78]["阶"] >= 3 and JY.Person[eid]["生命"] < JY.Person[eid]["生命最大值"]*0.25 then
	      hurt = hurt + 2000
	   end
    end
	if match_ID(pid, 54) and JY.Person[54]["阶"] >= 1 and WAR.JSAY == 1 then
	   hurt = hurt + 100
	   if JY.Person[54]["阶"] >= 2 then
	      hurt = hurt + 200
	   end
	end
	
	--iron fist
	--skill--lotus whip,dragon's touch,surging fist,dragon tail,crescent heel,twin snake,rising fang*,wall of kun-lun*,iron rage**,volcanic roar**,dragon's prey***
	if match_ID(pid, 693) and DWPD() then
	hurt = hurt + math.modf(get_skill_power(pid, wugong, 11)*0.07)
	   if JY.Person[693]["天4"] == 2 then
	      hurt = hurt + math.modf(JY.Person[eid]["生命最大值"]*0.06)
	   end
	   if wugong == 251 then
	      hurt = hurt + math.modf(get_skill_power(pid, wugong, 11)*0.07)
	   end
	   hurt = math.modf(hurt*((WAR.TQLJ + WAR.TQLJ2)*0.15 + 1))
	   if wugong == 252 then
	   local d = 0.12
	   if JY.Person[693]["天3"] == 3 then
	      d = 0.25
	   end
	      hurt = hurt + math.modf(JY.Person[eid]["生命最大值"]*d)
		  WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)+math.modf(JY.Person[eid]["生命最大值"]*d)
		  AddPersonAttrib(pid, "生命", math.modf(JY.Person[eid]["生命最大值"]*d))
		  JY.Person[eid]["主运内功"] = 0
	   end
	end
	
	--龙牧
	if match_ID(pid, 39) and JY.Person[39]["阶"] >= 1 and DWPD() then
	   hurt = hurt + 120
	end
	if match_ID(pid, 77) and JY.Person[77]["阶"] >= 2 and DWPD() then
	   hurt = hurt + 200
	end
	if match_ID(eid, 77) and JY.Person[77]["阶"] >= 3 and DWPD() then
	   hurt = hurt - 200
	   if hurt < 1 then
	      hurt = 1
	   end
	end
	
	--丁春秋
	if match_ID(pid, 46) and JY.Person[46]["阶"] >= 3 and JY.Person[0]["品德"] == 0 then
	   hurt = math.modf(hurt*1.4)
	end
	
	if JY.Person[pid]["人10"] == 1 and DWPD() then
	   hurt = math.modf(hurt*1.25)
	end
	
	if JY.Person[pid]["地4"] == 3 or (match_ID(pid, 147) and JY.Person[147]["阶"] >= 1) or (
	(match_ID(pid, 143) or match_ID(pid, 144) or match_ID(pid, 145) or match_ID(pid, 146) or match_ID(pid, 147) or match_ID(pid, 148)) and JY.Person[147]["阶"] >= 3
	) then
	local n = 1
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				n = n + 1
			end
		end
		hurt = math.modf(hurt*(1+n*0.07))
	end
	
	if (JY.Base["标准"] == 4 and eid == 0) and JY.Person[0]["阶"] >= 2 then
       hurt = math.modf(hurt*0.8)
    end
	
	if match_ID(eid, 90) and JY.Person[90]["阶"] >= 3 then
       hurt = math.modf(hurt*0.8)
    end
	if match_ID(eid, 50) and JY.Person[50]["阶"] >= 2 then
	   hurt = math.modf(hurt*0.75)
	end
	if match_ID(pid, 50) and JY.Person[50]["阶"] >= 3 and DWPD() then
	   hurt = hurt + WAR.SXTJ*10
	end
	
	if match_ID(eid, 63) and JY.Person[63]["阶"] >= 2 and JY.Person[eid]["生命"] < JY.Person[eid]["生命最大值"]*0.5 then
	   hurt = math.modf(hurt*0.5)
	end
	
	if match_ID(eid, 112) and JY.Person[112]["阶"] >= 1 then
	   hurt = math.modf(hurt*0.9)
	end
	if match_ID(eid, 113) and JY.Person[113]["阶"] >= 3 then
	   hurt = math.modf(hurt*0.8)
	end
	
	if match_ID(eid, 40) and JY.Person[40]["阶"] >= 1 then
	   hurt = hurt - 120
	   if hurt < 1 then
	      hurt = 1
	   end
	end
	if match_ID(eid, 114) and JY.Person[114]["阶"] >= 1 then
	   hurt = hurt - 100
	   if hurt < 1 then
	      hurt = 1
	   end
	end
	if match_ID(eid, 70) and JY.Person[70]["阶"] >= 3 then
	   hurt = hurt - 300
	   if hurt < 1 then
	      hurt = 1
	   end
	end
	if match_ID(eid, 671) and JY.Person[671]["阶"] >= 3 and WAR.WMCS[eid] == 1 then
	hurt = hurt-math.modf(TrueYJ(pid)*0.1)
	if hurt < 1 then
	      hurt = 1
	   end
	end
	--童姥
	if match_ID(eid, 117) and JY.Person[117]["阶"] >= 3 then
	   if hurt > JY.Person[eid]["生命最大值"]*0.15 then
	      hurt = math.modf(JY.Person[eid]["生命最大值"]*0.15)
	   end
	end
	if JY.Base["标准"] == 7 and eid == 0 and JY.Person[0]["阶"] >= 1 then
	   if hurt > JY.Person[eid]["生命"]*0.2 + 200 then
	      hurt = JY.Person[eid]["生命"]*0.2 + 200
	   end
	end
	--dx
	if match_ID(eid, 21) and JY.Person[21]["阶"] >= 3 then
	   hurt = math.modf(hurt*0.65)
	end
	
	if match_ID(pid, 114) and JY.Person[114]["阶"] >= 3 and DWPD() then
	   local j = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[enemyid]["坐标X"]) + math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[enemyid]["坐标Y"])
	   if j <= 2 then
	      hurt = hurt*3
	   end
	end
	
	--达尔巴
	if match_ID(pid, 160) and JY.Person[160]["阶"] >= 2 then
	   hurt = math.modf(hurt*1.3)
	end
	if match_ID(eid, 160) and JY.Person[160]["阶"] >= 2 then
	   hurt = math.modf(hurt*0.7)
	   if JY.Person[160]["阶"] >= 3 then
	      hurt = math.modf(hurt*0.6)
	   end
	end
	
	if match_ID(eid, 693) then
	   hurt = math.modf(hurt*0.8)
	end
	
	if match_ID(eid, 48) and JY.Person[48]["阶"] >= 1 then
	   hurt = hurt*0.8
	   if JY.Person[48]["阶"] >= 2 then
	   hurt = hurt - 200
	   if hurt < 1 then
	      hurt = 1
	   end
	   end
	   hurt = math.modf(hurt)
	   if JY.Person[48]["阶"] >= 3 then
		  WAR.YTZ[eid] = 1
	   end
	end
	--宋远桥
	if match_ID(eid, 171) and JY.Person[171]["阶"] >= 2 and WAR.Defup[eid] == 1 then
	   if WAR.SYQ[eid] == nil then
	      WAR.SYQ[eid] = 1
	   else
	      WAR.SYQ[eid] = WAR.SYQ[eid] + 1
	   end	  
	   hurt = math.modf(hurt*0.9^WAR.SYQ[eid])
	end
	
	--宋远桥
	if match_ID(pid, 171) and WAR.Defup[pid] == nil then
	   WAR.SYQ[pid] = nil
	end
	
	if match_ID(eid, 693) and JY.Person[693]["天4"] == 1 then
	local h = math.modf(JY.Person[eid]["生命最大值"]*0.15)
	   if hurt > h then
	   local r = hurt - h
	   if r > h then
	      r = h
	   end
	      hurt = h
		  WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+r
		  AddPersonAttrib(eid, "生命", r)
	   end
	end
	
	--kael
	if match_ID(pid, 689) and wugong > 225 and wugong < 336 then
	   hurt = hurt + math.modf(get_skill_power(pid, wugong, 11)/6)
	end
	
	if SanhuaJD(eid) then
	hurt = math.modf(hurt*0.8)
	   if hurt > 666 then
	      hurt = 666
	   end
	end
	
	if wugong == 238 or wugong == 232 then
	hurt = hurt + 200
	   if wugong == 238 then
	   hurt = hurt + 2^JY.Person[689]["天3"]
	   end
	end
	
	if match_ID(eid, 689) and JY.Person[689]["阶"] >= 1 then
	local n = math.ceil(JY.Person[eid]["防御力"]*0.03 + JY.Person[eid]["内力最大值"]*0.002)
    if JY.Person[690]["天1"] == 2 then
	n = n + 15
	end
	hurt = math.modf(hurt*(1-0.06*n/(1+0.06*n)))
	end
	
	if wugong == 223 then
	   hurt = -9999
	end
	--死亡
	if JY.Person[pid]["生命"] < 0 then
		JY.Person[pid]["生命"] = 0
	end
  
	--误伤打到自己人
	if (WAR.Person[WAR.CurID]["我方"] == WAR.Person[enemyid]["我方"]) or match_ID(eid, 135) --[[or (match_ID(pid,9) and math.random(100) > 50 and inteam(pid))]] and WAR.LZ_L[pid] == nil then
	    if (WAR.JYSH == 1 and WAR.LQZ[pid] == 100) or match_ID(eid, 135) then 	--九阴摄魂误伤
			hurt = math.modf(hurt * 1.3) + Rnd(3)
		else
			--我方
			if WAR.Person[WAR.CurID]["我方"] then
				--水笙误伤加血
				if match_ID(pid, 589) or match_ID(pid, 686) then
					hurt = -(math.modf(hurt) + Rnd(3))
				--其他人误伤30%
				else
					hurt = math.modf(hurt * 0.3) + Rnd(3)
				end
			--NPC，误伤=20%
			else
				--倾国反弹100%
				if WAR.NZQK == 3 then
				
				--触发逆转乾坤，NPC误伤提高至50%
				elseif match_ID(eid, 135) then
					hurt = math.modf(hurt * 0.8) + Rnd(3)
				elseif WAR.NZQK == 0 then
					hurt = math.modf(hurt * 0.2) + Rnd(3)
				else
					hurt = math.modf(hurt * 0.5) + Rnd(3)
				end
			end
		end
	end
	if JY.Person[pid]["专2"] == 997 and WAR.DZXY == 1 then
	   WAR.WGJY[eid] = wugong
	   if WAR.WGJY2[eid] == 1 and WAR.WGJY3[eid] == wugong then
	      WAR.WGJY2[eid] = 2
	   end	  
	end
	--寒冰绵掌，九阴白骨爪，幻阴指，七伤拳，黯然销魂掌，玄铁剑法，六脉神剑，分筋错骨手，冰蚕毒掌，凝血神爪，五轮大转，烈火剑法，剑血浮生，摧心掌，碧针清掌，中华傲决，急速冷却
	if wugong == 5 or wugong == 11 or wugong == 19 or wugong == 23 or wugong == 45 or wugong == 25 or wugong == 17 
	or wugong == 49 or wugong == 117 or wugong == 21 or wugong == 134 or wugong == 158 or wugong == 176 or wugong == 35 or wugong == 86
	or wugong == 200 or wugong == 201 or wugong == 206 or wugong == 213 or wugong == 140 or wugong == 64 or wugong == 226 then
	local jl = hurt + 100
	if jl > 800 then
	   jl = 800
	end
	if wugong == 213 or wugong == 200 or wugong == 206 then
	   jl = jl + 500	
	end
	if wugong == 226 then
	   jl = 1500	
	end
	if math.random(1600) <= jl then
	   for i = 1, 16 do
	   local x = JY.Person[eid]["武功"..i]
	       if KungfuCD(eid, x) > 0 then
		      if WAR.KungfuLQ[eid][x] == nil then
			     WAR.KungfuLQ[eid][x] = 1
			  else
			     WAR.KungfuLQ[eid][x] = WAR.KungfuLQ[eid][x] + 1
				 if WAR.KungfuLQ[eid][x] > KungfuCD(eid, x) then
				    WAR.KungfuLQ[eid][x] = KungfuCD(eid, x)
			     end		
			  end
			WAR.Person[enemyid]["特效文字6"] = "冷却提高"
		    WAR.Person[enemyid]["特效动画"] = 121  
		   end
	   end
	end
	end
	--被攻击减少cd
	--太极拳
	if hurt > 100 and DWPD() then
	local wg = {16,25,46,95,96,97,106,138,171}
	  for i = 1, #wg do
	  if WAR.KungfuLQ[eid][wg[i]] ~= nil then
	  WAR.KungfuLQ[eid][wg[i]] = WAR.KungfuLQ[eid][wg[i]] - 1
	    if WAR.KungfuLQ[eid][wg[i]] <= 0 then
	     WAR.KungfuLQ[eid][wg[i]] = nil
	    end   
	  end
	  end
	
	end

	
	--无酒不欢：伤害的结算到此为止，扣除被攻击方血量
	if hurt > 499 then
	   hurt = 499 + math.modf((hurt - 499)^0.98)
	    if hurt > 999 then
		   hurt = 999 + math.modf((hurt - 999)^0.9)
		   if hurt > 1999 then
		      hurt = 1999 + math.modf((hurt - 1999)^0.95)
		   end
		end
	end
	
	if match_ID(pid, 28) and JY.Person[28]["阶"] >= 3 and WAR.JYSY[pid] ~= nil and DWPD() then
	   hurt = hurt + WAR.JYSY[pid]
	   WAR.JYSY[pid] = nil
	end
	
	if match_ID(pid, 52) and wugong == 241 and JY.Person[52]["阶"] >= 3 then
	   if hurt < 1000 then
	      hurt = 1000
	   end
	end
	
	--林月如乾坤一掷
	if WAR.QKYZ == 1 and match_ID(pid,657) then	
			hurt = 1999
			WAR.QKYZ = 0
	end
	
	--狄云赤心连城追加连击
	if match_ID(pid, 37) and pid == 0 and hurt < 200 and DWPD() then
		WAR.CXLC = 1
	end
	
	if match_ID(eid, 52) and JY.Person[52]["阶"] >= 2 and math.random(100) < 51 then
	   hurt = math.modf(hurt*0.001)
	   WAR.Person[enemyid]["特效文字2"] = "金钢之躯"
	   WAR.Person[enemyid]["特效动画"] = 87
	end
	
	--林平之觉醒后，根据伤害回气
	if match_ID_awakened(pid, 36, 1) then
		WAR.LPZ = hurt/2
		if WAR.LPZ > 400 then
			WAR.LPZ = 400
		end
	end
	--无想流舞
	if match_ID(pid, 686) and JY.Person[686]["天2"] == 2 then
		WAR.WXLW = math.modf(hurt*0.6)
		if WAR.WXLW > 500 then
			WAR.WXLW = 500
		end
	end
	
	--石破天觉醒后，有30%几率挨打回血
	if (match_ID_awakened(eid, 38, 1) and DWPD() and math.random(10) < 4) or (match_ID(eid, 636) and DWPD() and math.random(10) < 4) or (Curr_NG(eid, 102) and DWPD() and math.random(100) < 9 and JY.Person[7]["血量翻倍"] == 1) and WAR.JESS[eid] == nil and WAR.ALH == 0 then
		hurt = -math.modf(hurt/2)
		WAR.Person[enemyid]["特效文字2"] = "混沦太玄"
		WAR.Person[enemyid]["特效动画"] = 147
	end

	--天地玄黄，穆人清自带
	if (TiandiXH(eid) or match_ID(eid,185)) and DWPD() and math.random(200) < 11 and WAR.JESS[eid] == nil then
		hurt = -math.modf(hurt/2)
		WAR.Person[enemyid]["特效文字5"] = "天地玄黄・玄"
		WAR.Person[enemyid]["特效动画"] = 145
	end		
	
	--宁中则有15%几率挨打回血
	if match_ID(eid, 649) and DWPD() and math.random(100) < 16 and WAR.JESS[eid] == nil then
		hurt = -math.modf(hurt/2)
		WAR.Person[enemyid]["特效文字3"] = "鲸吞镇海杵"
		WAR.Person[enemyid]["特效动画"] = 143
	end
	
	JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - hurt
	
	if JY.Person[eid]["生命"] > JY.Person[eid]["生命最大值"] then
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
	end

	--太极拳，挨打蓄力
	if PersonKF(eid, 16) and WAR.JESS[eid] == nil then
		if WAR.tmp[3000 + eid] == nil then
			WAR.tmp[3000 + eid] = 0
		end
		WAR.tmp[3000 + eid] = WAR.tmp[3000 + eid] + hurt;
		--上限1080
		if WAR.tmp[3000 + eid] > 1080 then
			WAR.tmp[3000 + eid] = 1080
		end
	end
	
	--太极剑，挨打蓄力
	if PersonKF(eid, 46) and PersonKF(eid, 16) == false and WAR.JESS[eid] == nil then
		if WAR.tmp[3000 + eid] == nil then
			WAR.tmp[3000 + eid] = 0
		end
		WAR.tmp[3000 + eid] = WAR.tmp[3000 + eid] + hurt;
		--上限1080
		if WAR.tmp[3000 + eid] > 1080 then
			WAR.tmp[3000 + eid] = 1080
		end
	end
	

	
	--参和指，挨打蓄力
	if PersonKF(eid,138) and WAR.DZXYCS<5 and WAR.JESS[eid] == nil then
		WAR.DZXYCS=WAR.DZXYCS+1
		if WAR.tmp[7000 + eid] == nil then
			WAR.tmp[7000 + eid] = 0
		end
		WAR.tmp[7000 + eid] = WAR.tmp[7000 + eid] + 1;
		--上限2016
		if WAR.tmp[7000 + eid] > 10 then
			WAR.tmp[7000 + eid] = 10
		end
	end
  
	--获取得经验
	WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + math.modf((hurt) / 5)
	
	--装备获取经验
	if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.ZDDH ~= 226 then
		--武器获取经验
		if JY.Person[pid]["武器"] ~= - 1 then
			JY.Thing[JY.Person[pid]["武器"]]["装备经验"] = JY.Thing[JY.Person[pid]["武器"]]["装备经验"] + 5
			if JY.Thing[JY.Person[pid]["武器"]]["装备经验"] > 100 and JY.Thing[JY.Person[pid]["武器"]]["装备等级"] < 6 then
				JY.Thing[JY.Person[pid]["武器"]]["装备经验"] = 0
				JY.Thing[JY.Person[pid]["武器"]]["装备等级"] = JY.Thing[JY.Person[pid]["武器"]]["装备等级"] + 1
			end
		end
		--防具获取经验
		if JY.Person[eid]["防具"] ~= - 1 then
			JY.Thing[JY.Person[eid]["防具"]]["装备经验"] = JY.Thing[JY.Person[eid]["防具"]]["装备经验"] + 5
			if JY.Thing[JY.Person[eid]["防具"]]["装备经验"] > 100 and JY.Thing[JY.Person[eid]["防具"]]["装备等级"] < 6 then
				JY.Thing[JY.Person[eid]["防具"]]["装备经验"] = 0
				JY.Thing[JY.Person[eid]["防具"]]["装备等级"] = JY.Thing[JY.Person[eid]["防具"]]["装备等级"] + 1
			end
		end
		--动物获取经验
		if JY.Person[eid]["动物"] ~= - 1 then
			JY.Thing[JY.Person[eid]["动物"]]["装备经验"] = JY.Thing[JY.Person[eid]["动物"]]["装备经验"] + 2
			if JY.Thing[JY.Person[eid]["动物"]]["装备经验"] > 100 and JY.Thing[JY.Person[eid]["动物"]]["装备等级"] < 6 then
				JY.Thing[JY.Person[eid]["动物"]]["装备经验"] = 0
				JY.Thing[JY.Person[eid]["动物"]]["装备等级"] = JY.Thing[JY.Person[eid]["动物"]]["装备等级"] + 1
			end
		end
		if JY.Person[pid]["动物"] ~= - 1 then
			JY.Thing[JY.Person[pid]["动物"]]["装备经验"] = JY.Thing[JY.Person[pid]["动物"]]["装备经验"] + 2
			if JY.Thing[JY.Person[pid]["动物"]]["装备经验"] > 100 and JY.Thing[JY.Person[pid]["动物"]]["装备等级"] < 6 then
				JY.Thing[JY.Person[pid]["动物"]]["装备经验"] = 0
				JY.Thing[JY.Person[pid]["动物"]]["装备等级"] = JY.Thing[JY.Person[pid]["动物"]]["装备等级"] + 1
			end
		end
	end
	
	--主角刀系，每个刀法练到极，减少受到的5%杀气
	if JY.Base["标准"] == 4 and eid == 0 then
		local askd = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 4 and JY.Person[0]["武功等级" .. i] == 999 then
				askd = askd + 1
			end
		end
		if askd > 7 then
			askd = 7
		end
		ang = math.modf(ang * (1 - 0.05 * askd))
	end
	
	--无酒不欢 傲世狂刀
	if JY.Base["特殊"] ==1 and JY.Person[19]["血量翻倍"]==1 and eid==0 then
		local askd = 5
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 4 and JY.Person[0]["武功等级" .. i] == 999 then
				askd = askd + 1
			end
		end
		ang = math.modf(ang * (1 - 0.05 * askd))
	end
	
	--灵犀一指
	if WAR.LXYZF == 1 then
		ang = 0
	end
	
	
	if WAR.HLJS == 1 then
	   ang = math.modf(ang/2)
	end
	
	--两仪守护降低320点气攻
	if WAR.LYSH == 3 then
		ang = ang - 320
		if ang < 0 then
			ang = 0
		end
	elseif WAR.LYSH == 4 then 
		ang = ang - 640
		if ang < 0 then
			ang = 0
		end
	end
	WAR.LYSH = 0
	WAR.HLJS = 0
	
	--计算是否破气防，dng为0表示被破气防
	--唯快不破
	if WAR.WKBP == 1 then
		dng = math.modf(dng*0.3)
	end
	ang = ang - dng
	if 0 < ang then
		dng = 0
	else
		dng = -ang
		ang = 0
	end
	
	--东方不败，葵花秘法・化凤为凰免疫杀气
	if match_ID(eid, 27) and WAR.LQZ[eid] == 100 and WAR.JESS[eid] == nil then
		dng = 1
	end
	
	if match_ID(eid, 160) and JY.Person[160]["阶"] >= 3 then
		dng = 1
	end
	
	--豪鬼，怒
	if match_ID(eid, 673) and JY.Person[673]["外号2"] == "怒" and WAR.SYBD[eid] ~= nil then
	   dng = 1
	end 
	
	if match_ID(eid, 681) and WAR.MXD[eid] ~= nil then
	   dng = 1
	end 
	
	if match_ID(eid, 672) and JY.Person[672]["阶"] >= 3 then
		dng = 1	
	end
  
	--扫地  免杀气
	if match_ID(eid, 114) and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效文字2"] = "天地独尊"
		WAR.Person[enemyid]["特效动画"] = 39
		dng = 1
	end
	
	if match_ID(eid, 46) and JY.Person[0]["品德"] == 0 and JY.Person[46]["阶"] >= 3 then
		WAR.Person[enemyid]["特效文字2"] = "星河真气"
		WAR.Person[enemyid]["特效动画"] = 98
		dng = 1	
	end
	
	--瑜伽密乘
	if Curr_NG(eid, 169) and JY.Person[eid]["专2"] == 169 then
		WAR.Person[enemyid]["特效动画"] = 39
		dng = 1
	end
	
	--文泰来暴怒免杀气
	if match_ID(eid, 151) and WAR.LQZ[eid] == 100 and WAR.JESS[eid] == nil then
		dng = 1
	end
	
	--狄云
	if match_ID(eid, 37) and Curr_NG(eid, 94) and WAR.JESS[eid] == nil then
		Set_Eff_Text(enemyid,"特效文字1","真名神照");
		WAR.Person[enemyid]["特效动画"] = 89
		dng = 1
	end
	
	--中华傲诀
	if Curr_NG(eid, 213) and WAR.JESS[eid] == nil then
		dng = 1
	end
	
	--盖世无双，50%几率免内伤，免杀气
	
	if GaiSWS(eid) and JLSD(20, 70, eid) and match_ID(eid, 459) == false then
		dng = 1
		WAR.Person[enemyid]["特效动画"] = 10
		Set_Eff_Text(enemyid,"特效文字1","盖世无双")
	end
  
	--伤害小于等于30 免内伤，免杀气 
	if hurt <= 30 then
		dng = 1
	end
	
	--真太奥免疫杀气
	if WAR.TJAY == 4 then
		dng = 1
	end
	WAR.TJAY = 0
  
	--刀系大招，忽视绝对气防
	if WAR.ASKD == 1 then
		dng = 0
	end
	
	--无量・极
	if WAR.WLJ == 1 then
	   dng = 0
	end
	
	if WAR.PLKD == 1 then
	   dng = 0
	end   
	--无名，名不虚传
	if wugong == 199 and match_ID(pid, 671) and WAR.MMZS == 8 then
	   dng = 0
	end
	
	--大力
	if wugong == 22 and JY.Person[pid]["专2"] == 22 then
	   dng = 0
	end
	
	if wugong == 83 and JY.Person[pid]["专2"] == 83 then
	   dng = 0
	end
	
	if wugong == 135 and JY.Person[pid]["专2"] == 135 then
	   dng = 0
	end
	
	if wugong == 83 and JY.Person[pid]["专2"] == 83 then
	   dng = 0
	end
	
	if match_ID(pid, 693) and JY.Person[693]["天4"] == 2 then
	   dng = 0
	end 
	
	if match_ID(pid, 3) and wugong == 44 and JY.Person[pid]["阶"] >= 3 then
	   dng = 0
	end	
	
	--雷震，浊浪排空
	if WAR.ZLPK == 2 then
	   dng = 0
	end

	--天罡大招，忽视绝对气防
	if WAR.JSTG == 1 then
		dng = 0
	end
	
	--拳王大招，忽视绝对气防
	if WAR.LXZQ == 1 then
		dng = 0
	end
	
	--破尽天下，忽视绝对气防
	if WAR.PJTX == 1 then
		dng = 0
	end
	
	--五岳剑法+五岳剑诀，忽视绝对气防
	if WAR.ZWYJF == 1 then
		dng = 0
	end
	
	--李文秀14书，特效忽视绝对气防
	if WAR.LWX == 1 then
		dng = 0
	end
	
	--郭靖降龙后劲超过11道，忽视绝对气防
	if WAR.YYBJ > 11 then
		dng = 0
	end

	--乔峰见龙在田，忽视绝对气防
	if WAR.QFBGM==1 then
		dng = 0
	end
	
	--龙象之力暴怒，忽视绝对气防
	if WAR.LXZL10 == 1 then
		dng = 0
	end
	
	--忽视绝对气防
	if WAR.LXYZG == 1 then
		dng = 0
	end
	
	--螺旋九影，忽视绝对气防
	if Curr_QG(pid,181) then
		dng = 0
	end
	--少商剑
	if match_ID(pid, 687) and wugong == 49 and WAR.LMZS == 6 then
	   dng = 0
	end   
	
	if wugong == 232 or wugong == 238 then
	   dng = 0
	end 
	
	if match_ID(pid, 52) and wugong == 70 and JY.Person[pid]["六如觉醒"] >= 6 then
	   dng = 0
	end
	
	if match_ID(pid, 106) and wugong == 59 and JY.Person[106]["阶"] >= 3 then
	   dng = 0
	end

	--太玄之轻40%几率
	if ((Curr_NG(eid, 102) and JLSD(20, 60, eid)) 
	or (PersonKF(eid, 102) and JY.Person[eid]["专2"] == 102 and JLSD(20, 40, eid))
	or (Curr_NG(eid, 102) and match_ID(eid, 38) and JY.Person[38]["阶"] >= 3))
	and WAR.JESS[eid] == nil then
		WAR.TXZQ[eid] = 1
	end
	
	if match_ID(eid, 681) and WAR.LQZ[eid] == 100 and WAR.JESS[eid] == nil then
	   dng = 1
	end
	
	--逍遥御风累积9点，未行动前不会被杀气
	if WAR.XYYF[eid] and WAR.XYYF[eid] == 11 and WAR.JESS[eid] == nil then
		dng = 1
	end
	
	
	
	--破气防后内伤计算
	--毒王大招不破气防也上内伤
	if (dng == 0 or WAR.YTML == 1) and hurt > 0 and DWPD() and WAR.JESS[eid] == nil then
		local n = 0;		--内伤点数值
		if inteam(eid) then		--队友内伤计算
			n = (hurt) / 10
		else
			n = (hurt) / 16
		end
		
		--张召重攻击，内伤加倍
		if match_ID(pid, 80) then
			n = n * 2
		end
		
		--主运先天，逆运，蛤蟆，内伤-30%
		if Curr_NG(eid, 100) or Curr_NG(eid, 104) or Curr_NG(eid, 95) then
			n = n*0.7
		end
		
		--主运踏雪，内伤-50%
		if Curr_QG(eid,178) then
			n = n*0.5
		end		
		
		--除却四相，内伤-50%
		if WAR.CQSX == 1 then
			n = n*0.5
		end
		if WAR.BXJ == 1 then
			n = n*(0.7-JY.Base["天书数量"]*0.04)
		end
		
		--主运乾坤，罗汉，内伤-60%
		if Curr_NG(eid, 97) or Curr_NG(eid, 96) then
			n = n*0.4
		end
		
		--装备乌蚕衣，1级内伤-5，6级内伤-10
		if JY.Person[eid]["防具"] == 59 then
			n = n - 5 - 1*(JY.Thing[59]["装备等级"]-1)
		end

		--太玄之轻免疫内伤
		if WAR.TXZQ[eid] ~= nil and WAR.TXZQ[eid] == 1 then
			n = 0
		end
		
		n= math.modf(n)
		
    	WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", n);
	end
  
	--破防杀集气计算
	if dng == 0 and hurt > 0 and DWPD() then
		local killsq;
		--被杀集气随难度增加
		if JY.Base["难度"] == 1 then
			killsq = 0.8
		elseif JY.Base["难度"] == 2 then
			killsq = 1
		elseif JY.Base["难度"] == 3 then
			killsq = 1.1
		elseif JY.Base["难度"] == 4 then
			killsq = 1.3
		elseif JY.Base["难度"] == 5 then
			killsq = 1.5
		elseif JY.Base["难度"] == 6 then
			killsq = 1.6
		elseif JY.Base["难度"] == 7 then
			killsq = 1.7
		elseif JY.Base["难度"] == 8 then
			killsq = 2	
		end
		--随武功数量变化
		if JY.Base["难度"] > 3 then
		local add1 = (JY.Person[671]["品德"]-12)*0.02*(JY.Base["难度"] - 3)*(JY.Base["天书数量"]/14)
		--local add2 = (JY.Person[671]["品德"]-12)*0.005*JY.Base["难度"]
		   killsq = killsq + add1
		end
		
		local killjq = 0
		if inteam(eid) then  
			killjq = math.modf(ang / 10 * killsq)
		else
			killjq = math.modf(ang / 10)
		end

		--受伤害额外杀集气
		local spdhurt = 0
		--难5开始NPC追加伤害杀气
		if inteam(eid) and JY.Base["难度"] > 4 then
			spdhurt = math.modf(hurt * 0.3)
		end
		--龙象追加杀气
		if PersonKF(pid, 103) then
			spdhurt = math.modf(hurt * 0.3)
		end
		--如果学了八荒不受伤害杀集气
		if PersonKF(eid, 101) then
			spdhurt = 0
		end
		killjq = killjq + spdhurt
		if match_ID(eid, 682) then
		   if killjq > 250 then
		      killjq = 250
		   end	  
		end
		
		--太玄之轻，把被杀的集气转为自己的集气值
		if WAR.TXZQ[eid] ~= nil and WAR.TXZQ[eid] == 1 and WAR.JESS[eid] == nil then
			WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + killjq
			Set_Eff_Text(enemyid,"特效文字1","太玄之轻")
		else
			WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - killjq
			--太极+柔云，以柔克刚，50%几率将被杀气转化为回血
			if YiRouKG(eid) and JLSD(20, 70, eid) and WAR.JESS[eid] == nil then
				local heal = math.modf(killjq/4)
				if tg2 ~= 1 then
				   if fx2 < 0 then
				   heal = math.modf(-(killjq*0.4*fx2)/4)
				   end
				else
				   heal = math.modf(-(killjq*0.4*yin)/4)
				end
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", heal)
				Set_Eff_Text(enemyid,"特效文字1","太极道・以柔克刚")
				WAR.Person[enemyid]["特效动画"] = 21
			end
		end
	end
	if WAR.JQHY2[eid] ~= nil and WAR.JQHY2[eid] == 1 then
		   WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + WAR.JQJQ
		   WAR.JQHY2[eid] = nil
	end
	--逆流而上
	    if match_ID(eid, 36) and JY.Person[36]["天2"] == 2 then
	       WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + math.random(50, 150)
	    end
  
	--小龙女死掉，杨过吼
	if match_ID(eid, 59) and JY.Person[eid]["生命"] <= 0 and WAR.JESS[eid] == nil then
		WAR.XK = 1
		WAR.XK2 = WAR.Person[enemyid]["我方"]
	end
	
	for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and match_ID(WAR.Person[j]["人物编号"], 634) and JY.Person[634]["天4"] == 1 then
		   if math.random(100) <= 18 then
		      WAR.XYZ = 1  
		   end
		end
	end
	
	for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and WAR.Person[j]["人物编号"] == 689 then
		   if math.random(100) <= 25 then
		      WAR.KAEL = 1  
		   end
		end
	end
	
	--文泰来
	for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and match_ID(WAR.Person[j]["人物编号"], 151) then
		    for t = 0, WAR.PersonNum - 1 do
			   if WAR.Person[j]["我方"] == WAR.Person[t]["我方"] and WAR.Person[t]["死亡"] == false and JY.Person[WAR.Person[t]["人物编号"]]["生命"] <= 0 then
		          WAR.WTL = 1
	           end
			end   
		end
	end
	
	if match_ID(eid, 151) and JY.Person[eid]["生命"] <= JY.Person[eid]["生命最大值"]*0.35 and JY.Person[eid]["生命"] > 0 and WAR.JESS[eid] == nil then
		local jl = 15
		jl = jl + math.modf((JY.Person[eid]["生命最大值"]*0.35-JY.Person[eid]["生命"])*30/JY.Person[eid]["生命最大值"]*0.35)
		if WAR.LQZ[eid] == 100 then
		   jl = jl + 8
		end
		if JY.Person[151]["阶"] >= 3 then
		   jl = jl + 15
		end
		if math.random(100) < jl then
		   WAR.WTL = 1
		end   
	end
	  
	--欧阳锋，攻击中毒+30
	if match_ID(pid, 60) then
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 30)
	end
	
	--西毒蛇杖
	if JY.Person[pid]["武器"] == 244 and DWPD() then
		local sz = 10 + 5 * (JY.Thing[244]["装备等级"]-1)
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", sz)
	end
	
	--闪电貂
	if JY.Person[pid]["动物"] == 350 and DWPD() then
		local sz = 4 + 4 * JY.Thing[244]["装备等级"]
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", sz)
	end
	
	if JY.Person[pid]["动物"] == 351 and DWPD() then
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 12)
	end
	
	if wugong == 19 and match_ID(pid, 18) and JY.Person[18]["阶"] >= 1 and DWPD() then
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 100)
	end
	
	--紫气天罗组合强制上毒
	if (wugong == 3 or wugong == 9 or wugong == 5 or wugong == 21 or wugong == 118 or wugong == 120 or wugong == 170 or pid==46 or (JY.Person[642]["血量翻倍"] == 1 and match_ID(pid, 46))) and ZiqiTL(pid) and DWPD() then
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", math.random(20,30))
	end
	
	--赤练神掌，强制上毒20
	if WAR.WD_CLSZ == 1 and DWPD() then
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 20)
	end
	
	--张家辉的麻痹戒指
	if JY.Person[pid]["防具"] == 301 and DWPD() then
		local mb = 1
		if JY.Thing[301]["装备等级"] >=5 then
			mb = 3
		elseif JY.Thing[301]["装备等级"] >=3 then
			mb = 2
		end
		WAR.MBJZ[eid] = mb
	end
	
	--无酒不欢：优化钟灵闪电貂偷东西
	if WAR.TD == -2 and DWPD() then
		for i = 1, 4 do
			if 0 < JY.Person[eid]["携带物品数量" .. i] and -1 < JY.Person[eid]["携带物品" .. i] then
				WAR.TD = JY.Person[eid]["携带物品" .. i]
				WAR.TDnum = JY.Person[eid]["携带物品数量" .. i]
				JY.Person[eid]["携带物品数量" .. i] = 0
				JY.Person[eid]["携带物品" .. i] = -1
				break
			end
		end
	else
		WAR.TD = -1
	end

	--血刀吸血，1级5%，3级6%，5级7%
	--上限100点

	if JY.Person[pid]["武器"] == 44 then
		local bs = 0
		if JY.Thing[44]["装备等级"] >= 5 then
			bs = 2
		elseif JY.Thing[44]["装备等级"] >= 3 then
			bs = 1
		end
		local leech_rate = 0.05 + 0.01*bs
		if WAR.XDLeech < 100 then
			WAR.XDLeech = WAR.XDLeech + limitX(math.modf(hurt * leech_rate),0,100)
			if WAR.XDLeech > 100 then
				WAR.XDLeech = 100
			end
		end
	end
	
	if JY.Person[pid]["武器"] == 362 and JY.Wugong[wugong]["武功类型"] == 3 then
		local bs = JY.Thing[362]["装备等级"]
		local leech_rate = 0.1 + 0.025*bs
		if WAR.JSHJab < 100*bs then
			WAR.JSHJab = WAR.JSHJab + limitX(math.modf(hurt * leech_rate),0,100*bs)
			if WAR.JSHJab > 100*bs then
				WAR.JSHJab = 100*bs
			end
		end
	end
	
	--血河，10%吸血
	if PersonKF(pid, 163) then
		if WAR.XHSJ < 100 then
			WAR.XHSJ = WAR.XHSJ + limitX(math.modf(hurt * 0.1),0,100)
			if WAR.XHSJ > 100 then
				WAR.XHSJ = 100
			end
		end
	end
	
	--韦一笑吸血10%，上限100点
	if match_ID(pid, 14) then
	local p = 0
	   if JY.Person[14]["阶"] >= 2 and WAR.JQSDXS[pid] ~= nil then
	   local p = (WAR.JQSDXS[pid]/600)
	   end
		if WAR.WYXLeech < 500 then
			WAR.WYXLeech = WAR.WYXLeech + limitX(math.modf((hurt) * (0.2+p)),0,500)
			if WAR.WYXLeech > 500 then
				WAR.WYXLeech = 500
			end
		end
		if JY.Person[14]["阶"] >= 2 and JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"]*0.3 then
		   WAR.WYXLeech2 = WAR.WYXLeech2 + hurt
		end
	end
	
	--雷震，夺
	if WAR.LZ_D[eid] ~= nil and JY.Person[eid]["生命"] > hurt then
	   local xnl = math.modf(TrueQZ(pid) * 0.2)
	   local xsm = math.modf(TrueQZ(pid)*0.1)
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl)
	   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", xnl)
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -xsm);
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", xsm)
	end
	
	--雷震，夺
	if WAR.LZ_D[pid] ~= nil then
	   local xnl = math.modf(TrueQZ(eid) * 0.8)
	   local xsm = math.modf(TrueQZ(eid)* 0.4)
	   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -xnl)
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -xsm)
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", xnl)
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", xsm)
	end
	
	--天魔功吸血20%
	if Curr_NG(pid, 160) then
	   WAR.TMGLeech = WAR.TMGLeech + math.modf(hurt * 0.2)
	end
	if JY.Person[pid]["人34"] == 1 then
	   WAR.RENLeech = WAR.RENLeech + math.modf(hurt * 0.06)
	end
	
	if (match_ID(pid, 689) and JY.Person[690]["天4"] == 2) or JY.Person[pid]["防具"] == 367 then
	   WAR.LLXLeech = WAR.LLXLeech + math.modf(hurt * 0.25)
	end
	
	if match_ID(pid, 28) then
	   WAR.PYZLeech = WAR.PYZLeech + math.modf(hurt * (0.1 + 0.02*WAR.PYZ))
	end
	
	if match_ID(pid, 687) and wugong == 17 then
	local add = JY.Person[687]["声望"]/16600
	if JY.Person[687]["声望"] == 1000 and JY.Person[687]["天2"] == 1 then
	   add = add+0.1
	end
	   WAR.YYZLeech = WAR.YYZLeech + math.modf(hurt * (0.04 + add))
	end
	
	if JY.Person[pid]["地7"] == 8 then
	   if WAR.Siphon[pid] ~= nil then
	    WAR.Siphon[pid] = WAR.Siphon[pid] + math.modf(hurt * 0.35)
	   else
	    WAR.Siphon[pid] = math.modf(hurt * 0.35)
	   end
	   if WAR.Siphon[pid] > 1000 then
	      WAR.Siphon[pid] = 1000
	   end
	end
	
	if wugong == 134 and JY.Person[pid]["专2"] == 134 then
	   if WAR.Siphon[pid] ~= nil then
	    WAR.Siphon[pid] = WAR.Siphon[pid] + math.modf(hurt * 0.25)
	   else
	    WAR.Siphon[pid] = math.modf(hurt * 0.25)
	   end
	   if WAR.Siphon[pid] > 1000 then
	      WAR.Siphon[pid] = 1000
	   end
	end
	
	if JY.Person[pid]["人17"] == 1 then
	   if WAR.Siphon[pid] ~= nil then
	    WAR.Siphon[pid] = WAR.Siphon[pid] + math.modf(hurt * 0.2)
	   else
	    WAR.Siphon[pid] = math.modf(hurt * 0.2)
	   end
	   if WAR.Siphon[pid] > 1000 then
	      WAR.Siphon[pid] = 1000
	   end
	end
	
	--被攻击回复
	if 0 < JY.Person[eid]["生命"] and WAR.JESS[eid] == nil then
	local Heal = 0
	--天山童姥 被攻击后生命+80
	if match_ID(eid, 117) then
	   Heal = Heal + 80
	end
	--贝海石
	if match_ID(eid, 85) then
	   Heal = Heal + hurt*0.35+30
	   if JY.Person[85]["阶"] >= 3 then
	      Heal = Heal + 200
	   end
	end
	--苏灿
	if match_ID(eid, 692) and JY.Person[692]["天2"] == 1 then
	   Heal = Heal + hurt*0.5+1
	end
	
	--雷震，八荒
	if match_ID(eid, 670) and JY.Person[eid]["天赋内功"] == 101 and PersonKF(eid, 101) then
		Heal = Heal + 80
	end
	--坚韧不拔
	if eid == 0 and JY.Person[0]["天1"] == 3 then
	   Heal = Heal + hurt*0.01*(5+JY.Base["天书数量"]/2)
	end
	--先天
	if Curr_NG(eid, 100) then
	local x = math.modf((JY.Person[eid]["生命最大值"] - JY.Person[eid]["生命"])*0.03)
	  if x > hurt then
	     x = hurt
	  end
	   Heal = Heal + x
	end
	if JY.Person[eid]["专2"] == 171 and PersonKF(eid, 171) then
	   Heal = Heal + hurt*0.15
	end

	--无酒不欢 枯木逢春
	if JY.Base["特殊"] ==1 and JY.Person[38]["血量翻倍"]==1 and eid==0 then
		Heal = Heal + 40
	end

	--先天功+九阴
	if ((PersonKF(eid,107) and PersonKF(eid,100)) or match_ID(eid, 129)) then
		local LJ=math.random(4)
		if LJ==1 then
		Heal = Heal + 20
		Set_Eff_Text(enemyid,"特效文字5","大道无形，生育天地")
		end
		if LJ==2 then
		Heal = Heal + 30
		Set_Eff_Text(enemyid,"特效文字5","大道无情，运行日月")
		end
		if LJ==3 then
		Heal = Heal + 40
		Set_Eff_Text(enemyid,"特效文字5","大道无名，长养万物")
		end
		if LJ==4 then
		Heal = Heal + 50
		Set_Eff_Text(enemyid,"特效文字5","吾不知其名，强名曰道")
		end
	end
	
				if Curr_NG(eid, 94) then
				   Heal = Heal*3
				end
				if JY.Person[eid]["洗髓"] == 100 then
				   Heal = Heal*1.1
				end
				if Curr_NG(eid, 171) then
				   Heal = Heal*1.3
				end
				if PersonKF(eid, 97) then
				   Heal = Heal*1.1
				end
				   
				if Curr_NG(eid, 96) then
				   Heal = Heal*1.2
				end
				
				--地狱铁拳
				if WAR.DYTQ[eid] ~= nil then
				   Heal = Heal*1.2
				end
				if PersonKF(eid, 100) then
				   Heal = Heal*1.1
				end
				if PersonKF(eid, 107) then
				   Heal = Heal*1.1
				end
				if JY.Person[eid]["防具"] == 367 then
				   Heal = Heal*1.5
				end
				if JY.Person[eid]["动物"] == 262 then
				   Heal = Heal*1.1
				end
				if XueDao() then
				   if not match_ID(eid, 97) then
				      Heal = 0
				   end
				end
				if WAR.LZ_S[eid] ~= nil then
				   Heal = 0
				end
				
				--聂风
				if WAR.ZWZX[eid] ~= nil then
				   Heal = Heal*0.4
				end
				--昏迷
				if WAR.HMZT[eid] ~= nil then
				   Heal = Heal*0.6
				end
				if WAR.BLZ[eid] ~= nil then
				   Heal = Heal*0.6
				end
				--无影神拳！
				if WAR.WYSQ[eid] ~= nil then
				   Heal = Heal*0.1
				end
				--化骨绵掌
				if WAR.HGMZ[eid] ~= nil then
				   Heal = Heal*0.7
				end
				
				--魔刀
				if WAR.MDLX[eid] ~= nil then
				   Heal = Heal*0.7
				end
				if WAR.JHLY[eid] ~= nil then
				   Heal = Heal*0.6
				end
				--中毒-
				if JY.Person[eid]["中毒程度"] > 70 then
				   Heal = Heal*0.7
				elseif JY.Person[eid]["受伤程度"] > 35 then
					Heal = Heal*0.9
				end
				--灼烧
				if JY.Person[eid]["灼烧程度"] >= 0 then
				   Heal = Heal*0.9
				end
				--内伤
				if JY.Person[eid]["受伤程度"] > 70 then
					Heal = Heal*0.5
				elseif JY.Person[eid]["受伤程度"] > 35 then
					Heal = Heal*0.8
				end
				
	
	Heal = math.modf(Heal)
	WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", Heal);
	end
	--被攻击
	--霍青桐 杀体力
	if WAR.HQT == 1 and DWPD() then
		WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid, "体力", -math.random(7,8))
	end
	
	

	--程英 杀内力
	if WAR.CY == 1 and DWPD() then
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -300);
		if JY.Person[63]["阶"] >= 3 then
		   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -500)
		end
	end
	--电磁脉冲
	if wugong == 229 and DWPD() then
	   local loss = math.modf((2^(1.6+0.6*JY.Person[689]["天2"]))*110 + math.modf(hurt*0.6)) 
	   if JY.Person[pid]["专1"] == 229 then
	      loss = math.modf(loss*1.45) 
	   end
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -loss)
	end
	
	--进阶万岳，杀内力
	if wugong == 33 and PersonKF(pid,175) and DWPD() then
		local neiliLoss = hurt
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -neiliLoss);
	end

	--阎基偷钱
	if eid ~= 591 and match_ID(pid, 4) and JY.Person[eid]["生命"] <= 0 and inteam(pid) and DWPD() then
		WAR.YJ = WAR.YJ + math.random(15) + 25
	end
	
	--苏乞儿
	if eid ~= 591 and match_ID(pid, 692) and JY.Person[eid]["生命"] <= 0 and inteam(pid) and DWPD() then
		WAR.YJ = WAR.YJ + math.random(10) + 5
	end
  
	--田归农与阎基的加成，中毒+5 + 随机15
	if match_ID(pid, 72) and DWPD() then
		for j = 0, WAR.PersonNum - 1 do
			if match_ID(WAR.Person[j]["人物编号"],4) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 5 + math.random(15));
			end
		end
	end
	    
	--辟邪刺目，100%MISS
	if WAR.KHBX == 2 and 0 < hurt then
	if (match_ID(eid, 36) or match_ID(eid, 48) or match_ID(eid, 130) or match_ID(eid, 78) or match_ID(eid, 13) or match_ID(eid, 602)) == false then
		WAR.KHCM[eid] = 2
	end	
	end
	
	if WAR.HBMZ == 1 and hurt > 0 then
	   if WAR.HBMZJS[eid] == nil then
	      WAR.HBMZJS[eid] = 10
	   else
	      WAR.HBMZJS[eid] = WAR.HBMZJS[eid] + 5
	   end
	end
	if WAR.DGGF == 1 and hurt > 0 then
	   if WAR.DGGFJS[eid] == nil then
	      WAR.DGGFJS[eid] = 10
	   else
	      WAR.DGGFJS[eid] = WAR.DGGFJS[eid] + 5
	   end
	end
	if WAR.LMSJ == 5 and hurt > 0 then
	   if WAR.DGGFJS[eid] == nil then
	      WAR.DGGFJS[eid] = 15
	   else
	      WAR.DGGFJS[eid] = WAR.DGGFJS[eid] + 5
	   end
	   if WAR.JQSDXS[eid] ~= nil and WAR.JQSDXS[pid] ~= nil and WAR.JQSDXS[eid] < WAR.JQSDXS[pid] then
	      WAR.HMZT[eid] = 1
	   end
	end
  
	--无酒不欢：一些高封穴的人物
	--扫地，任我行，王重阳，一灯，成昆，龙岛主，玄慈，段延庆，黄药师，穆人清
	local gfxp = {114, 26, 129, 65, 18, 39, 70, 98, 57, 185}
	for g = 1, #gfxp do
		if match_ID(pid, gfxp[g]) and JLSD(30, 70, pid) then
			WAR.BFX = 1
		end
	end
	if JY.Person[pid]["人24"] == 1 and math.random(100) <= 25 then
	   WAR.BFX = 1
	end
	if JY.Person[637]["声望"] >= 3 and match_ID(pid, 637) and math.random(100) <= 50 then
	   WAR.BFX = 1
	end
	
	if match_ID(pid, 677) and JY.Person[677]["天3"] == 2 then
	   WAR.BFX = 1
	end
	
	if match_ID(pid, 686) and (JY.Wugong[wugong]["武功类型"] == 1 or JY.Wugong[wugong]["武功类型"] == 2) then
	   WAR.BFX = 1
	end
  
	--拳主大招，高几率封穴
	if WAR.LXZQ == 1 and JLSD(25, 75, pid) then
		WAR.BFX = 1
	end
	
	--混元功，高几率封穴
	if Curr_NG(pid, 90) and JLSD(25, 75, pid) then
		WAR.BFX = 1
	end
	
	--琴棋书画之倚天屠龙功，必封穴
	if WAR.QQSH3 == 1 then
		WAR.BFX = 1
	end
	
	--贝海石
	if match_ID(pid, 85) and wugong == 239 and math.random(100) < 35 then
	   WAR.BFX = 1
	end
	
	--谢烟客，碧针清掌
	if match_ID(pid, 164) and wugong == 206 then
		WAR.BFX = 1
	end
	
	--冯锡范
	if match_ID(pid, 150) and JLSD(25, 75, pid) then
	   WAR.BFX = 1
	end
	
	--奇门主角大招，必封穴
	if WAR.GCTJ == 1 then
		WAR.BFX = 1
	end
	
	--馥m流云扇，必封穴
	if wugong == 196 then
		WAR.BFX = 1
	end
	
	--一阳指，玄铁剑法50%几率封穴，优先判定
	if (wugong == 17 or wugong == 45) and JLSD(30,80,pid) then
		WAR.BFX = 1
	end
	
	if wugong == 17 and JY.Person[pid]["专2"] == 17 then
	   WAR.BFX = 1
	end
	
	if wugong == 19 and JY.Person[pid]["专2"] == 19 then
	   WAR.BFX = 1
	end
	
	--弹指神通
	if wugong == 18 and JY.Person[pid]["专2"] == 18 then
	   WAR.BFX = 1
	end

	if wugong == 121 and JY.Person[pid]["专1"] == 121 then
	   WAR.BFX = 1
	end
	
	if wugong == 127 and JY.Person[pid]["专1"] == 127 then
	   WAR.BFX = 1
	end
	--多罗叶指
	if JY.Wugong[wugong]["武功类型"] == 2 and JY.Person[pid]["专2"] == 132 and PersonKF(pid, 132) then
	   WAR.BFX = 1
	end
	
	
	--拳法指法45%几率封穴
	if (WGLX == 1 or WGLX == 2) and JLSD(30, 75, pid) then
		WAR.BFX = 1
	end
	
	--毒王大招必封穴
	if WAR.YTML == 1 then
		WAR.BFX = 1
	end
	
	--指法主角，初始15%封穴率，每个指法+5%
	if match_ID(pid, 678) then
		local lxyz = 45
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 2 and JY.Person[0]["武功等级" .. i] == 999 then
				lxyz = lxyz + 2
			end
		end
		if JLSD(30, 30 + lxyz, pid) then
			WAR.BFX = 1
		end
	end
	
	--指法主角，初始15%封穴率，每个指法+5%
	if JY.Base["标准"] == 2 and pid == 0 then
		local lxyz = 40
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 2 and JY.Person[0]["武功等级" .. i] == 999 then
				lxyz = lxyz + 6
			end
		end
		if JLSD(30, 30 + lxyz, pid) then
			WAR.BFX = 1
		end
	end
	
	--无酒不欢 灵犀一指
	if JY.Base["特殊"] ==1 and JY.Person[17]["血量翻倍"]==1 and pid==0 then
		local lxyz = 15
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 2 and JY.Person[0]["武功等级" .. i] == 999 then
				lxyz = lxyz + 1
			end
		end
		if JLSD(30, 30 + lxyz, pid) then
			WAR.BFX = 1
		end
	end
	
	local fx_yes = 1
	
	--逍遥御风累积9点，未行动前不会被封穴
	if WAR.XYYF[eid] and WAR.XYYF[eid] == 11 and WAR.JESS[eid] == nil then
		fx_yes = 0
	end
	
	--逆运免疫封穴
	if PersonKF(eid, 104) and WAR.JESS[eid] == nil then
		fx_yes = 0
	end
	
	if PersonKF(eid, 237) and WAR.JESS[eid] == nil then
		fx_yes = 0
		Set_Eff_Text(enemyid, "特效文字1", "天移地转大移穴法")
		WAR.Person[enemyid]["特效动画"] = 148
	end
	
	--无名，剑冲废穴
	if match_ID(eid, 671) and JY.Person[eid]["六如觉醒"] == 7 then
	    fx_yes = 0
		Set_Eff_Text(enemyid, "特效文字1", "剑冲废穴")
		WAR.Person[enemyid]["特效动画"] = 63
	end
	
	--主运瞬息千里，暴怒状态不会被封穴
	if Curr_QG(eid,150) and WAR.LQZ[eid]==100 and WAR.JESS[eid] == nil then
		fx_yes = 0
	end
	
	--伤害小于50无封穴，拳法指法额外封穴，一阳指高封穴，其他30%几率封穴
	--除却四相免疫封穴
	if fx_yes == 1 and DWPD() and 50 <= hurt and (WAR.BFX == 1 or JLSD(30, 60, pid)) then
		--无酒不欢：使用分段函数
		local fxz = 1;
		if hurt >= 50 and hurt < 100 then
			fxz = fxz + math.modf((hurt - 50)/10)
		elseif hurt >= 100 and hurt <= 200 then
			fxz = math.modf((hurt - 50)/10) + math.random(3)
		elseif hurt > 200 then
			fxz = math.modf(hurt/15) + 5 + math.random(3)
		end
		--封穴调整
		if inteam(pid) then
			fxz = math.modf(fxz *0.4)
		else
			fxz = math.modf(fxz *0.6)
		end
		--暴怒状态封穴减半
		if WAR.LQZ[eid]==100 and WAR.JESS[eid] == nil then
			fxz = math.modf(fxz *0.5)
		end
		--被动混元，造成的封穴效果提高50%
		if PersonKF(pid, 90) then
			fxz = math.modf(fxz *1.5)
		end
		--公孙止受封穴减半
		if match_ID(eid, 616) and WAR.JESS[eid] == nil then
			fxz = math.modf(fxz *0.5)
		end
		--圣火受封穴减半
		if Curr_NG(eid, 93) and WAR.JESS[eid] == nil then
			fxz = math.modf(fxz *0.5)
		end
		--乾坤受封穴减半
		if Curr_NG(eid, 97) and WAR.JESS[eid] == nil then
			fxz = math.modf(fxz *0.5)
		end
		--除却四相受封穴减半
		if WAR.CQSX == 1 then
			fxz = math.modf(fxz *0.5)
		end
		if WAR.BXJ == 1 then
			fxz = math.modf(fxz*(0.8-JY.Base["天书数量"]*0.04))
		end
		--天怒十方，怒气减少封穴
		if match_ID(eid, 670) and JY.Person[eid]["内力"] >= 1500 and JY.Person[eid]["生命"] > JY.Person[eid]["生命最大值"]* 0.1 and JY.Person[eid]["防具"] == 327 and WAR.LQZ[eid] ~= nil then
		   fxz = math.modf(fxz *(1-WAR.LQZ[eid])/100)
		end
		--装备金丝背心，1级封穴-5，6级封穴-10
		if JY.Person[eid]["防具"] == 60 then
			fxz = fxz - 5 - 1*(JY.Thing[60]["装备等级"]-1)
			if fxz < 0 then
				fxz = 0
			end
		end
		if fxz > 0 then
			--玩家和NPC一样待遇
			if WAR.FXDS[eid] == nil then
				WAR.FXDS[eid] = fxz
			else
				WAR.FXDS[eid] = WAR.FXDS[eid] + fxz
			end
			if JY.Person[pid]["人28"] == 1 then
			   if WAR.LJXS[eid] == nil then
				WAR.LJXS[eid] = fxz
			   else
				WAR.LJXS[eid] = WAR.LJXS[eid] + fxz
			   end
			end
			WAR.FXXS[eid] = 1
			--封穴上限50点
			if 25 < WAR.FXDS[eid] then
				WAR.FXDS[eid] = 25
			end
		end
	end
  
	WAR.BFX = 0
	
	--无酒不欢：一些高流血的人物
	local glxp = {6, 3, 40, 97, 103, 19, 60, 71, 189}
	for g = 1, 9 do
		if match_ID(pid, glxp[g]) and JLSD(30, 70, pid) then
			WAR.BLX = 1
		end
	end
	  
	--倚天剑，必流血
	--1级70%几率流血
	--4级开始追加灼烧
	if JY.Person[pid]["武器"] == 37 then
		if JLSD(0, 60 + JY.Thing[37]["装备等级"] * 10, pid) and match_ID(pid, 150) == false then
			WAR.BLX = 1
		end
	end
	
	--剑道
	if JY.Person[pid]["人3"] == 1 and DWPD() then
	   WAR.BLX = 1
	end
	
	--丁典，邪
	if match_ID(pid, 672) and JY.Person[672]["品德"] == 70 and DWPD() then
	   WAR.BLX = 1
	end
	--西门吹雪
	if match_ID(pid, 683) and JY.Wugong[wugong]["武功类型"] == 3 and DWPD() then
	   WAR.BLX = 1
	end
	
	--摧心掌
	if wugong == 201 and DWPD() then
	   WAR.BLX = 1
	end
	
	--贝海石
	if match_ID(pid, 85) and wugong == 239 and math.random(100) < 35 then
	   WAR.BLX = 1
	end
	
	--田归农装备闯王军刀，必流血
	if JY.Person[pid]["武器"] == 202 and match_ID(pid, 72) then
		WAR.BLX = 1
	end
	
	--无名，名不虚传
	if wugong == 199 and match_ID(pid, 671) and WAR.MMZS == 8 and DWPD() then
	   WAR.BLX = 1
	end
	
	--钟灵必流血
	if match_ID(pid, 90) and DWPD() then
		WAR.BLX = 1
	end
	
	--剑法刀法45%几率流血
	if (WGLX == 3 or WGLX == 4) and JLSD(30, 75, pid) and match_ID(pid, 150) == false then
		WAR.BLX = 1
	end
	
	--沧溟刀法特效，必流血
	if WAR.CMDF == 1 and match_ID(pid, 150) == false and DWPD() then
		WAR.BLX = 1
	end
	
	--主运血河神鉴，必流血
	if ((JY.Person[pid]["天赋内功"] == 163 and PersonKF(pid, 163)) or Curr_NG(pid, 163)) and match_ID(pid, 150) == false then
		WAR.BLX = 1
	end
	
	--毒王大招必流血
	if WAR.YTML == 1 and match_ID(pid, 150) == false then
		WAR.BLX = 1
	end
	--满足玄铁重击的判定
	if WAR.LXZT[eid] == 100 and WAR.FXDS[eid] == 25 and JY.Person[pid]["武器"] == 36 and DWPD() then
		WAR.XTZJ[eid] = 1
		WAR.LXZT[eid] = nil
		WAR.LXXS[eid] = nil
	end
	
	--装备倚天剑，屠龙刀第一种特效，奇门标主大招，必流血，其他30%几率流血
	--防御方带6级金丝免疫流血
	if (hurt > 30 and DWPD() and (JY.Person[eid]["武器"] == 239 and JY.Thing[239]["装备等级"] == 6) == false and (JY.Person[eid]["专2"] == 63 and PersonKF(eid, 63)) == false and (WAR.L_TLD == 1 or WAR.BLX == 1 or WAR.GCTJ == 1 or JLSD(30, 60, pid))) and match_ID(pid, 150) == false then
		if WAR.LXZT[eid] == nil then
			WAR.LXZT[eid] = math.modf((hurt) / 10)
		else
			WAR.LXZT[eid] = WAR.LXZT[eid] + math.modf((hurt) / 10)
		end
		WAR.LXXS[eid] = 1
		if 100 < WAR.LXZT[eid] then
			WAR.LXZT[eid] = 100
		end
	end
	
   
	WAR.BLX = 0
	
	--冰封计算 
	--阴内九阴必冰封
	if JY.Person[pid]["地1"] == 6 then
	   WAR.BBF = 1
	end
	
	if JY.Person[pid]["人22"] == 1 and math.random(100) <= 20 then
	   WAR.BBF = 1
	end
	
	if JY.Wugong[wugong]["冰封系数"] == 1 and (PersonKF(pid, 107) or JLSD(10,90,pid)) then
		WAR.BBF = 1
	end
	
	if JY.Person[pid]["武器"] == 360 and math.random(100) <= 25 + JY.Thing[360]["装备等级"] * 5 then
	   WAR.BBF = 1
	end
	
	if JY.Person[pid]["动物"] == 351 and math.random(100) <= 40 + JY.Thing[351]["装备等级"] * 10 then
	   WAR.BBF = 1
	end
	
	if match_ID(pid, 677) and JY.Person[677]["天3"] == 2 then
	   WAR.BBF = 1
	end
	
	--冰眼
	if match_ID(pid, 689) and JY.Person[690]["天2"] == 2 or JY.Person[pid]["防具"] == 369 then
       WAR.BBF = 1 
	end
	
	if (wugong == 17 or wugong == 19) and PersonKF(pid, 17) and PersonKF(pid, 19) then
	   WAR.BBF = 1
	end
	
	--万岳朝宗
	if wugong == 33 and JY.Person[pid]["专1"] == 33 then
	   WAR.BBF = 1
	end
	
	--雪山
	if wugong == 35 and JY.Person[pid]["专1"] == 35 then
	   WAR.BBF = 1
	end
	
	--冬寒刺骨
	if match_ID(pid, 675) and WAR.DHCG == 1 then
	   WAR.BBF = 1
	end 

	if wugong == 5 and JY.Person[pid]["专1"] == 5 then
	   WAR.BBF = 1
	end  
	--天山六阳掌
	if wugong == 8 and JY.Person[pid]["专2"] == 8 then
	   WAR.BBF = 1
	end
	if wugong == 19 and JY.Person[pid]["专2"] == 19 then
	   WAR.BBF = 1
	end
	if PersonKF(pid, 174) and JY.Person[pid]["专2"] == 174 and JY.Wugong[wugong]["武功类型"] == 4 then
	   WAR.BBF = 1
	end
	
	--浊浪排空1
	if match_ID(pid, 670) and WAR.ZLPK >= 1 then
	    WAR.BBF = 1
	end
	
	--贝海石
	if match_ID(pid, 85) and wugong == 239 and math.random(100) < 35 then
	   WAR.BBF = 1
	end
	
	if JY.Wugong[wugong]["武功类型"] == 1 and JY.Person[pid]["专2"] == 120 and PersonKF(pid, 120) then
	   WAR.BBF = 1
	end
	
	--幻阴指
	if match_ID(pid, 18) and wugong == 19 then
	    WAR.BBF = 1
	end
	
	--林朝英流风回雪
	if WAR.LFHX == 1 then
		WAR.BBF = 1
	end
	if WAR.LIBAI == 2 then
		WAR.BBF = 1
	end
	
	--渔一阳指必冰封
	if match_ID(pid, 119) and wugong == 17 then
		WAR.BBF = 1
	end
	
	--琴棋书画的妙笔丹青特效
	if WAR.QQSH2 >= 1 then
		WAR.BBF = 1
	end
	
	--玉箫剑法配合桃花绝技60%冰封
	if wugong == 38 and TaohuaJJ(pid) and JLSD(20,80,pid) then
		WAR.BBF = 1
	end
	
	--左冷禅，李四，高几率冰封
	if (match_ID(pid, 22) or match_ID(pid, 42) or (match_ID(pid, 420) and pid == 0)) and JLSD(10,90,pid) then
		WAR.BBF = 1
	end
	if Curr_NG(pid, 207) then
	   WAR.BBF = 1
	end   
	
	--毒王大招必冰封
	if WAR.YTML == 1 then
		WAR.BBF = 1
	end

	--冰火毒龙	玉真子自带
	if match_ID(pid, 184) or BinghuoDL(pid) then
		WAR.BBF = 1
	end

	if tg ~= 1 then
	   if fx < -3 then
	      if math.random(100) <= (-fx+3)*10 then
	         WAR.BBF = 1
	      end
	   end
	else
	   if math.random(100) <= (-yin+3)*10 then
	         WAR.BBF = 1
	   end
	   
	end
	
	
	--阴内或调和的枯禅, 免疫冰封
	if PersonKF(eid, 186) and fx2 < 0 then
		WAR.BBF = 0
	end
	
	if fx2 > 9 or tg2 == 1 then
	   WAR.BBF = 0
	end   

	--除却四相免疫冰封
	if hurt > 30 and DWPD() and WAR.BBF == 1 then
		local bfz = math.modf(hurt / 10)
		--琴棋书画的妙笔丹青特效大冰封
		if WAR.QQSH2 >= 1 then
			bfz = bfz * 2
		end 
		if Curr_NG(pid, 207) then
			bfz = bfz * 2
		end
		--装备皮衣，1级冰封-50%，6级免疫冰封
		if JY.Person[eid]["防具"] == 63 then
			local kh = 0.5 + 0.1 * (JY.Thing[63]["装备等级"]-1)
			bfz = math.modf(bfz *(1-kh))
		end
		--纯阳被动，冰封-50%
		if PersonKF(eid, 99) and WAR.JESS[eid] == nil then
			bfz = math.modf(bfz / 2)
		end
		--除却四相，冰封-50%
		if WAR.CQSX == 1 and WAR.JESS[eid] == nil then
			bfz = math.modf(bfz / 2)
		end
		if WAR.BXJ == 1 then
			bfz = math.modf(bfz*(0.6-JY.Base["天书数量"]*0.04))
		end
		if bfz > 0 then
			JY.Person[eid]["冰封程度"] = JY.Person[eid]["冰封程度"] + bfz
			WAR.BFXS[eid] = 1
			if 100 < JY.Person[eid]["冰封程度"] then
				JY.Person[eid]["冰封程度"] = 100
			end
		end
	end
	
	WAR.BBF = 0

	--灼烧计算
	--阳内九阳必灼烧
	if JY.Person[pid]["地5"] == 5 then
	   WAR.BZS = 1
	end
	if JY.Person[pid]["人22"] == 1 and math.random(100) <= 20 then
	   WAR.BBF = 1
	end
	if JY.Wugong[wugong]["灼烧系数"] == 1 and JLSD(10,90,pid) then
		WAR.BZS = 1
	end
	if wugong == 221 and WAR.YSZZS == 2 then
	   WAR.BZS = 1
	end
	if Curr_NG(pid, 99) or Curr_NG(pid, 106) then
		WAR.BZS = 1
	end
	
	if match_ID(pid, 677) and JY.Person[677]["天3"] == 2 then
	   WAR.BZS = 1
	end
	
	--贝海石
	if match_ID(pid, 85) and wugong == 239 and math.random(100) < 35 then
	   WAR.BZS = 1
	end
	
	--天山六阳掌
	if wugong == 8 and JY.Person[pid]["专2"] == 8 then
	   WAR.BZS = 1
	end
	
	--金乌刀法
	if wugong == 61 and JY.Person[pid]["专1"] == 61 then
	   WAR.BZS = 1
	end
	
	if wugong == 136 and JY.Person[pid]["专2"] == 136 then
	   WAR.BZS = 1
	end
	
	if (wugong == 17 or wugong == 19) and PersonKF(pid, 17) and PersonKF(pid, 19) then
	   WAR.BZS = 1
	end
	
	if JY.Wugong[wugong]["武功类型"] == 4 and JY.Person[pid]["专2"] == 65 and PersonKF(pid, 65) then
	   WAR.BZS = 1
	end
	
	
	if tg ~= 1 and fx > 3 then
	   if math.random(100) <= (fx-3)*10 then
	      WAR.BZS = 1
	   end
	elseif tg == 1 then
	   if math.random(100) <= (yang-3)*10 then
	      WAR.BZS = 1
	   end
	end
	
	--雷震，火焰刀
	if match_ID(pid, 670) and wugong == 66 then
	    WAR.BZS = 1
	end
	
	if match_ID(pid, 670) and WAR.TNSF >= 1 then
	    WAR.BZS = 1
	end
	
	if match_ID(pid, 673) and wugong == 205 then
	    WAR.BZS = 1
	end
	
	--无名，剑火无名
	if  wugong == 199 and match_ID(pid, 671) and WAR.MMZS == 6 and WAR.LQZ[pid] ~= nil and WAR.LQZ[pid] >= 80 then
	   WAR.BZS = 1
	   if WAR.LQZ[pid] == 100 then
	      WAR.JHLY[eid] = 10 + math.modf(JY.Person[pid]["御剑能力"]*0.01)
	   end
	end

	--冰火毒龙	玉真子自带
	if match_ID(pid, 184) or BinghuoDL(pid) then
		WAR.BZS = 1
	end		
	
	--苗人凤，天门，张三，高几率灼烧
	if (match_ID(pid, 3) or match_ID(pid, 23) or match_ID(pid, 41)) and JLSD(10,90,pid) then
		WAR.BZS = 1
	end
	
	--樵一阳指必灼烧
	if match_ID(pid, 120) and wugong == 17 then
		WAR.BZS = 1
	end
	
	--毒王大招必灼烧
	if WAR.YTML == 1 then
		WAR.BZS = 1
	end
	
	--阳内或调和的枯禅, 免疫灼烧
	if PersonKF(eid, 186) and fx2 > 0 and WAR.JESS[eid] == nil then
		WAR.BZS = 0
	end
	
	if (fx2 < -9 or tg2 == 1) and WAR.JESS[eid] == nil then
		WAR.BZS = 0
	end
	
	if PersonKF(eid, 207) and JY.Person[eid]["天赋内功"] == 207 and WAR.JESS[eid] == nil then
		WAR.BZS = 0
	end
	
	--除却四相免疫灼烧
	if hurt > 30 and DWPD() and WAR.BZS == 1 then
		local zsz = math.modf(hurt / 10)

		--装备佛心甲，1级灼烧-50%，6级免疫灼烧
		if JY.Person[eid]["防具"] == 62 then
			local kz = 0.5 + 0.1 * (JY.Thing[62]["装备等级"]-1)
			zsz = math.modf(zsz *(1-kz))
		end
		--玉女被动，灼烧0
		if PersonKF(eid, 154) and WAR.JESS[eid] == nil then
			zsz = 0
		end
		--除却四相，灼烧-50%
		if WAR.CQSX == 1 and WAR.JESS[eid] == nil then
			zsz = math.modf(zsz / 2)
		end
		if WAR.BXJ == 1 then
			zsz = math.modf(zsz*(0.6-JY.Base["天书数量"]*0.04))
		end
		if zsz > 0 then
			JY.Person[eid]["灼烧程度"] = JY.Person[eid]["灼烧程度"] + zsz
			WAR.ZSXS[eid] = 1
			if 50 < JY.Person[eid]["灼烧程度"] then
				JY.Person[eid]["灼烧程度"] = 50
			end
		end
	end
	
	WAR.BZS = 0
	
	--倚天剑，4级开始追加灼烧
	if JY.Person[pid]["武器"] == 37 and JY.Thing[37]["装备等级"] >= 4 and DWPD() and hurt > 0 then
		local zsz = (JY.Thing[37]["装备等级"]-3)*5

		--装备佛心甲，灼烧-50%
		if JY.Person[eid]["防具"] == 62 then
			zsz = math.modf(zsz / 2)
		end
		--玉女被动，灼烧0
		if PersonKF(eid, 154) and WAR.JESS[eid] == nil then
			zsz = 0
		end
		--除却四相，灼烧-50%
		if WAR.CQSX == 1 and WAR.JESS[eid] == nil then
			zsz = math.modf(zsz / 2)
		end
		if WAR.BXJ == 1 then
			zsz = math.modf(zsz*(0.6-JY.Base["天书数量"]*0.04))
		end
		if zsz > 0 then
			JY.Person[eid]["灼烧程度"] = JY.Person[eid]["灼烧程度"] + zsz
			WAR.ZSXS[eid] = 1
			if 50 < JY.Person[eid]["灼烧程度"] then
				JY.Person[eid]["灼烧程度"] = 50
			end
		end
	end
	
	--DOOM
	if JY.Person[pid]["地8"] == 8 then
	local jl = 20 + JY.Person[pid]["资质"]*0.15
	if WAR.LQZ[pid] ~= nil then
	   jl = jl + WAR.LQZ[pid]*0.3
	end
	if WAR.LQZ[pid] == 100 then
	   jl = 100
	end  
	
	if math.random(100)<jl then
	local tim = 1
	while tim < math.random(3)+4 do
	local XZ = {}
		for j = 0, WAR.PersonNum - 1 do
		  if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
		     WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
		     table.insert(XZ,j)
		  end
		end
	local si = XZ[math.random(#XZ)]
	local dam = math.modf(JY.Person[pid]["内力最大值"]*0.05 + JY.Person[pid]["资质"]*2)+350
	WAR.Person[si]["特效动画"] = 166
	WAR.Person[si]["生命点数"] = (WAR.Person[si]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[si]["人物编号"], "生命", -dam)
	tim = tim + 1
	end
	end
    end
	
	--雷震剑法
	if (JY.Person[pid]["专1"] == 28 or (match_ID(pid, 91) and JY.Base["天书数量"]>=7)) and wugong == 28 then
	local jl = 5
	if WAR.LQZ[pid] ~= nil then
	   jl = jl + math.modf(WAR.LQZ[pid]*0.04)
	end
	if WAR.LQZ[pid] == 100 then
	   jl = jl + 3
	end
	if match_ID(pid, 91) then
	   jl = jl + 7
	   if JY.Person[91]["阶"] >= 2 then
	      jl = jl + 5
	   end
	end
	
	local tim = 1
	while tim < jl+1 do
	local XZ = {}
		for j = 0, WAR.PersonNum - 1 do
		  if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
		     WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
		     table.insert(XZ,j)
		  end
		end
	local si = XZ[math.random(#XZ)]
	local dam = math.modf(JY.Person[pid]["御剑能力"]*0.2)+math.random(20)
	WAR.Person[si]["特效动画"] = 131
	WAR.Person[si]["生命点数"] = (WAR.Person[si]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[si]["人物编号"], "生命", -dam)
	tim = tim + 1
	end
    end
	
	--文泰来
	if match_ID(pid, 151) and JY.Wugong[wugong]["武功类型"] == 1 then
	local jl = 6 + JY.Base["天书数量"]
	if not inteam(pid) then
	   jl = 6
	end
	
	local tim = 1
	while tim < jl+1 do
	local XZ = {}
		for j = 0, WAR.PersonNum - 1 do
		  if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
		     WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
		     table.insert(XZ,j)
		  end
		end
	local si = XZ[math.random(#XZ)]
	local dam = math.modf(JY.Person[pid]["拳掌功夫"]*0.25)+10+math.random(10)
	if JY.Person[151]["阶"] >= 3 then
	   dam = dam + math.modf(JY.Person[pid]["拳掌功夫"]*0.1) + 10
	end
	WAR.Person[si]["特效动画"] = 6
	WAR.Person[si]["生命点数"] = (WAR.Person[si]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[si]["人物编号"], "生命", -dam)
	tim = tim + 1
	end
    end
	
	--怒气值计算，斗转星移不加怒，指法大招不加怒，暗香反击不加怒
	if 0 < JY.Person[eid]["生命"] and hurt > 0 and (WAR.LQZ[eid] == nil or WAR.LQZ[eid] < 100) and (wugong == 27 and JY.Person[pid]["专1"] == 27)==false
	and (wugong == 137 and JY.Person[pid]["专2"] == 137)==false
	and pid ~= 689
	and (match_ID(pid, 691) and JY.Person[691]["天4"] == 2)==false
	and (match_ID(pid, 693) and JY.Person[693]["天2"] == 2 and WAR.TQLJ > 1)==false
	and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] 
	and WAR.DZXY ~= 1 and WAR.LXYZ ~= 1 and WAR.AXFJ ~= 1 and WAR.MMZS ~= 10 then
		local lqzj = math.modf((hurt) / 8 + 1)
		--擒龙功, 怒气值*1.5
		if Curr_NG(eid, 188) then
			lqzj = math.modf(lqzj*1.5)
		end
		if JY.Person[eid]["人6"] == 1 then
		   lqzj = lqzj + 15
		end
		if PersonKF(eid, 159) and JY.Person[eid]["专2"] == 159 then
			lqzj = math.modf(lqzj*2)
		end
		if PersonKF(eid, 218) then
			lqzj = math.modf(lqzj*0.7)
		end
		if JY.Base["标准"] == 4 and eid == 0 and JY.Person[0]["阶"] >= 3 then
		   lqzj = lqzj + 10
		end
		lqzj = math.random(lqzj, lqzj+8)
		
		--敌人难度下额外增加的怒气值
		if WAR.Person[enemyid]["我方"] == false then
			local flqzj = 0
			if JY.Base["难度"] == 1 then
				flqzj = 0
			elseif JY.Base["难度"] == 2 then
				flqzj = 2
			elseif JY.Base["难度"] == 3 then
				flqzj = 5	
			else
				flqzj = 4 + JY.Base["难度"]
			end
			
			lqzj = lqzj + flqzj
		end
		
		if WAR.Person[enemyid]["我方"] == true and JY.Person[642]["血量翻倍"] == 1 then
			lqzj = lqzj + 8 + JY.Base["难度"]
		end	
		--豪鬼怒气
		if match_ID(eid, 673) then
		   if lqzj < 10 then
		      lqzj = 10
		   end
		end
		
		--太玄之重，不加怒
		if WAR.TXZZ == 1 then
		--无名，mmzs10
		elseif WAR.MMZS == 10 then
		--琴棋书画之持瑶琴不加怒
		elseif WAR.QQSH1 > 0 then
		elseif WAR.LIBAI == 18 then
		--我佛慈悲不加怒		
		elseif WoFo(pid) then
		--被攻击方在金身不灭状态下，不加怒
		elseif WAR.JSBM[eid] ~= nil then
		--杀意波动
		elseif JY.Person[pid]["人22"] == 1 and JLSD(10, 30, pid) then
		elseif WAR.SYBD[eid] ~= nil then
		elseif WAR.MXD[eid] ~= nil then
		elseif WAR.YYXS[eid] ~= nil then
		elseif match_ID(pid, 15) and JY.Person[15]["阶"] >= 2 then
		else
			if WAR.LQZ[eid] == nil then
				WAR.LQZ[eid] = lqzj + 2
			else
				WAR.LQZ[eid] = WAR.LQZ[eid] + lqzj + 2
			end
		end
		  
		if WAR.LQZ[eid] ~= nil and WAR.LQZ[eid] <= 0 then
			WAR.LQZ[eid] = nil;
		end
		
		--怒气暴发
		if WAR.LQZ[eid] ~=  nil and 100 < WAR.LQZ[eid] then
			WAR.LQZ[eid] = 100
			--东方不败，葵花秘法・化凤为凰
			if match_ID(eid, 27) then
				WAR.Person[enemyid]["特效动画"] = 7
				Set_Eff_Text(enemyid,"特效文字1","葵花秘法・化凤为凰");
			elseif match_ID(eid, 673) then
			       WAR.Person[enemyid]["特效动画"] = 6
				   Set_Eff_Text(enemyid,"特效文字1","杀意波动")
			elseif match_ID(eid, 681) then
			       WAR.Person[enemyid]["特效动画"] = 115
				   Set_Eff_Text(enemyid,"特效文字1","疯血爆发")	   
			elseif match_ID(eid, 114) or match_ID(eid, 652) or match_ID(eid, 149) then
			       WAR.Person[enemyid]["特效动画"] = 104
				   Set_Eff_Text(enemyid,"特效文字1","业由心生，回转有道")
				   if WAR.FXDS[eid] ~= nil then
					WAR.FXDS[eid] = nil
					WAR.FXXS[eid] = nil
				   end
				   WAR.LQZ[eid] = nil
				   JY.Person[eid]["受伤程度"] = 0
				   WAR.YYXS[eid] = 15
			else
				WAR.Person[enemyid]["特效动画"] = 6
				Set_Eff_Text(enemyid,"特效文字1","怒气爆发");
			end
			--瞬息暴怒清空封穴
			if Curr_QG(eid,150) and WAR.JESS[eid] == nil then
				if WAR.FXDS[eid] ~= nil then
					WAR.FXDS[eid] = nil
					WAR.FXXS[eid] = nil
				end
			end
			--冷却减少
			for i = 1, 4 do
			local w = JY.Person[eid]["天赋外功"..i]
			    if WAR.KungfuLQ[eid][w] ~= nil then
				   WAR.KungfuLQ[eid][w] = WAR.KungfuLQ[eid][w] - 2
				   if WAR.KungfuLQ[eid][w] <= 0 then
				      WAR.KungfuLQ[eid][w] = nil
				   end	  
				end
			end
			if WAR.KungfuLQ[eid][JY.Person[eid]["天赋内功"]] ~= nil then
				   WAR.KungfuLQ[eid][JY.Person[eid]["天赋内功"]] = WAR.KungfuLQ[eid][JY.Person[eid]["天赋内功"]] - 2
				   if WAR.KungfuLQ[eid][JY.Person[eid]["天赋内功"]] <= 0 then
				      WAR.KungfuLQ[eid][JY.Person[eid]["天赋内功"]] = nil
				   end	  
			end
		end
	end

	--王重阳在北斗七闪状态下不会被清怒
	if not (match_ID(eid, 129) and WAR.CYZX[eid] ~= nil and WAR.BDQS > 0) then
	  if not (match_ID(eid, 112) and WAR.ZHRM[eid] ~= nil and WAR.XYS > 0) then
		--指法大招清一半怒
		if WAR.LXYZ == 1 and DWPD() and WAR.LQZ[eid] ~= nil then
			WAR.LQZ[eid] = math.modf(WAR.LQZ[eid] * 0.5)
		end
		
	--吸星吸怒，斗转不触发   
	if Curr_NG(pid,88) and pid == 0 and WAR.LQZ[eid] ~= nil and DWPD() and JLSD(25, 50 + math.modf(JY.Person[pid]["实战"]/20), pid) and match_ID(eid, 673) == false and WAR.YYXS[pid] == nil then
		local XLZ= nil
		XLZ = math.modf(WAR.LQZ[eid] * 0.5)
		if XLZ > 20 then
		XLZ = 20
        end
		WAR.LQZ[eid] = WAR.LQZ[eid] - XLZ
		WAR.BMSGXL =WAR.BMSGXL+XLZ
		Set_Eff_Text(enemyid,"特效文字5","吞噬星空");
	end
	
	if match_ID(pid, 693) and JY.Person[693]["阶"] >= 1 and WAR.LQZ[pid] ~= 100 and DWPD() and WAR.YYXS[pid] == nil then
	   WAR.LQZ[pid] = WAR.LQZ[pid] + 5 + math.random(5)
	   if WAR.LQZ[pid] > 100 then
	      WAR.LQZ[pid] = 100
		  WarDrawMap(0)
		  CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
	   end	  
	end
		
		--菩提清心清一半怒
		if WAR.QQSH1 == 2 and DWPD() and WAR.LQZ[eid] ~= nil then
			WAR.LQZ[eid] = math.modf(WAR.LQZ[eid] * 0.5)
		end
		
		--我佛慈悲
		if WoFo(pid) and DWPD() and WAR.LQZ[eid] ~= nil then
			WAR.LQZ[eid] = math.modf(WAR.LQZ[eid] * 0.5)
		end		
		
		--触发太玄之重时，敌方已经暴怒的话，则有几率清怒，斗转不触发
		if WAR.TXZZ == 1 and WAR.LQZ[eid] ~= nil and WAR.LQZ[eid] == 100 and WAR.DZXY ~= 1 and JLSD(0, 50 + JY.Base["天书数量"]*2 + math.modf(JY.Person[pid]["实战"]/25), pid) then
			WAR.LQZ[eid] = WAR.LQZ[eid] - 20
			Set_Eff_Text(enemyid,"特效文字1","救赵挥金锤.邯郸先震惊");
		end
		
		--怨忿莫名
		if  wugong == 199 and match_ID(pid, 671) and WAR.MMZS == 10 and math.random(100)< 50 and WAR.LQZ[eid] ~= nil then
		   WAR.LQZ[eid] = math.modf(WAR.LQZ[eid] * 0.5)
		   Set_Eff_Text(enemyid,"特效文字1","剑灵压魄");
		end
	end
	end
  
	--成不忧 被令狐冲 秒杀
	if WAR.ZDDH == 205 and eid == 141 then
		WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
		JY.Person[eid]["生命"] = 0
	end
	if wugong == 223 then
	   WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
	   JY.Person[eid]["生命"] = 0
	end
	--丁鹏
	if match_ID(pid, 691) and JY.Wugong[wugong]["武功类型"] == 4 then
	local rate = JY.Person[eid]["生命"]/JY.Person[eid]["生命最大值"]
	if rate < 0.01 then
	   rate = 0.01
	end   
	     if rate < 0.3 then
		    if math.random(100) <= 3 + 2.1/rate then
			   WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
	           JY.Person[eid]["生命"] = 0
			end
		 end
	end
	if WAR.Defup[eid] == 1 and match_ID(pid, 691) and JY.Person[691]["天2"] == 2 and JY.Person[pid]["武器"] == 319 then
	   WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
	   JY.Person[eid]["生命"] = 0
	end   
	
	--丁敏君 被周芷若 秒杀
	if WAR.ZDDH == 279 and eid == 632 then
		WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
		JY.Person[eid]["生命"] = 0
	end
	
	--[[无名秒杀
	if match_ID(pid, 671) and JY.Person[pid]["六如觉醒"] == 6 then 
	   if JY.Base["难度"] == 1 and JY.Person[eid]["生命最大值"] <= 600 then
	      WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"]
		  JY.Person[eid]["生命"] = 0
	   elseif (JY.Base["难度"] == 2 or JY.Base["难度"] == 3) and JY.Person[eid]["生命最大值"] <= 900 then
	      WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"]
		  JY.Person[eid]["生命"] = 0
	   elseif (JY.Base["难度"] == 4 or JY.Base["难度"] == 5) and JY.Person[eid]["生命最大值"] <= 1200 then
	      WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"]
		  JY.Person[eid]["生命"] = 0
       elseif (JY.Base["难度"] == 6 or JY.Base["难度"] == 7) and JY.Person[eid]["生命最大值"] <= 1500 then
	      WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"]
		  JY.Person[eid]["生命"] = 0
       end
    end]]
  
	--铁掌，高机率造成内伤12~15点
	if wugong == 13 and JLSD(30, 90, pid) and DWPD() then
	local t = 0
	if tg ~= 1 then 
	   if fx > 0 then
		  t = t + fx*2	 
	   end
	else
		  t = t + yang*2	 	
	end
	WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(12+t, 15+t));
	end
	
	if WAR.WLDF == 3 then
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(50, 60))
	end
	
	--贝海石
	if match_ID(pid, 85) and wugong == 239 and math.random(100) < 35 then
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(10, 17))
	end
	
	if JY.Person[pid]["人22"] == 1 and math.random(100) < 20 then
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(14, 25))
	end
	
	
	--七伤拳，机率造成内伤17点
	if wugong == 23 and (WAR.YZQS == 3 or WAR.YZQS == 7) then
		local ns = 37
		--谢逊额外造成+7
		if match_ID(pid, 13) then
			ns = ns + 7
		end
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", ns);
		--当自己内力值低于5000时，会受到内伤
		if JY.Person[pid]["内力"] < 5000  and JY.Person[pid]["内力最大值"] < 9999 then
			WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", 7);
		end
	end
	
	--不知道干嘛的
	if eid == -1 then
		local x, y = nil, nil
		while true do
			x = math.random(63)
			y = math.random(63)
			if not SceneCanPass(x, y) or GetWarMap(x, y, 2) < 0 then
				SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 2, -1)
				SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 5, -1)
				WAR.Person[enemyid]["坐标X"] = x
				WAR.Person[enemyid]["坐标Y"] = y
				SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 2, enemyid)
				SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 5, WAR.Person[enemyid]["贴图"])
				break;
			end
		end
	end
  
	--判断是否可以加实战
	if JY.Person[eid]["生命"] <= 0 and DWPD() and WAR.SZJPYX[eid] == nil and JY.Person[pid]["实战"] <= 500 then
		--崆峒派战斗、高升客栈杀欧阳克、家里练功房、全真教练功、青城派练功、少林练功   不加实战
		local wxzd = {17, 67, 226, 220, 224, 219, 79, 329}
		local wx = 0
		for i = 1, 8 do
			if WAR.ZDDH == wxzd[i] then
				wx = 1
			end
		end
		
		--丐帮门口
		if WAR.ZDDH == 82 and GetS(10, 0, 18, 0) == 1 then
			wx = 1
		end
		--木人巷
		if WAR.ZDDH == 214 and GetS(10, 0, 19, 0) == 1 then
			wx = 1
		end
		
		if wx == 0 then--and inteam(pid) then
			local szexp = 1
			if eid < 191 and 0 < eid then
				szexp = WARSZJY[eid]
			end
			if eid == 642 then
			   szexp = JY.Person[642]["天1"]
			end
			JY.Person[pid]["感悟点"] = JY.Person[pid]["感悟点"] + szexp*2
			if JY.Person[pid]["感悟点"] > 1000 then
			   JY.Person[pid]["感悟点"] = 1000
			else 
			   if pid == 0 then
			      JY.Person[pid]["感悟"] = JY.Person[pid]["感悟"] + szexp*2
			   end
			end   
			JY.Person[pid]["实战"] = JY.Person[pid]["实战"] + szexp
			if JY.Person[pid]["实战"] > 500 then
				JY.Person[pid]["实战"] = 500
			end
			if match_ID(pid, 5) and JY.Person[pid]["实战"]<500 then
			local ZJB = {"攻击力","防御力","轻功","拳掌功夫","御剑能力","指法技巧","耍刀技巧","特殊兵器","武学常识"}
			local ZSF = math.random(9)
			AddPersonAttrib(pid, ZJB[ZSF], 1)
			if pid == 0 then
			DrawStrBoxWaitKey(JY.Person[pid]["姓名"]..ZJB[ZSF].."提高了1点", C_ORANGE, CC.DefaultFont)
			end
			end
			WAR.SZJPYX[eid] = 1
		end
		
		
		--专精一
		if JY.Person[pid]["实战"] > 229 and JY.Base["天书数量"] >= 1 then
		--sssid
		if (pid == 0 and JY.Person[0]["专1"] == 999) or (JY.Person[0]["专1"] > 0 and inteam(pid) and JY.Person[pid]["专1"] == 0) then 
	local k = JY.Wugong;
	local menu = {}
	for i = 1, 239 do
		local kfname = k[i]["名称"]
		if string.len(kfname) == 10 then
			kfname = kfname.." : "
		elseif string.len(kfname) == 8 then
			kfname = kfname.."   : "
		elseif string.len(kfname) == 6 then
			kfname = kfname.."     : "
		elseif string.len(kfname) == 4 then--43,91,113,143,151,152,167,168,172,173,182,190,191,192,195,200,202,203,204,205,209,210,211,212,213,214
			kfname = kfname.."       : "
		end
		if ZJINS[i] ~= nil then
		   kfname = kfname..ZJINS[i]
		end
		menu[i] = {kfname,nil,2}
		
		
		if k[i]["积分"] > 0 and i ~= 23 and ((k[i]["武功类型"] > 0 and k[i]["武功类型"] < 6 and k[i]["攻击力10"] <= 800) or (k[i]["武功类型"] == 6 and k[i]["积分"] < 40) or k[i]["武功类型"] == 7) and ZJINS[i] ~= nil then
			menu[i][3] = 1
		end
		
	end
	    if match_ID(pid, 689) then
		   for i = 226, 235 do
		       if ZJINS[i] ~= nil then
		       menu[i][3] = 1
			   end
		   end
		end
	local nexty = CC.ScreenH/4-CC.DefaultFont*4 + CC.SingleLineHeight
	local r = ShowMenu2(menu, #menu, 1, 13, CC.ScreenW/2-CC.DefaultFont*13-30, nexty, 0, 0, 1, 0, CC.DefaultFont, C_ORANGE, C_WHITE,JY.Person[pid]["姓名"].."||选择专精武功")
		if r>0 then
        JY.Person[pid]["专1"] = r
		   if r == 3 then
		      AddPersonAttrib(pid, "攻击带毒", 50)
		   end
		   if r == 12 then
		      AddPersonAttrib(pid, "拳掌功夫", 30)
			  AddPersonAttrib(pid, "御剑能力", 30)
		   end
		   if r == 31 or r == 53 then
		      AddPersonAttrib(pid, "防御力", 30)
		   end
		   if r == 32 then
		      AddPersonAttrib(pid, "御剑能力", 30)
		   end
		   if r == 56 then
		      AddPersonAttrib(pid, "防御力", 20)
			  AddPersonAttrib(pid, "攻击力", 20)
			  AddPersonAttrib(pid, "轻功", 20)
		   end
		   if r == 72 then
		      AddPersonAttrib(pid, "特殊兵器", 50)
		   end
		   if r == 129 then
		      AddPersonAttrib(pid, "轻功", 40)
		   end
		   if r == 165 then
		      AddPersonAttrib(pid, "特殊兵器", 50)
		   end
		   if r == 166 then
		      AddPersonAttrib(pid, "防御力", 30)
			  AddPersonAttrib(pid, "攻击力", 30)
			  AddPersonAttrib(pid, "轻功", 30)
		   end
		   if r == 178 or r == 179 then
			  AddPersonAttrib(pid, "轻功", 30)
		   end
		   if r == 233 then
		      local wg = math.random(226,235)
			  if wg == 227 or wg == 230 or wg == 233 then
			     wg = wg + 1
			  end
		      JY.Person[690]["武功2"] = wg
			  JY.Person[690]["武功等级2"] = 999
		   end
		   for i = 1, JY.Person[671]["品德"] do
		       if JY.Person[pid]["武功"..i] == JY.Person[pid]["专1"] and JY.Person[pid]["武功等级"..i] == 900 and (JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] == 6 or JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] == 7) then
			      JY.Person[pid]["武功等级"..i] = 999
			   end
		   end
		end
		DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟"..k[r]["名称"].."精髓", C_ORANGE, CC.DefaultFont)
		end
		end
		
		--专精二
		if pid == 0 and JY.Person[0]["专2"] == 999 and JY.Person[pid]["实战"] > 449 and JY.Base["天书数量"] >= 5 then
	local k = JY.Wugong;
	local menu = {}
	for i = 1, 239 do
		local kfname = k[i]["名称"]
		if string.len(kfname) == 10 then
			kfname = kfname.." : "
		elseif string.len(kfname) == 8 then
			kfname = kfname.."   : "
		elseif string.len(kfname) == 6 then
			kfname = kfname.."     : "
		elseif string.len(kfname) == 4 then--43,91,113,143,151,152,167,168,172,173,182,190,191,192,195,200,202,203,204,205,209,210,211,212,213,214
			kfname = kfname.."       : "
		end
		if ZJINS[i] ~= nil then
		   kfname = kfname..ZJINS[i]
		end
		menu[i] = {kfname,nil,2}
		
		
		if k[i]["积分"] > 0 and ((k[i]["武功类型"] > 0 and k[i]["武功类型"] < 6 and k[i]["攻击力10"] > 800 or i == 23) or (k[i]["武功类型"] == 6 and k[i]["积分"] >= 40)) and ZJINS[i] ~= nil then
			menu[i][3] = 1
		end
	end
	    menu[#menu+1] = {"左右互搏   ：几率提高25%，伤害提高25% ", nil, 1}
		menu[#menu+1] = {"斗转星移   ：敌方下回合不能用被反击击中的武功 ", nil, 1}
		menu[#menu+1] = {"暗器       ：暗器+100。战斗结束随机获得暗器，暗器伤害加倍，至少为250", nil, 1}
		menu[#menu+1] = {"医         ：医疗+100。友方时序回复生命值，中毒，内伤，行动后回血15% ", nil, 1}
		menu[#menu+1] = {"毒         ：用毒+100。攻击带毒999，中毒的敌人会同时有虚弱状态 ", nil, 1}
	local nexty = CC.ScreenH/4-CC.DefaultFont*4 + CC.SingleLineHeight
	local r = ShowMenu2(menu, #menu, 1, 13, CC.ScreenW/2-CC.DefaultFont*13-70, nexty, 0, 0, 1, 0, CC.DefaultFont*0.85, C_ORANGE, C_WHITE,JY.Person[pid]["姓名"].."||选择专精武功")
		if r>0 and r<=#menu-5 then
        JY.Person[pid]["专2"] = r
		   if r == 14 then
		      AddPersonAttrib(pid, "拳掌功夫", 30)
			  AddPersonAttrib(pid, "指法技巧", 30)
		   end
		   if r == 21 then
		      AddPersonAttrib(pid, "攻击带毒", 100)
		   end
		   if r == 37 or r == 60 then
		      AddPersonAttrib(pid, "防御力", 40)
			  AddPersonAttrib(pid, "攻击力", 40)
		   end
		   if r == 48 then
			  AddPersonAttrib(pid, "攻击力", 30)
		   end
		   if r == 49 then
		      AddPersonAttrib(pid, "御剑能力", 30)
			  AddPersonAttrib(pid, "指法技巧", 50)
		   end
		   if r == 66 then
		      AddPersonAttrib(pid, "拳掌功夫", 50)
			  AddPersonAttrib(pid, "耍刀技巧", 50)
			  AddPersonAttrib(pid, "攻击力", 50)
		   end
		   if r == 77 then
		      AddPersonAttrib(pid, "御剑能力", 40)
			  AddPersonAttrib(pid, "耍刀技巧", 40)
			  AddPersonAttrib(pid, "特殊兵器", 40)
		   end
		   if r == 98 then
		      AddPersonAttrib(pid, "御剑能力", 20)
			  AddPersonAttrib(pid, "耍刀技巧", 20)
			  AddPersonAttrib(pid, "特殊兵器", 20)
			  AddPersonAttrib(pid, "拳掌功夫", 20)
			  AddPersonAttrib(pid, "指法技巧", 20)
		   end
		   if r == 107 then
		      AddPersonAttrib(pid, "武学常识", 70)
		   end
		   for i = 1, JY.Person[671]["品德"] do
		       if JY.Person[pid]["武功"..i] == JY.Person[pid]["专2"] and JY.Person[pid]["武功等级"..i] == 900 and JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] == 6 then
			      JY.Person[pid]["武功等级"..i] = 999
			   end
		   end
		   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟"..k[r]["名称"].."精髓", C_ORANGE, CC.DefaultFont)
		end
		if r == #menu-4 then
		JY.Person[pid]["专2"] = 996
		DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟左右互搏精髓", C_ORANGE, CC.DefaultFont)
		end
		if r == #menu-3 then
		JY.Person[pid]["专2"] = 997
		DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟斗转星移精髓", C_ORANGE, CC.DefaultFont)
		end
		if r == #menu-2 then
		JY.Person[pid]["专2"] = 995
		AddPersonAttrib(pid, "暗器技巧", 100)
		DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟暗器精髓", C_ORANGE, CC.DefaultFont)
		end
		if r == #menu-1 then
		JY.Person[pid]["专2"] = 994
		AddPersonAttrib(pid, "医疗能力", 100)
		DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟医疗精髓", C_ORANGE, CC.DefaultFont)
		end
		if r == #menu then
		JY.Person[pid]["专2"] = 993
		AddPersonAttrib(pid, "攻击带毒", 999)
		AddPersonAttrib(pid, "用毒能力", 100)
		DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟用毒精髓", C_ORANGE, CC.DefaultFont)
		end
		
		end
		--cd
		if JY.Person[123]["天2"] == 1 and pid == 0 then
		for j = 1, 3 do
		if JY.Person[0]["实战"] >= j*200-150 and JY.Person[260+j]["声望"] == 0 then
		local cd = {"无","一","二","三","四","五","六","七","八"}
		local k = JY.Wugong;
	    local menu = {}
	    for i = 1, 237 do
		local kfname = k[i]["名称"]
		if string.len(kfname) == 10 then
			kfname = kfname.."  冷却"..cd[KungfuCD(pid, i)+1].." "
		elseif string.len(kfname) == 8 then
			kfname = kfname.."    冷却"..cd[KungfuCD(pid, i)+1].." "
		elseif string.len(kfname) == 6 then
			kfname = kfname.."      冷却"..cd[KungfuCD(pid, i)+1].." "
		elseif string.len(kfname) == 4 then
			kfname = kfname.."        冷却"..cd[KungfuCD(pid, i)+1].." "
		end
		menu[i] = {kfname,nil,2}
		if k[i]["武功类型"] ~= 7 then
			menu[i][3] = 1
		end
		end
		local nexty = CC.ScreenH/4-CC.DefaultFont*4 + CC.SingleLineHeight
		local r = ShowMenu2(menu, #menu, 3, 8, CC.ScreenW/2-CC.DefaultFont*13-30, nexty, 0, 0, 1, 0, CC.DefaultFont, C_ORANGE, C_WHITE,JY.Person[pid]["姓名"].."||选择武功冷却减少")
		if r>0 then
        JY.Person[260+j]["声望"] = r
		end
		end
		end
		end
		--plu
		--[[if pid == 0 and JY.Person[123]["天1"] == 4 then
		   if JY.Person[pid]["实战"] >= 300 and JY.Person[0]["天4"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "魔高一丈：内力上限增加2500*有无相生：35%几率减少35%所受伤害*道法自然：集气速度+15，集气不受异常状态影响 *大器晚成：武功学满后，所有武功威力+700",{"魔高一丈","有无相生","道法自然","大器晚成"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天4"] = 1
					   DrawStrBoxWaitKey("领悟【Ｇ魔高一丈Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天4"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ有无相生Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then   
					   JY.Person[0]["天4"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ道法自然Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then   
					   JY.Person[0]["天4"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ大器晚成Ｏ】", C_ORANGE, CC.DefaultFont, 2)    
                    end	  
	            
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 150 and JY.Person[0]["天3"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "罗袜生尘：15%几率闪避，攻击后可移动2格 *融会贯通：所有武功威力至少1300*          攻击附带目标2%当前生命值 *所向披靡：攻击无视50%防御*锦上添花：增加一次连击 ",{"罗袜生尘","融会贯通","所向披靡","锦上添花"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天3"] = 1
					   DrawStrBoxWaitKey("领悟【Ｇ罗袜生尘Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天3"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ融会贯通Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then
					   JY.Person[0]["天3"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ所向披靡Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then
					   JY.Person[0]["天3"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ锦上添花Ｏ】", C_ORANGE, CC.DefaultFont, 2)   
                    end	  
	            
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 60 and JY.Person[0]["天2"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "世仇未报：时序增加1点怒气*杀意骤起：攻击强制杀气*浴血奋战：生命值越低，造成的伤害越高*朴实无华：普通攻击加强",{"世仇未报","杀意骤起","浴血奋战","朴实无华"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天2"] = 1
					   DrawStrBoxWaitKey("领悟【Ｇ世仇未报Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天2"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ杀意骤起Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then
					   JY.Person[0]["天2"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ浴血奋战Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then
					   JY.Person[0]["天2"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ朴实无华Ｏ】", C_ORANGE, CC.DefaultFont, 2)    
                    end	  
	            
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 3 and JY.Person[0]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "道高一尺：生命上限增加500*自强不息：根据已损失生命，时序回复生命值*坚韧不拔：每次受到攻击恢复一定血量*福星高照：特效几率增加12% ",{"道高一尺","自强不息","坚韧不拔","福星高照"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天1"] = 1
					   JY.Person[0]["生命最大值"] = JY.Person[0]["生命最大值"] + 500
					   DrawStrBoxWaitKey("领悟【Ｇ道高一尺Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天1"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ自强不息Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then
					   JY.Person[0]["天1"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ坚韧不拔Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then
					   JY.Person[0]["天1"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ福星高照Ｏ】", C_ORANGE, CC.DefaultFont, 2)   
                    end	  
	            
					ClsN()
				end
		end
		if pid == 0 and JY.Person[123]["天1"] == 3 then
	
				if JY.Person[pid]["实战"] >= 280 and JY.Person[0]["天3"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "罗袜生尘：15%几率闪避，攻击后可移动2格 *融会贯通：所有武功威力至少1300*          攻击附带目标2%当前生命值 *所向披靡：攻击无视50%防御*锦上添花：增加一次连击 ",{"罗袜生尘","融会贯通","所向披靡","锦上添花"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天3"] = 1
					   DrawStrBoxWaitKey("领悟【Ｇ罗袜生尘Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天3"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ融会贯通Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then
					   JY.Person[0]["天3"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ所向披靡Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then
					   JY.Person[0]["天3"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ锦上添花Ｏ】", C_ORANGE, CC.DefaultFont, 2)   
                    end	  
	            
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 160 and JY.Person[0]["天2"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "世仇未报：时序增加1点怒气*杀意骤起：攻击强制杀气*浴血奋战：生命值越低，造成的伤害越高*朴实无华：普通攻击加强",{"世仇未报","杀意骤起","浴血奋战","朴实无华"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天2"] = 1
					   DrawStrBoxWaitKey("领悟【Ｇ世仇未报Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天2"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ杀意骤起Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then
					   JY.Person[0]["天2"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ浴血奋战Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then
					   JY.Person[0]["天2"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ朴实无华Ｏ】", C_ORANGE, CC.DefaultFont, 2)    
                    end	  
	            
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 40 and JY.Person[0]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "道高一尺：生命上限增加500*自强不息：根据已损失生命，时序回复生命值*坚韧不拔：每次受到攻击恢复一定血量*福星高照：特效几率增加12% ",{"道高一尺","自强不息","坚韧不拔","福星高照"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天1"] = 1
					   JY.Person[0]["生命最大值"] = JY.Person[0]["生命最大值"] + 500
					   DrawStrBoxWaitKey("领悟【Ｇ道高一尺Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天1"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ自强不息Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then
					   JY.Person[0]["天1"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ坚韧不拔Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then
					   JY.Person[0]["天1"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ福星高照Ｏ】", C_ORANGE, CC.DefaultFont, 2)   
                    end	  
	            
					ClsN()
				end
		end
		if pid == 0 and JY.Person[123]["天1"] == 2 then
		   	
				if JY.Person[pid]["实战"] >= 150 and JY.Person[0]["天2"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "世仇未报：时序增加1点怒气*杀意骤起：攻击强制杀气*浴血奋战：生命值越低，造成的伤害越高*朴实无华：普通攻击加强",{"世仇未报","杀意骤起","浴血奋战","朴实无华"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天2"] = 1
					   DrawStrBoxWaitKey("领悟【Ｇ世仇未报Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天2"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ杀意骤起Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then
					   JY.Person[0]["天2"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ浴血奋战Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then
					   JY.Person[0]["天2"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ朴实无华Ｏ】", C_ORANGE, CC.DefaultFont, 2)    
                    end	  
	            
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 50 and JY.Person[0]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "道高一尺：生命上限增加500*自强不息：根据已损失生命，时序回复生命值*坚韧不拔：每次受到攻击恢复一定血量*福星高照：特效几率增加12% ",{"道高一尺","自强不息","坚韧不拔","福星高照"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天1"] = 1
					   JY.Person[0]["生命最大值"] = JY.Person[0]["生命最大值"] + 500
					   DrawStrBoxWaitKey("领悟【Ｇ道高一尺Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天1"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ自强不息Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then
					   JY.Person[0]["天1"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ坚韧不拔Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then
					   JY.Person[0]["天1"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ福星高照Ｏ】", C_ORANGE, CC.DefaultFont, 2)   
                    end	  
	            
					ClsN()
				end
		end
		if pid == 0 and JY.Person[123]["天1"] == 1 then
				if JY.Person[pid]["实战"] >= 60 and JY.Person[0]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "道高一尺：生命上限增加500*自强不息：根据已损失生命，时序回复生命值*坚韧不拔：每次受到攻击恢复一定血量*福星高照：特效几率增加12% ",{"道高一尺","自强不息","坚韧不拔","福星高照"},4,516)
	                if wh == 1 then
		               JY.Person[0]["天1"] = 1
					   JY.Person[0]["生命最大值"] = JY.Person[0]["生命最大值"] + 500
					   DrawStrBoxWaitKey("领悟【Ｇ道高一尺Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            elseif wh == 2 then	 
		               JY.Person[0]["天1"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ自强不息Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 3 then
					   JY.Person[0]["天1"] = 3
					   DrawStrBoxWaitKey("领悟【Ｇ坚韧不拔Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					elseif wh == 4 then
					   JY.Person[0]["天1"] = 4
					   DrawStrBoxWaitKey("领悟【Ｇ福星高照Ｏ】", C_ORANGE, CC.DefaultFont, 2)   
                    end	  
	            
					ClsN()
				end
		end]]
		--段思平
		if match_ID(pid, 687) and pid == 0 then
		
				if JY.Person[pid]["实战"] >= 50 and JY.Person[687]["天1"] == 0 then
				    AddPersonAttrib(0, "指法技巧", 50)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."指法提高", C_ORANGE, CC.DefaultFont)	
	                JY.Person[687]["天1"] = 1
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 180 and JY.Person[687]["天2"] == 0 and JY.Base["天书数量"] >= 1 then
                    local wh = JYMsgBox("请选择领悟天赋", "一品一阳：*一阳指可以提升到一品   *剑气无双：*六脉神剑范围+2",{"一品一阳","剑气无双"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[687]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【一品一阳】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[687]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【剑气无双】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 320 and JY.Person[687]["天3"] == 0 and JY.Base["天书数量"] >= 3 then
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【双树枯荣】", C_ORANGE, CC.DefaultFont)	  
	                JY.Person[687]["天3"] = 1
					ClsN()
				end
		end
		--赵云
		if match_ID(pid, 688) and pid == 0 then
		
				if JY.Person[pid]["实战"] >= 35 and JY.Person[688]["天1"] == 0 and JY.Base["天书数量"] >= 1 then
				local wh = JYMsgBox("请选择领悟天赋", "冲锋陷阵：*集气不会暂停，最低30   *骁勇善战：*每时序武功威力提升3",{"冲锋陷阵","骁勇善战"},2,JY.Person[pid]["头像代号"])
					if wh == 1 then
		               JY.Person[688]["天1"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【冲锋陷阵】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[688]["天1"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【骁勇善战】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 160 and JY.Person[688]["天2"] == 0 and JY.Base["天书数量"] >= 3 then
                    local wh = JYMsgBox("请选择领悟天赋", "势如破竹：*无视70%防御    *疾风骤雨：*必连击，几率三连    ",{"势如破竹","疾风骤雨"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[688]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【势如破竹】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[688]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【疾风骤雨】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 400 and JY.Person[688]["天3"] == 0 and JY.Base["天书数量"] >= 5 then
					local wh = JYMsgBox("请选择领悟天赋", "浑身是胆：*可以连续行动两次*一雷二闪：*12%几率闪避，闪避后使用龙啸穿云枪反击",{"浑身是胆","一雷二闪"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[688]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【浑身是胆】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[688]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【一雷二闪】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
		end
		--张君宝顿悟
		if match_ID(pid, 5) and pid == 0 then
				if JY.Person[pid]["实战"] >499 and JY.Person[5]["品德"]==99 then
					instruct_35(5,4,171,999)
					JY.Person[5]["品德"]=JY.Person[5]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟武功【Ｇ太极神功Ｏ】", C_ORANGE, CC.DefaultFont, 2)
					
					JY.Person[0]["头像代号"]=JY.Person[5]["头像代号"]
		            for i=1,5 do
			            JY.Person[0]["出招动画帧数" .. i]=JY.Person[5]["出招动画帧数" .. i]
			            JY.Person[0]["出招动画延迟" .. i]=JY.Person[5]["出招动画延迟" .. i]
			            JY.Person[0]["武功音效延迟" .. i]=JY.Person[5]["武功音效延迟" .. i]
		            end
				elseif JY.Person[pid]["实战"]>400 and JY.Person[5]["品德"]==98 then
					instruct_35(5,3,46,999)
					SetTianWai(5,2,46)
					JY.Person[5]["品德"]=JY.Person[5]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟武功【Ｇ太极剑法Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>300 and JY.Person[5]["品德"]==97 then
					instruct_35(5,2,149,999)
					SetTianQing(5,149)
					JY.Person[5]["品德"]=JY.Person[5]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟武功【Ｇ梯云纵横Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>200 and JY.Person[5]["品德"]==96 then
					instruct_35(5,1,99,999)
					SetTianNei(5,99)
					JY.Person[5]["品德"]=JY.Person[5]["品德"]+1
					JY.Person[0]["姓名"]="张三丰"
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟武功【Ｇ纯阳无极功Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>100 and JY.Person[5]["品德"]==95 then
					instruct_35(5,0,16,999)
					SetTianWai(5,1,16)
					JY.Person[5]["品德"]=JY.Person[5]["品德"]+1
					
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟武功【Ｇ太极拳法Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				end
		end
		--聂风
		if match_ID(pid, 681) and pid == 0 then
				if JY.Person[pid]["实战"] >300 and JY.Person[681]["品德"]==5 then
				    JY.Person[681]["品德"]=JY.Person[681]["品德"]+1
					AddPersonAttrib(0, "攻击力", 20)
					AddPersonAttrib(0, "防御力", 10)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【神风怒嚎】，集气速度、防御力、攻击力提升", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["实战"]>230 and JY.Person[681]["品德"]==4 then
				    JY.Person[681]["品德"]=JY.Person[681]["品德"]+1
					AddPersonAttrib(0, "轻功", 20)
					AddPersonAttrib(0, "防御力", 10)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【风卷楼残】，集气速度、防御力、轻功提升", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["实战"]>160 and JY.Person[681]["品德"]==3 then
				    JY.Person[681]["品德"]=JY.Person[681]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【雷厉风行】，集气速度提升", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["实战"]>100 and JY.Person[681]["品德"]==2 then
				    JY.Person[681]["品德"]=JY.Person[681]["品德"]+1
					AddPersonAttrib(0, "攻击力", 10)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【暴雨狂风】，集气速度、攻击力提升", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["实战"]>50 and JY.Person[681]["品德"]==1 then
				    JY.Person[681]["品德"]=JY.Person[681]["品德"]+1
					AddPersonAttrib(0, "防御力", 10)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【风中劲草】，集气速度、防御力提升", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["实战"]>10 and JY.Person[681]["品德"]==0 then
					JY.Person[681]["品德"]=JY.Person[681]["品德"]+1
					AddPersonAttrib(0, "轻功", 20)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【捕风捉影】，集气速度、轻功提升", C_ORANGE, CC.DefaultFont)	
				end
					
					
				if JY.Person[pid]["实战"] >= 10 and JY.Person[681]["天1"] == 0 and JY.Base["天书数量"] >= 1 then
                    local wh = JYMsgBox("请选择领悟能力", "聂家步法：*集气速度提高10  *急转步法：*15%几率闪避攻击      ",{"聂家步法","急转步法"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[681]["天1"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【聂家步法】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[681]["天1"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【急转步法】", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 80 and JY.Person[681]["天2"] == 0 and JY.Base["天书数量"] >= 3 then
                    local wh = JYMsgBox("请选择领悟能力", "暴击提高：*暴击几率随兵器值提高 *连击提高：*连击几率随兵器值提高  ",{"暴击提高","连击提高"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[681]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."暴击提高", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[681]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."连击提高", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 220 and JY.Person[681]["天3"] == 0 and JY.Base["天书数量"] >= 5 then
                    local wh = JYMsgBox("请选择领悟能力", "创刀：*刀法攻击敌方兵器值视为0*魔刀：*刀法攻击造成流血，按百分比时序损失生命值  ",{"创刀","魔刀"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[681]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【创刀】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[681]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【魔刀】", C_ORANGE, CC.DefaultFont)
                    end	  
	                AddPersonAttrib(0, "耍刀技巧", 50)
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 400 and JY.Person[681]["天4"] == 0 and JY.Base["天书数量"] >= 7 then
                    local wh = JYMsgBox("请选择领悟天赋", "摩诃无量：*攻击范围+2，所有武功威力提高25% *天道无极：*攻击范围-3，攻击伤害提高75%",{"摩诃无量","天道无极"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[681]["天4"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【摩诃无量】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[681]["天4"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【天道无极】", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
		end
		--逍遥子
		if match_ID(pid, 634) and pid == 0 then
				if JY.Person[pid]["实战"] >390 and JY.Person[634]["声望"]==4 then
				    JY.Person[634]["声望"]=JY.Person[634]["声望"]+1
					JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 50
					AddPersonAttrib(0, "攻击力", 20)
					AddPersonAttrib(0, "防御力", 20)
					AddPersonAttrib(0, "轻功", 20)
					AddPersonAttrib(0, "拳掌功夫", 20)
					AddPersonAttrib(0, "指法技巧", 20)
					AddPersonAttrib(0, "御剑能力", 20)
					AddPersonAttrib(0, "耍刀技巧", 20)
					AddPersonAttrib(0, "特殊兵器", 20)
					instruct_35(634,5,98,999)
					AddPersonAttrib(0, "武学常识", 20)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【小无相功】，攻防轻五系兵器值+20，武学常识+20", C_ORANGE, CC.DefaultFont)
				elseif JY.Person[pid]["实战"]>290 and JY.Person[634]["声望"]==3 then
				    JY.Person[634]["声望"]=JY.Person[634]["声望"]+1
					JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 50
                    instruct_35(634,4,101,999)
					SetTianNei(634,101)
					AddPersonAttrib(0, "武学常识", 20)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【八荒六合功】，武学常识+20", C_ORANGE, CC.DefaultFont)		
				elseif JY.Person[pid]["实战"]>200 and JY.Person[634]["声望"]==2 then
				    JY.Person[634]["声望"]=JY.Person[634]["声望"]+1
					JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 50
					AddPersonAttrib(0, "御剑能力", 40)
					AddPersonAttrib(0, "武学常识", 20)
					instruct_35(634,3,168,999)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【逍遥神剑】，御剑+40，武学常识+20", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["实战"]>120 and JY.Person[634]["声望"]==1 then
				    JY.Person[634]["声望"]=JY.Person[634]["声望"]+1
					JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 50
					instruct_35(634,2,147,999)
					SetTianQing(634,147)
					AddPersonAttrib(0, "武学常识", 20)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【凌波微步】，武学常识+20", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["实战"]>50 and JY.Person[634]["声望"]==0 then
					JY.Person[634]["声望"]=JY.Person[634]["声望"]+1
					JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 50
					instruct_35(634,1,85,999)
					AddPersonAttrib(0, "武学常识", 20)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【北冥神功】，武学常识+20", C_ORANGE, CC.DefaultFont)	
				end
					
					
				if JY.Person[pid]["实战"] >= 40 and JY.Person[634]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "逍遥游：*攻击后可以移动  *扶摇直上：*集气速度提高12      ",{"逍遥游","扶摇直上"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[634]["天1"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【逍遥游】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[634]["天1"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【扶摇直上】", C_ORANGE, CC.DefaultFont)
                    end
					JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 50
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 120 and JY.Person[634]["天2"] == 0 and JY.Base["天书数量"] >= 1 then
                    local wh = JYMsgBox("请选择领悟能力", "南冥天池：*内力上限提高至9999，时序恢复15点内力 *冥灵大椿：*生命上限提高500，时序恢复0.5%最大生命值  ",{"南冥天池","冥灵大椿"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[634]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【南冥天池】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[634]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【冥灵大椿】", C_ORANGE, CC.DefaultFont)
                    end
					JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 50
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 250 and JY.Person[634]["天3"] == 0 and JY.Base["天书数量"] >= 3 then
                    local wh = JYMsgBox("请选择领悟能力", "御风而行：*22%几率闪避 *鹏程万里：*移动范围+20        ",{"御风而行","鹏程万里"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[634]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【御风而行】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[634]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【鹏程万里】", C_ORANGE, CC.DefaultFont)
                    end
					JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 50
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 460 and JY.Person[634]["天4"] == 0 and JY.Base["天书数量"] >= 6 then
                    local wh = JYMsgBox("请选择领悟天赋", "遨游无穷：*攻击范围+2，随时有可能直接行动 *鹏游蝶梦：*能复活一次，攻击者代替"..JY.Person[pid]["姓名"].."死亡*被攻击10%几率转化为生命恢复 ",{"遨游无穷","鹏游蝶梦"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[634]["天4"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【遨游无穷】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[634]["天4"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【鹏游蝶梦】", C_ORANGE, CC.DefaultFont)
                    end
					JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 50
	            
					ClsN()
				end
		end
		--黄裳
		if match_ID(pid, 637) and pid == 0 then
		        if JY.Person[pid]["感悟点"]>900 and JY.Person[637]["声望"]==6 then
				    JY.Person[637]["声望"]=JY.Person[637]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【大道归藏】", C_ORANGE, CC.DefaultFont)
		        elseif JY.Person[pid]["感悟点"]>300 and JY.Person[637]["声望"]==5 then
				    JY.Person[637]["声望"]=JY.Person[637]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【蛇行狸翻】，10%概率闪避攻击", C_ORANGE, CC.DefaultFont)
				elseif JY.Person[pid]["感悟点"] >250 and JY.Person[637]["声望"]==4 then
				    JY.Person[637]["声望"]=JY.Person[637]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【闭气秘诀】，气防增加1000", C_ORANGE, CC.DefaultFont)
				elseif JY.Person[pid]["感悟点"]>200 and JY.Person[637]["声望"]==3 then
				    JY.Person[637]["声望"]=JY.Person[637]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【解穴秘诀】，时序减少封穴2点", C_ORANGE, CC.DefaultFont)		
				elseif JY.Person[pid]["感悟点"]>150 and JY.Person[637]["声望"]==2 then
				    JY.Person[637]["声望"]=JY.Person[637]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【点穴秘法】，攻击50%额外概率造成封穴", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["感悟点"]>100 and JY.Person[637]["声望"]==1 then
				    JY.Person[637]["声望"]=JY.Person[637]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【疗伤之法】，时序回复1点生命，减少1点内伤，用药效果提高50%", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["感悟点"]>50 and JY.Person[637]["声望"]==0 then
					JY.Person[637]["声望"]=JY.Person[637]["声望"]+1
					AddPersonAttrib(0, "攻击力", 20)
					AddPersonAttrib(0, "防御力", 20)
					AddPersonAttrib(0, "轻功", 20)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【易筋锻骨】，攻防轻上限提高100", C_ORANGE, CC.DefaultFont)	
				end
				
		end
		--斗酒
		if match_ID(pid, 638) and pid == 0 then
		        if JY.Person[pid]["感悟点"]>700 and JY.Person[638]["声望"]==5 then
				    JY.Person[638]["声望"]=JY.Person[638]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【愈使愈强】，伤害时序增加1点", C_ORANGE, CC.DefaultFont)
				elseif JY.Person[pid]["感悟点"] >500 and JY.Person[638]["声望"]==4 then
				    JY.Person[638]["声望"]=JY.Person[638]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【反弹攻击】，反弹攻击伤害20%给攻击者", C_ORANGE, CC.DefaultFont)
				elseif JY.Person[pid]["感悟点"]>400 and JY.Person[638]["声望"]==3 then
				    JY.Person[638]["声望"]=JY.Person[638]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【金刚不坏】，受到的伤害减少10%", C_ORANGE, CC.DefaultFont)		
				elseif JY.Person[pid]["感悟点"]>300 and JY.Person[638]["声望"]==2 then
				    JY.Person[638]["声望"]=JY.Person[638]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【至阳热气】，攻击几率对全体敌方上灼烧", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["感悟点"]>200 and JY.Person[638]["声望"]==1 then
				    JY.Person[638]["声望"]=JY.Person[638]["声望"]+1
					AddPersonAttrib(0, "攻击力", 20)
					AddPersonAttrib(0, "防御力", 20)
					AddPersonAttrib(0, "轻功", 20)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【易筋洗髓】，兵器值和攻防轻上限提高70", C_ORANGE, CC.DefaultFont)	
				elseif JY.Person[pid]["感悟点"]>100 and JY.Person[638]["声望"]==0 then
					JY.Person[638]["声望"]=JY.Person[638]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【氤氲紫气】，内力上限提高2000", C_ORANGE, CC.DefaultFont)	
				end
				
		end
		--托奇
		if match_ID(pid, 686) and pid == 0 then
		
				if JY.Person[pid]["实战"] >= 65 and JY.Person[686]["天1"] == 0 then
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【秘孔・心灵台】", C_ORANGE, CC.DefaultFont)	
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【秘孔・刹活孔】", C_ORANGE, CC.DefaultFont)
	                JY.Person[686]["天1"] = 1
					AddPersonAttrib(0, "指法技巧", 50)
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 120 and JY.Person[686]["天2"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "暗杀拳：*从背后攻击敌人伤害提高80%   *无想流舞：*根据造成的伤害回复集气",{"暗杀拳","无想流舞"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[686]["天2"] = 1
					   AddPersonAttrib(0, "拳掌功夫", 50)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【暗杀拳】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[686]["天2"] = 2
					   AddPersonAttrib(0, "轻功", 50)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【无想流舞】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 280 and JY.Person[686]["天3"] == 0 and JY.Base["天书数量"] >= 1 then
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【北斗有情断迅拳】", C_ORANGE, CC.DefaultFont)	  
	                JY.Person[686]["天3"] = 1
					AddPersonAttrib(0, "拳掌功夫", 50)
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 470 and JY.Person[686]["天4"] == 0 and JY.Base["天书数量"] >= 3 then
		            JY.Person[686]["天4"] = 1
					instruct_35(0,0,223,999)
					AddPersonAttrib(0, "拳掌功夫", 50)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【北斗有情破颜拳】", C_ORANGE, CC.DefaultFont) 
					ClsN()
				end
		end
		--李白
		if match_ID(pid, 636) and pid == 0 then
		
				if JY.Person[pid]["实战"] >= 300 and JY.Person[636]["天1"] == 0 then
	                JY.Person[636]["天1"] = 1
					instruct_35(636,1,102,30)
					SetTianNei(636,102)
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 100 and JY.Person[636]["天2"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "仗剑天涯：*剑法范围+2       *把酒言欢：*内力上限增加2000",{"仗剑天涯","把酒言欢"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[636]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【仗剑天涯】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[636]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【把酒言欢】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 210 and JY.Person[636]["天3"] == 0 and JY.Base["天书数量"] >= 2 then
					local wh = JYMsgBox("请选择领悟天赋", "托身白刃里：*受到的伤害减少25%       *杀人红尘中：*伤害增加35%",{"托身白刃里","杀人红尘中"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[636]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【托身白刃里】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[636]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【杀人红尘中】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 420 and JY.Person[636]["天4"] == 0 and JY.Base["天书数量"] >= 5 then
		            local wh = JYMsgBox("请选择领悟天赋", "精光射天地：*几率全屏攻击             *雷腾不可冲：*杀气增加3500 ",{"精光射天地","雷腾不可冲"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[636]["天4"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【精光射天地】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[636]["天4"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【雷腾不可冲】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
		end
		--步惊云
		if match_ID(pid, 682) and pid == 0 then
		
				if JY.Person[pid]["实战"] >= 100 and JY.Person[682]["天1"] == 0 then
				    instruct_35(0,0,221,999)
					SetTianWai(0,1,221)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【云十掌】", C_ORANGE, CC.DefaultFont)	  
	                JY.Person[682]["天1"] = 1
					ClsN()
				end	
					
				if JY.Person[pid]["实战"] >= 200 and JY.Person[682]["天2"] == 0 then
                    instruct_35(0,1,222,999)
					SetTianWai(0,2,222)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【云十剑】", C_ORANGE, CC.DefaultFont)	  
	                JY.Person[682]["天2"] = 1
					ClsN()
				end	
				if JY.Person[pid]["实战"] >= 300 and JY.Person[682]["天3"] == 0 and JY.Base["天书数量"] >= 3 then
                    local wh = JYMsgBox("请选择领悟天赋", "摩诃无量：*攻击范围+2，所有武功威力提高25% *天道无极：*攻击范围-3，攻击伤害提高75%",{"摩诃无量","天道无极"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[682]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【摩诃无量】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[682]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【天道无极】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 420 and JY.Person[682]["天4"] == 0 and JY.Base["天书数量"] >= 7 then
				    local wh = JYMsgBox("请选择领悟天赋", "七气归一：*运功同时主运所有内功，消耗提升 *逆乾坤：*可以复活三次，每次复活能力会提高",{"七气归一","逆乾坤"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[682]["天4"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【七气归一】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[682]["天4"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【逆乾坤】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
		end
		--西门吹雪
		if match_ID(pid, 683) and pid == 0 then
		   if JY.Person[pid]["实战"] >= 30 and JY.Person[683]["天1"] == 0 and JY.Base["天书数量"] >= 1 then
                    local wh = JYMsgBox("请选择领悟能力", "连击：*连击几率提高60%  *暴击：*暴击几率提高70%      ",{"连击","暴击"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[683]["天1"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."连击率提高", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[683]["天1"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."暴击率提高", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 100 and JY.Person[683]["天2"] == 0 and JY.Base["天书数量"] >= 3 then
                    local wh = JYMsgBox("请选择领悟能力", "狂风剑：*剑法攻击后下回合集气提前 *无情剑：*敌方生命值越低，伤害越高  ",{"狂风剑","无情剑"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[683]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【狂风剑】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[683]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【无情剑】", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 220 and JY.Person[683]["天3"] == 0 and JY.Base["天书数量"] >= 5 then
                    local wh = JYMsgBox("请选择领悟能力", "剑道巅峰：*御剑上限提高150，御剑+150*剑意纵横：*剑法攻击锁定自身周围7格攻击  ",{"剑道巅峰","剑意纵横"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[683]["天3"] = 1
					   AddPersonAttrib(0, "御剑能力", 150)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【剑道巅峰】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[683]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【剑意纵横】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 370 and JY.Person[683]["天4"] == 0 and JY.Base["天书数量"] >= 7 then
                    local wh = JYMsgBox("请选择领悟天赋", "剑神一笑：*攻击时几率锁定全屏攻击 *心中有剑：*被攻击几率先手全屏反击",{"剑神一笑","心中有剑"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[683]["天4"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【剑神一笑】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[683]["天4"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【心中有剑】", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
		end
		--李寻欢
		if match_ID(pid, 684) and pid == 0 then
		        if JY.Person[pid]["实战"] >= 10 and JY.Person[684]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "拳：拳掌功夫+40*指：指法技巧+40*剑：御剑能力+40*刀：耍刀技巧+40*奇：特殊兵器+40        ",{"拳","指","剑","刀","奇"},5,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               AddPersonAttrib(0, "拳掌功夫", 40)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."拳掌功夫提高", C_ORANGE, CC.DefaultFont)
		            elseif wh == 2 then 
		               AddPersonAttrib(0, "指法技巧", 40)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."指法技巧提高", C_ORANGE, CC.DefaultFont)
					elseif wh == 3 then 
		               AddPersonAttrib(0, "御剑能力", 40)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."御剑能力提高", C_ORANGE, CC.DefaultFont)
					elseif wh == 4 then
		               AddPersonAttrib(0, "耍刀技巧", 40)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."耍刀技巧提高", C_ORANGE, CC.DefaultFont)
					elseif wh == 5 then	 
		               AddPersonAttrib(0, "特殊兵器", 40)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."特殊兵器提高", C_ORANGE, CC.DefaultFont)   
                    end	  
	                JY.Person[684]["天1"] = 1
					ClsN()
				end
		        if JY.Person[pid]["实战"] >= 50 and JY.Person[684]["天2"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "闪避提高：*额外10%几率闪避  *集气加快：*集气速度+10                    ",{"闪避提高","集气加快"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[684]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."闪避提高", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[684]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."集气速度增加", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				
				if JY.Person[pid]["实战"] >= 100 and JY.Person[684]["天3"] == 0 then
				    JY.Person[684]["天3"] = 1
					AddPersonAttrib(0, "暗器技巧", 50)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."暗器技巧提升", C_ORANGE, CC.DefaultFont)
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 160 and JY.Person[684]["天4"] == 0 then
                    JY.Person[684]["天4"] = 1
					AddPersonAttrib(0, "暗器技巧", 50)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."飞刀连击数提升", C_ORANGE, CC.DefaultFont)
					ClsN()	  
				end
		end
		--丁鹏
		if match_ID(pid, 691) and pid == 0 then
		        if JY.Person[pid]["实战"] >= 50 and JY.Person[691]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "刀光剑影：*刀法+50、御剑+50*以剑入刀：*增加御剑值的刀法      ",{"刀光剑影","以剑入刀"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               AddPersonAttrib(0, "耍刀技巧", 50)
					   AddPersonAttrib(0, "御剑能力", 50)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."耍刀技巧，御剑能力提高", C_ORANGE, CC.DefaultFont)
		            elseif wh == 2 then
					   AddPersonAttrib(0, "耍刀技巧", JY.Person[pid]["御剑能力"])
		               DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."耍刀技巧提高", C_ORANGE, CC.DefaultFont) 
                    end	  
	                JY.Person[691]["天1"] = 1
					ClsN()
				end
		        if JY.Person[pid]["实战"] >= 150 and JY.Person[691]["天2"] == 0 and JY.Base["天书数量"] >= 1 then
                    local wh = JYMsgBox("请选择领悟能力", "魔刀：*装备圆月弯刀，所有敌人时序流血+2      *挡者必死：*伤害提高20%，装备圆月弯刀秒杀防御的敌人 ",{"魔刀","挡者必死"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[691]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【魔刀】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[691]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【挡者必死】", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 260 and JY.Person[691]["天3"] == 0 and JY.Base["天书数量"] >= 3 then
				    local wh = JYMsgBox("请选择领悟能力", "我即是刀：*怒气时序+2，攻击按刀系数计算，敌方刀系数视为三分之一 *我仍是我：*攻击范围+3，攻防均按刀系数计算 ",{"我即是刀","我仍是我"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[691]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【我即是刀】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[691]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【我仍是我】", C_ORANGE, CC.DefaultFont)
                    end
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 410 and JY.Person[691]["天4"] == 0 and JY.Base["天书数量"] >= 5 then
                    local wh = JYMsgBox("请选择领悟能力", "傲世狂刀：*攻击几率发动羽葬煌炎斩       *心中无刀：*攻击不造成怒气，容易击中破绽  ",{"傲世狂刀","心中无刀"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[691]["天4"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【傲世狂刀】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[691]["天4"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【心中无刀】", C_ORANGE, CC.DefaultFont)
                    end
					ClsN()	  
				end
		end
		--苏灿
		if match_ID(pid, 692) and pid == 0 then
		        if JY.Person[pid]["实战"] >= 80 and JY.Person[692]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "精通武艺：*五系兵器值+60，五系武功威力+300*考试作弊：*进入战斗直接行动，敌方集气减少200      ",{"精通武艺","考试作弊"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
					   AddPersonAttrib(0, "拳掌功夫", 60)
					   AddPersonAttrib(0, "指法技巧", 60)
					   AddPersonAttrib(0, "特殊兵器", 60)
		               AddPersonAttrib(0, "耍刀技巧", 60)
					   AddPersonAttrib(0, "御剑能力", 60)
					   JY.Person[692]["天1"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【精通武艺】", C_ORANGE, CC.DefaultFont)
		            elseif wh == 2 then
					   JY.Person[692]["天1"] = 2
		               DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【考试作弊】", C_ORANGE, CC.DefaultFont) 
                    end	  
	                
					ClsN()
				end
		        if JY.Person[pid]["实战"] >= 230 and JY.Person[692]["天2"] == 0 and JY.Base["天书数量"] >= 1 then
                    local wh = JYMsgBox("请选择领悟能力", "苦尽甘来：*受到攻击恢复50%伤害值生命 *回头是岸：*洗掉前5格武功                  ",{"苦尽甘来","回头是岸"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[692]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【苦尽甘来】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[692]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【回头是岸】", C_ORANGE, CC.DefaultFont)
					   for i = 1, 5 do
					      JY.Person[0]["武功"..i] = 0
			           end
			           local wg = {}
			           for i = 6, JY.Person[671]["品德"] do
						   wg[i-5] = {JY.Person[0]["武功"..i], JY.Person[0]["武功等级"..i]}
				       end
					   for i = 1, JY.Person[671]["品德"] do
					   JY.Person[0]["武功"..i] = 0
					   JY.Person[0]["武功等级"..i] = 0
					   end
					   for i = 1, JY.Person[671]["品德"] do
					       if wg[i] ~= nil then
					       JY.Person[0]["武功"..i] = wg[i][1]
						   JY.Person[0]["武功等级"..i] = wg[i][2]
						   end
					   end
				  					 
			           end  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 340 and JY.Person[692]["天3"] == 0 and JY.Base["天书数量"] >= 3 then
				    local wh = JYMsgBox("请选择领悟能力", "灵魂附体：*可以复活一次，复活后变为洪七公*变身后伤害提高20% *乞丐霸主：*第二格洗为打狗棒法*降龙十八掌和打狗棒法威力+1000          ",{"灵魂附体","乞丐霸主"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[692]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【灵魂附体】", C_ORANGE, CC.DefaultFont)
		            else	
					   SetTianWai(692,1,26)
					   SetTianWai(692,2,80)
		               JY.Person[692]["天3"] = 2
					   JY.Person[0]["武功2"] = 80
					   JY.Person[0]["武功等级2"] = 999
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【乞丐霸主】", C_ORANGE, CC.DefaultFont)
                    end
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 480 and JY.Person[692]["天4"] == 0 and wugong == 26 then	 
		               JY.Person[692]["天4"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【亢龙有悔】", C_ORANGE, CC.DefaultFont)
					ClsN()	  
				end
		end
		--Iron Fist
		if match_ID(pid, 693) and pid == 0 then
		        if JY.Person[pid]["实战"] >= 70 and JY.Person[693]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "钢铁之拳：*拳掌武功威力+300，受到的伤害减少10% *拳法精通：*武学常识+50，拳掌和拳掌上限+50",{"钢铁之拳","拳法精通"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then	   
					   JY.Person[693]["天1"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【钢铁之拳】", C_ORANGE, CC.DefaultFont)
		            elseif wh == 2 then
					   AddPersonAttrib(0, "武学常识", 50)
					   AddPersonAttrib(0, "拳掌功夫", 50)
					   JY.Person[693]["天1"] = 2
		               DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【拳法精通】", C_ORANGE, CC.DefaultFont) 
                    end	  
	                
					ClsN()
				end
		        if JY.Person[pid]["实战"] >= 210 and JY.Person[693]["天2"] == 0 and JY.Base["天书数量"] >= 2 then
                    local wh = JYMsgBox("请选择领悟能力", "怒之铁拳：*满怒时集气速度提高70% *静之铁拳：*连击不造成怒气                  ",{"怒之铁拳","静之铁拳"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[693]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【怒之铁拳】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[693]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【静之铁拳】", C_ORANGE, CC.DefaultFont)				 
			        end
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 340 and JY.Person[693]["天3"] == 0 and JY.Base["天书数量"] >= 8 then
				    local wh = JYMsgBox("请选择领悟能力", "铁拳之怒：*铁拳之怒威力+1000，距离+3*火山咆哮：*火山咆哮范围+2，全体敌方杀集气500*龙之掠夺：*额外造成敌方最大生命值15%的伤害，范围+2  ",{"铁拳之怒","火山咆哮","龙之掠夺"},3,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[693]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【铁拳之怒】", C_ORANGE, CC.DefaultFont)
		            elseif wh == 2 then	
                       JY.Person[693]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【火山咆哮】", C_ORANGE, CC.DefaultFont)
					elseif wh == 3 then	
                       JY.Person[693]["天3"] = 3
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【龙之掠夺】", C_ORANGE, CC.DefaultFont)   
                    end
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 500 and JY.Person[693]["天4"] == 0 and JY.Base["天书数量"] >= 12 then	 
		            local wh = JYMsgBox("请选择领悟能力", "不朽之龙：*受到的伤害不会超过最大生命值15%*并回复超过部分的生命值 *屠龙之拳：*攻击无视气防，拳掌武功威力+70%，气功+1000*额外造成敌方6%最大生命值的最终伤害  ",{"不朽之龙","屠龙之拳"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[693]["天4"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【不朽之龙】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[693]["天4"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【屠龙之拳】", C_ORANGE, CC.DefaultFont)				 
			        end
					ClsN()	  
				end
		end
		--张角
		if match_ID(pid, 694) and pid == 0 then
		        
		        if JY.Person[pid]["实战"] >= 60 and JY.Person[694]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "五行错乱：*所有敌方灼烧、冰封、流血、中毒、内伤时序增加1点 *阴阳不交：*敌方行动后损失5%当前内力生命",{"五行错乱","阴阳不交"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then	   
					   JY.Person[694]["天1"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【五行错乱】", C_ORANGE, CC.DefaultFont)
		            elseif wh == 2 then
					   JY.Person[694]["天1"] = 2
		               DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【阴阳不交】", C_ORANGE, CC.DefaultFont) 
                    end	  
	                
					ClsN()
				end
		        if JY.Person[pid]["实战"] >= 160 and JY.Person[694]["天2"] == 0 and JY.Base["天书数量"] >= 2 then
                    local wh = JYMsgBox("请选择领悟能力", "天下大乱：*所有角色额外20%概率闪避攻击 *无的放矢：*强制命中效果70%概率无效           ",{"天下大乱","无的放矢"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[694]["天2"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【天下大乱】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[694]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【无的放矢】", C_ORANGE, CC.DefaultFont)				 
			        end
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 290 and JY.Person[694]["天3"] == 0 and JY.Base["天书数量"] >= 4 then	 
		            local wh = JYMsgBox("请选择领悟能力", "天雷滚滚：*雷击杀集气300，伤害提高30%*符图咒法：*【祝由】效果提高20%*使敌方最终伤害减少20%，友方伤害提高20%  ",{"天雷滚滚","符图咒法"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[694]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【天雷滚滚】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[694]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【符图咒法】", C_ORANGE, CC.DefaultFont)				 
			        end
					ClsN()	  
				end
				if JY.Person[pid]["实战"] >= 450 and JY.Person[694]["天4"] == 0 and JY.Base["天书数量"] >= 10 then
				    local wh = JYMsgBox("请选择领悟能力", "驱雷策电：*雷电伤害提高，闪避后用雷电反击敌方   *道高魔重：*【祝由】以所有人为目标，行动结束后使用一次  ",{"驱雷策电","道高魔重"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[694]["天4"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【驱雷策电】", C_ORANGE, CC.DefaultFont)
		            elseif wh == 2 then	
                       JY.Person[694]["天4"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【道高魔重】", C_ORANGE, CC.DefaultFont) 
                    end
					ClsN()
				end
		end
		--kael
		if match_ID(pid, 689) and pid == 0 and JY.Person[689]["品德"] < 8 then
		local ys = {{"  冰  |  当前等级："..JY.Person[689]["天1"],nil,1},{"  雷  |  当前等级："..JY.Person[689]["天2"],nil,1},{"  火  |  当前等级："..JY.Person[689]["天3"],nil,1}}
		local t = 5
		if JY.Person[689]["阶"] >= 1 then
		   t = t + 1
		   if JY.Person[689]["阶"] >= 3 then
		   t = t + 2
		   end
		end
		for i = 1, 3 do
		  if JY.Person[689]["天"..i] >= t then
		   ys[i][3] = 3
		  end
		end
		if ys[1][3] == 3 and ys[1][3] == 3 and ys[1][3] == 3 then
		for i = 1, 3 do
		   ys[i][3] = 1
		end
		end
		        local i = JY.Person[689]["品德"]
				while JY.Person[pid]["实战"] > i*(13+i*8) and JY.Person[689]["品德"] == i do
				    local nexty = CC.ScreenH/2-CC.DefaultFont*4 + CC.SingleLineHeight
					local cs = ShowMenu2(ys, #ys, 1, 3, CC.ScreenW/4+70, nexty, 0, 0, 1, 0, CC.DefaultFont, C_ORANGE, C_WHITE,"升级技能点数")
			        if cs > 0 then
				       JY.Person[689]["天"..cs] = JY.Person[689]["天"..cs] + 1
			        end
					JY.Person[689]["品德"] = JY.Person[689]["品德"] + 1
				end
		end
		if match_ID(pid, 689) and pid == 0 then
		        if JY.Person[pid]["实战"] >= 70 and JY.Person[690]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "黑皇杖：*20%几率免疫伤害   *席瓦的守护：*受到的伤害降低20%，周围9格内敌人集齐速度降低20%  ",{"黑皇杖","席瓦的守护"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[690]["天1"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."获得黑皇杖", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[690]["天1"] = 2
					   PlayWavAtk(158)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."获得席瓦的守护", C_ORANGE, CC.DefaultFont)
                    end
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 150 and JY.Person[690]["天2"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "林肯法球：*每时序获得护盾      *斯嘉蒂之眼：*攻击必冰封，降低目标集气速度，追加真实伤害",{"林肯法球","斯嘉蒂之眼"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[690]["天2"] = 1
					   PlayWavAtk(157)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."获得林肯法球", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[690]["天2"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."获得斯嘉蒂之眼", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 240 and JY.Person[690]["天3"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "毁天灭地：*阳炎冲击必连击，按T变成毁天灭地*阳炎冲击会出现在所有敌方附近*阳炎冲击冷却变为5回合，毁天灭地威力提高500*环形声波：*超震声波朝八方攻击，威力提高600  ",{"毁天灭地","环形声波"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[690]["天3"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【毁天灭地】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[690]["天3"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【环形声波】", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 350 and JY.Person[690]["品德"] == 0 then
                    local wh = JYMsgBox("请选择领悟能力", "狂风：*强袭飓风冷却时间减少3，威力提高500   *刷新球：*攻击后20%几率所有武功冷却重置 ",{"强袭飓风","刷新球"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[690]["品德"] = 1
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【狂风】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[690]["品德"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."获得刷新球", C_ORANGE, CC.DefaultFont)
                    end	  
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 420 and JY.Person[690]["天4"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "阿哈利姆神杖：*行动后集气回复400-600   *玲珑心：*造成伤害的25%转化为生命恢复 ",{"阿哈利姆神杖","玲珑心"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[690]["天4"] = 1
					   PlayWavAtk(156)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."获得阿哈利姆神杖", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[690]["天4"] = 2
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."获得玲珑心", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] > 499 and JY.Person[689]["声望"] == 0 and JY.Person[pid]["六如觉醒"] >= 6 then
                    local wh = JYMsgBox("请选择领悟天赋", "元素精华：*所有元素等级+2   *血精石：*时序回复0.8%已损失的生命内力，可以复活一次*死亡时会爆炸，伤害9格范围内敌人 ",{"元素精华","血精石"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[689]["声望"] = 1
					   JY.Person[689]["天1"] = JY.Person[689]["天1"] + 2
					   JY.Person[689]["天2"] = JY.Person[689]["天2"] + 2
					   JY.Person[689]["天3"] = JY.Person[689]["天3"] + 2
					   PlayWavAtk(126)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【元素精华】", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[689]["声望"] = 2
					   PlayWavAtk(164)
					   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."获得血精石", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
		end
		--殷离
		if match_ID(pid, 646) and pid == 0 then
		        if JY.Person[pid]["实战"] >350 and JY.Person[646]["天3"]==0 then
					JY.Person[646]["天3"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【毒手尊拳】，攻击上满毒，无视所有防御", C_ORANGE, CC.DefaultFont)
				elseif JY.Person[pid]["实战"]>200 and JY.Person[646]["天2"]==0 then
					JY.Person[646]["天2"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【千蛛万毒】，千蛛万毒手威力增加双倍全场角色中毒量之和", C_ORANGE, CC.DefaultFont*0.9)
				elseif JY.Person[pid]["实战"]>70 and JY.Person[646]["天1"]==0 then
					JY.Person[646]["天1"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【毒泷恶雾】，敌方根据中毒量时序损失生命", C_ORANGE, CC.DefaultFont)
				end
		end
		--林平之
		if match_ID(pid, 36) and pid == 0 then
		        if JY.Person[pid]["实战"] > 499 and JY.Person[36]["天4"]==0 and JY.Base["天书数量"] >= 12 then
				   JY.Person[36]["天4"]=1
				   DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【腥风血雨】", C_ORANGE, CC.DefaultFont)
		        elseif JY.Person[pid]["实战"] > 350 and JY.Person[36]["天3"]==0 and JY.Base["天书数量"] >= 7 then
				local wh = JYMsgBox("请选择领悟天赋", "无坚不摧：*伤害提高30%，攻击强制杀集气200   *唯快不破：*集气速度增加40，20%几率闪避   ",{"无坚不摧","唯快不破"},2,JY.Person[pid]["头像代号"])
				if wh == 1 then
					JY.Person[36]["天3"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【无坚不摧】", C_ORANGE, CC.DefaultFont)
				else
				    JY.Person[36]["天3"]=2
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【唯快不破】", C_ORANGE, CC.DefaultFont)
				end
					
				elseif JY.Person[pid]["实战"]>200 and JY.Person[36]["天2"]==0 and JY.Base["天书数量"] >= 2 then
				local wh = JYMsgBox("请选择领悟天赋", "厄运洪流：*自身和敌方连击几率提高60%，暴击几率提高40%   *逆流而上：*受到攻击集气增加50~150  ",{"厄运洪流","逆流而上"},2,JY.Person[pid]["头像代号"])
				if wh == 1 then
					JY.Person[36]["天2"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【厄运洪流】", C_ORANGE, CC.DefaultFont)
				else
				    JY.Person[36]["天2"]=2
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【逆流而上】", C_ORANGE, CC.DefaultFont)
				end
				elseif JY.Person[pid]["实战"]>70 and JY.Person[36]["天1"]==0 then
				local wh = JYMsgBox("请选择领悟天赋", "复仇之心：*对最后一个攻击你的敌人造成50%额外伤害   *平之坦之：*受到的伤害气功减少15% ",{"复仇之心","平之坦之"},2,JY.Person[pid]["头像代号"])
				if wh == 1 then
					JY.Person[36]["天1"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【复仇之心】", C_ORANGE, CC.DefaultFont)
				else
				    JY.Person[36]["天1"]=2
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【平之坦之】", C_ORANGE, CC.DefaultFont)
				end
				end
		end
		--游坦之
		if match_ID(pid, 48) and pid == 0 then
		        if JY.Person[pid]["实战"] > 499 and JY.Person[48]["天4"]==0 and JY.Base["天书数量"] >= 12 then
				    JY.Person[48]["天4"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【摩T罗伽】", C_ORANGE, CC.DefaultFont)
		        elseif JY.Person[pid]["实战"] > 350 and JY.Person[48]["天3"]==0 and JY.Base["天书数量"] >= 7 then
				local wh = JYMsgBox("请选择领悟天赋", "冰毒怪客：*冰蚕毒掌威力+700，33%几率全屏攻击   *易筋锻骨：*三维+40，每学有一门内功*三维、生命、内力上限分别增加：20、100、200  ",{"冰毒怪客","易筋锻骨"},2,JY.Person[pid]["头像代号"])
				if wh == 1 then
					JY.Person[48]["天3"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【冰毒怪客】", C_ORANGE, CC.DefaultFont)
				else
				       AddPersonAttrib(0, "攻击力", 40)
		               AddPersonAttrib(0, "轻功", 40)
					   AddPersonAttrib(0, "防御力", 40)
				    JY.Person[48]["天3"]=2
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【易筋锻骨】", C_ORANGE, CC.DefaultFont)
				end
					
				elseif JY.Person[pid]["实战"]>200 and JY.Person[48]["天2"]==0 and JY.Base["天书数量"] >= 2 then
				local wh = JYMsgBox("请选择领悟天赋", "厄运洪流：*自身和敌方连击几率提高40%，暴击几率提高60%   *潘磕嫦：*五系兵器值三维+60  ",{"厄运洪流","潘磕嫦"},2,JY.Person[pid]["头像代号"])
				if wh == 1 then
					JY.Person[48]["天2"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【厄运洪流】", C_ORANGE, CC.DefaultFont)
				else
				       AddPersonAttrib(0, "拳掌功夫", 60)
					   AddPersonAttrib(0, "指法技巧", 60)
					   AddPersonAttrib(0, "特殊兵器", 60)
		               AddPersonAttrib(0, "耍刀技巧", 60)
					   AddPersonAttrib(0, "御剑能力", 60)
					   AddPersonAttrib(0, "攻击力", 60)
		               AddPersonAttrib(0, "轻功", 60)
					   AddPersonAttrib(0, "防御力", 60)
				    JY.Person[48]["天2"]=2
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【潘磕嫦】", C_ORANGE, CC.DefaultFont)
				end
				elseif JY.Person[pid]["实战"]>70 and JY.Person[48]["天1"]==0 then
				local wh = JYMsgBox("请选择领悟天赋", "心无所住：*内功能修炼到极，且威力提升10%   *平之坦之：*受到的伤害气功减少15% ",{"心无所住","平之坦之"},2,JY.Person[pid]["头像代号"])
				if wh == 1 then
					JY.Person[48]["天1"]=1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【心无所住】", C_ORANGE, CC.DefaultFont)
				else
				    JY.Person[48]["天1"]=2
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【平之坦之】", C_ORANGE, CC.DefaultFont)
				end
				end
		end
		   
		--莫大
		if match_ID(pid, 20) and pid == 0 then
				if JY.Person[pid]["实战"] >300 and JY.Person[20]["品德"]==44 then
                    AddPersonAttrib(0, "御剑能力", 20)   
					JY.Person[20]["品德"]=JY.Person[20]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ雁回祝融Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>200 and JY.Person[20]["品德"]==43 then
                    AddPersonAttrib(0, "御剑能力", 20)
					JY.Person[20]["品德"]=JY.Person[20]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ天柱云气Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>130 and JY.Person[20]["品德"]==42 then
                    AddPersonAttrib(0, "御剑能力", 20)
					JY.Person[20]["品德"]=JY.Person[20]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ石廪书声Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>80 and JY.Person[20]["品德"]==41 then
                    AddPersonAttrib(0, "御剑能力", 20)
					JY.Person[20]["品德"]=JY.Person[20]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ鹤翔紫盖Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>30 and JY.Person[20]["品德"]==40 then
                    AddPersonAttrib(0, "御剑能力", 20)
					JY.Person[20]["品德"]=JY.Person[20]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ泉鸣芙蓉Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				end
		end
		--武僧
		if match_ID(pid, 676) and pid == 0 then
				if JY.Person[pid]["实战"] >= 400 and JY.Person[676]["天4"] == 0 and JY.Base["天书数量"] >= 9 then
                    local wh = JYMsgBox("请选择领悟天赋", "天人合一：*所有武功威力提高50%*脱凡入化：*攻击回复消耗内力值20%的生命",{"天人合一","脱凡入化"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[676]["天4"] = 1
					   DrawStrBoxWaitKey("领悟【Ｇ天人合一Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            else	 
		               JY.Person[676]["天4"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ脱凡入化Ｏ】", C_ORANGE, CC.DefaultFont, 2)
                    end	  
	            
					ClsN()
				elseif JY.Person[pid]["实战"] >= 220 and JY.Person[676]["天3"] == 0 and JY.Base["天书数量"] >= 5 then
                    local wh = JYMsgBox("请选择领悟天赋", "健步如飞：轻功上限+50*集气速度+10，每有一本天书，额外+1*斗志坚决：攻击力上限+50*伤害提高15%，战场上每有一个敌人，伤害提高2%  ",{"健步如飞","斗志坚决"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[676]["天3"] = 1
					   AddPersonAttrib(0, "轻功", 50)
					   DrawStrBoxWaitKey("领悟【Ｇ健步如飞Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            else	 
		               JY.Person[676]["天3"] = 2
					   AddPersonAttrib(0, "攻击力", 50)
					   DrawStrBoxWaitKey("领悟【Ｇ斗志坚决Ｏ】", C_ORANGE, CC.DefaultFont, 2)
                    end	  
	            
					ClsN()
				elseif JY.Person[pid]["实战"] >= 80 and JY.Person[676]["天2"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "奇筋异骨：内力硬上限提高3000*时序回复内力+6*以攻为守：武常+50*装备武器但未装备防具时，30%几率闪避，攻击无视闪避  ",{"奇筋异骨","以攻为守"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[676]["天2"] = 1
					   DrawStrBoxWaitKey("领悟【Ｇ奇筋异骨Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            else	 
		               JY.Person[676]["天2"] = 2
					   AddPersonAttrib(0, "武学常识", 50)
					   DrawStrBoxWaitKey("领悟【Ｇ以攻为守Ｏ】", C_ORANGE, CC.DefaultFont, 2)
                    end	  
	            
					ClsN()
				elseif JY.Person[pid]["实战"] >= 10 and JY.Person[676]["天1"] == 0 then
                    local wh = JYMsgBox("请选择领悟天赋", "先知先觉：防御力上限增加50*受到的伤害降低20%  *濒死体验：生命上限增加25%*第一次被击退会恢复35%血内，并且15时序无敌 ",{"先知先觉","濒死体验"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[676]["天1"] = 1
					   AddPersonAttrib(0, "防御力", 50)
					   DrawStrBoxWaitKey("领悟【Ｇ先知先觉Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            else	 
		               JY.Person[676]["天1"] = 2
					   DrawStrBoxWaitKey("领悟【Ｇ濒死体验Ｏ】", C_ORANGE, CC.DefaultFont, 2)
                    end	  
	            
					ClsN()
				end
		end
		--lxf
		if match_ID(pid, 678) and pid == 0 then
		        if JY.Person[pid]["实战"] >= 30 and JY.Person[678]["天1"] == 0 and JY.Base["天书数量"] >= 1 then
                    local wh = JYMsgBox("请选择领悟天赋", "威力增加：指法威力提高10%  *范围增加：指法范围+1 ",{"威力增加","范围增加"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[678]["天1"] = 1
					   DrawStrBoxWaitKey("指法威力提高", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[678]["天1"] = 2
					   DrawStrBoxWaitKey("指法范围提高", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 80 and JY.Person[678]["天2"] == 0 and JY.Base["天书数量"] >= 2 then
                    local wh = JYMsgBox("请选择领悟天赋", "连击：连击率提高，有几率三连*暴击：暴击率提高，指法暴击伤害提高 ",{"连击","暴击"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[678]["天2"] = 1
					   DrawStrBoxWaitKey("连击提高", C_ORANGE, CC.DefaultFont)
		            else	 
		               JY.Person[678]["天2"] = 2
					   DrawStrBoxWaitKey("暴击提高", C_ORANGE, CC.DefaultFont)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 200 and JY.Person[678]["天3"] == 0 and JY.Base["天书数量"] >= 4 then
                    local wh = JYMsgBox("领悟灵犀一指", "锐不可当：攻击发动灵犀一指伤害提高*坚不可摧：被攻击发动灵犀一指，不消耗内力 ",{"锐不可当","坚不可摧"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[678]["天3"] = 1
					   AddPersonAttrib(0, "指法技巧", 30)
					   DrawStrBoxWaitKey("领悟【Ｇ锐不可当Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            else	 
		               JY.Person[678]["天3"] = 2
					   AddPersonAttrib(0, "指法技巧", 30)
					   DrawStrBoxWaitKey("领悟【Ｇ坚不可摧Ｏ】", C_ORANGE, CC.DefaultFont, 2)
                    end	  
	            
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 300 and JY.Person[678]["声望"] == 0 and JY.Base["天书数量"] >= 5 then
                   DrawStrBoxWaitKey("领悟【Ｇ凤舞九天Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				   AddPersonAttrib(0, "轻功", 50)
				   instruct_35(0,1,216,999)
					SetTianQing(0,216)
					JY.Person[678]["声望"] = 110
					ClsN()
				end
				if JY.Person[pid]["实战"] >= 400 and JY.Person[678]["天4"] == 0 and JY.Base["天书数量"] >= 7 then
                    local wh = JYMsgBox("请选择领悟天赋", "拔地参天：攻击和被攻击都以指法计算*海阔天空：指法攻击会根据指法系数有额外范围 ",{"拔地参天","海阔天空"},2,JY.Person[pid]["头像代号"])
	                if wh == 1 then
		               JY.Person[678]["天4"] = 1
					   AddPersonAttrib(0, "指法技巧", 30)
					   DrawStrBoxWaitKey("领悟【Ｇ拔地参天Ｏ】", C_ORANGE, CC.DefaultFont, 2)
		            else	 
		               JY.Person[678]["天4"] = 2
					   AddPersonAttrib(0, "指法技巧", 30)
					   DrawStrBoxWaitKey("领悟【Ｇ海阔天空Ｏ】", C_ORANGE, CC.DefaultFont, 2)
                    end	  
	            
					ClsN()
				end
				
		end
		--华英雄
		if match_ID(pid, 675) and pid == 0 then
				
				if JY.Person[pid]["实战"] >350 and JY.Person[675]["品德"]==5 then
                    AddPersonAttrib(0, "拳掌功夫", 20)   
					JY.Person[675]["品德"]=JY.Person[675]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ无悔三震Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>230 and JY.Person[675]["品德"]==4 then
                    AddPersonAttrib(0, "拳掌功夫", 20)
					JY.Person[675]["品德"]=JY.Person[675]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ气吞天下Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>170 and JY.Person[675]["品德"]==3 then
                    AddPersonAttrib(0, "拳掌功夫", 20)
					JY.Person[675]["品德"]=JY.Person[675]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ日月无华Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>120 and JY.Person[675]["品德"]==2 then
                    AddPersonAttrib(0, "拳掌功夫", 20)
					JY.Person[675]["品德"]=JY.Person[675]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ气海无涯Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>80 and JY.Person[675]["品德"]==1 then
                    AddPersonAttrib(0, "拳掌功夫", 20)
					JY.Person[675]["品德"]=JY.Person[675]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ地动天旋Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>50 and JY.Person[675]["品德"]==0 then
                    AddPersonAttrib(0, "拳掌功夫", 20)
					instruct_35(0,1,212,999)
					SetTianWai(0,2,212)
					JY.Person[675]["品德"]=JY.Person[675]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ佛法无边Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				end
		end
		--豪鬼
		if match_ID(pid, 673) then
		        if JY.Person[pid]["实战"] >=500 and JY.Person[673]["声望"]==3 then
					instruct_35(0,3,210,999)
					SetTianWai(0,3,210)
					AddPersonAttrib(0, "拳掌功夫", 100)
					JY.Person[673]["声望"]=JY.Person[673]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ金刚国裂斩Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"] >300 and JY.Person[673]["声望"]==2 then
					instruct_35(0,1,203,999)
					SetTianWai(0,2,203)
					AddPersonAttrib(0, "拳掌功夫", 100)
					JY.Person[673]["声望"]=JY.Person[673]["声望"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ豪升龙拳Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				elseif JY.Person[pid]["实战"]>150 and JY.Person[673]["声望"]==1 then
					instruct_35(0,0,202,999)
					SetTianWai(0,1,202)
					JY.Person[673]["声望"]=JY.Person[673]["声望"]+1
					AddPersonAttrib(0, "拳掌功夫", 100)
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ豪波动拳Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				end
		end
		--谢烟客
		if match_ID(pid, 164) then
				if JY.Person[pid]["实战"] > 300 and JY.Person[164]["品德"]== 50 then
					instruct_35(0,2,206,999)
					SetTianWai(0,2,206)
					AddPersonAttrib(0, "拳掌功夫", 100)
					JY.Person[164]["品德"]=JY.Person[164]["品德"]+1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ碧针清掌Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				end
		end
		--小虾米
		if match_ID(pid, 677) then
				if JY.Person[pid]["六如觉醒"] == 6 and JY.Person[pid]["实战"] > 300 then
					instruct_35(0,2,214,666)
					SetTianWai(0,2,214)
					say("我记起来了，这个手感......不会有错的！",0,1)
					JY.Person[pid]["六如觉醒"] = JY.Person[pid]["六如觉醒"] + 1
					DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."领悟【Ｇ真野球拳Ｏ】", C_ORANGE, CC.DefaultFont, 2)
				end
				
		end
		--正义
		if JY.Base["特殊"] == 3 and pid == 0 then
				if JY.Person[680]["品德"] == 101 and JY.Person[pid]["实战"] > 450 then
				local i = 0
				local t = 3
				if JY.Person[92]["天1"] == 1 then
				t = t+1
				end
			    while i < t do
			      i = 0
			     JY.Person[0]["地"..math.random(9)] = 8
			      for j = 1, 9 do
			      if JY.Person[0]["地"..j] == 8 then
				     i = i + 1
				  end
				  
			      end	  
			    end
				
				JY.Person[680]["品德"] = 102
				
				elseif JY.Person[680]["品德"] == 100 and JY.Person[pid]["实战"] > 220 then
				local i = 0
				local t = 3
				if JY.Person[92]["天1"] == 1 then
				t = t+1
				end
			    while i < t do
			      i = 0
			     JY.Person[0]["地"..math.random(9)] = 7
			      for j = 1, 9 do
			      if JY.Person[0]["地"..j] == 7 then
				     i = i + 1
				  end
				  
			      end	  
			    end
				JY.Person[680]["品德"] = 101
				end
		end

		
		--范瑶
		if match_ID(pid, 10) and JY.Person[10]["品德"] < 11 then
		        local i = JY.Person[10]["品德"]
				while JY.Person[pid]["实战"] > i*50 and JY.Person[10]["品德"] == i do
					local hqjl = JYMsgBox("请选择一项兵器值进行提高","我对武学又有更深的见解", {"拳法","指法","剑法","刀法","奇门"}, 5, 10)
			        if hqjl == 1 then
				    AddPersonAttrib(0, "拳掌功夫", 10)
				    DrawStrBoxWaitKey("你的拳掌功夫提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				    Cls()  --清屏
			        elseif hqjl == 2 then
				    AddPersonAttrib(0, "指法技巧", 10)
				    DrawStrBoxWaitKey("你的指法技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				    Cls()  --清屏
			        elseif hqjl == 3 then
				    AddPersonAttrib(0, "御剑能力", 10)
				    DrawStrBoxWaitKey("你的御剑能力提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				    Cls()  --清屏
			        elseif hqjl == 4 then
				    AddPersonAttrib(0, "耍刀技巧", 10)
				    DrawStrBoxWaitKey("你的耍刀技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				    Cls()  --清屏
			        elseif hqjl == 5 then
				    AddPersonAttrib(0, "特殊兵器", 10)
				    DrawStrBoxWaitKey("你的特殊兵器提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				    Cls()  --清屏
			        end
					JY.Person[10]["品德"] = JY.Person[10]["品德"] + 1
				end
		end
	end
	
	--丁典
	if match_ID(eid, 672) and (WAR.ZMSZ[eid] == nil or math.random(100) < 15 or (JY.Person[672]["阶"] >= 1 and math.random(100) < 15)) and JY.Person[eid]["生命"] <= 0 then
		   local jl = 20
		   jl = jl + JY.Base["天书数量"]*2
		   if JY.Person[672]["品德"] ~= 80 and JY.Person[672]["品德"] ~= 90 then
		      jl = jl + 10
		   end
		   if math.random(200) <= jl then
		      JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*(25+jl/2)*0.01)
		      WAR.ZMSZ[eid] = 30 - JY.Base["天书数量"]
			  WAR.Person[enemyid]["特效动画"] = 128
		      WAR.Person[enemyid]["特效文字1"] = "神照真髓"
			  WAR.Person[enemyid].Time = 995
		   elseif math.random(100) < 15 + jl then
		      JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*0.1)
			  WAR.ZMSZ[eid] = 30 
			  WAR.Person[enemyid]["特效动画"] = 89
		      WAR.Person[enemyid]["特效文字1"] = "神照真传"
			  WAR.Person[enemyid].Time = WAR.Person[enemyid].Time + 700
		   else
		      JY.Person[eid]["生命"] = 1
			  WAR.ZMSZ[eid] = 30 
			  WAR.Person[enemyid]["特效动画"] = 88
		      WAR.Person[enemyid]["特效文字1"] = "神照"
			  WAR.Person[enemyid].Time = WAR.Person[enemyid].Time + 500  
		   end
	end
	--血精石
	if match_ID(eid, 689) and JY.Person[eid]["生命"] <= 0 and JY.Person[689]["声望"] == 2 and WAR.JESS[eid] == nil then
	local dam = 0
		WAR.XJSBZ = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]}
		if WAR.XJSFH[eid] == nil then
        WAR.XJSFH[eid] = 1		
		WAR.Person[enemyid]["特效动画"] = 121
		WAR.Person[enemyid]["特效文字3"] = "重生"
		   PlayWavAtk(140+math.random(4))
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["体力"] = 100
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		--流血
		WAR.LXZT[eid] = nil
		--封穴
		WAR.FXDS[eid] = nil
		WAR.Person[enemyid].Time = 990
		end
		
	end
	--xyz
	if match_ID(eid, 634) and JY.Person[eid]["生命"] <= 0 and JY.Person[634]["天4"] == 2 and WAR.JESS[eid] == nil then
		if WAR.PYDM[eid] == nil then
        WAR.PYDM[eid] = 1		
		WAR.Person[enemyid]["特效动画"] = 128
		WAR.Person[enemyid]["特效文字3"] = "鹏游蝶梦"
		WAR.ACT = 10
		JY.Person[pid]["生命"] = 0
		WAR.Person[WAR.CurID]["死亡"] = true
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["体力"] = 100
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		--流血
		WAR.LXZT[eid] = nil
		--封穴
		WAR.FXDS[eid] = nil
		WAR.Person[enemyid].Time = 990
		end
		
	end
	--无名
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 671) and WAR.WMCS[eid] == nil and JY.Person[671]["阶"] >= 3 and WAR.JESS[eid] == nil then
        WAR.WMCS[eid] = 1
		WAR.WMJY[eid] = 100
		WAR.Person[enemyid]["特效动画"] = 120
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["体力"] = 100
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		--流血
		WAR.LXZT[eid] = nil
		--封穴
		WAR.FXDS[eid] = nil
		WAR.Person[enemyid].Time = 990
	end
	--逆乾坤
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 682) and JY.Person[682]["天4"] == 2 and (WAR.NQK[eid] == nil or (WAR.NQK[eid] < 3 and WAR.NQK[eid] > 0)) and WAR.JESS[eid] == nil then
	    local nqk = {"一", "二", "三"}
		if WAR.NQK[eid] == nil then
		   WAR.NQK[eid] = 1
		else
		   WAR.NQK[eid] = WAR.NQK[eid] + 1
		end
		WAR.Person[enemyid]["特效动画"] = 160
		WAR.Person[enemyid]["特效文字6"] = "逆乾坤・"..nqk[WAR.NQK[eid]].."周天"
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["体力"] = 100
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		--流血
		WAR.LXZT[eid] = nil
		--封穴
		WAR.FXDS[eid] = nil
		WAR.Person[enemyid].Time = WAR.Person[enemyid].Time + 600
		if WAR.Person[enemyid].Time > 990 then
			WAR.Person[enemyid].Time = 990
		end
	end
	
	--神照重生
	if JY.Person[eid]["生命"] <= 0 and PersonKF(eid, 94) and WAR.tmp[2000 + eid] == nil and WAR.JESS[eid] == nil then
	    if WAR.NQK[eid] ~= nil then
		   WAR.NQK[eid] = 0
		end
		
		WAR.Person[enemyid]["特效动画"] = 89
		WAR.Person[enemyid]["特效文字3"] = "神照功起死回生"
		if match_ID(eid, 689) then
		   PlayWavAtk(140+math.random(4))
		end
		local modifier = 0.35+JY.Base["天书数量"]*0.01
		--狄云
		if match_ID(eid, 37) then
			modifier = 1
		--主运神照
		elseif Curr_NG(eid, 94) then
			modifier = 0.7+JY.Base["天书数量"]*0.02
		end
		JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*modifier)
		JY.Person[eid]["内力"] = JY.Person[eid]["内力"] + math.modf((JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])*modifier)
		JY.Person[eid]["体力"] = JY.Person[eid]["体力"] + math.modf((100 - JY.Person[eid]["体力"])*modifier)
		JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"]-math.modf(JY.Person[eid]["中毒程度"]*modifier)
		JY.Person[eid]["受伤程度"] = JY.Person[eid]["受伤程度"]-math.modf(JY.Person[eid]["受伤程度"]*modifier)
		JY.Person[eid]["冰封程度"] = JY.Person[eid]["冰封程度"]-math.modf(JY.Person[eid]["冰封程度"]*modifier)
		JY.Person[eid]["灼烧程度"] = JY.Person[eid]["灼烧程度"]-math.modf(JY.Person[eid]["灼烧程度"]*modifier)
		--流血
		if WAR.LXZT[eid] ~= nil then
			WAR.LXZT[eid] = WAR.LXZT[eid]-math.modf(WAR.LXZT[eid]*modifier)
			if WAR.LXZT[eid] < 1 then
				WAR.LXZT[eid] = nil
				WAR.LXXS[eid] = nil
			end
		end
		--封穴
		if WAR.FXDS[eid] ~= nil then
			WAR.FXDS[eid] = WAR.FXDS[eid]-math.modf(WAR.FXDS[eid]*modifier)
			if WAR.FXDS[eid] < 1 then
				WAR.FXDS[eid] = nil
				WAR.FXXS[eid] = nil
			end
		end				
		WAR.Person[enemyid].Time = WAR.Person[enemyid].Time + 500
		if PersonKF(eid, 94) and JY.Person[eid]["天赋内功"] == 94 then
		WAR.Person[enemyid].Time = WAR.Person[enemyid].Time + 300
		end
		--狄云
		if match_ID(eid, 37) then
			WAR.Person[enemyid].Time = 990
		end
		if WAR.Person[enemyid].Time > 990 then
			WAR.Person[enemyid].Time = 990
		end
		--6%的几率二次复活
		
		if math.random(100) > 94 then		
			WAR.tmp[2000 + eid] = nil
		elseif match_ID(eid, 672) and  math.random(100) > 86 - JY.Person[0]["六如觉醒"] then
		    WAR.tmp[2000 + eid] = nil
		else
		    WAR.tmp[2000 + eid] = 1
		end
		if WAR.DYSZ[eid] ~= nil and match_ID(eid, 37) and WAR.DYSZ[eid] > 0 then
		   WAR.tmp[2000 + eid] = nil
		   WAR.DYSZ[eid] = WAR.DYSZ[eid] - 1
		end
	end
  
	--一灯，复活
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 65) and WAR.WCY[eid] == nil and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = 19
		WAR.Person[enemyid]["特效文字3"] = "先天一阳 起死回生"
		WAR.WCY[eid] = 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"] * 0.7
		JY.Person[eid]["内力"] = JY.Person[eid]["内力"] + (JY.Person[eid]["内力最大值"] - JY.Person[eid]["内力"])* 0.5
		JY.Person[eid]["体力"] = JY.Person[eid]["体力"] + (100 - JY.Person[eid]["体力"])* 0.5
		JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"] * 0.5
		JY.Person[eid]["受伤程度"] = JY.Person[eid]["受伤程度"] * 0.5
		WAR.Person[enemyid].Time = 980
	end
	
	--平一指
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 28) and WAR.JJSY[eid] >= 1 and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = 0
		WAR.JJSY[eid] = WAR.JJSY[eid] - 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"] * 0.5
		if WAR.JYSY[eid] == nil then
		   WAR.JYSY[eid] = JY.Person[eid]["生命最大值"] * 0.5
		else
		   WAR.JYSY[eid] = WAR.JYSY[eid] + JY.Person[eid]["生命最大值"] * 0.5
		end
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
	end
	
	--武僧
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 676) and JY.Person[676]["天1"] == 2 and WAR.WCY[eid] == nil and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = 41
		WAR.Person[enemyid]["特效文字3"] = "濒死体验"
		WAR.WCY[eid] = 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"] * 0.35
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"] * 0.35
        WAR.WDZT[eid] = 15
	end
	
	--恶法
	if JY.Person[eid]["生命"] <= 0 and JY.Person[eid]["地10"] == 3 and WAR.EFLH[eid] == nil and WAR.JESS[eid] == nil then
	    if WAR.NQK[eid] ~= nil then
		   WAR.NQK[eid] = 0
		end
		WAR.Person[enemyid]["特效动画"] = 123
		WAR.Person[enemyid]["特效文字3"] = "恶法轮回"
		if match_ID(eid, 689) then
		   PlayWavAtk(140+math.random(4))
		end
		WAR.EFLH[eid] = 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["体力"] = 100
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		--流血
		WAR.LXZT[eid] = nil
		--封穴
		WAR.FXDS[eid] = nil
		WAR.Person[enemyid].Time = 990
	end
	
	--丁春秋，复活
	if JY.Person[eid]["生命"] <= 0 and ((match_ID(eid, 46) and JY.Person[642]["血量翻倍"] == 1) or eid==46) and WAR.WCY[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = 20
		WAR.Person[enemyid]["特效文字3"] = "北冥重生法"
		WAR.WCY[eid] = 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["体力"] = 100
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		JY.Person[eid]["性别"]=0
		WAR.Person[enemyid].Time = 980
	end

		--常赫志、常伯志复活
	if JY.Person[eid]["生命"] <= 0 and (match_ID(eid, 155) or match_ID(eid, 156)) and WAR.WCY[eid] == nil and WAR.JESS[eid] == nil then
		if math.random(100) > 30 then
		WAR.WCY[eid] = 1
		WAR.Person[enemyid]["特效动画"] = 18
		WAR.Person[enemyid]["特效文字1"] = "敌众我寡，无力回天"
		else
		WAR.Person[enemyid]["特效动画"] = 16
		WAR.Person[enemyid]["特效文字1"] = "百战之身，奋勇驱嫌"
		end		
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["体力"] = 100
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		WAR.Person[enemyid].Time = 980
	end
	
	--王重阳，复活
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 129) and WAR.CYZX[eid] == nil and WAR.JESS[eid] == nil then
		WAR.LQZ[eid] = 100
		--畅想主角的七闪数量随天书增加，NPC固定为7
		if eid == 0 then
			WAR.BDQS = math.modf(JY.Base["天书数量"]/2)
		else
			WAR.BDQS = 7
		end
		WAR.Person[enemyid]["特效动画"] = 115
		WAR.Person[enemyid]["特效文字3"] = "重阳再现 论剑形态"
		WAR.CYZX[eid] = 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"] * 0.7
		JY.Person[eid]["内力"] = JY.Person[eid]["内力"] + (JY.Person[eid]["内力最大值"] - JY.Person[eid]["内力"])* 0.5
		JY.Person[eid]["体力"] = JY.Person[eid]["体力"] + (100 - JY.Person[eid]["体力"])* 0.5
		JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"] * 0.5
		JY.Person[eid]["受伤程度"] = JY.Person[eid]["受伤程度"] * 0.5
		WAR.Person[enemyid].Time = 980
	end
	
	--戚长发，复活
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 594) and WAR.QCF < 1 and WAR.JESS[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = 19
		WAR.Person[enemyid]["特效文字3"] = "闭气离墙 起死回生"
		WAR.QCF = WAR.QCF + 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"] * 0.7
		JY.Person[eid]["内力"] = JY.Person[eid]["内力"] + (JY.Person[eid]["内力最大值"] - JY.Person[eid]["内力"])* 0.5
		JY.Person[eid]["体力"] = JY.Person[eid]["体力"] + (100 - JY.Person[eid]["体力"])* 0.5
		JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"] * 0.5
		JY.Person[eid]["受伤程度"] = JY.Person[eid]["受伤程度"] * 0.5
		WAR.Person[enemyid].Time = 980
	end
  
	--薛慕华 复活一个人
	if JY.Person[eid]["生命"] <= 0 and WAR.XMH == 0 then
		for i = 0, WAR.PersonNum - 1 do
			if match_ID(WAR.Person[i]["人物编号"], 45) and WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == WAR.Person[enemyid]["我方"] then
				WAR.Person[enemyid]["特效动画"] = 89
				WAR.Person[enemyid]["特效文字3"] = "阎王敌 重生"
				JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
				JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
				JY.Person[eid]["中毒程度"] = 0
				JY.Person[eid]["受伤程度"] = 0
				JY.Person[eid]["冰封程度"] = 0
				JY.Person[eid]["灼烧程度"] = 0
				JY.Person[eid]["体力"] = 100
				--流血
				if WAR.LXZT[eid] ~= nil then
					WAR.LXZT[eid] = nil
					WAR.LXXS[eid] = nil
				end
				--封穴
				if WAR.FXDS[eid] ~= nil then
					WAR.FXDS[eid] = nil
					WAR.FXXS[eid] = nil
				end
				WAR.XMH = 1
				break
			end
		end
	end
	
	--张家辉的复活戒指
	if JY.Person[eid]["生命"] <= 0 and JY.Person[eid]["防具"] == 303 then
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["体力"] = 100
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		--流血
		if WAR.LXZT[eid] ~= nil then
			WAR.LXZT[eid] = nil
			WAR.LXXS[eid] = nil
		end
		--封穴
		if WAR.FXDS[eid] ~= nil then
			WAR.FXDS[eid] = nil
			WAR.FXXS[eid] = nil
		end
		WAR.Person[enemyid]["特效动画"] = 154
		WAR.Person[enemyid]["特效文字3"] = "复活戒指・重生"
		JY.Person[651]["品德"] = JY.Person[651]["品德"] - 1
		if JY.Person[651]["品德"] == 0 then
			JY.Person[eid]["防具"] = -1
			JY.Thing[303]["使用人"] = -1
			instruct_32(303,-1)
			WAR.FHJZ = 1
		end
	end
	
	--苏灿
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 692) and JY.Person[692]["天3"] == 1 and WAR.WCY[eid] == nil then
	    WAR.WCY[eid] = 1
		WAR.Person[enemyid]["特效动画"] = 6
		WAR.Person[enemyid]["特效文字1"] = "灵魂附体"
		JY.Person[0]["姓名"] = "洪七公"
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["体力"] = 100
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		WAR.Person[enemyid].Time = 980
	end
  
	--人物死亡
	if JY.Person[eid]["生命"] < 0 then
	    JY.Person[eid]["生命"] = 0
		WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + JY.Person[eid]["等级"] * 5
		WAR.Person[enemyid]["反击武功"] = -1		--如果被打死则不会触发反击
		if WAR.SZSD == eid then						--取消死战标记
			WAR.SZSD = -1
		end
	end
	--四老师参战
	if JY.Base["难度"] == 8 and WAR.Person[enemyid]["我方"] == false and eid ~= 642 and WAR.SLSCZ <= math.modf(JY.Person[0]["感悟点"]/210) and match_ID(pid, 642) == false and JY.Person[eid]["生命"] <= 0 and WAR.ZDDH ~= 226 and WAR.ZDDH ~= 310 and WAR.ZDDH ~= 313 and DWPD() then
	local jl = 20 + math.modf(JY.Person[0]["感悟点"]/100) + JY.Base["天书数量"]*3
	for i = 0,WAR.PersonNum-1 do 
	    if WAR.Person[i]['人物编号'] == 642 and WAR.Person[i]['死亡'] == false then 
           jl = 0
		end
	end
	   if math.random(100) < jl then
	   
	   if JY.Person[pid]["人10"] == 1 and math.random(100) < 33 then
	    WAR.Person[enemyid]["我方"] = WAR.Person[WAR.CurID]["我方"]
		JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*0.3)
		JY.Person[eid]["内力"] = math.modf(JY.Person[eid]["内力最大值"]*0.3)
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		JY.Person[eid]["体力"] = 100
		WAR.FXXS[eid] = nil
		WAR.LXXS[eid] = nil
		WAR.FXDS[eid] = nil
		WAR.LXZT[eid] = nil
		WAR.XDLZ[eid] = 1
	   else
	   WAR.SLSCZ = WAR.SLSCZ + 1
	   local si = math.random(2)
	   WAR.Person[enemyid]["特效动画"] = math.random(165)
	   WAR.ACT = 10
	   NewWARPersonZJ(642, false, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], false, WAR.Person[enemyid]["人方向"])
	   JY.Person[642]["生命最大值"] = 10 + JY.Person[642]["天1"]*60 + JY.Person[0]["实战"]
	   JY.Person[642]["生命"] = JY.Person[642]["生命最大值"]
	   JY.Person[642]["内力最大值"] = 20 + JY.Person[642]["天1"]*90 + JY.Person[0]["实战"]*2
	   JY.Person[642]["内力"] = JY.Person[642]["内力最大值"]
	   JY.Person[642]["轻功"] = 1 + JY.Person[642]["天1"]*5
	   JY.Person[642]["攻击力"]= 1 + JY.Person[642]["天1"]*5
	   JY.Person[642]["防御力"]= 1 + JY.Person[642]["天1"]*5
	   JY.Person[642]["拳掌功夫"]=1 + math.modf(JY.Person[642]["天1"]*1.5)
	   JY.Person[642]["指法技巧"]=1 + math.modf(JY.Person[642]["天1"]*1.5)
	   JY.Person[642]["御剑能力"]=1 + math.modf(JY.Person[642]["天1"]*1.5)
	   JY.Person[642]["特殊兵器"]=1 + math.modf(JY.Person[642]["天1"]*1.5)
	   JY.Person[642]["耍刀技巧"]=1 + math.modf(JY.Person[642]["天1"]*1.5)
	   for i = 1, 30 do
	       JY.Person[642]["人"..i] = JY.Person[0]["人"..i]
	   end
	   local wg = math.modf(JY.Person[0]["感悟点"]/72)
	   if wg > 15 then
	      wg = 15
	   end
	   if wg < 1 then
	      wg = 1
	   end
	   if si == 1 then
	     for i = 1, wg do
	     JY.Person[642]["武功"..i] = math.random(240)
	     end
	   else
	     for i = 1, wg do
	     JY.Person[642]["武功"..i] = JY.Person[0]["武功"..i]
	     end
	   end
	   end
	  elseif JY.Person[pid]["人10"] == 1 then
	    WAR.Person[enemyid]["我方"] = WAR.Person[WAR.CurID]["我方"]
		JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*0.3)
		JY.Person[eid]["内力"] = math.modf(JY.Person[eid]["内力最大值"]*0.3)
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		JY.Person[eid]["体力"] = 100
		WAR.FXXS[eid] = nil
		WAR.LXXS[eid] = nil
		WAR.FXDS[eid] = nil
		WAR.LXZT[eid] = nil
		WAR.XDLZ[eid] = 1
	  else
	  --血刀老祖 杀死敌人后转化为己方
	  if match_ID(pid, 97) then
		WAR.Person[enemyid]["我方"] = WAR.Person[WAR.CurID]["我方"]
		JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*0.3+JY.Base["天书数量"]*0.01)
		JY.Person[eid]["内力"] = math.modf(JY.Person[eid]["内力最大值"]*0.3+JY.Base["天书数量"]*0.01)
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		JY.Person[eid]["体力"] = 100
		WAR.FXXS[eid] = nil
		WAR.LXXS[eid] = nil
		WAR.FXDS[eid] = nil
		WAR.LXZT[eid] = nil
		WAR.XDLZ[eid] = 1
	  end
	  end
	
	end
	if JY.Base["难度"] ~= 8 then
	  if match_ID(pid, 97) and JY.Person[eid]["生命"] <= 0 and DWPD() then
		WAR.Person[enemyid]["我方"] = WAR.Person[WAR.CurID]["我方"]
		JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*0.2+JY.Base["天书数量"]*0.01)
		JY.Person[eid]["内力"] = math.modf(JY.Person[eid]["内力最大值"]*0.2+JY.Base["天书数量"]*0.01)
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		JY.Person[eid]["体力"] = 100
		WAR.FXXS[eid] = nil
		WAR.LXXS[eid] = nil
		WAR.FXDS[eid] = nil
		WAR.LXZT[eid] = nil
		WAR.XDLZ[eid] = 1
	  elseif JY.Person[pid]["人10"] == 1 and JY.Person[eid]["生命"] <= 0 then
	    WAR.Person[enemyid]["我方"] = WAR.Person[WAR.CurID]["我方"]
		JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*0.3)
		JY.Person[eid]["内力"] = math.modf(JY.Person[eid]["内力最大值"]*0.3)
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		JY.Person[eid]["体力"] = 100
		WAR.FXXS[eid] = nil
		WAR.LXXS[eid] = nil
		WAR.FXDS[eid] = nil
		WAR.LXZT[eid] = nil
		WAR.XDLZ[eid] = 1	
	  end
	end
	--四老师阵亡
	if JY.Base["难度"] == 8 and eid == 642 and JY.Person[eid]["生命"] <= 0 and DWPD() then
	   JY.Person[642]["天1"] = JY.Person[642]["天1"] + math.random(2)
	   if JY.Person[642]["天1"] > 100 then
	      JY.Person[642]["天1"] = 100
	   end	  
	end
  
	--平一指杀人
	if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 28) and DWPD() then
		WAR.PYZ = WAR.PYZ + 1
		if 10 < WAR.PYZ then
			WAR.PYZ = 10
		end
	end
	
	--阿紫杀人
	if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 47) and DWPD() then
		WAR.MZSH = WAR.MZSH + 1
	end
	
	--无酒不欢：袁承志碧血长风
	--限主角
	if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 54) and pid == 0 and DWPD() then
		WAR.BXCF = 1
	end
	
	if (JY.Person[eid]["生命"] <= 0 or math.random(100) < 10) and match_ID(pid, 36) and JY.Person[36]["天4"] == 1 and DWPD() then
		WAR.XFXY = 1
	end
	
	if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 689) and not match_ID(pid, 642) and math.random(100) < 15 and DWPD() then
	    lib.Delay(550)
		PlayWavAtk(127+math.random(13))
	end
	
	--buzz axe rampage
	if JY.Person[eid]["生命"] <= 0 and JY.Person[pid]["地6"] == 8 and DWPD() then
	    JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
		JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
		JY.Person[pid]["体力"] = 100
		JY.Person[pid]["受伤程度"] = 0
		JY.Person[pid]["中毒程度"] = 0
		JY.Person[pid]["冰封程度"] = 0
		JY.Person[pid]["灼烧程度"] = 0
	end
	
	--紫气天罗，杀人引爆毒素
	if (JY.Person[eid]["生命"] <= 0 or (wugong == 170 and JY.Person[pid]["专2"] == 170)) and (wugong == 3 or wugong == 9 or wugong == 5 or wugong == 21 or wugong == 118 or wugong == 120 or wugong == 170 or pid==46 or (JY.Person[642]["血量翻倍"] == 1 and match_ID(pid, 46))) and ZiqiTL(pid) and DWPD() then
		local dam = math.modf((JY.Person[eid]["中毒程度"]/100)*(JY.Person[eid]["生命最大值"]/12))+220
		if tg ~= 1 then
		   if fx < 0 then
		   dam = math.modf(dam*(1-fx*0.02))
		   end
		else
		   dam = math.modf(dam*(1-yin*0.02))
		end
		if dam > 600 then
		   dam = 600
		end
		dam = dam+JY.Person[pid]["攻击带毒"]+JY.Person[pid]["用毒能力"]
		WAR.ZQTL = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], pid}
	end
	
	--爆裂掌
	if (JY.Person[eid]["生命"] <= 0 and WAR.BLZ[eid] ~= nil or WAR.BLZ[eid] ~= nil and WAR.QXQ == 1) and DWPD() then
		local dam = math.modf(hurt*0.1 + JY.Person[eid]["生命最大值"]/20)
		if WAR.QXQ == 1 then
		dam = dam * math.random(5)
		end
		WAR.BLZZ = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]}
	end
	
	--亢龙有悔
	if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 692) and wugong == 26 and JY.Person[692]["天4"] == 1 and DWPD() then
		local dam = math.modf(JY.Person[eid]["生命最大值"]/5)
		WAR.KLYH = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]}
	end
	
	--Bloodsplosion
	if JY.Person[eid]["生命"] <= 0 and JY.Person[pid]["地1"] == 8 and DWPD() then
		local dam = math.modf(hurt*0.2)+200
		WAR.BLOOD = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]}
	end
	
	--野球拳
	if wugong == 214 and DWPD() then
		WAR.YQQ = {WAR.CurID, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]}
	end
	
	--噬魂
	if JY.Person[eid]["生命"] <= 0 and WAR.SHMY[eid] == 1 and DWPD() then
	local SH = {}
	   for i = 0, WAR.PersonNum - 1 do
	       if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["人物编号"] ~= eid and WAR.SHMY[WAR.Person[i]["人物编号"]] == nil then

		      table.insert(SH, i)

		   end
		   
	   end
	   if #SH > 0 then
	   local s = SH[math.random(#SH)]
	          WAR.SHMY[WAR.Person[s]["人物编号"]] = 1
			  WAR.Person[s]["特效动画"] = 54
		      Set_Eff_Text(s,"特效文字1","噬魂")
	   end	  
	   
	end   
	
	
	
	--[[if JY.Person[pid]["武器"] == 362 and JY.Wugong[wugong]["武功类型"] == 3 then 
	   local xnl = math.modf(JY.Person[eid]["内力"]*0.01*(JY.Thing[362]["装备等级"]+5))
	   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", xnl)
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl)
	end]]
	 
  
	--北冥神功和吸星大法，加内力上限
	if (WAR.BMXH == 1 or WAR.BMXH == 2) and 0 < hurt and DWPD() then
		local xnl = nil
		if match_ID(pid, 670)  and JY.Person[pid]["天赋内功"] == 85 then
		   xnl = math.modf(JY.Person[eid]["内力最大值"] * 0.09)
		else
		   xnl = math.modf(JY.Person[eid]["内力"] * 0.07)
		   if xnl > 300 then
			  xnl = 300
		   end
		end
		if fx == 0 then
		   xnl = xnl + (yang + 1)*30
		end   
		if JY.Person[pid]["天赋内功"] == 88 or JY.Person[pid]["天赋内功"] == 85 then
		   xnl = xnl + 100
		end
		--方证不会被吸
		if (match_ID(eid,149) or PersonKF(eid, 207)) and WAR.JESS[eid] == nil then
			xnl = 0
		end
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl);
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", xnl)
		AddPersonAttrib(pid, "内力最大值", xnl * 10)
		--畅想无崖子发动北冥时吸取属性
		if WAR.BMXH == 1 and match_ID(pid, 116) and pid == 0 then
			AddPersonAttrib(pid, "攻击力", 2)
			AddPersonAttrib(pid, "防御力", 2)
			AddPersonAttrib(pid, "轻功", 2)
		end
		if WAR.BMXH == 1 and (match_ID(pid, 53) or JY.Person[pid]["专2"] == 85 or (match_ID(pid, 116) and JY.Person[116]["阶"] >= 2)) then
		local xxl = 0
		   xxl = math.modf(JY.Person[eid]["生命"]*0.05+JY.Person[pid]["生命最大值"]*0.03)+math.random(20)
		   if xxl > 200 then
			  xxl = 200
		   end
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -xxl)
		   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", xxl)
		end
		if WAR.BMXH == 2 and (match_ID(pid, 26) and JY.Person[26]["阶"] >=1) then
		local xxl = 0
		   xxl = math.modf(JY.Person[eid]["生命"]*0.05+JY.Person[pid]["内力最大值"]*0.02)+math.random(20)
		   if xxl > 200 then
			  xxl = 200
		   end
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -xxl)
		   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", xxl)
		end
	end
	
	--化功大法 上毒 减内力
	if WAR.BMXH == 3 and 0 < hurt and DWPD() then
		local xnl = nil
		xnl = math.modf(JY.Person[eid]["内力"] * 0.07)
		if xnl < 100 then
			xnl = 100
		elseif xnl > 300 then
			xnl = 300
		end
		if JY.Person[pid]["天赋内功"] == 87 then
		   xnl = xnl + 250
		   WAR.Person[enemyid]["中毒点数"] = AddPersonAttrib(eid, "中毒程度", 15)
		end		
		--方证不会被吸
		if (match_ID(eid,149) or PersonKF(eid, 207)) and WAR.JESS[eid] == nil then
			xnl = 0
		end
		if match_ID(pid, 670) and JY.Person[pid]["天赋内功"] == 87 then
		   xnl = xnl + 250
		end
		if JY.Person[pid]["专1"] == 87 then
		   xnl = xnl +  math.modf(JY.Person[eid]["内力"] * 0.1)
		end
		  WAR.Person[enemyid]["内力点数"] = AddPersonAttrib(eid, "内力", -xnl);		  
		  WAR.Person[enemyid]["中毒点数"] = AddPersonAttrib(eid, "中毒程度", math.random(16,20))
	end

	--冰火毒龙 玉真子自带
	if match_ID(pid, 184) or BinghuoDL(pid) then
		WAR.Person[enemyid]["中毒点数"] = AddPersonAttrib(eid, "中毒程度", math.random(10,20))
	end	
  
	--吸星大法，一般人吸3-4体力
	if WAR.BMXH == 2 and 0 < hurt and DWPD() then
		local xt1 = 3 + Rnd(2)
		local n = AddPersonAttrib(eid, "体力", -xt1)
		local m = AddPersonAttrib(pid, "体力", xt1)
		
		--任我行 额外吸3体力
		if match_ID(pid, 26) then
			n = n + AddPersonAttrib(eid, "体力", -3)
			m = m + AddPersonAttrib(pid, "体力", 3)
		end
		--额外见体力
		if JY.Person[pid]["专1"] == 88 then
			n = n + AddPersonAttrib(eid, "体力", -math.random(5)-4)
		end
		
		WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + n;
		WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + m;
	end
	
	--无名，万剑归宗后吸内，回血
	if match_ID(eid, 671) and PersonKF(eid, 198) and JY.Person[eid]["生命"] > 0 and hurt > 50 then
	   local jl = 50
	   if JY.Person[eid]["内力"] < JY.Person[eid]["内力最大值"]*0.5 then
	      jl = jl + 20
	   end
	   if jl > math.random(100) then
	      local xnl = 300 + math.modf(JY.Person[pid]["内力"]*0.05)	 
	       WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -math.modf(xnl*0.7))
		   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", xnl)
		   AddPersonAttrib(eid, "内力最大值", xnl)
		   WAR.Person[enemyid]["特效动画"] = 63
		   Set_Eff_Text(enemyid,"特效文字1","万气自生")
	   end
	end
	
	--主运北冥挨打也吸内
	if Curr_NG(eid, 85) and 0 < hurt and DWPD() and JLSD(20,70,eid) and WAR.JESS[eid] == nil then
		local xnl = 200
		if match_ID(eid, 670) and JY.Person[0]["天赋内功"] == 85 then
		   xnl = xnl + math.modf(JY.Person[pid]["内力"]*0.05)
		end
		--方证不会被吸
		if (match_ID(eid,149) or PersonKF(eid, 207)) then
			xnl = 0
		end
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -xnl)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", xnl)
		AddPersonAttrib(eid, "内力最大值", 2000)
		WAR.Person[enemyid]["特效动画"] = 63
		Set_Eff_Text(enemyid,"特效文字1","百川入海");
	end
	
	--主运吸星挨打也吸内
	if Curr_NG(eid, 88) and 0 < hurt and DWPD() and JLSD(20,70,eid) and WAR.JESS[eid] == nil then
		local xnl = 200
		--方证不会被吸
		if (match_ID(eid,149) or PersonKF(eid, 207)) then
			xnl = 0
		end
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -xnl)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", xnl/2)
		AddPersonAttrib(eid, "内力最大值", 1000)
		WAR.Person[enemyid]["特效动画"] = 71
		Set_Eff_Text(enemyid,"特效文字1","万物相吸");
	end
	
	--主运化功挨打也吸内+上毒
	if Curr_NG(eid, 87) and 0 < hurt and DWPD() and JLSD(20,70,eid) and WAR.JESS[eid] == nil then
		local xnl = 200
		--方证不会被吸
		if (match_ID(eid,149) or PersonKF(eid, 207)) then
			xnl = 0
		end
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -xnl)
		WAR.Person[WAR.CurID]["中毒点数"] = AddPersonAttrib(pid, "中毒程度", math.random(10,15))
		WAR.Person[enemyid]["特效动画"] = 64
		Set_Eff_Text(enemyid,"特效文字1","化功大法");
	end

	--被虚竹生死符击中的
	if WAR.TZ_XZ == 1 and DWPD() then
		WAR.TZ_XZ_SSH[eid] = 1
	end
  
	--中毒计算
	local poisonnum = math.modf(JY.Wugong[wugong]["敌人中毒点数"] + JY.Person[pid]["攻击带毒"])
	if hurt > 30 and DWPD() then
		local kd = JY.Person[eid]["抗毒能力"] + JY.Person[eid]["内力"] / 50
		--周芷若白骨爪无视敌人毒抗
		if match_ID(pid, 631) and wugong == 11 then
			kd = 0
		end
		poisonnum = math.modf((poisonnum - kd) / 4)
		if poisonnum < 0 then
			poisonnum = 0
		end
		--太玄之轻免疫中毒
		if WAR.TXZQ[eid] ~= nil and WAR.TXZQ[eid] == 1 and WAR.JESS[eid] == nil then
			poisonnum = 0
		end
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", math.modf(myrnd(poisonnum)))
	end
	  
	WAR.NGHT = 0	--内功护体
	WAR.CQSX = 0	--除却四相
	WAR.BXJ = 0
	WAR.FLHS4 = 0	--不动如山

	if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "  "
	end
	--误伤不显示动画
	if DWPD() == false and match_ID(eid, 135)==false then
		WAR.Person[enemyid]["特效动画"] = -1
		WAR.Person[enemyid]["特效文字0"] = nil
		WAR.Person[enemyid]["特效文字1"] = nil
		WAR.Person[enemyid]["特效文字2"] = nil
		WAR.Person[enemyid]["特效文字3"] = nil
		WAR.Person[enemyid]["特效文字4"] = nil
		WAR.Person[enemyid]["特效文字5"] = nil
		WAR.Person[enemyid]["特效文字6"] = nil
	end
	
	--被血刀老祖击杀的人物该回合显示动画
	if WAR.XDLZ[eid] ~= nil then
		WAR.Person[enemyid]["特效动画"] = 123
		WAR.XDLZ[eid] = nil
	end   
	
	return limitX(hurt, 0, hurt)
	
end

-- 绘制战斗地图
-- flag=0  绘制基本战斗地图
--     =1  显示可移动的路径，(v1,v2)当前移动坐标，白色背景(雪地战斗)
--     =2  显示可移动的路径，(v1,v2)当前移动坐标，黑色背景
--     =3  命中的人物用白色轮廓显示
--     =4  战斗动作动画  v1 战斗人物pic, v2贴图所属的加载文件id
--                       v3 武功效果pic  -1表示没有武功效果
function WarDrawMap(flag, v1, v2, v3, v4, v5, ex, ey)
	local x = WAR.Person[WAR.CurID]["坐标X"]
	local y = WAR.Person[WAR.CurID]["坐标Y"]
	if not v4 then
		v4 = JY.SubScene
	end
	if not v5 then
		v5 = -1;
	end
  
	if flag == 0 then
		lib.DrawWarMap(0, x, y, 0, 0, -1, v4)
	elseif flag == 1 then
		--胡斐居，雪山，有间客栈，凌霄城，北京城，华山绝顶
		if v4 == 0 or v4 == 2 or v4 == 3 or v4 == 39 or v4 == 107 or v4 == 111 then
			lib.DrawWarMap(1, x, y, v1, v2, -1, v4)
		else
			lib.DrawWarMap(2, x, y, v1, v2, -1, v4)
		end
	elseif flag == 2 then
			lib.DrawWarMap(3, x, y, 0, 0, -1, v4)
	elseif flag == 4 then
		lib.DrawWarMap(4, x, y, v1, v2, v3, v4,v5, ex, ey)
		if WAR.SLX ~= nil then
		lib.DrawWarMap(4, WAR.SLX, WAR.SLY, v1, v2, v3, v4,v5, WAR.SLX, WAR.SLY)
		end
	end
  --豪鬼
	if WAR.ShowHead == 1 then
		WarShowHead()
	end
	
	if CONFIG.HPDisplay == 1 then
		if WAR.ShowHP == 1 then
			HP_Display_When_Idle()	--常态显血
		end
	end
	if WAR.ShowMP == 1 then
	MP_Display_When_Idle()
	end
	
end

--敌方战斗数据
function WarSelectEnemy()
	--敌方数据特别调整
	if PNLBD[WAR.ZDDH] ~= nil then
		PNLBD[WAR.ZDDH]()
	end
  
	for i = 1, 20 do
		if WAR.Data["敌人" .. i] > 0 then
			--冰糖恋：单挑陈达海
			if WAR.ZDDH == 92 and GetS(87,31,33,5) == 1 then
				for i=2,5 do	
					WAR.Data["敌人" .. i] = -1;
				end
			end
			
			--无酒不欢：新论剑敌人
			if WAR.ZDDH == 266 then
				WAR.Data["敌人1"] = GetS(85, 40, 38, 4)
			end
			
			WAR.Person[WAR.PersonNum]["人物编号"] = WAR.Data["敌人" .. i]
			WAR.Person[WAR.PersonNum]["我方"] = false
			WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["敌方X" .. i]
			WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["敌方Y" .. i]
			WAR.Person[WAR.PersonNum]["死亡"] = false
			WAR.Person[WAR.PersonNum]["人方向"] = 1
			--无酒不欢：调整战斗初始面向
			--战海大富
			if WAR.ZDDH == 259 then
				WAR.Person[WAR.PersonNum]["人方向"] = 2
			end
			--双挑公孙止
			if WAR.ZDDH == 273 then
				WAR.Person[WAR.PersonNum]["人方向"] = 3
			end
			--杨过单金轮
			if WAR.ZDDH == 275 then
				WAR.Person[WAR.PersonNum]["人方向"] = 3
			end
			--战杨龙
			if WAR.ZDDH == 75 then
				WAR.Person[WAR.PersonNum]["人方向"] = 3
			end
			--蒙哥
			if WAR.ZDDH == 278 then
				WAR.Person[WAR.PersonNum]["人方向"] = 3
			end
			--芷若夺掌门
			if WAR.ZDDH == 279 then
				WAR.Person[WAR.PersonNum]["人方向"] = 3
			end
			--单挑赵敏
			if WAR.ZDDH == 293 then
				WAR.Person[WAR.PersonNum]["人方向"] = 3
			end
			--玄冥二老
			if WAR.ZDDH == 295 then
				WAR.Person[WAR.PersonNum]["人方向"] = 3
			end
			--三挑岳不群
			if WAR.ZDDH == 298 then
				WAR.Person[WAR.PersonNum]["人方向"] = 2
			end
			--侠客邪
			if WAR.ZDDH == 170 then
				WAR.Person[WAR.PersonNum]["人方向"] = 3
			end
			--拿洗髓
			if WAR.ZDDH == 305 then
				WAR.Person[WAR.PersonNum]["人方向"] = 2
			end
			WAR.PersonNum = WAR.PersonNum + 1
		end
	end
	
	if (JY.Base["畅想"]==147 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 147 or JY.Person[685]["天2"] == 147 or JY.Person[685]["天3"] == 147))) and JY.Base["单通"] == 1 then
	for i=143,148 do
	if i~=147 then
	JY.Person[i]["专1"] = JY.Person[0]["专1"]
	JY.Person[i]["专2"] = JY.Person[0]["专2"]
	JY.Person[i]["生命"] =JY.Person[0]["生命"]
	JY.Person[i]["生命最大值"] = JY.Person[0]["生命最大值"] 
	JY.Person[i]["内力"] = JY.Person[0]["内力"]
	JY.Person[i]["内力最大值"] = JY.Person[0]["内力最大值"]
	JY.Person[i]["天赋内功"] = JY.Person[0]["主运内功"] 
	JY.Person[i]["天赋轻功"] = JY.Person[0]["主运轻功"] 
	JY.Person[i]["攻击力"] = JY.Person[0]["攻击力"]
	JY.Person[i]["防御力"] = JY.Person[0]["防御力"]
	JY.Person[i]["轻功"] = JY.Person[0]["轻功"]
	JY.Person[i]["拳掌功夫"] = math.modf(JY.Person[0]["拳掌功夫"]/3)
	JY.Person[i]["指法技巧"] = math.modf(JY.Person[0]["指法技巧"]/3)
	JY.Person[i]["御剑能力"] = math.modf(JY.Person[0]["御剑能力"]/3)
	JY.Person[i]["耍刀技巧"] = math.modf(JY.Person[0]["耍刀技巧"]/3)
	JY.Person[i]["特殊兵器"] = math.modf(JY.Person[0]["特殊兵器"]/3)
	JY.Person[i]["出战"] = JY.Person[0]["出战"]
	JY.Person[i]["内力性质"] = JY.Person[0]["内力性质"]
	JY.Person[i]["左右互搏"] = JY.Person[0]["左右互搏"]
	JY.Person[i]["资质"] = JY.Person[0]["资质"]
	JY.Person[0]["实战"] = JY.Person[0]["实战"] + JY.Person[i]["实战"]
	if JY.Person[0]["实战"] > 500 then
	   JY.Person[0]["实战"] = 500
	end   
	JY.Person[i]["实战"] = 0
	for t = 1, JY.Person[671]["品德"] do
		JY.Person[i]["武功"..t] = JY.Person[0]["武功"..t]
		JY.Person[i]["武功等级"..t] = JY.Person[0]["武功等级"..t]
	end
	end
	end
	end
	
	if (JY.Base["畅想"]== 41 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 41 or JY.Person[685]["天2"] == 41 or JY.Person[685]["天3"] == 41))) and JY.Base["单通"] == 1 then
	JY.Person[0]["实战"] = JY.Person[0]["实战"] + JY.Person[42]["实战"]
	JY.Person[42]["实战"] = 0
	JY.Person[42]["出战"] = JY.Person[0]["出战"]
	JY.Person[42]["资质"] = JY.Person[0]["资质"]
	JY.Person[42]["内力性质"] = JY.Person[0]["内力性质"]
	JY.Person[42]["左右互搏"] = JY.Person[0]["左右互搏"]
	JY.Person[42]["生命"] =JY.Person[0]["生命"]
	JY.Person[42]["专1"] = JY.Person[0]["专1"]
	JY.Person[42]["专2"] = JY.Person[0]["专2"]
	JY.Person[42]["生命最大值"] = JY.Person[0]["生命最大值"] 
	JY.Person[42]["内力"] = JY.Person[0]["内力"]
	JY.Person[42]["内力最大值"] = JY.Person[0]["内力最大值"]
	JY.Person[42]["天赋内功"] = JY.Person[0]["主运内功"] 
	JY.Person[42]["天赋轻功"] = JY.Person[0]["主运轻功"] 
	JY.Person[42]["攻击力"] = JY.Person[0]["攻击力"]
	JY.Person[42]["防御力"] = JY.Person[0]["防御力"]
	JY.Person[42]["轻功"] = JY.Person[0]["轻功"]
	JY.Person[42]["拳掌功夫"] = math.modf(JY.Person[0]["拳掌功夫"]/3)
	JY.Person[42]["指法技巧"] = math.modf(JY.Person[0]["指法技巧"]/3)
	JY.Person[42]["御剑能力"] = math.modf(JY.Person[0]["御剑能力"]/3)
	JY.Person[42]["耍刀技巧"] = math.modf(JY.Person[0]["耍刀技巧"]/3)
	JY.Person[42]["特殊兵器"] = math.modf(JY.Person[0]["特殊兵器"]/3)
	for t = 1, JY.Person[671]["品德"] do
		JY.Person[42]["武功"..t] = JY.Person[0]["武功"..t]
		JY.Person[42]["武功等级"..t] = JY.Person[0]["武功等级"..t]
	end
	for t = 1, 40 do
		JY.Person[42]["人"..t] = JY.Person[0]["人"..t]
	end
	end
	if WAR.ZDDH == 330 then
		   PlayWavAtk(109)
	end
	
	--无酒不欢：非我方自动运功
	for i = 0, WAR.PersonNum - 1 do
		local pid = WAR.Person[i]["人物编号"]
	
	    if JY.Person[pid]["防具"] == 355 then
	    WAR.QNFJ[pid] = math.random(100)
	    end
		if match_ID(pid, 686) then
		   JY.Person[pid]["生命"] = math.modf(JY.Person[pid]["生命最大值"]*0.7)
		end
		if match_ID(pid, 688) then
		   WAR.QJQC[pid] = 7
		end
		if JY.Person[pid]["人16"] == 1 then
		   WAR.Siphon[pid] = 200
		end
		if JY.Person[pid]["人27"] == 1 then
		   WAR.SPbuff[pid] = 1
		end
		if JY.Person[pid]["人19"] == 1 then
		   WAR.XTGQ[pid] = 1
		end
		--test
		if match_ID(pid, 669) then
		   if instruct_18(144) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地1"] = JYJS1[math.random(#JYJS1)]  
		   end
		   if instruct_18(145) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地2"] = JYJS2[math.random(#JYJS2)]  
		   end
		   if instruct_18(146) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地3"] = JYJS3[math.random(#JYJS3)]  
		   end
		   if instruct_18(147) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地4"] = JYJS4[math.random(#JYJS4)]  
		   end
		   if instruct_18(148) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地5"] = JYJS5[math.random(#JYJS5)]  
		   end
		   if instruct_18(149) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地6"] = JYJS6[math.random(#JYJS6)]  
		   end
		   if instruct_18(150) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地7"] = JYJS7[math.random(#JYJS7)]  
		   end
		   if instruct_18(151) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地8"] = JYJS8[math.random(#JYJS8)]  
		   end
		   if instruct_18(152) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地9"] = JYJS9[math.random(#JYJS9)]  
		   end
		   if instruct_18(153) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["地10"] = JYJS10[math.random(#JYJS10)]  
		   end
		   if instruct_18(154) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["天1"] = JYJS11[math.random(#JYJS11)]  
		   end
		   if instruct_18(155) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["天2"] = JYJS12[math.random(#JYJS12)]  
		   end
		   if instruct_18(156) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["天3"] = JYJS13[math.random(#JYJS13)]  
		   end
		   if instruct_18(157) or JY.Base["天书数量"] >= 28 then
		      JY.Person[669]["天4"] = JYJS14[math.random(#JYJS14)]  
		   end
		end
		--大蛇
		if match_ID(pid, 48) and JY.Person[48]["天4"] == 1 then
		   for d = 0, WAR.PersonNum - 1 do
		   local did = WAR.Person[d]["人物编号"]
		       if WAR.Person[i]["我方"] ~= WAR.Person[d]["我方"] then
			      WAR.JESS[did] = 21 + math.random(6)
			   end
		   end
		end

		if match_ID(pid, 112) then
			WAR.XYS = 3
		end
		if match_ID(pid, 52) and JY.Person[52]["阶"] >= 3 then
			WAR.HTG = JY.Person[pid]["武功2"]
		end
		if match_ID(pid, 673) and JY.Person[673]["阶"] >= 2 then
			WAR.LQZ[pid] = 100
		end
		if match_ID(pid, 59) and JY.Person[59]["阶"] >= 2 then
			WAR.XLN[pid] = JY.Person[59]["阶"] - 1
		end
		--灭绝
		if match_ID(pid, 6) and JY.Person[6]["阶"] >= 3 then
		   WAR.MJST[pid] = 1
		end
        --平一指
		if match_ID(pid, 28) and JY.Person[28]["阶"] >= 2 then
		   WAR.JJSY[pid] = 2
		end	
        --狄云
		if match_ID(pid, 37) and JY.Person[37]["阶"] >= 3 then
		   WAR.DYSZ[pid] = math.modf(JY.Person[pid]["内力最大值"]/3000)
		end		
		   
		if JY.Person[pid]["人39"] == 1 then
		   for d = 0, WAR.PersonNum - 1 do
		   local did = WAR.Person[d]["人物编号"]
		       if WAR.Person[i]["我方"] ~= WAR.Person[d]["我方"] then
			      WAR.Jiaox[did] = 1
			   end
		   end
		end
		if JY.Person[pid]["地8"] == 7 then
		   for d = 0, WAR.PersonNum - 1 do
		   local did = WAR.Person[d]["人物编号"]
		       if JY.Person[did]["地8"] ~= 7 then
			      WAR.JESS[did] = 20
			   end
		   end
		end
		if JY.Person[pid]["地10"] == 7 then
		   for d = 0, WAR.PersonNum - 1 do
		   local did = WAR.Person[d]["人物编号"]
		       if JY.Person[did]["地10"] ~= 7 and WAR.Person[i]["我方"] ~= WAR.Person[d]["我方"] then
			      JY.Person[did]["生命"] = JY.Person[did]["生命最大值"]*0.5
				  JY.Person[did]["内力"] = JY.Person[did]["内力最大值"]*0.5
			   end
		   end
		end
		if JY.Person[pid]["人37"] == 1 then
		   for d = 0, WAR.PersonNum - 1 do
		   local did = WAR.Person[d]["人物编号"]
		       if WAR.Person[i]["我方"] ~= WAR.Person[d]["我方"] then
			      JY.Person[did]["生命"] = JY.Person[did]["生命"]*0.9
				  JY.Person[did]["中毒程度"] = 30 + math.modf(JY.Person[pid]["实战"]*0.1)
				  JY.Person[did]["受伤程度"] = 30 + math.modf(JY.Person[pid]["实战"]*0.1)
				  JY.Person[did]["冰封程度"] = 30 + math.modf(JY.Person[pid]["实战"]*0.1)
				  JY.Person[did]["灼烧程度"] = 17 + math.modf(JY.Person[pid]["实战"]*0.1)
			   end
		   end
		end
		if match_ID(pid, 15) then
		WAR.QGZT[pid] = 1 + math.modf(JY.Person[pid]["实战"]*0.01)
	    end
		if inteam(pid) == false or WAR.Person[i]["我方"] == false then
			if JY.Person[pid]["天赋内功"] > 0 then
				JY.Person[pid]["主运内功"] = JY.Person[pid]["天赋内功"]
			end
			if JY.Person[pid]["天赋轻功"] > 0 then
				JY.Person[pid]["主运轻功"] = JY.Person[pid]["天赋轻功"]
			end
		end
		if inteam(pid) == true or WAR.Person[i]["我方"] == true then
			if JY.Person[pid]["主运内功"] == 0 then
				JY.Person[pid]["主运内功"] = 190
			end
			if JY.Person[pid]["主运轻功"] == 0 then
				JY.Person[pid]["主运轻功"] = 191
			end
		end
		
		--阶
		if JY.Base["难度"] >= 3 then
		   if (JY.Person[0]["阶"] > 0 or JY.Person[JY.Base["畅想"]]["阶"] > 0) then
		       local t = math.max(JY.Person[0]["阶"], JY.Person[JY.Base["畅想"]]["阶"])
			   if not inteam(pid) and pid ~= JY.Base["畅想"] then
			      if JY.Base["难度"] <= 5 and math.random(100) < 10 + JY.Base["天书数量"]*3 then
			         JY.Person[pid]["阶"] = math.random(t)
				  elseif JY.Base["难度"] <= 7 and math.random(100) < 20 + JY.Base["天书数量"]*4 then
				     JY.Person[pid]["阶"] = math.random(t)
					 if JY.Person[pid]["阶"] < t and math.random(100) < 10 + JY.Base["天书数量"] then
					    JY.Person[pid]["阶"] = t
					 end
				  elseif math.random(100) < 15 + JY.Base["天书数量"]*5 then
				     JY.Person[pid]["阶"] = math.random(t)
					 if JY.Person[pid]["阶"] < t and math.random(100) < 20 + JY.Base["天书数量"] then
					    JY.Person[pid]["阶"] = t
					 end
					 if math.random(100) < JY.Base["天书数量"]*2 then
					    JY.Person[pid]["阶"] = 3
					 end
				  end
			   end
		   end
		end
		
		if WAR.Person[i]["我方"] == false and WAR.ZDDH ~= 329 then
		--地
		   if WAR.ZDDH == 321 then
		   local t = math.modf(JY.Person[124]["天1"]/13)+2
		   if t > 9 then
		      t = 9
		   end
		     for i = 1, t do 
                JY.Person[pid]["地"..i] = math.random(7)
             end
		   end
		   
		   if WAR.ZDDH ~= 321 and JY.Person[126]["声望"] == 100 then
		      if math.random(430-40*JY.Base["难度"]) < JY.Person[0]["实战"] then
			  local x, y = math.random(8), math.random(7)
			     JY.Person[pid]["地"..x] = y
				 if x == 3 and y == 1 then
				     AddPersonAttrib(pid, "拳掌功夫", 30)
	                 AddPersonAttrib(pid, "指法技巧", 30)
	                 AddPersonAttrib(pid, "御剑能力", 30)
	                 AddPersonAttrib(pid, "耍刀技巧", 30)
	                 AddPersonAttrib(pid, "特殊兵器", 30)
				  end
				  if x == 9 and y == 2 then
				  local str = {"拳掌功夫","指法技巧","御剑能力","耍刀技巧","特殊兵器","攻击力","防御力","轻功","暗器技巧","武学常识","攻击带毒","医疗能力","用毒能力","解毒能力","抗毒能力","生命最大值","内力最大值"}
				     for a = 1, #str do
					     AddPersonAttrib(pid, str[a], 9999)
					 end	  
				  end
				  if x == 6 then
				     if y == 1 then
					    JY.Person[pid]["出战"] = 1
					 elseif y == 2 then	
					    JY.Person[pid]["左右互搏"] = 1
					 end
				  end
			  end
		   end
		   
		   JY.Person[pid]["武功等级16"] =  499 + JY.Person[0]["实战"]
		   if (JY.Person[0]["专1"] > 0 or JY.Person[0]["专2"] > 0) and JY.Person[0]["实战"] > 200 then
		      for i = 1, JY.Person[671]["品德"] do
			      if ((JY.Wugong[JY.Person[pid]["武功"..i]]["攻击力10"] <= 800 and JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] < 6 and JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] > 0) or 
				  (JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] == 6 and JY.Wugong[JY.Person[pid]["武功"..i]]["积分"] < 40) or
				  JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] == 7) and ZJINS[JY.Person[pid]["武功"..i]] ~= nil then
				     JY.Person[pid]["专1"] = JY.Person[pid]["武功"..i]
					 break
				  end
			  end
		   end
		   if JY.Person[0]["专2"] > 0 and JY.Person[0]["实战"] > 400 then
		      for i = 1, JY.Person[671]["品德"] do
			      if ((JY.Wugong[JY.Person[pid]["武功"..i]]["攻击力10"] > 800 and JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] < 6 and JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] > 0) or 
				  (JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] == 6 and JY.Wugong[JY.Person[pid]["武功"..i]]["积分"] >= 40)) and ZJINS[JY.Person[pid]["武功"..i]] ~= nil then
				     JY.Person[pid]["专2"] = JY.Person[pid]["武功"..i]
					 break
				  end
				  
			  end
		   end
		   --星河难度
		   if JY.Base["难度"] == 8 and pid ~= 35 and pid ~= 52 and pid ~= 48 then
		   local zwg = {}
		   for i = 1, JY.Person[671]["品德"] do
			   zwg[i] = JY.Person[0]["武功"..i]
		   end
		      for i = 1, 6 do
			      if JY.Person[pid]["武功"..i] == 0 then
				     JY.Person[pid]["武功"..i] = zwg[math.random(#zwg)]
					 JY.Person[pid]["武功等级"..i] = 999
					 break
				  end
			  end		  
		   end
		   
		   if pid == 689 then
		   local t = math.random(4)
		      if t == 1 then
			  JY.Person[pid]["专1"] = 228
			  elseif t == 2 then
			  JY.Person[pid]["专1"] = 229
			  elseif t == 3 then
			  JY.Person[pid]["专1"] = 231
			  elseif t == 4 then
			  JY.Person[pid]["专1"] = 234
			  end
		   end
		   
		end
	end
end

--计算战斗人物贴图
function WarCalPersonPic(id)
	local n = 5106
	n = n + JY.Person[WAR.Person[id]["人物编号"]]["头像代号"] * 8 + WAR.Person[id]["人方向"] * 2
	return n
end

--计算标准主角特殊行走贴图
function WarCalPersonPic2(id, gender)
	local n = 5058
	if gender == 1 then
		n = 5010
	end
	n = n + WAR.Person[id]["人方向"] * 12
	return n
end

--战斗是否结束
function War_isEnd()
	for i = 0, WAR.PersonNum - 1 do
		if JY.Person[WAR.Person[i]["人物编号"]]["生命"] <= 0 then
			WAR.Person[i]["死亡"] = true
		end
	end
	WarSetPerson()
	Cls()
	ShowScreen()
	local myNum = 0
	local EmenyNum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			if WAR.Person[i]["我方"] == true then
				myNum = 1
			else
				EmenyNum = 1
			end
		end
	end

	if EmenyNum == 0 then
		return 1;
	end
	if myNum == 0 then
		return 2;
	end
	return 0
end

--无酒不欢：战斗是否结束2
function War_isEnd2()
	local myNum = 0
	local EmenyNum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			if WAR.Person[i]["我方"] == true then
				myNum = 1
			else
				EmenyNum = 1
			end
		end
	end

	if EmenyNum == 0 then
		return 1;
	end
	if myNum == 0 then
		return 2;
	end
	return 0
end

--设置战斗全局变量
function WarSetGlobal()
	WAR = {}
	WAR.Data = {}
	WAR.Person = {}
	WAR.MCRS = 0 --无酒不欢：每场战斗选的人数
	for i = 0, 30 do
		WAR.Person[i] = {}
		WAR.Person[i]["人物编号"] = -1
		WAR.Person[i]["我方"] = true
		WAR.Person[i]["坐标X"] = -1
		WAR.Person[i]["坐标Y"] = -1
		WAR.Person[i]["死亡"] = true
		WAR.Person[i]["人方向"] = -1
		WAR.Person[i]["贴图"] = -1
		WAR.Person[i]["贴图类型"] = 0
		WAR.Person[i]["轻功"] = 0
		WAR.Person[i]["移动步数"] = 0
		WAR.Person[i]["经验"] = 0
		WAR.Person[i]["自动选择对手"] = -1
		WAR.Person[i].Move = {}
		WAR.Person[i].Action = {}
		WAR.Person[i].Time = 0
		WAR.Person[i].TimeAdd = 0
		WAR.Person[i].SpdAdd = 0
		WAR.Person[i].Point = 0
		WAR.Person[i]["特效动画"] = -1
		WAR.Person[i]["反击武功"] = -1
		WAR.Person[i]["特效文字0"] = nil
		WAR.Person[i]["特效文字1"] = nil
		WAR.Person[i]["特效文字2"] = nil
		WAR.Person[i]["特效文字3"] = nil
		WAR.Person[i]["特效文字4"] = nil
		WAR.Person[i]["特效文字5"] = nil
		WAR.Person[i]["特效文字6"] = nil
			--无酒不欢：加到这里 8-11
	end
	WAR.PersonNum = 0
	WAR.AutoFight = 0
	WAR.CurID = -1
	WAR.SXTJ = 0		--时序
	WAR.ESX_Counter = 0	--2时序计数器
	WAR.SSX_Counter = 0	--三时序计数器
	WAR.WSX_Counter = 0	--五时序计数器
	WAR.LSX_Counter = 0	--六时序计数器
	WAR.JSX_Counter = 0	--九时序计数器
	WAR.ZSHY = {}		--转瞬红颜计数器
	WAR.TCQ =0
	WAR.WGWL = 0		--记录武功10级的攻击力
	WAR.ZYHB = 0		--左右互搏，1：发动左右的回合，2：左右的额外回合
	WAR.ZYHBP = -1		--记录发动左右的人的编号
	WAR.CLBF = 0
	WAR.HSSD = 0
	WAR.ZHB = 0			--周伯通的追加左右判定
	WAR.AQBS = 0		--暗器倍数
	WAR.FYYS = 0
	WAR.HLB = 0
	WAR.XLFD = 0
	WAR.BJ = 0			--暴击
	WAR.ZJZBJ = 0		--朱九真暴击
	WAR.XK = 0			--西狂之怒啸
	WAR.XK2 = nil
	WAR.WTL = 0
	WAR.SLJF = 0
	WAR.SLJFB = 0
	WAR.XYJ = 0
	
	WAR.TD = -1			--偷盗
	WAR.TDnum = 0		--偷盗数量
	WAR.HTSS = 0		--医生大招
	WAR.ZSF = 0			--张三丰万法自然
	WAR.XZZ = 0			--虚竹福泽加护
	WAR.PG = 0
	
	WAR.ZLPK = 0        --浊浪排空
	WAR.PLKD = 0
	WAR.WLJ = 0
	WAR.TNSF = 0
	
	WAR.KFKJ = 0		--封不平狂风快剑
	WAR.JZSJ = 0
	WAR.XMKFJ = 0
	WAR.WCY = {}		--一灯复活
	WAR.RZWD = {}
	WAR.EFLH = {}
	WAR.NQK = {}
	WAR.XJSFH = {}
	WAR.PYDM = {}
	WAR.CYZX = {} 		--王重阳复活
	WAR.ZHRM = {} 		--萧远山走火入魔
	WAR.BDQS = 0		--王重阳北斗真打状态层数
	WAR.QJQC = {}
	WAR.SPbuff = {}
	WAR.DrugD = {}
	WAR.XYS = 0			--萧远山杀破狼
	WAR.QCF = 0			--戚长发复活
	WAR.HTS = 0			--何铁手五毒随机2-5倍威力
	WAR.QKYZ = 0		--林月如乾坤一掷
	WAR.FS = 0			--四帮主之战，乔峰用铁掌
	WAR.ZBT = 1			--周伯通，每行动一次，攻击时伤害一+10%
	WAR.DJSS = 0
	WAR.SLSCZ = 0
	WAR.LBDIS = 0
	WAR.HCDLW = {}
	WAR.WJBH = 0		--无酒不欢持之以恒
	WAR.HQT = 0			--霍青桐 杀体力
	WAR.CY = 0			--程英 杀内力
	WAR.HDWZ = 0		--霍都随机上毒
	WAR.ZJZ = 0			--朱九真，随机得到食材
	WAR.YJ = 0			--阎基偷钱
	WAR.XMH = 0			--薛慕华 复活一个人
	WAR.PYZ = 0			--平一指杀人
	WAR.DJGZ = 0		--刀剑归真
	WAR.WS = 0			--误伤
	WAR.ACT = 1			--连击回数
	WAR.ZDDH = -1		--战斗代号
	WAR.NO1 = -1		--旧版论剑第一名
	WAR.TJAY = 0		--太极奥义
	WAR.WDKTJ = 0		--开太极
	WAR.LYSH = 0 		--两仪守护
	WAR.HLJS = 0
	WAR.LXYZF = 0
	WAR.DZXY = 0		--斗转星移
	WAR.DZXYLV = {}
	WAR.JGGLZ = 0
	WAR.ALH = 0
	WAR.fthurt = 0		--乾坤反弹的伤害
	WAR.LXZQ = 0		--拳主大招
	WAR.LXYZ = 0		--指主大招
	WAR.JSYX = 0		--剑神大招
	WAR.ASKD = 0		--刀主大招
	WAR.YSXL = 0		--参合指
	
	
	WAR.BLJY = 0        --碧落九重剑剑意
	
	WAR.SLX = nil
	WAR.SLY = nil
	
	WAR.YZHYZ = 0		--刀主大招增加怒气计数
	WAR.GCTJ = 0		--奇门大招
	WAR.JSTG = 0		--天罡大招
	WAR.YTML = 0 		--毒王大招
	WAR.HBMZ = 0
	WAR.DGGF = 0
	WAR.LMSJ = 0
	WAR.NGXS = 0		--内功攻击的系数
	WAR.TXZZ = 0		--太玄之重
	WAR.MMGJ = 0		--盲目攻击
	WAR.MMGJ2 = 0
	--WAR.TFBW = 0		--听风辨位的文字记录
	--WAR.TLDWX = 0		--天罗地网的文字记录
	WAR.JSAY = 0		--金蛇奥义
	WAR.TLDW = {}		--天罗地网
	WAR.OYFXL = 0 		--欧阳锋根据蛤蟆蓄力增加伤害
	WAR.XDLeech = 0		--血刀吸血量
	WAR.JSHJab = 0
	WAR.WYXLeech = 0	--韦一笑吸血量
	WAR.WYXleech2 = 0
	WAR.TMGLeech = 0	--天魔功吸血量
	WAR.RENLeech = 0
	WAR.PYZLeech = 0
	WAR.YYZLeech = 0
	WAR.LLXLeech = 0
	WAR.BMSGXL = 0		--吸星大法吸怒
	WAR.XHSJ = 0		--血河神鉴吸血量
	WAR.WDRX = 0		--宋远桥使用太极拳或太极剑攻击后自动进入防御状态
	WAR.AER = 0			--阿二使用龙爪手攻击后自动进入蓄力状态
	WAR.KMZWD = 0 		--周伯通空明之武道
	WAR.SJDR = 0 
	WAR.XTQKG = 0		--先天乾坤功
	WAR.ARJY = 0		--黯然极意
	WAR.TZYQ = 0
	WAR.XYDD = 0
	WAR.LBJY = 0
	WAR.MSHBD = 0
	WAR.MSHSL = 0
	WAR.QXQ = 0
	
	WAR.SPSJ = 0        --三破神机
	WAR.ZHDJY = 0		--真苗剑极意
	WAR.HQGXL = 0		--洪七公降龙
	WAR.HQGDG = 0		--洪七公打狗
	WAR.SDXT = 0
	WAR.SDXTH = 0
	WAR.SYZY = 0
	WAR.SYZYH = 0
	WAR.LFHX = 0 		--林朝英流风回雪
	WAR.YYBJ = 0 		--郭靖：有余不尽
	WAR.YNXJ = 0		--玉女心经：夭矫空碧
	WAR.HXZYJ = 0		--会心之一击
	WAR.QQSH1 = 0		--琴棋书画之持瑶琴
	WAR.QQSH2 = 0		--琴棋书画之妙笔丹青
	WAR.QQSH3 = 0		--琴棋书画之倚天屠龙功
	WAR.YZQS = 0		--一震七伤
	WAR.LIBAI = 0
	WAR.DHCG = 0

	WAR.WKBP = 0
	WAR.WJBC = 0
	WAR.TYJQ = 0		--阿青天元剑气
	WAR.NFCD = 0
	WAR.RJSD = 0
	WAR.ZXSG = 0		--紫霞神功
	WAR.OYK = 0 		--欧阳克灵蛇拳
	WAR.HDF = 0 		--海大富化骨绵掌	
	WAR.YKDD = 0 		--一空到底
	WAR.ADA = 0 		--阿大八臂神剑
	WAR.DDSQ = 0
	WAR.NFMD = 0
	WAR.JQBYH = 0		--六脉：剑气碧烟横
	WAR.CMDF = 0		--沧溟刀法
	WAR.NZQK = 0		--逆转乾坤
	WAR.TXXS = {} 		--特效点数显示
	WAR.BXCF = 0 		--袁承志碧血长风
	WAR.XFXY = 0
	WAR.FLHS1 = {}		--其疾如风
	WAR.FLHS2 = 0		--其徐如林
	WAR.FLHS2C = 3
	WAR.FLHS4 = 0		--不动如山
	WAR.FLHS5 = 0		--难知如阴
	WAR.FLHS6 = 0		--动如雷震
	WAR.NGJL = 0		--当前加力内功编号
	WAR.NGHT = 0		--当前护体内功编号
	WAR.CQSX = 0		--除却四相
	WAR.BXJ = 0
	
	WAR.BMXH = 0		--三大吸功
	WAR.ZYYD = 0		--记录左右的圣火移动步数
	WAR.XYZD = 0
	WAR.LMSJwav = 0		--六脉神剑的音效
	WAR.NJDJ=0			--降龙音效
	WAR.JGZ_DMZ = 0		--达摩掌
	WAR.LHQ_BNZ = 0		--般若掌
	WAR.LHQ_YKDD = 0	--一空到底
	WAR.YZC_MKZ = 0 	--摩柯指
	WAR.FMZ_BFSC = 0 	--八法神禅
	WAR.WD_CLSZ = 0		--赤练神掌
	WAR.ShowHead = 0	--显示右下角头像信息
	WAR.Effect = 0		--本次攻击的效果，2：伤害，3：杀内，4：医疗，5：上毒，6：解毒
	WAR.Delay = 0
	WAR.LifeNum = 0
	WAR.EffectXY = nil
	WAR.EffectXYNum = 0
	WAR.tmp = {}		--200：蛤蟆功蓄力，1000：欧阳锋逆运走火，2000：太极拳蓄力，3000：神照复活，5000：头像编号
	WAR.Actup = {}		--蓄力记录
	WAR.Defup = {}		--防御记录
	WAR.Wait = {}		--等待记录
	WAR.Focus = {}		--集中记录
	WAR.HMGXL = {}		--蛤蟆蓄力增加300集气
	WAR.Weakspot = {}	--破绽计数
	WAR.KHBX = 0		--葵花刺目
	WAR.KHCM = {}		--被刺目的人记录
	WAR.HBMZJS = {}
	WAR.DGGFJS = {}
	WAR.LQZ = {}		--怒气值
	WAR.FXDS = {}		--封穴点数
	WAR.FXXS = {}		--封穴显示
	WAR.LXZT = {}		--流血点数
	WAR.LXXS = {}		--流血显示
	WAR.BFXS = {}		--冰封显示
	WAR.ZSXS = {}		--灼烧显示
	WAR.SZJPYX = {}		--已经提供过实战的人记录（被打死的）
	WAR.TZ_MRF = 0		--慕容复指令
	WAR.TZ_DY = 0		--段誉指令
	WAR.TZ_XZ = 0		--虚竹指令
	WAR.TZ_XZ_SSH = {}	--中了生死符的人记录
	WAR.BFX = 0			--必封穴
	WAR.BLX = 0			--必流血
	WAR.BBF = 0 		--必冰封
	WAR.BZS = 0			--必灼烧
	WAR.TXZQ = {}		--太玄之轻
	
	WAR.JQJQ = 0
	
	WAR.Siphon = {}
	WAR.LHHF = {}       --豪鬼，罗汉
	WAR.QHTR = {}
	WAR.NLZ = {}
	
	WAR.JQSDXS = {} 	--无酒不欢：集气速度显示
	WAR.TWLJ = 0 		--天外连击
	WAR.hit_DGQB = 0	--无酒不欢：独孤求败反击的特效显示
	WAR.hit_XWXG = 0	--小无相功反击
	WAR.hit_AHLJ = 0
	WAR.hit_LHLJ = 0

	WAR.XWXGNAME= {}
	WAR.XWXGSB = {}		--小无相功闪避
	WAR.SMLHSB = {}
	WAR.WXFS = nil		--李秋水无相分身的编号记录
	WAR.ZCFS = nil
	WAR.JJPZ = {} 		--无酒不欢：九剑破招
	WAR.TKJQ = {}		--太空卸劲减少集气
	WAR.YJZD = {}
	WAR.JQHY = {}
	WAR.JJZC = 0		--九剑真传的4种主动攻击特效
	WAR.JJDJ = 0 		--九剑荡剑式回气
	WAR.Dodge = 0		--判定是否闪避
	WAR.PTGJ = {}
	WAR.YTZ = {}
	WAR.SYQ = {}
	WAR.XLN = {}
	WAR.TQ = {}
	WAR.TQLJ = 1
	WAR.TQLJ2 = 0
	WAR.TQGJ = {}
	WAR.TQFY = {}
	WAR.TQLQ = {}
	WAR.DDJQ = {}
	WAR.TQJQ = {}
	WAR.ZJSB = {}
	WAR.ZJJQ = {}
	WAR.ZJbuff = {}
	WAR.ZJDbuff = {}
	WAR.WMJY = {}
	WAR.WMCS = {}
	WAR.TJZX = {}		--太极之形记录
	WAR.TJZX_LJ = 0		--太极之形连击
	WAR.CXLC = 0		--狄云赤心连城
	WAR.CXLC_Count = 0	--狄云赤心连城计数
	WAR.FQY = 0			--风清扬无招胜有招
	WAR.WZSYZ = {}		--被无招胜有招击中的人
	WAR.ZXXS = {}		--紫霞蓄力
	WAR.GMYS = 0		--范遥挨打加减伤
	WAR.GMZS = {}		--被杨逍打中的人记录
	WAR.ZZZS = {}		--精心打磨记录
	WAR.LPZ = 0			--林平之回气
	WAR.WXLW = 0
	
	WAR.JYFX = {}		--九阳7时序解除封穴
	WAR.L_TLD = 0;		--装备屠龙刀特效，1流血
	WAR.PJTX = 0 		--玄铁剑配玄铁剑法，破尽天下
	WAR.QYBY = {}		--林朝英轻云蔽月，每50时序可触发一次，免疫伤害10时序
	WAR.XTGQ = {}
	WAR.LJXS = {}
	WAR.WDZT = {}
	WAR.DFZR = {}
	WAR.XZ_YB = {}		--小昭影步记录
	WAR.LSQ = {}		--被灵蛇拳击中的人记录
	WAR.LSQ2 = {}
	WAR.LSQ3 = {}
	WAR.HGMZ = {}		--被海大富化骨绵掌击中的人记录	
	WAR.HKHL={}			--被花开花落击中的人的记录
	WAR.JJCD = {}		--破X式记录
	WAR.YKDD1 = {}		--玄慈一空到底
	WAR.YKDD2 = {}
	WAR.BBSJ = {}		--阿大八臂神剑
	WAR.SFGYQ = {}		--三分归元气
	WAR.QFKDP = {}		--七分靠打拼
	
	WAR.YFMM = {}       
	
	WAR.JESS = {}       --剑廿三
	WAR.YYXS = {}
	WAR.QJJB = {}

	WAR.QNFJ = {}
	WAR.JQDT = {}
  
	WAR.L_EffectColor = {}					--异常状态的颜色显示
	WAR.L_EffectColor[1] = M_Silver;		--显示减少生命
	WAR.L_EffectColor[2] = M_Pink;			--显示增加生命
	WAR.L_EffectColor[3] = M_LightBlue;		--显示解毒
	WAR.L_EffectColor[4] = M_DeepSkyBlue;	--显示内力减少和增加
	WAR.L_EffectColor[5] = M_PaleGreen;		--显示体力减少和增加
	WAR.L_EffectColor[6] = C_GOLD;			--显示封穴
	WAR.L_EffectColor[7] = M_Red;			--显示流血
	WAR.L_EffectColor[8] = M_DarkGreen;		--显示中毒
	WAR.L_EffectColor[9] = PinkRed;			--显示内伤减少和增加
	WAR.L_EffectColor[10] = LightSkyBlue;	--显示冰封
	WAR.L_EffectColor[11] = C_ORANGE;		--显示灼烧
	
  
	WAR.L_WNGZL = {};		--王难姑指令，持续中毒减血
	WAR.L_HQNZL = {};		--胡青牛指令，持续回血回内伤
  
	WAR.L_QKDNY = {};		--设定攻击多个人时，乾坤只能被反一次
  	WAR.L_XWXGFT = {}
	WAR.L_NOT_MOVE = {};	--记录不可移动的人
	WAR.XDLZ = {};			--记录被血刀老祖杀掉的人
	WAR.ZZRZY = 0			--周芷若领悟左右的剧情
	WAR.ZZRZY2 = 0			--增加NPC参战防无限触发
	WAR.ZZRZY3 = 0
	WAR.ZZRZY4 = 0
	WAR.ZZRZY5 = 0
	WAR.ZZRZY6 = 0
	WAR.ZZRZY7 = 0
	WAR.XTTX = 0			--先天调息

	WAR.ShowHP = 1			--血条显示
	WAR.ShowMP = 1
	
	WAR.FF = 0				--主角觉醒后，喵姐开局前三次不受伤害
	WAR.WJ = 0				--无酒不欢 无喵不欢
	
	WAR.ZQHT = 0 			--是否触发真气护体
	WAR.TSSB = {}			--进阶泰山，使用后30时序内闪避
	WAR.TSSJ = {}
	WAR.YWSS = {}
	WAR.NSDF = {}			--南山刀法，使用后10时序内不动如山
	WAR.JDYJ = {}			--剑胆琴心增加御剑能力
	WAR.YWDJ = {}
	WAR.DYTQ = {}
	
	WAR.YXMM = {}           --隐姓埋名
	WAR.PPWQ = {}
	WAR.ZMSZ = {}           --真名神照
	
	WAR.WMYH = {}			--无明业火状态，耗损使用的内力一半的生命
	
	WAR.JHLY = {}			--无酒不欢：举火燎原，金乌+燃木+火焰刀
	WAR.LRHF = {}			--无酒不欢：利刃寒锋，修罗+阴风+沧溟
	WAR.BDZX = {}
	WAR.JSLQ = {}
	WAR.YLMB = {}
	WAR.FCZX = {}
	WAR.LDXJ = {}
	WAR.CZSB = {}
	WAR.SWKY = {}
	
	WAR.BLZ = {}
	WAR.KLYHB = {}
	
	WAR.KQB = {}
	
	WAR.LZ_S = {}
	WAR.LZ_H = {}
	WAR.LZ_Z = {}
	WAR.LZ_L = {}
	WAR.LZ_D = {}
	WAR.ZWZX = {}
	WAR.SHMY = {}
	WAR.JYSY = {}
	WAR.JJSY = {}
	WAR.DYSZ = {}
	WAR.KFDF = {}
	WAR.XQJQ = {}
	for i = 0, 692 do
	    WAR.XQJQ[i] = {}
	end
	--"蛇蛊","金蚕蛊","蔑片蛊","石头蛊","泥瞅蛊","惘蛊","肿蛊","癫蛊","姑蛊"
	WAR.GSG = {}
	WAR.GJCG = {}
	WAR.GMPG = {}
	WAR.GSTG = {}
	WAR.GNQG = {}
	WAR.GWG = {}
	WAR.GZG = {}
	WAR.GDG = {}
	WAR.GGG = {}
	
	WAR.SDD = {}
	WAR.SDD2 = {}
	WAR.TGLX = {}
	
	WAR.SYBD = {}
	WAR.MXD = {}
	WAR.XLT = {}
	WAR.SHK = {}
	
	WAR.LSF = {}
	
	WAR.QSQ = {}
	WAR.WYSQ = {}
	WAR.HBZQDJ = {}
	WAR.HBZQJS = {}
	WAR.MDLX = {}
	WAR.KXS = {}
	
	WAR.SLSX = {}			--金轮，十龙十象
	WAR.HMZT = {}			--昏迷状态
	
	WAR.JYZT = {}			--阿紫，禁药状态
	WAR.MZSH = 0			--阿紫曼珠沙华，每杀一个人+200气攻气防
	
	WAR.SZSD = -1			--被死战锁定的目标
	
	WAR.CSZT = {}			--沉睡状态
	
	WAR.PJZT = {}			--破军状态
	WAR.PJJL = {}			--被破军前的内功记录
	WAR.LZ_HH = {}
	
	WAR.JYPJ = {}
	WAR.Adapt = {}
	for i = 0, 694 do
	WAR.Adapt[i] = {}
	end
	WAR.KungfuLQ = {}
	for i = 0, 694 do
	WAR.KungfuLQ[i] = {}
	WAR.KungfuLQ[i][223] = 7
	WAR.KungfuLQ[i][200] = 4
	end
	
	WAR.WGJY = {}
	WAR.WGJY2 = {}
	WAR.WGJY3 = {}
	WAR.XHTT = {}
	WAR.YSJF = {}			--玉石俱焚
	
	WAR.HLZT = {}			--混乱状态
	
	WAR.QYZT = {}			--琴音状态
	
	WAR.XRZT = {}			--虚弱状态
	
	WAR.QSQ6 = {}
	
	WAR.QGZT = {}			--倾国状态
	
	WAR.MJST = {}
	
	WAR.BXZS = 0				--辟邪招式
	WAR.BXLQ = {}				--辟邪冷却记录
	WAR.BXCD = {0,1,0,1,2,3}	--辟邪冷却时间
	
	WAR.MMZS = 0            --莫名剑法招式
	
	WAR.AHZS = 0				--辟邪招式
	WAR.AHLQ = {}				--辟邪冷却记录
	WAR.AHCD = {0,1,1,1,1,0}
	
	WAR.MMLQ = {}
	WAR.MMCD = {2,0,0,2,3,2,1,1,5,4}
	
	WAR.LMLQ = {}
	WAR.LMCD = {0,1,1,1,2,2}
	
	WAR.SFZS = 0				--三分招式
	WAR.SFLQ = {}				--三分冷却记录
	WAR.SFCD = {1,1,1,3}	--三分冷却时间
	
	WAR.YSJZS = 0			
	WAR.YSJLQ = {}	
	WAR.YSJCD = {1,1,1,3}
	
	WAR.YSZZS = 0				
	WAR.YSZLQ = {}				
	WAR.YSZCD = {1,1,1}
	
	WAR.KHSZ = 0			--葵花神针
	
	WAR.JSBM = {}			--金身不灭
	
	WAR.ZWYJF = 0			--有剑诀的五岳剑法，无视绝对气防
	
	WAR.TXZS = 0 			--太玄招式
	
	WAR.XYYF = {}			--逍遥御风
	
	WAR.XYYF_10 = 0			--本回合逍遥御风累积至9点
	
	WAR.YFCS = 0			--逍遥御风次数
	WAR.DZXYCS = 0
	WAR.XXDFCS = 0
	
	WAR.JuHuo = 0			--举火燎原
	WAR.LiRen = 0			--利刃寒锋
	
	WAR.YZHH = 0
	WAR.HBZQ = 0
	WAR.WLDF = 0
	WAR.YHDF = 0
	WAR.AHGJ = 0
	WAR.CBDF = 0
	WAR.SHJD = 0
	WAR.DJJ = 0
	WAR.SDLT = 0
	WAR.QXQ = 0
	
	WAR.LWX = 0				--李文秀的破气防特效
	WAR.LXZL10 = 0			--龙象之力暴怒，忽视绝对气防
	WAR.QHTRG = 0
	WAR.LXYZG = 0
	
	WAR.PDJN = 0			--陈家洛庖丁解牛
	
	WAR.ZQTL = {}			--紫气天罗
	WAR.BLZZ = {}
	WAR.KLYH = {}
	WAR.BLOOD = {}
	WAR.XJSBZ = {}
	WAR.MRSD = {}
	WAR.YQQ = {}
	WAR.KJZ = {}
	WAR.Jiaox = {}
	WAR.XTZJ = {}			--玄铁重击（名字待定）
	
	WAR.ZTHSB = 0			--诸天化身步
	WAR.ZT_id = -1			--触发人的ID
	WAR.ZT_X = -1			--触发人的X坐标
	WAR.ZT_Y = -1			--触发人的Y坐标
	
	WAR.Miss = {}			--闪避的miss显示
	WAR.PIC = {}			--闪避的贴图记录
	
	WAR.MBJZ = {}			--张家辉的麻痹戒指
	
	WAR.FHJZ = 0 			--张家辉的复活戒指
	
	WAR.YSJZ = 0 			--张家辉的隐身戒指
	
	WAR.TXWH = {}			--踏雪无痕的移动记录
	
	WAR.DPJQ = {}			--登萍渡水的集气
	WAR.DPLJ = 0			--登萍渡水的连击
	
	WAR.LXJY = {}			--螺旋九影记录
	WAR.LXJY_P = {}			--螺旋九影・破
	
	WAR.AXFJ = 0			--暗香月影
	WAR.XZYB = 0			--小昭影步
	
	
	CleanWarMap(7, 0)
end


--显示人物的战斗信息，包括头像，生命，内力等
function WarShowHead(id)
        if not id then
           id = WAR.CurID
        end
        if id < 0 then
           return 
        end
        local pid = WAR.Person[id]["人物编号"]
        local p = JY.Person[pid]
        local h = CC.FontSMALL
        local width = CC.FontSMALL*11 - 6
        local height = (CC.FontSMALL+CC.RowPixel)*9 - 12
        local x1, y1 = nil, nil
        local i = 1
        local size = CC.FontSmall3
        if p["主运内功"] > 0 and PersonKF(pid, p["主运内功"]) then
                height = height + CC.FontSMALL + 2
        end
		if p["主运轻功"] > 0 and PersonKF(pid, p["主运轻功"]) then
                height = height + CC.FontSMALL + 2
        end
        if WAR.Person[id]["我方"] == true then
                x1 = CC.ScreenW - width - 6
                y1 = CC.ScreenH - height - CC.ScreenH/6 -6
                DrawBox(x1, y1, x1 + width, y1 + height + CC.ScreenH/6, C_GOLD)
        else
                x1 = 10
                y1 = 10
                DrawBox(x1, y1, x1 + width, y1 + height + CC.ScreenH/6, C_GOLD)
        end

	---------------------------------------------------------状态显示---------------------------------------------------------
	
	local zt_num = 0
	--神照重生显示
	if WAR.tmp[2000 + pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 1 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1, "已神照复活", C_WHITE, size)
		else
			lib.LoadPNG(98, 1 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + size*2+CC.RowPixel*2, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + size*2+CC.RowPixel*2, "已神照复活", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	--能量值显示
	if (JY.Base["畅想"] == 673 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 673 or JY.Person[685]["天2"] == 673 or JY.Person[685]["天3"] == 673))) and pid == 0 then
	if WAR.NLZ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 160 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "能量值:"..WAR.NLZ[pid], M_DeepSkyBlue, size)
		else
			lib.LoadPNG(98, 160 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "能量值:"..WAR.NLZ[pid], M_DeepSkyBlue, size)
		end
		zt_num = zt_num + 1
	else
	    if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 160 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "能量值: 0", M_DeepSkyBlue, size)
		else
			lib.LoadPNG(98, 160 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "能量值: 0", M_DeepSkyBlue, size)
		end
		zt_num = zt_num + 1
	end
	end
	
	--杀意波动
	if WAR.SYBD[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 161 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "杀意波动:"..WAR.SYBD[pid], C_RED, size)
		else
			lib.LoadPNG(98, 161 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "杀意波动:"..WAR.SYBD[pid], C_RED, size)
		end
		zt_num = zt_num + 1
	end
	
	--魔心渡
	if WAR.MXD[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 175 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "魔心渡:"..WAR.MXD[pid], C_RED, size)
		else
			lib.LoadPNG(98, 175 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "魔心渡:"..WAR.MXD[pid], C_RED, size)
		end
		zt_num = zt_num + 1
	end
	--hcdlw
	if WAR.HCDLW[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 181 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "大力:"..WAR.HCDLW[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 181 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "大力:"..WAR.HCDLW[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	--血河
	if XueHe() then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 184 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "血河", C_WHITE, size)
		else
			lib.LoadPNG(98, 184 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "血河", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--流沙覆
	if WAR.LSF[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 171 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "流沙覆:"..WAR.LSF[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 171 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "流沙覆:"..WAR.LSF[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--罗汉，血库
	if WAR.LHHF[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 162 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "阿罗汉:"..WAR.LHHF[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 162 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "阿罗汉:"..WAR.LHHF[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.QHTR[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 191 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "气合天人", C_WHITE, size)
		else
			lib.LoadPNG(98, 191 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "气合天人", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.XTGQ[pid] == 1 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 192 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "先天罡气", C_WHITE, size)
		else
			lib.LoadPNG(98, 192 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "先天罡气", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.SPbuff[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 193 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "集气上升"..WAR.SPbuff[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 193 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "集气上升"..WAR.SPbuff[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--太极之形显示
	if PersonKF(pid, 171) then
		local tjzx = WAR.TJZX[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 2 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "太极之形:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 2 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "太极之形:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--迷踪步显示
	if pid == 0 and JY.Person[615]["论剑奖励"] == 1 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 3 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "迷踪步开启", C_WHITE, size)
		else
			lib.LoadPNG(98, 3 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "迷踪步开启", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--岳灵珊，慧中灵剑显示
	if match_ID(pid, 79) then
		local JF = 0
		for i = 1, JY.Person[671]["品德"] do
			if JY.Wugong[JY.Person[pid]["武功" .. i]]["武功类型"] == 3 then
				JF = JF + 1
			end
		end
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 4 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "慧中灵剑:"..JF, C_WHITE, size)
		else
			lib.LoadPNG(98, 4 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "慧中灵剑:"..JF, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--剑胆琴心显示
	if JiandanQX(pid) then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 5 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "剑胆琴心", C_WHITE, size)
		else
			lib.LoadPNG(98, 5 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "剑胆琴心", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无明业火显示	
	if WAR.WMYH[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 6 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "无明业火:"..WAR.WMYH[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 6 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "无明业火:"..WAR.WMYH[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--天衣无缝显示
	if TianYiWF(pid) then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 7 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "天衣无缝", C_WHITE, size)
		else
			lib.LoadPNG(98, 7 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "天衣无缝", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：举火燎原，金乌+燃木+火焰刀，造成引燃效果
	if WAR.JHLY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 8 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "引燃状态:"..WAR.JHLY[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 8 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "引燃状态:"..WAR.JHLY[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--七伤拳，肺
	if WAR.QSQ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 157 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "伤肺:"..WAR.QSQ[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 157 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "伤肺:"..WAR.QSQ[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无影神拳
	if WAR.WYSQ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 159 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "致残:"..WAR.WYSQ[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 159 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "致残:"..WAR.WYSQ[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--回转又道
	if WAR.YYXS[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 165 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "回转有道:"..WAR.YYXS[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 165 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "回转有道:"..WAR.YYXS[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.QJJB[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 172 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "龙翔九天:"..WAR.QJJB[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 172 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "龙翔九天:"..WAR.QJJB[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if JY.Person[pid]["防具"] == 355 and WAR.QNFJ[pid] ~= nil then
	local t = "无"
	if WAR.QNFJ[pid] >= 81 then
	   t = "奇"
	elseif WAR.QNFJ[pid] >= 61 then
	   t = "刀" 
	elseif WAR.QNFJ[pid] >= 41 then
	   t = "剑" 
	elseif WAR.QNFJ[pid] >= 21 then
	   t = "指" 
	elseif WAR.QNFJ[pid] >= 1 then
	   t = "拳" 
	end   
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 173 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "全能法戒:"..t, C_WHITE, size)
		else
			lib.LoadPNG(98, 173 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "全能法戒:"..t, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.JQDT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 166 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "集气倒退:"..WAR.JQDT[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 166 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "集气倒退:"..WAR.JQDT[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--噬魂
	if WAR.SHMY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 164 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "灵魂折磨", C_WHITE, size)
		else
			lib.LoadPNG(98, 164 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "灵魂折磨", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--剑意
	if WAR.WMJY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 198 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "天剑："..WAR.WMJY[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 198 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "天剑："..WAR.WMJY[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.ZWZX[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 176 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "风之诅咒:"..WAR.ZWZX[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 176 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "风之诅咒:"..WAR.ZWZX[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.NQK[pid] ~= nil and WAR.NQK[pid] > 0 then
	local nqk = {"一","二","三"}
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 178 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "逆乾坤・"..nqk[WAR.NQK[pid]].."周天", C_WHITE, size)
		else
			lib.LoadPNG(98, 178 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "逆乾坤・"..nqk[WAR.NQK[pid]].."周天", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.XLT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 180 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "心灵台："..WAR.XLT[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 180 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "心灵台："..WAR.XLT[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.SHK[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 179 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "刹活孔："..WAR.SHK[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 179 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "刹活孔："..WAR.SHK[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--碧落九重剑：重
	if WAR.LZ_Z[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 153 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "重:"..WAR.LZ_Z[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 153 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "重:"..WAR.LZ_Z[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.LZ_H[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 42 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "寒:"..WAR.LZ_H[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 42 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "寒:"..WAR.LZ_H[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.LZ_S[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 49 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "蚀:"..WAR.LZ_S[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 49 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "蚀:"..WAR.LZ_S[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.LZ_L[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 43 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "烈:"..WAR.LZ_L[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 43 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "烈:"..WAR.LZ_L[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.LZ_D[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 54 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "夺:"..WAR.LZ_D[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 54 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "夺:"..WAR.LZ_D[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：利刃寒锋，修罗+阴风+沧溟，造成冻结效果
	if WAR.LRHF[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 9 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "冻结状态:"..WAR.LRHF[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 9 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "冻结状态:"..WAR.LRHF[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.JSLQ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 185 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "急速冷却:"..WAR.JSLQ[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 185 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "急速冷却:"..WAR.JSLQ[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	if WAR.YLMB[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 186 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "幽灵漫步:"..WAR.YLMB[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 186 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "幽灵漫步:"..WAR.YLMB[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	if WAR.FCZX[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 190 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "复仇:"..JY.Person[WAR.FCZX[pid]]["姓名"], C_RED, size)
		else
			lib.LoadPNG(98, 190 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "复仇:"..JY.Person[WAR.FCZX[pid]]["姓名"], C_RED, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.CZSB[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 188 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "易伤:"..WAR.CZSB[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 188 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "易伤:"..WAR.CZSB[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	if WAR.LDXJ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 187 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "灵动迅捷:"..WAR.LDXJ[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 187 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "灵动迅捷:"..WAR.LDXJ[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	if WAR.SWKY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 189 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "剩余:"..WAR.SWKY[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 189 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "剩余:"..WAR.SWKY[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--爆裂掌
	if WAR.BLZ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 170 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "死到临头", C_WHITE, size)
		else
			lib.LoadPNG(98, 170 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "死到临头", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--sdd2
	if WAR.SDD2[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 197 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "貂毒:"..WAR.SDD2[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 197 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "貂毒:"..WAR.SDD2[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--狂犬病
	if WAR.KQB[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 167 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "狂犬病:"..WAR.KQB[pid].."级", C_WHITE, size)
		else
			lib.LoadPNG(98, 167 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "狂犬病:"..WAR.KQB[pid].."级", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	--狂犬病
	if WAR.WGJY[pid] ~= nil or (WAR.WGJY2[pid] ~= nil and WAR.WGJY3[pid] ~= nil) then
	local t = 0
	if WAR.WGJY[pid] ~= nil then
	   t = WAR.WGJY[pid]
	elseif  WAR.WGJY2[pid] ~= nil and WAR.WGJY3[pid] ~= nil then
	   t = WAR.WGJY3[pid]
	end  
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 167 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "禁用:"..JY.Wugong[t]["名称"], C_WHITE, size)
		else
			lib.LoadPNG(98, 167 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "禁用:"..JY.Wugong[t]["名称"], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	--无敌
	if WAR.WDZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 168 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "无敌:"..WAR.WDZT[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 168 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "无敌:"..WAR.WDZT[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--无酒不欢：被死战锁定的目标
	if pid == WAR.SZSD then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 10 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "死战目标", C_WHITE, size)
		else
			lib.LoadPNG(98, 10 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "死战目标", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：金轮 十龙十象状态
	if WAR.SLSX[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 11 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "十龙十象", C_WHITE, size)
		else
			lib.LoadPNG(98, 11 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "十龙十象", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：昏迷状态
	if WAR.HMZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 12 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "昏迷状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 12 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "昏迷状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--恐惧
	if WAR.KJZ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 174 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "恐惧状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 174 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "恐惧状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：阿紫曼珠沙华
	if match_ID(pid, 47) then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 13 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "曼珠沙华:" .. WAR.MZSH, C_WHITE, size)
		else
			lib.LoadPNG(98, 13 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "曼珠沙华:" .. WAR.MZSH, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--太极蓄力
	if WAR.tmp[3000 + pid]~= nil then	
		local tjzx = WAR.tmp[3000 + pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 104 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "太极蓄力值:" .. WAR.tmp[3000 + pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 104 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "太极蓄力值:" .. WAR.tmp[3000 + pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	--参和蓄力
	if WAR.tmp[7000 + pid]~= nil then	
		local tjzx = WAR.tmp[7000 + pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 124 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "斗转星移:" .. WAR.tmp[7000 + pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 124 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "斗转星移:" .. WAR.tmp[7000 + pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	--蛤蟆功蓄力
	if WAR.tmp[200 + pid]~= nil then	
		local tjzx = WAR.tmp[200 + pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 95 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "蛤蟆蓄力值:" .. WAR.tmp[200 + pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 95 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "蛤蟆蓄力值:" .. WAR.tmp[200 + pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	--无酒不欢：阿紫禁药状态
	if WAR.JYZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 14 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "禁药状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 14 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "禁药状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：沉睡状态
	if WAR.CSZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 15 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "沉睡状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 15 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "沉睡状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--平一指
	if WAR.JYSY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 196 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "人口平衡:"..WAR.JYSY[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 196 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "人口平衡:"..WAR.JYSY[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--铁拳
	if WAR.TQGJ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 199 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, WAR.TQGJ[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 199 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), WAR.TQGJ[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	if WAR.TQFY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 200 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, WAR.TQFY[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 200 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), WAR.TQFY[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	if WAR.TQLQ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 201 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, WAR.TQLQ[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 201 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), WAR.TQLQ[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	
	--灭绝
	if WAR.MJST[pid] ~= nil and JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"]*0.25 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 195 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "灭绝", C_WHITE, size)
		else
			lib.LoadPNG(98, 195 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "灭绝", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	
	--无酒不欢：灭绝的玉石俱焚
	if WAR.YSJF[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 16 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "玉石俱焚:" .. WAR.YSJF[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 16 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "玉石俱焚:" .. WAR.YSJF[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：停运状态
	if WAR.PJZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 17 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "停运状态:" .. WAR.PJZT[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 17 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "停运状态:" .. WAR.PJZT[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：混乱状态
	if WAR.HLZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 18 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "混乱状态:" .. WAR.HLZT[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 18 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "混乱状态:" .. WAR.HLZT[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.KXS[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 18 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "移魂:" .. WAR.KXS[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 18 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "移魂:" .. WAR.KXS[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--金庸评价
	if WAR.JYPJ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 163 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "已观察" .. WAR.JYPJ[pid].."次", C_WHITE, size)
		else
			lib.LoadPNG(98, 163 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "已观察" .. WAR.JYPJ[pid].."次", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--[[金庸评价
	if WAR.Adapt[pid] ~= nil
	if WAR.Adapt[pid][pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 19 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "已观察" .. WAR.Adapt[pid][pid].."次", C_WHITE, size)
		else
			lib.LoadPNG(98, 19 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "已观察" .. WAR.Adapt[pid][pid].."次", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	end]]
	
	--无酒不欢：琴音状态
	if WAR.QYZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 19 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "琴音" .. WAR.QYZT[pid].."层", C_WHITE, size)
		else
			lib.LoadPNG(98, 19 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "琴音" .. WAR.QYZT[pid].."层", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：虚弱状态
	if WAR.XRZT[pid] ~= nil or (DuZ() and WAR.Person[id]["我方"] == false and JY.Person[pid]["中毒程度"] > 0) then
	
	   if WAR.XRZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 20 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "虚弱状态:" .. WAR.XRZT[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "虚弱状态:" .. WAR.XRZT[pid], C_WHITE, size)
		end
	   else
			lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "虚弱状态", C_WHITE, size)
	   end
		zt_num = zt_num + 1
	end
	
	--七伤拳，恍惚
	if WAR.QSQ6[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 20 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "意恍惚:" .. WAR.QSQ6[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "意恍惚:" .. WAR.QSQ6[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--腐蚀状态	
	if WAR.HGMZ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 96 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "腐蚀状态:" .. WAR.HGMZ[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 96 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "腐蚀状态:" .. WAR.HGMZ[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--三分归元气	
	if WAR.SFGYQ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 84 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "三分归元气:" .. WAR.SFGYQ[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 84 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "三分归元气:" .. WAR.SFGYQ[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--七分靠打拼	
	if WAR.QFKDP[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 113 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "七分靠打拼:" .. WAR.QFKDP[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 113 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "七分靠打:" .. WAR.QFKDP[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--金刚不坏神功
	if Curr_NG(pid,144) and pid==0 then
			lib.LoadPNG(98, 150 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "金钟罩:" .. math.modf(JY.Person[596]["声望"]/300), C_WHITE, size)
			zt_num = zt_num + 1
	end

	--达摩剑法
	if PersonKF(pid, 140) and pid==0 and JY.Person[595]["声望"]>0 then
			lib.LoadPNG(98, 151 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "达摩剑:" .. math.modf(JY.Person[595]["声望"]/300), C_WHITE, size)
			zt_num = zt_num + 1
	end				
	
	--精心打磨
	if WAR.ZZZS[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 79 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "精心打磨:" .. WAR.ZZZS[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 79 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "精心打磨:" .. WAR.ZZZS[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	
	--无酒不欢：倾国状态
	if WAR.QGZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 21 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "倾国剩余" .. WAR.QGZT[pid].."次", C_WHITE, size)
		else
			lib.LoadPNG(98, 21 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "倾国剩余" .. WAR.QGZT[pid].."次", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	
	
	--无酒不欢：盲目状态
	if WAR.KHCM[pid] == 2 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 22 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "盲目状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 22 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "盲目状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：葵花尊者
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and pid == 27 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 23 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "葵花尊者形态", C_WHITE, size)
		else
			lib.LoadPNG(98, 23 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "葵花尊者形态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：其疾如风
	if WAR.FLHS1[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 24 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "其疾如风", C_WHITE, size)
		else
			lib.LoadPNG(98, 24 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "其疾如风", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：金身不灭
	if WAR.JSBM[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 25 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "金身不灭", C_WHITE, size)
		else
			lib.LoadPNG(98, 25 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "金身不灭", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--集中状态
	if WAR.Focus[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 26 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "心念合一", C_WHITE, size)
		else
			lib.LoadPNG(98, 26 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "心念合一", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--泰山十八盘，峻岭横空
	if WAR.TSSB[pid] ~= nil then
	    if match_ID(pid, 23) and JY.Person[23]["阶"] >= 2 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 27 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "峻岭横空", C_WHITE, size)
		else
			lib.LoadPNG(98, 27 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "峻岭横空", C_WHITE, size)
		end
		else
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 27 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "峻岭横空:"..WAR.TSSB[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 27 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "峻岭横空:"..WAR.TSSB[pid], C_WHITE, size)
		end
		end
		zt_num = zt_num + 1
	end
	
	--雷震，地涌天泉
	if WAR.DYTQ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 152 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "地涌天泉:"..WAR.DYTQ[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 152 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "地涌天泉:"..WAR.DYTQ[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--寒冰真气
	if WAR.HBZQJS[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 194 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, Number[WAR.HBZQDJ[pid]].."级寒气:"..WAR.HBZQJS[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 194 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), Number[WAR.HBZQDJ[pid]].."级寒气:"..WAR.HBZQJS[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--怨愤莫名
	if WAR.YFMM[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 155 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "怨忿莫名:"..WAR.YFMM[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 155 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "怨忿莫名:"..WAR.YFMM[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--隐姓埋名
	if WAR.YXMM[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 154 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "隐姓埋名:"..WAR.YXMM[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 154 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "隐姓埋名:"..WAR.YXMM[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--真名神照
	if WAR.ZMSZ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 158 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "神没罩:"..WAR.ZMSZ[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 158 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "神没罩:"..WAR.ZMSZ[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--时停
	if WAR.JESS[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 156 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "时停:"..WAR.JESS[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 156 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "时停:"..WAR.JESS[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--南山刀法，不动如山
	if WAR.NSDF[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 98 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "不动如山:"..WAR.NSDF[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 98 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "不动如山:"..WAR.NSDF[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.DFZR[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 144 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "道法自然:"..WAR.DFZR[pid], LimeGreen, size)
		else
			lib.LoadPNG(98, 144 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "道法自然:"..WAR.DFZR[pid], LimeGreen, size)
		end
		zt_num = zt_num + 1
	end
	
	--逍遥御风
	if XiaoYaoYF(pid) then
		local count = WAR.XYYF[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 28 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "逍遥御风:"..count, C_WHITE, size)
		else
			lib.LoadPNG(98, 28 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "逍遥御风:"..count, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--麻痹状态
	if WAR.MBJZ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 29 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "麻痹:移动-"..WAR.MBJZ[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 29 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "麻痹:移动-"..WAR.MBJZ[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--张家辉的隐身戒指
	if JY.Person[pid]["防具"] == 304 then
		if WAR.YSJZ == 0 then
			if WAR.Person[id]["我方"] == true then
				lib.LoadPNG(98, 30 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
				DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "隐匿中……", C_WHITE, size)
			else
				lib.LoadPNG(98, 30 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
				DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "隐匿中……", C_WHITE, size)
			end
		else
			if WAR.Person[id]["我方"] == true then
				lib.LoadPNG(98, 31 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
				DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "下次隐匿:"..WAR.YSJZ, C_WHITE, size)
			else
				lib.LoadPNG(98, 31 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
				DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "下次隐匿:"..WAR.YSJZ, C_WHITE, size)
			end
		end
		zt_num = zt_num + 1
	end
	
	--螺旋九影
	if Curr_QG(pid, 181) then
		local lx = WAR.LXJY[pid] or 1
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 32 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "螺旋九影:"..lx, C_WHITE, size)
		else
			lib.LoadPNG(98, 32 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "螺旋九影:"..lx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--单枪匹马组合
	if (JY.Person[pid]["武器"] == 54 or JY.Person[pid]["武器"] == 344) and (JY.Person[pid]["动物"] == 230 or JY.Person[pid]["动物"] == 349) and WAR.MCRS == 1 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 33 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "单枪匹马", C_WHITE, size)
		else
			lib.LoadPNG(98, 33 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "单枪匹马", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--七进七出
	if WAR.QJQC[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 183 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "剩余"..WAR.QJQC[pid].."回合", C_WHITE, size)
		else
			lib.LoadPNG(98, 183 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "剩余"..WAR.QJQC[pid].."回合", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--九阳生生不息
	if pid == 0 and Curr_NG(pid, 106) and JY.Person[pid]['生命'] <= JY.Person[pid]['生命最大值']/2 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 34 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "生生不息", C_WHITE, size)
		else
			lib.LoadPNG(98, 34 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "生生不息", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--九阴摄魂
	if pid ~= 0 then
	   local sh = 0
	   local xx,yy = WAR.Person[id]['坐标X'],WAR.Person[id]['坐标Y']
       for ii = 0,WAR.PersonNum -1 do 
	       local xi,yi = WAR.Person[ii]['坐标X'],WAR.Person[ii]['坐标Y']
	       if WAR.Person[ii]['人物编号'] == 0 and WAR.Person[ii]['死亡'] == false and WAR.Person[ii]['我方'] ~= WAR.Person[id]['我方'] then 
		      if math.abs(xx-xi) + math.abs(yy-yi) <= 14 and Curr_NG(WAR.Person[ii]['人物编号'], 193) then 
		         sh = 1
		         break
			  end	 
		   end
	   end
	   if sh == 1 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 35 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "抖音摄魂", C_WHITE, size)
		else
			lib.LoadPNG(98, 35 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "抖音摄魂", C_WHITE, size)
		end
		zt_num = zt_num + 1
	   end
	end
	
	--霍青桐: 固若金汤
	if WAR.HQT_GRJT and WAR.HQT_GRJT[pid] then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 60 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "固若金汤:"..WAR.HQT_GRJT[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 60 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "固若金汤:"..WAR.HQT_GRJT[pid], C_WHITE, size)
		end
	end
	
	--霍青桐: 军神再临
	if WAR.HQT_JSZL and WAR.HQT_JSZL[pid] then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 61 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "军神再临:"..WAR.HQT_JSZL[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 61 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "军神再临:"..WAR.HQT_JSZL[pid], C_WHITE, size)
		end
	end
	
	--空性: 抢攻
	if WAR.KX_DD and WAR.KX_DD[pid] then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 62 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "抢攻", C_WHITE, size)
		else
			lib.LoadPNG(98, 62 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "抢攻", C_WHITE, size)
		end
	end
	
	--空性: 游斗
	if WAR.KX_RS and WAR.KX_RS[pid] then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 63 * 2 , x1 - size*9- CC.RowPixel, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "游斗", C_WHITE, size)
		else
			lib.LoadPNG(98, 63 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*(zt_num+1), "游斗", C_WHITE, size)
		end
	end
	if WAR.ZTCK == 1 then
	   lib.LoadPNG(98, 195 * 2 , x1 + width + CC.RowPixel + 5, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*6-320, 1)
	end

        local headw, headh = lib.GetPNGXY(1, p["头像代号"])
        local headx = (width - headw) / 2
        local heady = (CC.ScreenH/5 - headh) / 2
        --头像信息
        local headid = WAR.tmp[5000+id];
		
        lib.LoadPNG(1, headid*2, x1 + 1 + headx, y1 - 14 + heady, 1)
        x1 = x1 + CC.RowPixel
        y1 = y1 + CC.RowPixel + CC.ScreenH/6 - 12
		
		local color1 = RGB(255, 255, 255)
		if WAR.LQZ[pid] == 100 then
		   color1 = C_RED
		end
		
        local color = nil
        if p["受伤程度"] < p["中毒程度"] then
                if p["中毒程度"] == 0 then
                        color = RGB(252, 148, 16)
                elseif p["中毒程度"] < 50 then
                        color = RGB(120, 208, 88)
                else
                        color = RGB(56, 136, 36)
                end
        elseif p["受伤程度"] < 33 then
                color = RGB(236, 200, 40)
        elseif p["受伤程度"] < 66 then
                color = RGB(244, 128, 32)
        else
                color = RGB(232, 32, 44)
        end
		local yin, yang, tg = NeiL(pid)
		local fx = yin + yang
		local Col1 = C_WHITE
		local Col2
		if fx ~= 0 then
		if yin < 0 then
			Col1 = RGB(127+fx*7, 190+fx*13, 216-fx*2)
		end	
		if yang > 0 then
			Col2 = RGB(190+fx*5, 170-fx*9, 100-fx*8)
		end
		end
		if tg == 1 then
		   Col1 = TG_Red
		   Col2 = TG_Red
		end
		if JY.Person[JY.Base["畅想"]]["阶"] > 0 and pid == 0 then
        MyDrawString(x1 -90 , x1 + width -4, y1 + CC.RowPixel + 6, p["姓名"], color, size*1.2)
		MyDrawString(x1 +100 , x1 + width -4, y1 + CC.RowPixel + 6, "("..Number[JY.Person[JY.Base["畅想"]]["阶"]].."阶)", C_WHITE, size*1.15)
		elseif JY.Person[pid]["阶"] > 0 then
		MyDrawString(x1 -90 , x1 + width -4, y1 + CC.RowPixel + 6, p["姓名"], color, size*1.2)
		MyDrawString(x1 +100 , x1 + width -4, y1 + CC.RowPixel + 6, "("..Number[JY.Person[pid]["阶"]].."阶)", C_WHITE, size*1.15)
		else
		MyDrawString(x1 -2 , x1 + width -4, y1 + CC.RowPixel + 2, p["姓名"], color, CC.DefaultFont)
		end
		if WAR.JQSDXS[pid] ~= nil then
           DrawString(x1 - size*0.3, y1 + CC.RowPixel- CC.DefaultFont*4, "集气", C_WHITE, size*1.15)
		   DrawString(x1 + size*0.2, y1 + CC.RowPixel- CC.DefaultFont*3.3, WAR.JQSDXS[pid], color1, size*1.1)
		end
		if fx ~= 0 then
		if yin < 0 then
		DrawString(x1 + size*5.1, y1 + CC.RowPixel- CC.DefaultFont*4, "阴"..-yin, Col1, size*1.1)
		end
		if yang > 0 then
		DrawString(x1 + size*7.1, y1 + CC.RowPixel- CC.DefaultFont*4, "阳"..yang, Col2, size*1.1)
		end
		else
		DrawString(x1 + size*6.1, y1 + CC.RowPixel- CC.DefaultFont*4, "调和"..yang + 1, Col1, size*1.1)
		end
		--tf
		local d1,d2 = 0, 0
		for i = 1, 10 do
        if p["地"..i] > 0 then
		   d1 = p["地"..i]
		   d2 = i
		   break
		end
		end
		if WAR.ZTCK == 1 then
		local s = 0
          for j = 1, 40 do
		    if p["人"..j] == 1 then
			DrawString(x1 + size*10, y1 + CC.RowPixel- CC.DefaultFont*2.6+s*2*size, SkillT[j][3], PinkRed, size)
			s = s+1
			end	
          end
		end
		if d1 > 0 then
           DrawString(x1 + size*10, y1 + CC.RowPixel- CC.DefaultFont*3.8, tf[d2][d1][1], PinkRed, size)
        end
		
        --有运功时的显示
        if p["主运内功"] > 0 and PersonKF(pid, p["主运内功"]) then
                DrawString(x1 + 8, y1 + CC.RowPixel + CC.DefaultFont, "运功", MilkWhite, size)
                DrawString(x1 + size*3, y1 + CC.RowPixel+ CC.DefaultFont, JY.Wugong[p["主运内功"]]["名称"], TG_Red_Bright, size)
                y1 = y1 + CC.FontSMALL + 2
        end
        --有轻功时的显示
        if p["主运轻功"] > 0 and PersonKF(pid, p["主运轻功"]) then
                DrawString(x1 + 8, y1 + CC.RowPixel + CC.DefaultFont, "轻功", MilkWhite, size)
                DrawString(x1 + size*3, y1 + CC.RowPixel+ CC.DefaultFont, JY.Wugong[p["主运轻功"]]["名称"], M_DeepSkyBlue, size)
                y1 = y1 + CC.FontSMALL + 2
        end       
  
				
        y1 = y1 + size + CC.RowPixel + 3
  
        --颜色条
        local pcx = x1 + 3 - CC.RowPixel + 2;
        local pcy = y1 + CC.RowPixel +1
  
        --生命条
        lib.LoadPNG(1, 275 * 2 , pcx  , pcy, 1)
        local pcw, pch = lib.GetPNGXY(1, 274 * 2);
   
        lib.SetClip(pcx, pcy, pcx + (p["生命"]/p["生命最大值"])*pcw, pcy + pch)
        lib.LoadPNG(1, 274 * 2 , pcx  , pcy, 1)
        pcy = pcy + CC.RowPixel + size -2
        lib.SetClip(0,0,0,0)
  
        --内力条
        lib.LoadPNG(1, 275 * 2 , pcx  , pcy, 1)
        local pcw, pch = lib.GetPNGXY(1, 273 * 2);
        lib.SetClip(pcx, pcy, pcx + (p["内力"]/p["内力最大值"])*pcw, pcy + pch)
        lib.LoadPNG(1, 273 * 2 , pcx  , pcy, 1)
        pcy = pcy + CC.RowPixel + size -2
        lib.SetClip(0,0,0,0)
  
        --体力条
        lib.LoadPNG(1, 275 * 2 , pcx  , pcy, 1)
        local pcw, pch = lib.GetPNGXY(1, 276 * 2);
        lib.SetClip(pcx, pcy, pcx + (p["体力"]/100)*pcw, pcy + pch)
        lib.LoadPNG(1, 276 * 2 , pcx  , pcy, 1)
        pcy = pcy + CC.RowPixel + size -2
        lib.SetClip(0,0,0,0)
  
        local lifexs = "命 "..p["生命"]
        local nlxs = "内 "..p["内力"]
        local tlxs = "体 "..p["体力"]
        local lqzxs = WAR.LQZ[pid] or 0;        --怒气
        local zdxs = p["中毒程度"]
  
        local nsxs = p["受伤程度"];                --内伤
        local bfxs = p["冰封程度"];                --冰封
        local zsxs = p["灼烧程度"];                --灼烧
        local fxxs = WAR.FXDS[pid] or 0;                --封穴
        local lxxs = WAR.LXZT[pid] or 0;                --流血
  
        DrawString(x1 + 9, y1 + CC.RowPixel + 6, lifexs, M_White, CC.FontSMALL)
		DrawString(x1 + 9, y1 + CC.RowPixel + size + 11, nlxs, M_White, CC.FontSMALL)
        DrawString(x1 + 9, y1 + CC.RowPixel + 2*size + 16, tlxs, M_White, CC.FontSMALL)
		
        y1 = y1 + 3*(CC.RowPixel + size) + 4
          
          local myx1 = 3;
          local myy1 = 0;
        --怒气
        DrawString(x1 + myx1, y1 + myy1, "怒气", C_RED, size)
        if lqzxs == 100 then
                lqzxs = "极"
        end
        DrawString(x1 + myx1 + size*2 + 10, y1 + myy1, lqzxs, C_RED, size)
        --如林
        myx1 = myx1 + size * 4;
        DrawString(x1 + myx1, y1 + myy1, "如林", M_DeepSkyBlue, size)
        if pid == 0 then
                DrawString(x1 + size*5/2 + myx1, y1 + myy1, WAR.FLHS2, M_DeepSkyBlue, size)
        else
                DrawString(x1 + size*5/2 + myx1, y1 + myy1, "※", M_DeepSkyBlue, size)
        end
        --冰封
        myx1 = 3;
        myy1 = myy1 + size + 2;
        DrawString(x1 + myx1, y1 + myy1, "冰封", M_LightBlue, size)
        DrawString(x1 + myx1 + size*2 + 10, y1 + myy1, bfxs, M_LightBlue, size)
        --灼烧
        myx1 = myx1 + size * 4;
        DrawString(x1 + myx1, y1 + myy1, "灼烧", C_ORANGE, size)
          DrawString(x1 + size*5/2 + myx1, y1 + myy1, zsxs, C_ORANGE, size)
        --封穴
        myx1 = 3;
        myy1 = myy1 + size + 2;
        DrawString(x1 + myx1, y1 + myy1, "封穴", C_GOLD, size)
        if fxxs == 50 then
                fxxs = "极"
        end
        DrawString(x1 + myx1 + size*2 + 10, y1 + myy1, fxxs, C_GOLD, size)
        --流血
        myx1 = myx1 + size * 4;
        DrawString(x1 + myx1, y1 + myy1, "流血", M_DarkRed, size)
        if lxxs == 100 then
                lxxs = "极"
        end
          DrawString(x1 + size*5/2 + myx1, y1 + myy1, lxxs, M_DarkRed, size)
        --内伤
        myx1 = 3;
        myy1 = myy1 + size + 2;
        DrawString(x1 + myx1, y1 + myy1, "内伤", PinkRed, size)
        if nsxs == 100 then
                nsxs = "极"
        end
        DrawString(x1 + myx1 + size*2 + 10, y1 + myy1, nsxs, PinkRed, size)
        --中毒
        myx1 = myx1 + size * 4;
        DrawString(x1 + myx1, y1 + myy1, "中毒", LimeGreen, size)
        if zdxs == 100 then
                zdxs = "极"
        end
          DrawString(x1 + size*5/2 + myx1, y1 + myy1, zdxs, LimeGreen, size)        

       --敌方攻防轻与武功
        if WAR.Person[id]["我方"] == false and CONFIG.Shujvxianshi==1 then
                y1 = y1 + 3*(CC.RowPixel + size) +12
                DrawBox(x1-7, y1, x1 + width , y1 + size*10, C_GOLD)
                local hl = 1
                DrawString(x1+2, y1 + hl * (size+CC.RowPixel) - 18, "攻" .. p["攻击力"] .. "防" .. p["防御力"] .. "轻" .. p["轻功"], C_WHITE, size)
                hl = hl + 1
				if p["代号"] == 671 or p["代号"] == 670 then
				DrawString(x1+2, y1 + hl * (size+CC.RowPixel) - 18, "拳" .. (p["拳掌功夫"]+(JY.Base["周目"]-1)*5) .. "指" .. (p["指法技巧"]+(JY.Base["周目"]-1)*5) .. "剑" .. (p["御剑能力"]+(JY.Base["周目"]-1)*5), C_WHITE, size)
				hl = hl + 1
				DrawString(x1+2, y1 + hl * (size+CC.RowPixel) - 18, "刀" .. (p["耍刀技巧"]+(JY.Base["周目"]-1)*5) .. "特" .. (p["特殊兵器"]+(JY.Base["周目"]-1)*5) .. "武" .. p["武学常识"], C_WHITE, size)
				hl = hl + 1
				else
				DrawString(x1+2, y1 + hl * (size+CC.RowPixel) - 18, "拳" .. (p["拳掌功夫"]+(JY.Base["周目"]-1)*5)*3 .. "指" .. (p["指法技巧"]+(JY.Base["周目"]-1)*5)*3 .. "剑" .. (p["御剑能力"]+(JY.Base["周目"]-1)*5)*3, C_WHITE, size)
				hl = hl + 1
				DrawString(x1+2, y1 + hl * (size+CC.RowPixel) - 18, "刀" .. (p["耍刀技巧"]+(JY.Base["周目"]-1)*5)*3 .. "特" .. (p["特殊兵器"]+(JY.Base["周目"]-1)*5)*3 .. "武" .. p["武学常识"], C_WHITE, size)
				hl = hl + 1
				end
				 
				local WGclr = C_WHITE
				DrawString(x1+2, y1 + hl * (size+CC.RowPixel) - 18, JY.Wugong[p["武功16"]]["名称"], WGclr, size)
				DrawString(x1+120, y1 + hl * (size+CC.RowPixel) - 18, get_skill_power(id, 225, math.modf(p["武功等级16"]/100) + 1), WGclr, size)
				hl = hl + 1
                for i = 1, JY.Person[671]["品德"] do
                        local wugongid = p["武功" .. i]
						local power = get_skill_power(p["代号"], wugongid, 11)
                        if wugongid > 0 then
						        if wugongid == p["专2"] then
				                   WGclr = C_RED
								elseif wugongid == p["专1"] then
				                   WGclr = PinkRed
								else
				                   WGclr = C_WHITE   
				                end
								if WAR.Person[id]["人物编号"] ~= 689 then
                                DrawString(x1+2, y1 + hl * (size+CC.RowPixel) - 18, JY.Wugong[wugongid]["名称"], WGclr, size)
								if power > 0 then
								DrawString(x1+120, y1 + hl * (size+CC.RowPixel) - 18, power, WGclr, size)
								end
								end
                                hl = hl + 1
                        end
                end
        end
        
        --敌方物品
        if WAR.Person[id]["我方"] == false and CONFIG.Shujvxianshi==1 then
                y1 = y1 + size*10 + 2
                DrawBox(x1-7, y1, x1 + width , y1 + size*6, C_GOLD)
                local hl = 1
                for i = 1, 4 do
                        local wp = p["携带物品" .. i]
                        local wps = p["携带物品数量" .. i]
                        if wp >= 0 then
                                local wpm = JY.Thing[wp]["名称"]
                                DrawString(x1+2, y1 + hl * (size+CC.RowPixel) - 18, wpm .. wps, C_WHITE, size)
                                hl = hl + 1
                        end
                end
        end
end

--自动选择合适的武功
function War_AutoSelectWugong()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local probability = {}
	local wugongnum = 16
	local pg = 0
	for i = 1, 16 do   
		local wugongid = JY.Person[pid]["武功" .. i]
		if wugongid >= 0 then
			if JY.Wugong[wugongid]["伤害类型"] == 0 then
		  
				--选择杀生命的武功，必须消耗内力比现有内力小，起码可以发出一级的武功。
				if JY.Wugong[wugongid]["消耗内力点数"] <= JY.Person[pid]["内力"] then
					local level = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1
					probability[i] = get_skill_power(pid, wugongid, level)	--无酒不欢：采用新公式
				else
					probability[i] = 0
				end
				
				--轻功不可攻击
				if JY.Wugong[wugongid]["武功类型"] == 7 or wugongid == 0 then
					probability[i] = 0
				end
					
				--内功攻击
				if JY.Wugong[wugongid]["武功类型"] == 6 then
				
					if inteam(pid) == false and i == 1 then 				--NPC会用第一格内功
			  
					elseif inteam(pid) == false and wugongid == 105 and (match_ID(pid, 36) or match_ID(pid, 27))then		--林平之 东方 使用葵花神功
					
					elseif wugongid == 102 and (match_ID_awakened(pid, 38, 1) or JY.Person[pid]["专2"] == 102) then		--石破天 使用太玄神功
					
					elseif inteam(pid) == false and wugongid == 106 and match_ID(pid, 9) then		--张无忌 使用九阳神功					
					
					elseif wugongid == 94 and (match_ID(pid, 37) or match_ID(pid, 672)) then		--狄云 使用神经照
					
					elseif wugongid == 106 and match_ID(pid, 638) then
					
					elseif wugongid == 93 and match_ID(pid, 66) then		--小昭 使用圣火
					
					elseif wugongid == 92 and match_ID(pid, 13) and JY.Person[13]["阶"] >= 1 then
					
					elseif wugongid == 207 and match_ID(pid, 22) and JY.Person[22]["阶"] >= 2 then
														
					elseif inteam(pid) == false and wugongid == 105 and pid == 189 then		--萧半和可用葵花
					
					elseif inteam(pid) == false and wugongid == 104 and match_ID(pid, 60) then		--欧阳锋 使用逆运
					
					elseif inteam(pid) == false and wugongid == 103 and (match_ID(pid, 39) or match_ID(pid, 40))then		--侠客岛主 使用龙象
					
					elseif JY.Base["标准"] == 6 and pid == 0 and wugongid ~= 87 and wugongid ~= 144 and wugongid ~= 175 then
						
					else
						probability[i] = 0
					end
				end
				
				--乔峰不用打狗
				if wugongid == 80 and pid == 50 then
					probability[i] = 0
				end
				
				if not inteam(pid) and wugongid == 210 then
				   probability[i] = 0
				end   

				--027不用龙爪手灵蛇杖
				if (wugongid == 20 or wugongid == 81) and pid == 666 then
					probability[i] = 0
				end
				
				--机器猫不用太极拳剑
				if (wugongid == 16 or wugongid == 46 or wugongid == 15 or wugongid == 36) and pid == 667 then
					probability[i] = 0
				end
				
				--小小猪不用黄沙鞭玄虚刀
				if (wugongid == 78 or wugongid == 64) and pid == 665 then
					probability[i] = 0
				end
				
				--苍天泰坦不用冰火毒龙
				if (wugongid == 35 or wugongid == 50 or wugongid == 69 ) and pid == 668 then
					probability[i] = 0
				end
				
				--冯锡范不用反两仪
				if wugongid == 60 and pid == 150 then
					probability[i] = 0
				end
				
				--黄药师不用玉萧落英
				if (wugongid == 12 or wugongid == 38) and pid == 57 then
					probability[i] = 0
				end
				
				--周伯通不用太极拳
				if wugongid == 16 and pid == 64 then
					probability[i] = 0
				end
				
				--二十大欧阳锋不用逆运蛤蟆
				if (wugongid == 95 or wugongid == 104) and pid == 60 and WAR.ZDDH == 289 then
					probability[i] = 0
				end
				
				--七夕任盈盈不用棋书画
				if (wugongid == 72 or wugongid == 84 or wugongid == 142) and pid == 611 then
					probability[i] = 0
				end
				
				--七夕郭靖不用打狗
				if wugongid == 80 and pid == 612 then
					probability[i] = 0
				end
				
				--七夕黄蓉不用降龙
				if wugongid == 26 and pid == 613 then
					probability[i] = 0
				end
				
				--襄阳金轮不用龙象瑜伽
				--神邪战三绝不用龙象瑜伽
				--二十大不用龙象瑜伽
				if wugongid == 103 and pid == 62 and (WAR.ZDDH == 289  or WAR.ZDDH == 75 or WAR.ZDDH == 278) then
					probability[i] = 0
				end
				
				if wugongid == 169 and pid == 62 and (WAR.ZDDH == 275  or WAR.ZDDH == 289 or WAR.ZDDH == 278 or WAR.ZDDH == 75 or WAR.ZDDH == 277) then
					probability[i] = 0
				end
				
				--重阳宫杨过不用黯然
				if wugongid == 25 and pid == 614 and WAR.ZDDH == 74 then
					probability[i] = 0
				end
				
				--萧半和不用辟邪
				if wugongid == 48 and pid == 189 then
					probability[i] = 0
				end
				
				--天正第五战慕容复不用太空
				if (wugongid == 15 or wugongid == 16) and pid == 51 and WAR.ZDDH == 81 then
					probability[i] = 0
				end
				
				--刀剑合璧胡一刀不用苗剑
				if wugongid == 44 and pid == 633 and WAR.ZDDH == 280 then
					probability[i] = 0
				end
				
				--余沧海
				if wugongid == 201 and pid == 24 and inteam(pid) == false and math.random(100) < 50 then
					probability[i] = 0
				end
				
				if wugongid == 201 and pid == 24 and (WAR.ZDDH == 51 or WAR.ZDDH == 53) then
					probability[i] = 0
				end
				
				--[[zjtz
				if (wugongid == 198 or wugongid == 199) and pid == 671 and WAR.ZDDH == 312 then
					probability[i] = 0
				end]]
				
				if wugongid == 114 and pid == 672 and (WAR.ZDDH == 314 or WAR.ZDDH == 266) then
					probability[i] = 0
				end
				
				--刀剑合璧苗人凤不用胡刀
				if wugongid == 67 and pid == 3 and WAR.ZDDH == 280 then
					probability[i] = 0
				end
				if pid == 674 and (wugongid == 16 or wugongid == 20 or wugongid == 81 or wugongid == 15) and WAR.ZDDH == 313 then
					probability[i] = 0
				end
				--左冷禅不用其他几个五岳剑法
				if pid == 22 and (wugongid == 30 or wugongid == 31 or wugongid == 32 or wugongid == 34) then
					probability[i] = 0
				end
				--黯然优先使用限制
				if wugongid == 25 and JY.Person[pid]["受伤程度"] < 70 and JY.Person[pid]["生命"] > (JY.Person[pid]["生命最大值"] * 0.3) and (JY.Person[58]["阶"] >= 1 and match_ID(pid, 58))==false then
					probability[i] = 0
				end
				--[[破颜拳
	            if wugongid == 223 then
	            if WAR.LQZ[pid] == nil or WAR.LQZ[pid] ~= 100 or JY.Person[pid]["生命"] > JY.Person[pid]["生命最大值"] * 0.5 then
	               probability[i] = 0
	            end
	            end]]
				--瞬狱杀使用限制
				if wugongid == 204 and ((WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 150 and WAR.SYBD[pid] ~= nil and WAR.SYBD[pid] >= 85) == false) then
					probability[i] = 0
				end
				--赤鸦空裂破
				if wugongid == 205 and ((WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 150) == false) then
					probability[i] = 0
				end
				--杨过，以袖代掌
				if match_ID(pid, 58) and WAR.ZYHB == 2 and JY.Wugong[wugongid]["武功类型"] ~= 1 then
                    probability[i] = 0
                end					
				--剑血浮生，使用限制
				if wugongid == 200 and WAR.LQZ[pid] ~= 100 then
					probability[i] = 0
				end
				--[[莫名剑法
				if wugongid == 199 then
					probability[i] = 0
				end]]
				if WAR.KungfuLQ[pid][wugongid] ~= nil then
				   probability[i] = 0
				end
				if (WAR.WGJY[pid] == wugongid or (WAR.WGJY2[pid] ~= nil and WAR.WGJY3[pid] == wugongid)) then
				   probability[i] = 0
				end
			else
				probability[i] = 0		 --自动不会杀内力
			end
		else
			wugongnum = i - 1
			break;
		end
	end
  
	if wugongnum ==  0 then			--如果没有武功，直接返回-1
		return -1;
	end
	
	for i = 1,  JY.Person[671]["品德"] do
		if 0 < probability[i] then
		 probability[16] = 0
		end
	end	
	    
	if pid == 690 then
	   if probability[2] > 0 then
	      probability[1] = 0
	   end
	end
	

	local maxoffense = 0			--计算最大攻击力
	for i = 1,  JY.Person[671]["品德"] do
		if maxoffense < probability[i] then
			maxoffense = probability[i]
		end
	end
	
	local mynum = 0					--计算我方和敌人个数
	local enemynum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			if WAR.Person[i]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				mynum = mynum + 1
			else
				enemynum = enemynum + 1
			end
		end
	end
	
	
	local factor = 0			--敌人人数影响因子，敌人多则对线面等攻击多人武功的选择概率增加
	if mynum < enemynum then
		factor = 2
	else
		factor = 1
	end
	
	for i = 1, wugongnum do		--考虑其他概率效果
		local wugongid = JY.Person[pid]["武功" .. i]
		if probability[i] > 0 then
			if probability[i] < maxoffense*3/4 then			--去掉攻击力小的武功
				probability[i] = 0
			else
				local level = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1
				probability[i] = probability[i] + JY.Wugong[wugongid]["移动范围".. level]  * factor*10
				if JY.Wugong[wugongid]["杀伤范围" .. level] > 0 then
					probability[i] = probability[i] + JY.Wugong[wugongid]["杀伤范围" .. level]* factor*10
				end
			end
		end
	end
	--kaelai
	if pid == 689 then
	   for i = 1, 10 do
	    probability[i] = 1000  
	   end
	   probability[1] = 6000
	   if WAR.SXTJ < 10 then
	   probability[9] = 15000
	   end
	   if JY.Person[0]["生命"] > JY.Person[0]["生命最大值"]*0.5 then
	      probability[6] = 7500
	   else
	      probability[7] = 9000
	   end
	   if JY.Person[0]["内力"] > JY.Person[0]["内力最大值"]*0.7 then
	      probability[4] = 8800
	   end
	   local id = 0
	   for i = 0, WAR.PersonNum - 1 do
	      if WAR.Person[i]["人物编号"] == 0 then
		     id = i
		  end
		  if WAR.Person[id].Time > 800 then
	      probability[3] = 7000
		  end
	   end
	   if WAR.LQZ[0]~=nil then
	      probability[10] = WAR.LQZ[0]*150
	   end
	   if JY.Base["难度"] == 1 or JY.Person[123]["天2"] == 2 then
	      probability[1] = 0
	   end
	   if WAR.KungfuLQ[pid][232] == nil then
	      probability[5] = 10000
	   end
	   
	   for i = 1, 10 do
	      if WAR.KungfuLQ[pid][JY.Person[pid]["武功"..i]] ~= nil then
		  probability[i] = 0
	      end
	   end
	   
	end
	
	local s = {}			--按照概率依次累加
	local maxnum = 0
	for i = 1, wugongnum do
		s[i] = maxnum
		maxnum = maxnum + probability[i]
	end
	s[wugongnum + 1] = maxnum
	if maxnum == 0 then		--没有可以选择的武功
		return -1
	end
	local selectid = 0		
	local v = Rnd(maxnum)		--产生随机数
	for i = 1, wugongnum do		--根据产生的随机数，寻找落在哪个武功区间
		if s[i] <= v and v < s[i + 1] then
			selectid = i
		end
	end
	if JY.Base["难度"] == 8 and JY.Person[pid]["天赋外功1"] > 0 and JY.Person[pid]["天赋外功1"] ~= JY.Person[pid]["武功"..selectid] then
	   if JY.Wugong[JY.Person[pid]["武功1"]]["武功类型"] < 6 and math.random(100) < 70 then
	   selectid = 1
	   end
	end
	
	if WAR.PTGJ[pid] ~= nil then
	   selectid = 16
	end
	
	return selectid
end

--战斗武功选择菜单
--sb star为无意义参数，仅为防止代码语法错误跳出
function War_FightMenu(sb, star, wgnum)
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local numwugong = 0
	local menu = {}
	local canuse = {}
	local c = 0;
	if match_ID(pid, 689) then--Kael
	local ptgj = 0
	local k = {}
if JY.Person[689]["天1"] > 0 then
k[1] = {name="冰", picked=0}
end
if JY.Person[689]["天2"] > 0 then
k[2] = {name="雷", picked=0}
end
if JY.Person[689]["天3"] > 0 then
k[3] = {name="火", picked=0}
end
local skill = {}
    local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
    while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		local x1,y1,x2,y2,x3,y3 = 240,240,320,320,400,400
		
		if skill[1] ~= nil then
		   for i = 1, #skill do
		       if skill[i] == 1 then
			      if i == 1 then
			         lib.LoadPNG(1, 901 * 2 , 380, 160, 1)
				  end
				  if i == 2 then
			         lib.LoadPNG(1, 901 * 2 , 250, 340, 1)
				  end
				  if i == 3 then
			         lib.LoadPNG(1, 901 * 2 , 510, 340, 1)
				  end
			   end
			   if skill[i] == 2 then
			      if i == 1 then
			         lib.LoadPNG(1, 902 * 2 , 380, 160, 1)
				  end
				  if i == 2 then
			         lib.LoadPNG(1, 902 * 2 , 250, 340, 1)
				  end
				  if i == 3 then
			         lib.LoadPNG(1, 902 * 2 , 510, 340, 1)
				  end
			   end
			   if skill[i] == 3 then
			      if i == 1 then
			         lib.LoadPNG(1, 903 * 2 , 380, 160, 1)
				  end
				  if i == 2 then
			         lib.LoadPNG(1, 903 * 2 , 250, 340, 1)
				  end
				  if i == 3 then
			         lib.LoadPNG(1, 903 * 2 , 510, 340, 1)
				  end
			   end
		   end

		end
		
		local q, w, e
		if k[1] ~= nil then
		   q = k[1].picked
		else   
		   q = 0
		end
		if k[2] ~= nil then
		   w = k[2].picked
		else
		   w = 0
		end
		if k[3] ~= nil then
		   e = k[3].picked
		else
		   e = 0
		end
		
		local cd = {"无","一","二","三","四","五","六"}
		if q == 3 then
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[1].."     内耗："..(JY.Wugong[226]["消耗内力点数"]*7).."    威力："..get_skill_power(pid, 226, 11).."    冷却："..cd[1+KungfuCD(pid, 226)], PinkRed, size)
		DrawString(20, 85, "冻结敌人10时序，对处于急速冷却中的敌人造成双倍伤害，在"..(30+JY.Person[689]["天1"]*5), C_GOLD, size)
		DrawString(20, 125, "时序内目标每次受到攻击会被冻结3时序，延长目标冷却一回合", C_GOLD, size)
		if WAR.KungfuLQ[pid][226] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][226]+1).."回合", C_WHITE, size)
		end
		elseif q == 2 and w == 1 then--幽灵漫步
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[2].."     内耗："..(JY.Wugong[227]["消耗内力点数"]*7).."    冷却："..cd[1+KungfuCD(pid, 227)], PinkRed, size)
		DrawString(20, 85, "隐身，集气速度提升"..((JY.Person[689]["天2"]-3)*6).."，周围的敌人集气速度降低"..(JY.Person[689]["天1"]*6).."，"..(JY.Person[689]["天1"]*2+40).."时序", C_GOLD, size)
		if WAR.KungfuLQ[pid][227] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][227]+1).."回合", C_WHITE, size)
		end
		elseif q == 1 and w == 2 then--强袭飓风
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[3].."     内耗："..(JY.Wugong[228]["消耗内力点数"]*7).."    威力："..get_skill_power(pid, 228, 11).."    冷却："..cd[1+KungfuCD(pid, 228)], PinkRed, size)
		DrawString(20, 85, "使用飓风吹飞敌人，强制杀气"..(170*math.modf(JY.Person[689]["天1"]*0.5)+650), C_GOLD, size)
		if WAR.KungfuLQ[pid][228] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][228]+1).."回合", C_WHITE, size)
		end
		elseif w == 3 then--电磁脉冲
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[4].."     内耗："..(JY.Wugong[229]["消耗内力点数"]*7).."    威力："..get_skill_power(pid, 229, 11).."    冷却："..cd[1+KungfuCD(pid, 229)], PinkRed, size)
		DrawString(20, 85, "消魔大法", C_GOLD, size)
		if WAR.KungfuLQ[pid][229] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][229]+1).."回合", C_WHITE, size)
		end
		elseif w == 2 and e == 1 then--灵动迅捷
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[5].."     内耗："..(JY.Wugong[230]["消耗内力点数"]*7).."    冷却："..cd[1+KungfuCD(pid, 230)], PinkRed, size)
		DrawString(20, 85, "集气速度提升"..(5+JY.Person[689]["天2"]*2).."%".."伤害提升"..(10+JY.Person[689]["天3"]*3).."%，"..(JY.Person[689]["天2"]*10).."时序", C_GOLD, size)
		if WAR.KungfuLQ[pid][230] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][230]+1).."回合", C_WHITE, size)
		end
		elseif e == 2 and w == 1 then--混沌陨石
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[6].."     内耗："..(JY.Wugong[231]["消耗内力点数"]*7).."    威力："..get_skill_power(pid, 231, 11).."    冷却："..cd[1+KungfuCD(pid, 231)], PinkRed, size)
		DrawString(20, 85, "对敌人施加致残状态"..(5+JY.Person[689]["天3"]*2).."时序", C_GOLD, size)
		if WAR.KungfuLQ[pid][231] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][231]+1).."回合", C_WHITE, size)
		end
		elseif e == 3 then--阳炎冲击
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[7].."     内耗："..(JY.Wugong[232]["消耗内力点数"]*7).."    威力："..get_skill_power(pid, 232, 11).."    冷却："..cd[1+KungfuCD(pid, 232)], PinkRed, size)
		DrawString(20, 85, "无视所有防御和气防，造成无法闪避和抵抗的纯粹伤害", C_GOLD, size)
		if WAR.KungfuLQ[pid][232] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][232]+1).."回合", C_WHITE, size)
		end
		elseif q == 1 and e == 2 then--熔炉精灵
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[8].."     内耗："..(JY.Wugong[233]["消耗内力点数"]*7).."    威力："..get_skill_power(pid, 233, 11).."    冷却："..cd[1+KungfuCD(pid, 233)], PinkRed, size)
		DrawString(20, 85, "召唤熔炉精灵"..(60+JY.Person[689]["天3"]*8).."时序，熔炉精灵只能存在一个", C_GOLD, size)
		if WAR.KungfuLQ[pid][233] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][233]+1).."回合", C_WHITE, size)
		end
		elseif q == 2 and e == 1 then--寒冰之墙
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[9].."     内耗："..(JY.Wugong[234]["消耗内力点数"]*7).."    威力："..get_skill_power(pid, 234, 11).."    冷却："..cd[1+KungfuCD(pid, 234)], PinkRed, size)
		DrawString(20, 85, "留下一堵寒冰之墙，时序降低敌人"..(5+JY.Person[689]["天1"]*3).."点生命，移动步数减少"..math.modf(JY.Person[689]["天1"]*0.8), C_GOLD, size)
		if WAR.KungfuLQ[pid][234] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][234]+1).."回合", C_WHITE, size)
		end
		elseif q == 1 and e == 1 and w == 1 then--超震声波
		lib.LoadPNG(1, 904 * 2 , 10, 33, 1)
		DrawString(20, 45, Kael[10].."     内耗："..(JY.Wugong[235]["消耗内力点数"]*7).."    威力："..get_skill_power(pid, 235, 11).."    冷却："..cd[1+KungfuCD(pid, 235)], PinkRed, size)
		DrawString(20, 85, "使敌方受到的伤害增加"..(10+JY.Person[689]["天1"]*3).."%，下回合不能攻击", C_GOLD, size)
		if WAR.KungfuLQ[pid][235] ~= nil then
		   DrawString(20, 125, "剩余："..(WAR.KungfuLQ[pid][235]+1).."回合", C_WHITE, size)
		end
		end
		    
		
		ShowScreen()
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress >= 49 and  keyPress <= 51 then

		local p = keyPress-48
		   if k[p] ~= nil then
		   if k[p].picked <= 3 then
		   k[p].picked = k[p].picked + 1
		   end
		   table.insert(skill, p)
		   if #skill > 3 then 
			  k[skill[1]].picked = k[skill[1]].picked - 1
			  table.remove(skill, 1)
		   end
		   end
		end
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN or keyPress==VK_T then
		if skill[1] ~= nil then
		local sk = 0
		
		   if #skill == 3 then--正常施法 
		      --[[if q == 3 then
		   DrawString(120, 200, "急速冷却", C_WHITE, size)
		elseif q == 2 and w == 1 then--幽灵漫步
		elseif q == 1 and w == 2 then--强袭飓风
		elseif w == 3 then--电磁脉冲
		DrawString(120, 200, "电磁脉冲", C_WHITE, size)
		elseif w == 2 and e == 1 then--灵动迅捷
		elseif e == 2 and w == 1 then--混沌陨石
		elseif e == 3 then--阳炎冲击
		elseif q == 1 and e == 2 then--熔炉精灵
		elseif q == 2 and e == 1 then--寒冰之墙
		elseif q == 1 and e == 1 and w == 1 then--超震声波
		end]]    JY.Person[689]["天4"] = JY.Person[pid]["武功1"]
		      if q == 3 then   
				 sk = 226
			  elseif q == 2 and w == 1 then
			     sk = 227
			  elseif q == 1 and w == 2 then
			     sk = 228
			  elseif w == 3 then
			     sk = 229
			  elseif w == 2 and e == 1 then
			     sk = 230
			  elseif e == 2 and w == 1 then
			     sk = 231
			  elseif e == 3 then
			     sk = 232
				 if JY.Person[690]["天3"] == 1 and WAR.KungfuLQ[pid][232] == nil then
				 if keyPress==VK_T then
				    sk = 238
				 end
				 end
			  elseif q == 1 and e == 2 then
			     sk = 233
			  elseif q == 2 and e == 1 then
			     sk = 234
			  elseif q == 1 and w == 1 and e == 1 then
			     sk = 235	 
			  end
			  
			if skill_usable(pid, sk) then
			   if JY.Person[pid]["内力"] < JY.Wugong[sk]["消耗内力点数"]*7 then
			      PlayWavAtk(173+math.random(9))
				  ptgj = 1
				  break
			   else
			   JY.Person[pid]["武功1"] = sk
			  break
			  end
			else
			  PlayWavAtk(164+math.random(9))
			  ptgj = 1
			  break
			end  
		   else
		      PlayWavAtk(158+math.random(5))
		   end
		end
		end
	end
	local wg1 = 1
	   if ptgj == 1 then
	      wg1 = 16
	   end  

       local r2 = War_Fight_Sub(WAR.CurID, wg1)
	   if ptgj == 0 then
       JY.Person[pid]["武功1"] = JY.Person[689]["天4"]
	   end
	   return r2
	else--其他人
	for i = 1, 16 do
		local tmp = JY.Person[pid]["武功" .. i]
			menu[i] = {JY.Wugong[tmp]["名称"], nil, 2}
			
			if WAR.KungfuLQ[pid][tmp] ~= nil then
			   menu[i][1] = menu[i][1].."||剩余："..(WAR.KungfuLQ[pid][tmp]+1).."回合 "
			end   

			if skill_usable(pid, tmp) and tmp > 0 then
				menu[i][3] = 1
			elseif tmp > 0 then
				menu[i][3] = 3
			end
		  
			--内力少不显示
			if JY.Person[pid]["内力"] < JY.Wugong[tmp]["消耗内力点数"] then
				menu[i][3] = 2
			end
		  
			--体力低于10不显示
			if JY.Person[pid]["体力"] < 10 then
				menu[i][3] = 2
			end
			  
			numwugong = numwugong + 1
		  
			if menu[i][3] == 1 then
				c = c + 1
				canuse[c] = i
			end
	end
	if c == 0 then
		return 0
	end
	if wgnum == nil then
		local r = nil
		local posx = CC.MainSubMenuX + 15
		if WAR.HQT_JDSR then
			posx = CC.MainMenuX
		end
		--local nexty = CC.ScreenH/2-CC.DefaultFont*4 + CC.SingleLineHeight
		--r = ShowMenu2(menu, numwugong, 0, posx, CC.MainSubMenuY, 0, 0, 1, 1, CC.DefaultFont, C_ORANGE, C_WHITE)
		r = ShowMenu2(menu, numwugong, 1, numwugong, posx, CC.MainSubMenuY, 0, 0, 1, 1, CC.DefaultFont, C_ORANGE, C_WHITE)
		if r == 0 then
			return 0
		end
		WAR.ShowHead = 0
		local r2 = War_Fight_Sub(WAR.CurID, r)
		WAR.ShowHead = 1
		Cls()
		return r2
	--无酒不欢：数字快捷键直接使用武功
	else
		if wgnum <= c then
			WAR.ShowHead = 0
			local r2 = War_Fight_Sub(WAR.CurID, canuse[wgnum])
			WAR.ShowHead = 1
			Cls()
			return r2
		else
			return 0
		end
	end
	end
end

--自动战斗时 做思考
--吃药的flag：2 生命；3内力；4体力；6 解毒
function War_Think()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local r = -1
	local minNeili = War_GetMinNeiLi(pid)
	local can_eat_drug = 0
	--非我方，会考虑吃药
	if WAR.Person[WAR.CurID]["我方"] == false then
		can_eat_drug = 1
	--如果是我方，只有在队且允许才会吃药
	else
		if inteam(pid) and JY.Person[pid]["是否吃药"] == 1 then
			can_eat_drug = 1
		end
	end
	--侠客正岛主战不吃药
	--洪七公居洪七公不吃药
	if WAR.Person[WAR.CurID]["我方"] == false and (WAR.ZDDH == 188 or WAR.ZDDH == 257) then
		can_eat_drug = 0
	end
	--可以吃药的话
	if can_eat_drug == 1 then 
		--吃体力药
		local eat_eng_drug = 0
		if inteam(pid) then
			local fz = {50, 30, 10}
			if JY.Person[pid]["体力"] < fz[JY.Person[pid]["体力阈值"]] then
				eat_eng_drug = 1
			end
		else
			if JY.Person[pid]["体力"] < 10 then
				eat_eng_drug = 1
			end
		end
		if eat_eng_drug == 1 then
			r = War_ThinkDrug(4)
			if r >= 0 then
			  return r
			end
			return 0
		end
		
		--吃血药
		local eat_hp_drug = 0
		if inteam(pid) then
			local fz = {0.7, 0.5, 0.3}
			if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"]*fz[JY.Person[pid]["生命阈值"]] then
				eat_hp_drug = 1
			end
		else
			--根据生命确定吃血药几率
			local rate = -1
			if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 5 then
				rate = 90
			elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 4 then
				rate = 70
			elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 3 then
				rate = 50
			elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 then
				rate = 25
			end
			
			--内伤也增加吃血药几率
			if JY.Person[pid]["受伤程度"] > 50 then
				rate = rate + 50
			end
			
			--暴气时，不吃药
			if Rnd(100) < rate and WAR.LQZ[pid] ~= nil and WAR.LQZ[pid] ~= 100 then
				eat_hp_drug = 1
			end
		end
		if eat_hp_drug == 1 then
			r = War_ThinkDrug(2)
			if r >= 0 then				--如果有药吃药
				return r
			else
				r = War_ThinkDoctor()		--如果没有药，考虑医疗
				if r >= 0 then
					return r
				end
			end
		end
		
		--吃内力药
		local eat_mp_drug = 0
		if inteam(pid) then
			local fz = {0.7, 0.5, 0.3}
			if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"]*fz[JY.Person[pid]["内力阈值"]] then
				eat_mp_drug = 1
			end
		else
			--考虑内力
			local rate = -1
			if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 6 then
				rate = 100
			elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 5 then
				rate = 75
			elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 4 then
				rate = 50
			end

			if Rnd(100) < rate or minNeili > JY.Person[pid]["内力"] then
				eat_mp_drug = 1
			end
		end
		if eat_mp_drug == 1 then
			r = War_ThinkDrug(3)
			if r >= 0 then
				return r
			end
		end
	  
		local jdrate = -1
		if CC.PersonAttribMax["中毒程度"] * 3 / 4 < JY.Person[pid]["中毒程度"] then
			jdrate = 60
		else
			if CC.PersonAttribMax["中毒程度"] / 2 < JY.Person[pid]["中毒程度"] then
				jdrate = 30
			end
		end
	  
		--半血以下吃解毒药
		--暴怒不吃解毒药
		if Rnd(100) < jdrate and JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 and WAR.LQZ[pid] ~= nil and WAR.LQZ[pid] ~= 100 then
			r = War_ThinkDrug(6)
			if r >= 0 then
				return r
			end
		end
	end
	
	if inteam(pid) then 
		if JY.Person[pid]["行为模式"] == 4 then
			r = 0
		elseif JY.Person[pid]["行为模式"] == 3 then
			r = 7
		elseif JY.Person[pid]["行为模式"] == 2 then
			r = 8
		elseif JY.Person[pid]["行为模式"] == 1 then
			if minNeili <= JY.Person[pid]["内力"] and JY.Person[pid]["体力"] > 10 then
				r = 1
			else
				r = 0
			end
		end
	else
		if minNeili <= JY.Person[pid]["内力"] and JY.Person[pid]["体力"] > 10 then
			r = 1
		else
			r = 0
		end
	end
	return r
end

--自动攻击
function War_AutoFight()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local wugongnum = 1
	local DGQB = 0
	local WJJ = 0
	local WJGZ = 0
	--独孤求败的情况, 优先使用千剑归宗

	if match_ID(pid, 592) and not inteam(pid) then
		for i = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. i] == 187 then
			    if skill_usable(pid, JY.Person[pid]["武功" .. i]) then
				DGQB = 1
				War_Fight_Sub(WAR.CurID, i)
				end
				break
			end
		end
	end
	
	if match_ID(pid, 671) and not inteam(pid) then
		for i = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. i] == 198 then
			    if skill_usable(pid, JY.Person[pid]["武功" .. i]) then
				WJGZ = 1
				War_Fight_Sub(WAR.CurID, i)
				end
				break
			end
		end
	end

	if match_ID(pid, 655) and not inteam(pid) then
		for i = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. i] == 194 then
			    if skill_usable(pid, JY.Person[pid]["武功" .. i]) then
				WJJ = 1
				War_Fight_Sub(WAR.CurID, i)
				end
				break
			end
		end
	end
	if DGQB == 0 and WJJ == 0 and WJGZ == 0 then
		if JY.Person[pid]["优先使用"] ~= 0 then
			for i = 1, JY.Person[671]["品德"] do
				if JY.Person[pid]["武功"..i] == JY.Person[pid]["优先使用"] then
					wugongnum = i
					break
				end
			end
			if match_ID(pid, 689) then
			   wugongnum = 16
			end
			if skill_usable(pid, JY.Person[pid]["武功"..wugongnum]) == false then
			   wugongnum = War_AutoSelectWugong()
			end
			if wugongnum ~= nil then
			--黯然自动攻击限制
			if inteam(pid) and JY.Person[pid]["武功"..wugongnum] == 25 and JY.Person[pid]["受伤程度"] < 70 and JY.Person[pid]["生命"] > (JY.Person[pid]["生命最大值"] * 0.3)
			and (JY.Person[58]["阶"] >= 1 and match_ID(pid, 58)) == false then
				wugongnum = War_AutoSelectWugong()
			end
			--瞬狱杀使用限制
			if inteam(pid) and JY.Person[pid]["武功"..wugongnum] == 204 and ((WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 150 and WAR.SYBD[pid] ~= nil and WAR.SYBD[pid] >= 85) == false) then
				wugongnum = War_AutoSelectWugong()
			end
			--[[破颜拳  
	        if inteam(pid) and JY.Person[pid]["武功"..wugongnum] == 223 and (WAR.LQZ[pid] == nil or WAR.LQZ[pid] ~= 100 or JY.Person[pid]["生命"] > JY.Person[pid]["生命最大值"] * 0.5) then
	            wugongnum = War_AutoSelectWugong()
	        end]]
			--赤鸦空裂破
			if inteam(pid) and JY.Person[pid]["武功"..wugongnum] == 205 and ((WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 150) == false) then
				wugongnum = War_AutoSelectWugong()
			end
			--杨过，以袖代掌
			if inteam(pid) and match_ID(pid, 58) and WAR.ZYHB == 2 and JY.Wugong[JY.Person[pid]["武功"..wugongnum]]["武功类型"] ~= 1 then
                wugongnum = War_AutoSelectWugong()
            end					
			--剑血浮生，使用限制
			if inteam(pid) and JY.Person[pid]["武功"..wugongnum] == 200 and WAR.LQZ[pid] ~= 100 then
				wugongnum = War_AutoSelectWugong()
			end
			   
			end
			--加一条防止被洗掉等意外
			if wugongnum == nil then
				wugongnum = War_AutoSelectWugong()
			end
		else
			wugongnum = War_AutoSelectWugong()
		end
		if not inteam(pid) and wugongnum == 16 and (math.random(1500) > get_skill_power(pid, 225, math.modf(JY.Person[pid]["武功等级16"]/100) + 1)) then
		   War_AutoEscape()
		   if JY.Person[pid]["生命"] < math.modf(JY.Person[pid]["生命最大值"]*0.5) then
		   War_RestMenu()
		   elseif WAR.LQZ[pid] ~= 100 then
		   War_Wait()
		   end
		   return
		else   
		if wugongnum <= 0 then
			War_AutoEscape()
			War_RestMenu()
			return
		end
		end
		unnamed(wugongnum)
	end
end

--自动战斗
function War_Auto()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	WAR.ShowHead = 1
	WarDrawMap(0)
	ShowScreen()
	lib.Delay(CC.WarAutoDelay)
	WAR.ShowHead = 0
	if CC.AutoWarShowHead == 1 then
		WAR.ShowHead = 1
	end
	local autotype = War_Think()
  
	if autotype == 0 then
		War_AutoEscape()
		War_RestMenu()
	elseif autotype == 1 then
		War_AutoFight()
	elseif autotype == 2 then
		War_AutoEscape()
		War_AutoEatDrug(2)
	elseif autotype == 3 then
		War_AutoEscape()
		War_AutoEatDrug(3)
	elseif autotype == 4 then
		War_AutoEscape()
		War_AutoEatDrug(4)
	elseif autotype == 5 then
		War_AutoEscape()
		War_AutoDoctor()
	elseif autotype == 6 then
		War_AutoEscape()
		War_AutoEatDrug(6)
	elseif autotype == 7 then
		War_RestMenu()
	elseif autotype == 8 then
		War_DefupMenu()
	end
	return 0
end

--人物升级
function War_AddPersonLVUP(pid)
	local tmplevel = JY.Person[pid]["等级"]
	if CC.Level <= tmplevel then
		return false
	end
	if JY.Person[pid]["经验"] < CC.Exp[tmplevel] then
		return false
	end
	while CC.Exp[tmplevel] <= JY.Person[pid]["经验"] do
		tmplevel = tmplevel + 1
		if CC.Level <= tmplevel then
			break;
		end
	end
  
	DrawStrBoxWaitKey(string.format("%s 升级了", JY.Person[pid]["姓名"]), C_WHITE, CC.DefaultFont)
	--计算提升的等级
	local leveladd = tmplevel - JY.Person[pid]["等级"]
	
	JY.Person[pid]["等级"] = JY.Person[pid]["等级"] + leveladd
	
	--提高生命增长
	AddPersonAttrib(pid, "生命最大值", (JY.Person[pid]["生命增长"] + 4) * leveladd * 4)
	
	JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
	JY.Person[pid]["体力"] = CC.PersonAttribMax["体力"]
	JY.Person[pid]["受伤程度"] = 0
	JY.Person[pid]["中毒程度"] = 0

	local theadd = JY.Person[pid]["资质"] / 4
	--聪明人内力加少。。。
	--增加内力的成长
	AddPersonAttrib(pid, "内力最大值", math.modf(leveladd * ((16 - JY.Person[pid]["生命增长"]) * 7 + 210 / (theadd + 1))))
	
	--天罡内力每级额外加50
	if pid == 0 and JY.Base["标准"] == 6 then
	  AddPersonAttrib(pid, "内力最大值", 50 * leveladd)
	end
	JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
	
	--循环提升等级，累加属性
	for i = 1, leveladd do
		local ups;
		local p_zz = JY.Person[pid]["资质"];
		if p_zz <= 15 then
			ups = 2   
		elseif p_zz >= 16 and p_zz <= 30 then
			ups = 3
		elseif p_zz >= 31 and p_zz <= 45 then
			ups = 4
		elseif p_zz >= 46 and p_zz <= 60 then
			ups = 5
		elseif p_zz >= 61 and p_zz <= 75 then
			ups = 6
		elseif p_zz >= 76 and p_zz <= 90 then
			ups = 7
		elseif p_zz >= 91 then
			ups = 8
		end
		
		--令狐冲 内伤回复前，每级3点
		--[[
		if pid == 35 and GetD(82, 1, 0) == 1 then
			ups = 3
		end]]
		  
		--郭靖固定每级5点
		if match_ID(pid,55) then
			ups = 5
		end
		if JY.Person[670]["无用"] == 1 and pid == 0 then
			ups = ups - 1
		end
		if JY.Base["畅想"]==147 and JY.Base["单通"] == 1 then
		    ups = ups - 5
			if ups < 0 then
			   ups = 0
			end
		end	

		--无酒不欢 风华正茂		
		if JY.Base["特殊"] ==1 and JY.Person[11]["血量翻倍"]==1 and pid==0 then
			ups=ups+1
		end
	  
		AddPersonAttrib(pid, "攻击力", ups)
		AddPersonAttrib(pid, "防御力", ups)
		AddPersonAttrib(pid, "轻功", ups)
		
		--修复医疗、用毒、解毒能力不与等级挂钩的问题
		if JY.Person[pid]["医疗能力"] >= 20 then
			AddPersonAttrib(pid, "医疗能力", 2)
		end
		if JY.Person[pid]["用毒能力"] >= 20 then
			AddPersonAttrib(pid, "用毒能力", 2)
		end
		if JY.Person[pid]["解毒能力"] >= 20 then
			AddPersonAttrib(pid, "解毒能力", 2)
		end
		
		--陈家洛 升级加五围
		if match_ID(pid,75) then
			if JY.Person[pid]["拳掌功夫"] >= 0 then
				AddPersonAttrib(pid, "拳掌功夫", 6)
			end
			if JY.Person[pid]["指法技巧"] >= 0 then
				AddPersonAttrib(pid, "指法技巧", 8)
			end
			if JY.Person[pid]["御剑能力"] >= 0 then
				AddPersonAttrib(pid, "御剑能力", 8)
			end
			if JY.Person[pid]["耍刀技巧"] >= 0 then
				AddPersonAttrib(pid, "耍刀技巧", 8)
			end
			if JY.Person[pid]["特殊兵器"] >= 0 then
				AddPersonAttrib(pid, "特殊兵器", 8)
			end
		end
		
		--袁士霄 升级加五围
		if match_ID(pid,635) then
			if JY.Person[pid]["拳掌功夫"] >= 0 then
				AddPersonAttrib(pid, "拳掌功夫", 3)
			end
			if JY.Person[pid]["指法技巧"] >= 0 then
				AddPersonAttrib(pid, "指法技巧", 4)
			end
			if JY.Person[pid]["御剑能力"] >= 0 then
				AddPersonAttrib(pid, "御剑能力", 4)
			end
			if JY.Person[pid]["耍刀技巧"] >= 0 then
				AddPersonAttrib(pid, "耍刀技巧", 4)
			end
			if JY.Person[pid]["特殊兵器"] >= 0 then
				AddPersonAttrib(pid, "特殊兵器", 4)
			end
		end
		
		--无酒不欢 厚德载物
		if JY.Base["特殊"] ==1 and JY.Person[12]["血量翻倍"]==1 and pid==0 then
				AddPersonAttrib(pid, "拳掌功夫", 1)
				AddPersonAttrib(pid, "指法技巧", 1)
				AddPersonAttrib(pid, "御剑能力", 1)
				AddPersonAttrib(pid, "耍刀技巧", 1)
				AddPersonAttrib(pid, "特殊兵器", 1)
		end			
		
		--暗器每级提高
		if JY.Person[pid]["暗器技巧"] >= 20 then
			AddPersonAttrib(pid, "暗器技巧", 2)
		end
	end

	local ey;  --每级的自由点数
	--难1，难2
	if JY.Base["畅想"]==147 and JY.Base["单通"] == 1 then
		ey = 0
	elseif JY.Base["难度"] == 1 then
		ey = 4;
	--难3，难4
	elseif JY.Base["难度"] > 1 and JY.Base["难度"] < 5 then
		ey = 3;
	--难5
	elseif JY.Base["难度"] == 5 then
		ey = 4;
	--难6
	elseif JY.Base["难度"] == 6 then
		ey = 5;
	elseif JY.Base["难度"] == 7 then
		ey = 6;
	elseif JY.Base["难度"] == 8 then
		ey = 7	
	end
	
	local n = ey*leveladd;		--计算随机额外点数
 
	--加点
	local gj = JY.Person[pid]["攻击力"];
	local fy = JY.Person[pid]["防御力"];
	local qg = JY.Person[pid]["轻功"];
	local tmpN = n;
	
	--天赋ID
	local tfid;
	--主角
	if pid == 0 then
		--标主
		if JY.Base["标准"] > 0 then
			tfid = 280 + JY.Base["标准"]
		--特殊
		elseif JY.Base["特殊"] > 0 then
			tfid = 289 + JY.Base["特殊"]
		--畅想
		else
			tfid = JY.Base["畅想"]
		end
	--队友
	else
		tfid = pid
	end
	
	--升级加点界面
	local current = 1
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls();
		ShowPersonStatus_sub(pid, 1, 1, tfid, -17, 1)
		DrawString(CC.ScreenW/2-CC.Fontsmall*6-2,20,string.format("可分配点数：%d 点",tmpN) ,C_ORANGE, CC.Fontsmall);
		for i = 1, 3 do
			local shade_color = C_GOLD
			if i ==  current then
				shade_color = PinkRed
			end
			DrawString(CC.ScreenW/2-CC.Fontsmall*7, 24+i*(CC.FontSmall4+CC.PersonStateRowPixel), "→",shade_color, CC.Fontsmall);
		end
		ShowScreen()
		local keypress, ktype, mx, my = WaitKey()
		--lib.Delay(CC.Frame)
		if ktype == 1 then
			if keypress == VK_UP then
				current = current - 1
				if current < 1 then
					current = 3
				end
			elseif keypress == VK_DOWN then
				current = current + 1
				if current > 3 then
					current = 1
				end
			elseif keypress == VK_LEFT and tmpN < n then
				if current == 1 and JY.Person[pid]["攻击力"] > gj then
					JY.Person[pid]["攻击力"] = JY.Person[pid]["攻击力"]-1
					tmpN = tmpN+1
				elseif current == 2 and JY.Person[pid]["防御力"] > fy then
					JY.Person[pid]["防御力"] = JY.Person[pid]["防御力"]-1
					tmpN = tmpN+1
				elseif current == 3 and JY.Person[pid]["轻功"] > qg then
					JY.Person[pid]["轻功"] = JY.Person[pid]["轻功"]-1
					tmpN = tmpN+1
				end
			elseif keypress == VK_RIGHT and tmpN > 0 then
				if current == 1 and JY.Person[pid]["攻击力"] < 520 then
					JY.Person[pid]["攻击力"] = JY.Person[pid]["攻击力"]+1
					tmpN = tmpN-1
				elseif current == 2 and JY.Person[pid]["防御力"] < 520 then
					JY.Person[pid]["防御力"] = JY.Person[pid]["防御力"]+1
					tmpN = tmpN-1
				elseif current == 3 and JY.Person[pid]["轻功"] < 520 then
					JY.Person[pid]["轻功"] = JY.Person[pid]["轻功"]+1
					tmpN = tmpN-1
				end
			elseif keypress==VK_SPACE or keypress==VK_RETURN then
				if tmpN == 0 or (JY.Person[pid]["攻击力"] == 520 and JY.Person[pid]["防御力"] == 520 and JY.Person[pid]["轻功"] == 520) then
					Cls();
					break
				else
					DrawStrBoxWaitKey("对不起，"..JY.Person[pid]["姓名"].."还有剩余的点数没加!", C_WHITE, CC.DefaultFont)
				end
			end
		end
	end
	return true
end

--战斗结束处理函数
--isexp 经验值
--warStatus 战斗状态
function War_EndPersonData(isexp, warStatus)
	--乔峰武功回复
	JY.Person[50]["武功1"] = 26
	JY.Wugong[13]["名称"] = "铁掌"
	
	--鸠摩智武功恢复
	if JY.Base["畅想"] == 103 then
		JY.Person[0]["武功2"] = 98
	end
  
	--破丐帮打狗阵
	if WAR.ZDDH == 82 then
		SetS(10, 0, 18, 0, 1)
	end
  
	--梅庄 秃笔翁战斗后
	if WAR.ZDDH == 44 then
		instruct_3(55, 6, 1, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
		instruct_3(55, 7, 1, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
	end
  
	--梅庄 黑白子战斗
	if WAR.ZDDH == 45 then
		instruct_3(55, 9, 1, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
	end
  
	--梅庄 黄钟公战斗
	if WAR.ZDDH == 46 then
		instruct_3(55, 13, 0, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
	end
  
  	--葵花尊者战斗胜利
	--用东方的品德记录
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and warStatus == 1 then
		JY.Person[27]["品德"] = 10
	end
  
	--战斗失败，并且无经验
	if warStatus == 2 and isexp == 0 then
		return 
	end
  
	--统计活的人数
	local liveNum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["我方"] == true and JY.Person[WAR.Person[i]["人物编号"]]["生命"] > 0 then
			liveNum = liveNum + 1
		end
	end
  
	--分配经验
	local canyu = false
	if warStatus == 1 then
		if WAR.Data["经验"] < 1000 then
			WAR.Data["经验"] = 1000
		end
		--超级木桩和木桩的经验
		if WAR.ZDDH == 226 then
			WAR.Data["经验"] = 45000
		end
		for i = 0, WAR.PersonNum - 1 do
			local pid = WAR.Person[i]["人物编号"]
			if WAR.Person[i]["我方"] == true and inteam(pid) and JY.Person[pid]["生命"] > 0 then
				if pid == 0 then
					canyu = true
				end
				--超级木桩的经验
				if WAR.ZDDH == 226 and JY.Person[591]["内力性质"] == 1 then
					WAR.Person[i]["经验"] = 120000
				else
					WAR.Person[i]["经验"] = WAR.Person[i]["经验"] + math.modf(WAR.Data["经验"] / (liveNum))
				end
			end
		end
	end
	if WAR.ZDDH == 330 then
	    for i = 0, WAR.PersonNum - 1 do
			WAR.Person[i]["经验"] = 120000
		end
	end
  
	--把等级放在修炼秘籍的后面
	for i = 0, WAR.PersonNum - 1 do
		local pid = WAR.Person[i]["人物编号"]
		if WAR.Person[i]["我方"] == true and inteam(pid) then
			--无酒不欢：小于30级，或者身上有物品才显示对话框提示
			if JY.Person[pid]["等级"] < 30 or JY.Person[pid]["修炼物品"] >= 0 then
				DrawStrBoxWaitKey(string.format("%s 获得经验点数 %d", JY.Person[pid]["姓名"], WAR.Person[i]["经验"]), C_WHITE, CC.DefaultFont)
			end
			--修炼物品
			AddPersonAttrib(pid, "物品修炼点数", math.modf(WAR.Person[i]["经验"] * 8 / 10))
			AddPersonAttrib(pid, "修炼点数", math.modf(WAR.Person[i]["经验"] * 8 / 10))
			if JY.Person[pid]["修炼点数"] < 0 then
				JY.Person[pid]["修炼点数"] = 0
			end
			War_PersonTrainBook(pid)     --修炼秘籍
			War_PersonTrainDrug(pid)		 --修炼药品
			--把等级放在修炼秘籍的后面
			AddPersonAttrib(pid, "经验", math.modf(WAR.Person[i]["经验"] / 2))
			War_AddPersonLVUP(pid)
		else
			AddPersonAttrib(pid, "经验", WAR.Person[i]["经验"])
		end
	end
  
	--青城四秀
	if WAR.ZDDH == 48 then
		SetS(57, 52, 29, 1, 0)
		SetS(57, 52, 30, 1, 0)
	--一灯居，欧阳锋，裘千刃
	elseif WAR.ZDDH == 175 then
		instruct_3(32, 12, 1, 0, 0, 0, 0, 0, 0, 0, -2, -2, -2)
	--破打狗阵
	elseif WAR.ZDDH == 82 then
		SetS(10, 0, 18, 0, 1)
	--木人巷
	elseif WAR.ZDDH == 214 then
		SetS(10, 0, 19, 0, 1)
	--侠客邪
	elseif WAR.ZDDH == 170 then
		JY.Scene[JY.SubScene]["进门音乐"] = -1
	end

	if JY.Restart == 1 then
		return
	end
end

--执行战斗，自动和手动战斗都调用
--id战斗人物编号
--wugongnum 使用的武功在位置
--x,y为战斗场景坐标
function War_Fight_Sub(id, wugongnum, x, y)	
    local  t = 0
	local pid = WAR.Person[id]["人物编号"]
	local yin, yang, tg = NeiL(pid)
	local fx = yin + yang
	local wugong = 0
	if wugongnum < 100 then
		wugong = JY.Person[pid]["武功" .. wugongnum]
	else
		wugong = wugongnum - 100
		wugongnum = 1
--[[		for i = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. i] == 43 then	--如果学习有斗转星移
				wugongnum = i							--记录斗转武功位置
				break;
			end
		end--]]
		x = WAR.Person[WAR.CurID]["坐标X"] - x
		y = WAR.Person[WAR.CurID]["坐标Y"] - y
		WarDrawMap(0)   
		local fj = "错误"		--斗转错误
		--斗转星移提示的文字
		if WAR.DZXYLV[pid] == 150 then
			fj = string.format("%s发动幻梦星辰反击", JY.Person[pid]["姓名"])
		elseif WAR.DZXYLV[pid] == 130 then
			fj = string.format("%s发动离合参商反击", JY.Person[pid]["姓名"])
		elseif WAR.DZXYLV[pid] == 100 then
			fj = string.format("%s发动斗转星移反击", JY.Person[pid]["姓名"])
		elseif WAR.DZXYLV[pid] == 70 then
			fj = string.format("%s发动北斗移辰反击", JY.Person[pid]["姓名"])
		end
		for i = 1, 20 do
			DrawStrBox(-1, 24, fj, C_ORANGE, 10 + i)
			ShowScreen()
			if i == 20 then
				lib.Delay(40)
			else
				lib.Delay(10)
			end
		end
	end

	WAR.WGWL = JY.Wugong[wugong]["攻击力10"]
	local fightscope = JY.Wugong[wugong]["攻击范围"]		--没啥用的玩意
	local kfkind = JY.Wugong[wugong]["武功类型"]
	local level = JY.Person[pid]["武功等级" .. wugongnum]   --判断武功是否为极

	if level == 999 then
		level = 11
	else
		level = math.modf(level / 100) + 1
	end
	WAR.ShowHead = 0
	local m1, m2, a1, a2, a3, a4, a5 = refw(wugong, level)  --获取武功的范围
		
	local movefanwei = {m1, m2}				--可移动的范围
	local atkfanwei = {a1, a2, a3, a4, a5}	--攻击范围
	
	--暗香反击单体
	if WAR.AXFJ == 1 then
		movefanwei = {0, 0}
		atkfanwei = {0, 0, 0, 0, 0}
		for i = 1, 20 do
			DrawStrBox(-1, 24, "暗香月影", M_Pink, 10 + i)
			ShowScreen()
			if i == 20 then
				lib.Delay(40)
			else
				lib.Delay(10)
			end
		end
	end
  
	--千剑归宗/万剑诀 不选范围
	if wugong == 187 or wugong == 194 or wugong == 198 or wugong == 253 or (wugong == 210 and WAR.AXFJ == 0) then
		x, y = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
	else
		x, y = War_FightSelectType(movefanwei, atkfanwei, x, y,wugong)

		if x == nil then
			return 0
		end
	end
	


    
	--判断合击
	local ZHEN_ID = -1
	local x0, y0 = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and i ~= WAR.CurID and WAR.Person[i]["死亡"] == false then
			local nx = WAR.Person[i]["坐标X"]
			local ny = WAR.Person[i]["坐标Y"]
			local fid = WAR.Person[i]["人物编号"]
			for j = 1, JY.Person[671]["品德"] do
				if JY.Person[fid]["武功" .. j] == wugong then         
					if math.abs(nx-x0)+math.abs(ny-y0)<9 then
						local flagx, flagy = 0, 0
						if math.abs(nx - x0) <= 1 then
							flagx = 1
						end
						if math.abs(ny - y0) <= 1 then
							flagy = 1
						end
						if x0 == nx then
							flagy = 1
						end
						if y0 == ny then
							flagx = 1
						end
						if between(x, x0, nx, flagx) and between(y, y0, ny, flagy) then
							ZHEN_ID = i
							WAR.Person[i]["人方向"] = 3 - War_Direct(x0, y0, x, y)
							break;
						end
					end
				end
			end
			if ZHEN_ID >= 0 then
				break;
			end
		end
	end
    if (wugong == 223 or (wugong == 82 and match_ID(WAR.Person[WAR.CurID]["人物编号"], 597)) or (match_ID(WAR.Person[WAR.CurID]["人物编号"], 688) and wugong == 208 and JY.Person[688]["阶"] >= 1)) and ZHEN_ID < 0 then
	   ZHEN_ID = WAR.CurID
	end
	--攻击次数
	local fightnum = 1
	
	--豪鬼，炽烈爆发
	if match_ID(pid, 673) and JY.Person[673]["外号2"] == "烈" and WAR.SYBD[pid] ~= nil and WAR.SYBD[pid] > 1 and WAR.XFXY == 0 and WAR.ZYHB == 0 and WAR.AXFJ == 0 and WAR.DZXY == 0 and WAR.JGGLZ == 0 and WAR.CLBF == 0 then
	  WAR.CLBF = 1
	  WAR.SYBD[pid] = WAR.SYBD[pid] - 20
	   if WAR.SYBD[pid] < 1 then
	      WAR.SYBD[pid] = 1
	   end
	    if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
			WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."・炽烈爆发";
		else
			WAR.Person[WAR.CurID]["特效文字4"] = "炽烈爆发";
		end
	end
	
	if match_ID(pid, 688) and JY.Person[688]["天3"] == 1 and WAR.XFXY == 0 and WAR.ZYHB == 0 and WAR.AXFJ == 0 and WAR.DZXY == 0 and WAR.JGGLZ == 0 and (WAR.CLBF == 0 or WAR.CLBF == 2) and WAR.HSSD == 0 then
	        WAR.HSSD = 1
	        if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
				WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."・枪出如龙";
			else
				WAR.Person[WAR.CurID]["特效文字4"] = "枪出如龙";
			end
	end

	--判定左右，斗转，暗香不触发
	if JY.Person[pid]["左右互搏"] == 1 and WAR.XFXY == 0 and WAR.ZYHB == 0 and WAR.AXFJ == 0 and WAR.DZXY == 0 and WAR.JGGLZ == 0 and (WAR.CLBF == 0 or WAR.CLBF == 2) and not match_ID(pid, 689) then
		--判断左右，80-资质
		local zyjl = 80 - JY.Person[pid]["资质"]
		if zyjl < 0 then
			zyjl = 0
		end
		--周伯通100%
		if match_ID(pid, 64) then
			zyjl = 100
		end

		--郭靖80%
		if match_ID(pid, 55) then
			zyjl = 80
		end
		if match_ID(pid, 55) and JY.Person[55]["阶"] >= 1 then
			zyjl = 100
		end
		--小龙女70%
		if match_ID(pid, 59) then
			zyjl = 70
			if JY.Person[59]["阶"] >= 1 then
			   zyjl = 100
			end
		end
		--周芷若觉醒后，70%
		if match_ID_awakened(pid, 631, 1) then
			zyjl = 70
		end
		--七夕郭靖100%
		--七夕龙女100%
		if match_ID(pid, 612) or match_ID(pid, 615) then
			zyjl = 100
		end
		--暴怒必左右
		if WAR.LQZ[pid] == 100 and match_ID(pid, 673) == false then
			zyjl = zyjl + 35
		end
		--周伯通支线完成后，主角+20%
		if pid == 0 and JY.Person[64]["品德"] == 80 then
			zyjl = zyjl + 20
		end
		if JY.Person[pid]["专2"] == 996 then
		   zyjl = zyjl + 25
		end
		--上限100%
		if zyjl > 100 then
			zyjl = 100
		end
		if JLSD(0, zyjl, pid) then
			WAR.ZYHB = 1
			--改到特效文字4显示
			if match_ID(pid, 58) then
			if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
			   WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."・以袖代掌";
			else
				WAR.Person[WAR.CurID]["特效文字4"] = "以袖代掌";
			end
			else
			if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
				WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."・左右互搏";
			else
				WAR.Person[WAR.CurID]["特效文字4"] = "左右互搏";
			end
			end
		end
	end
	
	--周伯通触发一次左右后，有几率根据资质追加第二次左右，畅想专属
	if match_ID(pid, 64) and pid == 0 and WAR.XFXY == 0 and WAR.ZYHB == 2 and WAR.ZHB == 0 then
		local zyjl = 80 - JY.Person[pid]["资质"]
		if zyjl < 0 then
			zyjl = 0
		end
		--斗转星移不触发左右
		if JLSD(0, zyjl, pid) and WAR.DZXY == 0 then
			WAR.ZYHB = 1
			WAR.ZHB = 1
		
			--改到特效文字4显示
			if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
				WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."・左右互搏";
			else
				WAR.Person[WAR.CurID]["特效文字4"] = "左右互搏";
			end
		end
	end
	
	--使用了辟邪，该招式进入冷却
	--林平之无冷却
	if KungfuCD(pid, wugong) > 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
	   WAR.KungfuLQ[pid][wugong] = KungfuCD(pid, wugong) + 1
	   
       if WAR.KungfuLQ[pid][wugong] > KungfuCD(pid, wugong) then
		  WAR.KungfuLQ[pid][wugong] = KungfuCD(pid, wugong)
		  --if WAR.KungfuLQ[pid][wugong] > KungfuCD(pid, wugong) and KungfuCD(pid, wugong) > 1 then
			 --WAR.KungfuLQ[pid][wugong] = KungfuCD(pid, wugong)
		  --end
		  if WAR.ZYHB == 1 or WAR.CLBF == 1 or WAR.HSSD == 1 or WAR.ZHB == 1 then
		     WAR.KungfuLQ[pid][wugong] = WAR.KungfuLQ[pid][wugong] - 1
		  end
	   end
	   
	end
	if wugong == 238 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
	   WAR.KungfuLQ[pid][232] = 5
	end
	if match_ID(pid, 689) and JY.Person[690]["品德"] == 2 and math.random(100) <= 20 then
	   for i = 226, 235 do
	       WAR.KungfuLQ[pid][i] = nil
	   end
	   WAR.Person[WAR.CurID]["特效动画"] = 71
	   Set_Eff_Text(WAR.CurID, "特效文字6", "刷新球")
	end
	
	if wugong == 48 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		if not (match_ID(pid, 36) or (match_ID(pid, 19) and JY.Person[19]["阶"] >= 3)) then
			WAR.BXLQ[pid][WAR.BXZS] = WAR.BXCD[WAR.BXZS] + 1
            if WAR.BXLQ[pid][WAR.BXZS] > WAR.BXCD[WAR.BXZS] then
			   WAR.BXLQ[pid][WAR.BXZS] = WAR.BXCD[WAR.BXZS]
			   --[[if WAR.BXLQ[pid][WAR.BXZS] > WAR.BXCD[WAR.BXZS] and WAR.BXCD[WAR.BXZS] > 1 then
			      WAR.BXLQ[pid][WAR.BXZS] = WAR.BXCD[WAR.BXZS]
			   end]]
			   if WAR.ZYHB == 1 or WAR.CLBF == 1 or WAR.HSSD == 1 or WAR.ZHB == 1 then
		          WAR.BXLQ[pid][WAR.BXZS] = WAR.BXLQ[pid][WAR.BXZS] - 1
		       end
			end
		end
	end
	
	if wugong == 217 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		if (match_ID(pid, 681) and JY.Base["天书数量"] >= 10) == false then
			WAR.AHLQ[pid][WAR.AHZS] = WAR.AHCD[WAR.AHZS] + 1
			if WAR.ZYHB == 1 or WAR.CLBF == 1 or WAR.HSSD == 1 or WAR.ZHB == 1 then
		       WAR.AHLQ[pid][WAR.AHZS] = WAR.AHLQ[pid][WAR.AHZS] - 1
		    end   
		end
	end
	
	if wugong == 29 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		if not match_ID(pid, 74) and JY.Person[pid]["专1"] ~= 29 then
			WAR.SFLQ[pid][WAR.SFZS] = WAR.SFCD[WAR.SFZS] + 1
			if WAR.ZYHB == 1 or WAR.CLBF == 1 or WAR.HSSD == 1 or WAR.ZHB == 1 then
		       WAR.SFLQ[pid][WAR.SFZS] = WAR.SFLQ[pid][WAR.SFZS] - 1
		    end
		end
	end
	
	if wugong == 221 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
			WAR.YSZLQ[pid][WAR.YSZZS] = WAR.YSZCD[WAR.YSZZS] + 1
			if WAR.ZYHB == 1 or WAR.CLBF == 1 or WAR.HSSD == 1 or WAR.ZHB == 1 then
		       WAR.YSZLQ[pid][WAR.YSZZS] = WAR.YSZLQ[pid][WAR.YSZZS] - 1
		    end
	end
	if wugong == 222 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
			WAR.YSJLQ[pid][WAR.YSJZS] = WAR.YSJCD[WAR.YSJZS] + 1
			if WAR.ZYHB == 1 or WAR.CLBF == 1 or WAR.HSSD == 1 or WAR.ZHB == 1 then
		       WAR.YSJLQ[pid][WAR.YSJZS] = WAR.YSJLQ[pid][WAR.YSJZS] - 1
		    end
	end
	
	--莫名剑法招式冷却
	if wugong == 199 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
	   if JY.Person[pid]["专1"] ~= 199 then
	   WAR.MMLQ[pid][WAR.MMZS] = WAR.MMCD[WAR.MMZS] + 1
	        if WAR.ZYHB == 1 or WAR.CLBF == 1 or WAR.HSSD == 1 or WAR.ZHB == 1 then
		       WAR.MMLQ[pid][WAR.MMZS] = WAR.MMLQ[pid][WAR.MMZS] - 1
		    end
	   end
	end
	
	--六脉
	if wugong == 49 and level == 11 and match_ID(pid, 687) and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
	   WAR.LMLQ[pid][WAR.LMZS] = WAR.LMCD[WAR.LMZS] + 1
	        if WAR.ZYHB == 1 or WAR.CLBF == 1 or WAR.HSSD == 1 or WAR.ZHB == 1 then
		       WAR.LMLQ[pid][WAR.LMZS] = WAR.LMLQ[pid][WAR.LMZS] - 1
		    end
	end	
	
	--无酒不欢：连击率用函数计算
	local LJ;
	
	LJ = Person_LJ(pid)
	
	--敌人连击+20%
	if WAR.Person[id]["我方"] == false then
		LJ = LJ + 20
	end
	
	if JY.Base["标准"] == 7 and WAR.Person[id]["我方"] == false and JY.Person[0]["阶"] >= 3 then
	   LJ = math.modf(LJ/2)
	end

	--V6连击+20
	if WAR.Person[id]["我方"] == true and JY.Person[642]["血量翻倍"] == 1 then
		LJ = LJ + 20
	end
	
	--连击率上限100meaningless

	if math.random(100) <= LJ then
		fightnum = 2
	end
	if match_ID(pid, 683) and LJ > 100 and math.random(100) <= LJ-100 then
		fightnum = 3
	end

	--高连击武功
	local glj = {7, 2, 34, 37, 55, 57, 70, 77, 156, 49}
	for i = 1, 10 do
		if JY.Person[pid]["武功" .. wugongnum] == glj[i] and JLSD(20, 75, pid) then
			fightnum = 2
			break
		end
	end
	
	if match_ID(pid, 676) then
	   fightnum = 2
	   if JLSD(40, 60, pid) or WAR.LQZ[pid] == 100 then
	   fightnum = 3
	   end
	end

    if JY.Person[pid]["地6"] == 3 then
       fightnum = 3
 	end
	
	--雷震，刀法
	if match_ID(pid, 670) and JY.Wugong[wugong]["武功类型"] == 4 and WAR.ACT >= 2 and math.random(420) <= (JY.Person[pid]["耍刀技巧"]-80) then
	   fightnum = fightnum + 1
	end
	
	if match_ID(pid, 678) and JY.Wugong[wugong]["武功类型"] == 2 and JY.Person[678]["天2"] == 1 and WAR.ACT >= 2 and math.random(100) <= 33 then
	   fightnum = 3
	end
	--小虾米
	if match_ID(pid, 677) and JY.Person[677]["天1"] == 1 and math.random(100) <= 20 then
	   fightnum = fightnum + 1
	end	
	
	--五岳剑法组合额外连击
	if wugong >= 30 and wugong <= 34 and WuyueJF(pid) and JLSD(30, 60, pid) then
		fightnum = 2
	end
	
	--紫气天罗组合额外连击
	if (wugong == 3 or wugong == 9 or wugong == 5 or wugong == 21 or wugong == 118 or pid==46 or (JY.Person[642]["血量翻倍"] == 1 and match_ID(pid, 46))) and ZiqiTL(pid) and JLSD(30, 60, pid) then
		fightnum = 2
	end
	
	--天衣无缝组合，刀法连击率+30%
	if kfkind == 4 and TianYiWF(pid) and JLSD(30, 60, pid) then
		fightnum = 2
	end
	
	if match_ID(pid, 691) and kfkind == 4 then
	local jl = JY.Person[pid]["实战"]*0.15
	   if math.random(100) <= jl then
		fightnum = 2
	   end	
	end
	
	--萧中慧夫妻必连
	if match_ID(pid, 77) and wugong == 62 then
		fightnum = 2
	end
	--73 or kfid == 72 or kfid == 84 or kfid == 142
	if match_ID(pid, 115) and JY.Person[115]["阶"] >= 1 and (wugong == 72 or wugong == 73 or wugong == 84 or wugong == 142) then
		fightnum = 2
	end
	
	--丁典，剑法
	if (kfkind == 3 or wugong == 94) and match_ID(pid, 672) and JLSD(30, 60, pid) then
		fightnum = 2
	end
	
	
	--装备鸳鸯刀，夫妻必连
	if (JY.Person[pid]["武器"] == 217 or JY.Person[pid]["武器"] == 218) and wugong == 62 then
		fightnum = 2
	end
	
	--狄云，水笙连城高连
	if (match_ID(pid, 37) or match_ID(pid, 589) or match_ID(pid, 672)) and wugong == 114 and JLSD(20, 75, pid) then
		fightnum = 2
	end
	
	--枯荣一阳指高连
	if match_ID(pid, 102) and wugong == 17 and JLSD(20, 75, pid) then
		fightnum = 2
	end
	
	--东方不败
	if match_ID(pid, 27) and JY.Person[27]["阶"] >= 1 and JLSD(20, 65+JY.Person[27]["阶"]*10, pid) then
		fightnum = 3
	end
	
	--萧远山杀破狼，必定三连击
	if match_ID(pid, 112) and WAR.ZHRM[pid] == nil and WAR.XYS > 0 then
		fightnum = 3
	end	
	
	--神刀斩必定单击	
	if wugong==189 and not match_ID(pid, 691) then
		fightnum = 1
	end	
	
	--温青青 大暴必连击
	if WAR.WQQ == 1 then
		fightnum = 2
	end

	--朱子柳一阳指必连击	
	if match_ID(pid, 122) and wugong == 17 then
		fightnum = 2
	end
	    
	--倚天密道，成昆必定单击
	--天外也不会连击
	if WAR.ZDDH == 237 and pid == 18 then
		fightnum = 1
		WAR.TWLJ = 2
	end
	
	--一剑成名
	if wugong == 199 and WAR.MMZS == 1 then
	   fightnum = 1
	   WAR.TWLJ = 2
	end

	--化功北冥吸星必定单击
	if wugong == 87 or wugong == 85 or wugong == 88 then
		fightnum = 1
	end

	--万剑诀必定单击
	--天外也不会连击
	if wugong == 195 then
		fightnum = 1
		WAR.TWLJ = 2
	end	

	--千剑归宗必定单击
	--天外也不会连击
	if wugong == 187 then
		fightnum = 1
		WAR.TWLJ = 2
	end
	
	--万剑归宗
	--天外也不会连击
	if wugong == 198 then
		fightnum = 1
		WAR.TWLJ = 2
	end
	
	--瞬狱杀
	--天外也不会连击，如雷也不会，玉女也不会
	if wugong == 204 or wugong == 205 or wugong == 223 or wugong == 227 or wugong == 230 or wugong == 233 then
		fightnum = 1
		WAR.TWLJ = 2
	end
  
	--无酒不欢：黯然极意和三叠浪
	--杨过才能触发
	if (match_ID(pid, 58) or (pid == 0 and JY.Base["标准"] == 1) or Curr_NG(pid, 177)) and wugong == 25 and level == 11 then
		local jl = 0;
		--内伤大于30时，每点内伤增加1%几率
		if JY.Person[pid]["受伤程度"] > 30 then
			jl = jl + (JY.Person[pid]["受伤程度"]-30);	
		end    
		--生命少于70%时，每少一百生命，机率增加10%
		if JY.Person[pid]["生命"] < (JY.Person[pid]["生命最大值"]*0.7) then
			jl = jl + math.ceil(((JY.Person[pid]["生命最大值"]*0.7) - JY.Person[pid]["生命"])/10)		
		end
		--几率大于0才触发
		if jl > 0 then
			--暴怒必触发
			if WAR.LQZ[pid] == 100 or jl > Rnd(100) then
				WAR.ARJY = 1
				--资质大于等于50才能触发三叠浪，限杨过
				if (match_ID(pid, 58) or Curr_NG(pid, 177)) and JY.Person[pid]["资质"] >= 50 then
					fightnum = 3;
					for i = 1, 30 do
						DrawStrBox(-1, 24, "黯然销魂.物我两忘.黯然三叠浪", M_DeepSkyBlue, 10 + i)
						ShowScreen()
						lib.Delay(10)
					end
				else
					fightnum = 2
				end
			end
		end
	end
	
	if wugong == 223 and match_ID(pid, 686) then
	    for i = 1, 30 do
		DrawStrBox(-1, 24, "北斗有情破颜拳", RGB(math.random(255),math.random(255),math.random(255)), 10 + i)
		ShowScreen()
		lib.Delay(20)
		end
	end
	
	if (wugong == 2 and JY.Person[pid]["专1"] == 2) or (match_ID(pid, 69) and (wugong == 26 or wugong == 80)) then
	   WAR.XYYD = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+逍遥游"
	   else
			WAR.Person[id]["特效文字1"] = "逍遥游"
	   end
	end
	
	if wugong == 222 and (WAR.YSJZS == 2 or WAR.YSJZS == 4) then
	   WAR.XYYD = 1
	end
	--北斗神拳
	if match_ID(pid, 686) and JY.Wugong[wugong]["武功类型"] == 1 then
	local jl = 10
	jl = jl - math.modf(JY.Person[pid]["实战"]*0.012)
	   local s = math.random(jl)
	   if s == 1 then
	
	   WAR.BDSQ = 1
	   WAR.Person[WAR.CurID]["特效文字1"] = "斗劲呼法"
	    elseif s == 2 then
	 
	   WAR.BDSQ = 2
	   WAR.Person[WAR.CurID]["特效文字1"] = "天翔百裂拳"
	    elseif s == 3 then

	   WAR.BDSQ = 3
	   WAR.Person[WAR.CurID]["特效文字1"] = "三尖破孔击"
	    elseif s == 4 then
	    
	   WAR.BDSQ = 4
	   WAR.Person[WAR.CurID]["特效文字1"] = "北斗有情鸿翔波"
	    end
	end
	
	if WAR.ACT == 1 then
	   WAR.WKBP = 1
	end
	--辟邪，唯快不破
	if wugong == 48 or (match_ID(pid, 29) and wugong == 55 and PersonKF(pid, 105))then
	local jl = math.modf(WAR.JQSDXS[pid]^0.85) + 7
	   if match_ID(pid, 36) or match_ID(pid, 29) then
	   jl = jl + 10
	   end
	   if math.random(100) < jl then
	   WAR.WJBC = 1
	   
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+无坚不摧"
		else
			WAR.Person[id]["特效文字1"] = "无坚不摧"
		end
	   end
	   if math.random(100) < jl then
	   WAR.WKBP = 1
	   
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+唯快不破"
		else
			WAR.Person[id]["特效文字1"] = "唯快不破"
		end
	   end
	end
	
	--李白
	if match_ID(pid, 636) and JLSD(20, 70+math.modf(JY.Person[pid]["御剑能力"]*0.1), pid) then
	   WAR.LIBAI = math.random(#LIBAI)
	   WAR.Person[id]["特效文字5"] = LIBAI[WAR.LIBAI]
	   if WAR.LIBAI == 1 or WAR.LIBAI == #LIBAI then
	   for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 500
			end
	   end
	   end
	   if WAR.LIBAI >= 9 and WAR.LIBAI <= 12 then
	      WAR.LBHQ = WAR.LIBAI - 8
	   end
	   if WAR.LIBAI == 5 then
	      WAR.LBHQ = 2
	   end
	   if WAR.LIBAI == 15 then
	      WAR.YBYS = 1
	   end
	   if WAR.LIBAI == 17 then
	      WAR.LBHQ = 3
	   end
	   if WAR.LIBAI == 19 then
	      for j = 0, WAR.PersonNum - 1 do
	        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.FXDS[WAR.Person[j]["人物编号"]] = 25
			end
		  end	
	   end
	   if WAR.LIBAI == 21 then
	      WAR.LQZ[pid] = 100
	   end
	   if WAR.LIBAI == 5 or WAR.LIBAI == 8 or WAR.LIBAI == 17 then
	      WAR.LBDIS = WAR.LBDIS+1
	   end
	   if WAR.LIBAI == 20 then
	      WAR.LBDIS = WAR.LBDIS+3
	   end
	   if WAR.LIBAI == 8 then
	      WAR.LBJY = 1
	   end
       if WAR.LIBAI == 16 then
	      for j = 0, WAR.PersonNum - 1 do
	        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.L_NOT_MOVE[WAR.Person[j]["人物编号"]] = 1
			end
		  end
	   end	   
	   if WAR.LIBAI == 6 or WAR.LIBAI == 13 or WAR.LIBAI == 14 then
	      WAR.LQZ[pid] = 0
	   end
	end
	
	--四季剑法
	if match_ID(pid, 675) and JY.Wugong[wugong]["武功类型"] == 3 and JY.Person[675]["声望"] > 50 then
	local jl = 65
	if WAR.LQZ[pid] == 100 then
	   jl = jl + 50
	end
	if wugong == 211 then
	   jl = jl + 30
	end   
	if math.random(100) < jl then
	local n = math.random(5)
	if JY.Person[675]["声望"] >= 600 and n == 1 and math.random(800) < JY.Person[pid]["御剑能力"] then
       WAR.DHCG = 1
	   WAR.CWMM = 1
	   WAR.QFJY = 1
	   WAR.XYDD = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・四季不休"
	   else
			WAR.Person[id]["特效文字1"] = "四季不休"
	   end
	   for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd  - 200
			end
	   end
	   
	elseif JY.Person[675]["声望"] >= 360 and n == 2 then
       WAR.DHCG = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・冬寒刺骨"
	   else
			WAR.Person[id]["特效文字1"] = "冬寒刺骨"
	   end
	   
	   if JY.Person[pid]["御剑能力"] >= 210 and math.random(400) < JY.Person[pid]["御剑能力"] then
	      WAR.CWMM = 1
		  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・春雾迷蒙"
	   end
	   
	   if JY.Person[pid]["御剑能力"] >= 420 and math.random(990) < JY.Person[pid]["御剑能力"] then
	      WAR.XYDD = 1
		  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・夏雨点点"
		  for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd  - 200
			end
	      end
	   end
	   
	elseif JY.Person[675]["声望"] >= 220 and n == 3 then
       WAR.QFJY = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・秋风卷叶"
	   else
			WAR.Person[id]["特效文字1"] = "秋风卷叶"
	   end 
	   
	   if JY.Person[pid]["御剑能力"] >= 210 and math.random(400) < JY.Person[pid]["御剑能力"] then
	      WAR.DHCG = 1
		  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・冬寒刺骨"
	   end
	   if JY.Person[pid]["御剑能力"] >= 420 and math.random(990) < JY.Person[pid]["御剑能力"] then
	      WAR.CWMM = 1
		  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・春雾迷蒙"
	   end
	   
	   
	elseif JY.Person[675]["声望"] >= 110 and n == 4 then
       WAR.XYDD = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・夏雨点点"
	   else
			WAR.Person[id]["特效文字1"] = "夏雨点点"
	   end
	   if JY.Person[pid]["御剑能力"] >= 210 and math.random(400) < JY.Person[pid]["御剑能力"] then
	      WAR.QFJY = 1
		  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・秋风卷叶"
	   end
	   if JY.Person[pid]["御剑能力"] >= 420 and math.random(990) < JY.Person[pid]["御剑能力"] then
	      WAR.DHCG = 1
		  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・冬寒刺骨"
	   end
	   for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd  - 200
			end
	   end
	elseif JY.Person[675]["声望"] >= 50 and n == 5 then
       WAR.CWMM = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・春雾迷蒙"
	   else
			WAR.Person[id]["特效文字1"] = "春雾迷蒙"
	   end
	   if JY.Person[pid]["御剑能力"] >= 210 and math.random(400) < JY.Person[pid]["御剑能力"] then
	      WAR.XYDD = 1
		  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・夏雨点点"
		  for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd  - 200
			end
	      end
	   end
	   if JY.Person[pid]["御剑能力"] >= 420 and math.random(990) < JY.Person[pid]["御剑能力"] then
	      WAR.QFJY = 1
		  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・秋风卷叶"
	   end
	end
	end
	end
	--达摩剑法
	if wugong == 140 and JY.Person[pid]["专2"] == 140 then
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+达摩剑法"
	   else
			WAR.Person[id]["特效文字1"] = "达摩剑法"
	   end
	end   
	
	--衡山五神剑
	if match_ID(pid, 20) and JY.Wugong[wugong]["武功类型"] == 3 and JY.Person[20]["品德"] > 40 then
	local jl = 145 - (JY.Person[20]["品德"] - 40)*20
	if WAR.LQZ[pid] == 100 then
	   jl = jl + 50
	end
	if wugong == 32 then
	   jl = jl + 60
	end   
	if math.random(100) < jl then
	local n = math.random(5)
	if JY.Person[20]["品德"] >= 45 and (n == 1 or math.random(100) < (JY.Person[20]["品德"]-40)*10) then
	   WAR.YHZR = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・雁回祝融"
	   else
			WAR.Person[id]["特效文字1"] = "雁回祝融"
	   end
	end   
	   
	if JY.Person[20]["品德"] >= 44 and (n == 2 or math.random(100) < (JY.Person[20]["品德"]-40)*10) then
	   WAR.TZYQ = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・天柱云气"
	   else
			WAR.Person[id]["特效文字1"] = "天柱云气"
	   end
	end   
	   
	if JY.Person[20]["品德"] >= 43 and (n == 3 or math.random(100) < (JY.Person[20]["品德"]-40)*10) then
	   WAR.SLSS = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・石廪书声"
	   else
			WAR.Person[id]["特效文字1"] = "石廪书声"
	   end 
	   for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.LQZ[WAR.Person[j]["人物编号"]] ~= nil then
				WAR.LQZ[WAR.Person[j]["人物编号"]] = WAR.LQZ[WAR.Person[j]["人物编号"]] - 20
				if WAR.LQZ[WAR.Person[j]["人物编号"]] < 0 then
				   WAR.LQZ[WAR.Person[j]["人物编号"]] = 0
				end   
			end
		end
	end   
	   
	if JY.Person[20]["品德"] >= 42 and (n == 4 or math.random(100) < (JY.Person[20]["品德"]-40)*10) then
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・鹤翔紫盖"
	   else
			WAR.Person[id]["特效文字1"] = "鹤翔紫盖"
	   end
	   for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd  - 500
			end
	   end
	end   
	if JY.Person[20]["品德"] >= 41 and (n == 5 or math.random(100) < (JY.Person[20]["品德"]-40)*10) then
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・泉鸣芙蓉"
	   else
			WAR.Person[id]["特效文字1"] = "泉鸣芙蓉"
	   end
	   local hl = math.modf((JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"])*0.2)
	   local cr = math.modf((JY.Person[pid]["内力最大值"] - JY.Person[pid]["内力"])*0.2)
	   
	   WAR.Person[id]["生命点数"] = AddPersonAttrib(pid, "生命", hl)
	   WAR.Person[id]["内力点数"] = AddPersonAttrib(pid, "内力", cr)
    
	end
	end
	end
	
	if WAR.SLSS == 1 then
		
		WAR.SLSS = 0
	end
	   
	
	--三破神机
	if match_ID(pid, 670) and JY.Wugong[wugong]["武功类型"] == 5 and JY.Person[pid]["特殊兵器"] >= 200 and (math.random(100) < 25 or WAR.LQZ[pid] == 100) and WAR.DZXY ~= 1 then
	   fightnum = 3
	   WAR.SPSJ = 1
	   WAR.BFX =1
		for i = 1, 30 do
			DrawStrBox(-1, 24, "三破神机", C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
    end
	
	--玄铁剑调息
	if inteam(pid) and wugong == 45 then
		WAR.LRHF[pid] = 5
	end
	
	--苗人凤三连击
	if WAR.ZDDH == 4 and pid==3 and wugong == 44 and level == 11 then
		fightnum = 3
		WAR.ZHDJY = 1
		WAR.LRHF[pid] = 25
	end
	
	if match_ID(pid, 3) and wugong == 44 then
	local jl = JY.Person[pid]["实战"]*0.07+30
	   if JY.Person[3]["阶"] >= 1 then
	   jl = jl + 50*JY.Person[3]["阶"] 
	   end
	   if math.random(100) < jl then
	   fightnum = 3
	   WAR.ZHDJY = 1
	   end
	end
	
	--神雕
	if JY.Person[pid]["动物"] == 348 then
	local jl = 10
	jl = jl + JY.Thing[348]["装备等级"]*3
	if WAR.LQZ[pid] == 100 then
	   jl = jl+15
	end 
 	    if math.random(100) <= jl then
		WAR.SDXT = 1
		WAR.SDXTH = wugong
		fightnum = fightnum + 1
		end
	end
	
	--天火
	if JY.Person[249]["品德"] == 1020 and pid == 0 then
	local jl = 15
	if WAR.LQZ[pid] == 100 then
	   jl = jl*2
	end 
 	    if math.random(100) <= jl then
		WAR.SYZY = 1
		WAR.SYZYH = wugong
		fightnum = fightnum + 1
		end
	end

	--洪七公二连击
	if match_ID(pid, 69) and wugong == 26 and JLSD(20, 75, pid) then
		WAR.HQGXL = 1
		fightnum = fightnum+1
		for i = 1, 30 do
			DrawStrBox(-1, 24, "盖世无双・降龙十八掌", C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(20)
		end
	end
	
	if match_ID(pid, 69) and wugong == 80  and JLSD(20, 75, pid) then
		WAR.HQGDG = 1
		fightnum = fightnum+1
		for i = 1, 30 do
		DrawStrBox(-1, 24, "盖世无双・打狗棒法", C_GOLD, 10 + i)
		ShowScreen()
		lib.Delay(20)
		end
	end	

	--主运擒龙功有30%几率触发降龙三叠浪，暴怒必触发
	if Curr_NG(pid, 188) and wugong == 26 and level == 11 then
		if JLSD(30, 45, pid) or WAR.LQZ[pid] == 100 or JY.Person[pid]["专2"] == 26 then
			fightnum = 3
			for i = 1, 30 do
				DrawStrBox(-1, 24, "降龙真传.登峰造极.降龙三叠浪", M_Red, 10 + i)
				ShowScreen()
				lib.Delay(10)
			end
		end
	end

	--无酒不欢醉梦罗汉拳
	if pid==596 and JY.Person[596]["姓名"] == "无酒不欢" then
		JY.Wugong[151]["名称"] = "醉梦罗汉拳"
	end
	
	--乔峰
	if match_ID(pid, 50) then
		if WAR.ZDDH == 83 and WAR.FS == 0 then   --打四帮主时的乔峰
			say("１（唉，这些年轻人闯荡江湖也不容易，也罢，此战就以Ｒ太祖长拳Ｗ来陪你们玩玩吧！）", 50)
			WAR.FS = 1
		end
		JY.Wugong[13]["名称"] = "太祖长拳"

		--如果乔峰用的是降龙，那么有40%的机率三连击，怒气暴发时必三连
		--音箱提高三叠浪几率，每级+5%
		local ex_chance = 0
		if JY.Person[pid]["武器"] == 300 then
			ex_chance = JY.Thing[300]["装备等级"] * 5
		end
		if wugong == 26 and (JLSD(25, 65+ex_chance, pid) or WAR.LQZ[pid] == 100) then
			WAR.FS = 1
			fightnum = 3
			local color = M_Red
			local display = "六军辟易.奋英雄怒.降龙三叠浪"
			--装备音箱，暴怒有50%几率出四叠浪
			if JY.Person[pid]["武器"] == 300 and WAR.LQZ[pid] == 100 and JLSD(25, 75, pid) then
				fightnum = 4
				display = "虎啸龙吟.帝释天威.降龙四叠浪"
				color = C_GOLD
				WAR.NJDJ=1
			end
			for i = 1, 30 do
				DrawStrBox(-1, 24, display, color, 10 + i)
				ShowScreen()
				lib.Delay(10)
			end
		end
		--NPC乔峰回内
		if inteam(pid) == false then
			if JY.Person[pid]["内力"] < 1000 then
				JY.Person[pid]["内力"] = 1200 + math.random(100)
			end
		end
	end
	
	--杀意，波动拳
	if WAR.SYBD[pid] ~= nil and wugong == 202 then
	   fightnum = 2
	   if math.random(100) < 50 and JY.Person[673]["外号2"] == "烈" then
	      fightnum = 3
	   end
	end
	
	--灭杀豪升龙
	if wugong == 203 and WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 50 then
	   WAR.MSHSL = 1
		local display = "灭杀豪升龙"
		local color = M_Purple
		if JY.Person[673]["外号2"] == "烈" then
		   display = "天魔豪斩空"
		   color = C_ORANGE
		end
		for i = 1, 40 do
			DrawStrBox(-1, 24, display, color, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end
	
	--灭杀豪被动
	if wugong == 202 and WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 50 then
	   WAR.MSHBD = 1
		local display = "灭杀豪波动"
		local color = M_Purple
		if JY.Person[673]["外号2"] == "烈" then
		   display = "狱炎豪波动"
		   color = C_ORANGE
		end
		for i = 1, 40 do
			DrawStrBox(-1, 24, display, color, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end

	--玉女全真双剑合璧
	if (wugong==39 or wugong==42) and (PersonKF(pid,39) and PersonKF(pid,42)) then
		WAR.Person[WAR.CurID]["特效文字5"] = "双剑合璧"	
		fightnum = fightnum+1
	JY.Wugong[39]["名称"] = "玉女素心剑"
	JY.Wugong[42]["名称"] = "玉女素心剑"
	end

	--素心剑双剑合璧
	if wugong==139 then
		WAR.Person[WAR.CurID]["特效文字5"] = "双剑合璧"	
		fightnum = fightnum+1
	end
	if match_ID(pid, 46) and wugong == 170 and JY.Person[46]["阶"] >= 2 then
	   fightnum = 2
	end
	if match_ID(pid, 66) and wugong == 93 and JY.Person[66]["阶"] >= 3 then
	   fightnum = 2
	end
	
	--须弥山神掌
	if wugong == 24 and (JY.Person[pid]["专2"] == 24 or (match_ID(pid, 147) and JY.Person[147]["阶"] >= 1)) then
	   fightnum = 2
	end
	
	if (wugong == 232 or wugong == 238) and JY.Person[690]["天3"] == 1 then
	   fightnum = 2
	end
	if WAR.BDSQ == 2 then
	   fightnum = 2
	   WAR.BDSQ = 0
	end
	--连城剑法
	if wugong == 114 and JY.Person[pid]["专2"] == 114 then
	   fightnum = 2
	end
	if wugong == 197 and JY.Person[pid]["专2"] == 197 then
	   fightnum = 2
	end
	if JY.Wugong[wugong]["武功类型"] == 2 and JY.Person[pid]["专2"] == 132 and PersonKF(pid, 132) then
	   fightnum = 2
	end
	if wugong == 139 and JY.Person[pid]["专2"] == 139 then
	   fightnum = 2
	end
	if JY.Person[pid]["专2"] == 154 and PersonKF(pid, 154) then
	   fightnum = 2
	end
	if PersonKF(pid, 174) and JY.Person[pid]["专2"] == 174 and JY.Wugong[wugong]["武功类型"] == 4 then
	   fightnum = 2
	end
	--玉箫剑法
	if wugong == 38 and  (JY.Person[pid]["专1"] == 38 or (match_ID(pid, 63) and JY.Person[63]["阶"] >= 3)) then
	   fightnum = 2
	end
	--全真剑法
	if wugong == 39 and JY.Person[pid]["专1"] == 39 then
	   fightnum = 2
	end
	--玉女剑法
	if wugong == 42 and JY.Person[pid]["专1"] == 42 then
	   fightnum = 2
	end
	if wugong == 161 and JY.Person[pid]["专1"] == 161 then
	   fightnum = 2
	end
		--蓝烟清：装备真武剑时使用太极剑法必连击
	if JY.Person[pid]["武器"] == 236 and wugong == 46 then
		fightnum = 2;
	end
	
	
	if wugong == 162 and JY.Person[pid]["专2"] == 162 then
	   fightnum = 3
	end
	--柴刀
	if wugong == 50 and JY.Person[pid]["专1"] == 50 then
	   fightnum = 3
	end
	
	if wugong == 185 and JY.Person[pid]["专2"] == 185 then
	   fightnum = 3
	end
	
	if WAR.BDSQ == 3 then
	   fightnum = 3
	   WAR.BDSQ = 0
	end
	if match_ID(pid, 20) and wugong == 32 and JY.Person[20]["阶"] >= 3 then
	   fightnum = 3
	end
	--疾风骤雨
	if match_ID(pid, 688) and JY.Person[688]["天2"] == 2 then
	   fightnum = 2
	   if Person_LJ(pid) > math.random(180) then
	      fightnum = 3
	   end
	end
	if wugong == 231 and JY.Person[pid]["专1"] == 231 then
	   fightnum = 3
	end
	if match_ID(pid, 39) and JY.Person[39]["阶"] >= 3 then
	   fightnum = 3
	end
	--桃花绝技，有40%几率三连击，暴怒必触发
	if (wugong == 12 or wugong == 18 or wugong == 38) and TaohuaJJ(pid) and (WAR.LQZ[pid] == 100 or JLSD(35, 75, pid)) then
		fightnum = 3
		for i = 1, 30 do
			DrawStrBox(-1, 24, "桃花绝技・奇门五转", PinkRed, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end
	
	--令狐冲二次觉醒后，40%几率动如雷震，暴怒必触发
	if (match_ID_awakened(pid, 35, 2) or (WAR.ZDDH==75 and pid==58) or (PersonKF(pid,47) and PersonKF(pid,45))) and (WAR.LQZ[pid] == 100 or JLSD(35, 75, pid)) and (wugong == 47 or wugong == 45) and WAR.DZXY ~= 1 then
		fightnum = 3
		for i = 1, 30 do
			DrawStrBox(-1, 24, "剑魔再临・动如雷震", M_Red, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end
	
		
	--太虚剑意，三环套月
	if Curr_NG(pid, 152) then
		WAR.Person[WAR.CurID]["特效文字1"] = "三环套月"
		fightnum = 3
		for i = 1, 30 do
			DrawStrBox(-1, 24, "太虚剑意.三环套月", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end
	
	--七夕杨过，必三叠浪
	if match_ID(pid, 614) and wugong == 25 then
		fightnum = 3
		WAR.ARJY = 1
		for i = 1, 30 do
			DrawStrBox(-1, 24, "黯然销魂.物我两忘.黯然三叠浪", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end
	if WAR.LIBAI == 8 then
	   WAR.LBJY = 1
	end
  
	
	--尼摩星必定单击
	if match_ID(pid, 159) then
		fightnum = 1
	end

	--无酒不欢 天下无双	
	if JY.Base["特殊"] ==1 and JY.Person[26]["血量翻倍"]==1 and pid==0 then
		fightnum = 1
	end
	
	if WAR.ZDDH == 275 and pid == 62 then	--襄阳终战金轮法王必定单击
		fightnum = 1
	end
	
	--进阶太岳，连击时为三连击
	if wugong == 34 and PersonKF(pid,175) and fightnum == 2 then
		fightnum = 3
	end
	
	--夺命三仙剑
	if wugong == 185 and WAR.LQZ[pid] == 100 then
		fightnum = 3
	end	
	
	--五虎
	if wugong == 59 and WAR.LQZ[pid] == 100 and (JY.Person[pid]["专1"] == 59 or (match_ID(pid, 106) and JY.Person[106]["阶"] >= 2)) then
		fightnum = 5
		for i = 1, 30 do
			DrawStrBox(-1, 24, "五虎断魂刀", PinkRed, 10 + i)
			ShowScreen()
			lib.Delay(20)
		end
	end
	
	--宋青书连击后再次判定	
	if match_ID_awakened(pid, 82, 1) and wugong == 7 then
		while (math.random(100) <= LJ or JLSD(20, 75, pid)) and fightnum<99 do
		fightnum = fightnum+1
		end
		if  fightnum>2 then
			for i = 1, 30 do
			DrawStrBox(-1, 24, "情意绵绵X"..fightnum, C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(20)
			end
		end
	end

	WAR.ACT = 1
	WAR.FLHS6 = 0	--如雷数量
	
	--斗转
	if WAR.DZXY == 1 then
		--慕容博两次，其他人一次
		if match_ID(pid, 113) then
			fightnum = 2
		else
			fightnum = 1
		end
	end
	
	
  while WAR.ACT <= fightnum do
	if JY.Restart == 1 then
		break
	end
	lib.GetKey()
    if WAR.WS == 1 then		--误伤
		WAR.WS = 0
    end
    if WAR.DJGZ == 1 then	--刀剑归真
		WAR.DJGZ = 0
    end
	if WAR.ZHDJY == 1 then	--苗剑极意
		WAR.ZHDJY = 0
    end
	if WAR.HQGXL == 1 then	--洪七公打狗
		WAR.HQGXL = 0
    end
	if WAR.HQGDG == 1 then	--洪七公降龙
		WAR.HQGDG = 0
    end   
	
    if WAR.HQT == 1 then	--霍青桐 杀体力
		WAR.HQT = 0
    end
    if WAR.CY == 1 then		--程英 杀内力
		WAR.CY = 0
    end
    if WAR.HDWZ == 1 then	--霍都随机上毒
		WAR.HDWZ = 0
    end
	
    WAR.NGJL = 0		--当前加力内功编号
    WAR.KHBX = 0		--葵花刺目
    WAR.LXZQ = 0		--拳主大招
	WAR.LXYZ = 0		--指主大招
    WAR.GCTJ = 0		--特主大招
    WAR.ASKD = 0		--刀主大招
	WAR.ALH = 0
	
	WAR.YSXL = 0		--参和指全屏攻击
    WAR.JSYX = 0		--剑主大招
    WAR.BMXH = 0		--北冥神功
    WAR.TD = -1			--钟灵朱聪偷盗
	WAR.TDnum = 0		--钟灵朱聪偷盗
    WAR.TZ_XZ = 0		--虚竹指令
	WAR.BMSGXL = 0		--吸星大法吸怒
    WAR.JGZ_DMZ = 0		--达摩掌
    WAR.LHQ_BNZ = 0		--般若掌
	WAR.LHQ_YKDD = 0 	--一空到底
	WAR.YZC_MKZ = 0 	--摩柯指
	WAR.FMZ_BFSC = 0 	--八法神禅
	WAR.WD_CLSZ = 0		--赤练神掌
	WAR.TXZQ = {}		--太玄之轻清除记录
	WAR.JQHY2 = {}
    CleanWarMap(4, 0)
	
    
    WAR.L_TLD = 0		--装备屠龙刀特效，流血
	WAR.PJTX = 0 		--玄铁剑配玄铁剑法，破尽天下
	WAR.CXLC = 0		--狄云赤心连城
	WAR.FQY = 0			--风清扬无招胜有招
	
	WAR.YTML = 0 		--毒王大招
	WAR.JSTG = 0		--天罡大招
	WAR.TXZZ = 0		--太玄之重
	WAR.MMGJ = 0		--盲目攻击
	WAR.MMGJ2 = 0
	WAR.HBMZ = 0
	WAR.DGGF = 0
	WAR.LMSJ = 0	
	WAR.JSAY = 0		--金蛇奥义
	WAR.WDKTJ = 0		--开太极
	WAR.OYFXL = 0 		--欧阳锋根据蛤蟆蓄力增加伤害
	WAR.XDLeech = 0		--血刀吸血量
	WAR.JSHJab = 0
	WAR.WYXLeech = 0	--韦一笑吸血量
	WAR.WYXLeech2 = 0
	WAR.TMGLeech = 0	--天魔功吸血量
	WAR.RENLeech = 0
	WAR.PYZLeech = 0
	WAR.YYZLeech = 0
	WAR.LLXLeech = 0
	WAR.XHSJ = 0		--血河神鉴吸血量
	WAR.KMZWD = 0 		--周伯通空明之武道
	WAR.SJDR = 0 
	WAR.XTQKG = 0		--先天乾坤功
	WAR.LFHX = 0 		--林朝英流风回雪
	WAR.YNXJ = 0		--夭矫空碧
	WAR.HXZYJ = 0		--会心之一击
	WAR.YYBJ = 0 		--郭靖：有余不尽
	WAR.NGXS = 0		--内功攻击的系数
	WAR.TYJQ = 0		--阿青天元剑气
	WAR.NFCD = 0
	WAR.RJSD = 0
	WAR.ZXSG = 0		--紫霞神功
	WAR.OYK = 0 		--欧阳克灵蛇拳
	WAR.HDF = 0 		--海大富化骨绵掌
	WAR.YKDD = 0 		--一空到底
	WAR.ADA = 0 		--阿大八臂神剑
	WAR.DDSQ = 0
	WAR.NFMD = 0
	WAR.JQBYH = 0		--六脉：剑气碧烟横
	WAR.LPZ = 0			--林平之回气
	WAR.QXQ = 0
	WAR.WXLW = 0
	
	WAR.QQSH1 = 0		--琴棋书画之持瑶琴
	WAR.QQSH2 = 0		--琴棋书画之妙笔丹青
	WAR.QQSH3 = 0		--琴棋书画之倚天屠龙功
	
	WAR.CMDF = 0		--沧溟刀法
	
	WAR.HTS = 0			--何铁手五毒随机2-5倍威力
	WAR.QKYZ = 0		--林月如乾坤一掷
	WAR.YZQS = 0		--一震七伤
	WAR.LIBAI = 0
	WAR.SLJF = 0
	WAR.SLJFB = 0
	WAR.XYJ = 0
	
	
	WAR.ZLPK = 0
	WAR.PLKD = 0
	WAR.WLJ = 0
	WAR.TNSF = 0        --天怒十方
	

	
	WAR.JJZC = 0		--九剑真传的4种主动攻击特效，攻击后会清0
	
	WAR.ZWYJF = 0		--有剑诀的五岳剑法，无视绝对气防
	WAR.QFBGM = 0		--乔峰暴怒降龙，无视绝对气防
	
	WAR.JuHuo = 0			--举火燎原
	WAR.LiRen = 0			--利刃寒锋
	
	WAR.YZHH = 0
	WAR.HBZQ = 0
	WAR.WLDF = 0
	WAR.YHDF = 0
	WAR.AHGJ = 0
	WAR.CBDF = 0
	WAR.SHJD = 0
	WAR.DJJ = 0
	WAR.SDLT = 0
	WAR.QXQ = 0
	
	WAR.LWX = 0				--李文秀的破气防特效
	WAR.LXZL10 = 0			--龙象之力暴怒，忽视绝对气防
	WAR.QHTRG = 0
	WAR.LXYZG = 0
	
	WAR.PDJN = 0			--陈家洛庖丁解牛
	
	WAR.DPDS = 0			--登萍渡水
	WAR.DPDS2 = 0
	WAR.AXYY = {}			--暗香月影
	
	WAR.JYSH = 0			--九阴摄魂
    
    WAR.L_QKDNY = {}	--重新计算乾坤大挪移是否被反弹过
	WAR.L_XWXGFT = {}
	WAR.TXXS = {} 		--特效点数显示
    
	WAR.FLHS3 = 0		--侵略如火
	
	
    WarDrawAtt(x, y, atkfanwei, 3)
    if ZHEN_ID >= 0 then
		local tmp_id = WAR.CurID
		WAR.CurID = ZHEN_ID
		WarDrawAtt(WAR.Person[ZHEN_ID]["坐标X"] + x0 - x, WAR.Person[ZHEN_ID]["坐标Y"] + y0 - y, atkfanwei, 3)
		WAR.CurID = tmp_id
    end
	
    --判断攻击次数大于1，显示连击
    if WAR.ACT > 1 then   
		local A = "连击"
		if WAR.TWLJ == 1 then
			A = "天赋外功.炉火纯青"
		end
		if WAR.TJZX_LJ == 1 then
			A = "太极之形.圆转不断"
			WAR.TJZX_LJ = 0
		end
		if match_ID(pid, 6) and WAR.MJST[pid] == 1 and JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"]*0.25 then
		   A = "灭之绝之"
		end
		--夫妻刀法
		if wugong == 62 then
			--萧中慧
			if match_ID(pid, 77) then
				A = "碧箫声里双鸣凤"
			--主角男性
			elseif pid == 0 and JY.Person[0]["性别"] == 0 then
				A = "英雄无双风流婿"
			--主角女性
			elseif pid == 0 and JY.Person[0]["性别"] ~= 0 then
				A = "刀光掩映孔雀屏"
			end
		end
		--东方不败
		if match_ID(pid, 27) then
			A = "风云再起"
		end
		--豪鬼
		if match_ID(pid, 673) and WAR.SYBD[pid] ~= nil and JY.Person[673]["外号2"] == "烈" then
			A = "炽烈爆发"
		end
		--改到特效文字4显示
		if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
			WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."・".. A
		else
			WAR.Person[WAR.CurID]["特效文字4"] = A;
		end
	    
	    if wugong == 49 and WAR.LMZS == 4 and match_ID(pid, 687) then
		local wg = JY.Person[pid]["武功16"]
		local wgwl = JY.Person[pid]["武功等级16"]
		JY.Person[pid]["武功16"] = 49
		JY.Person[pid]["武功等级16"] = 999
	    if JY.Person[0]["天3"] == 4 then
		WAR.Person[WAR.CurID]["移动步数"] = 7
		War_CalMoveStep(WAR.CurID, 7, 0)
		else
	    WAR.Person[WAR.CurID]["移动步数"] = 5
		War_CalMoveStep(WAR.CurID, 5, 0)
		end
		local x, y = nil, nil
		x, y = War_SelectMove()
		if x ~= nil then
		WAR.ShowHead = 0
		War_MovePerson(x, y)
		War_Fight_Sub(WAR.CurID, 16)
		end
		
        JY.Person[pid]["武功16"] = wg
		JY.Person[pid]["武功等级16"] = wgwl
	    end
		
    end
	--少泽剑	
	--玉女心经：进趋如风，第一击有几率发动，追加一次连击
	if PersonKF(pid, 154) and wugong ~= 198 and wugong ~= 205 and wugong ~= 204 and wugong ~= 224 and wugong ~= 227 and wugong ~= 230 and wugong ~= 233 then
	  
		local ynjl = 0;
		if pid == 0 then
			ynjl = 5
		end
		if tg ~= 1 then
		   if fx < 0 then
	       ynjl = ynjl - fx
	       end
		else
		   ynjl = ynjl - yin
		end
	    if Curr_NG(pid, 154) then 
		--七夕龙女必发动
		if (match_ID(pid, 59) or match_ID(pid, 615) or WAR.LQZ[pid] == 100 or (JLSD(20, 95 + JY.Base["天书数量"]*2 + ynjl, pid) or PersonKF(pid, 105))) and WAR.ACT == 1 then
			fightnum = fightnum + 1
			Set_Eff_Text(id,"特效文字1","进趋如风");
		end
		
		if (WAR.LQZ[pid] == 100 or (JLSD(20, 45 + JY.Base["天书数量"] + ynjl, pid))) and WAR.ACT == 3 then
			fightnum = fightnum + 1
			Set_Eff_Text(id,"特效文字1","进趋如风");
		end
	   else
	    if (WAR.LQZ[pid] == 100 or (JLSD(20, 45 + JY.Base["天书数量"] + ynjl, pid))) and WAR.ACT == 1 then
			fightnum = fightnum + 1
			Set_Eff_Text(id,"特效文字1","进趋如风");
		end
	   end
	    
	end
	
	if JY.Person[0]["天3"] == 4 and pid == 0 and WAR.ACT == 1 then
	   Set_Eff_Text(id,"特效文字1","锦上添花")
	   fightnum = fightnum + 1
	end
	
	--枯荣
	if Curr_NG(pid, 186) and WAR.ACT == 1 and (( match_ID(pid, 102) and JY.Base["天书数量"] > 6) or (match_ID(pid, 687) and JY.Person[687]["天3"] == 1)) then
	local hl = math.modf((level + 3) / 2) * JY.Wugong[wugong]["消耗内力点数"]
	if WAR.DZXY == 1 then
	   hl = math.min(hl, 60)
	end
	   WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", hl)
		Set_Eff_Text(WAR.CurID, "特效文字1", "非枯非荣")
	end
	--一灯一阶
	if match_ID(pid, 65) and JY.Person[65]["阶"] >= 1 and wugong == 17 then
	local hl = math.modf((JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"])*0.1)
	   WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", hl)
	end
	--枯禅
	if PersonKF(pid, 186) and WAR.ACT == 1 and JY.Person[pid]["专1"] == 186 then
	local hl = math.modf((level + 3) / 10) * JY.Wugong[wugong]["消耗内力点数"]
	   if WAR.DZXY == 1 then
	      hl = math.min(hl, 60)
	   end
	   WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", hl)
		Set_Eff_Text(WAR.CurID, "特效文字1", "非枯非荣")
	end
	
	if match_ID(pid, 676) and JY.Person[676]["天4"] == 2 then
	local hl = math.modf((level + 3) / 10) * JY.Wugong[wugong]["消耗内力点数"] * WAR.ACT
	   WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", hl)
		Set_Eff_Text(WAR.CurID, "特效文字1", "脱凡入化")
	end
	
	if JY.Person[pid]["地3"] == 2 then
	local hl = math.modf((JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"])*0.07)
	   WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", hl)
	end
	
	if JY.Person[pid]["地5"] == 4 then
	local hl = -math.modf(JY.Person[pid]["生命"]*0.1)
	   WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", hl)
	end
	
	--天外，有33%几率多连击一次
	if Given_WG(pid, wugong) and JLSD(33, 66, pid) and WAR.TWLJ == 0 and (fightnum < 2 or (JY.Person[0]["天3"] == 4 and pid == 0)) then
		fightnum = fightnum + 1
		WAR.TWLJ = 1
	end
	
	--无酒不欢：暴击率用函数计算
	local BJ;
	
	BJ = Person_BJ(pid)
	
	--敌人暴击+20%
	if WAR.Person[id]["我方"] == false then
		BJ = BJ + 20
	end

	--V6暴击+20
	if WAR.Person[id]["我方"] == true and JY.Person[642]["血量翻倍"] == 1 then
		BJ = BJ + 20
	end
    
	--暴击率上限100
    if BJ > 100 then
		BJ = 100
    end
 
	if math.random(100) <= BJ then
		WAR.BJ = 1		
    end

	--[[朱九真暴击后再次判定
	if match_ID_awakened(pid, 81, 1) and wugong == 17 then	
	WAR.ZJZBJ=1.5
	local ZJZ=0
		if (Curr_NG(pid, 177) or PersonKF(pid, 172)) and WAR.HXZYJ == 1 then
		ZJZ = ZJZ + 0.5
		end
		if Curr_NG(pid, 104) then
		    ZJZ = ZJZ + 0.2
			if JY.Person[pid]["天赋内功"] == 104 then
				 ZJZ = ZJZ + 0.2
			end	  
	    end
		if PersonKF(pid, 104) and PersonKF(pid, 95) then
			ZJZ = ZJZ + 0.1
		end
		while (math.random(100) < DJ or JLSD(25, 75, pid)) and WAR.ZJZBJ<99 do
		WAR.ZJZBJ=WAR.ZJZBJ+ZJZ+0.5
		end
		if  WAR.ZJZBJ>2.2 then
			for i = 1, 30 do
			DrawStrBox(-1, 24, "娇媚婉转X" ..WAR.ZJZBJ, C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(20)
			end
		end
	end]]
    
    --装备玄铁剑，配合玄铁剑法
	--1级50%暴击率，6级100%
	--6级解锁破尽天下，必暴击，无视绝对气防
    if (JY.Person[pid]["武器"] == 36 or match_ID(pid, 614)) and wugong == 45 then
		if JLSD(0, 40 + JY.Thing[36]["装备等级"] * 10, pid) then
			WAR.BJ = 1
		end
		if JY.Thing[36]["装备等级"] == 6 or match_ID(pid, 614) then
			WAR.PJTX = 1
			Set_Eff_Text(id,"特效文字0","重剑无锋・破尽天下");
		end
    end
	
	if match_ID(pid, 691) and JY.Wugong[wugong]["武功类型"] == 4 then
	local jl = JY.Person[pid]["实战"]*0.15
	   if math.random(100) <= jl then
		WAR.BJ = 1
	   end	
	end
	
	--弹指神通，配合桃花绝技，必暴击
	if wugong == 18 and TaohuaJJ(pid) then
		WAR.BJ = 1
	end
	
	--雷震，参合指
	if wugong == 138 and match_ID(pid, 670) then
		WAR.BJ = 1
	end
	if match_ID(pid, 115) and JY.Person[115]["阶"] >= 2 and (wugong == 72 or wugong == 73 or wugong == 84 or wugong == 142) then
		WAR.BJ = 1
	end
	
	--杀意波动
	if match_ID(pid, 673) and WAR.SYBD[pid] ~= nil then
		WAR.BJ = 1
	end
	
	--耕一阳指必暴击
	if match_ID(pid, 121) and wugong == 17 then
		WAR.BJ = 1
	end
	
	if match_ID(pid, 20) and wugong == 32 and JY.Person[20]["阶"] >= 3 then
		WAR.BJ = 1
	end
	
	if match_ID(pid, 66) and wugong == 93 and JY.Person[66]["阶"] >= 3 then
		WAR.BJ = 1
	end
	
	if match_ID(pid, 37) and wugong == 114 and JY.Person[37]["阶"] >= 2 then
		WAR.BJ = 1
	end
	
	if match_ID(pid, 46) and wugong == 170 and JY.Person[46]["阶"] >= 2 then
		WAR.BJ = 1
	end
	
	--太岳三青峰
	if wugong == 34 and JY.Person[pid]["专1"] == 34 then
	   WAR.BJ = 1
	end
	
	if wugong == 17 and match_ID(pid, 687) then
	   if BJ ~= 1 then
	      if math.random(1600) < JY.Person[687]["声望"] then
		  end
	   end
	   if JY.Person[687]["声望"] == 1000 and JY.Person[687]["天2"] == 1 then
	      BJ = 1
	   end
	end
	
	--天竺佛指
	if wugong == 122 and JY.Person[pid]["专1"] == 122 then
	   WAR.BJ = 1
	end
	
	--金乌
	if wugong == 61 and JY.Person[pid]["专1"] == 61 then
	   WAR.BJ = 1
	end
	
	if JY.Wugong[wugong]["武功类型"] == 4 and JY.Person[pid]["专2"] == 65 and PersonKF(pid, 65) then
	   WAR.BJ = 1
	end
	
	if JY.Wugong[wugong]["武功类型"] == 1 and JY.Person[pid]["专2"] == 120 and PersonKF(pid, 120) then
	   WAR.BJ = 1
	end
	
	if wugong == 86 and JY.Person[pid]["专2"] == 86 then
	   WAR.BJ = 1
	end
	
	if wugong == 136 and JY.Person[pid]["专2"] == 136 then
	   WAR.BJ = 1
	end
	
	
	--全真剑法
	if wugong == 39 and JY.Person[pid]["专1"] == 39 then
	   WAR.BJ = 1
	end
	--金蛇剑法
	if wugong == 40 and JY.Person[pid]["专1"] == 40 then
	   WAR.BJ = 1
	end
	
	--天魔功，必暴击
	if Curr_NG(pid, 160) then
		WAR.BJ = 1
	end
    
    --装备屠龙刀，使用等级为极的刀法，有几率触发两种特效
	if JY.Person[pid]["武器"] == 43 then
	  	if kfkind == 4 and level == 11 then
    		--必流血，并追加等同于武功威力的杀气，50%几率优先判定
    		if JLSD(25, 75, pid) then
    			WAR.L_TLD = 1;
				Set_Eff_Text(id,"特效文字1","武林至尊.宝刀屠龙");
			--如果没有触发，则还有40%几率触发必定暴击
    		elseif JLSD(35, 75, pid) then	
    			WAR.BJ = 1
				Set_Eff_Text(id,"特效文字1","号令天下.莫敢不从");
    		end
    	end
	end
	  
	local ng = 0
	
	--化功大法必定不暴击
	if wugong == 87 or wugong == 85 or wugong == 88 then
		WAR.BJ = 0
	end
	
	--千剑归宗必定不暴击
	if wugong == 187 then
		WAR.BJ = 0
	end
	
	--万剑诀必定不暴击
	if wugong == 194 then
		WAR.BJ = 0
	end
	
	--瞬狱杀不暴击
	if wugong == 204 then
		WAR.BJ = 0
	end
	
	--如果暴击
    if WAR.BJ == 1 then
		WAR.Person[id]["特效动画"] = 89		--暴击特效动画
		if match_ID_awakened(pid, 81, 1) and wugong==17 then
			--朱九真暴击后再次判定
				WAR.ZJZBJ=1.5
				local ZJZ=0
		if (Curr_NG(pid, 177) or PersonKF(pid, 172)) and WAR.HXZYJ == 1 then
		ZJZ = ZJZ + 0.5
		end
		if Curr_NG(pid, 104) then
		    ZJZ = ZJZ + 0.2
			if JY.Person[pid]["天赋内功"] == 104 then
				ZJZ = ZJZ + 0.2
			end
			if fx < 0 then
				ZJZ = ZJZ - fx*0.01
			end
	    end
		if JY.Person[pid]["专2"] == 104 and PersonKF(pid, 104) then
		   ZJZ = ZJZ + 0.2
		end
		if JY.Person[60]["阶"] >= 3 and match_ID(pid, 60) then
		    ZJZ = ZJZ + 0.5
		end
		if JY.Person[81]["阶"] >= 1 and match_ID(pid, 81) then
		    ZJZ = ZJZ + 0.1*JY.Person[81]["阶"]^2 + 0.2
		end
		if JY.Person[pid]["人33"] == 1 then
	       ZJZ = ZJZ + 0.20
	    end
		if PersonKF(pid, 104) and PersonKF(pid, 95) then
			ZJZ = ZJZ + 0.1
		end
		if WAR.LQZ[pid] == 100 then
			ZJZ = ZJZ + 0.5
		end
		if JY.Person[pid]["地2"] == 8 then
		ZJZ = ZJZ + 0.03*JY.Person[124]["天1"] + 0.3
		end
		while (math.random(100) < ZhuJZ(pid) or JLSD(25, 70, pid)) and WAR.ZJZBJ<99 do
		WAR.ZJZBJ=WAR.ZJZBJ+ZJZ+0.5
		end
		Set_Eff_Text(id,"特效文字1","娇媚婉转X" ..WAR.ZJZBJ);
		end

		if match_ID(pid, 50) then			--乔峰特效文字
			local r = nil
			r = math.random(3)
			if r == 1 then
				Set_Eff_Text(id,"特效文字1","教单于折箭 六军辟易 奋英雄怒");
			elseif r == 2 then
				Set_Eff_Text(id,"特效文字1","虽万千人吾往矣");
			elseif r == 3 then
				Set_Eff_Text(id,"特效文字1","胡汉恩仇 须倾英雄泪");
			end
		end
		if match_ID(pid, 112) and WAR.ZHRM[pid] == nil and WAR.XYS > 0 then
			if WAR.XYS == 3 then
				Set_Eff_Text(id,"特效文字1","七杀・搅乱世界之贼");
			elseif WAR.XYS == 2 then
				Set_Eff_Text(id,"特效文字1","破军・纵横天下之将");
			elseif WAR.XYS == 1 then
				Set_Eff_Text(id,"特效文字1","贪狼・奸险诡诈之士");
			end
		end
		if match_ID(pid, 677) and JY.Person[677]["天2"] == 1 then
			Set_Eff_Text(id,"特效文字1","奋英雄怒");
		end
		--改成特效文字4显示
		if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
			WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."・".. "暴击"
		else
			WAR.Person[WAR.CurID]["特效文字4"] = "暴击";
		end
    end	
	
	
    --无酒不欢：计算内功加力
	if JY.Person[pid]["主运内功"] > 0 then
		local cur_NG = JY.Person[pid]["主运内功"]
		--吸功，金刚不坏，风林六如，五岳剑诀，太极神功不加力
		if cur_NG ~= 85 and cur_NG ~= 87 and cur_NG ~= 88 and cur_NG ~= 144 and cur_NG ~= 143 and cur_NG ~= 91 and cur_NG ~= 175 and cur_NG ~= 171 then
			local cur_NGL = 0;
			for i = 1, JY.Person[671]["品德"] do
				if JY.Person[pid]["武功"..i] ==  cur_NG then
					cur_NGL = JY.Person[pid]["武功等级" .. i];
				elseif JY.Person[pid]["主运内功"] ==  cur_NG then
					cur_NGL = JY.Person[pid]["武功等级" .. i];
					if cur_NGL == 999 then
						cur_NGL = 11
					else
						cur_NGL = math.modf(cur_NGL / 100) + 1
					end
					break;
				end
			end
			--主运内功有35%的高优先级判定
			if cur_NGL ~= 0 and JLSD(30, 65, pid) then
				ng = get_skill_power(pid, cur_NG, cur_NGL)
				--擒龙功, 加力气攻*1.5
				if Curr_NG(pid, 188) then
					ng = math.modf(ng*1.5)
				end
				WAR.Person[id]["特效文字2"] = JY.Wugong[JY.Person[pid]["主运内功"]]["名称"] .. "加力"
				WAR.Person[id]["特效动画"] = 93
				WAR.NGJL = JY.Person[pid]["主运内功"]
			end
		end
	end
	
	--如果没有触发主运内功加力，再判定一般加力
	if WAR.NGJL == 0 then
		local N_JL = {};		
		local num = 0;	--当前学了多少个内功
		for i = 1, JY.Person[671]["品德"] do
			local kfid = JY.Person[pid]["武功" .. i]
			local kflvl = JY.Person[pid]["武功等级" .. i]
			if kflvl == 999 then
				kflvl = 11
			else
				kflvl = math.modf(kflvl / 100) + 1
			end
			--先把内功都存入表格，吸功，金刚不坏，风林六如，五岳剑诀，太极神功不加力
			if JY.Wugong[kfid]["武功类型"] == 6 and kfid ~= 85 and kfid ~= 87 and kfid ~= 88 and kfid ~= 144 and kfid ~= 143 and kfid ~= 91 and kfid ~= 175 and kfid ~= 171 then
				num = num + 1;
				N_JL[num] = {kfid,i,get_skill_power(pid, kfid, kflvl)};
			end
		end
				
		--如果学有内功
		if num > 0 then	
			--按照威力从大到小排序，威力一样的话按照面板的先后顺序
			for i = 1, num - 1 do
				for j = i + 1, num do
					if N_JL[i][3] < N_JL[j][3] or (N_JL[i][3] == N_JL[j][3] and N_JL[i][2] > N_JL[j][2])then
						N_JL[i], N_JL[j] = N_JL[j], N_JL[i]
					end
				end
			end
			--按顺序判定触发
			for i = 1, num do
				--王重阳北斗七闪状态必定加力
				if (match_ID(pid, 129) and WAR.CYZX[pid] ~= nil and WAR.BDQS > 0) or myrandom(10, pid) then
					ng = N_JL[i][3];
					WAR.Person[id]["特效文字2"] = JY.Wugong[N_JL[i][1]]["名称"] .. "加力"
					WAR.Person[id]["特效动画"] = 87 + math.random(6)
					WAR.NGJL = N_JL[i][1];
					break;
				end
			end
		end
	end
	
	--张无忌补偿加力
    if match_ID(pid, 9) and WAR.NGJL == 0 and PersonKF(pid, 106) then
		WAR.Person[id]["特效动画"] = math.fmod(106, 10) + 85
		WAR.Person[id]["特效文字2"] = "九阳神功加力"
		ng = ng + 1200
    end
	
	--NPC内功补完系统
	if not inteam(pid) and WAR.NGJL == 0 then
		local htName, htPower = G["NPC内功补完系统"](pid)
		if htName then
			WAR.Person[id]["特效动画"] = 87 + math.random(6)
			WAR.Person[id]["特效文字2"] = htName.."加力"
			ng = ng + htPower
		end
	end

	--蟾震九天，斗转不触发
	if PersonKF(pid, 95) and WAR.DZXY == 0 then
		if WAR.tmp[200 + pid] == nil then
			WAR.tmp[200 + pid] = 0
		elseif WAR.tmp[200 + pid] > 100 then
			ng = ng + WAR.tmp[200 + pid] * 10 + 1500
		  
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].. "・蟾震九天"
			else
				WAR.Person[id]["特效文字3"] = "蟾震九天"
			end
			--欧阳锋提高伤害
			if match_ID(pid, 60) or JY.Person[pid]["天赋内功"] == 95 then
				WAR.OYFXL = WAR.tmp[200 + pid]
			end
			WAR.Person[id]["特效动画"] = math.fmod(95, 10) + 85
			
			--蓄力清0
			WAR.tmp[200 + pid] = 0
		end
	end
	
	--天赋外功提高100点气攻
	if Given_WG(pid, wugong) then
		ng = ng + 100
	end
	
	if ZhiGZY(pid) > 0 then
	   ng = ng + ZhiGZY(pid)*200
	end
	
	if wugong == 225 then
	local level = math.modf(JY.Person[pid]["武功等级16"]/100)+1
	   ng = ng + math.modf(get_skill_power(pid, wugong, level)*0.5)
	end 

	if wugong > 225 and wugong < 236 or wugong == 238 then
	   ng = ng + get_skill_power(pid, wugong, 11)
	end
	
	if wugong == 9 and JY.Person[pid]["专1"] == 9 then
	   ng = ng + 1000
	end
	
	if wugong == 240 and JY.Person[pid]["洗髓"] == 100 then
	   ng = ng + 4000
	end
	
	if wugong == 18 and JY.Person[pid]["专2"] == 18 then
	   ng = ng + 1200
	end
	
	if wugong == 20 and JY.Person[pid]["专2"] == 20 then
	   ng = ng + 3000
	end
	
	if wugong == 133 and JY.Person[pid]["专2"] == 133 then
	   ng = ng + 1500
	end
	
	if PersonKF(pid, 55) and JY.Wugong[wugong]["武功类型"] == 4 and JY.Person[pid]["专1"] == 55 then
	   ng = ng + 1100
	end
	
	if PersonKF(pid, 70) and JY.Person[pid]["专1"] == 70 then
	   ng = ng + 1000
	end
	
	if JY.Wugong[wugong]["啊"] > 0 then
	   if tg ~= 1 then
	      if fx > 0 then
		     ng = ng + fx*100
		  end
		  if fx > 9 then
		     ng = ng + 1000
		  end
	   else
	      ng = ng + 1000 + 100*yang
	   end 
	
	end
    
    --无酒不欢：狮子吼
    if PersonKF(pid, 92) then
    	if WAR.Person[id]["特效动画"] == -1 then
    		WAR.Person[id]["特效动画"] = math.fmod(92, 10) + 85
    	end
    	local nl = JY.Person[pid]["内力"];
    	local f = 0;
		local chance = 70
		local force = 100
		--主运提高效果
		if Curr_NG(pid, 92) then
			chance = 100
			force = 200
		end
		if wugong == 23 and match_ID(pid, 13) and JY.Person[13]["阶"] >= 3 then
		   chance = 100
		   force = force + 100
		end
		if JY.Person[pid]["天赋内功"] == 92 then
		force = force + 50
		end
		--一般人需要内力差大于2000，而谢逊只要内力差大于0即可
		local neilicha = 2000
		if match_ID(pid, 13) then
			neilicha = 0
		end
		if math.random(100) <= chance or wugong == 92 then
			f = 1
		end
		if f == 1 then
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and (nl - JY.Person[WAR.Person[j]["人物编号"]]["内力"]) > neilicha then
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - force 
					if WAR.Person[j].TimeAdd<-500 then
						WAR.Person[j].TimeAdd=-500
					end
					if Curr_NG(pid, 92) then
						WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "受伤程度", math.random(5,9))
						WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
					end
					if JY.Person[pid]["专1"] == 92 then
					   local jx = 45+math.random(10)
					   WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
				       JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]  - jx
				       WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - jx
					end
				end
			end
			Set_Eff_Text(id,"特效文字2","狮子吼");
		end
    end
    
    --六如的风火雷
	if pid==0 and JY.Person[pid]["六如觉醒"] > 0  then
    	local rate = limitX(math.modf(20 + (101-JY.Person[pid]["资质"])/10 + JY.Person[pid]["实战"]/50 + JY.Person[pid]["攻击力"]/40 + JY.Person[pid]["武学常识"]/10),0,100)
    	local low = 10

		local rf = 0
		local rh = 0
		local rl = 0
		local times = 1
		--仁者二次判定+循环两次，即一次可以触发两种六如特效
		if JY.Base["标准"] == 7 or match_ID(pid, 189) then
			times = 2
		end
		for i = 1, times do
			if JLSD(low, rate, pid) or ((JY.Base["标准"] == 7 or match_ID(pid, 189)) and JLSD(low, rate, pid)) then
				local lr = math.random(3)
				if lr == 1 then
					rf = 1
				elseif lr == 2 then
					rh = 1
				elseif lr == 3 then
					rl = 1
				end
			end
		end
		
		--其疾如风
    	if rf == 1 and JY.Person[1]["血量翻倍"] == 1 then
			WAR.FLHS1[0] = 1
		end
		--侵略如火
		if rh == 1 and JY.Person[3]["血量翻倍"] == 1 then
			WAR.Person[id]["特效动画"] = 6
			Set_Eff_Text(id,"特效文字2","侵略如火")
			ng = ng + 3000
			WAR.FLHS3 = 1
		end
		--动如雷震
		if rl == 1 and JY.Person[6]["血量翻倍"] == 1 and WAR.FLHS6 < 3 and wugong ~= 205 and wugong ~= 224 and wugong ~= 204 and wugong ~= 227 and wugong ~= 230 and wugong ~= 233 then
			WAR.Person[id]["特效动画"] = 6
			Set_Eff_Text(id,"特效文字2","动如雷震")
			fightnum = fightnum + 1
			WAR.FLHS6 = WAR.FLHS6 + 1
    	end
    end
	
	--主运葵花必出如风
	if Curr_NG(pid, 105) then
		WAR.FLHS1[pid] = 1
	end
	if WAR.FLHS1[pid] ~= nil then
		WAR.Person[id]["特效动画"] = 6
		Set_Eff_Text(id,"特效文字2","其疾如风")
		--[[
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].Time = WAR.Person[j].Time + 100
			end
			if WAR.Person[j].Time > 980 then
				WAR.Person[j].Time = 980
			end
		end]]
	end
	
	--陈家洛庖丁解牛
	if match_ID(pid, 75) and pid == 0 and JLSD(20,70,pid) then
		WAR.PDJN = 1
		Set_Eff_Text(id,"特效文字1","庖丁解牛")
	end
	
	if WAR.NGJL==154 and (wugong == 6 or wugong == 42 or wugong == 79 or wugong == 139) then	
		Set_Eff_Text(id,"特效文字5","终南山下・活死人墓")
	end

    --如果学会北冥神功
    if (PersonKF(pid, 85) and JLSD(45, 75, pid)) or (Curr_NG(pid, 85) and JLSD(20, 70, pid)) then
		if WAR.Person[id]["特效动画"] == -1 then
			WAR.Person[id]["特效动画"] = math.fmod(85, 10) + 85
		end
		Set_Eff_Text(id,"特效文字2","北冥神功");
		WAR.BMXH = 1
		  
		--北冥神功升级
		for w = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. w] < 0 then
				break;
			end
			if JY.Person[pid]["武功" .. w] == 85 then
				JY.Person[pid]["武功等级" .. w] = JY.Person[pid]["武功等级" .. w] + 50
				if JY.Person[pid]["武功等级" .. w] > 999 then
					JY.Person[pid]["武功等级" .. w] = 999
				end
				break;
			end
		end
    end
      
    --吸星大法，与北冥不可同时触发
    if ((PersonKF(pid, 88) and JLSD(45, 75, pid)) or (Curr_NG(pid, 88) and JLSD(20, 70, pid))) and WAR.BMXH == 0 then
		if WAR.Person[id]["特效动画"] == -1 then
			WAR.Person[id]["特效动画"] = math.fmod(88, 10) + 85
		end
		Set_Eff_Text(id,"特效文字2","吸星大法");
		WAR.BMXH = 2
		  
		--吸星大法升级
		for w = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. w] < 0 then
				break;
			end
			if JY.Person[pid]["武功" .. w] == 88 then
				JY.Person[pid]["武功等级" .. w] = JY.Person[pid]["武功等级" .. w] + 50
				if JY.Person[pid]["武功等级" .. w] > 999 then
					JY.Person[pid]["武功等级" .. w] = 999
				end
				break;
			end
		end
    end
    
    --化功大法
    if ((PersonKF(pid, 87) and JLSD(45, 75, pid)) or (Curr_NG(pid, 87) and JLSD(20, 70, pid))) and WAR.BMXH == 0 then
		if WAR.Person[id]["特效动画"] == -1 then
			WAR.Person[id]["特效动画"] = math.fmod(87, 10) + 85
		end
		Set_Eff_Text(id,"特效文字2","化功大法");
		WAR.BMXH = 3
		  
		--化功大法升级
		for w = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. w] < 0 then
				break;
			end
			if JY.Person[pid]["武功" .. w] == 87 then
				JY.Person[pid]["武功等级" .. w] = JY.Person[pid]["武功等级" .. w] + 50
				if JY.Person[pid]["武功等级" .. w] > 999 then
					JY.Person[pid]["武功等级" .. w] = 999
				end
				break;
			end
		end
    end
	
	--蒙哥，气攻+2000点
	if pid == 627 then
		ng = ng + 2000
	end
	
	if WAR.TQGJ[pid] ~= nil then
	   ng = ng + 2000
	end
	
	if match_ID(pid, 39) and JY.Person[39]["阶"] >= 2 then
		ng = ng + 2000
	end
	
	--雷震，降龙
	if match_ID(pid, 670) and wugong == 26 then
	    ng = ng + 1800
	end
	
	--鸠摩智
	if match_ID(pid, 103) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = math.fmod(98, 10) + 85
		Set_Eff_Text(id, "特效文字2", "明王真气")
	end
	
	--brolycjw: 洪七公
    if match_ID(pid, 69) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 67
		Set_Eff_Text(id,"特效文字2","丐王真气");
    end
	
	--四大恶人
    if match_ID(pid, 98) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 200
		if not inteam(pid) then
			ng = ng + 200
		end
		WAR.Person[id]["特效动画"] = math.fmod(98, 10) + 85
		Set_Eff_Text(id,"特效文字2","恶贯满盈");
    end
	
	if match_ID(pid, 99) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 200
		if not inteam(pid) then
			ng = ng + 200
		end
		WAR.Person[id]["特效动画"] = math.fmod(98, 10) + 85
		Set_Eff_Text(id,"特效文字2","无恶不作");
    end
	
	if match_ID(pid, 100) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 200
		if not inteam(pid) then
			ng = ng + 200
		end
		WAR.Person[id]["特效动画"] = math.fmod(98, 10) + 85
		Set_Eff_Text(id,"特效文字2","穷凶极恶");
    end
	
	if match_ID(pid, 44) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 200
		if not inteam(pid) then
			ng = ng + 200
		end
		WAR.Person[id]["特效动画"] = math.fmod(98, 10) + 85
		Set_Eff_Text(id,"特效文字2","凶神恶煞");
    end
	
	--余沧海
    if match_ID(pid, 24) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 100
		if match_ID_awakened(pid, 24, 1) or match_ID_awakened(pid, 24, 2) then
		   ng = ng + 1900
		end
		if not inteam(pid) then
			ng = ng + 100
		end
		WAR.Person[id]["特效动画"] = 67
		Set_Eff_Text(id,"特效文字2","松风剑神");
    end
	
	--成昆
    if match_ID(pid, 18) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字2"] == nil then
			WAR.Person[id]["特效文字2"] = "混元霹雳功加力"
		else
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+混元霹雳功"
		end
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = "魔相・幻阴".."・"..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = "魔相・幻阴"
		end
    end
	
 	--殷天正
    if match_ID(pid, 12) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 500
		if not inteam(pid) then
			ng = ng + 500
		end
		WAR.Person[id]["特效动画"] = 67
		Set_Eff_Text(id,"特效文字2","鹰王真气");
    end
	
	--左冷禅
    if match_ID(pid, 22) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 500
		if not inteam(pid) then
			ng = ng + 500
		end
		WAR.Person[id]["特效动画"] = 1
		Set_Eff_Text(id,"特效文字2","寒冰真气");
    end
	
	--brolycjw: 黄药师
    if match_ID(pid, 57) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 95
		Set_Eff_Text(id,"特效文字2","奇门奥义");
    end
	
	--brolycjw: 谢烟客
    if match_ID(pid, 164) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 1000
		if not inteam(pid) then
			ng = ng + 1000
		end
		WAR.Person[id]["特效动画"] = 23
		Set_Eff_Text(id,"特效文字2","控鹤功");
    end
	
	--戚长发
    if match_ID(pid, 594) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 93
		Set_Eff_Text(id,"特效文字2","铁锁横江");
    end
	
	--慕容博
    if match_ID(pid, 113) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 93
		Set_Eff_Text(id,"特效文字2","参合真气");
    end
	
    --任我行 
    if match_ID(pid, 26) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 6
		Set_Eff_Text(id,"特效文字2","魔帝・吸星");
    end
	
	  --无酒不欢 放荡不羁 
    if JY.Base["特殊"] ==1 and JY.Person[33]["血量翻倍"]==1 and pid==0 and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) then
		ng = ng + 300
		WAR.Person[id]["特效动画"] = 6
		Set_Eff_Text(id,"特效文字2","放荡不羁");
    end
	
	--何铁手
    if match_ID(pid, 83) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 500
		if not inteam(pid) then
			ng = ng + 500
		end
		WAR.Person[id]["特效动画"] =  92
		Set_Eff_Text(id,"特效文字2","红袖拂风");
    end
	
	--阿紫曼珠沙华，每杀一个人+200气攻
	if match_ID(pid, 47) then
		ng = ng + 200*WAR.MZSH
	end
	
    --枯荣
    if match_ID(pid, 102) and (inteam(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 23
		if math.random(2) == 1 then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = "有常无常・双树枯荣・"..WAR.Person[id]["特效文字3"]
			else
				WAR.Person[id]["特效文字3"] = "有常无常・双树枯荣"
			end
		else
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = "南北西东・非假非空・"..WAR.Person[id]["特效文字3"]
			else
				WAR.Person[id]["特效文字3"] = "南北西东・非假非空"
			end
		end
    end
    
    --天罡内功到极无误伤，50%几率发动天罡真气・
    if pid == 0 and JY.Base["标准"] == 6 and level == 11 then
		WAR.WS = 1
		if JLSD(25, 75, pid) then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+天罡真气・"..JY.Wugong[wugong]["名称"]
			else
				WAR.Person[id]["特效文字3"] = "天罡真气・"..JY.Wugong[wugong]["名称"]
			end
			ng = ng + JY.Wugong[wugong]["攻击力10"]
		end
    end

	--龙爪手+灵蛇仗法 龙蛇演义 水笙自带
	if (wugong==20 or wugong==81) and (LongShe(pid) or match_ID(pid, 589)) and (JLSD(20,40,pid) or WAR.LQZ[pid] == 100) then
		WAR.WS = 1
			if WAR.Person[id]["特效文字5"] ~= nil then
				WAR.Person[id]["特效文字5"] = WAR.Person[id]["特效文字5"].."+龙蛇演义・打破虚空，见神不坏"..JY.Wugong[wugong]["名称"]
			else
				WAR.Person[id]["特效文字5"] = "龙蛇演义・打破虚空，见神不坏"..JY.Wugong[wugong]["名称"]
			end
		War_RestMenu()
	end
	
	--斗转幻梦星辰特效动画
	if WAR.DZXYLV[id] == 150 then
		WAR.Person[id]["特效动画"] = 107
    end
	
	--苗人凤苗剑
	if WAR.ZDDH == 4 and wugong == 44 and level == 11 and WAR.ZHDJY == 0  and  pid==3 then
	if WAR.ACT==1 then
	 for i = 1, 30 do
			   DrawStrBox(-1, 24, "苗剑・提撩剑白鹤舒翅", M_Red, 10 + i)
			   ShowScreen()
			   lib.Delay(20)
	end
	end
	if WAR.ACT==2 then
	 for i = 1, 30 do
			   DrawStrBox(-1, 24, "苗剑・黄龙转身吐须势", M_DeepSkyBlue, 10 + i)
			   ShowScreen()
			   lib.Delay(20)
	end
	end
	if WAR.ACT==3 then
	 for i = 1, 30 do
			   DrawStrBox(-1, 24, "苗剑・冲天掌苏秦背剑", C_GOLD, 10 + i)
			   ShowScreen()
			   lib.Delay(20)
	end
	end
		  for i = 1, (level) / 2 + 1 do
				for j = 1, (level) / 2 + 1 do
					SetWarMap(x + i - 1, y + j - 1, 4, 1)
					SetWarMap(x - i + 1, y + j - 1, 4, 1)
					SetWarMap(x + i - 1, y - j + 1, 4, 1)
					SetWarMap(x - i + 1, y - j + 1, 4, 1)
					end
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
					 end
                 end
			end
		end

	--大伏魔拳
	if JY.Wugong[wugong]["武功类型"] == 1 and Curr_NG(pid, 107) and JY.Person[pid]["拳掌功夫"] >= 240 and math.random(100) < 51 then
			Set_Eff_Text(id, "特效文字1", "大伏魔拳")
			WAR.WS = 1
			ng = ng + 1200
			for i = 1, (level) / 2 + 1 do
				for j = 1, (level) / 2 + 1 do
					SetWarMap(x + i - 1, y + j - 1, 4, 1)
					SetWarMap(x - i + 1, y + j - 1, 4, 1)
					SetWarMap(x + i - 1, y - j + 1, 4, 1)
					SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
    end
	
    --降龙极意
    if wugong == 26 and WAR.AXFJ == 0 then
		--乔峰必出极意，洪七公，郭靖，拳主角40%，擒龙20%JY.Person[pid]["专2"] == 26
		if match_ID(pid, 50) 
		or ((match_ID(pid, 69) or match_ID(pid, 55) or pid==612 or (pid == 0 and JY.Base["标准"] == 1)) and JLSD(30, 70, pid)) 
		or (PersonKF(pid, 188) and JLSD(30, 50, pid)) 
		or match_ID(pid, 692) and JY.Person[692]["天4"] == 1 then
			Set_Eff_Text(id, "特效文字3", XL18JY[math.random(8)])

			ng = ng + 2300
			WAR.WS = 1
			for i = 1, (level) / 2 + 1 do
				for j = 1, (level) / 2 + 1 do
					SetWarMap(x + i - 1, y + j - 1, 4, 1)
					SetWarMap(x - i + 1, y + j - 1, 4, 1)
					SetWarMap(x + i - 1, y - j + 1, 4, 1)
					SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		elseif wugong == 26 and JY.Person[pid]["专2"] == 26 then
			Set_Eff_Text(id, "特效文字3", XL18JY[math.random(8)])

			ng = ng + 1200
			WAR.WS = 1
			for i = 1, (level) / 2 + 1 do
				for j = 1, (level) / 2 + 1 do
					SetWarMap(x + i - 1, y + j - 1, 4, 1)
					SetWarMap(x - i + 1, y + j - 1, 4, 1)
					SetWarMap(x + i - 1, y - j + 1, 4, 1)
					SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
        end	
    end
	
	


	--洪七公二连
	if match_ID(pid, 69) and wugong == 26 and WAR.HQGXL==0 then
		if WAR.ACT==2 then
			for i = 1, 30 do
			   DrawStrBox(-1, 24, "盖世无双・打狗棒法", C_GOLD, 10 + i)
			   ShowScreen()
			   lib.Delay(20)
			end	
		WAR.HQGXL=1
		end
	end
	
	if match_ID(pid, 69) and wugong == 80 and WAR.HQGDG==0 then
		if WAR.ACT==2 then	
			for i = 1, 30 do
			   DrawStrBox(-1, 24, "盖世无双・降龙十八掌", C_GOLD, 10 + i)
			   ShowScreen()
			   lib.Delay(20)
			end
		WAR.HQGDG=1
		end
	end
	
	if JY.Person[pid]["动物"] == 348 and WAR.SDXT == 1 then
		if WAR.ACT==2 then	
		   wugong = 45
		else
		   wugong = WAR.SDXTH
		end
	end
	
	if JY.Person[249]["品德"] == 1020 and WAR.SYZY == 1 and pid == 0 then
		if WAR.ACT==2 then	
		   wugong = 238
		else
		   wugong = WAR.SYZYH
		end
	end
	
	if WAR.HQGXL ==1 then
		wugong=80
		WAR.HQGXL=2		
	end
	
	if WAR.HQGDG ==1 then
		wugong=26
		WAR.HQGXL=2		
	end

	
	--玄冥极意，主角有40%几率触发，暴怒必出，玄冥二老必出
	local xmjy = 0
	if match_ID(pid,647) or match_ID(pid,648) then
		xmjy = 1
	end
	if pid == 0 and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
		xmjy = 1
	end
	if JY.Person[pid]["专2"] == 21 then
		xmjy = 1
	end
	if wugong == 21 and level == 11 and xmjy == 1 and WAR.AXFJ == 0 then
		Set_Eff_Text(id, "特效文字1", "玄冥极意")
		ng = ng + 1500
		WAR.WS = 1
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
	end
	
	--三枪拍案惊奇，学有杨家枪、呼延枪法、中平枪法，奇门40%几率触发，暴怒必出

	if SANQIANGPAIAN(pid) and (wugong == 68 or wugong == 70 or wugong == 165) and (WAR.LQZ[pid] == 100 or JLSD(30, 30+SANQIANGPAIANSL(pid)*15, pid)) then
		if SANQIANGPAIANSL(pid)==1 then
		Set_Eff_Text(id, "特效文字1", "单枪拍案惊奇")
		elseif SANQIANGPAIANSL(pid)==2 then
		Set_Eff_Text(id, "特效文字1", "双枪拍案惊奇")
		else
		Set_Eff_Text(id, "特效文字1", "三枪拍案惊奇")
		end
		ng = ng + 500*SANQIANGPAIANSL(pid)
		WAR.WS = 1
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
	end

		
	--黯然极意
	if WAR.ARJY == 1 and WAR.AXFJ == 0 then 
		ng = ng + 1200
		WAR.WS = 1
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
	end
	
	if WAR.BDSQ == 4 and WAR.AXFJ == 0 then 
		ng = ng + 1500
		for i = 1, 7 do
			for j = 1, 7 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
		for i = 1, 9, 2 do
			for j = 1, 9, 2 do
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
			end
		end
		WAR.BDSQ = 0
	end
	
	--qlong
	if wugong == 26 and WAR.NGJL == 188 then
	   ng = ng + 1100
		WAR.WS = 1
		for i = 1, 11, 2 do
			for j = 1, 11, 2 do
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
			end
		end
	end
	
	if JY.Person[pid]["人8"] == 1 then
	   ng = ng + 500
	   if math.random(100) < 67 then
	   ng = ng + 500
		WAR.WS = 1
		for i = 1, 21, 2 do
			for j = 1, 21, 2 do
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
			end
		end
		end
	end
	
	--夏雨点点
	if WAR.XYDD == 1 and WAR.AXFJ == 0 then 
		ng = ng + 1500
		WAR.WS = 1
		for i = 1, 11, 2 do
			for j = 1, 11, 2 do
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
			end
		end
		
	end
	
	if wugong == 222 and (WAR.YSJZS == 3 or WAR.YSJZS == 4) and WAR.AXFJ == 0 then 
		WAR.WS = 1
		ng = ng + 1300
		for i = 1, 11, 2 do
			for j = 1, 11, 2 do
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
			end
		end
	end
	
	--陆小凤
	if ((match_ID(pid, 678) and JY.Person[678]["天4"] == 2) or (JY.Base["标准"] == 2 and pid == 0)) and JY.Wugong[wugong]["武功类型"] == 2 then
	if math.random(100) < 33 or WAR.LQZ[pid] == 100 then
	local m1, m2, a1 = refw(wugong, 11)
	local add = math.modf(JY.Person[pid]["指法技巧"]*0.01)
	if JY.Base["标准"] == 2 then
	   add = add + math.modf(JY.Base["天书数量"]/5)
	end
	--m1为移动范围斜向延伸：
	--0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
  --m2为移动范围直线延伸；
	--数字即等于延伸距离
  --a1为攻击范围类型：
	--0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：d字，9：e字，10：直线，11：正三角，12：倒三角，13：横线
  --a2为攻击范围长度距离：
	--0：点攻，大于0时，距离 = a2
  --a3为攻击范围宽度(偏移1格)距离：
	--0：点攻，大于0时，距离 = a3  
  --a4为攻击范围宽度(偏移2格)距离：
	--0：点攻，大于0时，距离 = a4
  --a5为攻击范围宽度(偏移3格)距离：
	--0：点攻，大于0时，距离 = a5
	--
	if a1 == 1 then
	      for i = 1, 9 + add, 2 do
			for j = 1, 9 + add, 2 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		  end
		--  
	elseif a1 == 10 then
	local len1, len2, len3, len4 = 9+add,9+add,8+add,7+add
		if not len2 then
        len2 = 0
        end
        if not len3 then
        len3 = 0
        end
        if not len4 then
        len4 = 0
        end
        local fx, fy = x - x0, y - y0
        if fx > 0 then
        fx = 1
        elseif fx < 0 then
        fx = -1
        end
        if fy > 0 then
        fy = 1
        elseif fy < 0 then
        fy = -1
        end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
    for i = 0, len1 - 1 do
    SetWarMap(x + i * fx, y + i * fy,4,1)
    end
    for i = 0, len2 - 1 do
	SetWarMap(x + dx1 + i * fx, y + dy1 + i * fy,4,1)
	SetWarMap(x + dx2 + i * fx, y + dy2 + i * fy,4,1)
    end
        for i = 0, len3 - 1 do
	    SetWarMap(x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy,4,1)
	    SetWarMap(x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy,4,1)
        end
        for i = 0, len4 - 1 do
	    SetWarMap(x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy,4,1)
	    SetWarMap(x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy,4,1)
        end
		--
	elseif a1 == 12 then
	local len1 = 7 + add
	local fx, fy = x - x0, y - y0
    if fx > 1 then
       fx = 1
    elseif fx < -1 then
      fx = -1
    end
    if fy > 1 then
      fy = 1
    elseif fy < -1 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    if fx ~= 0 and fy ~= 0 then
      dx1 = (dx1 + fx) / 2
      dx2 = (dx2 + fx) / 2
      dy1 = (dy1 + fy) / 2
      dy2 = (dy2 + fy) / 2
      len1 = math.modf(len1 * 1.41421)
      for i = 0, len1 do
        if i <= len1 / 2 then
		  SetWarMap(x + i * fx, y + i * fy,4,1)
        end
        for j = 1, len1 - i * 2 do
		SetWarMap(x + i * fx + j * (dx1), y + i * fy + j * (dy1),4,1)
		SetWarMap(x + i * fx + j * (dx2), y + i * fy + j * (dy2),4,1)
        end
      end
	else
      for i = 0, len1 do
        SetWarMap(x + i * fx, y + i * fy,4, 1)
        for j = 1, i do
          SetWarMap(x + i * fx + j * (dx1), y + i * fy + j * (dy1),4, 1)
          SetWarMap(x + i * fx + j * (dx2), y + i * fy + j * (dy2),4, 1)
        end
      end  
	end  
		
	elseif a1 == 3 then
		for i = 1, 2 + add do
			for j = 1, 2 + add do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
	
	end
	
	
	end	
	end	
	
	--达摩剑
	if wugong == 140 and JY.Person[pid]["专2"] == 140 and WAR.AXFJ == 0 then
	   WAR.WS = 1
	   ng = ng + 1000
		for i = 0,14,2 do
		    for j = 0,14 do 
			    if j <= i then
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				end
			end
		end
		for i = 0,14 do
		    for j = 0,14,2 do 
			    if i <= j then
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)  
				end
			end
		end
	end
	
	--libai
	if WAR.LBJY == 1 then
	ng = ng + 1000
	if math.random(2) == 1 then
	local m1, m2, a1 = refw(wugong, 11)
	local add = math.modf(JY.Person[pid]["御剑能力"]*0.02)+2
	if a1 == 1 then
	      for i = 1, 9 + add, 2 do
			for j = 1, 9 + add, 2 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		  end
		--  
	elseif a1 == 10 then
	local len1, len2, len3, len4 = 9+add,9+add,8+add,7+add
		if not len2 then
        len2 = 0
        end
        if not len3 then
        len3 = 0
        end
        if not len4 then
        len4 = 0
        end
        local fx, fy = x - x0, y - y0
        if fx > 0 then
        fx = 1
        elseif fx < 0 then
        fx = -1
        end
        if fy > 0 then
        fy = 1
        elseif fy < 0 then
        fy = -1
        end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
    for i = 0, len1 - 1 do
    SetWarMap(x + i * fx, y + i * fy,4,1)
    end
    for i = 0, len2 - 1 do
	SetWarMap(x + dx1 + i * fx, y + dy1 + i * fy,4,1)
	SetWarMap(x + dx2 + i * fx, y + dy2 + i * fy,4,1)
    end
        for i = 0, len3 - 1 do
	    SetWarMap(x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy,4,1)
	    SetWarMap(x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy,4,1)
        end
        for i = 0, len4 - 1 do
	    SetWarMap(x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy,4,1)
	    SetWarMap(x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy,4,1)
        end
		--
	elseif a1 == 12 then
	local len1 = 7 + add
	local fx, fy = x - x0, y - y0
    if fx > 1 then
       fx = 1
    elseif fx < -1 then
      fx = -1
    end
    if fy > 1 then
      fy = 1
    elseif fy < -1 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    if fx ~= 0 and fy ~= 0 then
      dx1 = (dx1 + fx) / 2
      dx2 = (dx2 + fx) / 2
      dy1 = (dy1 + fy) / 2
      dy2 = (dy2 + fy) / 2
      len1 = math.modf(len1 * 1.41421)
      for i = 0, len1 do
        if i <= len1 / 2 then
		  SetWarMap(x + i * fx, y + i * fy,4,1)
        end
        for j = 1, len1 - i * 2 do
		SetWarMap(x + i * fx + j * (dx1), y + i * fy + j * (dy1),4,1)
		SetWarMap(x + i * fx + j * (dx2), y + i * fy + j * (dy2),4,1)
        end
      end
	else
      for i = 0, len1 do
        SetWarMap(x + i * fx, y + i * fy,4, 1)
        for j = 1, i do
          SetWarMap(x + i * fx + j * (dx1), y + i * fy + j * (dy1),4, 1)
          SetWarMap(x + i * fx + j * (dx2), y + i * fy + j * (dy2),4, 1)
        end
      end  
	end  
		
	elseif a1 == 3 then
		for i = 1, 2 + add do
			for j = 1, 2 + add do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
	
	end
	else
	   WAR.WS = 1
	   ng = ng + 600
		for i = 0,12,2 do
		    for j = 0,12 do 
			    if j <= i then
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				end
			end
		end
		for i = 0,12 do
		    for j = 0,12,2 do 
			    if i <= j then
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] - j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)
				   SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i, WAR.Person[WAR.CurID]["坐标Y"] + j, 4, 1)  
				end
			end
		end
	end
	end
	if wugong == 238 then
	   for e = 0, WAR.PersonNum - 1 do
	       if WAR.Person[e]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[e]["死亡"] == false then
	       local xe, ye = WAR.Person[e]["坐标X"], WAR.Person[e]["坐标Y"]
		   local r1 = math.random(-2-math.random(0,1),2+math.random(0,1))
	       local r2 = math.random(-2-math.random(0,1),2+math.random(0,1))
		         for i = 1, 3 do
				    for j = 1, 3 do
					    SetWarMap(xe+r1 + i - 1, ye+r2 + j - 1, 4, 1)
				        SetWarMap(xe+r1 - i + 1, ye+r2 + j - 1, 4, 1)
				        SetWarMap(xe+r1 + i - 1, ye+r2 - j + 1, 4, 1)
				        SetWarMap(xe+r1 - i + 1, ye+r2 - j + 1, 4, 1)
		            end
		         end
	       end
	   end
	end
	
	--超震声波
	if wugong == 235 and JY.Person[690]["天3"] == 2 then
	local len1,len2,len3,len4 = 11+math.modf(JY.Person[689]["天2"]*0.8),10+math.modf(JY.Person[689]["天2"]*0.8),9+math.modf(JY.Person[689]["天2"]*0.8),8
	for fx = -1, 1 do 
    for fy = -1, 1 do
    if fx > 0 then
      fx = 1
    elseif fx < 0 then
      fx = -1
    end
    if fy > 0 then
      fy = 1
    elseif fy < 0 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
	
	
       for i = 0, len1 - 1 do
		 SetWarMap(x0 + i * fx, y0 + i * fy,4,1)
       end

         for i = 0, len2 - 1 do
		   SetWarMap(x0 + dx1 + i * fx, y0 + dy1 + i * fy,4,1)
           SetWarMap(x0 + dx2 + i * fx, y0 + dy2 + i * fy,4,1)
         end
         for i = 0, len3 - 1 do
		   SetWarMap(x0 + 2 * dx1 + i * fx, y0 + 2 * dy1 + i * fy,4,1)
           SetWarMap(x0 + 2 * dx2 + i * fx, y0 + 2 * dy2 + i * fy,4,1)
         end
         for i = 0, len4 - 1 do
		   SetWarMap(x0 + 3 * dx1 + i * fx, y0 + 3 * dy1 + i * fy,4,1)
           SetWarMap(x0 + 3 * dx2 + i * fx, y0 + 3 * dy2 + i * fy,4,1)
         end
	   
	end
	end
	end
	
  --无酒不欢：参数说明
  --m1为移动范围斜向延伸：
	--0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
  --m2为移动范围直线延伸；
	--数字即等于延伸距离
  --a1为攻击范围类型：
	--0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：d字，9：e字，10：直线，11：正三角，12：倒三角，13：横线
  --a2为攻击范围长度距离：
	--0：点攻，大于0时，距离 = a2
  --a3为攻击范围宽度(偏移1格)距离：
	--0：点攻，大于0时，距离 = a3  
  --a4为攻击范围宽度(偏移2格)距离：
	--0：点攻，大于0时，距离 = a4
  --a5为攻击范围宽度(偏移3格)距离：
	--0：点攻，大于0时，距离 = a5
	--天柱云气
	if WAR.TZYQ == 1 and WAR.AXFJ == 0 then 
		WAR.WS = 1
		ng = ng + 1000
		local len1, len2, len3, len4 = 17,17,17,17
	if not len2 then
      len2 = 0
    end
    if not len3 then
      len3 = 0
    end
    if not len4 then
      len4 = 0
    end
    local fx, fy = x - x0, y - y0
    if fx > 0 then
      fx = 1
    elseif fx < 0 then
      fx = -1
    end
    if fy > 0 then
      fy = 1
    elseif fy < 0 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
    for i = 0, len1 - 1 do
    SetWarMap(x + i * fx, y + i * fy,4,1)
    end
    for i = 0, len2 - 1 do
	SetWarMap(x + dx1 + i * fx, y + dy1 + i * fy,4,1)
	SetWarMap(x + dx2 + i * fx, y + dy2 + i * fy,4,1)
    end
    for i = 0, len3 - 1 do
	SetWarMap(x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy,4,1)
	SetWarMap(x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy,4,1)
    end
    for i = 0, len4 - 1 do
	SetWarMap(x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy,4,1)
	SetWarMap(x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy,4,1)
    end
		
	end
	
	--熔炉精灵
	if wugong == 233 then
	   WAR.WS = 1
       local d = WAR.Person[WAR.CurID]["人方向"]
	   if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 or CC.SceneWater[lib.GetWarMap(x, y, 0)] ~= nil then
	   else
	       for e = 0, WAR.PersonNum - 1 do
		       if WAR.Person[e]["人物编号"] == 690 and WAR.Person[e]["死亡"] == false then
			      WAR.Person[e]["死亡"] = true
				  break
			   end 
		   end
		   NewWARPersonZJ(690, true, x, y, false, d)
		   WAR.SWKY[690] = 60 + JY.Person[689]["天3"]*8
		   if JY.Person[pid]["专1"] == 233 then
			  WAR.SWKY[690] = 80 + JY.Person[689]["天3"]*9
	       end
		    JY.Person[690]["生命"] = 1000+JY.Person[689]["天2"]*400
			JY.Person[690]["生命最大值"] = 1000+JY.Person[689]["天2"]*400
			JY.Person[690]["内力"] = 2000+JY.Person[689]["天2"]*500
			JY.Person[690]["内力最大值"] = 2000+JY.Person[689]["天2"]*500
			if JY.Person[pid]["专1"] == 233 then
			   JY.Person[690]["生命"] = 1400+JY.Person[689]["天2"]*600
			   JY.Person[690]["生命最大值"] = 1400+JY.Person[689]["天2"]*600
			   JY.Person[690]["内力"] = 2300+JY.Person[689]["天2"]*600
			   JY.Person[690]["内力最大值"] = 2300+JY.Person[689]["天2"]*600
	        end
	   end
	end
	--寒冰之墙
	if wugong == 234 then
	CleanWarMap(6,-1)
	local len1,len2 = 1+math.modf(JY.Person[689]["天1"]*0.5), 6+JY.Person[689]["天1"]
	if JY.Person[pid]["专1"] == 234 or (not inteam(pid) and match_ID(pid, 689)) then
	   len2 = 7+JY.Person[689]["天1"]
	   len1 = len2   
	end
    local dx, dy = math.abs(x - x0), math.abs(y - y0)
    if dy < dx then
      len1, len2 = len2, len1
    end
    for tx = x - len1, x + len1 do
      for ty = y - len2, y + len2 do
		SetWarMap(tx, ty, 6,5)
      end
    end
	end
	
	--涯角枪
	if (wugong == 68 or wugong == 70 or wugong == 165 or wugong == 208) and WAR.AXFJ == 0 and JY.Person[pid]["武器"] == 344 then 
	if (JY.Thing[344]["装备等级"] == 6 or (JY.Person[pid]["专2"] == 208 and wugong == 208) or match_ID(pid, 688)) and math.random(100) > WAR.ACT*33 then
	   fightnum = fightnum + 1
	end   
	local jl = 12
	jl = jl + JY.Thing[344]["装备等级"] * 5
	if match_ID(pid, 688) then
	   jl = 100
	end
	if math.random(100) <= jl or (JY.Person[pid]["专2"] == 208 and wugong == 208) then 
	    Set_Eff_Text(id, "特效文字1", "海角天涯无对")
		WAR.WS = 1
		ng = ng + 2000
	local len1, len2, len3, len4 = 11+JY.Thing[344]["装备等级"],11+JY.Thing[344]["装备等级"],11+JY.Thing[344]["装备等级"],11+JY.Thing[344]["装备等级"]
	if not len2 then
      len2 = 0
    end
    if not len3 then
      len3 = 0
    end
    if not len4 then
      len4 = 0
    end
    local fx, fy = x - x0, y - y0
    if fx > 0 then
      fx = 1
    elseif fx < 0 then
      fx = -1
    end
    if fy > 0 then
      fy = 1
    elseif fy < 0 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
    for i = 0, len1 - 1 do
    SetWarMap(x + i * fx, y + i * fy,4,1)
    end
    for i = 0, len2 - 1 do
	SetWarMap(x + dx1 + i * fx, y + dy1 + i * fy,4,1)
	SetWarMap(x + dx2 + i * fx, y + dy2 + i * fy,4,1)
    end
    for i = 0, len3 - 1 do
	SetWarMap(x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy,4,1)
	SetWarMap(x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy,4,1)
    end
    for i = 0, len4 - 1 do
	SetWarMap(x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy,4,1)
	SetWarMap(x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy,4,1)
    end
	end	
	end
	
	--真.苗剑极意
	if WAR.ZHDJY == 1 then 
		ng = ng + 2000
		WAR.WS = 1
		for i = 1, 6 do
			for j = 1, 6 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 7 and offset2 <= 7 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end				
				
			end
		end
	end	
  
	--六脉神剑，50%几率剑气碧烟横
	if (wugong == 49 or wugong == 224) and JLSD(20,70,pid) then
		WAR.JQBYH = 1
		Set_Eff_Text(id, "特效文字3", "剑气碧烟横")
	end
  
	--使用六脉神剑
    if wugong == 49 then
		local jl = 0
    	--学会一阳指
     	if PersonKF(pid, 17) then
			jl = jl + 30
		end
		if (myrandom(level+jl, pid) or (match_ID(pid, 53) and myrandom(level+jl, pid))) and match_ID(pid, 687) == false then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "・" ..LMSJ[math.random(6)]
			else
				WAR.Person[id]["特效文字3"] = LMSJ[math.random(6)]
			end
			ng = ng + 2000
			if match_ID(pid, 53) then
				WAR.LMSJwav = 1
				WAR.WS = 1
			end
		end
		if match_ID(pid, 687) and WAR.LMZS ~= nil and WAR.LMZS > 0 then
		    if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・" ..LMSJ[WAR.LMZS]
			else
				WAR.Person[id]["特效文字1"] = LMSJ[WAR.LMZS]
			end
			ng = ng + 2000
		end
    end
	
	---kaelsound
	if match_ID(pid, 689) and not match_ID(pid, 642) and (WAR.ACT == 1 or WAR.ACT == 3 or WAR.ACT == 5) then
	if (wugong >= 226 and wugong <= 235 or wugong == 238) and math.random(100) < 70 then
	
	if wugong == 226 and WAR.ACT == 1 then
	   PlayWavAtk(46 + math.random(5))
	elseif wugong == 227 and WAR.ACT == 1 then
	   PlayWavAtk(100 + math.random(5))
	elseif wugong == 228 and WAR.ACT == 1 then
	   PlayWavAtk(51 + math.random(5))
	elseif wugong == 229 and WAR.ACT == 1 then
	   PlayWavAtk(56 + math.random(10))
	elseif wugong == 230 and WAR.ACT == 1 then
	   PlayWavAtk(66 + math.random(5))   
	elseif wugong == 231 and WAR.ACT == 1 then
	   PlayWavAtk(71 + math.random(7))
	elseif (wugong == 232 or wugong == 238) and WAR.ACT == 1 then
	   PlayWavAtk(78 + math.random(5))--eee  
	elseif wugong == 233 and WAR.ACT == 1 then
	   PlayWavAtk(83 + math.random(6))
	elseif wugong == 234 and WAR.ACT == 1 then
	   PlayWavAtk(89 + math.random(5))
	elseif wugong == 235 and WAR.ACT == 1 then
	   PlayWavAtk(94 + math.random(6))
	end
	lib.Delay(230)
	else
	local wav = 105 + math.random(22)
	   PlayWavAtk(wav)	
	   if wav == 106 then
	      lib.Delay(2700)
	   end
	   lib.Delay(200)
	end
	end
	
	if wugong == 224 then   
		    if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."・少泽剑"
			else
				WAR.Person[id]["特效文字1"] = "少泽剑"
			end
			ng = ng + 2000
    end
	
	--莫名剑法伤害变化
	
	if wugong == 199 then
	   JY.Wugong[199]["攻击力10"] = 500
	
	    if WAR.MMZS == 1 then
	       local n = JY.Base["天书数量"]*0.2
		   if n > 1.5 then
		      n = 1.5
		   end
		       ng = ng + math.ceil(JY.Person[pid]["御剑能力"]*(1+n))
		       JY.Wugong[199]["攻击力10"] = math.ceil(JY.Person[pid]["御剑能力"]*(1+n)+300)
		
		elseif WAR.MMZS == 2 then
		       ng = ng + math.ceil(JY.Person[pid]["轻功"]*1.5+300)
		       JY.Wugong[199]["攻击力10"] = math.ceil(JY.Person[pid]["轻功"]+JY.Person[pid]["御剑能力"]*0.5+300)
		   
		elseif WAR.MMZS == 3 then
	           ng = ng + math.ceil(JY.Person[pid]["御剑能力"]*0.8+JY.Person[pid]["攻击力"]*1.5)
		       JY.Wugong[199]["攻击力10"] = math.ceil(JY.Person[pid]["御剑能力"]*0.5+JY.Person[pid]["攻击力"]*1.2)
           
		   
		elseif WAR.MMZS == 4 then
	       if WAR.LQZ[pid] == 100 then
		       ng = ng + math.ceil(JY.Person[pid]["御剑能力"]+500)
		       JY.Wugong[199]["攻击力10"] = math.ceil(math.ceil(JY.Person[pid]["御剑能力"]*4*(JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])/JY.Person[pid]["生命最大值"]+200))
           elseif WAR.LQZ[pid] ~= nil then
		       ng = ng + math.ceil(JY.Person[pid]["御剑能力"]+WAR.LQZ[pid]*3+(JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])*0.2)
		       JY.Wugong[199]["攻击力10"] = math.ceil(JY.Person[pid]["御剑能力"]+WAR.LQZ[pid]*3+(JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])*0.2)
           end

		elseif WAR.MMZS == 5 then
	           ng = ng + math.ceil(JY.Person[pid]["内力"]*0.1)
		       JY.Wugong[199]["攻击力10"] = math.ceil(JY.Person[pid]["攻击力"]+JY.Person[pid]["内力"]*0.05)
           

		elseif WAR.MMZS == 6 then
		    if WAR.LQZ[pid] ~= nil then
	           ng = ng + math.ceil((WAR.LQZ[pid]/50)*JY.Person[pid]["御剑能力"]+400)
		       JY.Wugong[199]["攻击力10"] = math.ceil((WAR.LQZ[pid]/60)*JY.Person[pid]["御剑能力"]+700)
            end

		elseif WAR.MMZS == 7 then
	           ng = ng + math.ceil(JY.Person[pid]["攻击力"])
		       JY.Wugong[199]["攻击力10"] = math.ceil(JY.Person[pid]["攻击力"])+200
           

		elseif WAR.MMZS == 8 then
		       ng = ng + math.ceil(JY.Person[pid]["御剑能力"]*1.1)
		       JY.Wugong[199]["攻击力10"] = math.ceil(JY.Person[pid]["御剑能力"]*1+500)
             		   
		elseif WAR.MMZS == 9 then
	           ng = ng + math.ceil(JY.Person[pid]["御剑能力"]*2)
		       JY.Wugong[199]["攻击力10"] = math.ceil(JY.Person[pid]["御剑能力"]*2*((JY.Base["天书数量"]+1)/15))
           

		elseif WAR.MMZS == 10 then
	           ng = ng + math.ceil(2000+JY.Person[pid]["御剑能力"])
		       JY.Wugong[199]["攻击力10"] = math.ceil(JY.Person[pid]["御剑能力"]+JY.Person[pid]["内力"]*0.07)
			    			   
		end
		if JY.Wugong[199]["攻击力10"] > 1600 then
	      JY.Wugong[199]["攻击力10"] = 1600 + (JY.Wugong[199]["攻击力10"] - 1600)*0.4
		  if JY.Wugong[199]["攻击力10"] > 1800 then
		     JY.Wugong[199]["攻击力10"] = 1800 + (JY.Wugong[199]["攻击力10"] - 1800)*0.3
			 if JY.Wugong[199]["攻击力10"] > 2000 then
			    JY.Wugong[199]["攻击力10"] = 2000 + (JY.Wugong[199]["攻击力10"] - 2000)*0.2
			 end
		  end
		end
	end
	--傲寒六诀
	if wugong == 217 then
	
	    if WAR.AHZS == 1 then
		   ng = ng + math.ceil(JY.Person[pid]["耍刀技巧"]+600)
		   JY.Wugong[217]["攻击力10"] = math.ceil(JY.Person[pid]["耍刀技巧"]*2+500)
		
		elseif WAR.AHZS == 2 then
		       if tg ~= 1 then
		          if fx < 0 then
		          ng = ng - fx*100
		          end
	           else
	              ng = ng - yin*100
	           end
		       ng = ng + math.ceil(JY.Person[pid]["内力最大值"]*0.1+300)
		       JY.Wugong[217]["攻击力10"] = JY.Person[pid]["内力"]*0.1+JY.Person[pid]["耍刀技巧"]*0.8+200
		   
		elseif WAR.AHZS == 3 then
	           ng = ng + math.ceil(JY.Person[pid]["耍刀技巧"]+JY.Person[pid]["攻击力"]*1.5)
			   if WAR.LQZ[pid] ~= nil then
		       JY.Wugong[217]["攻击力10"] = JY.Person[pid]["耍刀技巧"]+750*(WAR.LQZ[pid]/75)^3 + 200
			   else
			   JY.Wugong[217]["攻击力10"] = JY.Person[pid]["耍刀技巧"]
               end
		   
		elseif WAR.AHZS == 4 then
		       ng = ng + math.ceil(JY.Person[pid]["耍刀技巧"]*0.3+500)
		       JY.Wugong[217]["攻击力10"] = JY.Person[pid]["耍刀技巧"]*2.2

		elseif WAR.AHZS == 5 then
	           ng = ng + math.ceil(JY.Person[pid]["轻功"]*2)
		       JY.Wugong[217]["攻击力10"] = JY.Person[pid]["轻功"]*1.8+JY.Person[pid]["耍刀技巧"]*1.8
           

		elseif WAR.AHZS == 6 then
	           ng = ng + 900 + JY.Person[pid]["耍刀技巧"]
		       JY.Wugong[217]["攻击力10"] = JY.Person[pid]["耍刀技巧"]+600
			    			   
		end
		if JY.Person[681]["天4"] == 1 then
		   JY.Wugong[217]["攻击力10"] = JY.Wugong[217]["攻击力10"]*1.25
		   if WAR.MXD[pid] ~= nil then
		      JY.Wugong[217]["攻击力10"] = JY.Wugong[217]["攻击力10"]*1.25
		   end
		end
		JY.Wugong[217]["攻击力10"] = math.ceil(JY.Wugong[217]["攻击力10"])
	end
	if wugong == 219 then
	   ng = ng + 900 + JY.Person[pid]["耍刀技巧"]
    end
    --罗汉拳，易筋经变身，般若掌，50%几率，敌方必出
    if wugong == 1 and (PersonKF(pid, 108) or match_ID(pid, 134)) then
    	if inteam(pid) == false or JLSD(20, 70, pid) or match_ID(pid, 134) then
     	 	WAR.LHQ_BNZ = 1
    	end
    end
	
    --一指禅，易筋经变身，摩柯指，60%几率，敌方必出
    if wugong == 128 and (PersonKF(pid, 108) or match_ID(pid, 134)) then
	local jl = 70
	if fx > 0 or tg == 1 then
	   jl = jl + yang*3	   
	end	
    	if inteam(pid) == false or JLSD(20, jl, pid) or match_ID(pid, 134) then
     	 	WAR.YZC_MKZ = 1
    	end
    end
      
    --大力金刚掌，易筋经变身，达摩掌，70%几率，敌方必出
    if wugong == 22 and (PersonKF(pid, 108) or match_ID(pid, 134)) then
		if inteam(pid) == false or JLSD(20, 90, pid) or match_ID(pid, 134) then
			WAR.JGZ_DMZ = 1
		end
    end
	
    --伏魔杖法，易筋经变身，八法神禅，70%几率，敌方必出
    if wugong == 86 and (PersonKF(pid, 108) or match_ID(pid, 134)) then
	local jl = 80
	if fx > 0 or tg == 1 then
	   jl = jl + yang*2
	end
    	if inteam(pid) == false or JLSD(20, jl, pid) or match_ID(pid, 134) then
			WAR.FMZ_BFSC = 1
    	end
    end
	
	--五毒神掌，李莫愁用有70%几率变赤练神掌
    if wugong == 3 and match_ID(pid, 161) and JLSD(10, 80, pid) then
		WAR.WD_CLSZ = 1
    end
      
    --铜人阵，9个强力铜人，直接触发达摩掌
    if pid > 480 and pid < 490 then
		WAR.Person[id]["特效文字2"] = "易经筋加力"
		ng = ng + 1200
		WAR.JGZ_DMZ = 1
    end
    
    --[[狄云，神经照，追加气攻
    if match_ID(pid, 37) and wugong == 94 and level == 11 then
		WAR.Person[id]["特效文字3"] = "神照功・无影神拳"
		ng = ng + 1200
    end]]
	   
	
	--雷震，地涌天泉
	if match_ID(pid, 670) then
	   local jl = 101+(JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])*50/JY.Person[pid]["生命最大值"]
	   if JY.Person[pid]["内力"] <= JY.Person[pid]["内力最大值"]*0.5 then
	      jl = jl + 10
	   end
	   if JY.Person[pid]["体力"] <= 70 then
	      jl = jl + 6
	   end
	   if WAR.LQZ[pid] ~= nil then
	      jl = jl + math.modf(WAR.LQZ[pid]*0.4)
	   end
	   if WAR.DZXY == 1 then
	      jl = jl*0.5
	   end
	   if not inteam(pid) then
	   jl = jl + 25
	   end
	   if jl >= math.random(100) then
	      if WAR.DYTQ[pid] == 0 or WAR.DYTQ[pid] == nil then
	         WAR.DYTQ[pid] = 8 + math.modf(JY.Person[pid]["内力最大值"]*0.001)
		  else
		     WAR.DYTQ[pid] = WAR.DYTQ[pid] + 2
		     if WAR.DYTQ[pid] >= 12 + math.modf(JY.Person[pid]["内力最大值"]*0.001) then
		        WAR.DYTQ[pid] = 12 + math.modf(JY.Person[pid]["内力最大值"]*0.001)
		     else
		        WAR.DYTQ[pid] = WAR.DYTQ[pid]
		     end
		  end
		  local a = math.modf((JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"])*0.1)
		  local b = math.modf((JY.Person[pid]["内力最大值"] - JY.Person[pid]["内力"])*0.1)
		  JY.Person[pid]["生命"] = JY.Person[pid]["生命"] + a
		  WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + a
		  JY.Person[pid]["内力"] = JY.Person[pid]["内力"] + b
		  WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + b
		  if WAR.Person[id]["特效文字1"] ~= nil then
			  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."地涌天泉"
		  else
			  WAR.Person[id]["特效文字1"] = "地涌天泉"
		  end
	   end
	end
	
	if match_ID(pid, 675) and JY.Person[675]["品德"] >= 6 and (JY.Wugong[wugong]["武功类型"] == 1 or JY.Wugong[wugong]["武功类型"] == 3) and math.random(100) < 50 then
	      if WAR.Person[id]["特效文字1"] ~= nil then
			  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."无量・极"
		  else
			  WAR.Person[id]["特效文字1"] = "无量・极"
		  end
		  WAR.WLJ = 1
	end
	if wugong == 215 and WAR.LQZ[pid] ~= nil and math.random(100) <= WAR.LQZ[pid] then
	      if WAR.Person[id]["特效文字1"] ~= nil then
			  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."霹雳狂刀"
		  else
			  WAR.Person[id]["特效文字1"] = "霹雳狂刀"
		  end
		  ng = ng + 1300
		  WAR.PLKD = 1
	end
	
	--浊浪排空
	if match_ID(pid, 670) and (math.random(100) < 20 + JY.Person[pid]["指法技巧"]*0.2 or (JY.Person[pid]["指法技巧"]>=80 and WAR.LQZ[pid] == 100)) then
	    ng = ng + 500
		if JY.Person[pid]["指法技巧"] >= 80 then
		    ng = ng + 1000
		end
	    if JY.Person[pid]["指法技巧"] >= 200 then
		    ng = ng + JY.Person[pid]["指法技巧"]*4
		end
        if JY.Person[pid]["指法技巧"] >= 320 then
            ng = ng + JY.Person[pid]["内力最大值"]*0.4
        end
		
		if kfkind == 2 then
		  WAR.ZLPK = 1
		  if JY.Person[pid]["指法技巧"] >= 320 then
		     if WAR.LQZ[pid] == 100 then
		        WAR.ZLPK = 2
			 end
             if WAR.Person[id]["特效文字6"] ~= nil then
                WAR.Person[id]["特效文字6"] = WAR.Person[id]["特效文字6"] .."+".."浊浪排空・指路・北冥爪"	
		     else
                WAR.Person[id]["特效文字6"] = "浊浪排空・指路・北冥爪"
             end				
		  else
		     if WAR.Person[id]["特效文字1"] ~= nil then
                WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."浊浪排空・北冥爪"	
		     else
                WAR.Person[id]["特效文字1"] = "浊浪排空・北冥爪"
             end
		  end
		else
		  if WAR.Person[id]["特效文字1"] ~= nil then
			  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."浊浪排空"
		  else
			  WAR.Person[id]["特效文字1"] = "浊浪排空"
		  end
		end
    end
	
	--无名，隐姓埋名
	if wugong == 199 and WAR.MMZS == 5 and match_ID(pid, 671) then
	   WAR.YXMM[pid] = math.ceil(50 + TrueYJ(pid)*0.04)
	end
	if WAR.YLMB[pid] ~= nil and inteam(pid) then
	   WAR.YLMB[pid] = nil
	end
	if match_ID(pid, 689) and wugong == 227 then
	   WAR.YLMB[pid] = JY.Person[689]["天1"]*2+30
	   if JY.Person[pid]["专1"] == 226 then
		   WAR.YLMB[pid] = JY.Person[689]["天1"]*4+60
	   end
	end
	if match_ID(pid, 689) and wugong == 230 then
	   WAR.LDXJ[pid] = JY.Person[689]["天2"]*10
	end
	if JY.Person[pid]["防具"] == 355 and WAR.QNFJ[pid] == nil then
	--[[local kt = JY.Wugong[wugong]["武功类型"]
	   if kt == 1 then
	      WAR.QNFJ[pid] = 21
	   elseif kt == 2 then
	      WAR.QNFJ[pid] = 41
	   elseif kt == 3 then
	      WAR.QNFJ[pid] = 61
	   elseif kt == 4 then
	      WAR.QNFJ[pid] = 81
       elseif kt == 5 then
	      WAR.QNFJ[pid] = 1
	   end ]]
	   WAR.QNFJ[pid] = math.random(100)   
	end
	
    --小昭，圣火，追加气攻
    if match_ID(pid, 66) and wugong == 93 and level == 11 then
		local zs = {"赤沙流虹降心火","恍起未明净萦魂","业火焚心无量尊"}
		WAR.Person[id]["特效文字3"] = zs[math.random(4)]
		ng = ng + 1500
    end
    
    --苗家剑法，为极，配合胡家刀法。 60%刀剑合壁
    if wugong == 44 and level == 11 and math.random(10) < 7 then
		for i = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. i] == 67 and JY.Person[pid]["武功等级" .. i] == 999 then
				Set_Eff_Text(id, "特效文字1", "胡刀苗剑 归真合一")
				WAR.Person[id]["特效动画"] = 6
				WAR.DJGZ = 1
				ng = ng + 1500
				break
			end
		end
    end
    
    --胡家刀法，为极，配合苗家剑法。 60%刀剑合壁
    if wugong == 67 and level == 11 and math.random(10) < 7 then
		for i = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功" .. i] == 44 and JY.Person[pid]["武功等级" .. i] == 999 then
				Set_Eff_Text(id, "特效文字1", "胡刀苗剑 归真合一")
				WAR.Person[id]["特效动画"] = 6
				WAR.DJGZ = 1
				ng = ng + 1500
				break
			end
		end
    end
	
	--紫气天罗组合，气攻+1000
	if (wugong == 3 or wugong == 9 or wugong == 5 or wugong == 21 or wugong == 118 or wugong == 120 or wugong == 170 or pid==46 or (JY.Person[642]["血量翻倍"] == 1 and match_ID(pid, 46))) and ZiqiTL(pid) then
		ng = ng + 1000
		Set_Eff_Text(id, "特效文字1", "紫气天罗")
	end
	
	--无酒不欢：主运紫霞，50%几率剑系气攻+1000
	if Curr_NG(pid, 89) and kfkind == 3 and JLSD(20, 70, pid) then
		ng = ng + 1000
		Set_Eff_Text(id, "特效文字3", "紫霞剑气")
	end
	
	--破尽天下，增加1000点气攻
	if WAR.PJTX == 1 then
		ng = ng + 1000
	end
	
	--张家辉的隐身戒指
	if JY.Person[pid]["防具"] == 304 then
		local cd = 40
		if JY.Thing[304]["装备等级"] >=5 then
			cd = 20
		elseif JY.Thing[304]["装备等级"] >=3 then
			cd = 30
		end
		WAR.YSJZ = cd
	end
	
	--装备鸳鸯刀，5级开始，夫妻追加500气攻
	if JY.Person[pid]["武器"] == 217 and wugong == 62 and JY.Thing[217]["装备等级"] >=5 then
		ng = ng + 500
	end
	if JY.Person[pid]["武器"] == 218 and wugong == 62 and JY.Thing[218]["装备等级"] >=5 then
		ng = ng + 500
	end
	
	--五岳剑法组合，50%几率额外气攻+1000，暴怒必发动，学有五岳剑诀必发动
	if wugong >= 30 and wugong <= 34 and WuyueJF(pid) and (WAR.LQZ[pid] == 100 or PersonKF(pid, 175)  or JLSD(20, 70, pid))then
		local qg = 1000
		--学会五岳剑诀，气攻再加500，无视绝对气防
		if PersonKF(pid, 175) then
			qg = qg + 500
			WAR.ZWYJF = 1
		end
		ng = ng + qg
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = "气贯五岳・"..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = "气贯五岳"
		end
	end
	
	--琴棋书画：棋盘招式，额外杀气
	if wugong == 72 and QinqiSH(pid) then
		ng = ng + 1500
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = "棋高一着・"..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = "棋高一着"
		end
		--50%几率触发再次追加杀气
		if JLSD(20, 70, pid) then
			ng = ng + 2000
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = "星罗棋布・"..WAR.Person[id]["特效文字1"]
			else
				WAR.Person[id]["特效文字1"] = "星罗棋布"
			end
		end
    end
	
	--冰火毒龙	
	if BinghuoDL(pid) then
		ng = ng + 1000
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = "冰火毒龙・"..WAR.Person[id]["特效文字1"]
		else
			WAR.Person[id]["特效文字1"] = "冰火毒龙"
		end
	end
	
	--沧溟刀法，30%几率，额外杀气，必定流血
	--刀主二次判定
	if wugong == 153 and (JLSD(30, 60, pid) or (pid == 0 and JY.Base["标准"] == 4 and JLSD(30,60,pid))) then
		WAR.CMDF = 1
		ng = ng + 1000
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・颠动沧溟"
		else
			WAR.Person[id]["特效文字1"] = "颠动沧溟"
		end
	end
	
	if wugong == 26 and match_ID(pid, 692) and JY.Person[692]["天4"] == 1 then
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."亢龙有悔"
		else
			WAR.Person[id]["特效文字1"] = "亢龙有悔"
		end
	end
		
	--龙象之力
	if PersonKF(pid, 103) and JLSD(20,80,pid) then
		ng = ng + 1000
		if fx > 0 or tg == 1 then
		ng = ng + 80*yang
		end
		if Curr_NG(pid, 103) then
			local nq = WAR.LQZ[pid] or 0
			local lvl = math.modf(nq/10)
			ng = ng + 100 * lvl
			if nq == 100 then
				WAR.LXZL10 = 1
			end
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."龙象之力"
		else
			WAR.Person[id]["特效文字1"] = "龙象之力"
		end
	end
	
	--lxf
	if match_ID(pid, 678) and JY.Person[678]["天3"] ~= 0 and JY.Wugong[wugong]["武功类型"] == 2 then
	local jl = 25 + JY.Person[pid]["指法技巧"]*0.1
	if math.random(100) < jl then
		ng = ng + 1000
		WAR.LXYZG = 1
		if WAR.Person[id]["特效文字6"] ~= nil then
			WAR.Person[id]["特效文字6"] = WAR.Person[id]["特效文字6"] .. "+" .."灵犀一指"
		else
			WAR.Person[id]["特效文字6"] = "灵犀一指"
		end
	end	
	end
	
	if match_ID(pid, 673) and JY.Person[673]["天1"] == 2 then
	   local jl = 145 + (WAR.LQZ[pid] or 0)
	   if math.random(200) < jl then
	      WAR.QHTR[pid] = 1
	   end
	end

    if WAR.QHTR[pid] == 1 then
           if WAR.Person[id]["特效文字1"] ~= nil then
			  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."气合天人"
		   else
			  WAR.Person[id]["特效文字1"] = "气合天人"
		   end
		WAR.QHTR[pid] = nil
        WAR.QHTRG = 1		
    end	
	
	--雷震，天怒十方
	if JY.Person[pid]["防具"] == 327 and WAR.LQZ[pid] ~= nil and WAR.LQZ[pid] >= 70 and (math.random(100) < 25 + JY.Base["天书数量"]*2 or WAR.LQZ[pid] == 100) and WAR.DZXY ~= 1 then
	   if  WAR.LQZ[pid] == 100 then
	       WAR.TNSF = 2
		   if WAR.Person[id]["特效文字6"] ~= nil then
			  WAR.Person[id]["特效文字6"] = WAR.Person[id]["特效文字6"] .. "+" .."天怒十方"
		   else
			  WAR.Person[id]["特效文字6"] = "天怒十方"
		   end
	   else
	       WAR.TNSF = 1
		   local tx = {"怒气冲天","怒不可遏","怒发冲冠","怒火中烧"}
		   if WAR.Person[id]["特效文字1"] ~= nil then
			  WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" ..tx[math.random(4)]
		   else
			  WAR.Person[id]["特效文字1"] = tx[math.random(4)]
		   end
	   end
	end
	
	
		
	--螺旋九影，追加气攻，逐渐提高
	if Curr_QG(pid,181) and WAR.AXFJ == 0 and WAR.DZXY == 0 then
		ng = ng + (WAR.LXJY[pid] or 1)*300
		WAR.LXJY[pid] = (WAR.LXJY[pid] or 1) + 1
		if WAR.LXJY[pid] == 10 then
			WAR.LXJY[pid] = 1
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."螺旋九影・破"
			else
				WAR.Person[id]["特效文字1"] = "螺旋九影・破"
			end
			WAR.LXJY_P[pid] = 10
			if JY.Person[pid]["专1"] == 181 then
			WAR.LXJY_P[pid] = 20
			end
		end
	end
	
	--王重阳北斗七闪追加气攻1000点
	if match_ID(pid, 129) and WAR.CYZX[pid] ~= nil and WAR.BDQS > 0 then
		ng = ng + 1000
		local BDQS = {"天枢", "天璇", "天玑", "天权", "玉衡", "开阳", "摇光"}
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."北斗七闪・"..BDQS[WAR.BDQS]
		else
			WAR.Person[id]["特效文字2"] = "北斗七闪・"..BDQS[WAR.BDQS]
		end
	end
	
	--萧远山杀破狼加气攻2500点
	if match_ID(pid, 129) and WAR.ZHRM[pid] == nil and WAR.XYS > 0 then
		ng = ng + 5000
		local BDQS = {"贪狼", "破军", "七杀"}
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."杀破狼・"..BDQS[WAR.XYS]
		else
			WAR.Person[id]["特效文字2"] = "杀破狼・"..BDQS[WAR.XYS]
		end
	end
	
	--七伤拳招式
	if wugong == 23 then
	local jl = 30
	if match_ID(pid, 13) or match_ID(pid, 8) or match_ID(pid, 9) then
	   jl = jl - 2
	end
	if WAR.LQZ[pid] == 100 then
	   jl = jl - 2
	end
	if JY.Person[pid]["内力最大值"] >= 9999 then
	      jl = jl - 2
	end
	for i = 1, 4 do
	  if JY.Person[pid]["天赋外功"..i] == 23 then
	      jl = jl - 1
	  end
	end
	if JY.Person[pid]["专2"] == 23 then
	   jl = jl - 4
	end
	if match_ID(pid, 8) and JY.Person[8]["阶"] >= 2 then
       jl = 1
    end
    local n = math.random(jl)
	  if math.random(50) > jl and WAR.LQZ[pid] == 100 then
	        WAR.YZQS = 7
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+七伤总诀"
		else
			WAR.Person[id]["特效文字1"] = "七伤总诀"
		end
	  else
	   if n == 1 or n == 7 or n == 13 then
		WAR.YZQS = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+损心诀"
		else
			WAR.Person[id]["特效文字1"] = "损心诀"
		end
	   elseif n == 2 or n == 8 or n == 14 then
	    WAR.YZQS = 2
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+伤肺诀"
		else
			WAR.Person[id]["特效文字1"] = "伤肺诀"
		end
	   elseif (n == 3 or n == 9 or n == 15) and (JY.Person[pid]["体力"] >= 10 or JY.Person[pid]["内力"] >= 9999) then
	    WAR.YZQS = 3
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+摧肝肠诀"
		else
			WAR.Person[id]["特效文字1"] = "摧肝肠诀"
		end
	   elseif n == 4 or n == 10 or n == 16 then
	   WAR.YZQS = 4
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+藏离诀"
		else
			WAR.Person[id]["特效文字1"] = "藏离诀"
		end
	   elseif n == 5 or n == 11 or n == 17 then
	    WAR.YZQS = 5
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+精失诀"
		else
			WAR.Person[id]["特效文字1"] = "精失诀"
		end
	   elseif n == 6 or n == 12 or n == 18 then
	    WAR.YZQS = 6
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+意恍惚诀"
		else
			WAR.Person[id]["特效文字1"] = "意恍惚诀"
		end
	  
	   end
	   end
	end
    
    --钟灵 使用闪电貂，可偷窃，朱聪妙手空空也可
    if (match_ID(pid, 90) and wugong == 113) or (match_ID(pid, 131) and wugong == 116) or (JY.Person[pid]["动物"] == 350 and math.random(100) < 25 + JY.Thing[350]["装备等级"]*3) then
		WAR.TD = -2
		--蓝烟清：挑战战斗不可偷东西
		if WAR.ZDDH == 226 or WAR.ZDDH == 79 then
			WAR.TD = -1;
		end
    end
	
	--宋远桥使用太极拳或太极剑攻击后自动进入防御状态
	if match_ID(pid, 171) and (wugong == 16 or wugong == 46) then
		WAR.WDRX = 1
	end

	--阿二使用龙爪手攻击后自动进入蓄力状态	
	if match_ID(pid, 644) and wugong == 20 then
		WAR.AER = 1
	end	

    --黄药师，第一次攻击，伤内力500，内力不足500追加伤害
    if ((match_ID(pid, 57) and Curr_NG(pid, 193)) or (WAR.NGJL == 193 and Curr_NG(pid, 193)) or (PersonKF(pid, 193) and WAR.LQZ[pid] == 100)) and (WAR.ACT == 1 or (WAR.ACT == 2 and JY.Person[pid]["专1"] == 193)) then
		if match_ID(pid, 57) then
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					if JY.Person[WAR.Person[j]["人物编号"]]["内力"] > 500 then
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] - 500
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - 500;
					else
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - JY.Person[WAR.Person[j]["人物编号"]]["内力"];
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = 0
					--无酒不欢：记录人物血量
					WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 400
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 400
					end
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				WAR.LSQ[WAR.Person[j]["人物编号"]] = 10
						--沉睡状态的敌人会醒来
				if WAR.CSZT[WAR.Person[j]["人物编号"]] ~= nil then
					WAR.CSZT[WAR.Person[j]["人物编号"]] = nil
				end
				end
			end
		else
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					if JY.Person[WAR.Person[j]["人物编号"]]["内力"] > 250 then
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] - 250
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - 250;
					else
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - JY.Person[WAR.Person[j]["人物编号"]]["内力"];
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = 0
					--无酒不欢：记录人物血量
					WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 200
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 200
					end
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				WAR.LSQ[WAR.Person[j]["人物编号"]] = 10
						--沉睡状态的敌人会醒来
				if WAR.CSZT[WAR.Person[j]["人物编号"]] ~= nil then
					WAR.CSZT[WAR.Person[j]["人物编号"]] = nil
				end
				end
			end
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."魔音・碧海潮生曲"
		else
			WAR.Person[id]["特效文字1"] = "魔音・碧海潮生曲"
		end
		WAR.Person[id]["特效动画"] = 39
	elseif wugong == 38 and TaohuaJJ(pid) and JLSD(20,60,pid) and WAR.ACT == 1 then
	        for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					if JY.Person[WAR.Person[j]["人物编号"]]["内力"] > 250 then
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] - 250
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - 250;
					else
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - JY.Person[WAR.Person[j]["人物编号"]]["内力"];
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = 0
					--无酒不欢：记录人物血量
					WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 200
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 200
					end
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				WAR.LSQ[WAR.Person[j]["人物编号"]] = 10
						--沉睡状态的敌人会醒来
				if WAR.CSZT[WAR.Person[j]["人物编号"]] ~= nil then
					WAR.CSZT[WAR.Person[j]["人物编号"]] = nil
				end
				end
			end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."魔音・碧海潮生曲"
		else
			WAR.Person[id]["特效文字1"] = "魔音・碧海潮生曲"
		end
		WAR.Person[id]["特效动画"] = 39
    end
	
	--剑发琴音
	if match_ID(pid, 20) and JY.Wugong[wugong]["武功类型"] == 3 then
    local jl = 30
    if WAR.LQZ[pid] == 100 then
       jl = jl + 30
    end
    jl = jl + math.modf(JY.Person[pid]["御剑能力"]*0.07)
     
    if math.random(100) < jl then
        for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then	
				WAR.LSQ[WAR.Person[j]["人物编号"]] = 10
			end	
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."剑发琴音"
		else
			WAR.Person[id]["特效文字1"] = "剑发琴音"
		end
    end
    end	
	
	--何铁手五毒随机2-5倍威力
	if match_ID(pid, 83) and wugong == 3 then
		WAR.HTS = math.random(2, 5)
    end

	--林月如乾坤一掷
	if match_ID(pid, 657) and wugong==195 and instruct_31(5000) == true and WAR.ACT == 1 then
		WAR.QKYZ = 1
		instruct_32(174,-5000)
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."乾坤一掷"
		else
			WAR.Person[id]["特效文字1"] = "乾坤一掷"
		end
	end		
	
	--玉真子战斗中铁血十二式随机1-12倍威力
	if match_ID(pid, 184) and wugong == 161 then
		if inteam(pid) == false then
		WAR.HTS = math.random(6, 12)
		else
		WAR.HTS = math.random(1, 12)
    end
	end
	
	--玉真子战斗中铁血十二式随机1-12倍威力
	if match_ID(pid, 629) and wugong == 161 then
		WAR.HTS = math.random(4, 8)
    end
	
    --欧阳锋 无误伤
    if match_ID(pid, 60) then
		WAR.WS = 1
    end
	
	if match_ID(pid, 689) or match_ID(pid, 690) then
		WAR.WS = 1
    end
    
    --东方不败 无误伤
    if match_ID(pid, 27) then
		WAR.WS = 1
    end
	
	--扫地 无误伤
    if match_ID(pid, 114) then
		WAR.WS = 1
    end
	
	--阿青，越女无误伤
	if match_ID(pid, 604) and wugong == 156 then
		WAR.WS = 1
	end
	
	--剑仙剑魔战，独孤无误伤
	if match_ID(pid, 592) and WAR.ZDDH == 291 then
		WAR.WS = 1
	end
    
    --乔峰，郭靖，洪七公，使用降龙十八掌 无误伤
    if (match_ID(pid, 50) or match_ID(pid, 55) or match_ID(pid, 69) or pid==612) and wugong == 26 then
		WAR.WS = 1
    end
	
	--无名无误伤
	if match_ID(pid, 671) then
	   WAR.WS = 1
	end
	
    --萧中慧使用夫妻刀法 无误伤
    if match_ID(pid, 77) and wugong == 62 then
		WAR.WS = 1
    end
    
    --令狐冲 二觉之后，使用独孤九剑 无误伤
    if match_ID_awakened(pid, 35, 2) and wugong == 47 then
		WAR.WS = 1
    end
	
	--玉女素心剑 无误伤
	if wugong == 139 then
		WAR.WS = 1
	end
    
    --金轮法王 气攻+2500
    if match_ID(pid, 62) then
		ng = ng + 2500
    end
	
	if match_ID(pid, 636) and JY.Person[636]["天4"] == 2 then
		ng = ng + 3500
    end
	
	if JY.Person[pid]["人2"] == 1 then
	   ng = ng + 200
	end
	
	if WAR.QHTRG == 1 then
	   ng = ng + 1500 + JY.Person[pid]["拳掌功夫"]*2
	end
    
    --霍都 气攻+1000
    if match_ID(pid, 84) then
		ng = ng + 1000
    end
	
	  --霍都 气攻+1000
    if JY.Base["特殊"] ==1 and JY.Person[35]["血量翻倍"]==1 and pid==0 then
		ng = ng + 1250
    end
    
    --花铁干，使用中平枪法，气攻+1500
    if match_ID(pid, 52) and wugong == 70 then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."中平神枪"
		else
			WAR.Person[id]["特效文字3"] = "中平神枪"
		end
		ng = ng + 1500
    end
    
    --霍青桐，使用三分剑法，伤体力
    if match_ID(pid, 74) and wugong == 29 then
		WAR.HQT = 1
    end
    
    --程英，使用玉箫剑法，杀内力300
    if match_ID(pid, 63) and wugong == 38 then
		WAR.CY = 1
    end
	
	
	--无名，圣灵剑法
	if match_ID(pid, 671) and JY.Wugong[wugong]["武功类型"] == 3 then
	   local zs = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十", "廿一", "廿二", "廿三"}
       local i = math.random(math.ceil(JY.Person[pid]["御剑能力"]/27))
	   if JY.Person[pid]["御剑能力"] > 108 and math.ceil((JY.Person[pid]["御剑能力"]-108)/27) > i then
	      i = math.random(math.floor((JY.Person[pid]["御剑能力"]-108)/27),math.ceil(JY.Person[pid]["御剑能力"]/27))
	   end
	   if WAR.LQZ[pid] == 100 then
	      i = i + 1
	   end
	   if i >= 23 then
		  if math.random(110) >= 85 then
		     i = 23
		  else
		     if WAR.LQZ[pid] == 100 and math.random(3) ~= 1 then
			    i = 23
		     else
			    i = 22
		     end
	      end
	   end
	   --npc
	   if not inteam(pid) then 
	      if i < 22 then
	         i = 22
		  end
		  if WAR.LQZ[pid] == 100 then
		     i = 23
		  end
	   end

       if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・" .."剑"..zs[i]
	   else
			WAR.Person[id]["特效文字1"] = "剑"..zs[i]
	   end
       ng = ng + 130*i
	   if i > 10 then
	     WAR.SLJF = i
	   end
	   
	   if i == 23 then
	      for j = 0, WAR.PersonNum - 1 do
		    if WAR.Person[j]["死亡"] == false and j ~= WAR.CurID then
				WAR.JESS[WAR.Person[j]["人物编号"]] = 10 + math.modf(JY.Person[pid]["御剑能力"]*0.01)
				WAR.Person[j]["特效文字1"] = "定身"
			end
		  end
	   end
    end
	
	if wugong ==  232 or wugong == 238 then
	    for j = 0, WAR.PersonNum - 1 do
		    if WAR.Person[j]["死亡"] == false and j ~= WAR.CurID then
				WAR.JESS[WAR.Person[j]["人物编号"]] = 1
			end
		end
	end
	
	--步惊云，圣灵剑法
	if match_ID(pid, 682) and JY.Wugong[wugong]["武功类型"] == 3 then
	   local zs = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十", "廿一", "廿二", "廿三"}
       local i = math.random(10 + JY.Base["天书数量"])
	   if WAR.LQZ[pid] == 100 then
	      i = i + 2
	   end
	   if i >= 22 then
		  i = 22
	   end
	   if i > 10 then
	      WAR.SLJFB = i
	   end	  
	   
	   if WAR.LQZ[pid] == 100 and JY.Base["天书数量"] >= 12 then
	      i = i + 3
		  if i >= 23 then
		     i = 23
			 for j = 0, WAR.PersonNum - 1 do
		     if WAR.Person[j]["死亡"] == false and j ~= WAR.CurID then
				WAR.JESS[WAR.Person[j]["人物编号"]] = 9
				WAR.Person[j]["特效文字1"] = "定身"
			 end
		  end 
		  end	  
	   end
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・" .."剑"..zs[i]
	   else
			WAR.Person[id]["特效文字1"] = "剑"..zs[i]
	   end
	   ng = ng + 100*i
    end
	--虚云劲
	if match_ID(pid, 682) and JY.Wugong[wugong]["武功类型"] == 1 then
	   local jl = 25
	   if WAR.LQZ[pid] == 100 then
	      jl = jl + 50
	   end
	   jl = jl + JY.Base["天书数量"]*2  
	   if math.random(100) < jl then
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・虚云劲"
	   else
			WAR.Person[id]["特效文字1"] = "虚云劲"
	   end
	   ng = ng + 1000
	   WAR.XYJ = 1
	   end
    end
	
	if match_ID(pid, 693) and wugong == 245 then
	     for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 300
			end
		 end
	end
	
	if match_ID(pid, 693) and wugong == 251 and JY.Person[693]["天3"] == 2 then
	     for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 500
			end
		 end
	end
	

    --杨过 攻击，非吼 全体集气减100
    if match_ID(pid, 58) and WAR.XK ~= 2 then
	local sq = 100
	if JY.Person[58]["阶"] >= 2 then
	   sq = 200
	end
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - sq
			end
		end
		if WAR.Person[id]["特效动画"] == nil then
			WAR.Person[id]["特效动画"] = 89
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."西狂之怒啸"
		else
			WAR.Person[id]["特效文字1"] = "西狂之怒啸"
		end
    end
	
	if match_ID(pid, 614) and WAR.XK ~= 2 then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
			end
		end
		if WAR.Person[id]["特效动画"] == nil then
			WAR.Person[id]["特效动画"] = 89
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."西狂之怒啸"
		else
			WAR.Person[id]["特效文字1"] = "西狂之怒啸"
		end
    end
	
	if match_ID(pid, 681) and JY.Person[681]["品德"] >= 6 then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
			end
		end
		if WAR.Person[id]["特效动画"] == nil then
			WAR.Person[id]["特效动画"] = 89
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."神风怒嚎"
		else
			WAR.Person[id]["特效文字1"] = "神风怒嚎"
		end
    end

	--无酒不欢 乘风破浪
	 if JY.Base["特殊"] ==1 and JY.Person[36]["血量翻倍"]==1 and pid==0 then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 50
			end
		end
		if WAR.Person[id]["特效动画"] == nil then
			WAR.Person[id]["特效动画"] = 89
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."乘风破浪"
		else
			WAR.Person[id]["特效文字1"] = "乘风破浪"
		end
    end
	
    --天霄狂浪，全体集气减100
    if (Curr_NG(pid, 177) or PersonKF(pid, 172)) and WAR.LQZ[pid] == 100 then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
			end
		end
    end
      
    --杨过吼
    if WAR.XK == 2 and match_ID(pid, 58) and WAR.Person[WAR.CurID]["我方"] == WAR.XK2 then
		for e = 0, WAR.PersonNum - 1 do
			if WAR.Person[e]["死亡"] == false and WAR.Person[e]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[e].TimeAdd = WAR.Person[e].TimeAdd - math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 5)
				if WAR.Person[e].Time < -450 then
					WAR.Person[e].Time = -450
				end
				JY.Person[WAR.Person[e]["人物编号"]]["内力"] = JY.Person[WAR.Person[e]["人物编号"]]["内力"] - math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 5)
				if JY.Person[WAR.Person[e]["人物编号"]]["内力"] < 0 then
					JY.Person[WAR.Person[e]["人物编号"]]["内力"] = 0
				end
				JY.Person[WAR.Person[e]["人物编号"]]["生命"] = JY.Person[WAR.Person[e]["人物编号"]]["生命"] - math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 25)
			end
			if JY.Person[WAR.Person[e]["人物编号"]]["生命"] < 0 then
				JY.Person[WAR.Person[e]["人物编号"]]["生命"] = 0
			end
		end
			
		--吼过之后，内力为0，内力最大值-1000，并且用声望控制上限
		if inteam(pid) then
			JY.Person[pid]["内力"] = 0
			JY.Person[pid]["内力最大值"] = JY.Person[pid]["内力最大值"] - 1000
			JY.Person[300]["声望"] = JY.Person[300]["声望"] + 1
		else
			AddPersonAttrib(pid, "内力", -1000)  --做敌方内力只减1000
		end
		  
		if JY.Person[pid]["内力最大值"] < 500 then
			JY.Person[pid]["内力最大值"] = 500
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."西狂之震怒・雷霆狂啸"
		else
			WAR.Person[id]["特效文字1"] = "西狂之震怒・雷霆狂啸"
		end
		WAR.Person[id]["特效动画"] = 6
		WAR.XK = 3
	end 
	
	if WAR.XK == 2 and match_ID(pid, 614) then
		for e = 0, WAR.PersonNum - 1 do
			if WAR.Person[e]["死亡"] == false and WAR.Person[e]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[e].TimeAdd = WAR.Person[e].TimeAdd - math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 5)
				if WAR.Person[e].Time < -450 then
					WAR.Person[e].Time = -450
				end
				JY.Person[WAR.Person[e]["人物编号"]]["内力"] = JY.Person[WAR.Person[e]["人物编号"]]["内力"] - math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 5)
				if JY.Person[WAR.Person[e]["人物编号"]]["内力"] < 0 then
					JY.Person[WAR.Person[e]["人物编号"]]["内力"] = 0
				end
				JY.Person[WAR.Person[e]["人物编号"]]["生命"] = JY.Person[WAR.Person[e]["人物编号"]]["生命"] - math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 25)
			end
			if JY.Person[WAR.Person[e]["人物编号"]]["生命"] < 0 then
				JY.Person[WAR.Person[e]["人物编号"]]["生命"] = 0
			end
		end
			
		--吼过之后，内力为0，内力最大值-1000，并且用声望控制上限
		if inteam(pid) then
			JY.Person[pid]["内力"] = 0
			JY.Person[pid]["内力最大值"] = JY.Person[pid]["内力最大值"] - 1000
			JY.Person[300]["声望"] = JY.Person[300]["声望"] + 1
		else
			AddPersonAttrib(pid, "内力", -1000)  --做敌方内力只减1000
		end
		  
		if JY.Person[pid]["内力最大值"] < 500 then
			JY.Person[pid]["内力最大值"] = 500
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."西狂之震怒・雷霆狂啸"
		else
			WAR.Person[id]["特效文字1"] = "西狂之震怒・雷霆狂啸"
		end
		WAR.Person[id]["特效动画"] = 6
		WAR.XK = 3
	end
	
    
    --任盈盈，使用持瑶琴，无形剑气
    if match_ID(pid, 73) and wugong == 73 then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."七弦无形剑气"
		else
			WAR.Person[id]["特效文字3"] = "七弦无形剑气"
		end
		WAR.Person[id]["特效动画"] = 89
		local dam = 100
		if JY.Person[73]["阶"] >= 1 then
		   dam = 200
		   if JY.Person[73]["阶"] >= 2 then
		   dam = dam + 150
		   end
		   if JY.Person[73]["阶"] >= 2 then
		   dam = dam + 200
		   end
		end
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				--无酒不欢：记录人物血量
				WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - dam
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - dam
				--沉睡状态的敌人会醒来
				if WAR.CSZT[WAR.Person[j]["人物编号"]] ~= nil then
					WAR.CSZT[WAR.Person[j]["人物编号"]] = nil
				end
			end
		end
	end
	if JY.Person[pid]["人30"] == 1 then
	   WAR.Person[WAR.CurID]["特效动画"] = 163
	   for i = 0, WAR.PersonNum - 1 do
	    if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false then
		WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
		WAR.Person[i]["中毒点数"] = (WAR.Person[i]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "中毒程度", math.random(25,50))
		JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] = JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] + math.random(25,45)
	    WAR.BFXS[WAR.Person[i]["人物编号"]] = 1
			if 100 < JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] then
				JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] = 100
			end
		JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] = JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] + math.random(17,25)
	    WAR.ZSXS[WAR.Person[i]["人物编号"]] = 1
			if 50 < JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] then
				JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] = 50
			end	
		WAR.Person[i]["内伤点数"] = (WAR.Person[i]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "受伤程度", math.random(25,45))
		end
	   end
	end
	if match_ID(pid, 637) and math.random(100) < 23 + JY.Person[638]["声望"]*3 then
	   for i = 0, WAR.PersonNum - 1 do
	    if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false then
		WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
		JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] = JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] + math.random(20,38)
	    WAR.BFXS[WAR.Person[i]["人物编号"]] = 1
			if 100 < JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] then
				JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] = 100
			end	
		WAR.Person[i]["内伤点数"] = (WAR.Person[i]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "受伤程度", math.random(5,10))
		end
	   end
	end
	if JY.Person[638]["声望"] >= 3 and match_ID(pid, 638) and math.random(100) < 31 + JY.Person[638]["声望"]*3 then
	   for i = 0, WAR.PersonNum - 1 do
	    if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false then
		WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
		JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] = JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] + math.random(17,25)
	    WAR.ZSXS[WAR.Person[i]["人物编号"]] = 1
			if 50 < JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] then
				JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"] = 50
			end	
		WAR.Person[i]["内伤点数"] = (WAR.Person[i]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "受伤程度", math.random(9,12))
		end
	   end
	end
	
	--搜魂
    if Curr_NG(pid, 237) and JLSD(20,80,pid) then
		WAR.Person[id]["特效文字1"] = "天绝地灭大搜魂手"
		WAR.Person[id]["特效动画"] = 148
		local dam = 200
		local damb = 5
		if JY.Person[pid]["专2"] == 237 then
		   dam = 450
		   damb = 10
		end
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				--无酒不欢：记录人物血量
				WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - dam
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - dam
				JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] - dam
				WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - dam
				JY.Person[WAR.Person[j]["人物编号"]]["体力"] = JY.Person[WAR.Person[j]["人物编号"]]["体力"] - damb
				WAR.Person[j]["体力点数"] = (WAR.Person[j]["体力点数"] or 0) - damb
			end
		end
	end
	
	--一指
	if match_ID(pid, 138) and JY.Wugong[wugong]["武功类型"] == 2 then
	local jl = 25
	if WAR.LQZ[pid] == 100 then
	   jl = jl + 25
	end
    jl = jl + math.modf(JY.Person[pid]["指法技巧"]*0.1)
    if math.random(100) < jl then
	    if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."一指镇江南"
		else
			WAR.Person[id]["特效文字1"] = "一指镇江南"
		end
	    WAR.Person[id]["特效动画"] = 89
       	for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				if WAR.LRHF[WAR.Person[j]["人物编号"]] ~= nil then
				   WAR.LRHF[WAR.Person[j]["人物编号"]] = math.max(WAR.LRHF[WAR.Person[j]["人物编号"]], 10) + 2
				else
					WAR.LRHF[WAR.Person[j]["人物编号"]] = 10
				end
			end
		end
	end
	end
	
	--剑胆琴心 持瑶琴回血5%，减少10内伤
	if wugong == 73 and JiandanQX(pid) then
		Set_Eff_Text(id, "特效文字3", "清心普善咒")
		WAR.Person[id]["特效动画"] = 89	
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", JY.Person[pid]["生命"]*0.05)
		WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", -10)
	end
	
	--七夕任盈盈加强版效果
    if match_ID(pid, 611) and wugong == 73 then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."魔音搜魂"
		else
			WAR.Person[id]["特效文字3"] = "魔音搜魂"
		end
		WAR.Person[id]["特效动画"] = 89
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 400
			end
		end
	end
	
    --张三丰 万法自然，集气从500开始
    if match_ID(pid, 5) and math.random(10) < 8 then
		WAR.ZSF = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."万法自然"
		else
			WAR.Person[id]["特效文字1"] ="万法自然"
		end
    end
	
    --虚竹  福泽加护，集气从200开始
    if match_ID(pid, 49) and math.random(10) < 6 then
		WAR.XZZ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."福泽加护"
		else
			WAR.Person[id]["特效文字1"] = "福泽加护"
		end
    end
	
	--少冲剑
    if match_ID(pid, 687) and wugong == 49 and WAR.LMZS == 1 then
		WAR.XZZ = 1
    end
	
	if wugong == 225 then
		WAR.PG = 1
    end
	
	--封不平狂风快剑，使用剑法回气
    if match_ID(pid, 142) and kfkind == 3 then
		WAR.KFKJ = 1
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .."+".."狂风快剑"
		else
			WAR.Person[id]["特效文字3"] = "狂风快剑"
		end
    end
	
	if pid == 0 and JY.Base["标准"] == 3 and JY.Person[0]["阶"] >= 3 and kfkind == 3 then
		WAR.JZSJ = 1
	end
	
	if match_ID(pid, 683) and kfkind == 3 and JY.Person[683]["天2"] == 1 then
		WAR.XMKFJ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."狂风剑"
		else
			WAR.Person[id]["特效文字1"] = "狂风剑"
		end
    end
	if match_ID(pid, 683) and kfkind == 3 and JY.Person[683]["天2"] == 2 then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."无情剑"
		else
			WAR.Person[id]["特效文字1"] = "无情剑"
		end
    end
	--一阳指
	if match_ID(pid, 687) and wugong == 17 then
	local str
	local level = {"五品","四品","三品","二品","一品"}
	if JY.Person[687]["声望"] == 1000 and JY.Person[687]["天2"] == 1 then
	   str = level[5]
	elseif JY.Person[687]["声望"] == 1000 then
	   str = level[4]
	elseif JY.Person[687]["声望"] > 500 then
	   str = level[3]
	elseif JY.Person[687]["声望"] > 200 then
	   str = level[2]
	else
       str = level[1]
	end
	
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."・"..str.."一阳指"
		else
			WAR.Person[id]["特效文字1"] = str.."一阳指"
		end
    end
	
	--九剑真传，荡剑式，攻击后回气+200
	if WAR.JJZC == 4 and pid == 0 then
		WAR.JJDJ = 1
	end
    
    --东方不败  葵花点穴手，气攻+1000
	--葵尊必出点穴手
    if (match_ID(pid, 27) and math.random(10) < 7) or (WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and pid == 27) then
		ng = ng + 1000
		WAR.BFX = 1
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."葵花点穴手"
		else
			WAR.Person[id]["特效文字3"] = "葵花点穴手"
		end
    end
    
	
    --程灵素 攻击全屏中毒+20
	--扣除当前血量7%
    if match_ID(pid, 2) then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				local loss = math.modf(JY.Person[WAR.Person[j]["人物编号"]]["生命"]*0.07)
				--无酒不欢：记录人物血量
				WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - loss
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - loss
				WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "中毒程度", 20)
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				--沉睡状态的敌人会醒来
				if WAR.CSZT[WAR.Person[j]["人物编号"]] ~= nil then
					WAR.CSZT[WAR.Person[j]["人物编号"]] = nil
				end
			end
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."七心海棠"
		else
			WAR.Person[id]["特效文字1"] = "七心海棠"
		end
		WAR.Person[id]["特效动画"] = 64
    end
	
	--扣除血量3%
    if match_ID(pid, 671) and JY.Wugong[wugong]["武功类型"] == 3 and math.random(100) < 20 or wugong == 199 then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				local loss = math.modf(JY.Person[pid]["内力"]*0.02)
				--无酒不欢：记录人物血量
				WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - loss
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - loss
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				--沉睡状态的敌人会醒来
				if WAR.CSZT[WAR.Person[j]["人物编号"]] ~= nil then
					WAR.CSZT[WAR.Person[j]["人物编号"]] = nil
				end
			end
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."无天绝剑"
		else
			WAR.Person[id]["特效文字1"] = "无天绝剑"
		end
		WAR.Person[id]["特效动画"] = 83
    end
      
    --鸠摩智  使用火焰刀法，加内伤30，加杀集气1000
    --普通角色使用有30%的机率
	--刀主二次判定
    if wugong == 66 and level == 11 and (match_ID(pid, 103) or JLSD(30,60,pid) or (pid == 0 and JY.Base["标准"] == 4 and JLSD(30,60,pid)))  then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "受伤程度", 30)
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."大轮密宗・火焰刀"
		else
			WAR.Person[id]["特效文字1"] = "大轮密宗・火焰刀"
		end
		WAR.Person[id]["特效动画"] = 58
		ng = ng + 1000
    end
	
	--田伯光
	if JY.Person[29]["阶"] >= 2 and match_ID(pid, 29) and wugong == 55 then
	   if WAR.KFDF[pid] == nil then
	      WAR.KFDF[pid] = 1
	   else
	      WAR.KFDF[pid] = WAR.KFDF[pid] + 1
	   end
	end

	--血河神鉴	
    if PersonKF(pid, 163) and JLSD(30,60,pid) then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "受伤程度", 10)
			WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			WAR.LXXS[WAR.Person[j]["人物编号"]] = 1
			if WAR.LXZT[WAR.Person[j]["人物编号"]] == nil then
				WAR.LXZT[WAR.Person[j]["人物编号"]] = 20
			else
				WAR.LXZT[WAR.Person[j]["人物编号"]] = WAR.LXZT[WAR.Person[j]["人物编号"]] + 20
			end
			if WAR.LXZT[WAR.Person[j]["人物编号"]] > 100 then
				WAR.LXZT[WAR.Person[j]["人物编号"]] = 100
			end
			end
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."血海无涯苦作粥"
		else
			WAR.Person[id]["特效文字1"] = "血海无涯苦作粥"
		end
		WAR.Person[id]["特效动画"] = 64
    end	

	--罗汉伏魔加力文字特效
	--同时学有易筋神功+罗汉伏魔功，主运易筋神功必出“罗汉伏魔”特效
	--石破天必出罗汉伏魔
	if WAR.NGJL == 96 or (Curr_NG(pid, 108) and PersonKF(pid, 96)) or (match_ID(pid,38) and PersonKF(pid,96)) then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+罗汉伏魔";
		else
			WAR.Person[id]["特效文字1"] = "罗汉伏魔"
		end
	end
    
    --太极拳，借力打力
    if wugong == 16 then
		if WAR.tmp[3000 + pid] == nil then
			WAR.tmp[3000 + pid] = 0
		elseif 0 < WAR.tmp[3000 + pid] then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."・借力打力"
			else
				WAR.Person[id]["特效文字3"] = "借力打力"
			end
			ng = ng + WAR.tmp[3000 + pid]
		end
    end
	
	    --太极剑，借力打力
    if wugong == 46 then
		if WAR.tmp[3000 + pid] == nil then
			WAR.tmp[3000 + pid] = 0
		elseif 0 < WAR.tmp[3000 + pid] then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."・借力打力"
			else
				WAR.Person[id]["特效文字3"] = "借力打力"
			end
			ng = ng + math.modf(WAR.tmp[3000 + pid]/2)
		end
    end
	
	--天山折梅手，杀气提高
	if wugong == 14 then
		local exng = 0
		local CN_num = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一","十二","十三","十四"}
		for i = 1, JY.Person[671]["品德"] do
			if JY.Person[pid]["武功"..i] ~= 14 and JY.Person[pid]["武功等级"..i] == 999 then
				ng = ng + 100
				exng = exng + 1
			end
		end
		if exng > 14 then
		   exng = 14
		end
		if exng > 0 then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+天山折梅"..CN_num[exng]
			else
				WAR.Person[id]["特效文字3"] = "天山折梅"..CN_num[exng]
			end
		end
	end
	
	--无量神掌
	if match_ID(pid, 675) and (JY.Wugong[wugong]["武功类型"] == 3 or JY.Wugong[wugong]["武功类型"] == 1) and JY.Person[675]["品德"] >=1 then
		local exng = JY.Person[675]["品德"]
		local CN_num = {"五", "六", "七", "八", "九", "极"}
		ng = ng + 200*(JY.Person[675]["品德"]+4)
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+无量・"..CN_num[exng]
			else
				WAR.Person[id]["特效文字3"] = "无量・"..CN_num[exng]
			end
	end
	
	--豪鬼
	if wugong == 202 or wugong == 203 then
	    if wugong == 202 then
		   ng = ng + 800
		end
        if wugong == 203 then
           ng = ng + 1200
        end
        		
		if match_ID(pid, 673) then
			for i = 1, JY.Person[671]["品德"] do
				if JY.Person[pid]["武功"..i] ~= 202 and JY.Person[pid]["武功"..i] ~= 203 and JY.Wugong[JY.Person[pid]["武功"..i]]["武功类型"] == 1 then
					ng = ng+200
				end
			end
		end
	end
	
	--七伤拳
	if wugong == 23 then
	  if inteam(pid) then
	  local add = math.modf(JY.Person[pid]["内力最大值"]/17)
	    if add >= 490 then
		   add = 490
		end
	    if JY.Person[pid]["内力最大值"] >= 9999 then
	       add = add + 177
	    end
	  ng = ng + add
	  else
	    ng = ng + 490
	  end
	end
    
    --虚竹使用天山六阳掌或折梅手，出生死符，杀集气+1700
    if (wugong == 8 or wugong == 14) and match_ID(pid, 49) and PersonKF(pid, 101) and (JLSD(20, 80, pid) or WAR.NGJL == 98) then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+灵鹫宫绝学・生死符"
		else
			WAR.Person[id]["特效文字3"] = "灵鹫宫绝学・生死符"
		end
		ng = ng + 1700
		WAR.TZ_XZ = 1
    end
    
    --李文秀使用特系攻击，60%的机率大幅度杀集气
    if match_ID(pid, 590) and kfkind == 5 and JLSD(0, 50 + JY.Base["天书数量"]*2 + math.modf(JY.Person[pid]["实战"]/25), pid) then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+".."心秀天铃・星月争辉"
		else
			WAR.Person[id]["特效文字3"] = "心秀天铃・星月争辉"
		end
    	ng = ng + 1200
		--如有14天书，则忽视绝对气防
		if JY.Base["天书数量"] >= 14 then
			WAR.LWX = 1
		end
    end
	
	--王语嫣御法绝尘
	local YufaJC = 0
	for i = 0, WAR.PersonNum - 1 do
		local yfid = WAR.Person[i]["人物编号"]
		if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] and match_ID(yfid, 76) and Xishu_sum(yfid) >= 500 and inteam(pid) == false then
			YufaJC = 1
			break
		end
	end
	
	--武功招式加杀集气
	if YufaJC == 0 then
		--风清扬，暴怒九剑触发无招胜有招
		if match_ID(pid, 140) and wugong == 47 and WAR.LQZ[pid] == 100 then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."・".."无招胜有招"
			else
				WAR.Person[id]["特效文字3"] = "无招胜有招"
			end
			ng = ng + 2000
			WAR.FQY = 1
		--看有没有招式
		elseif CC.KFMove[wugong] ~= nil then
			--npc必出招，小无相功加力必出招式，暴怒必出招式，辟邪必出招，太玄必出招
			if inteam(pid) == false or myrandom(level, pid) or WAR.NGJL == 98 or WAR.LQZ[pid] == 100 or (wugong == 48 and level == 11 and WAR.DZXY == 0 and WAR.AXFJ == 0) or (wugong == 29 and level == 11 and WAR.DZXY == 0 and WAR.AXFJ == 0)
			or (wugong == 102 and WAR.DZXY == 0 and WAR.AXFJ == 0) or (wugong == 217 and WAR.DZXY == 0 and WAR.AXFJ == 0) or wugong == 212 then
				local num
				if wugong == 48 and inteam(pid) and WAR.DZXY ~= 1 and WAR.AXFJ ~= 1 and WAR.AutoFight == 0 then		--辟邪招式固定
					num = WAR.BXZS
				elseif wugong >= 242 and wugong <= 252 and WAR.DZXY ~= 1 and WAR.AXFJ ~= 1 then
					num = 1	
				elseif wugong == 217 and inteam(pid) and WAR.DZXY ~= 1 and WAR.AXFJ ~= 1 and WAR.AutoFight == 0 then		--辟邪招式固定
					num = WAR.AHZS	
				elseif wugong == 29 and inteam(pid) and WAR.DZXY ~= 1 and WAR.AXFJ ~= 1 and WAR.AutoFight == 0 then
					num = WAR.SFZS
				elseif wugong == 221 and inteam(pid) and WAR.DZXY ~= 1 and WAR.AXFJ ~= 1 and WAR.AutoFight == 0 then
					num = WAR.YSZZS
				elseif wugong == 222 and inteam(pid) and WAR.DZXY ~= 1 and WAR.AXFJ ~= 1 and WAR.AutoFight == 0 then
					num = WAR.YSJZS	
				elseif wugong == 102 and inteam(pid) and (match_ID_awakened(pid,38,1) or JY.Person[pid]["专2"] == 102) and WAR.DZXY ~= 1 and WAR.AXFJ ~= 1 and WAR.AutoFight == 0 then	--太玄招式固定
					num = WAR.TXZS	
				elseif wugong == 199 and WAR.DZXY ~= 1 and WAR.AXFJ ~= 1 then	--莫名剑法招式固定
					if WAR.AutoFight ~= 0 then
					   if math.random(2) == 1 then
					      num = 2
					   else
					      num = 7
					   end
					else
					   num = WAR.MMZS
					end
					
				else
					local choice = math.random(#CC.KFMove[wugong])											--从数组从随机抽取一个
					num = choice
					if wugong == 102 and WAR.TXZS == 0 then
						WAR.TXZS = choice
					end
					if wugong == 212 and match_ID(pid, 675)then
					   num = math.random(JY.Person[675]["品德"],4+JY.Person[675]["品德"])
					end   
				end
				if match_ID(pid, 692) and JY.Person[692]["天4"] == 1 then
				else
				if WAR.Person[id]["特效文字3"] ~= nil then
					WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."・"..CC.KFMove[wugong][num][1]
				else
				    WAR.Person[id]["特效文字3"] = CC.KFMove[wugong][num][1]
				    if CC.KFMove[wugong] == nil then
					WAR.Person[id]["特效文字3"] = " "
					end
				end
				end
				if CC.KFMove[wugong] ~= nil and CC.KFMove[wugong][num] ~= nil then
				   ng = ng + CC.KFMove[wugong][num][2]
				end
			end
		end
	end
	
	--张三丰，40%机率增加1000气攻
    if match_ID(pid, 5) and WAR.Person[id]["特效文字3"] ~= nil and JLSD(30, 70, pid) then
		WAR.Person[id]["特效文字3"] = "化朽为奇" .. "・" .. WAR.Person[id]["特效文字3"]
		ng = ng + 1000
    end
	
	--王重阳，全真剑法，60%几率重阳剑气777气攻
	if wugong == 39 and match_ID(pid, 129) and JLSD(20, 80, pid) then
		ng = ng + 777
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = "重阳剑气・"..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = "重阳剑气"
		end
	end
	
	--弹指神通，配合桃花绝技，气攻+1000
	if wugong == 18 and TaohuaJJ(pid) then
		ng = ng + 1000
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "・无影神石"
		else
			WAR.Person[id]["特效文字3"] = "无影神石"
		end
	end
	
	--斩流剑术，九种文字
    if wugong == 151 and JY.Person[596]["姓名"] ~= "无酒不欢" then
		local WZTS = {"一念无量","现世执妄","悟入幻想","草木成佛","天人五衰","六根清净","众生无情","生死有命","半身大悟"}
		local JTYL = math.random(9)
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+九天一流・"..WZTS[JTYL]
		else
			WAR.Person[id]["特效文字3"] =  "九天一流・"..WZTS[JTYL]
		end
		ng = ng + 5000
    end

	--醉梦罗汉拳 两种招式
	 if wugong == 151 and JY.Person[596]["姓名"] == "无酒不欢" then
		local WZTS = {"一饮尽江河","再饮吞日月"}
		local JTYL = math.random(2)
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+醉梦罗汉拳・"..WZTS[JTYL]
		else
			WAR.Person[id]["特效文字3"] =  "醉梦罗汉拳・"..WZTS[JTYL]
		end
		ng = ng + 500
    end
    
    --打狗棒法 极意
    if wugong == 80 and level == 11 and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid) or (pid == 0 and JY.Base["标准"] == 5 and JLSD(30, 75, pid))) and WAR.AXFJ == 0 then
		WAR.Person[id]["特效文字3"] = "打狗棒法绝学--天下无狗"
		WAR.Person[id]["特效动画"] = 89
		if ng < 2400 then
			ng = 2400
		end
		WAR.WS = 1
		for i = 1, 6 do
			for j = 1, 6 do
			  SetWarMap(x + i - 1, y + j - 1, 4, 1)
			  SetWarMap(x - i + 1, y + j - 1, 4, 1)
			  SetWarMap(x + i - 1, y - j + 1, 4, 1)
			  SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
    end
	
	--须弥山神掌
	if wugong == 24 and level == 11 then
	   if (WAR.LQZ[pid] == 100 and match_ID(pid, 673) == false) or (match_ID(pid, 673) and WAR.SYBD[pid] ~= nil) then
	      WAR.Person[id]["特效文字3"] = "芥子纳须弥"
		  ng = ng + 1500
	   else
          WAR.Person[id]["特效文字3"] = "须弥藏芥子"
	   end
    end		  
	      
     
    --蓝烟清：胡家刀法，极意
    --刀系主角40%，胡斐50%，暴怒必出
    if wugong == 67 and level == 11 and (((pid == 0 and JY.Base["标准"] == 4 and (WAR.LQZ[pid] == 100 or JLSD(30,70,pid))) or (match_ID(pid, 1) and (WAR.LQZ[pid] == 100 or JLSD(20,70,pid)))) 
	or (JY.Person[pid]["专2"] == 67 and math.random(100) >= 50) 
	or match_ID(pid, 633) or (match_ID(pid, 1) and JY.Person[1]["阶"] >= 1))
	and WAR.AXFJ == 0 then
		local HDJY = {"极意・伏虎式","极意・拜佛听经","极意・穿手藏刀","极意・沙鸥掠波","极意・参拜北斗","极意・闭门铁扇刀","极意・缠身摘心刀","极意・进步连环刀","极意・八方藏刀式"};
		WAR.Person[id]["特效文字3"] = HDJY[math.random(9)];
		WAR.Person[id]["特效动画"] = 6
		ng = ng + 1500
		WAR.WS = 1
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
    end
    
	--重剑真传
	--杨过，神雕几率提高，有二次判定
    if wugong == 45 and level == 11 and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid) or ((match_ID(pid, 58) or match_ID(pid, 628)) and JLSD(30, 75, pid))) and WAR.AXFJ == 0 then
		WAR.Person[id]["特效文字3"] = "重剑真传・浪如山涌剑如虹"
		WAR.Person[id]["特效动画"] = 84
		ng = ng + 1800
		WAR.WS = 1
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
    end
    
    --霍都攻击，中毒+13~16
    if match_ID(pid, 84) and math.random(10) < 7 then
		WAR.HDWZ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."+".."暗箭・扇中钉"
		else
			WAR.Person[id]["特效文字1"] = "暗箭・扇中钉"
		end
		WAR.Person[id]["特效动画"] = 89
    end
	
	--寒冰绵掌
    if JY.Person[pid]["专1"] == 5 and wugong == 5 then
		WAR.HBMZ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."+".."寒冰绵掌"
		else
			WAR.Person[id]["特效文字1"] = "寒冰绵掌"
		end
		WAR.Person[id]["特效动画"] = 45
    end
	
	if JY.Person[pid]["防具"] == 369 or (JY.Person[690]["天2"] == 2 and match_ID(pid, 689)) then
	   WAR.HBMZ = 1
	end
	
	--打狗棒法
    if JY.Person[pid]["专2"] == 80 and wugong == 80 then
		WAR.DGGF = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."+".."狗腿打断"
		else
			WAR.Person[id]["特效文字1"] = "狗腿打断"
		end
		WAR.Person[id]["特效动画"] = 71
    end
	
	--关冲剑
	if match_ID(pid, 687) and wugong == 49 and WAR.LMZS == 5 then
	   WAR.LMSJ = 5
	end
    
    --葵花神功 刺目
    if wugong == 48 and PersonKF(pid, 105) then
		WAR.KHBX = 2
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."・".."葵花刺目"
		else
			WAR.Person[id]["特效文字1"] = "真辟邪剑法・葵花刺目"
		end
		WAR.Person[id]["特效动画"] = 6
	end
	
	if wugong == 4 and (JY.Person[pid]["专1"] == 4 or (PersonKF(pid, 4) and PersonKF(pid, 74))) then
		WAR.KHBX = 2
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."・".."鹰爪刺目"
		else
			WAR.Person[id]["特效文字1"] = "鹰爪刺目"
		end
		WAR.Person[id]["特效动画"] = 6
	end
	
	if wugong == 55 and JY.Person[29]["阶"] >= 1 and match_ID(pid, 29) then
		WAR.KHBX = 2
	end
	
	--葵花尊者必刺目
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and pid == 27 then
		WAR.KHBX = 2
		WAR.Person[id]["特效文字1"] = "葵花诀・葵花刺目";
		WAR.Person[id]["特效动画"] = 6
	end

	--令狐冲刺目
	if  match_ID_awakened(pid, 35, 1) and WAR.LQZ[pid] == 100 and JY.Person[pid]["体力"]>50 then
		WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + AddPersonAttrib(pid, "体力", -math.modf(JY.Person[pid]["体力"]/20));
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -math.modf(JY.Person[pid]["内力"]/20))
		WAR.KHBX = 2
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
			end
		WAR.Person[id]["特效文字1"] = "令狐冲破箭式・九剑刺目";
		WAR.Person[id]["特效动画"] = 8
	end
	
    --盲目状态，20%几率攻击无效
    if WAR.KHCM[pid] == 2 and math.random(10) <= 2 then
		WAR.MMGJ = 1
		WAR.Person[id]["特效动画"] = 89
		WAR.Person[id]["特效文字2"] = "盲目状态・攻击无效"
    end
	
	if ShaX() and JY.Person[pid]["地7"] ~= 7 and math.random(100) <= 17 then
		WAR.MMGJ2 = 1
		WAR.Person[id]["特效动画"] = 89
		WAR.Person[id]["特效文字2"] = "攻击落空"
    end
	
	if JY.Base["标准"] == 7 and JY.Person[0]["生命"] > 0 and JY.Person[0]["阶"] >= 2 then
	    if math.random(100) <= 15 and not inteam(pid) then
        WAR.MMGJ2 = 1
		WAR.Person[id]["特效动画"] = 89
		WAR.Person[id]["特效文字2"] = "攻击落空"
		end
	end
	
	
	 -- 开太极 WAR.tmp[3000 + pid] > 600
    if match_ID(pid, 5) and PersonKF(pid,171) and (wugong == 16 or wugong == 46) and WAR.LQZ[pid] == 100 and WAR.tmp[3000 + pid]~= nil and WAR.tmp[3000 + pid]>=500 then
		WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + AddPersonAttrib(pid, "体力", -math.modf(JY.Person[pid]["体力"]/10));
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -math.modf(JY.Person[pid]["内力"]/10))
	    local qg = JY.Person[pid]["内力"]/4
	    WAR.WDKTJ = 1
	    ng = ng+ qg
		local size = 60
		local x = CC.ScreenW/2;
        local y = CC.ScreenH/2;
        local offx = (#"【太一初分.开太极】")*size/4
        local offy = size/2
        lib.Background(0,y-50,CC.ScreenW,y+50,98)
        DrawString(x-offx,y-offy,"【太一初分.开太极】",C_GOLD,size);  
        ShowScreen();
        lib.Delay(500);
				for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
					end
				end	
                end		
			end
	
	--袁承志觉醒后，生命低于30%，50%几率出金蛇奥义
	if match_ID_awakened(pid, 54, 1) and wugong == 40 then
	local jl = 57
	if JY.Person[54]["阶"] >= 1 then
	   jl = 87
	end
	if JLSD(20,jl,pid) then
		WAR.JSAY = 1
		ng = ng + 2000
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 9 and offset2 <= 9 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		end
	end	
	end
	
	--万花
	if wugong == 30 and (JY.Person[pid]["专1"] == 30 or (match_ID(pid, 21) and JY.Person[21]["阶"] >= 2)) then
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 6 and offset2 <= 6 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		end
	end
	
	--剑意纵横
	if match_ID(pid, 683) and JY.Wugong[wugong]["武功类型"] == 3 and JY.Person[683]["天3"] == 2 then
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 7 and offset2 <= 7 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		end
	end
	
	
	--无名，名动江湖
	if match_ID(pid, 671) and wugong == 199 and WAR.MMZS == 9 then
		WAR.MDJH = 1
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		end
	end
	
	--九阴白骨爪极意
	if wugong == 11 and WAR.NGJL == 107 then
		ng = ng + 1000
		WAR.WS = 1
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
	end
	
	--少林极意
	if (wugong == 1 or wugong == 22 or wugong == 24) and ShaoL(pid) ~= nil and (JLSD(20,58 + 6*ShaoL(pid),pid) or WAR.LQZ[pid] == 100) then
		ng = ng + ShaoL(pid)*300
		WAR.WS = 1
		WAR.Person[id]["特效文字3"] = "少林真传"
	    WAR.Person[id]["特效动画"] = 88
		for i = 1, 1+ShaoL(pid) do
			for j = 1, 1+ShaoL(pid) do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
	end
	
	--田伯光
	if match_ID(pid, 29) and wugong == 55 and JY.Person[654]['品德']>=90 then
	   ng = ng + (JY.Person[654]['品德']-90)*500
	   if WAR.LQZ[pid] == 100 and PersonKF(pid, 189) then
	   ng = ng + 1000
	     WAR.Person[id]["特效文字3"] = "狂风奥义・狂风绝息斩"
	     WAR.Person[id]["特效动画"] = 15
	     WAR.WS = 1
		 for i = 1, 6 do
			 for j = 1, 6 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			 end
		 end
		end
	end
	
	
	--千剑归宗, 攻击全屏
    if wugong == 187 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	if wugong == 253 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--万劫刀法
	if wugong == 51 and JY.Person[pid]["专1"] == 51 and math.random(100) < 34 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--欧阳克
	if wugong == 9 and JY.Person[61]["阶"] >= 1 and match_ID(pid, 61) and WAR.LQZ[pid] == 100 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--欧阳克
	if wugong == 8 and JY.Person[116]["阶"] >= 3 and match_ID(pid, 116) then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--谢逊
	if wugong == 23 and JY.Person[13]["阶"] >= 3 and match_ID(pid, 13) and math.random(100) < 36 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	if JY.Person[pid]["地6"] == 7 and WAR.ACT == 3 then
	   CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
	end
	
	if match_ID(pid, 636) and JY.Person[636]["天4"] == 1 and (JLSD(20, 50, pid) or (WAR.LQZ[pid] == 100 and JLSD(25, 105, pid))) then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--冰蚕毒掌
	if match_ID(pid, 48) and wugong == 120 and JY.Person[48]["天3"] == 1 and math.random(100) < 34 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--天魔功
	if PersonKF(pid, 160) and JY.Person[pid]["专2"] == 160 and WAR.LQZ[pid] == 100 and WAR.ACT == 1 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--银锁
	if wugong == 79 and JY.Person[pid]["专2"] == 79 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--万剑归宗, 攻击全屏
    if wugong == 198 then
		CleanWarMap(4, 0)
		local n = 0
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				n = n + 1
			end
		end
		ng = ng + math.modf((100/n)*100)
		if not inteam(pid) then
		ng = math.modf(ng*0.3)
		end
    end
	
	--万剑诀, 攻击全屏
    if wugong == 194 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--无酒不欢：斗转第四层，幻梦星辰，反击全屏
    if WAR.DZXYLV[pid] == 150 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
	--雷震，碧落九重剑
	if match_ID(pid, 670) and JY.Person[pid]["御剑能力"] >= 200 and (kfkind == 3 or wugong == 49) and (math.random(100) < TrueYJ(pid)*0.08+14  or WAR.LQZ[pid] == 100) then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
		if JY.Person[pid]["御剑能力"] >= 320 then
			WAR.BLJY = 1
			ng = ng*2
		    if WAR.Person[id]["特效文字6"] ~= nil then
			   WAR.Person[id]["特效文字6"] = "剑意・碧落九重剑".. "+" .. WAR.Person[id]["特效文字6"]
			else
			   WAR.Person[id]["特效文字6"] = "剑意・碧落九重剑"
            end			   
		else
		    if WAR.Person[id]["特效文字1"] ~= nil then
			   WAR.Person[id]["特效文字1"] = "碧落九重剑" .. "+" .. WAR.Person[id]["特效文字1"]
			else
			   WAR.Person[id]["特效文字1"] = "碧落九重剑" 
			end
		end
		
    end

	--参和指满蓄力，攻击全屏	
	if wugong == 138 and WAR.tmp[7000 + pid] ~= nil then
		if WAR.tmp[7000 + pid] >=10 then
			CleanWarMap(4, 0)
			WAR.Person[id]["特效动画"] = 107
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
			local DZXY = {"北斗移辰","参商永合","陨石星浪","天幻星辰","星光日月","乾坤星阵","星璇天图","无言星空","星光灭绝"};
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."・".. DZXY[math.random(9)]
			else
				WAR.Person[id]["特效文字1"] = DZXY[math.random(9)];
			end
			ng = ng + 1000
			WAR.YSXL = 1
			WAR.tmp[7000 + pid] = WAR.tmp[7000 + pid] - 10
		end
	end
	
    local pz = math.modf(JY.Person[0]["资质"] / 10)
	local zj = 0
	--emu
	if WAR.ZDDH == 322 then
	   dofile(CC.Acvmts)
	   local tf = Achievements.pChar[1000].CharTd
	   if tf > 1000 then
	      tf = tf - 1677
	   end
	if tf < 10 then
       local zj = tf
	end   
	end
    
    --主角剑神大招，全屏攻击
    if ((pid == 0 and JY.Base["标准"] == 3 and 120 <= TrueYJ(pid) and 0 < JY.Person[pid]["武功9"] and JLSD(25, 60 + pz, pid)) 
	or (match_ID(pid, 683) and JY.Person[683]["天4"] == 1 and math.random(750) < TrueYJ(pid)) 
	or (pid == 0 and JY.Person[246]["品德"] == 100 and JLSD(25, 30, pid)) 
	or (pid == 677 and zj == 3 and JLSD(25, 60 + pz, pid))) 
	and kfkind == 3 and wugong ~= 43 and JY.Person[pid]["六如觉醒"] > 0 and WAR.AXFJ == 0 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[3]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[3] .. "・" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1500
		if JY.Person[0]["阶"] >= 2 and pid == 0 then
		ng = ng + 2500
		end
		WAR.WS = 1
		Cls()
		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[3] .. TFSSJ[3], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, ZJTF[3] .. TFSSJ[3], C_GOLD, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
		WAR.JSYX = 1
    end
      
    --主角拳系大招
    if ((pid == 0 and JY.Base["标准"] == 1 and 120 <= TrueQZ(pid) and 0 < JY.Person[pid]["武功9"] and JLSD(25, 60 + pz, pid)) or (pid == 0 and JY.Person[246]["品德"] == 100 and JLSD(25, 30, pid)) or (pid == 677 and zj == 1 and JLSD(25, 60 + pz, pid))) and kfkind == 1 and JY.Person[pid]["六如觉醒"] > 0 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[1]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[1] .. "・" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1200
		WAR.WS = 1
		Cls()
      
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[1] .. TFSSJ[1], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
			  Cls()
			  NewDrawString(-1, -1, ZJTF[1] .. TFSSJ[1], C_GOLD, CC.DefaultFont + i*2)
			  ShowScreen()
			  lib.Delay(500)
			else
			  lib.Delay(1)
			end
		end
		WAR.LXZQ = 1
    end
	
    --主角指法大招
    if ((pid == 0 and JY.Base["标准"] == 2 and 120 <= TrueZF(pid) and 0 < JY.Person[pid]["武功9"] 
	and (JLSD(25, 60 + pz, pid) or ((JY.Person[0]["阶"] >= 1) and JLSD(25, 60, pid)))) 
	or (pid == 0 and JY.Person[246]["品德"] == 100 and JLSD(25, 30, pid)) 
	or (pid == 677 and zj == 2 and JLSD(25, 60 + pz, pid))) and kfkind == 2 and JY.Person[pid]["六如觉醒"] > 0 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[2]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[2] .. "・" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1100
		WAR.WS = 1
		Cls()

		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[2] .. TFSSJ[2], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
			  Cls()
			  NewDrawString(-1, -1, ZJTF[2] .. TFSSJ[2], C_GOLD, CC.DefaultFont + i*2)
			  ShowScreen()
			  lib.Delay(500)
			else
			  lib.Delay(1)
			end
		end
		WAR.LXYZ = 1
    end
    
    --主角特系大招
    if (((pid == 0 and JY.Base["标准"] == 5 and 120 <= TrueTS(pid) and 0 < JY.Person[pid]["武功9"] and JLSD(25, 60 + pz, pid)) or (pid == 0 and JY.Person[246]["品德"] == 100 and JLSD(25, 30, pid)) or (pid == 677 and zj == 5 and JLSD(25, 60 + pz, pid))) and kfkind == 5 and JY.Person[pid]["六如觉醒"] > 0)
	or (JY.Base["标准"] == 5 and pid == 0 and JY.Person[0]["阶"] >= 3) then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[5]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[5] .. "・" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1000
		WAR.WS = 1
		Cls()
		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[5] .. TFSSJ[5], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
			  Cls()
			  NewDrawString(-1, -1, ZJTF[5] .. TFSSJ[5], C_GOLD, CC.DefaultFont + i*2)
			  ShowScreen()
			  lib.Delay(500)
			else
			  lib.Delay(1)
			end
		end
		WAR.GCTJ = 1
    end
    
    --主角刀系大招
    if ((pid == 0 and JY.Base["标准"] == 4 and 120 <= TrueSD(pid) and 0 < JY.Person[pid]["武功9"] and JLSD(25, 60 + pz, pid)) 
	or (pid == 0 and JY.Person[246]["品德"] == 100 and JLSD(25, 30, pid)) 
	or (pid == 677 and zj == 4 and JLSD(25, 60 + pz, pid)) 
	or (match_ID(pid, 691) and JY.Person[691]["天4"] == 1 and math.random(650) < TrueSD(pid))) and JY.Person[pid]["六如觉醒"] > 0 and kfkind == 4 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[4]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[4] .. "・" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1500
		WAR.WS = 1
		Cls()
		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[4] .. TFSSJ[4], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
			  Cls()
			  NewDrawString(-1, -1, ZJTF[4] .. TFSSJ[4], C_GOLD, CC.DefaultFont + i*2)
			  ShowScreen()
			  lib.Delay(500)
			else
			  lib.Delay(1)
			end
		end
		WAR.ASKD = 1
		--触发后给自己加怒气25
		WAR.YZHYZ = WAR.YZHYZ + 25
    end
      
    --主角天罡大招，内功可触发
    if ((pid == 0 and JY.Base["标准"] == 6 and 0 < JY.Person[pid]["武功9"] and JLSD(25, 60 + pz, pid)) or (pid == 0 and JY.Person[246]["品德"] == 100 and JLSD(25, 35, pid)) or (pid == 677 and zj == 6 and JLSD(25, 60 + pz, pid))) and kfkind == 6 and JY.Person[pid]["六如觉醒"] > 0 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[6]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[6] .. "・" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1300
		WAR.WS = 1
		Cls()

		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[6] .. TFSSJ[6], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, ZJTF[6] .. TFSSJ[6], C_GOLD, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
		WAR.JSTG = 1
	end
	
    --主角毒王大招，自身中毒100可触发
    if ((pid == 0 and JY.Base["标准"] == 9 and 0 < JY.Person[pid]["武功9"] and JLSD(25, 60 + pz, pid)) or (pid == 0 and JY.Person[246]["品德"] == 100 and JLSD(25, 30, pid)) or (pid == 677 and zj == 9 and JLSD(25, 60 + pz, pid))) and JY.Person[pid]["六如觉醒"] > 0
	or (wugong == 239 and (JY.Person[pid]["专2"] == 239 or (match_ID(pid, 85) and JY.Person[85]["阶"] >= 1))) then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[9]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[9] .. "・" .. WAR.Person[id]["特效文字3"]
		end
		WAR.WS = 1
		--JY.Person[pid]["中毒程度"] = 0
		if JY.Base["标准"] == 9 and pid == 0 and JY.Person[0]["阶"] >= 3 then
		
		for j = 0, WAR.PersonNum - 1 do
		local dam = JY.Person[WAR.Person[j]["人物编号"]]["中毒程度"]*5
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 300
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				--无酒不欢：记录人物血量
				WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - dam
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - dam
				--沉睡状态的敌人会醒来
				if WAR.CSZT[WAR.Person[j]["人物编号"]] ~= nil then
					WAR.CSZT[WAR.Person[j]["人物编号"]] = nil
				end
			end
		end
		
		end
		Cls()

		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[9] .. TFSSJ[9], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, ZJTF[9] .. TFSSJ[9], C_GOLD, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
		WAR.YTML = 1
	end
	
	--欧阳克，暴怒使用雪山白驼掌，变为灵蛇拳
	if match_ID(pid,61) and JY.Wugong[wugong]["武功类型"]==1 and (WAR.LQZ[pid] == 100 or JY.Person[61]["阶"] >= 1) then
		WAR.OYK = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・灵蛇拳"
		else
			WAR.Person[id]["特效文字1"] = "灵蛇拳"
		end
	end
	
	if match_ID(pid,642) and wugong == 173 then
		instruct_2(174, 6000) 
	end
	
	--海大富使用化骨绵掌
	if match_ID(pid,602) and wugong == 118 then
		WAR.HDF = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・化骨绵掌"
		else
			WAR.Person[id]["特效文字1"] = "化骨绵掌"
		end
	end
	
	--无尘追魂夺命剑
	if match_ID(pid,152) and JY.Wugong[wugong]["武功类型"] == 3 then
		WAR.OYK = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・追魂夺命"
		else
			WAR.Person[id]["特效文字1"] = "追魂夺命"
		end
	end
	
	--阿大八臂神剑
	if match_ID(pid,643) and JY.Wugong[wugong]["武功类型"] == 3 then
		WAR.ADA = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・八臂神剑"
		else
			WAR.Person[id]["特效文字1"] = "八臂神剑"
		end
	end
	
	--丁典，无影神拳
	if match_ID(pid, 672) and JY.Person[672]["品德"] ~= 80 then
	local jl = 15
	if JY.Person[pid]["拳掌功夫"] >= 120 then
	   jl = jl + 10
	end
	if JY.Person[672]["品德"] == 70 then
	   jl = jl + 15
	end
	if JY.Person[672]["阶"] >= 2 then
	   jl = jl + 20
	end
	if WAR.LQZ[pid] ~= nil then
	   jl = jl + math.modf(WAR.LQZ[pid]*0.35)
	   if WAR.LQZ[pid] == 100 then
	      jl = jl + 10
	   end
	end
	if JY.Wugong[wugong]["武功类型"] ~= 1 and wugong ~= 94 then
	   jl = math.modf(jl/2)
	end
	
	if math.random(100) < jl then
	   WAR.DDSQ = 1
	   ng = ng + 500 + JY.Person[pid]["拳掌功夫"]*3
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+无影神拳"
	   else
			WAR.Person[id]["特效文字1"] = "无影神拳"
	   end
	   WAR.Person[id]["特效动画"] = 149
	end
	end
	
	--无影神拳
	if PersonKF(pid,94) and JY.Person[pid]["专1"] == 94 and JY.Wugong[wugong]["武功类型"] == 1 then
	
	if math.random(100) < 16 then
	   WAR.DDSQ = 1
	   ng = ng + 500 + JY.Person[pid]["拳掌功夫"]*3
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+无影神拳"
	   else
			WAR.Person[id]["特效文字1"] = "无影神拳"
	   end
	   WAR.Person[id]["特效动画"] = 149
	end
	end
	
	--少商剑
	if match_ID(pid, 687) and wugong == 49 and WAR.LMZS == 6 then
	if math.random(100) < 51 then
	   WAR.LMSJ = 6
	end
	end
	--能量值消耗
	if (wugong == 202 or wugong == 203) and WAR.NLZ[pid] ~= nil then
	if WAR.MSHBD == 1 or WAR.MSHSL == 1 then
	   ng = ng + 1500
	   WAR.NLZ[pid] = WAR.NLZ[pid] - 50
	   if WAR.NLZ[pid] < 1 then
	      WAR.NLZ[pid] = nil
	   end
	end
	end
	
	if wugong == 205 then
	   ng = ng + 3000
	   WAR.NLZ[pid] = nil
	end
	   
	
		--玄慈般若掌极意 一空到底
	if match_ID(pid,70) and wugong == 22 and level == 11 then
		WAR.LHQ_YKDD=1
	if wugong == 22 and level == 11 and JLSD(30, 60, pid) then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・般若掌最高境界"
		else
			WAR.Person[id]["特效文字1"] = "般若掌最高境界"
		end
		ng = ng + 1500
		WAR.WS = 1
		WAR.YKDD=1
		WAR.YKDD2[pid] = 10
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
	end
	end
	
	--郭靖，降龙连击时随机后劲，有余不尽
	if (match_ID(pid, 55) or pid==612) and wugong == 26 and WAR.ACT > 1 then
		local txwz = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一","十二","十三"}
		if inteam(pid) then
			WAR.YYBJ = math.random(0, JY.Base["天书数量"])
			if WAR.YYBJ > 13 then
				WAR.YYBJ = 13
			end
			--保底天书数量-7
			if JY.Base["天书数量"] > 7 then
				if WAR.YYBJ < JY.Base["天书数量"] - 7 then
					WAR.YYBJ = JY.Base["天书数量"] - 7
				end
			end
		else
			WAR.YYBJ = math.random(1, 10)
		end
		if WAR.YYBJ > 0 then
			ng = ng + WAR.YYBJ*150
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = "降龙・有余不尽・"..txwz[WAR.YYBJ].."重后劲".."+"..WAR.Person[id]["特效文字1"]
			else
				WAR.Person[id]["特效文字1"] = "降龙・有余不尽・"..txwz[WAR.YYBJ].."重后劲"
			end
		end
	end

	--乔峰见龙在田
	if match_ID(pid, 50) and wugong == 26 and WAR.LQZ[pid] == 100 then
		WAR.QFBGM=1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・见龙在田"
		else
			WAR.Person[id]["特效文字1"] = "见龙在田"
		end
	end
		
	
	--阿青，天元剑气
	if match_ID(pid, 604) and kfkind == 3 then
		WAR.TYJQ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・天元剑气"
		else
			WAR.Person[id]["特效文字1"] = "天元剑气"
		end
    end
	
	--创刀
	if match_ID(pid, 681) and kfkind == 4 and JY.Person[681]["天3"] == 1 then
		WAR.NFCD = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・创刀"
		else
			WAR.Person[id]["特效文字1"] = "创刀"
		end
    end
	
	--丁鹏
	if match_ID(pid, 691) and JY.Person[691]["天3"] == 1 then
	   WAR.RJSD = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+人即是刀"
		else
			WAR.Person[id]["特效文字1"] = "人即是刀"
		end
    end
	
	--魔刀
	if match_ID(pid, 681) and kfkind == 4 and JY.Person[681]["天3"] == 2 then
	   WAR.NFMD = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・魔刀"
		else
			WAR.Person[id]["特效文字1"] = "魔刀"
		end
    end
	
	--林朝英，流风回雪
	if match_ID(pid, 605) and JLSD(20, 80, pid) then
		WAR.LFHX = 1
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "・流风回雪"
		else
			WAR.Person[id]["特效文字3"] = "流风回雪"
		end
    end

	--七夕黄蓉，打狗缠字诀
	if wugong == 80 and match_ID(pid, 613) then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+打狗棒法・缠字诀"
		else
			WAR.Person[id]["特效文字1"] = "打狗棒法・缠字诀"
		end
	end
	
	--名动江湖
	if wugong == 199 and match_ID(pid, 671) and WAR.MMZS == 9 then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+震慑群雄"
		else
			WAR.Person[id]["特效文字1"] = "震慑群雄"
		end
	end
	
	--进阶泰山，使用后30时序内闪避
	if wugong == 31 and PersonKF(pid,175) then
		WAR.TSSB[pid] = 30
	end
	if wugong == 31 and JY.Person[pid]["专1"] == 31 then
		WAR.TSSJ[pid] = 20
	end
	if wugong == 32 and JY.Person[pid]["专1"] == 32 then
		WAR.YWSS[pid] = 20
	end
	
	--南山刀法，使用后10时序内不动如山
	if wugong == 53 and JY.Person[pid]["专1"] == 53 then
		WAR.NSDF[pid] = 10
	    if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+悠悠见南山"
		else
			WAR.Person[id]["特效文字1"] = "悠悠见南山"
		end
	end
	
	--南山刀法，使用后10时序内不动如山
	if wugong == 53 and match_ID(pid, 133) then
		WAR.NSDF[pid] = 18
	    if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+悠悠见南山"
		else
			WAR.Person[id]["特效文字1"] = "悠悠见南山"
		end
	end
	
	--主运天罗地网，减少敌方移动
	if Curr_QG(pid,148) then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+柔网势"
		else
			WAR.Person[id]["特效文字1"] = "柔网势"
		end
	end
	
	--无酒不欢：举火燎原，金乌+燃木+火焰刀，引燃效果，平时50%几率，暴怒必出
	if (wugong == 61 or wugong == 65 or wugong == 66) and JuHuoLY(pid) then
	local jl = 60
	if tg ~= 1 then
	   if fx > 0 then
	      jl = jl + fx*3
	   end  
	else
	   if yang > 0 then
	      jl = jl + yang*3
	   end
	end   
	    if WAR.LQZ[pid] == 100 or JLSD(20,jl,pid) then
		Set_Eff_Text(id,"特效文字2","举火燎原")
		WAR.JuHuo = 1
		end
	end
	
	--无酒不欢：利刃寒锋，修罗+阴风+沧溟，冻结效果，平时50%几率，暴怒必出
	if (wugong == 58 or wugong == 174 or wugong == 153) and LiRenHF(pid) then
	local jl = 60
	if tg ~= 1 then
	   if fx < 0 then
	      jl = jl - fx*3
	   end  
	else
	   if yang > 0 then
	      jl = jl - yin*3
	   end
	end	
	    if WAR.LQZ[pid] == 100 or JLSD(20,jl,pid) then
		Set_Eff_Text(id,"特效文字2","利刃寒锋")
		WAR.LiRen = 1
		end
	end
	
	if wugong == 207 then
	   WAR.LiRen = 1
	end
	
	if match_ID(pid, 676) and JY.Wugong[wugong]["武功类型"] == 1 and JY.Base["天书数量"] >= 1 and WAR.ACT == 3 then  
	WAR.DJJ = 1
		WAR.Person[id]["特效动画"] = 32
		if WAR.Person[id]["特效文字6"] ~= nil then
			WAR.Person[id]["特效文字6"] = WAR.Person[id]["特效文字6"] .. "+断筋诀"
		else
			WAR.Person[id]["特效文字6"] = "断筋诀"
		end

	end
	
	if match_ID(pid, 676) and JY.Wugong[wugong]["武功类型"] == 1 and JY.Base["天书数量"] >= 7 and JLSD(20,35 + 20*WAR.ACT,pid) then
	WAR.SDLT = 1
		WAR.Person[id]["特效动画"] = 31
		if WAR.Person[id]["特效文字6"] ~= nil then
			WAR.Person[id]["特效文字6"] = WAR.Person[id]["特效文字6"] .. "+爆裂掌"
		else
			WAR.Person[id]["特效文字6"] = "爆裂掌"
		end

	end
	
	if match_ID(pid, 676) and JY.Wugong[wugong]["武功类型"] == 1 and JY.Base["天书数量"] >= 9 then
	local jl = 15
	if WAR.LQZ[pid] == 100 then
	   jl = jl + 25
	end   
	jl = jl + math.modf(JY.Person[0]["实战"]/50)
	  if JLSD(20,20+jl,pid) then
		WAR.QXQ = 1
	    WAR.SDLT = 1	
		WAR.Person[id]["特效动画"] = 125
		if WAR.Person[id]["特效文字6"] ~= nil then
			WAR.Person[id]["特效文字6"] = WAR.Person[id]["特效文字6"] .. "+七相拳"
		else
			WAR.Person[id]["特效文字6"] = "七相拳"
		end
	  end	
	end
	
	if JY.Person[pid]["动物"] == 347 and math.random(100) <= 10 + JY.Thing[347]["装备等级"]*3 then
	   WAR.AHGJ = 1
	   if WAR.Person[id]["特效文字6"] ~= nil then
			WAR.Person[id]["特效文字6"] = WAR.Person[id]["特效文字6"] .. "+狂犬病"
	   else
			WAR.Person[id]["特效文字6"] = "狂犬病"
	   end
	end
	
	if Curr_NG(pid, 107) and inteam(pid) then
	   if math.random(100) < 7 then
	   if WAR.Person[id]["特效文字6"] ~= nil then
			WAR.Person[id]["特效文字6"] = WAR.Person[id]["特效文字6"] .. "+移魂大法"
	   else
			WAR.Person[id]["特效文字6"] = "移魂大法"
	   end
	      WAR.YHDF = 2
	   elseif math.random(100) < 7 then
	   if WAR.Person[id]["特效文字6"] ~= nil then
			WAR.Person[id]["特效文字6"] = WAR.Person[id]["特效文字6"] .. "+移魂大法"
	   else
			WAR.Person[id]["特效文字6"] = "移魂大法"
	   end
          WAR.YHDF = 1
	   end
	end 

	if wugong == 176 and JY.Person[pid]["专2"] == 176 then
	   WAR.Person[WAR.CurID]["特效文字1"] = "刀刀烈火"
	end
	
	if wugong == 115 and JY.Person[pid]["专1"] == 115 then
	   WAR.SHJD = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+三花聚顶"
	   else
			WAR.Person[id]["特效文字1"] = "三花聚顶"
	   end
	end
	if match_ID(pid, 36) then
	   WAR.XFXY = 0
	end
	
	if (Curr_NG(pid, 207) or (match_ID(pid, 22) and PersonKF(pid, 207))) and (WAR.ACT == 1 or math.random(100) < 20) then
	   WAR.HBZQ = 1
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+寒冰真气"
	   else
			WAR.Person[id]["特效文字1"] = "寒冰真气"
	   end
	end
	   
	--宇宙洪荒
	if YuzhouHH(pid) then
	local s = math.random(21)
	if (s < 8 and WAR.ACT == 1) or (WAR.ACT > 1 and (math.random(100) <= 10 or match_ID(pid, 677) and JY.Person[677]["天4"] == 1 and math.random(100) <= 35)) then
	
	
	if s == 1 then
	
	   WAR.YZHH = 1
	   WAR.Person[WAR.CurID]["特效文字1"] = "宇宙洪荒・冻"
	elseif s == 2 then
	 
	   WAR.YZHH = 2
	   WAR.Person[WAR.CurID]["特效文字1"] = "宇宙洪荒・燃"
	elseif s == 3 then

	   WAR.YZHH = 3
	   WAR.Person[WAR.CurID]["特效文字1"] = "宇宙洪荒・眩"
	elseif s == 4 then
	   
	   WAR.YZHH = 4
	   WAR.Person[WAR.CurID]["特效文字1"] = "宇宙洪荒・停"
	elseif s == 5 then
	   
	   WAR.YZHH = 5
	   WAR.Person[WAR.CurID]["特效文字1"] = "宇宙洪荒・虚"
	elseif s == 6 then
	   
	   WAR.YZHH = 6
	   WAR.Person[WAR.CurID]["特效文字1"] = "宇宙洪荒・乱"
	elseif s == 7 then
	   
	   WAR.YZHH = 7
	   WAR.Person[WAR.CurID]["特效文字1"] = "宇宙洪荒・残"
	end
	
	end
	end
	
	--五轮大法
	if wugong == 158 and (JY.Person[pid]["专2"] == 158 or (JY.Person[62]["阶"] >= 1 and match_ID(pid, 62))) then
	local s = math.random(11)
	    if s == 1 or s == 6 then
	
	   WAR.WLDF = 1
	   WAR.Person[WAR.CurID]["特效文字1"] = "金轮"
	    elseif s == 2 or s == 7 then
	 
	   WAR.WLDF = 2
	   WAR.Person[WAR.CurID]["特效文字1"] = "银轮"
	    elseif s == 3 or s == 8 then

	   WAR.WLDF = 3
	   WAR.Person[WAR.CurID]["特效文字1"] = "铜轮"
	    elseif s == 4 or s == 9 then
	    
	   WAR.WLDF = 4
	   WAR.Person[WAR.CurID]["特效文字1"] = "铁轮"
	    elseif s == 5 or s == 10 then
	   
	   WAR.WLDF = 5
	   WAR.Person[WAR.CurID]["特效文字1"] = "铅轮"
	    end
	end
	
	if wugong == 57 and JY.Person[pid]["专1"] == 57 then
	   WAR.CBDF = 1
	   WAR.Person[WAR.CurID]["特效文字1"] = "放下屠刀・立地成佛"
	end
	
	--逍遥御风
	if XiaoYaoYF(pid) and JLSD(20,70,pid) and (WAR.XYYF[pid] == nil or WAR.XYYF[pid] < 9) and WAR.YFCS < 3 then
		WAR.YFCS = WAR.YFCS + 1
		WAR.XYYF[pid] = (WAR.XYYF[pid] or 0) + 1
		Set_Eff_Text(id,"特效文字2","逍遥御风")
		if WAR.XYYF[pid] == 9 then
			WAR.XYYF[pid] = 11
			WAR.XYYF_10 = 1
		end
	end

	--参和指蓄力
	if PersonKF(pid,138) and WAR.DZXYCS<5  then
		WAR.DZXYCS=WAR.DZXYCS+1
	if WAR.tmp[7000 + pid] == nil then
			WAR.tmp[7000 + pid] = 0
		end
		WAR.tmp[7000 + pid] = WAR.tmp[7000 + pid] + 1;
		--上限100
		if WAR.tmp[7000 + pid] > 10 then
			WAR.tmp[7000 + pid] = 10
		end
	end

	--主运太玄，太玄之重，不加怒
	if (Curr_NG(pid, 102) and JLSD(0, 40 + JY.Base["天书数量"] + math.modf(JY.Person[pid]["实战"]/30), pid)) 
	or (PersonKF(pid, 102) and JY.Person[pid]["专2"] == 102 and JLSD(0, 20 + JY.Base["天书数量"] + math.modf(JY.Person[pid]["实战"]/60), pid))
	or (Curr_NG(pid, 102) and match_ID(pid, 38) and JY.Person[38]["阶"] >= 3) then
		WAR.TXZZ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "・太玄之重"
		else
			WAR.Person[id]["特效文字1"] = "太玄之重"
		end
    end
	
	--一灯用一阳指，无明业火
	if match_ID(pid, 65) and wugong == 17 then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = "无明业火・"..WAR.Person[id]["特效文字1"]
		else
			WAR.Person[id]["特效文字1"] = "无明业火"
		end
	end
	
	--周伯通空明之武道使敌方不会护体，初始几率25%，每20点实战+1%几率
	if match_ID(pid, 64) and JLSD(20, 45 + math.modf(JY.Person[pid]["实战"]/20), pid) then
		WAR.KMZWD = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = "空明之武道・"..WAR.Person[id]["特效文字1"]
		else
			WAR.Person[id]["特效文字1"] = "空明之武道"
		end
    end
	
	--先天功+乾坤大挪移，50%几率使敌方不会护体
	if PersonKF(pid, 100) and PersonKF(pid, 97) and JLSD(20, 70, pid) then
		WAR.XTQKG = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = "先天乾坤功・"..WAR.Person[id]["特效文字1"]
		else
			WAR.Person[id]["特效文字1"] = "先天乾坤功"
		end
    end
	
	--九剑真传，剑法主动攻击70%几率触发4种特效之一
	--七夕令狐冲自带
	if ((pid == 0 and JY.Person[592]["论剑奖励"] == 1 and JLSD(15, 85,pid))
		or match_ID(pid, 667) or match_ID_awakened(pid, 35, 2))
		and kfkind == 3 then
		local t = math.random(4)
		local wz = {"离剑式","倒剑式","撩剑式","荡剑式"}
		WAR.JJZC = t
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+九剑真传・"..wz[t]
		else
			WAR.Person[id]["特效文字1"] = "九剑真传・"..wz[t]
		end
	end
	
	--琴棋书画：持瑶琴，不加怒
	if wugong == 73 and QinqiSH(pid)  then
		--50%几率触发清怒
		if JLSD(20, 70, pid) then
			WAR.QQSH1 = 2
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = "菩提清心・"..WAR.Person[id]["特效文字1"]
			else
				WAR.Person[id]["特效文字1"] = "菩提清心"
			end
		else
			WAR.QQSH1 = 1
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = "琴音悦耳・"..WAR.Person[id]["特效文字1"]
			else
				WAR.Person[id]["特效文字1"] = "琴音悦耳"
			end
		end
    end

	--天竺佛指+慈悲刀法
	if (wugong ==122 or wugong ==57) and WoFo(pid) then
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = "我佛慈悲・"..WAR.Person[id]["特效文字1"]
			else
				WAR.Person[id]["特效文字1"] = "我佛慈悲"
			end
	end
	
	--琴棋书画：妙笔丹青
	if wugong == 142 and QinqiSH(pid)  then
		--40%几率全屏，暴怒必出
		if JLSD(30, 70, pid) or WAR.LQZ[pid] == 100 and WAR.AXFJ == 0 then
			WAR.QQSH2 = 2
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = "江山如画・"..WAR.Person[id]["特效文字3"]
			else
				WAR.Person[id]["特效文字3"] = "江山如画"
			end
			CleanWarMap(4, 0)
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		else
			--必定出大冰封
			WAR.QQSH2 = 1
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = "诗情画意・"..WAR.Person[id]["特效文字3"]
			else
				WAR.Person[id]["特效文字3"] = "诗情画意"
			end
		end
	end
	
	--琴棋书画：倚天屠龙功，50%几率出特效，伤害提高20%，必封穴
	if wugong == 84 and QinqiSH(pid) and JLSD(20, 70, pid)  then
		WAR.QQSH3 = 1
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] =  "秉笔直书・"..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = "秉笔直书"
		end
	end
	
	--主运玉女：夭矫空碧，连击伤害杀气不减 暴怒必出
	if match_ID(pid, 605) or (Curr_NG(pid, 154) and (JLSD(30, 45 + JY.Base["天书数量"]*2, pid) or WAR.LQZ[pid] == 100)) and WAR.ACT > 1 then
		WAR.YNXJ = 1
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"] .. "+夭矫空碧"
		else
			WAR.Person[id]["特效文字0"] = "夭矫空碧"
		end
    end
	
	--雷震，英雄三刀
	if match_ID(pid, 670) and JY.Wugong[wugong]["武功类型"] == 4 and WAR.ACT == 3 and JY.Person[pid]["耍刀技巧"] >= 200 then
		for i = 1, 30 do
			DrawStrBox(-1, 24, "英雄三刀", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
    end
	
	
	
    --怒气暴发，气攻+1200
    if WAR.LQZ[pid] == 100 and WAR.DZXY ~= 1 and WAR.AXFJ == 0 then
		local wd = "会心之一击"
		--怒涛海潮，
		if Curr_NG(pid, 177) or PersonKF(pid, 172) then
			wd = "天霄狂浪"
		end
		WAR.HXZYJ = 1
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+".. wd
		else
			WAR.Person[id]["特效文字1"] = wd
		end
		ng = ng + 1200
    end
	
	--全真七子，天罡北斗阵，文字显示
	if WAR.ZDDH == 73 then
		if (pid >= 123 and pid <= 128) or pid == 68 then
			WAR.Person[id]["特效动画"] = 93
			if WAR.Person[id]["特效文字2"] ~= nil then
				WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+天罡北斗阵加力"
			else
				WAR.Person[id]["特效文字2"] = "天罡北斗阵加力"
			end
		end
	end
	
    --蓄力攻击
    if WAR.Actup[pid] ~= nil then
    	--主运蛤蟆，追加杀气
		if Curr_NG(pid, 95) then
			ng = ng + 1200
		else
			ng = ng + 600
		end
		local str = "蓄力攻击"
		if WAR.SLSX[pid] ~= nil then
			str = str .. "・十龙十象"
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+"..str
		else
			WAR.Person[id]["特效文字1"] = str
		end
    end  
    
    --九阴神功加力时，使用九阴白骨爪出九阴神爪
	if wugong == 11 and WAR.NGJL == 107 then
		ng = ng + 2000
		WAR.WS = 1
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = "九阴神爪・"..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = "九阴神爪"
		end
	end
    
    --屠龙刀特效一，追加等同于武功威力的杀气
  	if WAR.L_TLD == 1 then
		ng = ng + get_skill_power(pid, wugong, 11)
  	end
  	
    --特效文字1，动画为红色圈
    if WAR.Person[id]["特效文字1"] ~= nil and WAR.Person[id]["特效动画"] == -1 then
		WAR.Person[id]["特效动画"] = 88
    end
	
	--北斗七闪的特效动画
	if match_ID(pid, 129) and WAR.CYZX[pid] ~= nil and WAR.BDQS > 0 then
		WAR.Person[id]["特效动画"] = 126
	end

	--杀破狼的特效动画	
	if match_ID(pid, 112) and WAR.ZHRM[pid] == nil and WAR.XYS > 0 then
		WAR.Person[id]["特效动画"] = 132
	end
	
	--无酒不欢的特效动画
	if pid == 0 and JY.Base["特殊"] == 1 then
		WAR.Person[id]["特效动画"] = 132
	end
	
	--无酒不欢的特效动画
	if pid == 596 and JY.Person[596]["姓名"] == "无酒不欢" then
		WAR.Person[id]["特效动画"] = 132
	end
	
	  --开太极的动画
	if WAR.WDKTJ == 1 then
	    WAR.Person[id]["特效动画"] = 137
	end	
	
	--苗人凤破军的动画和文字
	if match_ID(pid, 3) and WAR.MRF == 1 then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = "破军・"..WAR.Person[id]["特效文字1"]
		else
			WAR.Person[id]["特效文字1"] = "破军"
		end
		WAR.Person[id]["特效动画"] = 146
	end
	
	--温青青 大暴的动画
	if WAR.WQQ == 1 then
		WAR.Person[id]["特效动画"] = 154
	end
	
    --无酒不欢：独孤求败的先手反击
	if WAR.ACT == 1 and wugong~=27 and (JY.Person[pid]["御剑能力"] < 320 or (JY.Base["畅想"] == 592 and JY.Person[pid]["御剑能力"] < JY.Person[0]["御剑能力"])) then
		local hit_DGQB
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 592) then
							hit_DGQB = emeny
							break;
						end
					end
				end
			end
			if hit_DGQB ~= nil then
				break
			end
		end
		
		if hit_DGQB ~= nil then
			local pre_target_list = {}
			local pre_target_num = 0
			local tx_1 = WAR.Person[id]["特效文字0"] or nil
			local tx_2 = WAR.Person[id]["特效文字1"] or nil
			local tx_3 = WAR.Person[id]["特效文字2"] or nil
			local tx_4 = WAR.Person[id]["特效文字3"] or nil
			local tx_5 = WAR.Person[id]["特效文字4"] or nil
			local tx_6 = WAR.Person[id]["特效文字5"] or nil
			local tx_8 = WAR.Person[id]["特效文字6"] or nil
			
			local tx_7 = WAR.Person[id]["特效动画"]
			WAR.Person[id]["特效文字0"] = nil
			WAR.Person[id]["特效文字1"] = nil
			WAR.Person[id]["特效文字2"] = nil
			WAR.Person[id]["特效文字3"] = nil
			WAR.Person[id]["特效文字4"] = nil
			WAR.Person[id]["特效文字8"] = nil
			WAR.Person[id]["特效动画"] = -1
			WAR.hit_DGQB = 1
			WAR.Person[hit_DGQB]["特效动画"] = 83
			for i = 0, CC.WarWidth - 1 do
				for j = 0, CC.WarHeight - 1 do
					local pre_effect = GetWarMap(i, j, 4)
					if pre_effect > 0 then
						local pre_target = GetWarMap(i, j, 2)
						pre_target_num = pre_target_num + 1
						pre_target_list[pre_target_num] = {i, j, pre_target, pre_effect}
					end
				end
			end
			CleanWarMap(4, 0)
			local s1 = WAR.CurID
			WAR.CurID = hit_DGQB
			WAR.Effect = 2
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					local pid = WAR.Person[WAR.CurID]["人物编号"]
					local eid = WAR.Person[i]["人物编号"]
					local dam;
					dam = First_strike_dam_DG(pid, eid)
					if dam > 0 then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						--无酒不欢：记录人物血量
						WAR.Person[i]["Life_Before_Hit"] = JY.Person[eid]["生命"]
						JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - dam
						if JY.Person[eid]["生命"] < 0 then
							JY.Person[eid]["生命"] = 0
						end
						SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 2)
					end
				end
			end
			WAR.Person[WAR.CurID]["特效文字0"] = nil
			WAR.Person[WAR.CurID]["特效文字1"] = nil
			WAR.Person[WAR.CurID]["特效文字2"] = nil
			WAR.Person[WAR.CurID]["特效文字3"] = nil
			WAR.Person[WAR.CurID]["特效文字4"] = nil
			WAR.Person[WAR.CurID]["特效文字8"] = nil
			WAR.Person[WAR.CurID]["特效动画"] = -1
			War_ShowFight(WAR.Person[hit_DGQB]["人物编号"], 0, 0, 0, 0, 0, 60, -1)
			WAR.hit_DGQB = 0
			WAR.Person[hit_DGQB]["特效动画"] = -1
			
			--如果被上一步反击死亡，那么该人物的攻击就结束了
			if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] <= 0 then
				return 1
			else		
				WAR.CurID = s1
				CleanWarMap(4, 0)
				WAR.Effect = 0
				for i = 1, pre_target_num do
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 2, pre_target_list[i][3])
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 4, pre_target_list[i][4])
				end
				WAR.Person[id]["特效文字0"] = tx_1
				WAR.Person[id]["特效文字1"] = tx_2
				WAR.Person[id]["特效文字2"] = tx_3
				WAR.Person[id]["特效文字3"] = tx_4
				WAR.Person[id]["特效文字4"] = tx_5
				WAR.Person[id]["特效文字5"] = tx_6
				WAR.Person[id]["特效文字6"] = tx_8
				WAR.Person[id]["特效动画"] =  tx_7
			end
		end
	end
	
	--西门吹雪
	if (WAR.ACT == 1 or WAR.ACT == 2) and math.random(100) <= 40 then
		local hit_XMCX
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 683) and JY.Person[683]["天4"] == 2 then
							hit_XMCX = emeny
							break;
						end
					end
				end
			end
			if hit_XMCX ~= nil then
				break
			end
		end
		
		if hit_XMCX ~= nil then
			local pre_target_list = {}
			local pre_target_num = 0
			local tx_1 = WAR.Person[id]["特效文字0"] or nil
			local tx_2 = WAR.Person[id]["特效文字1"] or nil
			local tx_3 = WAR.Person[id]["特效文字2"] or nil
			local tx_4 = WAR.Person[id]["特效文字3"] or nil
			local tx_5 = WAR.Person[id]["特效文字4"] or nil
			local tx_6 = WAR.Person[id]["特效文字5"] or nil
			local tx_8 = WAR.Person[id]["特效文字6"] or nil
			
			local tx_7 = WAR.Person[id]["特效动画"]
			WAR.Person[id]["特效文字0"] = nil
			WAR.Person[id]["特效文字1"] = nil
			WAR.Person[id]["特效文字2"] = nil
			WAR.Person[id]["特效文字3"] = nil
			WAR.Person[id]["特效文字4"] = nil
			WAR.Person[id]["特效文字8"] = nil
			WAR.Person[id]["特效动画"] = -1
			WAR.hit_XMCX = 1
			WAR.Person[hit_XMCX]["特效动画"] = 3
			for i = 0, CC.WarWidth - 1 do
				for j = 0, CC.WarHeight - 1 do
					local pre_effect = GetWarMap(i, j, 4)
					if pre_effect > 0 then
						local pre_target = GetWarMap(i, j, 2)
						pre_target_num = pre_target_num + 1
						pre_target_list[pre_target_num] = {i, j, pre_target, pre_effect}
					end
				end
			end
			CleanWarMap(4, 0)
			local s1 = WAR.CurID
			WAR.CurID = hit_XMCX
			WAR.Effect = 2
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					local pid = WAR.Person[WAR.CurID]["人物编号"]
					local eid = WAR.Person[i]["人物编号"]
					local dam;
					dam = First_strike_dam_XM(pid, eid)
					if dam > 0 then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						--无酒不欢：记录人物血量
						WAR.Person[i]["Life_Before_Hit"] = JY.Person[eid]["生命"]
						JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - dam
						if JY.Person[eid]["生命"] < 0 then
							JY.Person[eid]["生命"] = 0
						end
						SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 2)
					end
				end
			end
			WAR.Person[WAR.CurID]["特效文字0"] = nil
			WAR.Person[WAR.CurID]["特效文字1"] = nil
			WAR.Person[WAR.CurID]["特效文字2"] = nil
			WAR.Person[WAR.CurID]["特效文字3"] = nil
			WAR.Person[WAR.CurID]["特效文字4"] = nil
			WAR.Person[WAR.CurID]["特效文字8"] = nil
			WAR.Person[WAR.CurID]["特效动画"] = -1
			War_ShowFight(WAR.Person[hit_XMCX]["人物编号"], 0, 0, 0, 0, 0, 60, -1)
			WAR.hit_XMCX = 0
			WAR.Person[hit_XMCX]["特效动画"] = -1
			
			--如果被上一步反击死亡，那么该人物的攻击就结束了
			if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] <= 0 then
				return 1
			else		
				WAR.CurID = s1
				CleanWarMap(4, 0)
				WAR.Effect = 0
				for i = 1, pre_target_num do
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 2, pre_target_list[i][3])
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 4, pre_target_list[i][4])
				end
				WAR.Person[id]["特效文字0"] = tx_1
				WAR.Person[id]["特效文字1"] = tx_2
				WAR.Person[id]["特效文字2"] = tx_3
				WAR.Person[id]["特效文字3"] = tx_4
				WAR.Person[id]["特效文字4"] = tx_5
				WAR.Person[id]["特效文字5"] = tx_6
				WAR.Person[id]["特效文字6"] = tx_8
				WAR.Person[id]["特效动画"] =  tx_7
			end
		end
	end
	--北斗有情断迅拳
	if WAR.ACT == 1 and math.random(100) <= 30+JY.Base["天书数量"] then
		local hit_YQDXQ
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 686) and JY.Person[686]["天3"] == 1 and WAR.Person[WAR.CurID]["死亡"] == false and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
							hit_YQDXQ = emeny
							break;
						end
					end
				end
			end
			if hit_YQDXQ ~= nil then
				break;
			end
			
		end
		
		if hit_YQDXQ ~= nil then
			local pre_target_list = {}
			local pre_target_num = 0
			local tx_1 = WAR.Person[id]["特效文字0"] or nil
			local tx_2 = WAR.Person[id]["特效文字1"] or nil
			local tx_3 = WAR.Person[id]["特效文字2"] or nil
			local tx_4 = WAR.Person[id]["特效文字3"] or nil
			local tx_5 = WAR.Person[id]["特效文字4"] or nil
			local tx_6 = WAR.Person[id]["特效文字5"] or nil
			local tx_8 = WAR.Person[id]["特效文字6"] or nil
			local tx_7 = WAR.Person[id]["特效动画"]
			WAR.Person[id]["特效文字0"] = nil
			WAR.Person[id]["特效文字1"] = nil
			WAR.Person[id]["特效文字2"] = nil
			WAR.Person[id]["特效文字3"] = nil
			WAR.Person[id]["特效文字4"] = nil
			WAR.Person[id]["特效文字8"] = nil
			WAR.Person[id]["特效动画"] = -1
	
			WAR.Person[hit_YQDXQ]["特效动画"] = 6
			for i = 1, 40 do
			DrawStrBox(-1, 24, "北斗有情断迅拳", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(20)
		    end
			for i = 0, CC.WarWidth - 1 do
				for j = 0, CC.WarHeight - 1 do
					local pre_effect = GetWarMap(i, j, 4)
					if pre_effect > 0 then
						local pre_target = GetWarMap(i, j, 2)
						pre_target_num = pre_target_num + 1
						pre_target_list[pre_target_num] = {i, j, pre_target, pre_effect}
					end
				end
			end
			CleanWarMap(4, 0)
			local s1 = WAR.CurID
			WAR.CurID = hit_YQDXQ
            local fac = 1.5
			local pid = WAR.Person[WAR.CurID]["人物编号"]
			local power = get_skill_power(pid, 24, 11)
				local h = math.modf(power/3+JY.Person[pid]["拳掌功夫"]*0.7)+math.random(10)
				if WAR.BJ == 1 then
				   
				   --怒涛海潮，会心一击暴击效果+50%
	                            if (Curr_NG(pid, 177) or PersonKF(pid, 172)) and WAR.HXZYJ == 1 then
		                           fac = fac + 0.5
	                            end
	                            --逆运经脉，暴击效果+20%
	                            if Curr_NG(pid, 104) then
		                           fac = fac + 0.2
								   if JY.Person[pid]["天赋内功"] == 104 then
								      fac = fac + 0.2
								   end
								   
								   if tg ~= 1 then
	                                  if fx < 0 then
	                                     fac = fac - fx*0.01
	                                  end  
	                               else
	                                     fac = fac - yin*0.01
	                               end
	                            end
								if JY.Person[pid]["专2"] == 104 and PersonKF(pid, 104) then
		                           fac = fac + 0.2
		                        end
								if JY.Person[60]["阶"] >= 3 and match_ID(pid, 60) then
		                           fac = fac + 0.5
		                        end
								if JY.Person[81]["阶"] >= 1 and match_ID(pid, 81) then
		                           fac = fac + 0.1*JY.Person[81]["阶"]^2 + 0.2
		                        end
								if JY.Person[pid]["人33"] == 1 then
	                               fac = fac + 0.2
	                            end
								if JY.Person[pid]["地2"] == 8 then
		                           fac = fac + 0.03*JY.Person[124]["天1"] + 0.3
		                        end
								if PersonKF(pid, 104) and PersonKF(pid, 95) then
				                   fac = fac + 0.1
			                    end
				   h = math.modf(h*fac)
				end
				SetWarMap(WAR.Person[s1]["坐标X"], WAR.Person[s1]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				WAR.Person[s1]["生命点数"] = (WAR.Person[s1]["生命点数"] or 0) - h;
				--无酒不欢：记录人物血量
				WAR.Person[s1]["Life_Before_Hit"] = JY.Person[WAR.Person[s1]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[s1]["人物编号"]]["生命"] = JY.Person[WAR.Person[s1]["人物编号"]]["生命"] - h
							if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] < 1 then
							   JY.Person[WAR.Person[s1]["人物编号"]]["生命"] = 1
							end
			local eft = 42
			War_ShowFight(WAR.Person[hit_YQDXQ]["人物编号"], 0, 0, 0, 0, 0, eft, -1)

			WAR.Person[hit_YQDXQ]["特效动画"] = -1
			WAR.ACT = 10
			--如果被上一步反击死亡，那么该人物的攻击就结束了
			if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] <= 1 then
			   WAR.Person[s1]["死亡"] = true
				return 1
			else		
				WAR.CurID = s1
				CleanWarMap(4, 0)
				WAR.Effect = 0
				for i = 1, pre_target_num do
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 2, pre_target_list[i][3])
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 4, pre_target_list[i][4])
				end
				WAR.Person[id]["特效文字0"] = tx_1
				WAR.Person[id]["特效文字1"] = tx_2
				WAR.Person[id]["特效文字2"] = tx_3
				WAR.Person[id]["特效文字3"] = tx_4
				WAR.Person[id]["特效文字4"] = tx_5
				WAR.Person[id]["特效文字5"] = tx_6
				WAR.Person[id]["特效文字6"] = tx_8
				WAR.Person[id]["特效动画"] =  tx_7
			end
			
		end
	end
	
	 --无酒不欢：小无相功的先手反击
	if WAR.ACT == 1 and math.random(20) > 15 then
		local hit_XWXG;
		local eid
		WAR.XWXGNAME=JY.Wugong[wugong]["名称"]
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and (Curr_NG(WAR.Person[emeny]["人物编号"], 98) or (PersonKF(WAR.Person[emeny]["人物编号"], 98) and JY.Person[WAR.Person[emeny]["人物编号"]]["专2"] == 98)) and WAR.Person[WAR.CurID]["死亡"] == false and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
							hit_XWXG = emeny
							eid = WAR.Person[emeny]["人物编号"]
							break;
						end
					end
				end
			end
			if hit_XWXG ~= nil then
				break;
			end
			
		end
		
		if hit_XWXG ~= nil then
			local pre_target_list = {}
			local pre_target_num = 0
			local tx_1 = WAR.Person[id]["特效文字0"] or nil
			local tx_2 = WAR.Person[id]["特效文字1"] or nil
			local tx_3 = WAR.Person[id]["特效文字2"] or nil
			local tx_4 = WAR.Person[id]["特效文字3"] or nil
			local tx_5 = WAR.Person[id]["特效文字4"] or nil
			local tx_6 = WAR.Person[id]["特效文字5"] or nil
			local tx_8 = WAR.Person[id]["特效文字6"] or nil
			local tx_7 = WAR.Person[id]["特效动画"]
			WAR.Person[id]["特效文字0"] = nil
			WAR.Person[id]["特效文字1"] = nil
			WAR.Person[id]["特效文字2"] = nil
			WAR.Person[id]["特效文字3"] = nil
			WAR.Person[id]["特效文字4"] = nil
			WAR.Person[id]["特效文字8"] = nil
			WAR.Person[id]["特效动画"] = -1
			WAR.hit_XWXG = 1
			WAR.XWXGSB[eid] = 1
			WAR.Person[hit_XWXG]["特效动画"] = 74
			for i = 0, CC.WarWidth - 1 do
				for j = 0, CC.WarHeight - 1 do
					local pre_effect = GetWarMap(i, j, 4)
					if pre_effect > 0 then
						local pre_target = GetWarMap(i, j, 2)
						pre_target_num = pre_target_num + 1
						pre_target_list[pre_target_num] = {i, j, pre_target, pre_effect}
					end
				end
			end
			CleanWarMap(4, 0)
			local s1 = WAR.CurID
			WAR.CurID = hit_XWXG
			local nydx = {}
			local nynum = 1
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					nydx[nynum] = i
					nynum = nynum + 1
				end
			end
			
			--反弹的人
			local nyft = nydx[math.random(nynum - 1)]
			local h = 0;
			local pid = WAR.Person[WAR.CurID]["人物编号"]
			local eid = WAR.Person[nyft]["人物编号"]
			if  WAR.L_XWXGFT[WAR.Person[nyft]["人物编号"]] == nil then
				h = math.modf(JY.Wugong[wugong]["攻击力10"]/5) + math.modf(Xishu_sum(pid)/2.5) + math.random(10)
				if match_ID(WAR.Person[hit_XWXG]["人物编号"], 103) and JY.Person[103]["阶"] >= 3 then
				   h = h + 200
				end
				SetWarMap(WAR.Person[nyft]["坐标X"], WAR.Person[nyft]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				WAR.L_XWXGFT[WAR.Person[nyft]["人物编号"]] = 1;
				
				WAR.Person[nyft]["生命点数"] = (WAR.Person[nyft]["生命点数"] or 0) - h;
				--无酒不欢：记录人物血量
				WAR.Person[nyft]["Life_Before_Hit"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] - h
							if JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] < 1 then
							JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = 1
							end
					end
			local eft = math.random(100)
			War_ShowFight(WAR.Person[hit_XWXG]["人物编号"], 0, 0, 0, 0, 0, eft, -1)
			WAR.hit_XWXG = 0
			WAR.Person[hit_XWXG]["特效动画"] = -1
			
			--如果被上一步反击死亡，那么该人物的攻击就结束了
			if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] <= 0 then
				return 1
			else		
				WAR.CurID = s1
				CleanWarMap(4, 0)
				WAR.Effect = 0
				for i = 1, pre_target_num do
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 2, pre_target_list[i][3])
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 4, pre_target_list[i][4])
				end
				WAR.Person[id]["特效文字0"] = tx_1
				WAR.Person[id]["特效文字1"] = tx_2
				WAR.Person[id]["特效文字2"] = tx_3
				WAR.Person[id]["特效文字3"] = tx_4
				WAR.Person[id]["特效文字4"] = tx_5
				WAR.Person[id]["特效文字5"] = tx_6
				WAR.Person[id]["特效文字6"] = tx_8
				WAR.Person[id]["特效动画"] =  tx_7
			end
		end
	end
	--睡梦罗汉拳
	if WAR.ACT == 1 and math.random(31) > 23 then
		local hit_LHLJ
		local eid
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] 
						and ((PersonKF(WAR.Person[emeny]["人物编号"], 1) and JY.Person[WAR.Person[emeny]["人物编号"]]["专1"] == 1) or (match_ID(WAR.Person[emeny]["人物编号"], 692) and JY.Person[692]["声望"] == 1)) 
						and WAR.Person[WAR.CurID]["死亡"] == false and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
							hit_LHLJ = emeny
							eid = WAR.Person[emeny]["人物编号"]
							break;
						end
					end
				end
			end
			if hit_LHLJ ~= nil then
				break;
			end
			
		end
		
		if hit_LHLJ ~= nil then
			local pre_target_list = {}
			local pre_target_num = 0
			local tx_1 = WAR.Person[id]["特效文字0"] or nil
			local tx_2 = WAR.Person[id]["特效文字1"] or nil
			local tx_3 = WAR.Person[id]["特效文字2"] or nil
			local tx_4 = WAR.Person[id]["特效文字3"] or nil
			local tx_5 = WAR.Person[id]["特效文字4"] or nil
			local tx_6 = WAR.Person[id]["特效文字5"] or nil
			local tx_8 = WAR.Person[id]["特效文字6"] or nil
			local tx_7 = WAR.Person[id]["特效动画"]
			WAR.Person[id]["特效文字0"] = nil
			WAR.Person[id]["特效文字1"] = nil
			WAR.Person[id]["特效文字2"] = nil
			WAR.Person[id]["特效文字3"] = nil
			WAR.Person[id]["特效文字4"] = nil
			WAR.Person[id]["特效文字8"] = nil
			WAR.Person[id]["特效动画"] = -1
			WAR.hit_LHLJ = 1
			WAR.SMLHSB[eid] = 1
			WAR.Person[hit_LHLJ]["特效动画"] = 88
			for i = 0, CC.WarWidth - 1 do
				for j = 0, CC.WarHeight - 1 do
					local pre_effect = GetWarMap(i, j, 4)
					if pre_effect > 0 then
						local pre_target = GetWarMap(i, j, 2)
						pre_target_num = pre_target_num + 1
						pre_target_list[pre_target_num] = {i, j, pre_target, pre_effect}
					end
				end
			end
			CleanWarMap(4, 0)
			local s1 = WAR.CurID
			WAR.CurID = hit_LHLJ
            local fac = 1.5
			local pid = WAR.Person[WAR.CurID]["人物编号"]
			local power = get_skill_power(pid, 1, 11)
				local h = math.modf(power/5)+math.random(10)
				if JY.Person[681]["天4"] == 2 and match_ID(pid, 681) then
				   h = math.modf(h*1.75)
				   if WAR.MXD[pid] ~= nil then
				   h = math.modf(h*2.5)
				   end
				end
				if JY.Person[682]["天3"] == 2 and match_ID(pid, 682) then
				   h = math.modf(h*1.75)
				end
				if match_ID(pid, 692) and JY.Person[692]["声望"] == 1 then
				   h = h*2
				end
				if WAR.BJ == 1 then
				   
				   --怒涛海潮，会心一击暴击效果+50%
	                            if (Curr_NG(pid, 177) or PersonKF(pid, 172)) and WAR.HXZYJ == 1 then
		                           fac = fac + 0.5
	                            end
	                            --逆运经脉，暴击效果+20%
	                            if Curr_NG(pid, 104) then
		                           fac = fac + 0.2
								   if JY.Person[pid]["天赋内功"] == 104 then
								      fac = fac + 0.2
								   end
								   
								   if tg ~= 1 then
	                                  if fx < 0 then
	                                     fac = fac - fx*0.01
	                                  end  
	                               else
	                                     fac = fac - yin*0.01
	                               end
	                            end
								if JY.Person[pid]["专2"] == 104 and PersonKF(pid, 104) then
		                           fac = fac + 0.2
		                        end
								if JY.Person[60]["阶"] >= 3 and match_ID(pid, 60) then
		                           fac = fac + 0.5
		                        end
								if JY.Person[81]["阶"] >= 1 and match_ID(pid, 81) then
		                           fac = fac + 0.1*JY.Person[81]["阶"]^2 + 0.2
		                        end
								if JY.Person[pid]["人33"] == 1 then
	                               fac = fac + 0.20
	                            end
								if JY.Person[pid]["地2"] == 8 then
		                           fac = fac + 0.03*JY.Person[124]["天1"] + 0.3
		                        end
								if PersonKF(pid, 104) and PersonKF(pid, 95) then
				                   fac = fac + 0.1
			                    end
				   h = math.modf(h*fac)
				end
				SetWarMap(WAR.Person[s1]["坐标X"], WAR.Person[s1]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				WAR.Person[s1]["生命点数"] = (WAR.Person[s1]["生命点数"] or 0) - h;
				--无酒不欢：记录人物血量
				WAR.Person[s1]["Life_Before_Hit"] = JY.Person[WAR.Person[s1]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[s1]["人物编号"]]["生命"] = JY.Person[WAR.Person[s1]["人物编号"]]["生命"] - h
							if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] < 1 then
							   JY.Person[WAR.Person[s1]["人物编号"]]["生命"] = 1
							end
			local eft = 12
			War_ShowFight(WAR.Person[hit_LHLJ]["人物编号"], 0, 0, 0, 0, 0, eft, -1)
			WAR.hit_LHLJ = 0
			WAR.Person[hit_LHLJ]["特效动画"] = -1
			
			--如果被上一步反击死亡，那么该人物的攻击就结束了
			if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] <= 1 then
			   WAR.Person[s1]["死亡"] = true
				return 1
			else		
				WAR.CurID = s1
				CleanWarMap(4, 0)
				WAR.Effect = 0
				for i = 1, pre_target_num do
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 2, pre_target_list[i][3])
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 4, pre_target_list[i][4])
				end
				WAR.Person[id]["特效文字0"] = tx_1
				WAR.Person[id]["特效文字1"] = tx_2
				WAR.Person[id]["特效文字2"] = tx_3
				WAR.Person[id]["特效文字3"] = tx_4
				WAR.Person[id]["特效文字4"] = tx_5
				WAR.Person[id]["特效文字5"] = tx_6
				WAR.Person[id]["特效文字6"] = tx_8
				WAR.Person[id]["特效动画"] =  tx_7
			end
		end
	end
	--傲寒六诀
	if WAR.ACT == 1 and math.random(30) > 13 and JY.Base["天书数量"] >= 7 then
		local hit_AHLJ
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and PersonKF(WAR.Person[emeny]["人物编号"], 217) and WAR.Person[WAR.CurID]["死亡"] == false and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
							hit_AHLJ= emeny
							break;
						end
					end
				end
			end
			if hit_AHLJ~= nil then
				break;
			end
			
		end
		
		if hit_AHLJ~= nil then
			local pre_target_list = {}
			local pre_target_num = 0
			local tx_1 = WAR.Person[id]["特效文字0"] or nil
			local tx_2 = WAR.Person[id]["特效文字1"] or nil
			local tx_3 = WAR.Person[id]["特效文字2"] or nil
			local tx_4 = WAR.Person[id]["特效文字3"] or nil
			local tx_5 = WAR.Person[id]["特效文字4"] or nil
			local tx_6 = WAR.Person[id]["特效文字5"] or nil
			local tx_8 = WAR.Person[id]["特效文字6"] or nil
			local tx_7 = WAR.Person[id]["特效动画"]
			WAR.Person[id]["特效文字0"] = nil
			WAR.Person[id]["特效文字1"] = nil
			WAR.Person[id]["特效文字2"] = nil
			WAR.Person[id]["特效文字3"] = nil
			WAR.Person[id]["特效文字4"] = nil
			WAR.Person[id]["特效文字8"] = nil
			WAR.Person[id]["特效动画"] = -1
			WAR.hit_AHLJ = 1
			WAR.Person[hit_AHLJ]["特效动画"] = 136
			for i = 0, CC.WarWidth - 1 do
				for j = 0, CC.WarHeight - 1 do
					local pre_effect = GetWarMap(i, j, 4)
					if pre_effect > 0 then
						local pre_target = GetWarMap(i, j, 2)
						pre_target_num = pre_target_num + 1
						pre_target_list[pre_target_num] = {i, j, pre_target, pre_effect}
					end
				end
			end
			CleanWarMap(4, 0)
			local s1 = WAR.CurID
			WAR.CurID = hit_AHLJ
            local fac = 1.5
			local pid = WAR.Person[WAR.CurID]["人物编号"]
			local power = get_skill_power(pid, 219, 11)
				local h = math.modf(power/4)+math.random(25)
				if JY.Person[681]["天4"] == 2 and match_ID(pid, 681) then
				   h = math.modf(h*1.75)
				   if WAR.MXD[pid] ~= nil then
				   h = math.modf(h*2.5)
				   end
				end
				if JY.Person[682]["天3"] == 2 and match_ID(pid, 682) then
				   h = math.modf(h*1.75)
				end
				if WAR.BJ == 1 then
				   
				   --怒涛海潮，会心一击暴击效果+50%
	                            if (Curr_NG(pid, 177) or PersonKF(pid, 172)) and WAR.HXZYJ == 1 then
		                           fac = fac + 0.5
	                            end
	                            --逆运经脉，暴击效果+20%
	                            if Curr_NG(pid, 104) then
		                           fac = fac + 0.2
								   if JY.Person[pid]["天赋内功"] == 104 then
								      fac = fac + 0.2
								   end
								   
								   if tg ~= 1 then
	                                  if fx < 0 then
	                                     fac = fac - fx*0.01
	                                  end  
	                               else
	                                     fac = fac - yin*0.01
	                               end
	                            end
								if JY.Person[pid]["专2"] == 104 and PersonKF(pid, 104) then
		                           fac = fac + 0.2
		                        end
								if JY.Person[60]["阶"] >= 3 and match_ID(pid, 60) then
		                           fac = fac + 0.5
		                        end
								if JY.Person[81]["阶"] >= 1 and match_ID(pid, 81) then
		                           fac = fac + 0.1*JY.Person[81]["阶"]^2 + 0.2
		                        end
								if JY.Person[pid]["人33"] == 1 then
	                               fac = fac + 0.20
	                            end
								if JY.Person[pid]["地2"] == 8 then
		                           fac = fac + 0.03*JY.Person[124]["天1"] + 0.3
		                        end
								if PersonKF(pid, 104) and PersonKF(pid, 95) then
				                   fac = fac + 0.1
			                    end
				   h = math.modf(h*fac)
				end
				SetWarMap(WAR.Person[s1]["坐标X"], WAR.Person[s1]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				WAR.Person[s1]["生命点数"] = (WAR.Person[s1]["生命点数"] or 0) - h;
				--无酒不欢：记录人物血量
				WAR.Person[s1]["Life_Before_Hit"] = JY.Person[WAR.Person[s1]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[s1]["人物编号"]]["生命"] = JY.Person[WAR.Person[s1]["人物编号"]]["生命"] - h
							if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] < 1 then
							   JY.Person[WAR.Person[s1]["人物编号"]]["生命"] = 1
							end
			local eft = 69
			War_ShowFight(WAR.Person[hit_AHLJ]["人物编号"], 0, 0, 0, 0, 0, eft, -1)
			WAR.hit_AHLJ= 0
			WAR.Person[hit_AHLJ]["特效动画"] = -1
			
			--如果被上一步反击死亡，那么该人物的攻击就结束了
			if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] <= 1 then
			   WAR.Person[s1]["死亡"] = true
				return 1
			else		
				WAR.CurID = s1
				CleanWarMap(4, 0)
				WAR.Effect = 0
				for i = 1, pre_target_num do
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 2, pre_target_list[i][3])
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 4, pre_target_list[i][4])
				end
				WAR.Person[id]["特效文字0"] = tx_1
				WAR.Person[id]["特效文字1"] = tx_2
				WAR.Person[id]["特效文字2"] = tx_3
				WAR.Person[id]["特效文字3"] = tx_4
				WAR.Person[id]["特效文字4"] = tx_5
				WAR.Person[id]["特效文字5"] = tx_6
				WAR.Person[id]["特效文字6"] = tx_8
				WAR.Person[id]["特效动画"] =  tx_7
			end
		end
	end
	
	        for i = 0,WAR.PersonNum -1 do 
            local mid = WAR.Person[i]['人物编号']

            if (TaohuaJJ(mid) or match_ID(mid, 57)) and (math.abs(x0-WAR.Person[i]['坐标X']) + math.abs(y0-WAR.Person[i]['坐标Y'])) and WAR.JESS[mid] == nil and wugong ~= 231 then
                local jl = 10
				if JY.Person[57]["阶"] >= 2 then
				   jl = 25
				end
                if WAR.Person[i]['死亡'] == false and GetWarMap(WAR.Person[i]['坐标X'],WAR.Person[i]['坐标Y'],4) > 0 and i ~= WAR.CurID and JLSD(0,jl,mid) then
	local nx,ny = nil,nil
	local id = WAR.Person[i]['人物编号']
	local lx = 0
    local at = WAR.CurID
	local bs = 3
		local menu = {}
		local menu2 = {}
		War_CalMoveStep(i, bs, lx)
		local xi,yi = WAR.Person[i]['坐标X'],WAR.Person[i]['坐标Y']
		--记录所有可以移动的坐标
		for ix = limitX(xi-bs,0,xi),limitX(xi+bs,xi,62) do 
			for iy = limitX(yi-bs,0,yi), limitX(yi+bs,yi,62) do 
				if GetWarMap(ix, iy, 3) ~= 255 and GetWarMap(ix, iy, 2) < 0 and GetWarMap(ix, iy, 4) <= 0 then 
				   menu[#menu+1] = {ix,iy}
				end
			end 
		end
		if #menu > 0 then 
		   local a = math.random(#menu)
			nx = menu[a][1]
			ny = menu[a][2]
		end
		if nx ~= nil and ny ~= nil then 
	    PlayWavE(5)
        WAR.CurID = i
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 89,1, "奇门五转")
	    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
	    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
	    WarDrawMap(0)
	    WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
	    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
	    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
	    CurIDTXDH(WAR.CurID, 89,1, "奇门五转")   
    WAR.CurID = at
	end
end
end
end

	
	
	--李秋水无相转身，没有触发过，或者分身已死，才可触发，有30%几率触发
	if (WAR.WXFS == nil or (WAR.WXFS ~= nil and WAR.Person[WAR.WXFS]["死亡"] == true)) and math.random(10) < 4 then
		local lqs_WXZS;
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						--仅限畅想主角触发
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 118) and WAR.Person[emeny]["人物编号"] == 0 then
							lqs_WXZS = emeny
							SetWarMap(i, j, 4, 0)
							break;
						end
					end
				end
			end
		end
		
		if lqs_WXZS ~= nil then
			
			--ID临时交给李秋水
			local s = WAR.CurID
			WAR.CurID = lqs_WXZS
			local wxlox, wxloy;
			War_CalMoveStep(WAR.CurID, 10, 0)
			local function SelfXY(x, y)
				local yes = 0
				if x == WAR.Person[WAR.CurID]["坐标X"] then
					yes = yes +1
				end
				if y == WAR.Person[WAR.CurID]["坐标Y"] then
					yes = yes +1
				end
				if yes == 2 then
					return true
				end
				return false
			end
	        local x, y = nil, nil
	        while true do
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					wxlox, wxloy = x, y
					break;
				--ESC退出
				else
					WAR.ShowHead = 0
					x, y = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
					--wxlox, wxloy = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
					break;
				end
			end
			--不在自身位置才能触发幻象
			if SelfXY(x, y) == false then
				SetWarMap(wxlox, wxloy, 4, 0)
				--本场还没触发过无相转身，则加入新人物
				if WAR.WXFS == nil then
					WAR.Person[WAR.PersonNum]["人物编号"] = 600
					WAR.Person[WAR.PersonNum]["我方"] = WAR.Person[WAR.CurID]["我方"]
					WAR.Person[WAR.PersonNum]["坐标X"] = wxlox
					WAR.Person[WAR.PersonNum]["坐标Y"] = wxloy
					WAR.Person[WAR.PersonNum]["死亡"] = false
					WAR.Person[WAR.PersonNum]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
					WAR.Person[WAR.PersonNum]["贴图"] = WarCalPersonPic(WAR.PersonNum)
					lib.PicLoadFile(string.format(CC.FightPicFile[1], JY.Person[600]["头像代号"]), string.format(CC.FightPicFile[2], JY.Person[600]["头像代号"]), 4 + WAR.PersonNum)
					WAR.tmp[5000+WAR.PersonNum] = JY.Person[600]["头像代号"]
					WAR.JQSDXS[600] = 0	--直接指定集气，以免召唤出来马上被斗转跳出
					WAR.WXFS = WAR.PersonNum
					WAR.PersonNum = WAR.PersonNum + 1
				--已经触发过，则让分身复活e
				else
					WAR.Person[WAR.WXFS]["死亡"] = false
					WAR.Person[WAR.WXFS]["我方"] = WAR.Person[WAR.CurID]["我方"]
					WAR.Person[WAR.WXFS]["坐标X"] = wxlox
					WAR.Person[WAR.WXFS]["坐标Y"] = wxloy
					WAR.Person[WAR.WXFS]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
					WAR.Person[WAR.WXFS]["贴图"] = WarCalPersonPic(WAR.WXFS)
					JY.Person[600]["生命"] = JY.Person[600]["生命最大值"]
					JY.Person[600]["内力"] = JY.Person[600]["内力最大值"]
					JY.Person[600]["体力"] = 100
					JY.Person[600]["受伤程度"] = 0
					JY.Person[600]["中毒程度"] = 0
					JY.Person[600]["冰封程度"] = 0
					JY.Person[600]["灼烧程度"] = 0
					WAR.Person[WAR.WXFS].Time = 0
					--流血
					if WAR.LXZT[600] ~= nil then
						WAR.LXZT[600] = nil
					end
					--封穴
					if WAR.FXDS[600] ~= nil then
						WAR.FXDS[600] = nil
					end
				end
		  
				--清除自身位置贴图
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)

				--修改自身与幻象坐标
				WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"] = WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"],WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
					
				--增加幻象贴图
				SetWarMap(WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"], 5, WAR.Person[WAR.WXFS]["贴图"])
				SetWarMap(WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"], 2, WAR.WXFS)

				--增加自身贴图
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
			end
			WarDrawMap(0)
			CurIDTXDH(WAR.CurID, 90,1,"无相转身")
				
			--还原ID并打断连击
			WAR.CurID = s
			WAR.ACT = 10
		end
	end
	
	
	--左慈分身
	if WAR.ZCFS == nil and JY.Person[685]["阶"] >= 3 and math.random(10) <= 7 + JY.Base["天书数量"] then
		local lqs_WXZS;
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						--仅限畅想主角触发
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 685) and WAR.Person[emeny]["人物编号"] == 0 then
							lqs_WXZS = emeny
							SetWarMap(i, j, 4, 0)
							break;
						end
					end
				end
			end
		end
		
		if lqs_WXZS ~= nil then
			
			local s = WAR.CurID
			WAR.CurID = lqs_WXZS
			local wxlox, wxloy;
			War_CalMoveStep(WAR.CurID, 10, 0)
			local function SelfXY(x, y)
				local yes = 0
				if x == WAR.Person[WAR.CurID]["坐标X"] then
					yes = yes +1
				end
				if y == WAR.Person[WAR.CurID]["坐标Y"] then
					yes = yes +1
				end
				if yes == 2 then
					return true
				end
				return false
			end
	        local x, y = nil, nil
	        while true do
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					wxlox, wxloy = x, y
					break;
				--ESC退出
				else
					WAR.ShowHead = 0
					x, y = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
					--wxlox, wxloy = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
					break;
				end
			end
			--不在自身位置才能触发幻象
			if SelfXY(x, y) == false then
				SetWarMap(wxlox, wxloy, 4, 0)
				--本场还没触发过无相转身，则加入新人物
				if WAR.ZCFS == nil then
					WAR.Person[WAR.PersonNum]["人物编号"] = 0
					WAR.Person[WAR.PersonNum]["我方"] = WAR.Person[WAR.CurID]["我方"]
					WAR.Person[WAR.PersonNum]["坐标X"] = wxlox
					WAR.Person[WAR.PersonNum]["坐标Y"] = wxloy
					WAR.Person[WAR.PersonNum]["死亡"] = false
					WAR.Person[WAR.PersonNum]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
					WAR.Person[WAR.PersonNum]["贴图"] = WarCalPersonPic(WAR.PersonNum)
					lib.PicLoadFile(string.format(CC.FightPicFile[1], JY.Person[685]["头像代号"]), string.format(CC.FightPicFile[2], JY.Person[685]["头像代号"]), 4 + WAR.PersonNum)
					WAR.tmp[5000+WAR.PersonNum] = JY.Person[685]["头像代号"]
					WAR.ZCFS = WAR.PersonNum
					WAR.PersonNum = WAR.PersonNum + 1
				end
		  
				--清除自身位置贴图
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)

				--修改自身与幻象坐标
				WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], WAR.Person[WAR.ZCFS]["坐标X"], WAR.Person[WAR.ZCFS]["坐标Y"] = WAR.Person[WAR.ZCFS]["坐标X"], WAR.Person[WAR.ZCFS]["坐标Y"],WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
					
				--增加幻象贴图
				SetWarMap(WAR.Person[WAR.ZCFS]["坐标X"], WAR.Person[WAR.ZCFS]["坐标Y"], 5, WAR.Person[WAR.ZCFS]["贴图"])
				SetWarMap(WAR.Person[WAR.ZCFS]["坐标X"], WAR.Person[WAR.ZCFS]["坐标Y"], 2, WAR.ZCFS)

				--增加自身贴图
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
			end
			WarDrawMap(0)
			CurIDTXDH(WAR.CurID, 78,1,"分身法")
				
			--还原ID并打断连击
			WAR.CurID = s
			WAR.ACT = 10
		end
	end
	
	--登萍渡水根据打击人数增加伤害
	if Curr_QG(pid, 179) then
		local Dpds = 0
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
							Dpds = Dpds +1
						end
					end
				end
			end
		end
		WAR.DPDS = Dpds
	end

	--NPC弱化版登萍渡水根据打击人数增加伤害	
	if inteam(pid)==false then
		local Dpds2 = 0
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
							Dpds2= Dpds2 +1
						end
					end
				end
			end
		end
		WAR.DPDS2 = Dpds2
	end
	
	--豪鬼，根据人数获取能量
	if match_ID(pid, 673) then
		local Hnlz = 0
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
							Hnlz = Hnlz +1
						end
					end
				end
			end
		end
		WAR.HNLZ = Hnlz
	end
	
	--九阴摄魂误伤
	local curx,cury = WAR.Person[WAR.CurID]['坐标X'],WAR.Person[WAR.CurID]['坐标Y']
	for i = 0,WAR.PersonNum-1 do 
	    local xx,yy = WAR.Person[i]['坐标X'],WAR.Person[i]['坐标Y']
	    if WAR.Person[i]['人物编号'] == 0 and WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] then 
		   if math.abs(xx-curx) + math.abs(yy-cury) <= 14 and Curr_NG(WAR.Person[i]['人物编号'], 193) then 
		      WAR.JYSH = 1
			  WAR.WS = 0
			  break
		   end
		end
	end
	
    --计算伤害的敌人
    for i = 0, CC.WarWidth - 1 do
		for j = 0, CC.WarHeight - 1 do
			lib.GetKey()
			local effect = GetWarMap(i, j, 4)
			if 0 < effect then
				local emeny = GetWarMap(i, j, 2)
				if 0 <= emeny and emeny ~= WAR.CurID then		--如果有人，并且不是当前控制人
					local eid = WAR.Person[emeny]["人物编号"]
					--触发逆转乾坤的情况下，无误伤特效和合击依然会打到自己人
					if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] or (ZHEN_ID < 0 and WAR.WS == 0) or WAR.NZQK > 0 and WAR.JESS[eid] == nil then
						if JY.Wugong[wugong]["伤害类型"] == 1 and (fightscope == 0 or fightscope == 3) then
							if level == 11 then
								level = 10
							end
							--无酒不欢：这里需要完善修改
							--WAR.Person[emeny]["内力点数"] = (WAR.Person[emeny]["内力点数"] or 0) - War_WugongHurtNeili(emeny, wugong, level)
							
							--化功大法，内功停运200时序
							if wugong == 87 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
								WAR.PJZT[eid] = 200
								if WAR.PJJL[eid] == nil then
									WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
								end
								JY.Person[eid]["主运内功"] = 0
							end
							SetWarMap(i, j, 4, 3)
							WAR.Effect = 3
						else
							local dodge = 0
							if WAR.MMGJ == 1 then		--被刺目的闪避
								dodge = 1
							end
							
							if Curr_NG(eid, 105) then		--真葵花移形20%闪避
								--葵花尊者几率+10
								local c_up = 0
								if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and eid == 27 then
									c_up = 10
								end
								if JLSD(30, 47+c_up, eid) then
									dodge = 1
								end
							end
							if not inteam(eid) then
	                        local x = JY.Person[0]["感悟点"]*0.005+JY.Base["难度"]
	                           if math.random(100) < x then
	                           dodge = 1
	                           end
	                        end
							if match_ID(eid, 47) and JY.Person[47]["阶"] >= 2 then
							local jl = math.modf(((JY.Person[eid]["生命最大值"] - JY.Person[eid]["生命"])/JY.Person[eid]["生命最大值"])*50)
							    if math.random(100) < jl then
							    dodge = 1
							    end
							end
							if match_ID(eid, 56) and JY.Person[56]["阶"] >= 2 and math.random(100) < 21 then
							    dodge = 1
							end
							if match_ID(eid, 688) and JY.Person[688]["阶"] >= 2 and math.random(100) < 13 then
							    dodge = 1
							end
							if match_ID(eid, 90) and JY.Person[90]["阶"] >= 3 and math.random(100) < 21 then
							    dodge = 1
							end
							if WAR.TQLQ[eid] ~= nil and math.random(100) < 26 then
							   dodge = 1
							end
							if JY.Person[eid]["地8"] == 4 and JY.Person[0]["品德"] >= 90 and math.random(100) < 21 then
	                           dodge = 1
	                        end
							if JY.Person[604]["论剑奖励"] == 1 and pid == 0 and math.random(100) < 9 then
	                           dodge = 1
	                        end
							if JY.Person[637]["声望"] >= 6 and match_ID(eid, 637) and math.random(100) < 11 then
			                   dodge = 1
			                end
							if JY.Person[eid]["人15"] == 1 and math.random(100) < 13 then
	                           dodge = 1
	                        end
							if JY.Person[eid]["人25"] == 1 and math.random(100) < 7 then
	                           dodge = 1
	                        end
							if JY.Person[eid]["人26"] == 1 and math.random(100) < 7 then
	                           dodge = 1
	                        end
							if JY.Person[eid]["人32"] == 1 and math.random(100) < 6 then
	                           dodge = 1
	                        end
							if JY.Person[692]["声望"] == 1 and match_ID(eid, 692) and math.random(100) < 16 then
	                           dodge = 1
	                        end
							if match_ID(eid, 132) and (JY.Person[eid]["动物"] == 262 or JY.Person[eid]["动物"] == 349 or JY.Person[eid]["动物"] == 264 or JY.Person[eid]["动物"] == 284 or JY.Person[eid]["动物"] == 230) 
							and math.random(100) <= 15 then
							   dodge = 1
							end
							if Curr_QG(eid, 146) then				--神行百变20%几率闪避
								local c_up = 0
								if match_ID_awakened(eid, 54, 1) then	--袁承志觉醒后，闪避率+5%
									c_up = 5
								end
								if match_ID(eid, 184) then	--玉真子，闪避率+5%
									c_up = 5
								end
								if JLSD(50, 67+c_up, eid) then
									dodge = 1
									--WAR.Person[enemyid]["特效文字2"] = "神行百变"
									--WAR.Person[enemyid]["特效动画"] = 88
								end
							end
							if JY.Person[eid]["动物"] == 349 and math.random(100) <= 5 + JY.Thing[349]["装备等级"] then
				                 dodge = 1
			                end
							if match_ID(eid, 682) and math.random(100) <= 10 then
				                 dodge = 1
			                end
							if match_ID(eid, 684) and math.random(100) <= 15 then
				                 dodge = 1
			                end
							if match_ID(eid, 684) and JY.Person[684]["天2"] == 1 and math.random(100) <= 10 then
				                 dodge = 1
			                end
							if match_ID(eid, 636) and JLSD(50, 65, eid) then
				                 dodge = 1
			                end
							if match_ID(eid, 36) and JY.Person[36]["天3"] == 2 and math.random(100) <= 20 then
				                 dodge = 1
			                end
							if match_ID(eid, 676) and JY.Person[676]["天2"] == 2 and JY.Person[eid]["武器"] > 0 and JY.Person[eid]["防具"] < 0 and math.random(100) <= 30 then
				                 dodge = 1
			                end
							if Curr_QG(eid, 147) and (JLSD(50, 70, eid) or match_ID(eid, 53) and JLSD(40, 70, eid)) then		--凌波微步25%几率闪避
								dodge = 1
								--WAR.Person[enemyid]["特效文字2"] = "凌波微步"
								--WAR.Person[enemyid]["特效动画"] = 90
							end
							if PersonKF(eid, 147) and JY.Person[eid]["专1"] == 147 and math.random(100) > 91 then
								dodge = 1
							end
							--柯镇恶
	                        if match_ID(eid, 130) and JY.Person[eid]["生命"] < math.modf(JY.Person[eid]["生命最大值"]*0.3) and JLSD(50, 60, eid) then
		                       dodge = 1
	                        end
							if JY.Person[634]["天3"] == 1 and match_ID(eid, 634) and math.random(100) > 77 then
							   dodge = 1
							end
							if eid == 0 and JY.Person[0]["天3"] == 1 and JLSD(50, 63, eid) then
							   dodge = 1
							end
							if match_ID(eid, 681) and JY.Person[681]["天1"] == 2 and math.random(100) <= 15 then
							   dodge = 1
							end
							if match_ID(eid, 688) and JY.Person[688]["天3"] == 2 and math.random(100) <= 12 then
							   dodge = 1
							end
							if match_ID(eid, 88) then		--祖千秋，30%闪避
							local c = 65
							c = c + JY.Person[88]["阶"]*15
							    if JLSD(35, c, eid) then
								dodge = 1
								end
								--WAR.Person[enemyid]["特效文字2"] = "酒神秘踪步"	
								--WAR.Person[enemyid]["特效动画"] = 89
							end
							if JY.Base["特殊"] ==1 and JY.Person[21]["血量翻倍"]==1 and eid==0 and JLSD(35, 65, eid) then		--无酒不欢 酒神秘踪步
								dodge = 1
								--WAR.Person[enemyid]["特效文字2"] = "酒神秘踪步"	
								--WAR.Person[enemyid]["特效动画"] = 89
							end
							if match_ID(eid, 53) and WAR.TZ_DY == 1 and JLSD(20, 80, eid) then		--段誉 指令，70%闪避
								dodge = 1
								--WAR.Person[enemyid]["特效文字2"] = "凌波微步"
								--WAR.Person[enemyid]["特效动画"] = 90
							end
							if WAR.Person[emeny]["我方"] == true and GetWarMap(WAR.Person[emeny]["坐标X"], WAR.Person[emeny]["坐标Y"],6) == 4 and JLSD(30, 60, eid) then	--黄蓉奇门遁甲，紫色，30%闪避
								dodge = 1
							end
							if WAR.TSSB[eid] ~= nil and JLSD(40, 60, eid) then	--进阶泰山，使用后30时序内闪避
								dodge = 1
								--WAR.Person[enemyid]["特效文字2"] = "峻岭横空"
								--WAR.Person[enemyid]["特效动画"] = 89
							end
							--赵敏在场，此方防御时20%几率闪避
							local ZM = {0}
							if inteam(eid) then
								for z = 0, WAR.PersonNum - 1 do
									local zid = WAR.Person[z]["人物编号"]
									if WAR.Person[z]["死亡"] == false and match_ID(zid, 609) then
										ZM[1] = 1
										ZM[2] = WAR.Person[z]["我方"]
										break
									end
								end
							end
							if ZM[1] == 1 and ZM[2] == WAR.Person[emeny]["我方"] then
								if WAR.Defup[eid] == 1 and JLSD(40, 60, eid) then
									dodge = 1
								end
							end
							if Curr_QG(eid, 180) and math.random(100) < 16 and JY.Person[eid]["生命"] > 0 and match_ID(pid, 689) == false then		--暗香月影20%几率闪避，LiangJC:人物死亡不触发
								dodge = 1
								if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then	--队友不触发反击和断连
									if JY.Person[eid]["体力"] > 10 and WAR.JESS[eid] == nil then
										WAR.AXYY[emeny] = eid
									end
									WAR.ACT = 10
								end
							end
							if WAR.XWXGSB[eid] == 1 and JY.Person[eid]["生命"] > 0 then	--小无相功闪避
								dodge = 1
								WAR.XWXGSB[eid] = 0
							end
							if WAR.SMLHSB[eid] == 1 and JY.Person[eid]["生命"] > 0 then
								dodge = 1
								WAR.SMLHSB[eid] = nil
							end
							--主角 特系，初始15%闪避，每个奇门练到极，增加5%闪避
							if JY.Base["标准"] == 5 and eid == 0 then
								local gctj = 15
								for i = 1, JY.Person[671]["品德"] do
									if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 5 and JY.Person[0]["武功等级" .. i] == 999 then
										gctj = gctj + 5
									end
								end
								if gctj > 50 then
									gctj = 50
								end
								if JLSD(30, 30 + gctj, eid) then
									dodge = 1
									--WAR.Person[enemyid]["特效文字1"] = "天机身法"
									--WAR.Person[enemyid]["特效动画"] = 88
								end
							end
							--无酒不欢 奇门无双
							if JY.Base["特殊"] ==1 and JY.Person[20]["血量翻倍"]==1 and eid==0 then
								local gctj = 15
								for i = 1, JY.Person[671]["品德"] do
									if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 5 and JY.Person[0]["武功等级" .. i] == 999 then
										gctj = gctj + 1
									end
								end
								if JLSD(30, 30 + gctj, eid) then
									dodge = 1
									--WAR.Person[enemyid]["特效文字1"] = "天机身法"
									--WAR.Person[enemyid]["特效动画"] = 88
								end
							end
							--千剑归宗
							if wugong == 187 then
								
								local dam
								dam = First_strike_dam_DG(pid, eid)
								if dam > 0 then
									WAR.Person[emeny]["Life_Before_Hit"] = JY.Person[eid]["生命"]
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - dam
									JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - dam
									if JY.Person[eid]["生命"] < 0 then
										JY.Person[eid]["生命"] = 0
									end
									
								end
							end
							--万剑诀
							if match_ID(pid, 655) and wugong == 194 then
								local dam
								dam = First_strike_dam_WJJ(pid, eid)
								if dam > 0 then
									WAR.Person[emeny]["Life_Before_Hit"] = JY.Person[eid]["生命"]
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - dam
									JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - dam
									if JY.Person[eid]["生命"] < 0 then
										JY.Person[eid]["生命"] = 0
									end
								end
							end
							--万剑归宗
							if wugong == 198 then
								local dam
								dam = First_strike_dam_WM(pid, eid)
								local fac = 1.5
	                            --怒涛海潮，会心一击暴击效果+50%
	                            if (Curr_NG(pid, 177) or PersonKF(pid, 172)) and WAR.HXZYJ == 1 then
		                           fac = fac + 0.5
	                            end
	                            --逆运经脉，暴击效果+20%
	                            if Curr_NG(pid, 104) then
		                           fac = fac + 0.2
								   if JY.Person[pid]["天赋内功"] == 104 then
								      fac = fac + 0.2
								   end
								   
								   if tg ~= 1 then
	                                  if fx < 0 then
	                                     fac = fac - fx*0.01
	                                  end  
	                               else
	                                     fac = fac - yin*0.01
	                               end
	                            end
								if JY.Person[pid]["专2"] == 104 and PersonKF(pid, 104) then
		                           fac = fac + 0.2
		                        end
								if JY.Person[60]["阶"] >= 3 and match_ID(pid, 60) then
		                           fac = fac + 0.5
		                        end
								if JY.Person[81]["阶"] >= 1 and match_ID(pid, 81) then
		                           fac = fac + 0.1*JY.Person[81]["阶"]^2 + 0.2
		                        end
								if JY.Person[pid]["人33"] == 1 then
	                               fac = fac + 0.20
	                            end
								if JY.Person[pid]["地2"] == 8 then
		                           fac = fac + 0.03*JY.Person[124]["天1"] + 0.3
		                        end
								if PersonKF(pid, 104) and PersonKF(pid, 95) then
				                   fac = fac + 0.1
			                    end
								if WAR.BJ == 1 then
								   dam = dam+dam*(fac-1)*Person_BJ(pid)*0.01
								end
								if match_ID(pid, 671) and JY.Person[671]["阶"] >= 2 then
	                               dam = dam + math.modf(TrueYJ(pid)*0.001)
	                            end
								local n = 0
		                        for i = 0, WAR.PersonNum - 1 do
			                        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				                         n = n + 1
			                        end
		                        end
						        if n == 1 then
								   dam = dam * 1.2
								end
								
								local ma = math.floor(dam*1.1)
								local mi = math.floor(dam*0.6)
								for i = 0, math.ceil(100/n) do
									WAR.Person[emeny]["Life_Before_Hit"] = JY.Person[eid]["生命"]
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - math.random(mi, ma)
									JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - math.random(mi, ma)
									if JY.Person[eid]["生命"] < 0 then
										JY.Person[eid]["生命"] = 0
									end
								end
							end
														
							--张角
							if match_ID(eid, 694) and dodge == 0 then
							local jl = (GetTeamNum() - 1)*3
							if JY.Base["天书数量"] >= 14 then
	                           jl = 45
	                        end
							if WAR.ZJSB[eid] ~= nil then
							   jl = jl + WAR.ZJSB[eid]
							end
							if math.random(100) <= jl then
							   dodge = 1
							end
							end
							--zj
							if JY.Person[694]["天2"] == 1 and math.random(100) <= 20 then
							   dodge = 1
							end

							--无酒不欢：命中统一结算
							if dodge == 1 then
							local dg = 5
							if (match_ID(pid, 694) or match_ID(eid, 694)) and JY.Person[694]["天2"] == 2 then
							   dg = dg + 70
							end
							if math.random(100) >= dg then
								--阿青听风辨位
								if match_ID(pid, 604) then
									dodge = 0
									Set_Eff_Text(WAR.CurID, "特效文字0", "听风辨位")
								elseif pid == 0 and JY.Person[604]["论剑奖励"] == 1 then
								    dodge = 0
								elseif match_ID(pid, 130) then
									dodge = 0
									Set_Eff_Text(WAR.CurID, "特效文字0", "回声定位")	
								elseif JY.Person[pid]["地4"] == 4 then
									dodge = 0
									Set_Eff_Text(WAR.CurID, "特效文字0", "百无一失")	
								--天罗地网
								elseif Curr_QG(pid,148) and JLSD(10, 85, pid) then
									dodge = 0
									Set_Eff_Text(WAR.CurID, "特效文字0", "天罗地网")
								elseif PersonKF(pid, 55) and PersonKF(pid, 189) and (wugong==189 or match_ID(pid, 29) and wugong == 55) then		--神刀斩：迎风一刀斩
									dodge = 0
									Set_Eff_Text(WAR.CurID, "特效文字0", "迎风一刀斩")
								--心念合一
								elseif WAR.Focus[pid] ~= nil then	
									dodge = 0	
									Set_Eff_Text(WAR.CurID, "特效文字0", "心念合一")
								elseif match_ID(pid, 670) and wugong == 197 then
                                    dodge = 0	
									Set_Eff_Text(WAR.CurID, "特效文字0", "五指山")
								elseif match_ID(pid, 23) and wugong == 31 and JY.Person[23]["阶"] >= 3 then
                                    dodge = 0
								elseif WAR.WKBP == 1 then
                                    dodge = 0
								    WAR.WKBP = 0	
								elseif match_ID(pid, 64) and wugong == 15 and JY.Person[64]["阶"] >= 2 then
                                    dodge = 0	
								elseif match_ID(pid, 52) and JY.Person[52]["阶"] >= 2 then
                                    dodge = 0	
								elseif match_ID(pid, 673) and wugong == 205 then
                                    dodge = 0
								elseif wugong == 221 and WAR.YSZZS == 2 then
                                    dodge = 0
								--达尔巴死战
								elseif match_ID(pid, 160) and WAR.SZSD == eid then
									dodge = 0
								elseif match_ID(pid, 689) then
									dodge = 0	
								elseif wugong == 199 and match_ID(pid, 671) and WAR.MMZS == 2 then --莫名其妙
								    dodge = 0
								elseif wugong == 217 and WAR.AHZS == 6 then
								    dodge = 0
								elseif wugong == 219 then
								    dodge = 0	
								elseif wugong == 214 then
								    dodge = 0
								elseif match_ID(pid, 687) and wugong == 49 and WAR.LMZS == 2 then
                                    dodge = 0
								elseif wugong == 125 and JY.Person[pid]["专1"] == 125 then
								    dodge = 0
								elseif wugong == 136 and JY.Person[pid]["专2"] == 136 then
								    dodge = 0	
								elseif match_ID(pid, 676) and JY.Person[676]["天2"] == 2 then
 								    dodge = 0
								elseif match_ID(pid, 683) and JY.Wugong[wugong]["武功类型"] == 3 then
 								    dodge = 0	
								--九阴被动，降低50%不命中率
								elseif PersonKF(pid, 107) and JLSD(10, 40, pid)  then
									dodge = 0
								elseif JY.Person[pid]["人23"] == 1 and JLSD(10, 35, pid)  then
									dodge = 0
								elseif JY.Person[pid]["人3"] == 1 and math.random(100) < 21 then
									dodge = 0
								elseif JY.Person[pid]["人9"] == 1 and math.random(100) < 21 then
									dodge = 0	
								elseif JY.Person[pid]["人24"] == 1 and JLSD(10, 30, pid)  then
									dodge = 0
								elseif WAR.GSTG[eid] ~= nil and math.random(100) <= 70 then	
								--剑二十三
								elseif WAR.JESS[eid] ~= nil then
								    dodge = 0
								elseif wugong == 10 and JY.Person[pid]["专1"] == 10 then
	   	                            dodge = 0
								elseif wugong == 184 and JY.Person[pid]["专2"] == 184 then
	   	                            dodge = 0
								end
								end
							end
							if WAR.MMGJ2 == 1 then		--被刺目的闪避
								dodge = 1
							end
								--独孤九剑
							if PersonKF(eid, 47) and WAR.KungfuLQ[eid][47] == nil and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and (math.random(950) <= JY.Person[eid]["资质"]) and (WAR.JJCD[eid] == 0 or WAR.JJCD[eid] == nil) and WAR.JESS[eid] == nil and wugong ~= 231 and JY.Wugong[wugong]["武功类型"] ~= 0 then
								local reaction = {"破掌式","总决式","破剑式","破刀式","破枪式","破气式",}
								local effect = 0
									effect = JY.Wugong[wugong]["武功类型"]
									WAR.Person[WAR.CurID]["特效动画"] = -1
									WAR.Person[WAR.CurID]["特效文字0"] = nil
									WAR.Person[WAR.CurID]["特效文字1"] = nil
									WAR.Person[WAR.CurID]["特效文字2"] = nil
									WAR.Person[WAR.CurID]["特效文字3"] = nil
									WAR.Person[WAR.CurID]["特效文字4"] = nil
									WAR.Person[WAR.CurID]["特效文字5"] = nil
									WAR.Person[WAR.CurID]["特效文字6"] = nil
							WAR.DPLJ = 0
							WAR.ZYHB = 0
							WAR.CLBF = 0
							WAR.HSSD = 0
							WAR.DZXY = 0
							WAR.ALH = 0
							WAR.AXFJ = 0
							WAR.ACT = 10
								WarDrawMap(0)
								if inteam(eid) then
									if DrawStrBoxYesNo(-1, -1, string.format(reaction[effect]), LimeGreen, CC.DefaultFont) then
										local z = WAR.CurID
										for j = 0, WAR.PersonNum - 1 do
											if WAR.Person[j]["人物编号"] == eid and 0 < JY.Person[j]["生命"] then
											WAR.CurID = j
											end		  	 
											if 995 < WAR.Person[WAR.CurID].Time then
											WAR.Person[WAR.CurID].Time = 995
											end
											WAR.Person[WAR.CurID].Time = 1005
											if WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] ~= nil then
											WAR.FXDS[WAR.Person[WAR.CurID]["人物编号"]] = nil
											end
												for d = 0, WAR.PersonNum - 1 do
													if 0 >= JY.Person[d]["生命"] then
													WAR.Person[d]["死亡"] = true
													end	
												end							
											break;
											WAR.CurID = z
										end
									WAR.Person[emeny]["体力点数"] = (WAR.Person[emeny]["体力点数"] or 0) + AddPersonAttrib(eid, "体力", -10)
									WAR.Person[emeny]["内力点数"] = (WAR.Person[emeny]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -1000)
									WAR.JJCD[eid] = 50
									return
									else
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - War_WugongHurtLife(emeny, wugong, level, ng, x, y)
									WAR.Effect = 2
									SetWarMap(i, j, 4, 2)
									end
								else
										WAR.Person[emeny]["特效文字5"] = reaction[effect]
										WAR.Person[emeny]["特效动画"] = 155	   
											if 995 < WAR.Person[emeny].Time then
											WAR.Person[emeny].Time = 995
											end
											WAR.Person[emeny].Time = 1005	
												for d = 0, WAR.PersonNum - 1 do
													if 0 >= JY.Person[d]["生命"] then
													WAR.Person[d]["死亡"] = true
													end	
												end					
											break;
								end
							--闪避
							elseif dodge == 1 then
								WAR.Dodge = 1
								for i = 0, 4 do
									WAR.Person[emeny]["特效文字"..i] = nil
								end
								WAR.Person[emeny]["特效动画"] = -1
								WAR.Miss[eid] = 1
								WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0)
								--登萍渡水打不中追加连击
								if Curr_QG(pid, 179) and WAR.DPLJ == 0 then
									fightnum = fightnum + 1
									WAR.DPLJ = 1
								end
							--穆人清 神游太虚	
							elseif match_ID(eid, 185) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and math.random(100) < 21 and WAR.JESS[eid] == nil and wugong ~= 231 then
								local reaction = {
									{'神', War_ActupMenu},
									{'游', War_DefupMenu},
									{'太', War_Focus},
									{'虚', War_Wait},
								}
								local effect =math.random(4)
									WAR.Person[WAR.CurID]["特效动画"] = -1
									WAR.Person[WAR.CurID]["特效文字0"] = nil
									WAR.Person[WAR.CurID]["特效文字1"] = nil
									WAR.Person[WAR.CurID]["特效文字2"] = nil
									WAR.Person[WAR.CurID]["特效文字3"] = nil
									WAR.Person[WAR.CurID]["特效文字4"] = nil
									WAR.Person[WAR.CurID]["特效文字5"] = nil
									WAR.Person[WAR.CurID]["特效文字6"] = nil
									WarDrawMap(0)
								CurIDTXDH(WAR.CurID, 97,1, string.format("神游太虚・%s", reaction[effect][1]), LimeGreen)
									WAR.Person[WAR.CurID].Time = -500
											for j = 0, WAR.PersonNum - 1 do
												if 0 >= JY.Person[j]["生命"] then
												WAR.Person[j]["死亡"] = true
												end	
											end
							WAR.DPLJ = 0
							WAR.ZYHB = 0
							WAR.CLBF = 0
							WAR.HSSD = 0
							WAR.DZXY = 0
							WAR.ALH = 0
							WAR.AXFJ = 0
							WAR.ACT = 10
							reaction[effect][2]()
								return 1
							--以静制动
							elseif JY.Person[eid]["人35"] == 1 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and math.random(100) < 14 then
									WAR.Person[WAR.CurID]["特效动画"] = -1
									WAR.Person[WAR.CurID]["特效文字0"] = nil
									WAR.Person[WAR.CurID]["特效文字1"] = nil
									WAR.Person[WAR.CurID]["特效文字2"] = nil
									WAR.Person[WAR.CurID]["特效文字3"] = nil
									WAR.Person[WAR.CurID]["特效文字4"] = nil
									WAR.Person[WAR.CurID]["特效文字5"] = nil
									WAR.Person[WAR.CurID]["特效文字6"] = nil
									WarDrawMap(0)
								    CurIDTXDH(WAR.CurID, 97,1, "以静制动", LimeGreen)
									WAR.Person[WAR.CurID].Time = -500
											for j = 0, WAR.PersonNum - 1 do
												if 0 >= JY.Person[j]["生命"] then
												   WAR.Person[j]["死亡"] = true
												end	
											end
							WAR.DPLJ = 0
							WAR.ZYHB = 0
							WAR.CLBF = 0
							WAR.HSSD = 0
							WAR.DZXY = 0
							WAR.ALH = 0
							WAR.AXFJ = 0
							WAR.ACT = 10
							War_DefupMenu()
								return 1

							--金刚国裂斩						
							elseif PersonKF(eid, 210) and WAR.DZXY ~= 1 and WAR.AXFJ ~= 1 and WAR.KungfuLQ[eid][210] == nil and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and (math.random(100) < 21 or (WAR.LQZ[eid] == 100 and math.random(100) < 99)) and wugong ~= 232 and wugong ~= 238 and wugong ~= 210 then
														
							WAR.JGGLZ = 1
									WAR.Person[WAR.CurID]["特效动画"] = -1
									WAR.Person[WAR.CurID]["特效文字0"] = nil
									WAR.Person[WAR.CurID]["特效文字1"] = nil
									WAR.Person[WAR.CurID]["特效文字2"] = nil
									WAR.Person[WAR.CurID]["特效文字3"] = nil
									WAR.Person[WAR.CurID]["特效文字4"] = nil
									WAR.Person[WAR.CurID]["特效文字5"] = nil
									WAR.Person[WAR.CurID]["特效文字6"] = nil
							WAR.DPLJ = 0
							WAR.ZYHB = 0
							WAR.XFXY = 0 
							WAR.CLBF = 0
							WAR.HSSD = 0
							WAR.DZXY = 0
							WAR.ALH = 0
							WAR.AXFJ = 0
							--WAR.ACT = 10
									    WarDrawMap(0)
										local z = WAR.CurID
										local t
										for j = 0, WAR.PersonNum - 1 do
											if WAR.Person[j]["人物编号"] == eid and 0 < JY.Person[j]["生命"] then
											WAR.CurID = j
											t = 0
											end		  	 						
											break
											
										end
										if t == 0 then
										WAR.KungfuLQ[eid][210] = 2
										local level = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["武功等级16"]
										JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["武功16"] = 210
										JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["武功等级16"] = 999
				                        War_Fight_Sub(WAR.CurID, 16)
										JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["武功16"] = 225
										JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["武功等级16"] = level
										else
										    if KungfuCD(eid, 210) == 0 then
										       if WAR.KungfuLQ[eid][210] == nil then
											   WAR.KungfuLQ[eid][210] = 2
											   else
											   WAR.KungfuLQ[eid][210] = WAR.KungfuLQ[eid][210] + 1
											   if WAR.KungfuLQ[eid][210] > 2 then
											      WAR.KungfuLQ[eid][210] = 2
											   end
											   end
											   
											else
											   if WAR.KungfuLQ[eid][210] == nil then
											   WAR.KungfuLQ[eid][210] = 2
											   else
											   WAR.KungfuLQ[eid][210] = WAR.KungfuLQ[eid][210] + 2
											   if WAR.KungfuLQ[eid][210] > 5 then
											      WAR.KungfuLQ[eid][210] = 5
											   end
											   end
											end 
											
										end
										WAR.CurID = z
			                        WAR.JGGLZ = 0
									return 1
							elseif match_ID(eid, 48) and WAR.YTZ[eid] == 1 and wugong ~= 231 and wugong ~= 238 then
								WAR.Person[emeny]["特效文字6"] = "摩T罗伽"
								WAR.Person[emeny]["特效动画"] = 54
								WAR.YTZ[eid] = nil
							elseif match_ID(eid, 685) and math.random(100) < 15 + math.modf(JY.Person[eid]["实战"]*0.03) and wugong ~= 231 and wugong ~= 238 then
								WAR.Person[emeny]["特效文字6"] = "奇门遁甲"
								WAR.Person[emeny]["特效动画"] = 78
							elseif match_ID(eid, 689) and JY.Person[690]["天1"] == 1 and math.random(100) <= 20 then
								WAR.Person[emeny]["特效文字6"] = "天神下凡"
								WAR.Person[emeny]["特效动画"] = 121	

							elseif WAR.LXJY_P[eid] ~= nil and wugong ~= 231 then
								WAR.Person[emeny]["特效文字3"] = "螺旋九影"
								WAR.Person[emeny]["特效动画"] = 115
							--谢无悠，剑步谜影
							elseif eid==596 and JY.Person[596]["姓名"]=="谢无悠" and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil and wugong ~= 197 and wugong ~= 232 and wugong ~= 238 then
								WAR.Person[emeny]["特效文字2"] = "剑步谜影"
								WAR.Person[emeny]["特效动画"] = 155
							elseif WAR.WDZT[eid] ~= nil then

							--天地玄黄 穆人清自带
							elseif (TiandiXH(eid) or match_ID(eid,185)) and math.random(200) > 189 and wugong ~= 232 and wugong ~= 238 and WAR.JESS[eid] == nil then
								WAR.Person[emeny]["特效文字5"] = "天地玄黄・天"
								WAR.Person[emeny]["特效动画"] = 151
							elseif JY.Person[eid]["地10"] == 1 and math.random(100) < 36 and wugong ~= 232 and wugong ~= 238 and WAR.JESS[eid] == nil then
								WAR.Person[emeny]["特效文字6"] = "玄之又玄"
								WAR.Person[emeny]["特效动画"] = 151
							elseif JY.Person[eid]["专2"] == 64 and math.random(100) < 16 and wugong ~= 232 and wugong ~= 238 and WAR.JESS[eid] == nil then
								WAR.Person[emeny]["特效文字6"] = "玄远虚无"
								WAR.Person[emeny]["特效动画"] = 135	
							--无酒不欢 无爱不欢	
							elseif JY.Base["特殊"] ==1 and JY.Person[41]["血量翻倍"]==1 and eid==0 and ((pid>310 and pid<320) or (pid>409 and pid<441) or pid==628 or pid==630 or pid==190) and WAR.JESS[eid] == nil then
								WAR.Person[emeny]["特效动画"] = 115
							--装备喵大山开局前三次不受伤害
							elseif (JY.Person[eid]["动物"]==321 or JY.Person[eid]["动物"]==322) and WAR.FF < 3 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and WAR.JESS[eid] == nil then
								WAR.FF = WAR.FF + 1 
								WAR.Person[emeny]["特效动画"] = 135
							--无酒不欢 无喵不欢	
							elseif JY.Base["特殊"] ==1 and JY.Person[22]["血量翻倍"]==1 and eid==0 and WAR.WJ < 3 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and WAR.JESS[eid] == nil then
								WAR.WJ = WAR.WJ + 1 
								WAR.Person[emeny]["特效动画"] = 135
							elseif Curr_QG(eid, 192) and instruct_31(6000) == true and wugong ~= 232 and wugong ~= 238 then
									if inteam(eid) then
								local line = "我，林陈爱，打钱";
								local tiles = 2;
								say(line, 367,0,"林陈爱")
								if DrawStrBoxYesNo(-1, -1, "我，林陈爱，打钱", C_WHITE, CC.DefaultFont) then
								instruct_32(174,-6000)
								WAR.Person[emeny]["特效文字2"] = "林陈爱向你丢过来一个账号并让你失去了6000银两"
								WAR.Person[emeny]["特效动画"] = 125
								else
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - War_WugongHurtLife(emeny, wugong, level, ng, x, y)
									WAR.Effect = 2
									SetWarMap(i, j, 4, 2)
								end
									else
								instruct_32(174,-6000)
								WAR.Person[emeny]["特效文字2"] = "林陈爱向你丢过来一个账号并让你失去了6000银两"
								WAR.Person[emeny]["特效动画"] = 125
									end								
							elseif JY.Base["特殊"] ==1 and JY.Person[23]["血量翻倍"]==1 and eid==0 and instruct_31(600) == true then
								local line = "我，林陈爱，打钱";
								local tiles = 2;
								say(line, 367,0,"林陈爱")
								if DrawStrBoxYesNo(-1, -1, "我，林陈爱，打钱", C_WHITE, CC.DefaultFont) then
								instruct_32(174,-600)
								WAR.Person[emeny]["特效文字2"] = "林陈爱向你丢过来一个账号并让你失去了600银两"
								WAR.Person[emeny]["特效动画"] = 125
								else
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - War_WugongHurtLife(emeny, wugong, level, ng, x, y)
									WAR.Effect = 2
									SetWarMap(i, j, 4, 2)
								end	
							--先天罡气
							elseif WAR.XTGQ[eid] == 1 then 
								   WAR.Person[emeny]["特效动画"] = 135
							       WAR.XTGQ[eid] = 2
							--林朝英轻云蔽月，每50时序可触发一次，免疫伤害10时序，误伤不触发
							elseif match_ID(eid, 605) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and WAR.JESS[eid] == nil and wugong ~= 197 and wugong ~= 232 and wugong ~= 238 then
								if WAR.QYBY[eid] == nil then
									WAR.QYBY[eid] = 50
								end
								if WAR.QYBY[eid] > 40 then
									WAR.Person[emeny]["特效文字3"] = "轻云蔽月"
									WAR.Person[emeny]["特效动画"] = 102
								else
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - War_WugongHurtLife(emeny, wugong, level, ng, x, y)
									WAR.Effect = 2
									SetWarMap(i, j, 4, 2)
								end
							--黄裳道法自然，每100时序可触发一次，免疫伤害10时序，误伤不触发
							elseif match_ID(eid, 637) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"]  and WAR.JESS[eid] == nil and wugong ~= 232 and wugong ~= 238 then
								if WAR.DFZR[eid] == nil then
									WAR.DFZR[eid] = 100
								end
								if WAR.DFZR[eid] > 90 then
									WAR.Person[emeny]["特效文字5"] = "道法自然"
									WAR.Person[emeny]["特效动画"] = 108
								else
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - War_WugongHurtLife(emeny, wugong, level, ng, x, y)
									WAR.Effect = 2
									SetWarMap(i, j, 4, 2)
								end
							--黛绮丝倾国
							elseif WAR.QGZT[eid] ~= nil and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"]  and WAR.JESS[eid] == nil and wugong ~= 232 and wugong ~= 238 then
								local list = {}
								for q = 0, WAR.PersonNum - 1 do
									if WAR.Person[q]["死亡"] == false and q ~= WAR.CurID and WAR.Person[q]["我方"] ~= WAR.Person[emeny]["我方"] then
										table.insert(list,q)
									end
								end
								local F_target
								if list[1] ~= nil then
									WAR.Person[emeny]["特效动画"] = 149
									F_target = list[math.random(#list)]
									WAR.NZQK = 3
									WAR.Person[F_target]["生命点数"] = (WAR.Person[F_target]["生命点数"] or 0) - War_WugongHurtLife(F_target, wugong, level, ng, x, y)
									WAR.Effect = 2
									SetWarMap(WAR.Person[F_target]["坐标X"], WAR.Person[F_target]["坐标Y"], 4, 2)
									WAR.NZQK = 0
								else
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - War_WugongHurtLife(emeny, wugong, level, ng, x, y)
									WAR.Effect = 2
									SetWarMap(i, j, 4, 2)
								end
								--无论是否有第三方，既无论是否反弹，都消耗一次次数
								WAR.QGZT[eid] = WAR.QGZT[eid] -1
								if WAR.QGZT[eid] < 1 then
									WAR.QGZT[eid] = nil
								end
							--郭襄，诸天化身步
							elseif match_ID_awakened(eid, 626, 1) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and WAR.JESS[eid] == nil then
							local jl = 30
							if JY.Person[626]["阶"] >= 3 then
							   jl = 45
							end
							    if math.random(100) <= jl then
								WAR.ZTHSB = 1
								WAR.ZT_id = emeny
								WAR.ZT_X = WAR.Person[emeny]["坐标X"]
								WAR.ZT_Y = WAR.Person[emeny]["坐标Y"]
								local dam = Xishu_max(eid)
								if JY.Person[626]["阶"] >= 3 then
							       dam = dam + 100
							    end
								local s = WAR.CurID
								WAR.CurID = emeny
								for f = 0, WAR.PersonNum - 1 do
									if WAR.Person[f]["我方"] ~= WAR.Person[emeny]["我方"] and WAR.Person[f]["死亡"] == false then					
										WAR.TXXS[WAR.Person[f]["人物编号"]] = 1
										WAR.Person[f]["Life_Before_Hit"] = JY.Person[WAR.Person[f]["人物编号"]]["生命"]
										JY.Person[WAR.Person[f]["人物编号"]]["生命"] = JY.Person[WAR.Person[f]["人物编号"]]["生命"] - dam
										WAR.Person[f]["生命点数"] = (WAR.Person[f]["生命点数"] or 0) - dam
									end
								end
								--一灯，避免被爆死
								if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil and WAR.JESS[eid] == nil then
									JY.Person[65]["生命"] = 1
								end
								--王重阳
								if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil and WAR.JESS[eid] == nil then
									JY.Person[129]["生命"] = 1
								end
								WAR.CurID = s
								end
							else
								WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - War_WugongHurtLife(emeny, wugong, level, ng, x, y)
								WAR.Effect = 2
								SetWarMap(i, j, 4, 2)
							end
							
							--沉睡状态的敌人会醒来
							if WAR.CSZT[WAR.Person[emeny]["人物编号"]] ~= nil and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
								WAR.CSZT[WAR.Person[emeny]["人物编号"]] = nil
							end
						end
					end
				end
			end
		end
    end
	    
	--无酒不欢：标主的大招音效
    local dhxg = JY.Wugong[wugong]["武功动画&音效"]
    if WAR.LXZQ == 1 then
		dhxg = 71
    elseif WAR.JSYX == 1 then
        dhxg = 84
    elseif WAR.ASKD == 1 then
        dhxg = 65
    elseif WAR.GCTJ == 1 then
        dhxg = 108
    elseif WAR.JSTG == 1 then
        dhxg = 119
    end
	
	
	--狄云赤心连城追加连击
	if WAR.CXLC == 1 and WAR.CXLC_Count < 3 then
		fightnum = fightnum + 1
		WAR.CXLC_Count = WAR.CXLC_Count + 1
	end
	
	--血刀吸血，上限100点
	if WAR.XDLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.XDLeech);
	end
	
	--绝世好剑
	if WAR.JSHJab > 0 then
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", WAR.JSHJab);
	end
	
	--韦一笑吸血10%，上限100点
	if WAR.WYXLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.WYXLeech);
	end
	if WAR.WYXLeech2 > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.WYXLeech2);
	end
	
	--天魔功吸血20%
	if WAR.TMGLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.TMGLeech);
	end
	if WAR.RENLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.RENLeech);
	end
	
	if WAR.PYZLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.PYZLeech);
	end
	
	if WAR.LLXLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.LLXLeech);
	end
	
	if WAR.YYZLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.YYZLeech);
	end
	
	--血河神鉴吸血，上限100点
	if WAR.XHSJ > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.XHSJ);
	end
	
	
	--[[千剑归宗和万剑诀的特殊显示
	if wugong == 187 then
		local x0 = WAR.Person[WAR.CurID]["坐标X"]
		local y0 = WAR.Person[WAR.CurID]["坐标Y"]
		local hb1 = GetS(JY.SubScene, x0, y0, 4)
		for i = 5, 10 do
			KungfuString('千剑归宗', CC.ScreenW / 2 -10, CC.ScreenH / 3 - 20 - hb1, C_GOLD, CC.FontBig+i, CC.FontName, 0)
			ShowScreen()
			lib.Delay(2)
			if i == 10 then
				lib.Delay(300)
			end
			Cls()
		end
		
		local yoff = 1
		local cur_dam_display = {}
		
		for i = 1, 60 do
			local off = 1
			if i%2 == 0 then
				off = -1
			end

			Cls()
			for j = 1, #WAR.QJGZ_Tar do
				local id = WAR.QJGZ_Tar[j]
				local dx = WAR.Person[id]["坐标X"] - x0
				local dy = WAR.Person[id]["坐标Y"] - y0

				local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
				local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
		 
				local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
				ry = ry - hb - CC.YScale*7

				if WAR.Person[id]["生命点数"] ~= nil then
				if i == 1 then
					local tmp_dam_top = WAR.Person[id]["生命点数"]/3*1.1
					local tmp_dam_bot = WAR.Person[id]["生命点数"]/3*0.9
					local tmp_dam = math.modf(math.random(tmp_dam_top, tmp_dam_bot))
					cur_dam_display[j] = tostring(tmp_dam)
					WAR.Person[id]["生命点数"] = WAR.Person[id]["生命点数"] - tmp_dam
				end
				if i == 21 then
					yoff = 1
					local tmp_dam_top = WAR.Person[id]["生命点数"]/2*1.1
					local tmp_dam_bot = WAR.Person[id]["生命点数"]/2*0.9
					local tmp_dam = math.modf(math.random(tmp_dam_top, tmp_dam_bot))
					cur_dam_display[j] = tostring(tmp_dam)
					WAR.Person[id]["生命点数"] = WAR.Person[id]["生命点数"] - tmp_dam
				end
				if i == 41 then
					yoff = 1
					cur_dam_display[j] = tostring(WAR.Person[id]["生命点数"])
					WAR.Person[id]["生命点数"] = nil
				end
				DrawString(rx-#cur_dam_display[j]/2*CC.DefaultFont/5, ry-yoff, cur_dam_display[j], C_GOLD, CC.DefaultFont)
				end
			end
			yoff = yoff + 1
			ShowScreen()
			lib.Delay(30)
		end
	else
		--无酒不欢：人物的攻击动画和点数显示
		War_ShowFight(pid, wugong, JY.Wugong[wugong]["武功类型"], level, x, y, dhxg, ZHEN_ID)
		 
	end
	]]
	War_ShowFight(pid, wugong, JY.Wugong[wugong]["武功类型"], level, x, y, dhxg, ZHEN_ID)
	WAR.Dodge = 0
	
	--紫气天罗，杀人引爆毒素
	if WAR.ZQTL[1] ~= nil then
		local dam = WAR.ZQTL[1]
		local ybid = WAR.ZQTL[2]
		local bpX = WAR.ZQTL[3]
		local bpY = WAR.ZQTL[4]
		local pid = WAR.ZQTL[5]
		local yin, yang, tg = NeiL(pid)
		local fx = yin + yang
		local ran = 5
		if tg ~= 1 then
		   if fx < 0 then
		   ran = ran - math.modf(fx/3)
		   end
		else
		   ran = ran - math.modf(yin/3)
		end
		   
		
		for i = 1, 5 do
			WAR.ZQTL[i] = nil
		end
		
		local ys_list = {}
		local ys_num = 0
		for i = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4) == 1 then
				ys_num = ys_num + 1
				ys_list[ys_num] = {WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"]}
			end
		end
		
		local yes = 1
		
		while (yes == 1) do
			yes = 0
			WAR.Person[ybid]["引爆"] = 1
			WAR.Person[ybid]["特效动画"] = 117
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["引爆"] == nil and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					local bdid = WAR.Person[i]["人物编号"]
					local offset1 = math.abs(bpX - WAR.Person[i]["坐标X"])
					local offset2 = math.abs(bpY - WAR.Person[i]["坐标Y"])
					if offset1 <= ran and offset2 <= ran then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						JY.Person[bdid]["生命"] = JY.Person[bdid]["生命"] - dam
						--一灯，避免被爆死
						if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil then
							JY.Person[65]["生命"] = 1
						end
						--王重阳
						if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil then
							JY.Person[129]["生命"] = 1
						end
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
							yes = 1
							ybid = i
							bpX = WAR.Person[i]["坐标X"]
							bpY = WAR.Person[i]["坐标Y"]
						end
						WAR.TXXS[bdid] = 1
					end
				end
			end
			War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
		end
		CleanWarMap(4, 0)
		for i = 1, ys_num do
			SetWarMap(ys_list[i][1], ys_list[i][2], 4, 1)
		end
	end
	
	--血精石
	if WAR.XJSBZ[1] ~= nil then
		local dam = 999
		local ybid = WAR.XJSBZ[2]
		local bpX = WAR.XJSBZ[3]
		local bpY = WAR.XJSBZ[4]
		   
		
		for i = 1, 4 do
			WAR.XJSBZ[i] = nil
		end
		
		local ys_list = {}
		local ys_num = 0
		for i = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4) == 1 then
				ys_num = ys_num + 1
				ys_list[ys_num] = {WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"]}
			end
		end
		
			WAR.Person[ybid]["引爆"] = 1
			WAR.Person[ybid]["特效动画"] = 115
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["引爆"] == nil and WAR.Person[i]["我方"] == WAR.Person[WAR.CurID]["我方"] then
					local bdid = WAR.Person[i]["人物编号"]
					local offset1 = math.abs(bpX - WAR.Person[i]["坐标X"])
					local offset2 = math.abs(bpY - WAR.Person[i]["坐标Y"])
					if offset1 <= 9 and offset2 <= 9 then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						JY.Person[bdid]["生命"] = JY.Person[bdid]["生命"] - dam
						WAR.Person[i]["特效动画"] = 41
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
						end
						WAR.TXXS[bdid] = 1
					end
				end
			War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
		end
		CleanWarMap(4, 0)
		for i = 1, ys_num do
			SetWarMap(ys_list[i][1], ys_list[i][2], 4, 1)
		end
	end
	
	--blood
	if WAR.BLOOD[1] ~= nil then
		local dam = WAR.BLOOD[1]
		local ybid = WAR.BLOOD[2]
		local bpX = WAR.BLOOD[3]
		local bpY = WAR.BLOOD[4]
		   
		
		for i = 1, 4 do
			WAR.BLOOD[i] = nil
		end
		
		local ys_list = {}
		local ys_num = 0
		for i = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4) == 1 then
				ys_num = ys_num + 1
				ys_list[ys_num] = {WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"]}
			end
		end
		
		local yes = 1
		
		while (yes == 1) do
			yes = 0
			WAR.Person[ybid]["引爆"] = 1
			WAR.Person[ybid]["特效动画"] = 115
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["引爆"] == nil and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					local bdid = WAR.Person[i]["人物编号"]
					local offset1 = math.abs(bpX - WAR.Person[i]["坐标X"])
					local offset2 = math.abs(bpY - WAR.Person[i]["坐标Y"])
					if offset1 <= 7 and offset2 <= 7 then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						JY.Person[bdid]["生命"] = JY.Person[bdid]["生命"] - dam
						WAR.Person[i]["特效动画"] = 41
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
							dam = math.modf(dam * 1.03)
							if dam > 1000 then
							   dam = 1000
							end   
							yes = 1
							ybid = i
							bpX = WAR.Person[i]["坐标X"]
							bpY = WAR.Person[i]["坐标Y"]
						end
						WAR.TXXS[bdid] = 1
					end
				end
			end
			War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
		end
		CleanWarMap(4, 0)
		for i = 1, ys_num do
			SetWarMap(ys_list[i][1], ys_list[i][2], 4, 1)
		end
	end
	--爆裂掌
	if WAR.BLZZ[1] ~= nil then
		local dam = WAR.BLZZ[1]
		local ybid = WAR.BLZZ[2]
		local bpX = WAR.BLZZ[3]
		local bpY = WAR.BLZZ[4]
		
		for i = 1, 4 do
			WAR.BLZZ[i] = nil
		end
		
		local ys_list = {}
		local ys_num = 0
		for i = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4) == 1 then
				ys_num = ys_num + 1
				ys_list[ys_num] = {WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"]}
			end
		end
		
		local yes = 1
		
		while (yes == 1) do
			yes = 0
			WAR.Person[ybid]["引爆"] = 1
			WAR.Person[ybid]["特效动画"] = 41
			WAR.BLZ[WAR.Person[ybid]["人物编号"]] = nil
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					local bdid = WAR.Person[i]["人物编号"]
					local offset1 = math.abs(bpX - WAR.Person[i]["坐标X"])
					local offset2 = math.abs(bpY - WAR.Person[i]["坐标Y"])
					if offset1 <= 11 and offset2 <= 11 then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						JY.Person[bdid]["生命"] = JY.Person[bdid]["生命"] - dam
						WAR.Person[i]["特效动画"] = 41
	
					
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
						end
						if WAR.BLZ[bdid] == 1 then
							yes = 1
							ybid = i
							bpX = WAR.Person[i]["坐标X"]
							bpY = WAR.Person[i]["坐标Y"]
						end
						WAR.TXXS[bdid] = 1
					end
				end
			end
			War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
		end
		CleanWarMap(4, 0)
		for i = 1, ys_num do
			SetWarMap(ys_list[i][1], ys_list[i][2], 4, 1)
		end
	end
	--亢龙有悔
	if WAR.KLYH[1] ~= nil then
		local dam = WAR.KLYH[1]
		local ybid = WAR.KLYH[2]
		local bpX = WAR.KLYH[3]
		local bpY = WAR.KLYH[4]
		
		for i = 1, 4 do
			WAR.KLYH[i] = nil
		end
		
		local ys_list = {}
		local ys_num = 0
		for i = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4) == 1 then
				ys_num = ys_num + 1
				ys_list[ys_num] = {WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"]}
			end
		end
		
		local yes = 1
		
		while (yes == 1) do
			yes = 0
			WAR.Person[ybid]["引爆"] = 1
			WAR.Person[ybid]["特效动画"] = 41
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["引爆"] == nil and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					local bdid = WAR.Person[i]["人物编号"]
					local offset1 = math.abs(bpX - WAR.Person[i]["坐标X"])
					local offset2 = math.abs(bpY - WAR.Person[i]["坐标Y"])
					if offset1 <= 7 and offset2 <= 7 then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						JY.Person[bdid]["生命"] = JY.Person[bdid]["生命"] - dam
						WAR.Person[i]["特效动画"] = 53
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
							if WAR.KLYHB[bdid] == 1 then
							yes = 1
							ybid = i
							bpX = WAR.Person[i]["坐标X"]
							bpY = WAR.Person[i]["坐标Y"]
							end
						end
						WAR.TXXS[bdid] = 1
					end
				end
			end
			War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
		end
		CleanWarMap(4, 0)
		for i = 1, ys_num do
			SetWarMap(ys_list[i][1], ys_list[i][2], 4, 1)
		end
	end
	--野球拳
	if WAR.YQQ[1] ~= nil then
	    local ybid = WAR.YQQ[1]
		local bpX = WAR.YQQ[2]
		local bpY = WAR.YQQ[3]
		
		for i = 1, 2 do
			WAR.YQQ[i] = nil
		end
		
		local ys_list = {}
		local ys_num = 0
		for i = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4) == 1 then
				ys_num = ys_num + 1
				ys_list[ys_num] = {WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"]}
			end
		end
		
		local yes = 1
		
		while (yes == 1) do
			yes = 0
			WAR.Person[ybid]["引爆"] = 1
			--
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					local bdid = WAR.Person[i]["人物编号"]
					local offset1 = math.abs(bpX - WAR.Person[i]["坐标X"])
					local offset2 = math.abs(bpY - WAR.Person[i]["坐标Y"])
					if offset1 <= 7 and offset2 <= 7 then
					    WAR.KJZ[WAR.Person[i]["人物编号"]] = 1
						WAR.Person[i]["特效动画"] = 123	
					    WAR.Person[i]["特效文字5"] = "好可怕的拳法！"
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
						end
						WAR.TXXS[bdid] = 1
					end
				end
			end
			War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
		end
		CleanWarMap(4, 0)
		for i = 1, ys_num do
			SetWarMap(ys_list[i][1], ys_list[i][2], 4, 1)
		end
	end
	
	--玄铁重击
	local show_XTZJ
	for i = 1, WAR.PersonNum - 1 do
		local id = WAR.Person[i]["人物编号"]
		local dam = math.modf(JY.Person[id]["受伤程度"]/50*100+200)
		if WAR.XTZJ[id] == 1 then
			show_XTZJ = true
			WAR.Person[i]["特效动画"] = 156	
			WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
			JY.Person[id]["生命"] = JY.Person[id]["生命"] - dam
			WAR.Effect = 2
			SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 2)
			WAR.XTZJ[id] = nil
			if JY.Person[id]["生命"] < 0 then
				JY.Person[id]["生命"] = 0
			end
		end
	end
	if show_XTZJ then		--无酒不欢: 修改了一下, 如果没有触发玄铁重击就不显示动画了
		War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
	end
	
	--无明业火状态，耗损使用的内力一半的生命--怒气值
	if WAR.WMYH[pid] ~= nil and WAR.LQZ[pid] ~= nil and WAR.ACT == 1 then
		CurIDTXDH(WAR.CurID, 127,1, "无明业火", C_ORANGE)
		local nlDam = math.modf((35+WAR.LQZ[pid])^1.15)--math.modf((math.modf((level + 3) / 2) * JY.Wugong[wugong]["消耗内力点数"])/2)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam)
	    --至少留1滴血
	    if JY.Person[pid]["生命"] <= 0 then
			JY.Person[pid]["生命"] = 1
	    end
	end
	
	War_Show_Count(WAR.CurID);		--显示当前控制人的点数
	
	--WAR.TFBW = 0		--听风辨位的文字记录恢复
	--WAR.TLDWX = 0		--天罗地网的文字记录恢复
    
	WAR.ZTHSB = 0			--诸天化身步
	WAR.ZT_id = -1			--触发人的ID
	WAR.ZT_X = -1			--触发人的X坐标
	WAR.ZT_Y = -1			--触发人的Y坐标
	
	if WAR.FHJZ == 1 then
		DrawStrBoxWaitKey("【Ｇ复活戒指Ｏ】损坏了！", C_ORANGE, CC.DefaultFont, 2)
		WAR.FHJZ = 0
	end
	
    WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + 2
	
    --武功增加经验和升级
    if inteam(pid) then
		if JY.Person[pid]["武功等级" .. wugongnum] < 900 then
			JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] + 10
		elseif JY.Person[pid]["武功等级" .. wugongnum] < 999 then
			--JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] + math.modf(JY.Person[pid]["资质"] / 20 + math.random(2)) + rz
			--无酒不欢：空挥一次到极
			JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] + 99;
			--武功提升为极
			if 999 <= JY.Person[pid]["武功等级" .. wugongnum] then
				JY.Person[pid]["武功等级" .. wugongnum] = 999
				PlayWavAtk(42)
				DrawStrBoxWaitKey(string.format("%s修炼%s到登峰造极", JY.Person[pid]["姓名"], JY.Wugong[JY.Person[pid]["武功" .. wugongnum]]["名称"]), C_ORANGE, CC.DefaultFont)

				--虚竹 天山折梅手为极，资质变回50
				if match_ID(pid, 49) and wugong == 14 then
					say("逍遥派的武学果然博大精深，让小僧有醍醐灌顶之感。", 49, 0);
					DrawStrBoxWaitKey("虚竹资质改变！", C_ORANGE, CC.DefaultFont)
					set_potential(49, 50)
				end
				
				--狄云 神照功为极，增加轻功20点
				if match_ID(pid, 37) and wugong == 94 then
					say("神照经当真奇妙，四肢百骸感觉劲力充盈。丁大哥，我一定不会让你失望的！", 37, 0);
					DrawStrBoxWaitKey("狄云领悟神照经的真髓，轻功加二十", C_ORANGE, CC.DefaultFont)
					AddPersonAttrib(pid, "轻功", 20)
				end
				
				--丁典，神照功为极
				if match_ID(pid, 672) and wugong == 94 and JY.Person[672]["品德"] ~= 80 and JY.Person[672]["品德"] ~= 90 and JY.Person[672]["声望"] == 80 then
					DrawStrBoxWaitKey("丁典领悟无影神拳精髓，拳掌加三十", C_ORANGE, CC.DefaultFont)
					JY.Person[672]["声望"]=100
					AddPersonAttrib(pid, "拳掌功夫", 30)
				end
				
				--胡斐，胡家刀法到极，增加10点耍刀技巧
				if match_ID(pid, 1) and wugong == 67 then
					say("刀法真是越练越精妙。", 1, 0);
					DrawStrBoxWaitKey("胡斐攻、防、轻、耍刀技巧各增加10点", C_ORANGE, CC.DefaultFont)
					AddPersonAttrib(pid, "攻击力", 10)
					AddPersonAttrib(pid, "防御力", 10)
					AddPersonAttrib(pid, "轻功", 10)
					AddPersonAttrib(pid, "耍刀技巧", 10)
				end
			end
		end
			
		--武功提升普通等级
		if level < math.modf(JY.Person[pid]["武功等级" .. wugongnum] / 100) + 1 then
			level = math.modf(JY.Person[pid]["武功等级" .. wugongnum] / 100) + 1
			DrawStrBox(-1, -1, string.format("%s 升为 %d 级", JY.Wugong[JY.Person[pid]["武功" .. wugongnum]]["名称"], level), C_ORANGE, CC.DefaultFont)
			ShowScreen()
			lib.Delay(500)
			Cls()
			ShowScreen()
		end
    end
      
    --我方，消耗的内力
    if WAR.Person[WAR.CurID]["我方"] then
		local nl = nil
	
		nl = math.modf((level + 3) / 2) * JY.Wugong[wugong]["消耗内力点数"]
		
		--纯阳减少内力消耗
		--主运
		if Curr_NG(pid, 99) then
			nl = math.modf(nl*0.6);
		--被动
		elseif PersonKF(pid, 99) then
			nl = math.modf(nl*0.7);
		end
		
		--阳内主运九阳，减少70%耗内
		if Curr_NG(pid, 106) then
			nl = math.modf(nl*0.5);
		elseif PersonKF(pid, 106) then
			nl = math.modf(nl*0.6);
		end

		--易筋经主运减25%耗内
		if Curr_NG(pid, 108) then
			nl = math.modf(nl*0.75);
		end
		
		--石破天觉醒后，太玄消耗减半
		if match_ID_awakened(pid, 38, 1) and wugong == 102 then
			nl = math.modf(nl/2);
		end
		  
		--段誉六脉消耗减半
		if match_ID(pid, 53) and wugong == 49 then
			nl = math.modf(nl/2);
		end
		--乔峰
		if JY.Person[50]["阶"] >= 1 and match_ID(pid, 50) and wugong == 26 then
		   nl = 0
		end
		if JY.Person[65]["阶"] >= 2 and match_ID(pid, 65) and (wugong == 17 or wugong == 49) then
		   nl = 0
		end
		if JY.Person[82]["阶"] >= 1 and match_ID(pid, 82) and wugong == 7 then
		   nl = 0
		end
		
		if match_ID(pid, 687) and wugong == 49 then
			nl = math.modf(nl/4);
		end
		
		--谢烟客，碧针清掌
		if match_ID(pid, 164) and wugong == 206 then
			nl = math.modf(nl/2);
		end
		
		--指法主角六脉消耗减半
		if pid == 0 and JY.Base["标准"] == 2 and wugong == 49 then
			nl = math.modf(nl/2);
		end
		
		--丁典
		if match_ID(pid, 672) and wugong == 94 then
			nl = math.modf(nl/1.5);
		end
		  
		--天外攻击，只消耗一半内力
		if Given_WG(pid, wugong) then
			nl = math.modf(nl/2);
		end
		
		--周伯通论剑奖励，体内消耗减少50%
		if pid == 0 and JY.Person[64]["论剑奖励"] == 1 then
			nl = math.modf(nl*0.35)
		end   

		AddPersonAttrib(pid, "内力", -(nl))
	--NPC的耗内
	else
		AddPersonAttrib(pid, "内力", -math.modf((level + 3) / 2) * JY.Wugong[wugong]["消耗内力点数"]/7*2)
    end
    
    if JY.Person[pid]["内力"] < 0 then
		JY.Person[pid]["内力"] = 0
    end
    
    if JY.Person[pid]["生命"] <= 0 then
		break;
    end
    
	
	--无酒不欢：被杀气的动态显示
  	DrawTimeBar2()
	
	--太极拳，借力打力，蓄力清除
	--张三丰不清除
	if (wugong == 16 or wugong == 46) and WAR.tmp[3000 + pid] ~= nil and WAR.tmp[3000 + pid] > 0 and match_ID(pid, 5) == false and PersonKF(pid,171) == false then
		WAR.tmp[3000 + pid] = 0
	end
	
    if WAR.BJ == 1 then		--暴击
		WAR.BJ = 0
    end
	

	WAR.ACT = WAR.ACT + 1   --统计攻击次数累加1
 		
  	--蓝烟清：攻击范围内的敌人全部死亡时取消连击
  	local flag = 0;
  	local n = 0;
    for i = 0, CC.WarWidth - 1 do
		for j = 0, CC.WarHeight - 1 do
			lib.GetKey()
			local effect = GetWarMap(i, j, 4)
			if 0 < effect then
				local emeny = GetWarMap(i, j, 2)
				if 0 <= emeny and WAR.Person[id]["我方"] ~= WAR.Person[emeny]["我方"] then
					n = n + 1;
					if JY.Person[WAR.Person[emeny]["人物编号"]]["生命"] > 0 then
						flag = 1;
					end
				end
    		end
    	end
    end
	
	--无酒不欢：程灵素不会中断连击
	
	if match_ID(pid, 6) and WAR.MJST[pid] == 1 and JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"]*0.25 then
	   fightnum = fightnum + 1
	   if flag == 0 or JY.Person[pid]["内力"] < 500 or JY.Person[pid]["体力"] < 5 then
	      WAR.MJST[pid] = nil
	   end
	end
	   
    if flag == 0 and n > 0 and match_ID(pid, 2) == false then
    	break
    end
	
	
	
	--主运太极神功，太极之形增加连击
	if PersonKF(pid, 171) and WAR.TJZX[pid] ~= nil and WAR.TJZX[pid] >= 5 then
		fightnum = fightnum + 1
		WAR.TJZX[pid] = WAR.TJZX[pid] - 5
		WAR.TJZX_LJ = 1
	end
	
	if match_ID(pid, 59) and JY.Person[59]["阶"] >= 2 and WAR.XLN[pid] ~= nil and WAR.XLN[pid] > 0 then
	   fightnum = fightnum + 1
	   WAR.XLN[pid] = WAR.XLN[pid] - 1	   
	   if JY.Person[59]["阶"] >= 3 and WAR.XLN[pid] > 0 then
	      fightnum = fightnum + 1
		  WAR.XLN[pid] = WAR.XLN[pid] - 1
	   end
	end
	
	if WAR.TQ[pid] ~= nil then
		fightnum = 1
	end
	
	if wugong == 244 then
	   fightnum = 2+math.random(3)
	end
	if wugong == 247 then
	   fightnum = 2
	end
	
	if Danji() and WAR.Person[WAR.CurID]["我方"] == false then
		fightnum = 1
	end
	
	if Danji2() and WAR.Person[WAR.CurID]["我方"] == true then
		fightnum = 1
	end
	
	if match_ID(pid, 693) and (wugong < 242 or wugong > 252) and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
	   WAR.TQLJ = WAR.TQLJ + 1
	end
	
	if match_ID(pid, 693) and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
	   if (wugong == 244 or wugong == 247) and WAR.ACT > 1 then
	   WAR.TQLJ2 = WAR.TQLJ2 + 1
	   elseif wugong >= 242 and wugong <= 252 then
	      WAR.TQLJ2 = WAR.TQLJ2 + 1
	   end
	end
  end
    --iron fist
	if match_ID(pid, 693) and JY.Base["天书数量"] >= 3 and War_isEnd() == 0 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
	
	local jl = 30
	local s = 6
	if JY.Base["天书数量"] >= 5 then
	   s = 3 + JY.Base["天书数量"]
	   if s > 11 then
	      s = 11
	   end
	end
	
	jl = jl + JY.Base["天书数量"]*3 + math.modf(JY.Person[pid]["实战"]/20)
	if WAR.TQ[pid] ~= nil then
	jl = jl - WAR.TQ[pid]*3
	end
	   if math.random(100) <jl and (WAR.TQ[pid] == nil or WAR.TQ[pid] < 4) then
	   local menu = {}
	   for i = 1, 11 do
	       menu[i] = {JY.Wugong[241+i]["名称"].."威力："..get_skill_power(pid, 241+i, 11),nil,1}
	   end
	      if WAR.TQ[pid] == nil then
	      WAR.TQ[pid] = 1
	      else
	      WAR.TQ[pid] = WAR.TQ[pid] + 1
	      end
		  

	      if WAR.LQZ[pid] == nil or WAR.LQZ[pid] < 25 or WAR.TQ[pid] ~= 3 then
		     menu[7][3] = 2
			 menu[8][3] = 2
		  end
		  if WAR.LQZ[pid] == nil or WAR.LQZ[pid] < 50 or WAR.TQ[pid] ~= 4 then
		     menu[9][3] = 2
			 menu[10][3] = 2
		  end
		  if WAR.LQZ[pid] == nil or WAR.LQZ[pid] < 100 or WAR.TQ[pid] ~= 4 then
		     menu[11][3] = 2
		  end
		  if WAR.TQ[pid] > 3 then
		     for i = 1, 6 do
		     menu[i][3] = 2
			 end
		  end
		  for i = 1, 11 do
		      if WAR.KungfuLQ[pid][241+i] ~= nil then
			     if WAR.KungfuLQ[pid][241+i]+1 > KungfuCD(pid, 241+i) then
				    menu[i][1] = menu[i][1].."||剩余："..KungfuCD(pid, 241+i).."回合 "
				 else
			     menu[i][1] = menu[i][1].."||剩余："..(WAR.KungfuLQ[pid][241+i]+1).."回合 "
				 end
				 menu[i][3] = 3
			  end
		  end
		  local n = 0
		  for i = 1, 11 do
		      if menu[i][3] == 1 then
			     n = n + 1
			  end
		  end
		  if n ~= 0 and War_isEnd() == 0 then
		     
		  

	   local c = ShowMenu2(menu, s, 1, s, CC.MainMenuX, CC.MainSubMenuY, 0, 0, 1, 0, CC.DefaultFont, C_ORANGE, C_WHITE)
	   JY.Person[pid]["武功16"] = 241 + c
	      
	   --skill--lotus whip,dragon's touch,surging fist,dragon tail,crescent heel,twin snake,rising fang*,wall of kun-lun*,iron rage**,volcanic roar**,dragon's prey***
	   if JY.Person[pid]["武功16"] == 246 then 
	   WAR.Person[WAR.CurID]["移动步数"] = 6
	   War_CalMoveStep(WAR.CurID, 6, 0)
		local x, y = nil, nil
		while 1 do
		if JY.Restart == 1 then
			break
		end
		x, y = War_SelectMove()
		if x ~= nil then
		WAR.ShowHead = 0
		War_MovePerson(x, y)
		break;
		end 
		end
		end
		
	   
	   War_Fight_Sub(WAR.CurID, 16)--
	   end--

	   if JY.Person[pid]["武功16"] == 248 or JY.Person[pid]["武功16"] == 249 then
	      WAR.LQZ[pid] = WAR.LQZ[pid] - 25  	 
	   end
	   if JY.Person[pid]["武功16"] == 250 or JY.Person[pid]["武功16"] == 251 then
	      WAR.LQZ[pid] = WAR.LQZ[pid] - 50  	 
	   end
	   if JY.Person[pid]["武功16"] == 252 then
	      WAR.LQZ[pid] = nil  	 
	   end
	   if WAR.LQZ[pid] ~= nil and WAR.LQZ[pid] <= 0 then
		  WAR.LQZ[pid] = nil
	   end
	   
	   end
	   if JY.Person[pid]["武功16"] == 250 then 
	   JY.Person[pid]["武功16"] = 241 + math.random(6)
	   if JY.Person[pid]["武功16"] == 246 then 
	   WAR.Person[WAR.CurID]["移动步数"] = 6
	   War_CalMoveStep(WAR.CurID, 6, 0)
		local x, y = nil, nil
		while 1 do
		if JY.Restart == 1 then
			break
		end
		x, y = War_SelectMove()
		if x ~= nil then
		WAR.ShowHead = 0
		War_MovePerson(x, y)
		break;
		end 
		end
		end
		
	   
	   War_Fight_Sub(WAR.CurID, 16)
	   end
	   JY.Person[pid]["武功16"] = 225
	   WAR.TQ[pid] = nil
	   WAR.TQLJ = 1
	   WAR.TQLJ2 = 0
	end
	

	--连击结束
	if JY.Restart == 1 then
		return 1
	end
	
	--衡山五神剑
	WAR.TZYQ = 0
	
	WAR.XYDD = 0
	WAR.LBJY = 0
	WAR.DHCG = 0
	--灭杀豪升龙
	WAR.MSHSL = 0
	WAR.MSHBD = 0
	WAR.SLX = nil
	WAR.SLY = nil
	--天外连击判定取消
	WAR.TWLJ = 0
	
	--登萍连击判定取消
	WAR.DPLJ = 0
	
	--黯然极意范围恢复
	WAR.ARJY = 0
	
	--碧落九重剑
	WAR.BLJY = 0
	
	--狄云赤心连城计数恢复
	WAR.CXLC_Count = 0
	
	--苗剑极意范围恢复
	WAR.ZHDJY = 0	
	--逍遥御风计数恢复
	WAR.YFCS = 0
	WAR.DZXYCS = 0
	WAR.XXDFCS = 0
	
	--太极拳，借力打力，蓄力清除
	--张三丰在这里清除
	if (wugong == 16 or wugong == 46) and WAR.tmp[3000 + pid] ~= nil and WAR.tmp[3000 + pid] > 0 and match_ID(pid, 5) and PersonKF(pid,171) == false then
		WAR.tmp[3000 + pid] = 0
	end
	
	--如果触发了逆转乾坤的强化反弹效果，在这里恢复
	if WAR.NZQK > 0 then
		WAR.NZQK = 0
	end
  
	--计算消耗的体力
	local jtl = 0
	if 1100 <= WAR.WGWL then
		jtl = 7
	elseif 900 <= WAR.WGWL then
		jtl = 5
	elseif 600 <= WAR.WGWL then
		jtl = 3
	else
		jtl = 1
	end
	if wugong == 214 and WAR.WGWL >= 2000 then
	   jtl = 30
	end
	if wugong == 241 then
	   jtl = 20
	end
	
	--周伯通论剑奖励，体内消耗减少50%
	if pid == 0 and JY.Person[64]["论剑奖励"] == 1 then
		jtl = math.modf(jtl*0.35)
		if jtl < 1 then
			jtl = 1
		end
	end
	
	--太玄被动减少体力消耗2点
	if PersonKF(pid, 102) then
		jtl = jtl - 2
		if jtl < 1 then
			jtl = 1
		end
	end
	
	if JY.Person[pid]["动物"] == 262 and JY.Thing[262]["装备等级"] >= 5 then
		jtl = jtl - 2
		if jtl < 1 then
			jtl = 1
		end
	end

	--人厨子攻击不消耗体力
	--NPC只消耗1点
	if match_ID(pid, 89) then 
	elseif JY.Person[pid]["地8"] == 6 then
    elseif JY.Person[pid]["动物"] == 349 and match_ID(pid, 132) then
	elseif JY.Person[29]["阶"] >= 1 and match_ID(pid, 29) and wugong == 55 then
	elseif JY.Person[35]["阶"] >= 3 and match_ID(pid, 35) and wugong == 47 then
	elseif JY.Person[50]["阶"] >= 1 and match_ID(pid, 50) and wugong == 26 then
	elseif JY.Person[53]["阶"] >= 2 and match_ID(pid, 53) and wugong == 49 then
	elseif JY.Person[56]["阶"] >= 1 and match_ID(pid, 56) and wugong == 80 then
	elseif JY.Person[82]["阶"] >= 2 and match_ID(pid, 82) and wugong == 7 then
	elseif match_ID(pid, 693) and wugong >= 242 and wugong <= 252 then
	else
		if WAR.Person[WAR.CurID]["我方"] then
			AddPersonAttrib(pid, "体力", -(jtl))
		else
			AddPersonAttrib(pid, "体力", -1);
		end
	end
    
	--斗转星移计算
	local dz = {}
	local dznum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["反击武功"] ~= -1 and WAR.Person[i]["反击武功"] ~= 9999 then
			dznum = dznum + 1
			dz[dznum] = {i, WAR.Person[i]["反击武功"], x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
			WAR.Person[i]["反击武功"] = 9999
		end
	end
	for i = 1, dznum do
		local tmp = WAR.CurID
		WAR.CurID = dz[i][1]
		WAR.DZXY = 1
		if WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 1 then
			WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 70
		elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 2 then
			WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 100
		elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 3 then
			WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 130
		elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 4 then	--无酒不欢：增加斗转第四层
			WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 150
		end
		if WAR.AutoFight == 0 and inteam(WAR.Person[dz[i][1]]["人物编号"]) and (JY.Person[WAR.Person[dz[i][1]]["人物编号"]]["资质"] > 90 or match_ID(WAR.Person[dz[i][1]]["人物编号"], 51) or match_ID(WAR.Person[dz[i][1]]["人物编号"], 113)) then
		local level = JY.Person[WAR.Person[dz[i][1]]["人物编号"]]["武功等级16"]
		JY.Person[WAR.Person[dz[i][1]]["人物编号"]]["武功16"] = dz[i][2]
		JY.Person[WAR.Person[dz[i][1]]["人物编号"]]["武功等级16"] = 999
		War_Fight_Sub(dz[i][1], 16)
		JY.Person[WAR.Person[dz[i][1]]["人物编号"]]["武功16"] = 225
		JY.Person[WAR.Person[dz[i][1]]["人物编号"]]["武功等级16"] = level
		else
		War_Fight_Sub(dz[i][1], dz[i][2] + 100, dz[i][3], dz[1][4])
		end
		WAR.Person[WAR.CurID]["反击武功"] = -1
		WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = nil
		WAR.CurID = tmp
		WAR.DZXY = 0
	end
	--暗香月影计算
	local ax = {}
	local axnum = 0
	local bxnum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.AXYY[i] ~= nil then
			axnum = axnum + 1
			local fjwg = nil
			local wl = 0
			for j = 1, JY.Person[671]["品德"] do
				if JY.Person[WAR.AXYY[i]]["武功"..j] == 0 then
					break
				end
				if skill_usable(WAR.AXYY[i], JY.Person[WAR.AXYY[i]]["武功"..j]) then
					bxnum = bxnum + 1
					local kungfulv = JY.Person[WAR.AXYY[i]]["武功等级"..j]
					if kungfulv == 999 then
						kungfulv = 11
					else
						kungfulv = math.modf(kungfulv / 100) + 1
					end
					local nwl = get_skill_power(WAR.AXYY[i], JY.Person[WAR.AXYY[i]]["武功"..j], kungfulv)
					if wl < nwl then
						wl = nwl
						fjwg = j
					end
				end
			end
			if fjwg then
				ax[axnum] = {i, fjwg, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]}
			end
		end
	end
	if axnum > 0 and bxnum>0 then
		for i = 1, axnum do
			local tmp = WAR.CurID
			WAR.CurID = ax[i][1]
			WAR.AXFJ = 1
			War_Fight_Sub(ax[i][1], ax[i][2], ax[i][3], ax[i][4])
			WAR.CurID = tmp
			WAR.AXFJ = 0
			WAR.AXYY[ax[i][1]] = nil
		end
	end
	if XueDao() then
	if WAR.XHTT[pid] ~= nil then
	   if JY.Person[pid]["生命"] > WAR.XHTT[pid] then
	      JY.Person[pid]["生命"] = WAR.XHTT[pid]
	   end
	end
	end
	return 1;
end

--无酒不欢：选择移动
--增加7*7的显示flag
function War_SelectMove(flag)
	local x0 = WAR.Person[WAR.CurID]["坐标X"]
	local y0 = WAR.Person[WAR.CurID]["坐标Y"]
	local x = x0
	local y = y0
	if flag ~= nil then
		CleanWarMap(7, 0)
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		local x2 = x
		local y2 = y
		WarDrawMap(1, x, y)
		
		if flag ~= nil then
			for i = 1, 4 do
				for j = 1, 4 do
					SetWarMap(x + i - 1, y + j - 1, 7, 1)
					SetWarMap(x - i + 1, y + j - 1, 7, 1)
					SetWarMap(x + i - 1, y - j + 1, 7, 1)
					SetWarMap(x - i + 1, y - j + 1, 7, 1)
				end
			end
			WarDrawMap(1, x, y)
		end
		
		WarShowHead(GetWarMap(x, y, 2))
		
		--如阴时显示集气条
		if WAR.FLHS5 == 2 then
			DrawTimeBar_sub()
		end
		
		ShowScreen()
		
		if flag ~= nil then
			CleanWarMap(7, 0)
		end
		
		local key, ktype, mx, my = WaitKey(1)
		if key == VK_UP then
			y2 = y - 1
		elseif key == VK_DOWN then
			y2 = y + 1
		elseif key == VK_LEFT then
			x2 = x - 1
		elseif key == VK_RIGHT then
			x2 = x + 1
		elseif key == VK_SPACE or key == VK_RETURN then
			return x, y
		elseif key == VK_ESCAPE or ktype == 4 then
		    if WAR.HLB ~= 0 or WAR.FYYS ~= 0 or WAR.XLFD ~= 0 then--赵半山
			   WAR.HLB = 0
			   WAR.FYYS = 0
			end
			return nil
		elseif ktype == 2 or ktype == 3 then
			mx = mx - CC.ScreenW / 2
			my = my - CC.ScreenH / 2
			mx = (mx) / CC.XScale
			my = (my) / CC.YScale
			mx, my = (mx + my) / 2, (my - mx) / 2
			if mx > 0 then
				mx = mx + 0.99
			else
				mx = mx - 0.01
			end
			if my > 0 then
				my = my + 0.99
			else
				mx = mx - 0.01
			end
			mx = math.modf(mx)
			my = math.modf(my)
			for i = 0, 10 do
				if mx + i <= 63 then
					if my + i > 63 then
						break;
					end
				end
				local hb = GetS(JY.SubScene, x0 + mx + i, y0 + my + i, 4)

				if math.abs(hb - CC.YScale * i * 2) < 5 then
					mx = mx + i
					my = my + i
				end
			end
			x2, y2 = mx + x0, my + y0
			  
			if ktype == 3 then
				return x, y
			end
		end
    
		--无酒不欢：避免跳出
		if GetWarMap(x2, y2, 3) ~= nil and GetWarMap(x2, y2, 3) < 128 then
			x = x2
			y = y2
		end
	end
end

--获取武功最小内力
function War_GetMinNeiLi(pid)
	local minv = math.huge
	for i = 1, JY.Person[671]["品德"] do
		local tmpid = JY.Person[pid]["武功" .. i]
		if tmpid > 0 and JY.Wugong[tmpid]["消耗内力点数"] < minv then
			minv = JY.Wugong[tmpid]["消耗内力点数"]
		end
	end
	return minv
end

--无酒不欢：手动战斗菜单上级
function War_Manual()
	local r = nil
	local x, y, move, pic, face_dir = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], WAR.Person[WAR.CurID]["移动步数"], WAR.Person[WAR.CurID]["贴图"], WAR.Person[WAR.CurID]["人方向"]
	while true do
		if JY.Restart == 1 then
			break
		end
		WAR.ShowHead = 1
		r = War_Manual_Sub()
		--移动，这里实际返回的应该是-1
		if r == 1 or r == -1 then
			--WAR.Person[WAR.CurID]["移动步数"] = 0 
		--ESC返回
		elseif r == 0 then
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
			WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], WAR.Person[WAR.CurID]["移动步数"] = x, y, move
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, pic)
			--无酒不欢：人物面相也要还原
			WAR.Person[WAR.CurID]["人方向"] = face_dir
			--踏雪无痕的移动记录
			WAR.TXWH[WAR.Person[WAR.CurID]["人物编号"]] = {WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"],0}
		elseif r == 20 then
	
		else
			break;
		end
	end
	WAR.ShowHead = 0
	WarDrawMap(0)
	return r	--无酒不欢：这里的返回值似乎没什么庞
end
	      
--手动战斗菜单
function War_Manual_Sub()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	--local isEsc = 0
	local warmenu = {
	{"移动", War_MoveMenu, 1},	--1
	{"攻击", War_FightMenu, 1},	--2
	{"运功", War_YunGongMenu, 1},	--3
	{"战术", War_TacticsMenu, 1},	--4
	{"用毒", War_PoisonMenu, 1},	--5
	{"解毒", War_DecPoisonMenu, 1},	--6
	{"医疗", War_DoctorMenu, 1},	--7
	{"物品", War_ThingMenu, 1},	--8
	{"状态", War_StatusMenu, 1},	--9
	{"休息", War_RestMenu, 1},	--10
	{"特色", War_TgrtsMenu, 1},	--11
	{"撤退", War_Retreat, 1},	--12
	{"自动", War_AutoMenu, 1},	--13
	--{"查看", War_StatusMenu2, 1},
	}
	if JY.Base["畅想"] == 685 then
	   for i = 1, 3 do
	       if JY.Person[685]["天"..i] > 0 then
	          JY.Person[142+i]["品德"] = 0
		   end
	   end   
	end
	if match_ID(pid, 694) then
	   warmenu[5][3] = 0
	   warmenu[6][3] = 0
	   warmenu[7][3] = 0
	   warmenu[14] = {"祝由", War_Incantation, 1}
	end
	--特色指令
	if JY.Person[pid]["特色指令"] == 1 then
		--如果是畅想
		if pid == 0 then
			warmenu[11][1] = GRTS[JY.Base["畅想"]]
			if JY.Base["畅想"] == 685 then
			   warmenu[11][1] = "指令"
			end
		else
			warmenu[11][1] = GRTS[pid]
		end
	else
		warmenu[11][3] = 0
	end
	
	if match_ID(pid, 689) then
	   warmenu[5][3] = 0
	   warmenu[6][3] = 0
	   warmenu[7][3] = 0
	   warmenu[13][3] = 0
	end
  
	--虚竹
	if match_ID(pid, 49) then
		--如果没有中生死符的人物则不显示特色指令
		local t = 0
		for i = 0, WAR.PersonNum - 1 do
			local wid = WAR.Person[i]["人物编号"]
			if WAR.TZ_XZ_SSH[wid] == 1 and WAR.Person[i]["死亡"] == false then
				t = 1
			end
		end
		if t == 0 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 49 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 49 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	
	--金庸评价
	if match_ID(pid, 669) then
		--如果没有9次以上不显示特色指令
		local t = 0
		for i = 0, WAR.PersonNum - 1 do
			local wid = WAR.Person[i]["人物编号"]
			if WAR.JYPJ[wid] ~= nil and WAR.JYPJ[wid] >= 9 and WAR.Person[i]["死亡"] == false then
				t = 1
			end
		end
		if t == 0 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 669 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 669 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
  
	--祖千秋
	if match_ID(pid, 88) then
		--如果周围没有队友不显示特色指令
		local yes = 0
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 5) and i ~= WAR.CurID then
				yes = 1
			end
		end
		if yes == 0 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 88 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
		--体力小于20不显示特色指令
		--内力小于1000不显示
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 88 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end

	--人厨子
	if match_ID(pid, 89) then
		--如果周围没有队友不显示特色指令
		local px, py = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
		local mxy = {
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] + 1}, 
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1}, 
					{WAR.Person[WAR.CurID]["坐标X"] + 1, WAR.Person[WAR.CurID]["坐标Y"]}, 
					{WAR.Person[WAR.CurID]["坐标X"] - 1, WAR.Person[WAR.CurID]["坐标Y"]}}

		local yes = 0
		for i = 1, 4 do
			if GetWarMap(mxy[i][1], mxy[i][2], 2) >= 0 then
			local mid = GetWarMap(mxy[i][1], mxy[i][2], 2)
			if inteam(WAR.Person[mid]["人物编号"]) then
				yes = 1
				end
			end  
		end
		if yes == 0 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 89 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
		--体力小于25不显示特色指令
		if JY.Person[pid]["体力"] < 25 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 89 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end

	--张无忌
	if match_ID(pid, 9) then
		--如果周围没有队友不显示特色指令
		local yes = 0
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 8) and i ~= WAR.CurID then
				yes = 1
			end
		end
		if yes == 0 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 9 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 9 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--豪鬼，杀意指令
	if match_ID(pid, 673) then
		if WAR.LQZ[pid] == nil or WAR.LQZ[pid] ~= 100 then
		warmenu[11][3] = 0
		for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 673 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	--聂风指令
	if match_ID(pid, 681) then
		if WAR.LQZ[pid] == nil or WAR.LQZ[pid] ~= 100 or (PersonKF(pid, 218) and JY.Person[pid]["六如觉醒"] >= 6) == false then
		warmenu[11][3] = 0
		for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 681 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	--托奇
	if match_ID(pid, 686) then
		if JY.Person[686]["天1"] == 0 or JY.Person[pid]["体力"] < 40 then
		warmenu[11][3] = 0
		for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 686 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	--武僧
	if match_ID(pid, 676) then
		if JY.Person[pid]["体力"] < 30 or JY.Person[pid]["内力"] < 2000 or WAR.LSF[pid] ~= nil then
		warmenu[11][3] = 0
		for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 676 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--尹志平骑龙指令
	if match_ID(pid, 653) then
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["人物编号"]==59 and WAR.Person[i]["死亡"] == false then
				warmenu[11][3] = 0
				for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 653 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
			end
		end
	end
	
	--慕容复指令 幻梦
	if match_ID(pid, 51) then
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 51 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--空性指令 检测
	if match_ID(pid, 170) then
		--体力小于10不显示特色指令
		if JY.Person[pid]["体力"] < 10 or WAR.TCQ==1 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 170 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--小昭指令 影步
	if match_ID(pid, 66) then
		--体力小于30，或内力小于2000不显示特色指令
		if JY.Person[pid]["体力"] < 30 or JY.Person[pid]["内力"] < 2000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 66 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--黛绮丝指令 倾国
	if match_ID(pid, 15) then
		--体力小于20，或内力小于2000不显示特色指令
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 2000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 15 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
  
	--钟灵指令 灵貂
	if match_ID(pid, 90) then
		--体力小于10不显示特色指令
		if JY.Person[pid]["体力"] < 10 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 90 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--温青青指令 大暴
	if match_ID(pid, 91) then
		--体力小于20，或内力小于1000不显示特色指令
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 91 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--李逍遥 探云
	if match_ID(pid, 655) then
		--体力小于20，或内力小于1000不显示特色指令
		if JY.Person[pid]["体力"] < 10 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 655 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	
	--胡斐指令 飞狐
	if match_ID(pid, 1) then
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 1 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--鸠摩智指令 幻化
	if match_ID(pid, 103) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 103 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--达尔巴指令 死战
	if match_ID(pid, 160) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 or WAR.SZSD ~= -1 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 160 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--金轮 龙象
	if match_ID(pid, 62) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 62 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--黄蓉 遁甲
	if match_ID(pid, 56) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 56 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--韦小宝 口才
	if match_ID(pid, 601) then
		if JY.Person[pid]["体力"] < 60 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 601 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--苗人凤 破军
	if match_ID(pid, 3) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 3 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--何太冲 铁琴
	if match_ID(pid, 7) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 7 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--方证 金身
	if match_ID(pid, 149) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 149 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--阎基 虚弱
	if match_ID(pid, 4) then
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
			for i = 1, 3 do
			    if JY.Person[685]["天"..i] == 4 then
			       JY.Person[142+i]["品德"] = 100
				end
			end
		end
	end
	
	--出左右时，移动，解毒，医疗，物品，特色，自动不可见
	if WAR.ZYHB == 2 then
		warmenu[1][3] = 0
		warmenu[6][3] = 0
		warmenu[7][3] = 0
		warmenu[8][3] = 0
		warmenu[11][3] = 0
		warmenu[13][3] = 0
	end
	
	if WAR.XFXY == 1 then
        warmenu[12][3] = 0
		warmenu[9][3] = 0
		warmenu[10][3] = 0
		warmenu[3][3] = 0
		warmenu[4][3] = 0
		warmenu[5][3] = 0
		warmenu[6][3] = 0
		warmenu[7][3] = 0
		warmenu[8][3] = 0
		warmenu[11][3] = 0
		warmenu[13][3] = 0
	end
	
	--炽烈爆发
	if WAR.CLBF == 2 then
		warmenu[3][3] = 0
		warmenu[4][3] = 0
		warmenu[5][3] = 0
		warmenu[6][3] = 0
		warmenu[7][3] = 0
		warmenu[8][3] = 0
		warmenu[10][3] = 0
		warmenu[13][3] = 0
	end

	if WAR.HSSD == 2 then
	    warmenu[3][3] = 0
		warmenu[4][3] = 0
		warmenu[5][3] = 0
		warmenu[6][3] = 0
		warmenu[7][3] = 0
		warmenu[8][3] = 0
		warmenu[11][3] = 0
		warmenu[13][3] = 0
	end
  
	--体力小于5或者已经移动过时，移动不可见
	if JY.Person[pid]["体力"] <= 5 or WAR.Person[WAR.CurID]["移动步数"] <= 0 then
		warmenu[1][3] = 0
		--isEsc = 1
	end
  
	--判断最小内力，是否可显示攻击
	local minv = War_GetMinNeiLi(pid)
	if JY.Person[pid]["内力"] < minv or JY.Person[pid]["体力"] < 10 then
		warmenu[2][3] = 0
	end
  
	--用毒解毒医疗，567
	if JY.Person[pid]["体力"] < 10 or JY.Person[pid]["用毒能力"] < 20 then
		warmenu[5][3] = 0
	end
	if JY.Person[pid]["体力"] < 10 or JY.Person[pid]["解毒能力"] < 20 then
		warmenu[6][3] = 0
	end
	if JY.Person[pid]["体力"] < 50 or JY.Person[pid]["医疗能力"] < 20 then
		warmenu[7][3] = 0
	end
	
	
	--左慈
	if match_ID(pid, 685) then
	warmenu[11][3] = 0
	local t = 0
	      if JY.Person[JY.Person[685]["天1"]]["特色指令"] == 1 or JY.Person[JY.Person[685]["天2"]]["特色指令"] == 1 or JY.Person[JY.Person[685]["天3"]]["特色指令"] == 1 then
		  for i = 1, 3 do
		     if JY.Person[142+i]["品德"] == 0 then 
				t = t + 1
			 end
		  end
		  if t > 0 then
		  warmenu[11][3] = 1
		  end
		  end
	end
	
  
	lib.GetKey()
	Cls()
	DrawTimeBar_sub()
	return ShowMenu(warmenu, #warmenu, 0, CC.MainMenuX, CC.MainMenuY, 0, 0, 1, 1, CC.DefaultFont, C_ORANGE, C_WHITE)
end

--无酒不欢：运功选择菜单
function War_YunGongMenu()
	local id = WAR.Person[WAR.CurID]["人物编号"]
	local menu={};
	menu[1]={"运行内功",SelectNeiGongMenu,1};
	menu[2]={"停运内功",nil,1};
	menu[3]={"运行轻功",SelectQingGongMenu,1};
	menu[4]={"停运轻功",nil,1};
    local r = ShowMenu(menu,#menu,0,CC.MainSubMenuX+15,CC.MainSubMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);	
	if r == 2 then
		JY.Person[id]["主运内功"] = 0
		DrawStrBoxWaitKey(JY.Person[id]["姓名"].."停止了运行主内功",C_RED,CC.DefaultFont,nil,LimeGreen)
		return 20;
	elseif r == 20 then
		return 20;
	elseif r == 4 then
		JY.Person[id]["主运轻功"] = 0
		DrawStrBoxWaitKey(JY.Person[id]["姓名"].."停止了运行主轻功",M_DeepSkyBlue,CC.DefaultFont,nil,LimeGreen)
		return 20;
	elseif r == 20 then
		return 20;
	end
end

--无酒不欢：选择内功菜单
function SelectNeiGongMenu()
	local id, x1, y1 = WAR.Person[WAR.CurID]["人物编号"], WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
	local menu={};
	for i=1,JY.Person[671]["品德"] do
        menu[i]={JY.Wugong[JY.Person[id]["武功" .. i]]["名称"],nil,0};
		if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 6 then
			menu[i][3]=1;
		end
		--天罡不能运三大
		if id == 0 and JY.Base["标准"] == 6 and (JY.Person[id]["武功" .. i] == 106 or JY.Person[id]["武功" .. i] == 107) then
			menu[i][3]=0;	
		end
		--五岳剑诀不能运
		if JY.Person[id]["武功" .. i] == 175 then
			menu[i][3]=0
		end
		--太极神功不能运
		if JY.Person[id]["武功" .. i] == 171 then
			menu[i][3]=0
		end
		--[[独孤九剑不能运
		if JY.Person[id]["武功" .. i] == 47 then
			menu[i][3]=0
		end]]
	end
    local main_neigong =  ShowMenu(menu,#menu,0,CC.MainSubMenuX+21+4*(CC.Fontsmall+CC.RowPixel),CC.MainSubMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
	if main_neigong ~= nil and main_neigong > 0 then
		CleanWarMap(4, 0)
		SetWarMap(x1, y1, 4, 1)
		War_ShowFight(id, 0, 0, 0, 0, 0, 9)	
		AddPersonAttrib(id, "内力", -200);
		AddPersonAttrib(id, "体力", -5);
		JY.Person[id]["主运内功"] = JY.Person[id]["武功" .. main_neigong]
		return 20;
	end
end

--无酒不欢：选择轻功菜单
function SelectQingGongMenu()
	local id, x1, y1 = WAR.Person[WAR.CurID]["人物编号"], WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
	local menu={};
	for i=1,JY.Person[671]["品德"] do
        menu[i]={JY.Wugong[JY.Person[id]["武功" .. i]]["名称"],nil,0};
		if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 7 then
			menu[i][3]=1;
		end
	end
    local main_qinggong =  ShowMenu(menu,#menu,0,CC.MainSubMenuX+21+4*(CC.Fontsmall+CC.RowPixel),CC.MainSubMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
	if main_qinggong ~= nil and main_qinggong > 0 then
		CleanWarMap(4, 0)
		SetWarMap(x1, y1, 4, 1)
		War_ShowFight(id, 0, 0, 0, 0, 0, 9)	
		AddPersonAttrib(id, "体力", -10);
		WAR.YQG = 1
		JY.Person[id]["主运轻功"] = JY.Person[id]["武功" .. main_qinggong]
		return 20;
	end
end

--无酒不欢：战术菜单
function War_TacticsMenu()
	local menu={};
	menu[1]={"蓄力",nil,1};
	menu[2]={"防御",nil,1};
	menu[3]={"等待",nil,1};
	menu[4]={"集中",nil,1};
    local r = ShowMenu(menu,#menu,0,CC.MainSubMenuX+15,CC.MainSubMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
	--蓄力
	if r == 1 then
		return War_ActupMenu()
	--防御
	elseif r == 2 then
		return War_DefupMenu()
	--等待
	elseif r == 3 then
		return War_Wait()
	--集中
	elseif r == 4 then
		return War_Focus()
	--快捷键的额外判定
	elseif r == 5 then
		return 1
	--快捷键的额外判定
	elseif r == 6 then
		return 20
	end
end

--修炼武功
function War_PersonTrainBook(pid)
  local p = JY.Person[pid]
  local thingid = p["修炼物品"]
  if thingid < 0 then
    return 
  end
  JY.Thing[101]["加御剑能力"] = 1
  JY.Thing[123]["加拳掌功夫"] = 1
  local wugongid = JY.Thing[thingid]["练出武功"]
  local wg = 0
  if JY.Person[pid]["武功15"] > 0 and wugongid >= 0 then
    for i = 1, JY.Person[671]["品德"] do
      if JY.Thing[thingid]["练出武功"] == JY.Person[pid]["武功" .. i] then
        wg = 1
      end
    end
  if wg == 0 then		--修复第一版本，不可修炼武功的BUG
  	return 
	end
  end
  
  
	local yes1, yes2, kfnum = false, false, nil
	while true do 
		local needpoint = TrainNeedExp(pid)
		if needpoint <= p["修炼点数"] then
			yes1 = true
			AddPersonAttrib(pid, "生命最大值", JY.Thing[thingid]["加生命最大值"])
			--修炼血刀减少生命
			--狄云不减
			if thingid == 139 and match_ID(pid, 37) == false then
				AddPersonAttrib(pid, "生命最大值", -15)
				AddPersonAttrib(pid, "生命", -15)
				if JY.Person[pid]["生命最大值"] < 1 then
					JY.Person[pid]["生命最大值"] = 1
				end
			end
			if JY.Person[pid]["生命"] < 1 then
				JY.Person[pid]["生命"] = 1
			end
			--资质感悟点
			if JY.Person[pid]["资质"] > 50 and JY.Thing[thingid]["练出武功"] > 0 then
			   JY.Person[pid]["感悟"] = JY.Person[pid]["感悟"] + 1
			   if JY.Person[pid]["资质"] >= 80 then
			      JY.Person[pid]["感悟"] = JY.Person[pid]["感悟"] + 1
			   end
			end
			--雷震，火焰刀
			if match_ID(pid, 670) and thingid == 135 then
			    AddPersonAttrib(pid, "拳掌功夫", 5)
			end
			--龙象之力
			if JY.Person[pid]["天赋内功"] == 103 and thingid == 81 then
			    AddPersonAttrib(pid, "攻击力", 3)
			end
			--金刚不坏
			if JY.Person[pid]["天赋内功"] == 144 and thingid == 265 then
			    AddPersonAttrib(pid, "防御力", 3)
			end
			--雷震天内
			if match_ID(pid, 670) and JY.Person[0]["六如觉醒"] > 0 then
			    if thingid == 64 and JY.Person[0]["天赋内功"] == 85 then
				   AddPersonAttrib(pid, "武学常识", 3)
				   AddPersonAttrib(pid, "攻击力", 2)
				   AddPersonAttrib(pid, "轻功", 1)
				elseif thingid == 66 and JY.Person[0]["天赋内功"] == 87 then
				   AddPersonAttrib(pid, "攻击带毒", 10)
				   AddPersonAttrib(pid, "攻击力", 2)
				   AddPersonAttrib(pid, "防御力", 1)
				elseif thingid == 75 and JY.Person[0]["天赋内功"] == 98 then
				   AddPersonAttrib(pid, "攻击力", 1)
				   AddPersonAttrib(pid, "防御力", 1)
				   AddPersonAttrib(pid, "拳掌功夫", 1)
				   AddPersonAttrib(pid, "指法技巧", 1)
				   AddPersonAttrib(pid, "御剑能力", 1)
				   AddPersonAttrib(pid, "耍刀技巧", 1)
				   AddPersonAttrib(pid, "特殊兵器", 1)
				elseif thingid == 79 and JY.Person[0]["天赋内功"] == 101 then
				   AddPersonAttrib(pid, "攻击力", 2)
				   AddPersonAttrib(pid, "防御力", 2)
				   AddPersonAttrib(pid, "轻功", 1)
				elseif thingid == 85 and JY.Person[0]["天赋内功"] == 108 then
				   AddPersonAttrib(pid, "攻击力", 2)
				   AddPersonAttrib(pid, "防御力", 2)
				   AddPersonAttrib(pid, "轻功", 2)
				end
			end
			
			if thingid == 329 and JY.Person[pid]["暗器1"] ~= 100 then
			   AddPersonAttrib(pid, "暗器技巧", 30)
			   JY.Person[pid]["暗器1"] = 100
			end
			if thingid == 330 and JY.Person[pid]["暗器2"] ~= 100 then
			   AddPersonAttrib(pid, "暗器技巧", 30)
			   JY.Person[pid]["暗器2"] = 100
			end
			if thingid == 331 and JY.Person[pid]["暗器3"] ~= 100 then
			   AddPersonAttrib(pid, "暗器技巧", 30)
			   JY.Person[pid]["暗器3"] = 100
			end
			if thingid == 357 and JY.Person[pid]["暗器4"] ~= 100 then
			   AddPersonAttrib(pid, "暗器技巧", 30)
			   JY.Person[pid]["暗器4"] = 100
			end
			if thingid == 313 and JY.Person[pid]["洗髓"] ~= 100 then
			   AddPersonAttrib(pid, "拳掌功夫", 15)
			   AddPersonAttrib(pid, "指法技巧", 15)
			   AddPersonAttrib(pid, "御剑能力", 15)
			   AddPersonAttrib(pid, "耍刀技巧", 15)
			   AddPersonAttrib(pid, "特殊兵器", 15)
			   AddPersonAttrib(pid, "攻击力", 15)
			   AddPersonAttrib(pid, "防御力", 15)
			   AddPersonAttrib(pid, "轻功", 15)
			   JY.Person[pid]["洗髓"] = 100
			end
			if thingid == 118 and JY.Person[pid]["出战"] ~= 1 then
			       AddPersonAttrib(pid, "拳掌功夫", 10)
				   AddPersonAttrib(pid, "指法技巧", 10)
				   AddPersonAttrib(pid, "御剑能力", 10)
				   AddPersonAttrib(pid, "耍刀技巧", 10)
				   AddPersonAttrib(pid, "特殊兵器", 10)
				   if JY.Base["特殊"] ==1 and JY.Person[13]["血量翻倍"]==1 and pid==0 then
				   AddPersonAttrib(pid, "拳掌功夫", 10)
				   AddPersonAttrib(pid, "指法技巧", 10)
				   AddPersonAttrib(pid, "御剑能力", 10)
				   AddPersonAttrib(pid, "耍刀技巧", 10)
				   AddPersonAttrib(pid, "特殊兵器", 10)
				   end
				   if (JY.Person[670]["无用"] == 2 and pid == 0) then
				   AddPersonAttrib(pid, "拳掌功夫", 10)
				   AddPersonAttrib(pid, "指法技巧", 10)
				   AddPersonAttrib(pid, "御剑能力", 10)
				   AddPersonAttrib(pid, "耍刀技巧", 10)
				   AddPersonAttrib(pid, "特殊兵器", 10)
				   end
				   if (match_ID(pid, 677) or match_ID(pid, 684) or match_ID(pid, 686) or match_ID(pid, 56)) then
				   AddPersonAttrib(pid, "拳掌功夫", 10)
				   AddPersonAttrib(pid, "指法技巧", 10)
				   AddPersonAttrib(pid, "御剑能力", 10)
				   AddPersonAttrib(pid, "耍刀技巧", 10)
				   AddPersonAttrib(pid, "特殊兵器", 10)
				   end
				   if match_ID(pid, 689) or match_ID(pid, 634) then
				   AddPersonAttrib(pid, "拳掌功夫", 50)
				   AddPersonAttrib(pid, "指法技巧", 50)
				   AddPersonAttrib(pid, "御剑能力", 50)
				   AddPersonAttrib(pid, "耍刀技巧", 50)
				   AddPersonAttrib(pid, "特殊兵器", 50)
				   end
				   JY.Person[pid]["出战"] = 1
			end
			--标主修炼秘籍
			if JY.Thing[thingid]["练出武功"] > 0  and pid == 0 then
			if JY.Base["标准"] == 1 and JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 1 then
				   AddPersonAttrib(pid, "拳掌功夫", 1)
			elseif JY.Base["标准"] == 2 and JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 2 then
				   AddPersonAttrib(pid, "指法技巧", 1)
			elseif JY.Base["标准"] == 3 and JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 3 then
				   AddPersonAttrib(pid, "御剑能力", 1)
			elseif JY.Base["标准"] == 4 and JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 4 then
				   AddPersonAttrib(pid, "耍刀技巧", 1)
			elseif JY.Base["标准"] == 5 and JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 5 then
				   AddPersonAttrib(pid, "特殊兵器", 1)
			elseif JY.Base["标准"] == 6 and JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 6 then
			       AddPersonAttrib(pid, "拳掌功夫", 1)
				   AddPersonAttrib(pid, "指法技巧", 1)
				   AddPersonAttrib(pid, "御剑能力", 1)
				   AddPersonAttrib(pid, "耍刀技巧", 1)
				   AddPersonAttrib(pid, "特殊兵器", 1)
            end
			end	
			--聪明人
			if JY.Thing[thingid]["练出武功"] > 0 and (JY.Person[670]["无用"] == 2 and pid == 0) then
			    if JY.Thing[thingid]["加攻击力"]>0 then
			    AddPersonAttrib(pid, "攻击力", 1)
				end
				if JY.Thing[thingid]["加轻功"]>0 then
			    AddPersonAttrib(pid, "轻功", 1)
				end
				if JY.Thing[thingid]["加防御力"]>0 then
			    AddPersonAttrib(pid, "防御力", 1)
				end
				if JY.Thing[thingid]["加拳掌功夫"]>0 then
				AddPersonAttrib(pid, "拳掌功夫", 1)
				end
				if JY.Thing[thingid]["加指法技巧"]>0 then
				AddPersonAttrib(pid, "指法技巧", 1)
				end
				if JY.Thing[thingid]["加御剑能力"]>0 then
				AddPersonAttrib(pid, "御剑能力", 1)
				end
				if JY.Thing[thingid]["加耍刀技巧"]>0 then
				AddPersonAttrib(pid, "耍刀技巧", 1)
				end
				if JY.Thing[thingid]["加特殊兵器"]>0 then
				AddPersonAttrib(pid, "特殊兵器", 1)
				end
			end	
			if match_ID(pid, 677) then
			    if JY.Thing[thingid]["加攻击力"]>0 then
			    AddPersonAttrib(pid, "攻击力", 1)
				end
				if JY.Thing[thingid]["加轻功"]>0 then
			    AddPersonAttrib(pid, "轻功", 1)
				end
				if JY.Thing[thingid]["加防御力"]>0 then
			    AddPersonAttrib(pid, "防御力", 1)
				end
				if JY.Thing[thingid]["加拳掌功夫"]>0 then
				AddPersonAttrib(pid, "拳掌功夫", 1)
				end
				if JY.Thing[thingid]["加指法技巧"]>0 then
				AddPersonAttrib(pid, "指法技巧", 1)
				end
				if JY.Thing[thingid]["加御剑能力"]>0 then
				AddPersonAttrib(pid, "御剑能力", 1)
				end
				if JY.Thing[thingid]["加耍刀技巧"]>0 then
				AddPersonAttrib(pid, "耍刀技巧", 1)
				end
				if JY.Thing[thingid]["加特殊兵器"]>0 then
				AddPersonAttrib(pid, "特殊兵器", 1)
				end
			end
				    
			--无名修炼内功剑法+2，修炼剑法系数加倍
			if match_ID(pid, 671) and JY.Thing[thingid]["练出武功"] > 0 then
			   if JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] >= 1 and JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] <= 7 and JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] ~= 3 then
			      AddPersonAttrib(pid, "御剑能力", 1)
			   end
			   if JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 3 then
			      AddPersonAttrib(pid, "御剑能力", 2)
				  if JY.Person[671]["阶"] >= 1 then
				  AddPersonAttrib(pid, "御剑能力", 1)
				  end
			   end
			end
			--聂风刀
			if match_ID(pid, 681) and JY.Thing[thingid]["练出武功"] > 0 then
			   if JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 4 then
			      AddPersonAttrib(pid, "耍刀技巧", 1)
			   end
			end
			--西门吹雪
			if match_ID(pid, 683) and JY.Thing[thingid]["练出武功"] > 0 then
			   if JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 3 then
			      AddPersonAttrib(pid, "御剑能力", 1)
			   end
			end
			--李寻欢
			if match_ID(pid, 684) and JY.Thing[thingid]["练出武功"] > 0 then
			    if JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 1 then
			      AddPersonAttrib(pid, "拳掌功夫", 1)
			    elseif JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 2 then
			      AddPersonAttrib(pid, "指法技巧", 1)
				elseif JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 3 then
			      AddPersonAttrib(pid, "御剑能力", 1)
				elseif JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 4 then
			      AddPersonAttrib(pid, "耍刀技巧", 1)
				elseif JY.Wugong[JY.Thing[thingid]["练出武功"]]["武功类型"] == 5 then
			      AddPersonAttrib(pid, "特殊兵器", 1)  
			    end
			end
			--fy
			if match_ID(pid, 10) and JY.Person[10]["阶"] >= 2 and JY.Thing[thingid]["练出武功"] > 0 then
			      AddPersonAttrib(pid, "拳掌功夫", 1)

			      AddPersonAttrib(pid, "指法技巧", 1)

			      AddPersonAttrib(pid, "御剑能力", 1)

			      AddPersonAttrib(pid, "耍刀技巧", 1)

			      AddPersonAttrib(pid, "特殊兵器", 1)  
			end
			if match_ID(pid, 64) and JY.Person[64]["阶"] >= 1 and JY.Thing[thingid]["练出武功"] > 0 then
			      AddPersonAttrib(pid, "攻击力", 1)

			      AddPersonAttrib(pid, "防御力", 1)

			      AddPersonAttrib(pid, "轻功", 1) 
			end
			if match_ID(pid, 686) then
				if JY.Thing[thingid]["加拳掌功夫"]>0 then
				AddPersonAttrib(pid, "拳掌功夫", 2)
				end
				if JY.Thing[thingid]["加指法技巧"]>0 then
				AddPersonAttrib(pid, "指法技巧", 2)
				end
				if JY.Thing[thingid]["加御剑能力"]>0 then
				AddPersonAttrib(pid, "御剑能力", 2)
				end
				if JY.Thing[thingid]["加耍刀技巧"]>0 then
				AddPersonAttrib(pid, "耍刀技巧", 2)
				end
				if JY.Thing[thingid]["加特殊兵器"]>0 then
				AddPersonAttrib(pid, "特殊兵器", 2)
				end
				if JY.Thing[thingid]["加攻击力"]>0 then
			    AddPersonAttrib(pid, "攻击力", 2)
				end
				if JY.Thing[thingid]["加轻功"]>0 then
			    AddPersonAttrib(pid, "轻功", 2)
				end
				if JY.Thing[thingid]["加防御力"]>0 then
			    AddPersonAttrib(pid, "防御力", 2)
				end
			end
			if match_ID(pid, 689) or match_ID(pid, 634) then
				if JY.Thing[thingid]["加拳掌功夫"]>0 then
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加拳掌功夫"])
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加拳掌功夫"])
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加拳掌功夫"])
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加拳掌功夫"])
				end
				if JY.Thing[thingid]["加指法技巧"]>0 then
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加指法技巧"])
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加指法技巧"])
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加指法技巧"])
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加指法技巧"])
				end
				if JY.Thing[thingid]["加御剑能力"]>0 then
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加御剑能力"])
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加御剑能力"])
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加御剑能力"])
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加御剑能力"])
				end
				if JY.Thing[thingid]["加耍刀技巧"]>0 then
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加耍刀技巧"])
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加耍刀技巧"])
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加耍刀技巧"])
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加耍刀技巧"])
				end
				if JY.Thing[thingid]["加特殊兵器"]>0 then
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加特殊兵器"])
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加特殊兵器"])
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加特殊兵器"])
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加特殊兵器"])
				end
			end
	    
			AddPersonAttrib(pid, "内力最大值", JY.Thing[thingid]["加内力最大值"])
	
			--无酒不欢 学富五车	
			if JY.Base["特殊"] ==1 and JY.Person[14]["血量翻倍"]==1 and pid==0 then
				if JY.Thing[thingid]["加攻击力"]>0 then
			AddPersonAttrib(pid, "攻击力", JY.Thing[thingid]["加攻击力"]+1)
				end
				if JY.Thing[thingid]["加轻功"]>0 then
			AddPersonAttrib(pid, "轻功", JY.Thing[thingid]["加轻功"]+1)
				end
				if JY.Thing[thingid]["加防御力"]>0 then
			AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"]+1)
				end
			else
			AddPersonAttrib(pid, "攻击力", JY.Thing[thingid]["加攻击力"])
			AddPersonAttrib(pid, "轻功", JY.Thing[thingid]["加轻功"])
			AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"])
			end
			AddPersonAttrib(pid, "医疗能力", JY.Thing[thingid]["加医疗能力"])
			AddPersonAttrib(pid, "用毒能力", JY.Thing[thingid]["加用毒能力"])
			AddPersonAttrib(pid, "解毒能力", JY.Thing[thingid]["加解毒能力"])
			AddPersonAttrib(pid, "抗毒能力", JY.Thing[thingid]["加抗毒能力"])
			if match_ID(pid, 56) then		--黄蓉 双倍兵器值
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"] * 2)
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"] * 2)
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"] * 2)
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"] * 2)
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"] * 2)
			--无酒不欢 满腹经纶	
			elseif JY.Base["特殊"] ==1 and JY.Person[13]["血量翻倍"]==1 and pid==0 then
				if JY.Thing[thingid]["加拳掌功夫"]>0 then
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"]+1)
				end
				if JY.Thing[thingid]["加指法技巧"]>0 then
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"]+1)
				end
				if JY.Thing[thingid]["加御剑能力"]>0 then
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"]+1)
				end
				if JY.Thing[thingid]["加耍刀技巧"]>0 then
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"]+1)
				end
				if JY.Thing[thingid]["加特殊兵器"]>0 then
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"]+1)
				end
			else
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"])
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"])
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"])
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"])
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"])
			end
			
			AddPersonAttrib(pid, "暗器技巧", JY.Thing[thingid]["加暗器技巧"])
			AddPersonAttrib(pid, "武学常识", JY.Thing[thingid]["加武学常识"])
			AddPersonAttrib(pid, "品德", JY.Thing[thingid]["加品德"])
			AddPersonAttrib(pid, "攻击带毒", JY.Thing[thingid]["加攻击带毒"])
			if JY.Thing[thingid]["加攻击次数"] == 1 then
			  p["左右互搏"] = 1
			end
			p["修炼点数"] = p["修炼点数"] - needpoint

			if wugongid >= 0 then 
				yes2 = true
				local oldwugong = 0
				for i = 1, JY.Person[671]["品德"] do
					if p["武功" .. i] == wugongid then
						oldwugong = 1
						p["武功等级" .. i] = math.modf((p["武功等级" .. i] + 100) / 100) * 100
						kfnum = i
						break;
					end
				end
				if oldwugong == 0 then
					for i = 1, JY.Person[671]["品德"] do
						if p["武功" .. i] == 0 then
							p["武功" .. i] = wugongid
							p["武功等级" .. i] = 0;
							kfnum = i
							break;
						end
					end
				end
			end
		else
			break;
		end
	end
	if yes1 then
		DrawStrBoxWaitKey(string.format("%s 修炼 %s 成功", p["姓名"], JY.Thing[thingid]["名称"]), C_WHITE, CC.DefaultFont)
	end
	if yes2 then
		--无酒不欢：自动到极的判定在这里
		if p["武功等级" .. kfnum] == 900 then
			--胡斐等人优先判定
			if (match_ID(pid, 1) and wugongid == 67) or (match_ID(pid, 37) and wugongid == 94) or (match_ID(pid, 49) and wugongid == 14) or (match_ID(pid, 672) and wugongid == 94) then
				DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"], math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
			--内功和轻功
			elseif JY.Wugong[wugongid]["武功类型"] == 6 or JY.Wugong[wugongid]["武功类型"] == 7 then
				--三大吸功直接到极
				if wugongid == 85 or wugongid == 87 or wugongid == 88 then
					p["武功等级" .. kfnum] = 999
					DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE, CC.DefaultFont)
				--天内天轻可以到极
				elseif wugongid == p["天赋内功"] or wugongid == p["天赋轻功"] or JY.Person[pid]["专1"] == wugongid or JY.Person[pid]["专2"] == wugongid then
					p["武功等级" .. kfnum] = 999
					DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE, CC.DefaultFont)
					
				elseif ((pid == 0 and JY.Base["标准"] == 6) or (match_ID(pid, 48) and JY.Person[48]["天1"] == 1)) and JY.Wugong[wugongid]["武功类型"] == 6 then
					p["武功等级" .. kfnum] = 999
					DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE, CC.DefaultFont)
				elseif JY.Base["特殊"] == 3 and pid == 0 then
					p["武功等级" .. kfnum] = 999
					DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE, CC.DefaultFont)
				elseif match_ID(pid, 685) then
					p["武功等级" .. kfnum] = 999
					DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE, CC.DefaultFont)	
				else
					DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"], math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
				end
			--外功直接到极
			else
				p["武功等级" .. kfnum] = 999
				DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE, CC.DefaultFont)
			end
		else
			DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"], math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
		end
	end
end

--特色指令--指令效果
function War_TgrtsMenu()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	Cls()
	WAR.ShowHead = 0
	WarDrawMap(0)
	local grts_id;
	--如果是畅想
	if pid == 0 then
		grts_id = JY.Base["畅想"]
	else
		grts_id = pid
	end
	--左慈
	local a,b,c = JY.Person[685]["天1"],JY.Person[685]["天2"],JY.Person[685]["天3"]

	
	if match_ID(pid, 685) then
	--[[local str1,str2,str3,str4,str5,str6 = "无","无","无","","",""
	    if JY.Person[a]["特色指令"] == 1 then
	       str1 = GRTS[a]
		   str4 = GRTSSAY[a]
		end
		if JY.Person[b]["特色指令"] == 1 then
	       str2 = GRTS[b]
		   str5 = GRTSSAY[b]
		end
		if JY.Person[c]["特色指令"] == 1 then
	       str3 = GRTS[c]
		   str6 = GRTSSAY[c]
		end]]
		
	    local wg = ZuoCi() --JYMsgBox("指令", str1.."*"..str4.."*"..str2.."*"..str5.."*"..str3.."*"..str6, {str1, str2, str3}, 3)
		if wg > 0 then
		   if wg == 1 then
		   GRTSSAY[685] = GRTSSAY[JY.Person[685]["天1"]]
		   GRTS[685] = GRTS[JY.Person[685]["天1"]]
		      JY.Person[685]["天1"] = a
			  JY.Person[685]["天2"] = 0
	          JY.Person[685]["天3"] = 0
		   elseif wg == 2 then	
		   GRTSSAY[685] = GRTSSAY[JY.Person[685]["天2"]]
		   GRTS[685] = GRTS[JY.Person[685]["天2"]]
 		      JY.Person[685]["天2"] = b
			  JY.Person[685]["天1"] = 0
			  JY.Person[685]["天3"] = 0
		   elseif wg == 3 then	
		   GRTSSAY[685] = GRTSSAY[JY.Person[685]["天3"]]
		   GRTS[685] = GRTS[JY.Person[685]["天3"]]
 		      JY.Person[685]["天3"] = c
			  JY.Person[685]["天1"] = 0
			  JY.Person[685]["天2"] = 0
	       end	  
		end
	end
	
	--郭襄的指令特殊
	if match_ID(pid, 626) then
		local wg = JYMsgBox("特色指令：" .. GRTS[grts_id], GRTSSAY[grts_id], {"弹指", "玉萧", "落英"}, 3, WAR.tmp[5000+WAR.CurID],1)
		if wg == 1 then
			JY.Person[pid]["武功1"] = 18
		elseif wg == 2 then
			JY.Person[pid]["武功1"] = 38
		elseif wg == 3 then
			JY.Person[pid]["武功1"] = 12
		end
		JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
		return 0
	--霍青桐兵法指令
	elseif match_ID(pid, 74) then
		local c = JYMsgBox("特色指令：" .. GRTS[grts_id], GRTSSAY[grts_id], {"借刀杀人", "固若金汤", "火烧连营", "霸王别姬", "军神再临"}, 5, WAR.tmp[5000+WAR.CurID],1)
		if c == 1 then
			if JY.Base["天书数量"] < 2 then
				DrawStrBoxWaitKey("指令<借刀杀人>需要收集2本天书！", C_WHITE, CC.DefaultFont)
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			local num = 0
			local e_list = {}
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					table.insert(e_list, i)
					num = num + 1
				end
			end
			local name = {}
			for i = 1, num do
				name[i] = {}
				name[i][1] = JY.Person[WAR.Person[e_list[i]]['人物编号']]['姓名']
				name[i][2] = nil
				name[i][3] = 1
			end
			DrawStrBox(CC.MainMenuX, CC.MainMenuY, "借刀杀人：", C_GOLD, CC.DefaultFont)
			local c = ShowMenu(name, num, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
			local o_id = WAR.CurID
			WAR.CurID = e_list[c]
			Cls()
			WAR.NZQK = 3
			WAR.HQT_JDSR = true
			War_FightMenu()
			WAR.NZQK = 0
			WAR.HQT_JDSR = nil
			WAR.CurID = o_id
		elseif c == 2 then
			if JY.Base["天书数量"] < 4 then
				DrawStrBoxWaitKey("指令<固若金汤>需要收集4本天书！", C_WHITE, CC.DefaultFont)
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			WAR.HQT_GRJT = {}
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					WAR.HQT_GRJT[WAR.Person[i]["人物编号"]] = 100
				end
			end
		elseif c == 3 then
			if JY.Base["天书数量"] < 6 then
				DrawStrBoxWaitKey("指令<火烧连营>需要收集6本天书！", C_WHITE, CC.DefaultFont)
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			CleanWarMap(4, 0)
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
					JY.Person[WAR.Person[i]["人物编号"]]['灼烧程度'] = 50
				end
			end
			War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, 0, 0, 0, 0, 58)
		elseif c == 4 then
			if JY.Base["天书数量"] < 8 then
				DrawStrBoxWaitKey("指令<霸王别姬>需要收集8本天书！", C_WHITE, CC.DefaultFont)
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			local num = 0
			local e_list = {}
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false and JY.Person[WAR.Person[i]['人物编号']]['性别'] == 1 then
					table.insert(e_list, i)
					num = num + 1
				end
			end
			if num > 0 then
				local name = {}
				for i = 1, num do
					name[i] = {}
					name[i][1] = JY.Person[WAR.Person[e_list[i]]['人物编号']]['姓名']
					name[i][2] = nil
					name[i][3] = 1
					name[i][4] = e_list[i]
				end
				DrawStrBox(CC.MainMenuX, CC.MainMenuY, "霸王别姬：", C_GOLD, CC.DefaultFont)
				local c = ShowMenu(name, num, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
				WAR.Person[e_list[c]]["死亡"] = true
			else
				DrawStrBoxWaitKey("在场的敌方中已经没有女性角色了！", C_WHITE, CC.DefaultFont)
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
		elseif c == 5 then
			if JY.Base["天书数量"] < 10 then
				DrawStrBoxWaitKey("指令<军神再临>需要收集10本天书！", C_WHITE, CC.DefaultFont)
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			WAR.HQT_JSZL = {}
			WAR.HQT_JSZL[pid] = 100
		else
		JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end

	else
		local yn = JYMsgBox("特色指令：" .. GRTS[grts_id], GRTSSAY[grts_id], {"确定", "取消"}, 2, WAR.tmp[5000+WAR.CurID])
		if yn == 2 then
		JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
  
	--段誉
	if match_ID(pid, 53) then
		if JY.Person[pid]["体力"] > 20 then
			WAR.TZ_DY = 1
			PlayWavE(16)
			CurIDTXDH(WAR.CurID, 72,1, "休迅飞凫 飘忽若神", M_DeepSkyBlue, 15);
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--I DOHATSU SHOTEN --II
	if match_ID(pid, 673) then
	   WAR.SYBD[pid] = 100
	   if JY.Person[673]["外号2"] == "烈" then
	   CurIDTXDH(WAR.CurID, 6, 1, "炽烈爆发")
	   else
	   CurIDTXDH(WAR.CurID, 6, 1, "怒火冲天")
	   end
	   WAR.LQZ[pid] = nil
	   if math.random(2) == 1 then
	   PlayMIDI(123)
	   else
	   PlayMIDI(124)
	   end
	   JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
	   return 20
	end
	
	if match_ID(pid, 681) then
	   WAR.MXD[pid] = 50   
	   CurIDTXDH(WAR.CurID, 115, 1, "入魔")
	   JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
	   return 20
	end
	
	if match_ID(pid, 686) then
	   local mk = JYMsgBox("请选择点穴", "心灵台：*回复15%生命，35时序内持续回复生命*刹活孔：*失去25%生命内力，35时序集气速度和伤害提升50%   ", {"心灵台", "刹活孔"}, 2)
	   
	   if mk == 1 then
	   AddPersonAttrib(pid, "体力", -25)
	   AddPersonAttrib(pid, "生命", math.modf(JY.Person[pid]["生命最大值"]*0.15))
	   CurIDTXDH(WAR.CurID, 91, 1, "秘孔・心灵台")
	   WAR.XLT[pid] = 35
	   end
	   
	   if mk == 2 then
	   AddPersonAttrib(pid, "体力", -25)
	   AddPersonAttrib(pid, "生命", -math.modf(JY.Person[pid]["生命"]*0.25))
	   AddPersonAttrib(pid, "内力", -math.modf(JY.Person[pid]["内力"]*0.25))
	   CurIDTXDH(WAR.CurID, 7, 1, "秘孔・刹活孔")
	   WAR.SHK[pid] = 35
	   end
	end
	
	--灵光悟
	if match_ID(pid, 676) then
	   if JY.Person[pid]["体力"] >= 30 and JY.Person[pid]["内力"] >= 2000 then
	        CleanWarMap(4,0);
			AddPersonAttrib(pid, "体力", -25)
			AddPersonAttrib(pid, "内力", -1500)
			CurIDTXDH(WAR.CurID, 158, 1, "流沙覆")
			WAR.LSF[pid] = 60
	   end
	end
	
	--尹志平
	if match_ID(pid, 653) then
		if JY.Person[pid]["体力"] > 50 then
			WAR.LRHF[pid] = 20
			CurIDTXDH(WAR.CurID, 72,1, "终南山下 活死人墓 神雕侠侣 绝迹江湖", M_DeepSkyBlue, 50);
			local x, y = WE_xy(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] -1)
			WAR.Data["自动选择参战人2"] = 59
			NewWARPersonZJ(59, true, x, y, false, 2)
		local function fightcombo()
			local combo = {}
			for i = 1, #CC.COMBO do
				combo[i] = {CC.COMBO[i][1], CC.COMBO[i][2], CC.COMBO[i][3],0}
			end
			for i = 0, WAR.PersonNum - 1 do
				local t = WAR.Person[i]["人物编号"]
				for j = 1, #combo do
					lib.GetKey()
					if match_ID(t, combo[j][1]) then
						for z = 0, WAR.PersonNum - 1 do
							local t2 = WAR.Person[z]["人物编号"]
							if match_ID(t2, combo[j][2]) and WAR.Person[i]["我方"] == WAR.Person[z]["我方"] then
								combo[j][4] = 1
								break
							end
						end
					end
				end
			end
			for i = 1, #combo do
				if combo[i][4] == 1 then
					local t1 = combo[i][1]
					local t2 = combo[i][2]
					for j = 0, 10 do
						lib.GetKey()
						local str = JY.Person[t1]["姓名"].."＆"..JY.Person[t2]["姓名"]
						local str2 = combo[i][3]
						Cls()
						DrawBox(150, CC.ScreenH / 3 + 30, CC.ScreenW - 150, CC.ScreenH / 3 * 2 - 20, C_BLACK)
						lib.LoadPNG(1, JY.Person[t1]["头像代号"]*2, CC.ScreenW / 4 - 80, CC.ScreenH / 2 - 35, 1)
						lib.LoadPNG(1, JY.Person[t2]["头像代号"]*2, CC.ScreenW / 4 + 50, CC.ScreenH / 2 - 35, 1)
						NewDrawString(CC.ScreenW / 2 * 3 - 170, CC.ScreenH + 120, str, C_ORANGE, 25)	
						NewDrawString(CC.ScreenW / 2 * 3 - 170, -1, str2, C_GOLD, 50 + j)
						ShowScreen()							
						lib.Delay(30)	
					end		
					lib.Delay(400)	
				end
			end
		end
		fightcombo()
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 50
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--金庸评价
	if match_ID(pid, 669) then
	   JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
       local num = 0
	   local e_list = {}
	   for i = 0, WAR.PersonNum - 1 do
	   if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false and WAR.JYPJ[WAR.Person[i]['人物编号']] ~= nil and WAR.JYPJ[WAR.Person[i]['人物编号']] >= 9 then
			table.insert(e_list, i)
			num = num + 1
	   end
	   end
			    if num > 0 then
				local name = {}
				for i = 1, num do
					name[i] = {}
					name[i][1] = JY.Person[WAR.Person[e_list[i]]['人物编号']]['姓名']
					name[i][2] = nil
					name[i][3] = 1
					name[i][4] = e_list[i]
				end
				DrawStrBox(CC.MainMenuX, CC.MainMenuY, "金庸评价：", C_GOLD, CC.DefaultFont)
		        local c = ShowMenu(name, num, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
				local x = math.random(3)
				if x == 1 then
				   if math.random(2) == 1 then
				   say("你的表演没有达到我觉得"..JY.Person[WAR.Person[e_list[c]]['人物编号']]['姓名'].."应该有的样子。差太远了。", 400,0,"金先生")
				   else
				   say("你完全没有体会到"..JY.Person[WAR.Person[e_list[c]]['人物编号']]['姓名'].."的内心情感。我觉得不行。", 400,0,"金先生")
				   end
				   WAR.Person[e_list[c]]["死亡"] = true
				elseif x == 2 then
				   if math.random(2) == 1 then
                   say("你把"..JY.Person[WAR.Person[e_list[c]]['人物编号']]['姓名'].."演得活灵活现。很好。", 400,0,"金先生")
				   else
				   say("你就像"..JY.Person[WAR.Person[e_list[c]]['人物编号']]['姓名'].."本人。不错。", 400,0,"金先生")
				   end
                else
				   if math.random(2) == 1 then
                   say("你这个"..JY.Person[WAR.Person[e_list[c]]['人物编号']]['姓名'].."演得还不够到位。再琢磨琢磨吧。", 400,0,"金先生")
				   JY.Person[WAR.Person[e_list[c]]['人物编号']]["生命"] = JY.Person[WAR.Person[e_list[c]]['人物编号']]["生命"] - math.modf(JY.Person[WAR.Person[e_list[c]]['人物编号']]["生命"]*0.5)
				   WAR.HMZT[WAR.Person[e_list[c]]['人物编号']] = 1
				   else
				   say("你把"..JY.Person[WAR.Person[e_list[c]]['人物编号']]['姓名'].."演得有气无力，这样是不行的。", 400,0,"金先生")
				   JY.Person[WAR.Person[e_list[c]]['人物编号']]["内力"] = JY.Person[WAR.Person[e_list[c]]['人物编号']]["内力"] - math.modf(JY.Person[WAR.Person[e_list[c]]['人物编号']]["内力"]*0.5)
				   JY.Person[WAR.Person[e_list[c]]['人物编号']]["体力"] = JY.Person[WAR.Person[e_list[c]]['人物编号']]["体力"] - math.modf(JY.Person[WAR.Person[e_list[c]]['人物编号']]["体力"]*0.5)
				   end				
				end
				WAR.JYPJ[WAR.Person[e_list[c]]['人物编号']] = nil
				AddPersonAttrib(pid, "体力", -10)
				end
    end				
  
	--虚竹
	if match_ID(pid, 49) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
		  JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 5
		  JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
		  local ssh = {}
		  local num = 1
		  for i = 0, WAR.PersonNum - 1 do
			local wid = WAR.Person[i]["人物编号"]
			if WAR.TZ_XZ_SSH[wid] == 1 and WAR.Person[i]["死亡"] == false then
				--封穴25点
				if WAR.FXDS[wid] == nil then
					WAR.FXDS[wid] = 25
				else
					WAR.FXDS[wid] = WAR.FXDS[wid] + 25
				end
				if WAR.FXDS[wid] > 25 then
					WAR.FXDS[wid] = 25
				end
				WAR.TZ_XZ_SSH[wid] = nil
				if WAR.Person[i].Time > 995 then
					WAR.Person[i].Time = 995
				end
				ssh[num] = {}
				ssh[num][1] = i
				ssh[num][2] = wid
				num = num + 1
			end
		  end
		  local name = {}
		  for i = 1, num - 1 do
			name[i] = {}
			name[i][1] = JY.Person[ssh[i][2]]["姓名"]
			name[i][2] = nil
			name[i][3] = 1
		  end
		  DrawStrBox(CC.MainMenuX, CC.MainMenuY, "催符：", C_GOLD, CC.DefaultFont)
		  ShowMenu(name, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
		  Cls()
		  PlayWavAtk(32)
		  CurIDTXDH(WAR.CurID, 72,1, "符掌生死 德折群雄")
		  PlayWavE(8)
		  local sssid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
		  for DH = 114, 129 do
			for i = 1, num - 1 do
			  local x0 = WAR.Person[WAR.CurID]["坐标X"]
			  local y0 = WAR.Person[WAR.CurID]["坐标Y"]
			  local dx = WAR.Person[ssh[i][1]]["坐标X"] - x0
			  local dy = WAR.Person[ssh[i][1]]["坐标Y"] - y0
			  local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
			  local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
			  local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

			  ry = ry - hb
			  lib.PicLoadCache(3, DH * 2, rx, ry, 2, 192)
			  if DH > 124 then
				DrawString(rx - 10, ry - 15, "封穴", C_GOLD, CC.DefaultFont)
			  end
			end
			lib.ShowSurface(0)
			lib.LoadSur(sssid, 0, 0)
			lib.Delay(30)
		  end
		  lib.FreeSur(sssid)
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
  
  --人厨子
  if match_ID(pid, 89) then
    if JY.Person[pid]["体力"] > 25 and JY.Person[pid]["内力"] > 300 then
      local px, py = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
      local mxy = {
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] + 1}, 
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1}, 
					{WAR.Person[WAR.CurID]["坐标X"] + 1, WAR.Person[WAR.CurID]["坐标Y"]}, 
					{WAR.Person[WAR.CurID]["坐标X"] - 1, WAR.Person[WAR.CurID]["坐标Y"]}}
      local zdp = {}
      local num = 1
      for i = 1, 4 do
        if GetWarMap(mxy[i][1], mxy[i][2], 2) >= 0 then
          local mid = GetWarMap(mxy[i][1], mxy[i][2], 2)
          if inteam(WAR.Person[mid]["人物编号"]) then
          	zdp[num] = WAR.Person[mid]["人物编号"]
          	num = num + 1
        	end
        end
        
      end
      local zdp2 = {}
      for i = 1, num - 1 do
        zdp2[i] = {}
        zdp2[i][1] = JY.Person[zdp[i]]["姓名"] .. "・" .. JY.Person[zdp[i]]["体力"]
        zdp2[i][2] = nil
        zdp2[i][3] = 1
      end
      DrawStrBox(CC.MainMenuX, CC.MainMenuY, "气补：", C_GOLD, CC.DefaultFont)
      local r = ShowMenu(zdp2, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
      Cls()
      AddPersonAttrib(zdp[r], "体力", 50)
      AddPersonAttrib(pid, "体力", -25)
      AddPersonAttrib(pid, "内力", -300)
      PlayWavE(28)
      lib.Delay(10)
      CurIDTXDH(WAR.CurID, 86,1, "化气补元")
      local Ocur = WAR.CurID
      for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["人物编号"] == zdp[r] then
          WAR.CurID = i
        end
      end
      WarDrawMap(0)
      PlayWavE(36)
      lib.Delay(100)
      CurIDTXDH(WAR.CurID, 86, 1, "恢复体力50点")
      WAR.CurID = Ocur
      WarDrawMap(0)
    else
    	DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
		JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
    	return 0
    end
  end
  
 
  
  --张无忌
  if match_ID(pid, 9) then
    if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 500 then
      local nyp = {}
      local num = 1
      for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 8) and i ~= WAR.CurID then
          nyp[num] = {}
          nyp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"]
          nyp[num][2] = nil
          nyp[num][3] = 1
          nyp[num][4] = i
          num = num + 1
        end
      end
      DrawStrBox(CC.MainMenuX, CC.MainMenuY, "挪移：", C_GOLD, CC.DefaultFont)
      local r = ShowMenu(nyp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
      Cls()
      local mid = WAR.Person[nyp[r][4]]["人物编号"]
      QZXS("请选择要将" .. JY.Person[mid]["姓名"] .. "挪移到什么位置？")
      War_CalMoveStep(WAR.CurID, 8, 1)
      local nx, ny = nil, nil
        while true do
	      nx, ny = War_SelectMove()
	      if nx ~= nil then
		      if lib.GetWarMap(nx, ny, 2) > 0 or lib.GetWarMap(nx, ny, 5) > 0 then
		        QZXS("此处有人！请重新选择")			--此处有人！请重新选择
	      	elseif CC.SceneWater[lib.GetWarMap(nx, ny, 0)] ~= nil then
	        	QZXS("水面，不可进入！请重新选择")		--水面，不可进入！请重新选择
	       	else
	       		break;
	        end
	      end
	    end
	    PlayWavE(5)
	    CurIDTXDH(WAR.CurID, 88,1, "九阳明尊 挪移乾坤")		--九阳明尊 挪移乾坤
	    local Ocur = WAR.CurID
	    WAR.CurID = nyp[r][4]
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 88,1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 88,1)
	    WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 88,1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 88,1)
	    WAR.CurID = Ocur
	    AddPersonAttrib(pid, "体力", -10)
	    AddPersonAttrib(pid, "内力", -500)
	    
	  else
	  	DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
		JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
	  	return 0
	  end
	end
	
	--祖千秋
	if match_ID(pid, 88) then
	  if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 700 then
	    local dxp = {}
	    local num = 1
	    for i = 0, WAR.PersonNum - 1 do
	      if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 5) and i ~= WAR.CurID then
	        dxp[num] = {}
	        dxp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"]
	        dxp[num][2] = nil
	        dxp[num][3] = 1
	        dxp[num][4] = i
	        num = num + 1
	      end
	    end
	    DrawStrBox(CC.MainMenuX, CC.MainMenuY, "传功：", C_GOLD, 30)
	    local r = ShowMenu(dxp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
	    Cls()
	    local mid = WAR.Person[dxp[r][4]]["人物编号"]
	    PlayWavE(28)
	    lib.Delay(10)
	    CurIDTXDH(WAR.CurID,87,1, "酒神戏红尘")
	    local Ocur = WAR.CurID
	    WAR.CurID = dxp[r][4]
	    WarDrawMap(0)
	    PlayWavE(36)
	    lib.Delay(100)
	    CurIDTXDH(WAR.CurID, 87, 1, "集气上升500")
	    WAR.CurID = Ocur
	    WarDrawMap(0)
	    WAR.Person[dxp[r][4]].Time = WAR.Person[dxp[r][4]].Time + 500
	    if WAR.Person[dxp[r][4]].Time > 999 then
	      WAR.Person[dxp[r][4]].Time = 999
	    end
	    AddPersonAttrib(pid, "体力", -10)
	    AddPersonAttrib(pid, "内力", -1000)
	  else
	  	DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
		JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
	  	return 0
		end
	end
	
	--萧中慧，慧心
	if match_ID(pid, 77) then
		if JY.Person[pid]["生命"] > 500 and JY.Person[pid]["受伤程度"] < 50 then
			local zjwid = nil
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["人物编号"] == 0 and WAR.Person[i]["死亡"] == false then
					zjwid = i
					break
				end
			end
			if zjwid ~= nil then
				DrawStrBoxWaitKey("我心本慧・侠女柔情", C_RED, 36)
				say("２慧妹……！",0,1)
				if JY.Person[0]["性别"] == 0 then
					say("１ｎ哥哥，９请…………２加油！",77,0)
				else
					say("１ｎ姐姐，９请…………２加油！",77,0)
				end
				JY.Person[pid]["生命"] = 1
				JY.Person[pid]["受伤程度"] = 100
				WAR.Person[WAR.CurID].Time = -500
				JY.Person[0]["生命"] = JY.Person[0]["生命最大值"]
				JY.Person[0]["受伤程度"] = 0
				WAR.Person[zjwid].Time = 999
				WAR.FXDS[0] = nil
				WAR.LQZ[0] = 100
			else
				DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)		-- "未满足发动条件"
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end

		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)		-- "未满足发动条件"
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end   
	
	
	--蓝烟清：王难姑特色指令 - 施毒  周围五格范围内的敌人时序中毒并时序减血
	if match_ID(pid, 17) then
		if JY.Person[pid]["体力"] >= 30 and JY.Person[pid]["内力"] >= 300 then
			CleanWarMap(4,0);
			AddPersonAttrib(pid, "体力", -15)
			AddPersonAttrib(pid, "内力", -300)
			local x1 = WAR.Person[WAR.CurID]["坐标X"];
			local y1 = WAR.Person[WAR.CurID]["坐标Y"];
			for ex = x1 - 5, x1 + 5 do
				for ey = y1 - 5, y1 + 5 do
					SetWarMap(ex, ey, 4, 1)
					if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
						local ep = GetWarMap(ex, ey, 2)
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] then
	          
							WAR.L_WNGZL[WAR.Person[ep]["人物编号"]] = 50;			--50时序内持续减中毒+减血
							SetWarMap(ex, ey, 4, 4)
						end
					end
				end
			end
			War_ShowFight(pid,0,0,0,x1,y1,30);
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--brolycjw：胡青牛特色指令 - 群疗  周围五格范围内的队友时序回内伤并按比例回血
	if match_ID(pid, 16) then
		if JY.Person[pid]["体力"] >= 30 and JY.Person[pid]["内力"] >= 300 then
			CleanWarMap(4,0);
			AddPersonAttrib(pid, "体力", -15)
			AddPersonAttrib(pid, "内力", -300)
			local x1 = WAR.Person[WAR.CurID]["坐标X"];
			local y1 = WAR.Person[WAR.CurID]["坐标Y"];
			
			for ex = x1 - 5, x1 + 5 do
				for ey = y1 - 5, y1 + 5 do
					SetWarMap(ex, ey, 4, 1)
					if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
						local ep = GetWarMap(ex, ey, 2)
						if WAR.Person[WAR.CurID]["我方"] == WAR.Person[ep]["我方"] then
				  
							WAR.L_HQNZL[WAR.Person[ep]["人物编号"]] = 20;			--20时序内持续回血+回内伤
							SetWarMap(ex, ey, 4, 4)
					  
						end
					end
				end
			end
			War_ShowFight(pid,0,0,0,x1,y1,0);

		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--慕容复 幻梦
	if match_ID(pid, 51) then
		if JY.Person[pid]["体力"] > 20 then
			WAR.TZ_MRF = 1
			CurIDTXDH(WAR.CurID, 127,1, "顾盼子孙贤 铭记复国志", C_GOLD)
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--小昭 影步
	if match_ID(pid, 66) then
		if JY.Person[pid]["体力"] > 30 and JY.Person[pid]["内力"] > 2000 then
			War_CalMoveStep(WAR.CurID, 10, 0)
			WAR.XZ_YB[1],WAR.XZ_YB[2]=War_SelectMove()
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 20
			JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 1000
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--钟灵指令 灵貂
	if match_ID(pid, 90) then
		if JY.Person[pid]["体力"] > 10 then
			War_CalMoveStep(WAR.CurID, 8, 1)
			local x,y = War_SelectMove()
			if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
				local tdID = lib.GetWarMap(x, y, 2)
				if WAR.Person[tdID]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
					return 0
				end
				local eid = WAR.Person[tdID]["人物编号"]
				local x0, y0 = WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]
				local x1, y1 = WAR.Person[tdID]["坐标X"],WAR.Person[tdID]["坐标Y"]
				for i = 1, 4 do
					if 0 < JY.Person[eid]["携带物品数量" .. i] and -1 < JY.Person[eid]["携带物品" .. i] then
						WAR.TD = JY.Person[eid]["携带物品" .. i]
						WAR.TDnum = JY.Person[eid]["携带物品数量" .. i]
						JY.Person[eid]["携带物品数量" .. i] = 0
						JY.Person[eid]["携带物品" .. i] = -1
						break
					end
				end
				WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
				CleanWarMap(4, 0)
				SetWarMap(x1, y1, 4, 1)
				WAR.SDD2[eid] = 20
				WAR.Person[tdID]["中毒点数"] = (WAR.Person[tdID]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 50)
				WAR.TXXS[eid] = 1
				War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, 0, 0, 0, 0, 12)
				if WAR.TD ~= -1 then
					if WAR.TD == 118 then
						say("１想要从我慕容复手中偷东西？哼哼，下辈子吧！", 51,0)
					else
						instruct_2(WAR.TD, WAR.TDnum)
					end
					WAR.TD = -1
					WAR.TDnum = 0
				end
				WAR.TXXS[eid] = nil
			else
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 5
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--李逍遥 探云
	if match_ID(pid, 655) then
		if JY.Person[pid]["体力"] > 10 then
			War_CalMoveStep(WAR.CurID, 8, 1)
			local x,y = War_SelectMove()
			if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
				local tdID = lib.GetWarMap(x, y, 2)
				if WAR.Person[tdID]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
					return 0
				end
				local eid = WAR.Person[tdID]["人物编号"]
				local x0, y0 = WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]
				local x1, y1 = WAR.Person[tdID]["坐标X"],WAR.Person[tdID]["坐标Y"]
				for i = 1, 4 do
					if 0 < JY.Person[eid]["携带物品数量" .. i] and -1 < JY.Person[eid]["携带物品" .. i] then
						WAR.TD = JY.Person[eid]["携带物品" .. i]
						WAR.TDnum = JY.Person[eid]["携带物品数量" .. i]
						JY.Person[eid]["携带物品数量" .. i] = 0
						JY.Person[eid]["携带物品" .. i] = -1
						break
					end
				end
				WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
				CleanWarMap(4, 0)
				SetWarMap(x1, y1, 4, 1)
				WAR.TXXS[eid] = 1
				War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, 0, 0, 0, 0, 12)
				if WAR.TD ~= -1 then
					if WAR.TD == 118 then
						say("１想要从我慕容复手中偷东西？哼哼，下辈子吧！", 51,0)
					else
						instruct_2(WAR.TD, WAR.TDnum)
					end
					WAR.TD = -1
					WAR.TDnum = 0
				end
				WAR.TXXS[eid] = nil
			else
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 5
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--胡斐 飞狐
	if match_ID(pid, 1) then
		if JY.Person[pid]["体力"] > 20 then
			War_CalMoveStep(WAR.CurID, 10, 2)
			local x,y = War_SelectMove()
			if not x then
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			if GetWarMap(x, y, 1) > 0 or GetWarMap(x, y, 2) > 0 or GetWarMap(x, y, 5) > 0 or CC.WarWater[GetWarMap(x, y, 0)] ~= nil then
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			else
				CurIDTXDH(WAR.CurID, 25,1, "雪山飞狐", Violet);
				WAR.Person[WAR.CurID]["移动步数"] = 10
				War_MovePerson(x, y, 1)
				WAR.Person[WAR.CurID]["移动步数"] = 0
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			end
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--鸠摩智 幻化
	if match_ID(pid, 103) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			local thing = {}
			local thingnum = {}
			for i = 0, CC.MyThingNum - 1 do
				thing[i] = -1
				thingnum[i] = 0
			end
			local num = 0
			for i = 0, CC.MyThingNum - 1 do
				local id = JY.Base["物品" .. i + 1]
				if id >= 0 then
					if JY.Thing[id]["类型"] == 2 and JY.Thing[id]["练出武功"] > -1 then
						thing[num] = id
						thingnum[num] = JY.Base["物品数量" .. i + 1]
						num = num + 1
					end
				end 
			end
			IsViewingKungfuScrolls = 1
			local r = SelectThing(thing, thingnum)
			if r >= 0 then
				CurIDTXDH(WAR.CurID, 93,1, "无相幻化", C_GOLD)
				JY.Person[pid]["武功2"]= JY.Thing[r]["练出武功"]
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
				JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
			else
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--达尔巴指令 死战
	if match_ID(pid, 160) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			War_CalMoveStep(WAR.CurID, 8, 1)
			local x,y = War_SelectMove()
			if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
				local tdID = lib.GetWarMap(x, y, 2)
				if WAR.Person[tdID]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
					return 0
				end
				local eid = WAR.Person[tdID]["人物编号"]
				WAR.SZSD = eid
				
				CurIDTXDH(WAR.CurID, 93,1, "锁定目标", C_GOLD)
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
				JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
			else
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--金轮 龙象
	if match_ID(pid, 62) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			War_ActupMenu()
			WAR.SLSX[pid] = 2
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--黄蓉 遁甲
	if match_ID(pid, 56) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			local x,y = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
			--1绿色，2红色，3蓝色，4紫色
			CleanWarMap(6,-1);
					
			local QMDJ = {"休","生","伤","杜","景","死","惊","开"}
						
			--在自身周围绘制奇阵
			SetWarMap(x,y, 6, math.random(4))
			
			for j=1, 2 do
				SetWarMap(x + math.random(6), y + math.random(6), 6, math.random(4));
				for i = 30, 40 do
					NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
					ShowScreen()
					if i == 40 then
						lib.Delay(300)
						Cls()
					else
						lib.Delay(1)
					end
				end
			end
						
			for j=3, 4 do
				SetWarMap(x + math.random(6), y - math.random(6), 6, math.random(4));
				for i = 30, 40 do
					NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
					ShowScreen()
					if i == 40 then
						lib.Delay(300)
						Cls()
					else
						lib.Delay(1)
					end
				end
			end
						
			for j=5, 6 do
				SetWarMap(x - math.random(6), y - math.random(6), 6, math.random(4));
				for i = 30, 40 do
					NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
					ShowScreen()
					if i == 40 then
						lib.Delay(300)
						Cls()
					else
						lib.Delay(1)
					end
				end
			end
						
			for j=7, 8 do
				SetWarMap(x - math.random(6), y + math.random(6), 6, math.random(4));
				for i = 30, 40 do
					NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
					ShowScreen()
					if i == 40 then
						lib.Delay(300)
						Cls()
					else
						lib.Delay(1)
					end
				end
			end
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--阿紫，禁药
	if match_ID(pid, 47) then
		WAR.JYZT[pid] = 1
		CurIDTXDH(WAR.CurID, 128,1, "禁药", C_RED);
		JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
		return 20
	end
	   
	
	--空性, 检测
	if match_ID(pid, 170) then
		JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 5
		
		local num = 0
		local e_list = {}
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				table.insert(e_list, i)
				num = num + 1
			end
		end
		local name = {}
		for i = 1, num do
			name[i] = {}
			name[i][1] = JY.Person[WAR.Person[e_list[i]]['人物编号']]['姓名']
			name[i][2] = nil
			name[i][3] = 1
		end
		DrawStrBox(CC.MainMenuX, CC.MainMenuY, "要检测谁的战斗力？", C_GOLD, CC.DefaultFont)
		local c = ShowMenu(name, num, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
		local o_id = WAR.CurID
		
		WAR.CurID = e_list[c]
		
		local eid = WAR.Person[WAR.CurID]['人物编号']
		
		local CombatExponent = 0
		
		local high_WL = 0
		
		for i = 1, JY.Person[671]["品德"] do
			if JY.Person[eid]["武功" .. i] > 0 then
				local wugong = JY.Person[eid]["武功" .. i]
				local level = JY.Person[eid]["武功等级" .. i]
				if level == 999 then
					level = 11
				else
					level = math.modf(level / 100) + 1
				end
				local true_WL = get_skill_power(eid, wugong, level)
				if true_WL > high_WL then
					high_WL = true_WL
				end
			else
				break
			end
		end
		
		CombatExponent = JY.Person[eid]["攻击力"]*2.6 + JY.Person[eid]["防御力"]*4 + JY.Person[eid]["轻功"]*3.4 + getnl(eid)*0.02 + high_WL
		
		CombatExponent = math.modf(CombatExponent)
		
		Cls()
		
		local x0 = WAR.Person[WAR.CurID]["坐标X"]
		local y0 = WAR.Person[WAR.CurID]["坐标Y"]
		local hb = GetS(JY.SubScene, x0, y0, 4)
		
		local pw, ph = lib.GetPNGXY(96, 1*2)
		
		local posx = CC.ScreenW / 2 - pw/2
		local posy = CC.ScreenH / 2 - hb - ph/2 - CC.YScale*4
		
		local str = {
			'检',
			'检测',
			'检测中',
			'检测中…',
			'检测中……',
		}
		local str_count = 1
		local frame_count = 0
		local JC_times_played = 0
		
		while true do
			if JY.Restart == 1 then
				break
			end
			local keypress, ktype = lib.GetKey()
			Cls()
			
			frame_count = frame_count + 1
			if frame_count > 100 then
				frame_count = 1
			end

			lib.LoadPNG(96, 1*2, -55, -82, 1)
			
			if JC_times_played < 3 then
				DrawString(390, 420, str[str_count], C_RED, CC.DefaultFont)
				if frame_count % 3 == 0 then
					str_count = str_count + 1
					if str_count > #str then
						str_count = 1
						JC_times_played = JC_times_played + 1
					end
				end
			else
				DrawString(407, 420, '检测完毕', C_RED, CC.DefaultFont)
				
				lib.LoadPNG(96, 2*2, 530, 70, 1)
				
				DrawString(580, 121, JY.Person[eid]['姓名'], M_DeepSkyBlue, CC.DefaultFont)
				
				DrawString(580, 171, '战斗力:', M_DeepSkyBlue, CC.DefaultFont)
				
				DrawString(580, 221, CombatExponent, M_DeepSkyBlue, CC.DefaultFont)
				
				if keypress == VK_RETURN or ktype == 3 then
					break
				end
			end
			
			ShowScreen()		
			lib.Delay(CC.Frame)
		end

		WAR.CurID = o_id
		if JY.Person[eid]['性别'] == 0 then
			say('Ｄ＜这小子的战斗力有'..CombatExponent..'，我该怎么办呢？＞', 0, 1)
		else
			say('Ｄ＜这丫头的战斗力有'..CombatExponent..'，我该怎么办呢？＞', 0, 1)
		end
		
		local r = JYMsgBox("请选择你的策略", '*'..JY.Person[eid]['姓名']..'的战斗力为：'..CombatExponent, {"抢攻","游斗","下毒","闷棍","色诱"}, 5, WAR.tmp[5000+WAR.CurID])
		if r == 1 then
				say('Ｄ＜不要怂，就是干！＞', 0, 1)
			WAR.KX_DD = {}
			WAR.KX_DD[pid] = eid
			if WAR.KX_RS and WAR.KX_RS[pid] then
				WAR.KX_RS[pid] = nil
			end
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 20
		elseif r == 2 then
			say('Ｄ＜不要干，就是怂！＞', 0, 1)
			WAR.KX_RS = {}
			WAR.KX_RS[pid] = eid
			if WAR.KX_DD and WAR.KX_DD[pid] then
				WAR.KX_DD[pid] = nil
			end
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 20
		elseif r == 3 then
			if JY.Person[0]["品德"]>60 then
			say('Ｄ＜来试试天下第一奇毒，无色无味的奇淫合欢散＞', 0, 1)
			JY.Person[eid]['中毒程度'] = 100
			WAR.PJZT[eid] = 100
			if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
			end
			JY.Person[eid]["主运内功"] = 0
			JY.Person[0]["品德"]  = JY.Person[0]["品德"] - 1
			else
			say('Ｄ＜人品值不够用了＞', 0, 1)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 20	
			end		
		elseif r == 4 then
			if JY.Person[0]["品德"]>80 then
			say('Ｄ＜好折凳！折凳的奥妙之处＞', 0, 1)
			say('Ｄ＜它可以藏在民居之中，随手可得＞', 0, 1)
			say('Ｄ＜还可以坐着它来隐藏杀机，就算被警察抓了也告不了你＞', 0, 1)
			say('Ｄ＜真不愧为七种武器之首！哈哈＞', 0, 1)
			JY.Person[eid]['受伤程度'] = 100
			WAR.HMZT[eid] = 1
			JY.Person[0]["品德"]  = JY.Person[0]["品德"] - 5
			else
			say('Ｄ＜人品值不够用了＞', 0, 1)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 20	
			end
		elseif r == 5 then
			say('Ｄ＜黑喂狗！跟我一起搞比利＞', 0, 1)
			PlayMIDI(120)
			if JY.Person[eid]['性别'] == 0 and JY.Person[0]["品德"]>100 then
			WAR.CurID = e_list[c]
			WAR.Person[WAR.CurID]["我方"]= true
			say('Ｄ＜色诱成功＞', 0, 1)
			JY.Person[0]["品德"]  = JY.Person[0]["品德"] - 10
			WAR.TCQ=1
			else
			say('Ｄ＜色诱失败＞', 0, 1)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 20
			end
		end
	end
	
	--韦小宝 口才
	if match_ID(pid, 601) then
		if JY.Person[pid]["体力"] > 60 then
			War_CalMoveStep(WAR.CurID, 8, 1)
			local x,y = War_SelectMove()
			if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
				local tdID = lib.GetWarMap(x, y, 2)
				if WAR.Person[tdID]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
					return 0
				end
				local eid = WAR.Person[tdID]["人物编号"]
				WAR.CSZT[eid] = 1
				
				Cls()
				local KC = {"阁下英明神武","鸟生鱼汤"}
				
				for i = 1, #KC do
					lib.GetKey()
					DrawString(-1, -1, KC[i], C_GOLD, CC.Fontsmall)
					ShowScreen()
					Cls()
					lib.Delay(1000)
				end
				local s = WAR.CurID
				WAR.CurID = tdID
				WarDrawMap(0)
				CurIDTXDH(WAR.CurID, 145,1)
				WAR.CurID = s
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 50
			else
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--苗人凤指令 破军
	if match_ID(pid, 3) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			WAR.MRF = 1
			if War_FightMenu() == 0 then
				WAR.MRF = 0
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 300
			WAR.MRF = 0
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--温青青指令 大暴
	if match_ID(pid, 91) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			WAR.WQQ = 1
			if War_FightMenu() == 0 then
				WAR.WQQ = 0
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 5
			JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 200
			WAR.WQQ = 0
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--灭绝，俱焚
	if match_ID(pid, 6) then
		WAR.YSJF[pid] = 100
		CurIDTXDH(WAR.CurID, 124,1, "玉石俱焚", M_Silver);
		JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
		return 20
	end
	
	--谢逊指令 咆哮
	if match_ID(pid, 13) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 3000 then
			CurIDTXDH(WAR.CurID, 118,1, "狮王咆哮", C_GOLD)
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
					WAR.HLZT[WAR.Person[j]["人物编号"]] = 20
				end
			end
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 2000
			WAR.MRF = 0
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--何太冲指令 琴音
	if match_ID(pid, 7) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			CleanWarMap(4, 0)
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					local eid = WAR.Person[j]["人物编号"]
					local qycs = WAR.QYZT[eid] or 0
					if qycs > 0 then
						WAR.TXXS[eid] = 1
						--无酒不欢：记录人物血量
						WAR.Person[j]["Life_Before_Hit"] = JY.Person[eid]["生命"]
						JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - 50*qycs
						WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 50*qycs
						SetWarMap(WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"], 4, 1)
						WAR.QYZT[eid] = nil
					end
				end
			end
			War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, 0, 0, 0, 0, 144)
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--阎基指令 虚弱
	if match_ID(pid, 4) then
		if JY.Person[pid]["体力"] > 20 then
			War_CalMoveStep(WAR.CurID, 8, 1)
			local x,y = War_SelectMove()
			if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
				local tdID = lib.GetWarMap(x, y, 2)
				if WAR.Person[tdID]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
					return 0
				end
				local eid = WAR.Person[tdID]["人物编号"]
				local x0, y0 = WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]
				local x1, y1 = WAR.Person[tdID]["坐标X"],WAR.Person[tdID]["坐标Y"]
				
				WAR.XRZT[eid] = 40
				WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
				CleanWarMap(4, 0)
				SetWarMap(x1, y1, 4, 1)
				War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, 0, 0, 0, 0, 148)
			else
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
				return 0
			end
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	
	--黛绮丝，倾国
	if match_ID(pid, 15) then
		WAR.QGZT[pid] = 6
		CurIDTXDH(WAR.CurID, 149,1)
		JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 2000
		JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
		JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
	end
	
	--方证 金身
	if match_ID(pid, 149) then
		if WAR.JSBM[pid] ~= nil then
			WAR.JSBM[pid] = nil
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 20
		end
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			WAR.JSBM[pid] = 1
			CurIDTXDH(WAR.CurID, 78,1,"金身不灭",C_GOLD)
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 20
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
			return 0
		end
	end
	JY.Person[685]["天1"] = a
	JY.Person[685]["天2"] = b
	JY.Person[685]["天3"] = c
	

	return 1
	
end
	
--战斗蓄力
function War_ActupMenu()
	local p = WAR.CurID
	local id = WAR.Person[p]["人物编号"]
	local x0, y0 = WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"]
	
	--赵敏是否在场
	local ZM = 0
	if inteam(id) then
		for i = 0, WAR.PersonNum - 1 do
			local zid = WAR.Person[i]["人物编号"]
			if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] and match_ID(zid, 609) then
				ZM = 1
				break
			end
		end
	end
	
	--蛤蟆蓄力带防御效果
	if PersonKF(id, 95) then
		WAR.Actup[id] = 2;
		WAR.Defup[id] = 1
		WAR.HMGXL[id] = 1
		CurIDTXDH(WAR.CurID, 85,1);
		DrawStrBox(-1, -1, "攻守兼备・蓄势待发", LightSlateBlue, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)
		return 1;
	--被动紫霞蓄力强化
	elseif PersonKF(id, 89) then
		WAR.Actup[id] = 2
		if inteam(id) then
			WAR.ZXXS[id] = 1 + math.modf(JY.Base["天书数量"]/7)
		else
			WAR.ZXXS[id] = 3
		end
		CurIDTXDH(WAR.CurID, 85, 1);
		DrawStrBox(-1, -1, "紫霞蓄势・连绵不绝", Violet, CC.DefaultFont, M_DeepSkyBlue)
		ShowScreen()
		lib.Delay(400)
		return 1
	--被动龙象蓄力必定成功
	elseif PersonKF(id, 103) then
		WAR.Actup[id] = 2
		CurIDTXDH(WAR.CurID, 85, 1);
		DrawStrBox(-1, -1, "蓄力成功", C_GOLD, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)
		return 1;
	--标主蓄力必成功
	elseif id == 0 and JY.Base["标准"] > 0 then
		WAR.Actup[id] = 2
	--NPC蓄力必成功
	elseif not inteam(id) or (inteam(id) and JY.Person[642]["血量翻倍"] == 1)then
		WAR.Actup[id] = 2
	--我方，赵敏在场必成功
	elseif inteam(id) and ZM == 1 then
		WAR.Actup[id] = 2
	--常态70%几率成功
	elseif JLSD(15, 85, id) then
		WAR.Actup[id] = 2
	end
	if WAR.Actup[id] ~= 2 then
		Cls()
		DrawStrBox(-1, -1, "蓄力失败", C_GOLD, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)
	else
		CurIDTXDH(WAR.CurID, 85, 1);
		DrawStrBox(-1, -1, "蓄力成功", C_GOLD, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)
	end
	return 1
end


--战斗防御
function War_DefupMenu()
	local p = WAR.CurID
	local id = WAR.Person[p]["人物编号"]
	local x0, y0 = WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"]
	WAR.Defup[id] = 1
	Cls()
	local hb = GetS(JY.SubScene, x0, y0, 4)
	  
	--太玄防御带蓄力
	if PersonKF(id, 102) then
		WAR.Actup[id] = 2;
		CurIDTXDH(WAR.CurID, 86,1);
		DrawStrBox(-1, -1, "防御开始・太玄蓄力", C_RED, CC.DefaultFont, C_GOLD)
		ShowScreen()
		lib.Delay(400)
		return 1;
	end
	  
	CurIDTXDH(WAR.CurID, 86,1);
	DrawStrBox(-1, -1, "防御开始", LimeGreen, CC.DefaultFont, C_GOLD)
	ShowScreen()
	lib.Delay(400)
	return 1
end

--设置人物的集气值，返回一个综合值以便循环刷新集气条
function GetJiqi()
	local num, total = 0, 0
	--无酒不欢：轻功对于人物集气的影响函数
	local function getnewmove(x)
		if x > 200 then
			return 15 + (x - 200) / 30
		elseif x > 100 then
			return 10 + (x - 100) / 20
		else
			return x / 20
		end
	end
	--无酒不欢：内力对于人物集气的影响函数
	local function getnewmove1(a, b)
		local x = (a * 2 + b) / 3
		if x > 5600 then
			return 8 + math.min((x - 5600) / 1200, 3)
		elseif x > 3600 then
			return 6 + (x - 3600) / 1000
		elseif x > 2000 then
			return 4 + (x - 2000) / 800
		elseif x > 800 then
			return 2 + (x - 800) / 600
		else
			return x / 400
		end
	end
	--无酒不欢：敌人集气随难度变化
	local function NPCjiqimod(nd)
		local x;
		if nd == 1 then
			return 0.8
		elseif nd == 2 then
			return 1
		elseif nd == 3 then
			return 1.2
		elseif nd == 4 then
			return 1.4
		elseif nd == 5 then
			return 1.6
		elseif nd == 6 then
			return 1.8
		elseif nd >= 7 then
			return 2.1
		end
	end
	local dgqb = {}			--记录独孤求败的数据
	local max_jq = 0		--记录全场最高集气
	for i = 0, WAR.PersonNum - 1 do
		if not WAR.Person[i]["死亡"] then
			local id = WAR.Person[i]["人物编号"]
			local yin, yang, tg = NeiL(id)
			local fx = yin + yang
			WAR.Person[i].TimeAdd = (getnewmove(WAR.Person[i]["轻功"]) + getnewmove1(JY.Person[id]["内力"], JY.Person[id]["内力最大值"]) + JY.Person[id]["体力"] / 30)
			
			--敌人根据难度集气速度额外增加
			if not inteam(id) then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * NPCjiqimod(JY.Base["难度"]))
				--随武功数量变化
		        if JY.Base["难度"] > 3 then
		        local add1 = 1+0.02*(JY.Base["难度"] - 3)*(JY.Base["天书数量"]/14)
				local add2 = JY.Person[671]["品德"]-11
				local add3 = JY.Base["天书数量"]-6
		              WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * add1 + add2) + add3
		        end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf((WAR.Person[i].TimeAdd * JY.Person[123]["天1"]*0.07)*(JY.Base["天书数量"]/14))
			else	
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd)
			end
			
			--1点基础集气
			WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 1
			
			--废资
			if JY.Person[0]["资质"] > 50 and JY.Person[0]["资质"] < 80 and id == 0 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 6 + JY.Person[0]["六如觉醒"]*2
			end
			if JY.Person[id]["内力性质"] == 0 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
			end
			if JY.Person[692]["声望"] == 1 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 15
			end
			--tiaohe
			if fx == 0 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + yang
			end
			--健步如飞
			if match_ID(id, 676) and JY.Person[676]["天3"] == 1 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10 + JY.Base["天书数量"]
			end
			if match_ID(id, 689) then
	           WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*(1.1^JY.Person[689]["天2"]))
	        end
			if match_ID(id, 690) and WAR.Person[i].TimeAdd < 20 then
	           WAR.Person[i].TimeAdd = 20
	        end
			if match_ID(id, 690) and JY.Person[0]["专1"] == 233 then
	           WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 15
	        end
			if match_ID(id, 684) and JY.Person[684]["天2"] == 2 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			
			if match_ID(id, 14) and JY.Person[14]["阶"] >= 1 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 30
			end
			if match_ID(id, 29) and JY.Person[29]["阶"] >= 2 and WAR.KFDF[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.KFDF[id]*10
			end
			if match_ID(id, 20) and JY.Person[20]["阶"] >= 2 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 30
			end
			if JY.Base["标准"] == 5 and id == 0 and JY.Person[0]["阶"] >= 1 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			if match_ID(id, 688) and JY.Person[688]["阶"] >= 2 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
			end
			
			--辟邪
			if PersonKF(id, 48) and (JY.Person[id]["专2"] == 48 or (match_ID(id, 36) and JY.Person[36]["阶"] >= 1)) then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			
			if JY.Person[id]["地8"] == 1 and JY.Person[0]["品德"] <= 30 then
	           WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 15
	        end
			
			if JY.Person[id]["地8"] == 4 and JY.Person[0]["品德"] >= 90 then
	           WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 25
	        end
			
			if JY.Person[id]["地4"] == 2 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 15
			end
			if JY.Person[id]["地5"] == 6 then
			local add = math.modf((JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])*30/JY.Person[id]["生命最大值"])
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + add
			end
			if WAR.BLZ[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 0.8)
			end  
			if match_ID(id, 634) and JY.Person[634]["天1"] == 2 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 12
			end
			--豪鬼
			if match_ID(id, 673) then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10 + math.modf(JY.Person[id]["拳掌功夫"]*0.01)
			end
			--杀意状态
			if WAR.SYBD[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.25)
			   if JY.Person[673]["外号2"] == "怒" then
			      WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.25)
			   end
			end
			
			if match_ID(id, 11) and JY.Person[11]["阶"] >= 3 then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*1.25)
			end
			
			--刚柔并济
			if GangRBJ(id) > 0 then
			local x = GangRBJ(id)*0.01+1
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * x)
			end
			
			--单枪匹马组合，集气速度+10%
			if (JY.Person[id]["武器"] == 54 or JY.Person[id]["武器"] == 344) and (JY.Person[id]["动物"] == 230 or JY.Person[id]["动物"] == 349) and WAR.MCRS == 1 then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.1)
				if match_ID(id, 688) then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.1)
				end
			end
			
			--夜照
			if JY.Person[id]["动物"] == 349 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + JY.Thing[349]["装备等级"] + 1
			end
			--回春大力
			if WAR.HCDLW[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 30
			end
			if WAR.YLMB[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + (JY.Person[689]["天2"]-3)*6
			end
			if WAR.LDXJ[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5 + JY.Person[689]["天2"]*3
			end
			--聂风，集气
			if match_ID(id, 681) then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10 + JY.Person[681]["品德"]*3
			   if JY.Person[681]["品德"] >= 4 then
			    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3
			   end
			   if JY.Person[681]["天1"] == 1 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			   end
			end
			
			--丁典，神照
			if (JY.Person[672]["品德"] == 100 or JY.Person[672]["品德"] == 70) and match_ID(id, 672) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			
			--天怒十方加集气
			if JY.Person[id]["防具"] == 324 or JY.Person[id]["防具"] == 327 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
				if JY.Person[id]["防具"] == 327 then
				   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.2) + JY.Base["天书数量"]
				end
			end
			
			--无名，集气上升
			if match_ID(id, 671) then
			local q = math.modf(TrueYJ(id)/100)
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + q
			   if WAR.LQZ[id] == 100 then
			      WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + q*JY.Person[id]["六如觉醒"]
			   end
			   if JY.Person[id]["生命"] <= JY.Person[id]["生命最大值"]*0.3 then
			      WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + q*3
			   end
			end

			--运行轻功，集气速度+10%
			if JY.Person[id]["主运轻功"] > 0 then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.1)
			end
			
			--主运葵花，集气速度+25%
			if Curr_NG(id,105) then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.25)
			end
			if PersonKF(id,105) and JY.Person[id]["专2"] == 105 then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.2)
			end
			if match_ID(id, 693) then
			   local add = math.modf(JY.Person[id]["拳掌功夫"]/30)
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.SXTJ + add
			   
			end
			if WAR.TQLQ[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.25)
			end
			
			if match_ID(id, 58) and JY.Person[58]["阶"] >= 3 then
			local s = 1+((JY.Person[id]["生命最大值"]-JY.Person[id]["生命"])/JY.Person[id]["生命最大值"])*2
			    WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * s)
			end
			
			if match_ID(id, 90) and JY.Person[90]["阶"] >= 3 then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.2)
			end
			
			--[[主运无名轻功，集气+5%
			if Curr_QG(id,191) then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.05)
			end]]
			
			--马王神装备黑马
			if match_ID(id, 132) then
			if JY.Person[id]["动物"] == 264 then
			WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*1.25);
			end		
			end
			
			--葵花神功被动，集气+2
			if PersonKF(id,105) then
			local add = 0
			if tg ~= 1 then
	           if fx < 0 then
			      add = add - fx
			   end
	        else
			   add = add - yin
			end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + add
			end
			
			--主运飞天，集气+5
			if Curr_QG(id,145) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
			end
			--神行百变
			if PersonKF(id, 146) and JY.Person[id]["专1"] == 146 then
			    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			--踏雪无痕
			if PersonKF(id, 178) and JY.Person[id]["专1"] == 178 then
			    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 2
			end
			if PersonKF(id, 180) and JY.Person[id]["专1"] == 180 then
			    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3
			end
			--凤舞九天
			if Curr_QG(id, 216) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf(JY.Person[id]["体力"]*0.2)
			elseif PersonKF(id, 216) then
			    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf(JY.Person[id]["体力"]*0.1)
			end
			
			--玉女心经被动，集气+1
			if PersonKF(id,154) and JY.Person[id]["天赋内功"] == 154 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 2
			end
			
			--圣火集气+2
			if PersonKF(id,93) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 2
				if JY.Person[id]["武器"] == 337 then
	               WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3
	            end
				if JY.Person[id]["天赋内功"] == 93 then
				   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 8
				end   
			end
			
			--主运登萍，每行动一次集气+1
			if Curr_QG(id, 179) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + (WAR.DPJQ[id] or 0)
			end
			
			--运行天赋轻功
			if JY.Person[id]["主运轻功"] > 0 and JY.Person[id]["主运轻功"] == JY.Person[id]["天赋轻功"] then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 1
			end
			
			--胡斐集气+8
			if match_ID(id, 1) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 8
			end
			
			--东方不败，集气+6
			if match_ID(id, 27) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 6
			end
			
			--韦一笑，成昆，柯镇恶集气+10
			if match_ID_awakened(id, 130, 1) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			
			if match_ID(id, 14) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10 + math.modf(JY.Person[id]["实战"]*0.04)
			end
			
			--一灯，重生后额外集气速度+5
			if match_ID(id, 65) and WAR.WCY[id] ~= nil then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
			end

			--王重阳，重生后额外集气速度+5
			if match_ID(id, 129) and WAR.CYZX[id] ~= nil then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
			end
			
			--田伯光 万里独行 人越少集气越快
			if match_ID(id, 29) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 4
					end
				end
			end
			
			--无酒不欢 后继无人
			if JY.Base["特殊"] ==1 and JY.Person[30]["血量翻倍"]==1 and id==0 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 2
					end
				end
			end
		  
			--公孙止，我方每死亡一个人，集气速度+2
			if match_ID(id, 616) then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == true and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3
					end
				end
			end
			
			
			--四大山，我方每死亡一个人，集气速度+20			
			if match_ID(id, 642) and JY.Base["天书数量"] > 7 then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == true and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
					   if WAR.ZDDH == 290 or WAR.ZDDH == 321 or WAR.ZDDH == 315 then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
					   else
					    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
					   end
					end
				end
			end

			--四大山，我方每存活一个人，集气速度+10					
			if match_ID(id, 642) and JY.Base["天书数量"] > 5 then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
					   if WAR.ZDDH == 290 or WAR.ZDDH == 321 or WAR.ZDDH == 315 then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
					   else
					    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
					   end
					end
				end
			end
		  
			--圣火三使，同时在场时，每人集气速度额外+20点
			if WAR.ZDDH == 14 and (id == 173 or id == 174 or id == 175) then
				local shz = 0
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						shz = shz + 1
					end
				end
				
				if shz == 3 then
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
				end
			end
		  
			--蓝烟清：天罡北斗阵，集气+6
			if WAR.ZDDH == 73 and WAR.Person[i]["我方"] == false then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 6
			end
			  
			--萧中慧给主角+2集气
			if id == 0 then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["人物编号"] == 77 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 2
						break
					end
				end
			end
		  
			--主角其徐如林
			if id == 0 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.FLHS2
			end
			
			--太极神功，太极之形增加集气
			if PersonKF(id, 171) and WAR.TJZX[id] ~= nil then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.TJZX[id]
			end
			  
			if match_ID(id, 675) then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * (1+(JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])*0.5/JY.Person[id]["生命最大值"]))
			end
			
			--平一指，集气速度额外加成5*杀人数
			if match_ID(id, 28) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.PYZ * 5
			end
	  
			--装备白马 1级加2集气，6级加4集气
			if JY.Person[id]["动物"] == 230 then
				local sd = 2
				if JY.Thing[230]["装备等级"] >= 5 then
					sd = 4
				elseif JY.Thing[230]["装备等级"] >= 3 then
					sd = 3
				end
				--李文秀的效果翻倍
				if match_ID(id, 590) then
					sd = sd * 2
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + sd
			end
			
			--装备毛驴 集气速度+10点
			if JY.Person[id]["动物"] == 279 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10;
			end
			
			--瘦黄马，血量越低集气越快，50%血+5，0血+10
			if JY.Person[id]["动物"] == 284 and JY.Thing[284]["装备等级"] == 6 and JY.Person[id]["生命"] < JY.Person[id]["生命最大值"]/2 then
				local spd_add = 5;
				spd_add = spd_add + math.floor((JY.Person[id]["生命最大值"]/2 - JY.Person[id]["生命"])/100)
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + spd_add;
			end
					
			
			--阿紫曼珠沙华，血量越低集气越快，100%血无加成，0血100%加成
			if match_ID(id, 47) and WAR.JYZT[id]~=nil then
				local bonus_perctge = 0
				bonus_perctge = 2 - JY.Person[id]["生命"] / JY.Person[id]["生命最大值"]
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * bonus_perctge)
			end
			
			--周芷若，每个外功+1集气
			if match_ID(id, 631) then
				local zzr = 0
				for i = 1, JY.Person[671]["品德"] do
					if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] < 6 then
						zzr = zzr + 1
					end
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + zzr
			end
		  
			--日本忍者战
			if WAR.ZDDH == 128 and inteam(id) == false and id ~= 553 and JY.Base["难度"] > 1 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			
			--七伤拳，肺
			if WAR.QSQ[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf((WAR.Person[i].TimeAdd)*0.7) 
			end
			
			--无影神拳
			if WAR.WYSQ[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf((WAR.Person[i].TimeAdd)*0.33) 
			end
			
			if WAR.GMPG[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf((WAR.Person[i].TimeAdd)*0.85) 
			end
			
			--狂犬病
			if WAR.KQB[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - WAR.KQB[id]
			end
	
			--碧落九重剑：重
			if WAR.LZ_Z[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf((WAR.Person[i].TimeAdd - 5)*0.6)
			end
			--聂风
			if WAR.ZWZX[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf((WAR.Person[i].TimeAdd - 1)*0.7)
			end
			--寒冰绵掌
			if WAR.HBMZJS[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf((WAR.Person[i].TimeAdd - 1)*0.7)
			end
			--打狗棒法
			if WAR.DGGFJS[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf((WAR.Person[i].TimeAdd - 1)*0.6)
			end
		  
			--集气下限10点
			if WAR.Person[i].TimeAdd < 10 then
				WAR.Person[i].TimeAdd = 10
			end
		  
			--李秋水的无相分身不集气
			if id == 600 then
				WAR.Person[i].TimeAdd = 0
			end
			
			if WAR.QJJB[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd * 2
			end
			
			--魔心渡
			if WAR.MXD[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd * 3
			end
			
			--中华傲诀
			if Curr_NG(id, 213) then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd * 2
			end
			
			if JY.Person[id]["地5"] == 7 then
			
			   if WAR.JQSDXS[id] ~= nil then
			   local add = WAR.SXTJ
			   if add > 300 then
			   add = 300
			   end
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + add
			   end
			end
			
			if WAR.BDZX[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf((WAR.Person[i].TimeAdd)*0.8) 
			end
			
			--任我行
			if WAR.XQJQ[id] ~= nil then
			local k = 0
			   for j = 0, WAR.PersonNum - 1 do			
					if WAR.XQJQ[id][WAR.Person[j]["人物编号"]] ~= nil then
						k = k + WAR.XQJQ[id][WAR.Person[j]["人物编号"]]
					end
			   end
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + k*3
			end
			
			if JY.Person[id]["中毒程度"] > 0 and (JY.Base["标准"] == 9 and id == 0) == false and (match_ID(id, 646) and JY.Person[646]["阶"] >= 1) == false then
			local a = 1 - JY.Person[id]["中毒程度"]*0.001
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*a)
			end
			
			if match_ID(id, 646) and JY.Person[646]["阶"] >= 1 then
			local a = 1 + JY.Person[id]["中毒程度"]*0.003
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*a + JY.Person[id]["中毒程度"]*0.2)
			end
			
			if WAR.Person[i].TimeAdd > 25 then
			   WAR.Person[i].TimeAdd = 25 + math.modf((WAR.Person[i].TimeAdd - 25)^0.97)
			   if WAR.Person[i].TimeAdd > 50 then
			      WAR.Person[i].TimeAdd = 50 + math.modf((WAR.Person[i].TimeAdd - 50)^0.87)
				  if WAR.Person[i].TimeAdd > 70 then
			         WAR.Person[i].TimeAdd = 70 + math.modf((WAR.Person[i].TimeAdd - 70)^0.91)
			      end
			   end
			end
			
			if WAR.HBZQJS[id] ~= nil then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*0.9^WAR.HBZQDJ[id])
			end
		  
			--[[集气上限100点
			if WAR.Person[i].TimeAdd > 100 then
				WAR.Person[i].TimeAdd = 100
			end]]

			
			--杀意状态
			if WAR.SYBD[id] ~= nil then
			   if JY.Person[673]["外号2"] == "怒" then
			      WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.25)
			   end
			end
			
			if match_ID(id, 36) and JY.Person[36]["阶"] >= 2 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 30
			end
			
			--云雾
			if WAR.YWSS[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 13
			end
			
			if WAR.NQK[id] ~= nil then
		       WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * (1.35^WAR.NQK[id]))	
	        end
			if WAR.SHK[id] ~= nil then
		       WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.5)	
	        end
			
			if WAR.YYXS[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd * 2
			end
			
			--集气
			if JY.Person[673]["外号2"] == "怒" then
		      for j = 0, WAR.PersonNum - 1 do
			    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.SYBD[WAR.Person[j]["人物编号"]] ~= nil then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 0.5)
			    end
		      end
			end
			
		    for j = 0, WAR.PersonNum - 1 do
			   if WAR.Person[j]["死亡"] == false and match_ID(WAR.Person[j]["人物编号"], 688) and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] then
				  WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 0.1*(9-(JY.Person[WAR.Person[j]["人物编号"]]["实战"]*0.002)))
			   end
		    end
			if match_ID(id, 688) then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10 + math.modf(JY.Person[id]["实战"]*0.02)
			end
			
		
			
			--剑神，每个剑法到极，+2集气
			if JY.Base["标准"] == 3 and id == 0 then
				local jsyx = 0
				for i = 1, JY.Person[671]["品德"] do
					if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 3 and JY.Person[0]["武功等级" .. i] == 999 then
						jsyx = jsyx + 1
					end
				end
				if jsyx > 7 then
					jsyx = 7
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + jsyx*2
			end			
			--无酒不欢 剑神一笑
			if JY.Base["特殊"] ==1 and JY.Person[18]["血量翻倍"]==1 and id==0 then
				local jsyx = 5
				for i = 1, JY.Person[671]["品德"] do
					if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 3 and JY.Person[0]["武功等级" .. i] == 999 then
						jsyx = jsyx + 1
					end
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + jsyx
			end
		  
			--李文秀，每个奇门到极，+2集气
			if match_ID(id, 590) then
				local lwx = 0
				for i = 1, JY.Person[671]["品德"] do
					if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 5 and JY.Person[id]["武功等级" .. i] == 999 then
						lwx = lwx + 1
					end
				end
				if lwx > 7 then
					lwx = 7
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + lwx*2
			end
			
			if id == 0 and JY.Person[0]["天4"] == 3 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			
			if JY.Person[id]["人26"] == 1 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			if JY.Person[id]["人32"] == 1 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
			end
			
			
			--任我行
			if JY.Person[26]["阶"] >= 3 then
			local k = 0
			for j = 0, WAR.PersonNum - 1 do						   
			       if WAR.XQJQ[WAR.Person[j]["人物编号"]][id] ~= nil then
				      k = k + WAR.XQJQ[WAR.Person[j]["人物编号"]][id]
			       end
			end
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - k*3
			   if WAR.Person[i].TimeAdd < 10 then
			      WAR.Person[i].TimeAdd = 10
			   end
			end
			
			--集气速度二次限制
			if WAR.Person[i].TimeAdd > 300 then
			   WAR.Person[i].TimeAdd = 300 + math.modf((WAR.Person[i].TimeAdd-300)^0.7)
			end
			
			if JY.Person[id]["人27"] == 1 and WAR.SPbuff[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.SPbuff[id]
			end
			
			if JY.Person[id]["人18"] == 1 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
			end
			
			if JY.Person[123]["天2"] == 2 then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*0.8)
	        end
			
			if match_ID(id, 36) and JY.Person[36]["天3"] == 2 then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 40
			end
			
			--主角论剑打赢东方奖励+8
			if id == 0 and JY.Person[27]["论剑奖励"] == 1 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 8
			end
			
			if match_ID(id, 672) and JY.Person[672]["阶"] >= 3 and WAR.DDJQ[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.DDJQ[id]*3
			end
			
			if match_ID(id, 694) and JY.Person[694]["阶"] >= 1 and WAR.ZJJQ[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.ZJJQ[id]*3
			end
			
			if match_ID(id, 693) and JY.Person[693]["阶"] >= 2 and WAR.TQJQ[id] ~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.TQJQ[id]
			end

			
			--白万剑
			if Bwj1() and not inteam(id) then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*0.75)
			end
			if Bwj2() and inteam(id) then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*0.75)
			end
			
			
			if match_ID(id, 36) and JY.Person[36]["阶"] >= 3 then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*1.2)
			end
			
			--木桩不集气
			if id == 591 and WAR.ZDDH == 226 then
				WAR.Person[i].TimeAdd = 0
			end
			
			if max_jq < WAR.Person[i].TimeAdd then
				max_jq = WAR.Person[i].TimeAdd
				if max_jq > 100 then
				   max_jq = 100
				end   
			end

	--独孤求败集气锁定全场最高	
			if match_ID(id, 592) then
				dgqb = {i, WAR.Person[i].TimeAdd}
			end
		  
			num = num + 1
			total = total + WAR.Person[i].TimeAdd
		end
	end
	
	if dgqb[1] then
		if dgqb[2] < max_jq then
			total = total - WAR.Person[dgqb[1]].TimeAdd + max_jq + 1
			WAR.Person[dgqb[1]].TimeAdd = max_jq + 1
		end
	end
  
	--无酒不欢：这个返回值表达不明确，存疑
	WAR.LifeNum = num
	return math.modf(((total) / (num) + (num) - 2))
end


--武功范围选择
function War_KfMove(movefanwei, atkfanwei,wugong)
  local kind = movefanwei[1] or 0
  local len = movefanwei[2] or 0
  local x0 = WAR.Person[WAR.CurID]["坐标X"]
  local y0 = WAR.Person[WAR.CurID]["坐标Y"]
  local x = x0
  local y = y0
  if kind ~= nil then
    if kind == 0 then
      War_CalMoveStep(WAR.CurID, len, 1)
	  elseif kind == 1 then
	    War_CalMoveStep(WAR.CurID, len * 2, 1)
	    for r = 1, len * 2 do
	      for i = 0, r do
	        local j = r - i
	        if len < i or len < j then
	          SetWarMap(x0 + i, y0 + j, 3, 255)
	          SetWarMap(x0 + i, y0 - j, 3, 255)
	          SetWarMap(x0 - i, y0 + j, 3, 255)
	          SetWarMap(x0 - i, y0 - j, 3, 255)
	        end
	      end
	    end
	  elseif kind == 2 then
	    War_CalMoveStep(WAR.CurID, len, 1)
	    for i = 1, len - 1 do
	      for j = 1, len - 1 do
	        SetWarMap(x0 + i, y0 + j, 3, 255)
	        SetWarMap(x0 - i, y0 + j, 3, 255)
	        SetWarMap(x0 + i, y0 - j, 3, 255)
	        SetWarMap(x0 - i, y0 - j, 3, 255)
	      end
	    end
	  elseif kind == 3 then
	    War_CalMoveStep(WAR.CurID, 2, 1)
	    SetWarMap(x0 + 2, y0, 3, 255)
	    SetWarMap(x0 - 2, y0, 3, 255)
	    SetWarMap(x0, y0 + 2, 3, 255)
	    SetWarMap(x0, y0 - 2, 3, 255)
	  else
	    War_CalMoveStep(WAR.CurID, 0, 1)
	  end
  end
  
  CleanWarMap(7, 0)
  
  while true do
	if JY.Restart == 1 then
		break
	end
    local x2 = x
    local y2 = y

	WarDrawMap(1, x, y)
	
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	--shaol
	if (wugong == 1 or wugong == 22 or wugong == 24) and ShaoL(pid) ~= nil then
		for i = 1, 1+ShaoL(pid) do
			for j = 1, 1+ShaoL(pid) do
				SetWarMap(x + i - 1, y + j - 1, 7, 3)
				SetWarMap(x - i + 1, y + j - 1, 7, 3)
				SetWarMap(x + i - 1, y - j + 1, 7, 3)
				SetWarMap(x - i + 1, y - j + 1, 7, 3)
			end
		end
	end
	--扫地
	if match_ID(pid, 114) and JY.Person[114]["阶"] >= 3 then
	  for i = 1, 2 do
		for j = 1, 2 do
	    SetWarMap(x0 + i - 1, y0 + j - 1, 7, 1)
		SetWarMap(x0 - i + 1, y0 + j - 1, 7, 1)
		SetWarMap(x0 + i - 1, y0 - j + 1, 7, 1)
		SetWarMap(x0 - i + 1, y0 - j + 1, 7, 1)
		end
	  end	
	end
	--超震声波
	if wugong == 235 and JY.Person[690]["天3"] == 2 then
	local len1,len2,len3,len4 = 11+math.modf(JY.Person[689]["天2"]*0.8),10+math.modf(JY.Person[689]["天2"]*0.8),9+math.modf(JY.Person[689]["天2"]*0.8),8
	for fx = -1, 1 do 
    for fy = -1, 1 do
    if fx > 0 then
      fx = 1
    elseif fx < 0 then
      fx = -1
    end
    if fy > 0 then
      fy = 1
    elseif fy < 0 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
	
	
       for i = 0, len1 - 1 do
		 SetWarMap(x0 + i * fx, y0 + i * fy,7,3)
       end

         for i = 0, len2 - 1 do
		   SetWarMap(x0 + dx1 + i * fx, y0 + dy1 + i * fy,7,3)
           SetWarMap(x0 + dx2 + i * fx, y0 + dy2 + i * fy,7,3)
         end
         for i = 0, len3 - 1 do
		   SetWarMap(x0 + 2 * dx1 + i * fx, y0 + 2 * dy1 + i * fy,7,3)
           SetWarMap(x0 + 2 * dx2 + i * fx, y0 + 2 * dy2 + i * fy,7,3)
         end
         for i = 0, len4 - 1 do
		   SetWarMap(x0 + 3 * dx1 + i * fx, y0 + 3 * dy1 + i * fy,7,3)
           SetWarMap(x0 + 3 * dx2 + i * fx, y0 + 3 * dy2 + i * fy,7,3)
         end
	   
	end
	end
	end
	--lxf
	if ((match_ID(pid, 678) and JY.Person[678]["天4"] == 2) or (JY.Base["标准"] == 2 and pid == 0)) and JY.Wugong[wugong]["武功类型"] == 2 then
	local add = math.modf(JY.Person[pid]["指法技巧"]*0.01)
	if JY.Base["标准"] == 2 then
	   add = add + math.modf(JY.Base["天书数量"]/5)
	end
	local m1, m2, a1 = refw(wugong, 11)
	
	if a1 == 1 then
	      for i = 1, 9 + add, 2 do
			for j = 1, 9 + add, 2 do
				SetWarMap(x + i - 1, y + j - 1, 7, 3)
				SetWarMap(x - i + 1, y + j - 1, 7, 3)
				SetWarMap(x + i - 1, y - j + 1, 7, 3)
				SetWarMap(x - i + 1, y - j + 1, 7, 3)
			end
		  end
		--  
	elseif a1 == 10 then
	local len1, len2, len3, len4 = 9+add,9+add,8+add,7+add
		if not len2 then
        len2 = 0
        end
        if not len3 then
        len3 = 0
        end
        if not len4 then
        len4 = 0
        end
        local fx, fy = x - x0, y - y0
        if fx > 0 then
        fx = 1
        elseif fx < 0 then
        fx = -1
        end
        if fy > 0 then
        fy = 1
        elseif fy < 0 then
        fy = -1
        end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
    for i = 0, len1 - 1 do
    SetWarMap(x + i * fx, y + i * fy,7, 3)
    end
    for i = 0, len2 - 1 do
	SetWarMap(x + dx1 + i * fx, y + dy1 + i * fy,7, 3)
	SetWarMap(x + dx2 + i * fx, y + dy2 + i * fy,7, 3)
    end
        for i = 0, len3 - 1 do
	    SetWarMap(x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy,7, 3)
	    SetWarMap(x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy,7, 3)
        end
        for i = 0, len4 - 1 do
	    SetWarMap(x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy,7, 3)
	    SetWarMap(x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy,7, 3)
        end
		--
	elseif a1 == 12 then
	local len1 = 7 + add
	local fx, fy = x - x0, y - y0
    if fx > 1 then
       fx = 1
    elseif fx < -1 then
      fx = -1
    end
    if fy > 1 then
      fy = 1
    elseif fy < -1 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    if fx ~= 0 and fy ~= 0 then
      dx1 = (dx1 + fx) / 2
      dx2 = (dx2 + fx) / 2
      dy1 = (dy1 + fy) / 2
      dy2 = (dy2 + fy) / 2
      len1 = math.modf(len1 * 1.41421)
      for i = 0, len1 do
        if i <= len1 / 2 then
		  SetWarMap(x + i * fx, y + i * fy,7, 3)
        end
        for j = 1, len1 - i * 2 do
		SetWarMap(x + i * fx + j * (dx1), y + i * fy + j * (dy1),7, 3)
		SetWarMap(x + i * fx + j * (dx2), y + i * fy + j * (dy2),7, 3)
        end
      end
	else
      for i = 0, len1 do
        SetWarMap(x + i * fx, y + i * fy,7, 3)
        for j = 1, i do
          SetWarMap(x + i * fx + j * (dx1), y + i * fy + j * (dy1),7, 3)
          SetWarMap(x + i * fx + j * (dx2), y + i * fy + j * (dy2),7, 3)
        end
      end  
	end	
		
	elseif a1 == 3 then
		for i = 1, 2 + add do
			for j = 1, 2 + add do
				SetWarMap(x + i - 1, y + j - 1, 7, 3)
				SetWarMap(x - i + 1, y + j - 1, 7, 3)
				SetWarMap(x + i - 1, y - j + 1, 7, 3)
				SetWarMap(x - i + 1, y - j + 1, 7, 3)
			end
		end
	
	end
	end--end
	
	--天柱运气
	if JY.Wugong[wugong]["武功类型"] == 3 and match_ID(pid, 20) and JY.Person[20]["品德"] >= 44 then
	local len1, len2, len3, len4 = 17,17,17,17
	if not len2 then
      len2 = 0
    end
    if not len3 then
      len3 = 0
    end
    if not len4 then
      len4 = 0
    end
    local fx, fy = x - x0, y - y0
    if fx > 0 then
      fx = 1
    elseif fx < 0 then
      fx = -1
    end
    if fy > 0 then
      fy = 1
    elseif fy < 0 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
    for i = 0, len1 - 1 do
    SetWarMap(x + i * fx, y + i * fy,7,3)
    end
    for i = 0, len2 - 1 do
	SetWarMap(x + dx1 + i * fx, y + dy1 + i * fy,7,3)
	SetWarMap(x + dx2 + i * fx, y + dy2 + i * fy,7,3)
    end
    for i = 0, len3 - 1 do
	SetWarMap(x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy,7,3)
	SetWarMap(x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy,7,3)
    end
    for i = 0, len4 - 1 do
	SetWarMap(x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy,7,3)
	SetWarMap(x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy,7,3)
    end
	end	
	--开太极
	if match_ID(pid, 5) and PersonKF(pid,171) and (wugong == 16 or wugong == 46) and WAR.LQZ[pid] == 100 and WAR.tmp[3000 + pid]~= nil and WAR.tmp[3000 + pid]>=500 then
		for i = 1, 9 do
		    for j = 1, 9 do
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)  
		    end
		end
	end
	--金蛇奥义
	if match_ID_awakened(pid, 54, 1) and wugong == 40 then
	    for i = 1, 10 do
		    for j = 1, 10 do
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)  
		    end
		end
	end
	--万花
	if wugong == 30 and JY.Person[pid]["专1"] == 30 then
	    for i = 1, 7 do
		    for j = 1, 7 do
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)  
		    end
		end
	end
	--剑意纵横
	if match_ID(pid, 683) and JY.Wugong[wugong]["武功类型"] == 3 and JY.Person[683]["天3"] == 2 then
	    for i = 1, 8 do
		    for j = 1, 8 do
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)  
		    end
		end
	end
	--名动江湖
	if match_ID(pid, 671) and wugong == 199 and WAR.MMZS == 9 then
	   for i = 1, 9 do
		    for j = 1, 9 do
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] + j - 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i - 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i + 1, WAR.Person[WAR.CurID]["坐标Y"] - j + 1, 7, 3)  
		    end
		end
	end
    --龙啸
	if (wugong == 68 or wugong == 70 or wugong == 165 or wugong == 208) and JY.Person[pid]["武器"] == 344 then
	local len1, len2, len3, len4 = 11+JY.Thing[344]["装备等级"],11+JY.Thing[344]["装备等级"],11+JY.Thing[344]["装备等级"],11+JY.Thing[344]["装备等级"]
	if not len2 then
      len2 = 0
    end
    if not len3 then
      len3 = 0
    end
    if not len4 then
      len4 = 0
    end
    local fx, fy = x - x0, y - y0
    if fx > 0 then
      fx = 1
    elseif fx < 0 then
      fx = -1
    end
    if fy > 0 then
      fy = 1
    elseif fy < 0 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
    for i = 0, len1 - 1 do
    SetWarMap(x + i * fx, y + i * fy,7,3)
    end
    for i = 0, len2 - 1 do
	SetWarMap(x + dx1 + i * fx, y + dy1 + i * fy,7,3)
	SetWarMap(x + dx2 + i * fx, y + dy2 + i * fy,7,3)
    end
    for i = 0, len3 - 1 do
	SetWarMap(x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy,7,3)
	SetWarMap(x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy,7,3)
    end
    for i = 0, len4 - 1 do
	SetWarMap(x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy,7,3)
	SetWarMap(x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy,7,3)
    end
	end	
	--达摩剑
	if (match_ID(pid, 675) and JY.Wugong[wugong]["武功类型"] == 3 and JY.Person[675]["声望"] >= 110) or (wugong == 26 and PersonKF(pid, 188))then
		local xl_x = WAR.Person[WAR.CurID]["坐标X"]
		local xl_y = WAR.Person[WAR.CurID]["坐标Y"]
		for i = 1, 11, 2 do
			for j = 1, 11, 2 do
				SetWarMap(xl_x - i,xl_y + j,7,3)
				SetWarMap(xl_x - i,xl_y - j,7,3)
				SetWarMap(xl_x + i,xl_y + j,7,3)
				SetWarMap(xl_x + i,xl_y - j,7,3)
			end
		end
	end
	--降龙
	if wugong == 140 and JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["专2"] == 140 then
	    WarDrawAtt(x, y, atkfanwei, 4, nil, nil, nil, 1)
	else
		WarDrawAtt(x, y, atkfanwei, 4)
	end
	if wugong == 223 
	or (wugong == 82 and (match_ID(WAR.Person[WAR.CurID]["人物编号"], 597) or match_ID(WAR.Person[WAR.CurID]["人物编号"], 598) or match_ID(WAR.Person[WAR.CurID]["人物编号"], 599)))
	or match_ID(WAR.Person[WAR.CurID]["人物编号"], 688) and JY.Person[688]["阶"] >= 1 and wugong == 208 
	then
	   WarDrawAtt(WAR.Person[WAR.CurID]["坐标X"] + x0 - x, WAR.Person[WAR.CurID]["坐标Y"] + y0 - y, atkfanwei, 4)
	end
	
	--[[if wugong == 1 then
	local m1, m2, a1, a2, a3, a4, a5 = refw(2, 11)
	local newscope = {a1, a2, a3, a4, a5}
	WarDrawAtt(x, y, newscope, 4)
	end]]
	
    
    --判断合击，判断是否有合击者

	local ZHEN_ID = -1;
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and i ~= WAR.CurID and WAR.Person[i]["死亡"] == false then
			local nx = WAR.Person[i]["坐标X"]
			local ny = WAR.Person[i]["坐标Y"]
			local fid = WAR.Person[i]["人物编号"]
			for j = 1, JY.Person[671]["品德"] do
				if JY.Person[fid]["武功" .. j] == wugong then         
					if math.abs(nx-x0)+math.abs(ny-y0)<9 then
						local flagx, flagy = 0, 0
						if math.abs(nx - x0) <= 1 then
							flagx = 1
						end
						if math.abs(ny - y0) <= 1 then
							flagy = 1
						end
						if x0 == nx then
							flagy = 1
						end
						if y0 == ny then
							flagx = 1
						end
						if between(x, x0, nx, flagx) and between(y, y0, ny, flagy) then
							--合击人的战场编号
							ZHEN_ID = i
							
							--绘画合击的范围
							local tmp_id = WAR.CurID
							WAR.CurID = ZHEN_ID
							WarDrawAtt(WAR.Person[ZHEN_ID]["坐标X"] + x0 - x, WAR.Person[ZHEN_ID]["坐标Y"] + y0 - y, atkfanwei, 4)
							SetWarMap(nx,ny,7,3)
							WAR.CurID = tmp_id
																
							break;
						end
					end
				end
			end
			
			if ZHEN_ID >= 0 then
				break;
			end
		end
	end
    
	WarDrawMap(1, x, y)
    WarShowHead(GetWarMap(x, y, 2))
	
	--合击人标识
	if ZHEN_ID ~= -1 then
		local nx = WAR.Person[ZHEN_ID]["坐标X"]
		local ny = WAR.Person[ZHEN_ID]["坐标Y"]
		local dx = nx - x0
		local dy = ny - y0
		local size = CC.FontSmall;
		local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
		local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
									
		local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
									
		DrawString(rx - size*1.5, ry-hb-size/2, "合击者", M_DeepSkyBlue, size);
	end
	
	--显示可以覆盖的敌人信息
	for i = 0, CC.WarWidth - 1 do
		for j = 0, CC.WarHeight - 1 do
			local target = GetWarMap(i, j, 7)
			if target ~= nil and target == 2 then
				if GetWarMap(i, j, 2) ~= nil and WAR.Person[GetWarMap(i, j, 2)]["人物编号"] ~= nil then
					local x0 = WAR.Person[WAR.CurID]["坐标X"];
					local y0 = WAR.Person[WAR.CurID]["坐标Y"];
					local dx = i - x0
					local dy = j - y0
					local size = CC.FontSmall;
					local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
					local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
					
					local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

					ry = ry - hb - CC.ScreenH/6;
							
					if ry < 1 then			--加上这个，防止看不到血的情况
						ry = 1;
					end
					
					--显示选中人物的生命值
					local color = RGB(245, 251, 5);
					local hp = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["生命"] or 0;
					local maxhp = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["生命最大值"] or 0;
					
					local ns = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["受伤程度"] or 0;
					local zd = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["中毒程度"] or 0;
					local len = #(string.format("%d/%d",hp,maxhp));
					rx = rx - len*size/4;
					
					--颜色根据所受的内伤确定
					if ns < 33 then
						color = RGB(236, 200, 40)
					elseif ns < 66 then
						color = RGB(244, 128, 32)
					else
						color = RGB(232, 32, 44)
					end
					
					DrawString(rx, ry, string.format("%d",hp), color, size);
					DrawString(rx + #string.format("%d",hp)*size/2, ry, "/", C_GOLD, size);
					
					if zd == 0 then
						color = RGB(252, 148, 16)
					elseif zd < 50 then
						color = RGB(120, 208, 88)
					else
						color = RGB(56, 136, 36)
					end
					DrawString(rx + #string.format("%d",hp)*size/2 + size/2 , ry, string.format("%d", maxhp), color, size)
				end
			end
		end
	end

    ShowScreen()
	CleanWarMap(7, 0)

    local key, ktype, mx, my = WaitKey(1)

    if key == VK_UP then
      y2 = y - 1
    elseif key == VK_DOWN then
      y2 = y + 1
    elseif key == VK_LEFT then
      x2 = x - 1
    elseif key == VK_RIGHT then
      x2 = x + 1
    elseif (key == VK_SPACE or key == VK_RETURN) then
      return x, y

    elseif (key == VK_ESCAPE or ktype == 4) and WAR.AHZS ~= 5 and WAR.LMZS ~= 4 then
      return nil
    elseif ktype == 2 or ktype == 3 then
      mx = mx - CC.ScreenW / 2
      my = my - CC.ScreenH / 2
      mx = (mx) / CC.XScale
      my = (my) / CC.YScale
      mx, my = (mx + my) / 2, (my - mx) / 2
      if mx > 0 then
        mx = mx + 0.99
      else
        mx = mx - 0.01
      end
      if my > 0 then
        my = my + 0.99
      else
        mx = mx - 0.01
      end
      mx = math.modf(mx)
      my = math.modf(my)
      for i = 1, 20 do
        if mx + i > 63 or my + i > 63 then
           return;
        end
        local hb = GetS(JY.SubScene, mx + i, my + i, 4)

        if math.abs(hb - CC.YScale * i * 2) < 8 then
          mx = mx + i
          my = my + i
        end
      end
      
      x2, y2 = mx + x0, my + y0
	    if ktype == 3 and (kind < 2 or x ~= x0 or y ~= y0) then
	      return x, y					
	    end
	    
    end
    if x2 >= 0 and x2 < CC.WarWidth and y2 >= 0 and y2 < CC.WarHeight then
			if GetWarMap(x2, y2, 3) ~= nil and GetWarMap(x2, y2, 3) < 128 then
	      x = x2
	      y = y2
		  end
		end
	end
end
--WarDrawAtt
function WarDrawAtt(x, y, fanwei, flag, cx, cy, atk, dm)
  local x0, y0 = nil
  if cx == nil or cy == nil then
    x0 = WAR.Person[WAR.CurID]["坐标X"]
    y0 = WAR.Person[WAR.CurID]["坐标Y"]
  else
    x0, y0 = cx, cy
  end
  local kind = fanwei[1]			--攻击范围
  local len1 = fanwei[2]
  local len2 = fanwei[3]
  local len3 = fanwei[4]
  local len4 = fanwei[5]
  local xy = {}
  local num = 0
  if kind == 0 then
    num = 1
    xy[1] = {x, y}
  elseif kind == 1 then
    if not len1 then
      len1 = 0
    end
    if not len2 then
      len2 = 0
    end
    num = num + 1
    xy[num] = {x, y}
    for i = 1, len1 do
      xy[num + 1] = {x + i, y}
      xy[num + 2] = {x - i, y}
      xy[num + 3] = {x, y + i}
      xy[num + 4] = {x, y - i}
      num = num + 4
    end
    for i = 1, len2 do
      xy[num + 1] = {x + i, y + i}
      xy[num + 2] = {x - i, y - i}
      xy[num + 3] = {x - i, y + i}
      xy[num + 4] = {x + i, y - i}
      num = num + 4
    end
  elseif kind == 2 then
    for tx = x - len1, x + len1 do
      for ty = y - len1, y + len1 do
        if len1 < math.abs(tx - x) + math.abs(ty - y) then
          
        else
        	num = num + 1
        	xy[num] = {tx, ty}
        end
        
      end
    end
  elseif kind == 3 then
    if not len2 then
      len2 = len1
    end
    local dx, dy = math.abs(x - x0), math.abs(y - y0)
    if dy < dx then
      len1, len2 = len2, len1
    end
    for tx = x - len1, x + len1 do
      for ty = y - len2, y + len2 do
        num = num + 1
        xy[num] = {tx, ty}
      end
    end
  elseif kind == 5 then
    if not len1 then
      len1 = 0
    end
    if not len2 then
      len2 = 0
    end
    num = num + 1
    xy[num] = {x, y}
    for i = 1, len1 do
      xy[num + 1] = {x + i, y}
      xy[num + 2] = {x - i, y}
      xy[num + 3] = {x, y + i}
      xy[num + 4] = {x, y - i}
      num = num + 4
    end
    if len2 > 0 then
      xy[num + 1] = {x + 1, y + 1}
      xy[num + 2] = {x + 1, y - 1}
      xy[num + 3] = {x - 1, y + 1}
      xy[num + 4] = {x - 1, y - 1}
      num = num + 4
    end
    for i = 2, len2 do
      xy[num + 1] = {x + i, y + 1}
      xy[num + 2] = {x - i, y - 1}
      xy[num + 3] = {x - i, y + 1}
      xy[num + 4] = {x + i, y - 1}
      xy[num + 5] = {x + 1, y + i}
      xy[num + 6] = {x - 1, y - i}
      xy[num + 7] = {x - 1, y + i}
      xy[num + 8] = {x + 1, y - i}
      num = num + 8
    end
  elseif kind == 6 then
    if not len2 then
      len2 = len1
    end
    xy[1] = {x + 1, y}
    xy[2] = {x - 1, y}
    xy[3] = {x, y + 1}
    xy[4] = {x, y - 1}
    num = num + 4
    if len1 > 0 or len2 > 0 then
      xy[5] = {x + 1, y + 1}
      xy[6] = {x + 1, y - 1}
      xy[7] = {x - 1, y + 1}
      xy[8] = {x - 1, y - 1}
      num = num + 4
      for i = 2, len1 do
        xy[num + 1] = {x + i, y + 1}
        xy[num + 2] = {x - i, y + 1}
        xy[num + 3] = {x + i, y - 1}
        xy[num + 4] = {x - i, y - 1}
        num = num + 4
      end
      for i = 2, len2 do
        xy[num + 1] = {x + 1, y + i}
        xy[num + 2] = {x + 1, y - i}
        xy[num + 3] = {x - 1, y + i}
        xy[num + 4] = {x - 1, y - i}
        num = num + 4
      end
    end
  elseif kind == 7 then
    if not len2 then
      len2 = len1
    end
    if len1 == 0 then
      for i = y - len2, y + len2 do
        num = num + 1
        xy[num] = {x, i}
      end
    elseif len2 == 0 then
      for i = x - len1, x + len1 do
        num = num + 1
        xy[num] = {i, y}
      end
    else
      for i = x - len1, x + len1 do
        num = num + 1
        xy[num] = {i, y}
        num = num + 1
        xy[num] = {i, y + len2}
        num = num + 1
        xy[num] = {i, y - len2}
      end
      for i = 1, len2 - 1 do
        xy[num + 1] = {x, y + i}
        xy[num + 2] = {x, y - i}
        xy[num + 3] = {x - len1, y + i}
        xy[num + 4] = {x - len1, y - i}
        xy[num + 5] = {x + len1, y + i}
        xy[num + 6] = {x + len1, y - i}
        num = num + 6
      end
    end
  elseif kind == 8 then
    xy[1] = {x, y}
    num = 1
    for i = 1, len1 do
      xy[num + 1] = {x + i, y}
      xy[num + 2] = {x - i, y}
      xy[num + 3] = {x, y + i}
      xy[num + 4] = {x, y - i}
      xy[num + 5] = {x + i, y + len1}
      xy[num + 6] = {x - i, y - len1}
      xy[num + 7] = {x + len1, y - i}
      xy[num + 8] = {x - len1, y + i}
      num = num + 8
    end
  elseif kind == 9 then
    xy[1] = {x, y}
    num = 1
    for i = 1, len1 do
      xy[num + 1] = {x + i, y}
      xy[num + 2] = {x - i, y}
      xy[num + 3] = {x, y + i}
      xy[num + 4] = {x, y - i}
      xy[num + 5] = {x - i, y + len1}
      xy[num + 6] = {x + i, y - len1}
      xy[num + 7] = {x + len1, y + i}
      xy[num + 8] = {x - len1, y - i}
      num = num + 8
    end
  elseif x == x0 and y == y0 then
    return 0
  elseif kind == 10 then
    if not len2 then
      len2 = 0
    end
    if not len3 then
      len3 = 0
    end
    if not len4 then
      len4 = 0
    end
    local fx, fy = x - x0, y - y0
    if fx > 0 then
      fx = 1
    elseif fx < 0 then
      fx = -1
    end
    if fy > 0 then
      fy = 1
    elseif fy < 0 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
    for i = 0, len1 - 1 do
      num = num + 1
      xy[num] = {x + i * fx, y + i * fy}
    end
    for i = 0, len2 - 1 do
      num = num + 1
      xy[num] = {x + dx1 + i * fx, y + dy1 + i * fy}
      num = num + 1
      xy[num] = {x + dx2 + i * fx, y + dy2 + i * fy}
    end
    for i = 0, len3 - 1 do
      num = num + 1
      xy[num] = {x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy}
      num = num + 1
      xy[num] = {x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy}
    end
    for i = 0, len4 - 1 do
      num = num + 1
      xy[num] = {x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy}
      num = num + 1
      xy[num] = {x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy}
    end
  elseif kind == 11 then
    local fx, fy = x - x0, y - y0
    if fx > 1 then
      fx = 1
    elseif fx < -1 then
      fx = -1
    end
    if fy > 1 then
      fy = 1
    elseif fy < -1 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    if fx ~= 0 and fy ~= 0 then
      dx1 = -(dx1 + fx) / 2
      dx2 = -(dx2 + fx) / 2
      dy1 = -(dy1 + fy) / 2
      dy2 = -(dy2 + fy) / 2
      len1 = math.modf(len1 * 0.7071)
      for i = 0, len1 do
        num = num + 1
        xy[num] = {x + i * fx, y + i * fy}
        for j = 1, 2 * i + 1 do
          num = num + 1
          xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
          num = num + 1
          xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
        end
      end
    else
      for i = 0, len1 do
        num = num + 1
        xy[num] = {x + i * fx, y + i * fy}
        for j = 1, len1 - i do
          num = num + 1
          xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
          num = num + 1
          xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
        end
      end
    end
  elseif kind == 12 then
    local fx, fy = x - x0, y - y0
    if fx > 1 then
      fx = 1
    elseif fx < -1 then
      fx = -1
    end
    if fy > 1 then
      fy = 1
    elseif fy < -1 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    if fx ~= 0 and fy ~= 0 then
      dx1 = (dx1 + fx) / 2
      dx2 = (dx2 + fx) / 2
      dy1 = (dy1 + fy) / 2
      dy2 = (dy2 + fy) / 2
      len1 = math.modf(len1 * 1.41421)
      for i = 0, len1 do
        if i <= len1 / 2 then
          num = num + 1
          xy[num] = {x + i * fx, y + i * fy}
        end
        for j = 1, len1 - i * 2 do
          num = num + 1
          xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
          num = num + 1
          xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
        end
      end
    else
      for i = 0, len1 do
        num = num + 1
        xy[num] = {x + i * fx, y + i * fy}
        for j = 1, i do
          num = num + 1
          xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
          num = num + 1
          xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
        end
      end
    end
  elseif kind == 13 then
    local fx, fy = x - x0, y - y0
    if fx > 1 then
      fx = 1
    elseif fx < -1 then
      fx = -1
    end
    if fy > 1 then
      fy = 1
    elseif fy < -1 then
      fy = -1
    end
    local xx = x + fx * len1
    local yy = y + fy * len1
    for tx = xx - len1, xx + len1 do
      for ty = yy - len1, yy + len1 do
        if len1 < math.abs(tx - xx) + math.abs(ty - yy) then
          break;
        end
        num = num + 1
        xy[num] = {tx, ty}
      end
    end
  else
    return 0
  end
  --xydd
	--[[if sj then
		local xl_x = WAR.Person[WAR.CurID]["坐标X"]
		local xl_y = WAR.Person[WAR.CurID]["坐标Y"]
		for i = 1, 11, 2 do
			for j = 1, 11, 2 do
				num = num + 1
				xy[num] = {xl_x - i, xl_y + j}
				num = num + 1
				xy[num] = {xl_x - i, xl_y - j}
				num = num + 1
				xy[num] = {xl_x + i, xl_y + j}
				num = num + 1
				xy[num] = {xl_x + i, xl_y - j}
			end
		end
	end]]
		
	if dm then
	local xl_x = WAR.Person[WAR.CurID]["坐标X"]
		local xl_y = WAR.Person[WAR.CurID]["坐标Y"]
		for i = 0, 14, 2 do
			for j = 0, 14 do
			    if j <= i then
				num = num + 1
				xy[num] = {xl_x - i, xl_y + j}
				num = num + 1
				xy[num] = {xl_x - i, xl_y - j}
				num = num + 1
				xy[num] = {xl_x + i, xl_y + j}
				num = num + 1
				xy[num] = {xl_x + i, xl_y - j}
				end
			end
		end
		for i = 0, 14 do
			for j = 0, 14, 2 do
			    if i <= j then
				num = num + 1
				xy[num] = {xl_x - i, xl_y - j}
				num = num + 1
				xy[num] = {xl_x + i, xl_y - j}
				num = num + 1
				xy[num] = {xl_x - i, xl_y + j}
				num = num + 1
				xy[num] = {xl_x + i, xl_y + j}
				end
			end
		end
	end
  
  if flag == 1 then
    local thexy = function(nx, ny, x, y)
	    local dx, dy = nx - x, ny - y
	    local hb = lib.GetS(JY.SubScene, nx, ny, 4)
	    return CC.ScreenW / 2 + CC.XScale * (dx - dy), CC.ScreenH / 2 + CC.YScale * (dx + dy) - hb
    end
    
    for i = 1, num do
    	if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
      	local tx, ty = thexy(xy[i][1], xy[i][2], x0, y0)

	      if GetWarMap(xy[i][1], xy[i][2], 2) ~= nil and GetWarMap(xy[i][1], xy[i][2], 2) >= 0 and GetWarMap(xy[i][1], xy[i][2], 2) ~= WAR.CurID then
				if not inteam(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]) and WAR.Person[WAR.CurID]["我方"] then
		      	local x0 = WAR.Person[WAR.CurID]["坐标X"];
		      	local y0 = WAR.Person[WAR.CurID]["坐标Y"];
		      	local dx = xy[i][1] - x0
		        local dy = xy[i][2] - y0
		        local size = CC.FontSmall;
		        local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
		        local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
		        
		        local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

		        ry = ry - hb - CC.ScreenH/6;
						
		        if ry < 1 then			--加上这个，防止看不到血的情况
		        	ry = 1;
		        end
		      	
		      	--显示选中人物的生命值
		      	local color = RGB(245, 251, 5);
		      	local hp = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["生命"];
		      	local maxhp = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["生命最大值"];
		      	
		      	local ns = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["受伤程度"];
		      	local zd = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["中毒程度"];
		      	local len = #(string.format("%d/%d",hp,maxhp));
		      	rx = rx - len*size/4;
		      	
		      	--颜色根据所受的内伤确定
		      	if ns < 33 then
					color = RGB(236, 200, 40)
				elseif ns < 66 then
					color = RGB(244, 128, 32)
				else
					color = RGB(232, 32, 44)
				end
		      	
		      	DrawString(rx, ry, string.format("%d",hp), color, size);
		      	DrawString(rx + #string.format("%d",hp)*size/2, ry, "/", C_GOLD, size);
		      	
		      	if zd == 0 then
				      color = RGB(252, 148, 16)
				    elseif zd < 50 then
				      color = RGB(120, 208, 88)
				    else
				      color = RGB(56, 136, 36)
				    end
				    DrawString(rx + #string.format("%d",hp)*size/2 + size/2 , ry, string.format("%d", maxhp), color, size)
		      end
		      
	      	--lib.PicLoadCache(0, 0, tx, ty, 2, 200)
	      else
	      	--lib.PicLoadCache(0, 0, tx, ty, 2, 112)
	      end
	      
	    end
    end

  elseif flag == 2 then
    local diwo = WAR.Person[WAR.CurID]["我方"]
    local atknum = 0
    for i = 1, num do
      if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
        local id = GetWarMap(xy[i][1], xy[i][2], 2)
      
	      if id ~= -1 and id ~= WAR.CurID then
	        local xa, xb, xc = nil, nil, nil
			local e_diwo = WAR.Person[id]["我方"]
			--张家辉的隐身戒指
			if (JY.Person[WAR.Person[id]["人物编号"]]["防具"] == 304 and WAR.YSJZ == 0) or WAR.YLMB[WAR.Person[id]["人物编号"]] ~= nil or WAR.PPWQ[WAR.Person[id]["人物编号"]] ~= nil then
				e_diwo = diwo
			end
	        if diwo ~= e_diwo then
				xa = 2
	        else
				xa = 0
	        end
	        local hp = JY.Person[WAR.Person[id]["人物编号"]]["生命"]
	        if hp < atk / 6 then
	          xb = 2
	        elseif hp < atk / 3 then
	          xb = 1
	        else
	          xb = 0
	        end
	        local danger = JY.Person[WAR.Person[id]["人物编号"]]["内力最大值"]
	        xc = danger / 500
	        atknum = atknum + xa * math.modf(xb * (xc) + 5)
	      end
      end
    end
    return atknum
  elseif flag == 3 then
    for i = 1, num do
    	if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
      	SetWarMap(xy[i][1], xy[i][2], 4, 1)
      end
    end
	--武功选择范围
  elseif flag == 4 then
    for i = 1, num do
    	if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
			if GetWarMap(xy[i][1], xy[i][2], 2) ~= nil and GetWarMap(xy[i][1], xy[i][2], 2) >= 0 then
				--七夕龙女的论剑奖励代表是否学有迷踪步
				--自动不触发
				if WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"] == 0 and JY.Person[615]["论剑奖励"] == 1 and math.random(10) < 4 and WAR.AutoFight == 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
					--用阿凡提的品德作为触发迷踪步的判定
					JY.Person[606]["品德"] = 90
				end
				--fwjt
				if Curr_QG(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"], 216) and  match_ID(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"], 678) and math.random(110) < 0 + math.modf(JY.Person[0]["实战"]/25) and WAR.AutoFight == 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
					--用阿凡提的品德作为触发迷踪步的判定
					JY.Person[606]["品德"] = 90
				end
				--小昭影步
				if match_ID(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"], 66) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
					--用小昭的品德作为触发影步的判定
					JY.Person[66]["品德"] = 90
				end
				--雷震，虚空藏
				if match_ID(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"], 670) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] and math.random(100) < 15 + math.modf(JY.Person[0]["特殊兵器"]*0.05) then
				    if JY.Base["畅想"] == 670 then
					JY.Person[670]["品德"] = 90
					end
				end
				--阿修罗闪空
				if match_ID(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"], 673) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] and math.random(110) < 20 + math.modf(JY.Person[0]["实战"]/25) then
				    if JY.Base["畅想"] == 673 then
					JY.Person[673]["品德"] = 90
					end
				end
				--畅想张无忌逆转乾坤
				--自动不触发
				if WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"] == 0 and JY.Base["畅想"] == 9 and PersonKF(0, 97) and WAR.AutoFight == 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
					--基础35%几率
					local chance = 36
					--每本天书+1几率
					chance = chance + JY.Base["天书数量"]
					if WAR.LQZ[0] == 100 then
						chance = chance + 10
					end
					if math.random(100) < chance then
						JY.Person[614]["品德"] = 90
					end
				end
				--命中的敌方的点为2
				if not inteam(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]) and WAR.Person[WAR.CurID]["我方"] then
					SetWarMap(xy[i][1], xy[i][2], 7, 2)
				else
					SetWarMap(xy[i][1], xy[i][2], 7, 1)
				end
			else
				SetWarMap(xy[i][1], xy[i][2], 7, 1)
			end
		end
    end
  end
end

PNLBD = {} 

PNLBD[321] = function()
local ng1 = {85,87,88,89,90,93,96,99,100,101,104,144,163,175,177,186,188}--188,17
local ng2 = {92,94,97,96,98,101,102,103,104,105,106,107,108,144,154,171,177,186,188,237}--188,19
local qg = {145,146,147,148,149,150,178,179,180,181}--181,10

    JY.Person[659]["姓名"] = "LLM32"
	JY.Person[660]["姓名"] = "冒救药"
	JY.Person[661]["姓名"] = "wangbababin"
	JY.Person[662]["姓名"] = "f3960"
	JY.Person[663]["姓名"] = "至尊元老"
	JY.Person[664]["姓名"] = "四粉"

--kael
  JY.Person[689]["生命"] = 3000
  JY.Person[689]["生命最大值"] = 3000
  JY.Person[689]["内力"] = 7000
  JY.Person[689]["内力最大值"] = 7000
  JY.Person[689]["攻击力"] = 200
  JY.Person[689]["防御力"] = 200
  JY.Person[689]["轻功"] = 200
  JY.Person[689]["实战"] = 500
  JY.Person[689]["拳掌功夫"] = 101
  JY.Person[689]["指法技巧"] = 101
  JY.Person[689]["御剑能力"] = 101
  JY.Person[689]["耍刀技巧"] = 101
  JY.Person[689]["特殊兵器"] = 101
  JY.Person[689]["资质"] = 50
  JY.Person[689]["左右互搏"] = 1
  JY.Person[689]["出战"] = 1
  for i = 1, 10 do
  JY.Person[689]["武功"..i] = 225+i  
  JY.Person[689]["武功等级"..i] = 999
  end
  JY.Person[689]["武功2"] = 228
  JY.Person[689]["武功5"] = 238
  JY.Person[689]["武功8"] = 235
  if JY.Base["畅想"] ~= 689 then
  JY.Person[689]["天1"] = 6
  JY.Person[689]["天2"] = 6
  JY.Person[689]["天3"] = 6
  JY.Person[689]["声望"] = 2
  for i = 1, 4 do
  JY.Person[690]["天"..i] = math.random(2)
  end
  JY.Person[690]["品德"] = math.random(2)
  end
  
  --sucan
  JY.Person[692]["生命"] = 6000
  JY.Person[692]["生命最大值"] = 6000
  JY.Person[692]["内力"] = 6699
  JY.Person[692]["内力最大值"] = 6699
  JY.Person[692]["攻击力"] = 300
  JY.Person[692]["防御力"] = 300
  JY.Person[692]["轻功"] = 300
  JY.Person[692]["实战"] = 500
  JY.Person[692]["武学常识"] = 50
  JY.Person[692]["拳掌功夫"] = 270
  JY.Person[692]["指法技巧"] = 120
  JY.Person[692]["御剑能力"] = 90
  JY.Person[692]["耍刀技巧"] = 100
  JY.Person[692]["特殊兵器"] = 90
  JY.Person[692]["武功1"] = 26
  JY.Person[692]["武功2"] = 80
  JY.Person[692]["武功3"] = 240
  JY.Person[692]["洗髓"] = 100
  for i = 1, 3 do
  JY.Person[692]["武功等级"..i] = 999
  end
  if JY.Base["畅想"] ~= 692 then
     JY.Person[692]["天3"] = math.random(2) 
	 JY.Person[692]["天4"] = 1
  end
--dp
  JY.Person[691]["生命"] = 6000
  JY.Person[691]["生命最大值"] = 6000
  JY.Person[691]["内力"] = 6699
  JY.Person[691]["内力最大值"] = 6699
  JY.Person[691]["攻击力"] = 300
  JY.Person[691]["防御力"] = 300
  JY.Person[691]["轻功"] = 300
  JY.Person[691]["实战"] = 500
  JY.Person[691]["武学常识"] = 100
  JY.Person[691]["拳掌功夫"] = 80
  JY.Person[691]["指法技巧"] = 80
  JY.Person[691]["御剑能力"] = 140
  JY.Person[691]["耍刀技巧"] = 250
  JY.Person[691]["特殊兵器"] = 60
  JY.Person[691]["武器"] = 319
  JY.Person[691]["武功1"] = 189
  JY.Person[691]["武功2"] = 55
  JY.Person[691]["武功3"] = 237
  if JY.Base["畅想"] ~= 691 then
     for i = 1, 4 do
	     if JY.Person[691]["天"..i] == 0 then
            JY.Person[691]["天"..i] = math.random(2)
         end
	 end	 
  end
--nf
  JY.Person[681]["生命"] = 6000
  JY.Person[681]["生命最大值"] = 6000
  JY.Person[681]["内力"] = 9999
  JY.Person[681]["内力最大值"] = 9999
  JY.Person[681]["攻击力"] = 380
  JY.Person[681]["防御力"] = 320
  JY.Person[681]["轻功"] = 520
  JY.Person[681]["实战"] = 500
  JY.Person[681]["武学常识"] = 100
  JY.Person[681]["拳掌功夫"] = 100
  JY.Person[681]["指法技巧"] = 100
  JY.Person[681]["御剑能力"] = 100
  JY.Person[681]["耍刀技巧"] = 320
  JY.Person[681]["特殊兵器"] = 100
  JY.Person[681]["品德"] = 6
  JY.Person[681]["武器"] = 360
  WAR.MXD[681] = 30
  if JY.Base["畅想"] ~= 681 then
     for i = 1, 4 do
	     if JY.Person[681]["天"..i] == 0 then
            JY.Person[681]["天"..i] = math.random(2)
         end
	 end	 
  end
  
  JY.Person[682]["生命"] = 6000
  JY.Person[682]["生命最大值"] = 6000
  JY.Person[682]["内力"] = 9999
  JY.Person[682]["内力最大值"] = 9999
  JY.Person[682]["攻击力"] = 480
  JY.Person[682]["防御力"] = 320
  JY.Person[682]["轻功"] = 320
  JY.Person[682]["实战"] = 500
  JY.Person[682]["武学常识"] = 100
  JY.Person[682]["拳掌功夫"] = 300
  JY.Person[682]["指法技巧"] = 80
  JY.Person[682]["御剑能力"] = 300
  JY.Person[682]["耍刀技巧"] = 70
  JY.Person[682]["特殊兵器"] = 70
  JY.Person[682]["武功1"] = 221  
  JY.Person[682]["武功等级1"] = 999
  JY.Person[682]["武功2"] = 222
  JY.Person[682]["武功等级2"] = 999
  JY.Person[682]["武器"] = 362
  if JY.Base["畅想"] ~= 682 then
     for i = 3, 4 do
	     if JY.Person[682]["天"..i] == 0 then
  JY.Person[682]["天"..i] = math.random(2)
         end
	 end	 
  end

--雷震
  JY.Person[670]["生命"] = 6300
  JY.Person[670]["生命最大值"] = 6300
  JY.Person[670]["内力"] = 9999
  JY.Person[670]["内力最大值"] = 9999
  JY.Person[670]["攻击力"] = 350
  JY.Person[670]["防御力"] = 250
  JY.Person[670]["轻功"] = 350
  JY.Person[670]["实战"] = 500
  JY.Person[670]["医疗能力"] = 500

  JY.Person[670]["拳掌功夫"] = 320
  JY.Person[670]["指法技巧"] = 320
  JY.Person[670]["御剑能力"] = 320
  JY.Person[670]["耍刀技巧"] = 320
  JY.Person[670]["特殊兵器"] = 320
  JY.Person[670]["防具"] = 327
  JY.Person[670]["武器"] = 345
  
  JY.Person[670]["武功1"] = 197  
  JY.Person[670]["武功等级1"] = 999
  JY.Person[670]["武功2"] = 108
  JY.Person[670]["武功等级2"] = 999
  JY.Person[670]["武功3"] = 49
  JY.Person[670]["武功等级3"] = 999
  JY.Person[670]["武功4"] = 66
  JY.Person[670]["武功等级4"] = 999
  JY.Person[670]["武功5"] = 26
  JY.Person[670]["武功等级5"] = 999
  JY.Person[670]["武功6"] = 80
  JY.Person[670]["武功等级6"] = 999
  JY.Person[670]["武功7"] = 147
  JY.Person[670]["武功等级7"] = 999
  JY.Person[670]["天赋内功"] = 108
  JY.Person[670]["天赋轻功"] = 147
  JY.Person[670]["出战"]=1
  
  
  --无名
  JY.Person[671]["生命"] = 4500
  JY.Person[671]["生命最大值"] = 4500
  JY.Person[671]["内力"] = 9999
  JY.Person[671]["内力最大值"] = 9999
  JY.Person[671]["攻击力"] = 350
  JY.Person[671]["防御力"] = 200
  JY.Person[671]["轻功"] = 350
  JY.Person[671]["实战"] = 500
  JY.Person[671]["医疗能力"] = 500
  JY.Person[671]["武器"] = 353

  JY.Person[671]["拳掌功夫"] = 200
  JY.Person[671]["指法技巧"] = 200
  JY.Person[671]["御剑能力"] = 999
  JY.Person[671]["耍刀技巧"] = 200
  JY.Person[671]["特殊兵器"] = 200
  
  JY.Person[671]["武功2"] = 167
  JY.Person[671]["武功等级2"] = 999
  JY.Person[671]["武功3"] = 168
  JY.Person[671]["武功等级3"] = 999
  JY.Person[671]["武功4"] = 46
  JY.Person[671]["武功等级4"] = 999
  JY.Person[671]["武功5"] = 45
  JY.Person[671]["武功等级5"] = 999
  JY.Person[671]["武功6"] = 198
  JY.Person[671]["武功等级6"] = 999
 
  
  --华英雄
  JY.Person[675]["生命"] = 6000
  JY.Person[675]["生命最大值"] = 6000
  JY.Person[675]["内力"] = 6000
  JY.Person[675]["内力最大值"] = 6000
  JY.Person[675]["攻击力"] = 300
  JY.Person[675]["防御力"] = 200
  JY.Person[675]["轻功"] = 200
  JY.Person[675]["实战"] = 500
  JY.Person[675]["御剑能力"] = 210
  JY.Person[675]["拳掌功夫"] = 180
  if JY.Base["畅想"] ~= 675 then
     JY.Person[675]["声望"] = 600
	 JY.Person[675]["品德"] = 6
  end	 
  
  --?
  JY.Person[654]["生命"] = 6500
  JY.Person[654]["生命最大值"] = 6500
  JY.Person[654]["实战"] = 500
  
  
  --豪鬼
  JY.Person[673]["生命"] = 4800
  JY.Person[673]["生命最大值"] = 4800
  JY.Person[673]["内力"] = 8000
  JY.Person[673]["内力最大值"] = 8000
  JY.Person[673]["攻击力"] = 520
  JY.Person[673]["防御力"] = 300
  JY.Person[673]["轻功"] = 400
  JY.Person[673]["实战"] = 500
  JY.Person[673]["医疗能力"] = 0
  JY.Person[673]["暗器技巧"] = 200
  JY.Person[673]["武功5"] = 210
  JY.Person[673]["武功等级5"] = 999

  JY.Person[673]["拳掌功夫"] = 333
  JY.Person[673]["指法技巧"] = 100
  JY.Person[673]["御剑能力"] = 0
  JY.Person[673]["耍刀技巧"] = 0
  JY.Person[673]["特殊兵器"] = 0
  WAR.SYBD[673] = 100
  if JY.Base["畅想"] ~= 673 then
     if JY.Person[673]["外号2"] == "小子" then
  if math.random(2) == 1 then
     JY.Person[673]["外号2"] = "怒"
  else	 
     JY.Person[673]["外号2"] = "烈"
  end
     end
	 JY.Person[673]["天1"] = math.random(2)
  end
  --武僧
  JY.Person[676]["生命"] = 6000
  JY.Person[676]["生命最大值"] = 6000
  JY.Person[676]["内力"] = 8000
  JY.Person[676]["内力最大值"] = 8000
  JY.Person[676]["实战"] = 500
  JY.Person[676]["武学常识"] = 150
  JY.Person[676]["拳掌功夫"] = 200
  JY.Person[676]["指法技巧"] = 100
  JY.Person[676]["御剑能力"] = 100
  JY.Person[676]["耍刀技巧"] = 100
  JY.Person[676]["特殊兵器"] = 100
  
  JY.Person[676]["防具"] = 355
  JY.Person[676]["武器"] = 354
  
  JY.Person[676]["武功1"] = 1  
  JY.Person[676]["武功等级1"] = 999
  JY.Person[676]["武功2"] = 24
  JY.Person[676]["武功等级2"] = 999
  JY.Person[676]["武功3"] = 22
  JY.Person[676]["武功等级3"] = 999
  JY.Person[676]["武功4"] = 186
  JY.Person[676]["武功等级4"] = 999
  JY.Person[676]["武功5"] = 144
  JY.Person[676]["武功等级5"] = 999
  JY.Person[676]["武功6"] = 96
  JY.Person[676]["武功等级6"] = 999
  JY.Person[676]["武功7"] = 182
  JY.Person[676]["武功等级7"] = 999
  JY.Person[676]["天赋内功"] = 108
  JY.Person[676]["天赋轻功"] = 182

  if JY.Base["畅想"] ~= 676 then
  for i = 1, 4 do
	 if JY.Person[676]["天"..i] == 0 then
        JY.Person[676]["天"..i] = math.random(2)
	 end
  end
  end
  WAR.LSF[676] = 50
  JY.Person[683]["生命"] = 6000
  JY.Person[683]["生命最大值"] = 6000
  JY.Person[683]["内力"] = 8000
  JY.Person[683]["内力最大值"] = 8000
  JY.Person[683]["实战"] = 500
  JY.Person[683]["武学常识"] = 60
  JY.Person[683]["拳掌功夫"] = 60
  JY.Person[683]["指法技巧"] = 60
  JY.Person[683]["御剑能力"] = 300
  JY.Person[683]["耍刀技巧"] = 60
  JY.Person[683]["特殊兵器"] = 60
  JY.Person[683]["武功1"] = 151  
  JY.Person[683]["武功等级1"] = 999
  if JY.Base["畅想"] ~= 683 then
  for i = 1, 4 do
	 if JY.Person[683]["天"..i] == 0 then
        JY.Person[683]["天"..i] = math.random(2)
	 end
  end
  end
  
  JY.Person[686]["生命"] = 5000
  JY.Person[686]["生命最大值"] = 5000
  JY.Person[686]["内力"] = 6666
  JY.Person[686]["内力最大值"] = 9999
  JY.Person[686]["实战"] = 500
  JY.Person[686]["武学常识"] = 50
  JY.Person[686]["拳掌功夫"] = 333
  JY.Person[686]["指法技巧"] = 200
  JY.Person[686]["御剑能力"] = 100
  JY.Person[686]["耍刀技巧"] = 80
  JY.Person[686]["特殊兵器"] = 60
  JY.Person[686]["武功1"] = 23  
  JY.Person[686]["武功等级1"] = 999
  JY.Person[686]["武功2"] = 25  
  JY.Person[686]["武功等级2"] = 999
  JY.Person[686]["武功3"] = 223  
  JY.Person[686]["武功等级2"] = 999
  if JY.Base["畅想"] ~= 686 then
  for i = 1, 4 do
	 if JY.Person[686]["天"..i] == 0 then
        JY.Person[686]["天"..i] = math.random(2)
	 end
  end
  end
  
  JY.Person[687]["生命"] = 6000
  JY.Person[687]["生命最大值"] = 6000
  JY.Person[687]["内力"] = 8000
  JY.Person[687]["内力最大值"] = 8000
  JY.Person[687]["实战"] = 500
  JY.Person[687]["武学常识"] = 100
  JY.Person[687]["拳掌功夫"] = 120
  JY.Person[687]["指法技巧"] = 300
  JY.Person[687]["御剑能力"] = 200
  JY.Person[687]["耍刀技巧"] = 80
  JY.Person[687]["特殊兵器"] = 80
  if JY.Base["畅想"] ~= 687 then
  for i = 1, 4 do
	 if JY.Person[687]["天"..i] == 0 then
        JY.Person[687]["天"..i] = 1
	 end
  end
  end
  
  JY.Person[688]["生命"] = 5000
  JY.Person[688]["生命最大值"] = 5000
  JY.Person[688]["内力"] = 5000
  JY.Person[688]["内力最大值"] = 5000
  JY.Person[688]["实战"] = 500
  JY.Person[688]["武学常识"] = 33
  JY.Person[688]["拳掌功夫"] = 100
  JY.Person[688]["指法技巧"] = 100
  JY.Person[688]["御剑能力"] = 100
  JY.Person[688]["耍刀技巧"] = 100
  JY.Person[688]["特殊兵器"] = 270
  
  JY.Person[688]["武器"] = 344
  if JY.Base["畅想"] ~= 688 then
  for i = 1, 4 do
	 if JY.Person[688]["天"..i] == 0 then
        JY.Person[688]["天"..i] = math.random(2)
	 end
  end
  end
  
  
  JY.Person[677]["生命"] = 6000
  JY.Person[677]["生命最大值"] = 6000
  JY.Person[677]["内力"] = 8000
  JY.Person[677]["内力最大值"] = 8000
  JY.Person[677]["实战"] = 500
  JY.Person[677]["武学常识"] = 100
  JY.Person[677]["拳掌功夫"] = 100
  JY.Person[677]["指法技巧"] = 100
  JY.Person[677]["御剑能力"] = 100
  JY.Person[677]["耍刀技巧"] = 100
  JY.Person[677]["特殊兵器"] = 100
  
  JY.Person[677]["武功1"] = 215  
  JY.Person[677]["武功等级1"] = 999
  JY.Person[677]["武功2"] = 214
  JY.Person[677]["武功等级2"] = 999
  JY.Person[677]["武功3"] = 48
  JY.Person[677]["武功等级3"] = 999
  JY.Person[677]["武功4"] = 26
  JY.Person[677]["武功等级4"] = 999
  JY.Person[677]["武功5"] = 102
  JY.Person[677]["武功等级5"] = 999
  JY.Person[677]["武功6"] = 106
  JY.Person[677]["武功等级6"] = 999
  
  --陆小凤
  JY.Person[678]["生命"] = 5000
  JY.Person[678]["生命最大值"] = 5000
  JY.Person[678]["内力"] = 7000
  JY.Person[678]["内力最大值"] = 7000
  JY.Person[678]["实战"] = 500
  JY.Person[678]["武学常识"] = 120
  JY.Person[678]["拳掌功夫"] = 100
  JY.Person[678]["指法技巧"] = 200
  JY.Person[678]["御剑能力"] = 70
  JY.Person[678]["耍刀技巧"] = 70
  JY.Person[678]["特殊兵器"] = 70
  
  
  JY.Person[678]["武功1"] = 132 
  JY.Person[678]["武功等级1"] = 999
  JY.Person[678]["武功2"] = 216
  JY.Person[678]["武功等级2"] = 999
  JY.Person[678]["武功3"] = 133
  JY.Person[678]["武功等级3"] = 999
  JY.Person[678]["武功4"] = 136
  JY.Person[678]["武功等级4"] = 999
  JY.Person[678]["武功5"] = 137
  JY.Person[678]["武功等级5"] = 999

  JY.Person[678]["天赋轻功"] = 216

  if JY.Base["畅想"] ~= 678 then
  for i = 1, 4 do
	 if JY.Person[678]["天"..i] == 0 then
        JY.Person[678]["天"..i] = math.random(2)
	 end
  end
  end
  
  for i = 1, 30 do
  JY.Person[642]["人"..i] = JY.Person[0]["人"..i]
  end
  --==================================================================
local m,n = math.modf(JY.Person[124]["天1"]/2.5)+1
if m > 8 then
   m = 8
end
JY.Base["难度"] = m

for e = 1, math.modf(JY.Person[124]["天1"]/1.5)+6 do
    if e < 6 then
    WAR.Data["敌人"..e] = math.random(305) + 190
	if JY.Person[WAR.Data["敌人"..e]]["天赋内功"] == 190 and math.random(100) < 25 then
	   JY.Person[WAR.Data["敌人"..e]]["天赋内功"] = ng1[math.random(17)]
	end
	elseif e >= 6 and e < 14 then
	  if math.random(100) < JY.Person[124]["天1"]*3 + 25 then
	     local foe = math.random(#NAN1)
	     if JY.Base["畅想"] ~= NAN1[foe] then
	        WAR.Data["敌人"..e] = NAN1[foe]
		 elseif foe == #NAN1 or foe == 1 then
		    WAR.Data["敌人"..e] = NAN1[math.random(#NAN1-1)+1]
		 end
	  else
	     WAR.Data["敌人"..e] = math.random(305) + 190
	  end
	  ----------------nGqG
	  if JY.Person[WAR.Data["敌人"..e]] ~= nil then
	  if JY.Person[WAR.Data["敌人"..e]]["天赋内功"] == 190 then
	   if math.random(100) < 15 then
	   JY.Person[WAR.Data["敌人"..e]]["天赋内功"] = ng2[math.random(20)]
	   elseif math.random(100) < 35 then
	   JY.Person[WAR.Data["敌人"..e]]["天赋内功"] = ng1[math.random(17)]
	   end
	end
	if JY.Person[WAR.Data["敌人"..e]]["天赋轻功"] == 191 and math.random(100) < 20 then
	   JY.Person[WAR.Data["敌人"..e]]["天赋轻功"] = qg[math.random(10)]
	end
	  end
	  
	elseif e >= 14 and e < 19 then
	
	  local foe = math.random(#NAN2)
	     if JY.Base["畅想"] ~= NAN2[foe] then
	        WAR.Data["敌人"..e] = NAN2[foe]
		 elseif foe == #NAN2 or foe == 1 then
		    WAR.Data["敌人"..e] = NAN2[math.random(#NAN2-1)+1]
		 end
		 --------------nGqG
		 if JY.Person[WAR.Data["敌人"..e]] ~= nil then
	if JY.Person[WAR.Data["敌人"..e]]["天赋内功"] == 190 then
	   if math.random(100) < 50 then
	      JY.Person[WAR.Data["敌人"..e]]["天赋内功"] = ng2[math.random(20)]
	   else
	      JY.Person[WAR.Data["敌人"..e]]["天赋内功"] = ng1[math.random(17)]
	   end   
	end
	     end
	if JY.Person[WAR.Data["敌人"..e]]["天赋轻功"] == 191 and math.random(100) < 50 then
	   JY.Person[WAR.Data["敌人"..e]]["天赋轻功"] = qg[math.random(10)]
	end
	elseif e >= 19 and e <= 20 then
	  local foe = math.random(#NAN3)
	     if JY.Base["畅想"] ~= NAN3[foe] then
	        WAR.Data["敌人"..e] = NAN3[foe]
		 elseif foe == #NAN3 or foe == 1 then
		    WAR.Data["敌人"..e] = NAN3[math.random(#NAN3-1)+1]
		 end
	end
end

for d = 1, 12 do
    if JY.Person[124]["天1"] > 4 and WAR.Data["敌人"..d] < 0 then
	   WAR.Data["敌人"..d] = math.random(305) + 190
	end      
end
local a,b = math.modf(JY.Person[124]["天1"]/6)
if a > 0 and b == 0 or JY.Person[124]["天1"] == 30 then
	WAR.Data["敌人20"] = 642
end
if a <= 2 then
   for i = 1, 4 do 
     JY.Person[642]["武功"..i] = JY.Person[0]["武功"..i]
	 JY.Person[642]["武功等级"..i] = 999
	 JY.Person[642]["地"..i] = math.random(7)
   end	 
elseif a > 2 and a <= 4 then
   for i = 1, 8 do 
     JY.Person[642]["武功"..i] = JY.Person[0]["武功"..i]
	 JY.Person[642]["武功等级"..i] = 999
	 JY.Person[642]["地"..i] = math.random(7)
   end
end   
if JY.Person[124]["天1"] == 30 then
   for i = 1, JY.Person[671]["品德"] do
     JY.Person[642]["武功"..i] = JY.Person[0]["武功"..i]
	 JY.Person[642]["武功等级"..i] = 999
   end
   if JY.Person[0]["主运轻功"] > 0 then
   JY.Person[642]["天赋轻功"] = JY.Person[0]["主运轻功"]
   end
   if JY.Person[0]["主运内功"] > 0 then
   JY.Person[642]["天赋内功"] = JY.Person[0]["主运内功"]
   end
   for j = 1, 10 do
     local tf = JY.Person[0]["地"..j]
	 if tf > 6 then
	 tf = math.random(7)
	 end
	 JY.Person[642]["地"..j] = tf
   end
   local str = {"拳掌功夫","指法技巧","御剑能力","耍刀技巧","特殊兵器","攻击力","防御力","轻功","暗器技巧","武学常识","攻击带毒","医疗能力","用毒能力","解毒能力","抗毒能力","洗髓","左右互搏","出战"}
		for a = 1, #str do
		JY.Person[642][str[a]] = JY.Person[0][str[a]]
		end	
end	
	
for i = 1, 20 do

if WAR.Data["敌人"..i] > 0 then

  if i < 6 then
  JY.Person[WAR.Data["敌人"..i]]["生命最大值"] = math.max(JY.Base["难度"] * 160 + 600,JY.Person[WAR.Data["敌人"..i]]["生命最大值"])
  JY.Person[WAR.Data["敌人"..i]]["内力最大值"] = math.max(JY.Base["难度"] * 160 + 600,JY.Person[WAR.Data["敌人"..i]]["内力最大值"])
  
  JY.Person[WAR.Data["敌人"..i]]["防御力"] = math.max(JY.Base["难度"] * 12 + 30,JY.Person[WAR.Data["敌人"..i]]["防御力"])
 
  JY.Person[WAR.Data["敌人"..i]]["攻击力"] = math.max(JY.Base["难度"] * 12 + 30,JY.Person[WAR.Data["敌人"..i]]["攻击力"])

  JY.Person[WAR.Data["敌人"..i]]["轻功"] = math.max(JY.Base["难度"] * 12 + 30,JY.Person[WAR.Data["敌人"..i]]["轻功"])
  if JY.Person[WAR.Data["敌人"..i]]["生命最大值"] > JY.Base["难度"] * 2000 then
     JY.Person[WAR.Data["敌人"..i]]["生命最大值"] = JY.Base["难度"] * 2000
  end
  
  elseif i >= 6 and i < 14 then
  JY.Person[WAR.Data["敌人"..i]]["生命最大值"] = math.max(JY.Base["难度"] * 160 + 1600,JY.Person[WAR.Data["敌人"..i]]["生命最大值"])
  JY.Person[WAR.Data["敌人"..i]]["内力最大值"] = math.max(JY.Base["难度"] * 160 + 1600,JY.Person[WAR.Data["敌人"..i]]["内力最大值"])
  
  JY.Person[WAR.Data["敌人"..i]]["防御力"] = math.max(JY.Base["难度"] * 13 + 50,JY.Person[WAR.Data["敌人"..i]]["防御力"])
 
  JY.Person[WAR.Data["敌人"..i]]["攻击力"] = math.max(JY.Base["难度"] * 13 + 50,JY.Person[WAR.Data["敌人"..i]]["攻击力"])

  JY.Person[WAR.Data["敌人"..i]]["轻功"] = math.max(JY.Base["难度"] * 13 + 50,JY.Person[WAR.Data["敌人"..i]]["轻功"])
  
  elseif i >= 14 and i < 19 then
  JY.Person[WAR.Data["敌人"..i]]["生命最大值"] = math.max(JY.Base["难度"] * 330 + 2600,JY.Person[WAR.Data["敌人"..i]]["生命最大值"])
  JY.Person[WAR.Data["敌人"..i]]["内力最大值"] = math.max(JY.Base["难度"] * 330 + 1600,JY.Person[WAR.Data["敌人"..i]]["内力最大值"])
  
  JY.Person[WAR.Data["敌人"..i]]["防御力"] = math.max(JY.Base["难度"] * 15 + 90,JY.Person[WAR.Data["敌人"..i]]["防御力"])
 
  JY.Person[WAR.Data["敌人"..i]]["攻击力"] = math.max(JY.Base["难度"] * 15 + 90,JY.Person[WAR.Data["敌人"..i]]["攻击力"])

  JY.Person[WAR.Data["敌人"..i]]["轻功"] = math.max(JY.Base["难度"] * 15 + 90,JY.Person[WAR.Data["敌人"..i]]["轻功"])
  
  elseif i >= 19 then
  JY.Person[WAR.Data["敌人"..i]]["生命最大值"] = math.max(JY.Base["难度"] * 380 + 5200,JY.Person[WAR.Data["敌人"..i]]["生命最大值"])
  JY.Person[WAR.Data["敌人"..i]]["内力最大值"] = math.max(JY.Base["难度"] * 380 + 4600,JY.Person[WAR.Data["敌人"..i]]["内力最大值"])
  
  JY.Person[WAR.Data["敌人"..i]]["防御力"] = math.max(JY.Base["难度"] * 20 + 120,JY.Person[WAR.Data["敌人"..i]]["防御力"])
 
  JY.Person[WAR.Data["敌人"..i]]["攻击力"] = math.max(JY.Base["难度"] * 20 + 120,JY.Person[WAR.Data["敌人"..i]]["攻击力"])

  JY.Person[WAR.Data["敌人"..i]]["轻功"] = math.max(JY.Base["难度"] * 20 + 120,JY.Person[WAR.Data["敌人"..i]]["轻功"])
  end
  if WAR.Data["敌人"..i] ~= 642 then
     JY.Person[WAR.Data["敌人"..i]]["姓名"] = "潮汐人"
  end
  if math.random(100) < 12 + JY.Person[124]["天1"]*0.5 then
     JY.Person[WAR.Data["敌人"..i]]["姓名"] = "★"..JY.Person[WAR.Data["敌人"..i]]["姓名"]
    JY.Person[WAR.Data["敌人"..i]]["生命最大值"] = math.max(JY.Person[WAR.Data["敌人"..i]]["生命最大值"]*1.5, JY.Person[WAR.Data["敌人"..i]]["生命最大值"]+JY.Person[124]["天1"]*110)
    JY.Person[WAR.Data["敌人"..i]]["内力最大值"] = math.max(JY.Person[WAR.Data["敌人"..i]]["内力最大值"]*1.5, JY.Person[124]["天1"]*70)
  end
  
  
  JY.Person[WAR.Data["敌人"..i]]["生命"] = JY.Person[WAR.Data["敌人"..i]]["生命最大值"]
  JY.Person[WAR.Data["敌人"..i]]["内力"] = JY.Person[WAR.Data["敌人"..i]]["内力最大值"]
  JY.Person[642]["生命最大值"] = math.max(650*JY.Person[124]["天1"], 6000)
  JY.Person[642]["内力最大值"] = math.max(450*JY.Person[124]["天1"], 6000)
  
  
end
end
end

PNLBD[329] = function()
for i = 1, 20 do
    if JY.Person[220+i]["声望"] > 0 then
        WAR.Data["敌人"..i] = JY.Person[220+i]["声望"]
	end
end
for i = 1, 20 do
    if JY.Person[250+i]["声望"] > 0 then
	   WAR.Data["自动选择参战人1"] = JY.Person[250+i]["声望"]
	end
end

end
--飞邪胡斐
PNLBD[0] = function()
  JY.Person[1]["生命"] = 3200
  JY.Person[1]["生命最大值"] = 3200
  JY.Person[1]["内力"] = 4000
  JY.Person[1]["内力最大值"] = 4000
  JY.Person[1]["攻击力"] = 130
  JY.Person[1]["防御力"] = 130
  JY.Person[1]["轻功"] = 160
  JY.Person[1]["受伤程度"] = 0
  JY.Person[1]["中毒程度"] = 0
  JY.Person[1]["武功1"] = 67
  JY.Person[1]["武功等级1"] = 999
  JY.Person[3]["天赋轻功"] = 145
end

--飞正阎基
PNLBD[1] = function()
  JY.Person[4]["生命"] = 2100
  JY.Person[4]["生命最大值"] = 2100
  JY.Person[4]["内力"] = 1200
  JY.Person[4]["内力最大值"] = 1200
  JY.Person[4]["武功等级1"] = 700
end

--飞正田归农
PNLBD[3] = function()
  JY.Person[72]["生命"] = 2400
  JY.Person[72]["生命最大值"] = 2400
  JY.Person[72]["内力"] = 2000
  JY.Person[72]["内力最大值"] = 2000
  JY.Person[72]["攻击力"] = 100
  JY.Person[72]["防御力"] = 130
  JY.Person[72]["轻功"] = 70
  JY.Person[72]["武功1"] = 37
  JY.Person[72]["武功等级1"] = 999
end

--飞正苗人凤
PNLBD[4] = function()
  JY.Person[3]["天赋轻功"] = 145
  JY.Person[3]["实战"] = 0
end

--杀林平之
PNLBD[34] = function()
  JY.Person[36]["生命"] = 2600
  JY.Person[36]["生命最大值"] = 2600
  JY.Person[36]["内力"] = 3000
  JY.Person[36]["内力最大值"] = 3000
  JY.Person[36]["攻击力"] = 180
  JY.Person[36]["防御力"] = 130
  JY.Person[36]["轻功"] = 220
  JY.Person[36]["受伤程度"] = 0
  JY.Person[36]["中毒程度"] = 0
end

--神邪战杨龙
PNLBD[75] = function()
  JY.Person[58]["生命"] = 3200
  JY.Person[58]["生命最大值"] = 3200
  JY.Person[58]["内力"] = 4000
  JY.Person[58]["内力最大值"] = 4000
  JY.Person[58]["攻击力"] = 210
  JY.Person[58]["防御力"] = 180
  JY.Person[58]["轻功"] = 160
  JY.Person[58]["受伤程度"] = 0
  JY.Person[58]["中毒程度"] = 100
  JY.Person[58]["武功1"] = 45		--玄铁
  JY.Person[58]["武功2"] = 104		--逆运
  JY.Person[58]["武功3"] = 107		--九阴
  JY.Person[58]["武功4"] = 172		--潮汐
  JY.Person[58]["天赋内功"] = 107		--九阴
  JY.Person[58]["武功等级1"] = 999
  JY.Person[58]["武功等级2"] = 999
  JY.Person[58]["武功等级3"] = 999
  JY.Person[58]["武功等级4"] = 999		
  JY.Person[59]["生命"] = 2800
  JY.Person[59]["生命最大值"] = 2800
  JY.Person[59]["内力"] = 3500
  JY.Person[59]["内力最大值"] = 3500
  JY.Person[59]["攻击力"] = 170
  JY.Person[59]["防御力"] = 150
  JY.Person[59]["轻功"] = 200
  JY.Person[59]["受伤程度"] = 0
  JY.Person[59]["中毒程度"] = 100
  JY.Person[59]["冰封程度"] = 100
  JY.Person[59]["武功3"] = 107		--九阴
  JY.Person[59]["武功等级3"] = 400
end

--招亲郭靖
PNLBD[76] = function()
	JY.Person[55]["生命"] = 2400
	JY.Person[55]["生命最大值"] = 2400
	JY.Person[55]["武功1"] = 26
	JY.Person[55]["武功等级1"] = 600
    JY.Person[55]["武功2"] = 15
	JY.Person[55]["武功等级2"] = 500
    JY.Person[55]["武功3"] = 107
	JY.Person[55]["武功等级3"] = 50
end

--四大恶人岳老三
PNLBD[191] = function()
	JY.Person[44]["生命"] = 2000
	JY.Person[44]["生命最大值"] = 2000
end

--程英局李莫愁
PNLBD[52] = function()
	JY.Person[161]["生命"] = 2100
	JY.Person[161]["生命最大值"] = 2100
	JY.Person[161]["冰封程度"] = 100
	JY.Person[161]["中毒程度"] = 100
end

--书邪陈家洛
PNLBD[138] = function()
  JY.Person[75]["生命"] = 2800
  JY.Person[75]["生命最大值"] = 2800
  JY.Person[75]["内力"] = 3000
  JY.Person[75]["内力最大值"] = 3000
  JY.Person[75]["攻击力"] = 140
  JY.Person[75]["防御力"] = 120
  JY.Person[75]["轻功"] = 130
  JY.Person[75]["受伤程度"] = 0
  JY.Person[75]["中毒程度"] = 0
  JY.Person[75]["武功等级1"] = 999
end

--碧邪
PNLBD[165] = function()
	--袁承志
	JY.Person[54]["生命"] = 3000
	JY.Person[54]["生命最大值"] = 3000
	JY.Person[54]["内力"] = 4000
	JY.Person[54]["内力最大值"] = 4000
	JY.Person[54]["攻击力"] = 140
	JY.Person[54]["防御力"] = 140
	JY.Person[54]["轻功"] = 90
	JY.Person[54]["受伤程度"] = 0
	JY.Person[54]["中毒程度"] = 0
	JY.Person[54]["个人觉醒"] = 1
	JY.Person[54]["携带物品1"] = -1
	JY.Person[54]["携带物品2"] = -1
	JY.Person[54]["携带物品数量1"] = 0
	JY.Person[54]["携带物品数量2"] = 0
	--温青青
	JY.Person[91]["生命"] = 2400
	JY.Person[91]["生命最大值"] = 2400
	JY.Person[91]["内力"] = 2500
	JY.Person[91]["内力最大值"] = 2500
	JY.Person[91]["攻击力"] = 110
	JY.Person[91]["防御力"] = 110
	JY.Person[91]["轻功"] = 70
	JY.Person[91]["受伤程度"] = 0
	JY.Person[91]["中毒程度"] = 0
	JY.Person[91]["武功1"] = 40
	JY.Person[91]["武功等级1"] = 999
	JY.Person[91]["武功2"] = 90
	JY.Person[91]["武功等级2"] = 999
	JY.Person[91]["天赋内功"] = 90
	JY.Person[91]["天赋轻功"] = 146
	for i = 3 , JY.Person[671]["品德"] do
		JY.Person[91]["武功"..i] = 0
		JY.Person[91]["武功等级"..i] = 0
	end
end

--侠邪石破天
PNLBD[170] = function()
  JY.Person[38]["生命"] = 4000
  JY.Person[38]["生命最大值"] = 4000
  JY.Person[38]["内力"] = 9999
  JY.Person[38]["内力最大值"] = 9999
  JY.Person[38]["攻击力"] = 180
  JY.Person[38]["防御力"] = 180
  JY.Person[38]["轻功"] = 180
  JY.Person[38]["受伤程度"] = 0
  JY.Person[38]["中毒程度"] = 0
  JY.Person[38]["武功等级1"] = 999
  JY.Person[38]["武功2"] = 102
  JY.Person[38]["武功等级2"] = 999
  JY.Person[38]["天赋内功"] = 102
  JY.Person[38]["天赋外功1"] = 102
  JY.Person[38]["实战"] = 500
end

--客栈欧阳克
PNLBD[69] = function()
  JY.Person[61]["生命"] = 1000
  JY.Person[61]["生命最大值"] = 1000
  JY.Person[61]["轻功"] = 40
  JY.Person[61]["攻击力"] = 55

end

--？？？
PNLBD[313] = function()
if JY.Person[674]["品德"] == 3 then
  JY.Person[674]["生命"] = 5200
  JY.Person[674]["生命最大值"] = 5200
  JY.Person[674]["内力"] = 6000
  JY.Person[674]["内力最大值"] = 6000
  JY.Person[674]["武功1"] = 57
  JY.Person[674]["武功等级1"] = 999
  JY.Person[674]["攻击力"] = 330
  JY.Person[674]["防御力"] = 300
  JY.Person[674]["轻功"] = 430
  JY.Person[674]["实战"] = 500
end
end
--四大山
PNLBD[315] = function()
  JY.Person[642]["生命"] = 14444
  JY.Person[642]["生命最大值"] = 14444
  JY.Person[642]["内力"] = 14444
  JY.Person[642]["内力最大值"] = 14444
  JY.Person[642]["攻击力"] = 444
  JY.Person[642]["防御力"] = 444
  JY.Person[642]["轻功"] = 444
  JY.Person[642]["实战"] = 444
  --远古神蛤
	JY.Person[190]["姓名"] = "远古神蛤"
	JY.Person[190]["生命"] = 8000
	JY.Person[190]["生命最大值"] = 8000
	JY.Person[190]["内力"] = 9999
	JY.Person[190]["内力最大值"] = 9999
	JY.Person[190]["内力性质"] = 0
	JY.Person[190]["攻击力"] = 300
	JY.Person[190]["防御力"] = 300
	JY.Person[190]["轻功"] = 250
	JY.Person[190]["武功1"] = 22
	JY.Person[190]["武功等级1"] = 999
	JY.Person[190]["武功2"] = 108
	JY.Person[190]["武功等级2"] = 999
	JY.Person[190]["武功3"] = 145
	JY.Person[190]["武功等级3"] = 999
	JY.Person[190]["武功4"] = 96
	JY.Person[190]["武功等级4"] = 999
	JY.Person[190]["武功5"] = 144
	JY.Person[190]["武功等级5"] = 999
	JY.Person[190]["天赋外功1"] = 22
	JY.Person[190]["天赋内功"] = 108
	JY.Person[190]["天赋轻功"] = 145
	JY.Person[190]["实战"] = 500
	--亿年雪人
	JY.Person[429]["姓名"] = "亿年雪人"
	JY.Person[429]["生命"] = 8000
	JY.Person[429]["生命最大值"] = 8000
	JY.Person[429]["内力"] = 9999
	JY.Person[429]["内力最大值"] = 9999
	JY.Person[429]["内力性质"] = -3
	JY.Person[429]["攻击力"] = 400
	JY.Person[429]["防御力"] = 250
	JY.Person[429]["轻功"] = 200
	JY.Person[429]["武功1"] = 156
	JY.Person[429]["武功等级1"] = 999
	JY.Person[429]["武功2"] = 107
	JY.Person[429]["武功等级2"] = 999
	JY.Person[429]["武功3"] = 148
	JY.Person[429]["武功等级3"] = 999
	JY.Person[429]["武功4"] = 104
	JY.Person[429]["武功等级4"] = 999
	JY.Person[429]["武功5"] = 92
	JY.Person[429]["武功等级5"] = 999
	JY.Person[429]["天赋外功1"] = 156
	JY.Person[429]["天赋内功"] = 107
	JY.Person[429]["天赋轻功"] = 148
	JY.Person[429]["实战"] = 500
	--蜘蛛尊者
	JY.Person[439]["姓名"] = "蜘蛛尊者"
	JY.Person[439]["生命"] = 8000
	JY.Person[439]["生命最大值"] = 8000
	JY.Person[439]["内力"] = 9999
	JY.Person[439]["内力最大值"] = 9999
	JY.Person[439]["内力性质"] = 3
	JY.Person[439]["攻击力"] = 250
	JY.Person[439]["防御力"] = 400
	JY.Person[439]["轻功"] = 200
	JY.Person[439]["武功1"] = 66
	JY.Person[439]["武功等级1"] = 999
	JY.Person[439]["武功2"] = 106
	JY.Person[439]["武功等级2"] = 999
	JY.Person[439]["武功3"] = 147
	JY.Person[439]["武功等级3"] = 999
	JY.Person[439]["武功4"] = 169
	JY.Person[439]["武功等级4"] = 999
	JY.Person[439]["武功5"] = 103
	JY.Person[439]["武功等级5"] = 999
	JY.Person[439]["天赋外功1"] = 66
	JY.Person[439]["天赋内功"] = 106
	JY.Person[439]["天赋轻功"] = 147
	JY.Person[439]["实战"] = 500
	--至尊卫士
	JY.Person[659]["姓名"] = "LLM32"
	JY.Person[660]["姓名"] = "冒救药"
	JY.Person[661]["姓名"] = "wangbababin"
	JY.Person[662]["姓名"] = "f3960"
	JY.Person[663]["姓名"] = "至尊元老"
	JY.Person[664]["姓名"] = "四粉"
	JY.Person[663]["生命最大值"] = 1000
	JY.Person[664]["生命最大值"] = 1000
	JY.Person[663]["生命"] = 1000
	JY.Person[664]["生命"] = 1000
end
--四大山
PNLBD[324] = function()

	--蜘蛛尊者
	JY.Person[439]["姓名"] = "至尊蜘蛛"
	JY.Person[439]["生命"] = 9999
	JY.Person[439]["生命最大值"] = 9999
	JY.Person[439]["内力"] = 9999
	JY.Person[439]["内力最大值"] = 9999
	JY.Person[439]["内力性质"] = -5
	JY.Person[439]["攻击力"] = 350
	JY.Person[439]["防御力"] = 220
	JY.Person[439]["轻功"] = 400
	JY.Person[439]["武功1"] = 66
	JY.Person[439]["武功等级1"] = 999
	JY.Person[439]["武功2"] = 106
	JY.Person[439]["武功等级2"] = 999
	JY.Person[439]["武功3"] = 147
	JY.Person[439]["武功等级3"] = 999
	JY.Person[439]["武功4"] = 169
	JY.Person[439]["武功等级4"] = 999
	JY.Person[439]["武功5"] = 103
	JY.Person[439]["武功等级5"] = 999
	JY.Person[439]["天赋外功1"] = 66
	JY.Person[439]["天赋内功"] = 106
	JY.Person[439]["天赋轻功"] = 147
	JY.Person[439]["资质"] = 100
	JY.Person[439]["出战"] = 1
	JY.Person[439]["实战"] = 500
end

--四大山
PNLBD[325] = function()
  --远古神蛤
	JY.Person[190]["姓名"] = "至尊神蛤"
	JY.Person[190]["生命"] = 9999
	JY.Person[190]["生命最大值"] = 9999
	JY.Person[190]["内力"] = 9999
	JY.Person[190]["内力最大值"] = 9999
	JY.Person[190]["内力性质"] = 5
	JY.Person[190]["攻击力"] = 380
	JY.Person[190]["防御力"] = 330
	JY.Person[190]["轻功"] = 350
	JY.Person[190]["武功1"] = 1
	JY.Person[190]["武功等级1"] = 999
	JY.Person[190]["武功2"] = 24
	JY.Person[190]["武功等级2"] = 999
	JY.Person[190]["武功3"] = 22
	JY.Person[190]["武功等级3"] = 999
	JY.Person[190]["武功4"] = 96
	JY.Person[190]["武功等级4"] = 999
	JY.Person[190]["武功5"] = 108
	JY.Person[190]["武功等级5"] = 999
	JY.Person[190]["天赋外功1"] = 24
	JY.Person[190]["天赋内功"] = 108
	JY.Person[190]["天赋轻功"] = 145
	JY.Person[190]["资质"] = 1
	JY.Person[190]["左右互搏"] = 1
	JY.Person[190]["实战"] = 500
end
--四大山
PNLBD[326] = function()
	--亿年雪人
	JY.Person[429]["姓名"] = "至尊雪怪"
	JY.Person[429]["生命"] = 13000
	JY.Person[429]["生命最大值"] = 13000
	JY.Person[429]["内力"] = 9000
	JY.Person[429]["内力最大值"] = 9000
	JY.Person[429]["内力性质"] = 0
	JY.Person[429]["攻击力"] = 400
	JY.Person[429]["防御力"] = 450
	JY.Person[429]["轻功"] = 340
	JY.Person[429]["资质"] = 50
	JY.Person[429]["武功1"] = 16
	JY.Person[429]["武功等级1"] = 999
	JY.Person[429]["武功2"] = 46
	JY.Person[429]["武功等级2"] = 999
	JY.Person[429]["武功3"] = 97
	JY.Person[429]["武功等级3"] = 999
	JY.Person[429]["武功4"] = 102
	JY.Person[429]["武功等级4"] = 999
	JY.Person[429]["武功5"] = 94
	JY.Person[429]["武功等级5"] = 999
	JY.Person[429]["天赋外功1"] = 16
	JY.Person[429]["天赋外功2"] = 46
	JY.Person[429]["天赋内功"] = 97
	JY.Person[429]["天赋轻功"] = 148
	JY.Person[429]["出战"] = 1
	JY.Person[429]["左右互搏"] = 1
	JY.Person[429]["实战"] = 500
end

--潮汐三叠浪
PNLBD[327] = function()
if JY.Base["难度"] == 8 then
for i = 2, 6 do
WAR.Data["敌人"..i] = NAN3[math.random(#NAN3)]
  while WAR.Data["敌人"..i] == WAR.Data["敌人"..(i-1)] do
        WAR.Data["敌人"..i] = NAN3[math.random(#NAN3)]
  end
end
end
--kael
  JY.Person[689]["生命"] = 3000
  JY.Person[689]["生命最大值"] = 3000
  JY.Person[689]["内力"] = 7000
  JY.Person[689]["内力最大值"] = 7000
  JY.Person[689]["攻击力"] = 200
  JY.Person[689]["防御力"] = 200
  JY.Person[689]["轻功"] = 200
  JY.Person[689]["实战"] = 500
  JY.Person[689]["拳掌功夫"] = 101
  JY.Person[689]["指法技巧"] = 101
  JY.Person[689]["御剑能力"] = 101
  JY.Person[689]["耍刀技巧"] = 101
  JY.Person[689]["特殊兵器"] = 101
  JY.Person[689]["资质"] = 50
  JY.Person[689]["左右互搏"] = 1
  JY.Person[689]["出战"] = 1
  for i = 1, 10 do
  JY.Person[689]["武功"..i] = 225+i  
  JY.Person[689]["武功等级"..i] = 999
  end
  JY.Person[689]["武功2"] = 228
  JY.Person[689]["武功5"] = 238
  JY.Person[689]["武功8"] = 235
  if JY.Base["畅想"] ~= 689 then
  JY.Person[689]["天1"] = 7
  JY.Person[689]["天2"] = 7
  JY.Person[689]["天3"] = 7
  JY.Person[689]["声望"] = 2
  for i = 1, 4 do
  JY.Person[690]["天"..i] = math.random(2)
  end
  JY.Person[690]["品德"] = math.random(2)
  end
  
  --sucan
  JY.Person[692]["生命"] = 6000
  JY.Person[692]["生命最大值"] = 6000
  JY.Person[692]["内力"] = 6699
  JY.Person[692]["内力最大值"] = 6699
  JY.Person[692]["攻击力"] = 300
  JY.Person[692]["防御力"] = 300
  JY.Person[692]["轻功"] = 300
  JY.Person[692]["实战"] = 500
  JY.Person[692]["武学常识"] = 50
  JY.Person[692]["拳掌功夫"] = 270
  JY.Person[692]["指法技巧"] = 120
  JY.Person[692]["御剑能力"] = 90
  JY.Person[692]["耍刀技巧"] = 100
  JY.Person[692]["特殊兵器"] = 90
  JY.Person[692]["武功1"] = 26
  JY.Person[692]["武功2"] = 80
  JY.Person[692]["武功3"] = 240
  JY.Person[692]["洗髓"] = 100
  for i = 1, 3 do
  JY.Person[692]["武功等级"..i] = 999
  end
  if JY.Base["畅想"] ~= 692 then
     JY.Person[692]["天3"] = math.random(2) 
	 JY.Person[692]["天4"] = 1
  end
--dp
  JY.Person[691]["生命"] = 6000
  JY.Person[691]["生命最大值"] = 6000
  JY.Person[691]["内力"] = 6699
  JY.Person[691]["内力最大值"] = 6699
  JY.Person[691]["攻击力"] = 300
  JY.Person[691]["防御力"] = 300
  JY.Person[691]["轻功"] = 300
  JY.Person[691]["实战"] = 500
  JY.Person[691]["武学常识"] = 100
  JY.Person[691]["拳掌功夫"] = 80
  JY.Person[691]["指法技巧"] = 80
  JY.Person[691]["御剑能力"] = 140
  JY.Person[691]["耍刀技巧"] = 250
  JY.Person[691]["特殊兵器"] = 60
  JY.Person[691]["武器"] = 319
  JY.Person[691]["武功1"] = 189
  JY.Person[691]["武功2"] = 55
  JY.Person[691]["武功3"] = 237
  if JY.Base["畅想"] ~= 691 then
     for i = 1, 4 do
	     if JY.Person[691]["天"..i] == 0 then
            JY.Person[691]["天"..i] = math.random(2)
         end
	 end	 
  end
--nf
  JY.Person[681]["生命"] = 6000
  JY.Person[681]["生命最大值"] = 6000
  JY.Person[681]["内力"] = 9999
  JY.Person[681]["内力最大值"] = 9999
  JY.Person[681]["攻击力"] = 380
  JY.Person[681]["防御力"] = 320
  JY.Person[681]["轻功"] = 520
  JY.Person[681]["实战"] = 500
  JY.Person[681]["武学常识"] = 100
  JY.Person[681]["拳掌功夫"] = 100
  JY.Person[681]["指法技巧"] = 100
  JY.Person[681]["御剑能力"] = 100
  JY.Person[681]["耍刀技巧"] = 320
  JY.Person[681]["特殊兵器"] = 100
  JY.Person[681]["品德"] = 6
  JY.Person[681]["武器"] = 360
  WAR.MXD[681] = 30
  if JY.Base["畅想"] ~= 681 then
     for i = 1, 4 do
	     if JY.Person[681]["天"..i] == 0 then
            JY.Person[681]["天"..i] = math.random(2)
         end
	 end	 
  end
  
  JY.Person[682]["生命"] = 6000
  JY.Person[682]["生命最大值"] = 6000
  JY.Person[682]["内力"] = 9999
  JY.Person[682]["内力最大值"] = 9999
  JY.Person[682]["攻击力"] = 480
  JY.Person[682]["防御力"] = 320
  JY.Person[682]["轻功"] = 320
  JY.Person[682]["实战"] = 500
  JY.Person[682]["武学常识"] = 100
  JY.Person[682]["拳掌功夫"] = 300
  JY.Person[682]["指法技巧"] = 80
  JY.Person[682]["御剑能力"] = 300
  JY.Person[682]["耍刀技巧"] = 70
  JY.Person[682]["特殊兵器"] = 70
  JY.Person[682]["武功1"] = 221  
  JY.Person[682]["武功等级1"] = 999
  JY.Person[682]["武功2"] = 222
  JY.Person[682]["武功等级2"] = 999
  JY.Person[682]["武器"] = 362
  if JY.Base["畅想"] ~= 682 then
     for i = 3, 4 do
	     if JY.Person[682]["天"..i] == 0 then
  JY.Person[682]["天"..i] = math.random(2)
         end
	 end	 
  end

--雷震
  JY.Person[670]["生命"] = 6300
  JY.Person[670]["生命最大值"] = 6300
  JY.Person[670]["内力"] = 9999
  JY.Person[670]["内力最大值"] = 9999
  JY.Person[670]["攻击力"] = 350
  JY.Person[670]["防御力"] = 250
  JY.Person[670]["轻功"] = 350
  JY.Person[670]["实战"] = 500
  JY.Person[670]["医疗能力"] = 500

  JY.Person[670]["拳掌功夫"] = 320
  JY.Person[670]["指法技巧"] = 320
  JY.Person[670]["御剑能力"] = 320
  JY.Person[670]["耍刀技巧"] = 320
  JY.Person[670]["特殊兵器"] = 320
  JY.Person[670]["防具"] = 327
  JY.Person[670]["武器"] = 345
  
  JY.Person[670]["武功1"] = 197  
  JY.Person[670]["武功等级1"] = 999
  JY.Person[670]["武功2"] = 108
  JY.Person[670]["武功等级2"] = 999
  JY.Person[670]["武功3"] = 49
  JY.Person[670]["武功等级3"] = 999
  JY.Person[670]["武功4"] = 66
  JY.Person[670]["武功等级4"] = 999
  JY.Person[670]["武功5"] = 26
  JY.Person[670]["武功等级5"] = 999
  JY.Person[670]["武功6"] = 80
  JY.Person[670]["武功等级6"] = 999
  JY.Person[670]["武功7"] = 147
  JY.Person[670]["武功等级7"] = 999
  JY.Person[670]["天赋内功"] = 108
  JY.Person[670]["天赋轻功"] = 147
  JY.Person[670]["出战"]=1
  
  
  --无名
  JY.Person[671]["生命"] = 4500
  JY.Person[671]["生命最大值"] = 4500
  JY.Person[671]["内力"] = 9999
  JY.Person[671]["内力最大值"] = 9999
  JY.Person[671]["攻击力"] = 350
  JY.Person[671]["防御力"] = 200
  JY.Person[671]["轻功"] = 350
  JY.Person[671]["实战"] = 500
  JY.Person[671]["医疗能力"] = 500
  JY.Person[671]["武器"] = 353

  JY.Person[671]["拳掌功夫"] = 200
  JY.Person[671]["指法技巧"] = 200
  JY.Person[671]["御剑能力"] = 999
  JY.Person[671]["耍刀技巧"] = 200
  JY.Person[671]["特殊兵器"] = 200
  
  JY.Person[671]["武功2"] = 167
  JY.Person[671]["武功等级2"] = 999
  JY.Person[671]["武功3"] = 168
  JY.Person[671]["武功等级3"] = 999
  JY.Person[671]["武功4"] = 46
  JY.Person[671]["武功等级4"] = 999
  JY.Person[671]["武功5"] = 45
  JY.Person[671]["武功等级5"] = 999
  JY.Person[671]["武功6"] = 198
  JY.Person[671]["武功等级6"] = 999
 
  
  --华英雄
  JY.Person[675]["生命"] = 6000
  JY.Person[675]["生命最大值"] = 6000
  JY.Person[675]["内力"] = 6000
  JY.Person[675]["内力最大值"] = 6000
  JY.Person[675]["攻击力"] = 300
  JY.Person[675]["防御力"] = 200
  JY.Person[675]["轻功"] = 200
  JY.Person[675]["实战"] = 500
  JY.Person[675]["御剑能力"] = 210
  JY.Person[675]["拳掌功夫"] = 180
  if JY.Base["畅想"] ~= 675 then
     JY.Person[675]["声望"] = 600
	 JY.Person[675]["品德"] = 6
  end	 
  
  --?
  JY.Person[654]["生命"] = 6500
  JY.Person[654]["生命最大值"] = 6500
  JY.Person[654]["实战"] = 500
  
  
  --豪鬼
  JY.Person[673]["生命"] = 4800
  JY.Person[673]["生命最大值"] = 4800
  JY.Person[673]["内力"] = 8000
  JY.Person[673]["内力最大值"] = 8000
  JY.Person[673]["攻击力"] = 520
  JY.Person[673]["防御力"] = 300
  JY.Person[673]["轻功"] = 400
  JY.Person[673]["实战"] = 500
  JY.Person[673]["医疗能力"] = 0
  JY.Person[673]["暗器技巧"] = 200
  JY.Person[673]["武功5"] = 210
  JY.Person[673]["武功等级5"] = 999

  JY.Person[673]["拳掌功夫"] = 333
  JY.Person[673]["指法技巧"] = 100
  JY.Person[673]["御剑能力"] = 0
  JY.Person[673]["耍刀技巧"] = 0
  JY.Person[673]["特殊兵器"] = 0
  WAR.SYBD[673] = 100
  if JY.Base["畅想"] ~= 673 then
     if JY.Person[673]["外号2"] == "小子" then
  if math.random(2) == 1 then
     JY.Person[673]["外号2"] = "怒"
  else	 
     JY.Person[673]["外号2"] = "烈"
  end
     end
	 JY.Person[673]["天1"] = math.random(2)
  end
  --武僧
  JY.Person[676]["生命"] = 6000
  JY.Person[676]["生命最大值"] = 6000
  JY.Person[676]["内力"] = 8000
  JY.Person[676]["内力最大值"] = 8000
  JY.Person[676]["实战"] = 500
  JY.Person[676]["武学常识"] = 150
  JY.Person[676]["拳掌功夫"] = 200
  JY.Person[676]["指法技巧"] = 100
  JY.Person[676]["御剑能力"] = 100
  JY.Person[676]["耍刀技巧"] = 100
  JY.Person[676]["特殊兵器"] = 100
  
  JY.Person[676]["防具"] = 355
  JY.Person[676]["武器"] = 354
  
  JY.Person[676]["武功1"] = 1  
  JY.Person[676]["武功等级1"] = 999
  JY.Person[676]["武功2"] = 24
  JY.Person[676]["武功等级2"] = 999
  JY.Person[676]["武功3"] = 22
  JY.Person[676]["武功等级3"] = 999
  JY.Person[676]["武功4"] = 186
  JY.Person[676]["武功等级4"] = 999
  JY.Person[676]["武功5"] = 144
  JY.Person[676]["武功等级5"] = 999
  JY.Person[676]["武功6"] = 96
  JY.Person[676]["武功等级6"] = 999
  JY.Person[676]["武功7"] = 182
  JY.Person[676]["武功等级7"] = 999
  JY.Person[676]["天赋内功"] = 108
  JY.Person[676]["天赋轻功"] = 182

  if JY.Base["畅想"] ~= 676 then
  for i = 1, 4 do
	 if JY.Person[676]["天"..i] == 0 then
        JY.Person[676]["天"..i] = math.random(2)
	 end
  end
  end
  WAR.LSF[676] = 50
  JY.Person[683]["生命"] = 6000
  JY.Person[683]["生命最大值"] = 6000
  JY.Person[683]["内力"] = 8000
  JY.Person[683]["内力最大值"] = 8000
  JY.Person[683]["实战"] = 500
  JY.Person[683]["武学常识"] = 60
  JY.Person[683]["拳掌功夫"] = 60
  JY.Person[683]["指法技巧"] = 60
  JY.Person[683]["御剑能力"] = 300
  JY.Person[683]["耍刀技巧"] = 60
  JY.Person[683]["特殊兵器"] = 60
  JY.Person[683]["武功1"] = 151  
  JY.Person[683]["武功等级1"] = 999
  if JY.Base["畅想"] ~= 683 then
  for i = 1, 4 do
	 if JY.Person[683]["天"..i] == 0 then
        JY.Person[683]["天"..i] = math.random(2)
	 end
  end
  end
  
  JY.Person[686]["生命"] = 5000
  JY.Person[686]["生命最大值"] = 5000
  JY.Person[686]["内力"] = 6666
  JY.Person[686]["内力最大值"] = 9999
  JY.Person[686]["实战"] = 500
  JY.Person[686]["武学常识"] = 50
  JY.Person[686]["拳掌功夫"] = 333
  JY.Person[686]["指法技巧"] = 200
  JY.Person[686]["御剑能力"] = 100
  JY.Person[686]["耍刀技巧"] = 80
  JY.Person[686]["特殊兵器"] = 60
  JY.Person[686]["武功1"] = 23  
  JY.Person[686]["武功等级1"] = 999
  JY.Person[686]["武功2"] = 25  
  JY.Person[686]["武功等级2"] = 999
  JY.Person[686]["武功3"] = 223  
  JY.Person[686]["武功等级2"] = 999
  if JY.Base["畅想"] ~= 686 then
  for i = 1, 4 do
	 if JY.Person[686]["天"..i] == 0 then
        JY.Person[686]["天"..i] = math.random(2)
	 end
  end
  end
  
  JY.Person[687]["生命"] = 6000
  JY.Person[687]["生命最大值"] = 6000
  JY.Person[687]["内力"] = 8000
  JY.Person[687]["内力最大值"] = 8000
  JY.Person[687]["实战"] = 500
  JY.Person[687]["武学常识"] = 100
  JY.Person[687]["拳掌功夫"] = 120
  JY.Person[687]["指法技巧"] = 300
  JY.Person[687]["御剑能力"] = 200
  JY.Person[687]["耍刀技巧"] = 80
  JY.Person[687]["特殊兵器"] = 80
  if JY.Base["畅想"] ~= 687 then
  for i = 1, 4 do
	 if JY.Person[687]["天"..i] == 0 then
        JY.Person[687]["天"..i] = 1
	 end
  end
  end
  
  JY.Person[688]["生命"] = 5000
  JY.Person[688]["生命最大值"] = 5000
  JY.Person[688]["内力"] = 5000
  JY.Person[688]["内力最大值"] = 5000
  JY.Person[688]["实战"] = 500
  JY.Person[688]["武学常识"] = 33
  JY.Person[688]["拳掌功夫"] = 100
  JY.Person[688]["指法技巧"] = 100
  JY.Person[688]["御剑能力"] = 100
  JY.Person[688]["耍刀技巧"] = 100
  JY.Person[688]["特殊兵器"] = 270
  
  JY.Person[688]["武器"] = 344
  if JY.Base["畅想"] ~= 688 then
  for i = 1, 4 do
	 if JY.Person[688]["天"..i] == 0 then
        JY.Person[688]["天"..i] = math.random(2)
	 end
  end
  end
  
  
  JY.Person[677]["生命"] = 6000
  JY.Person[677]["生命最大值"] = 6000
  JY.Person[677]["内力"] = 8000
  JY.Person[677]["内力最大值"] = 8000
  JY.Person[677]["实战"] = 500
  JY.Person[677]["武学常识"] = 100
  JY.Person[677]["拳掌功夫"] = 100
  JY.Person[677]["指法技巧"] = 100
  JY.Person[677]["御剑能力"] = 100
  JY.Person[677]["耍刀技巧"] = 100
  JY.Person[677]["特殊兵器"] = 100
  
  JY.Person[677]["武功1"] = 215  
  JY.Person[677]["武功等级1"] = 999
  JY.Person[677]["武功2"] = 214
  JY.Person[677]["武功等级2"] = 999
  JY.Person[677]["武功3"] = 48
  JY.Person[677]["武功等级3"] = 999
  JY.Person[677]["武功4"] = 26
  JY.Person[677]["武功等级4"] = 999
  JY.Person[677]["武功5"] = 102
  JY.Person[677]["武功等级5"] = 999
  JY.Person[677]["武功6"] = 106
  JY.Person[677]["武功等级6"] = 999
  
  --陆小凤
  JY.Person[678]["生命"] = 5000
  JY.Person[678]["生命最大值"] = 5000
  JY.Person[678]["内力"] = 7000
  JY.Person[678]["内力最大值"] = 7000
  JY.Person[678]["实战"] = 500
  JY.Person[678]["武学常识"] = 120
  JY.Person[678]["拳掌功夫"] = 100
  JY.Person[678]["指法技巧"] = 200
  JY.Person[678]["御剑能力"] = 70
  JY.Person[678]["耍刀技巧"] = 70
  JY.Person[678]["特殊兵器"] = 70
  
  
  JY.Person[678]["武功1"] = 132 
  JY.Person[678]["武功等级1"] = 999
  JY.Person[678]["武功2"] = 216
  JY.Person[678]["武功等级2"] = 999
  JY.Person[678]["武功3"] = 133
  JY.Person[678]["武功等级3"] = 999
  JY.Person[678]["武功4"] = 136
  JY.Person[678]["武功等级4"] = 999
  JY.Person[678]["武功5"] = 137
  JY.Person[678]["武功等级5"] = 999

  JY.Person[678]["天赋轻功"] = 216

  if JY.Base["畅想"] ~= 678 then
  for i = 1, 4 do
	 if JY.Person[678]["天"..i] == 0 then
        JY.Person[678]["天"..i] = math.random(2)
	 end
  end
  end
  --star
  for i = 1, 30 do
	  JY.Person[642]["人"..i] = JY.Person[0]["人"..i]
  end
  JY.Person[642]["生命"] = 14444
  JY.Person[642]["生命最大值"] = 14444
  JY.Person[642]["内力"] = 14444
  JY.Person[642]["内力最大值"] = 14444
  for i = 1, JY.Person[671]["品德"] do
     JY.Person[642]["武功"..i] = JY.Person[0]["武功"..i]
	 JY.Person[642]["武功等级"..i] = 999
   end
   if JY.Person[0]["主运轻功"] > 0 then
   JY.Person[642]["天赋轻功"] = JY.Person[0]["主运轻功"]
   end
   if JY.Person[0]["主运内功"] > 0 then
   JY.Person[642]["天赋内功"] = JY.Person[0]["主运内功"]
   end
  local str = {"拳掌功夫","指法技巧","御剑能力","耍刀技巧","特殊兵器","攻击力","防御力","轻功","暗器技巧","武学常识","攻击带毒","医疗能力","用毒能力","解毒能力","抗毒能力","洗髓","左右互搏","出战","专1","专2"}
  for a = 1, #str do
	  JY.Person[642][str[a]] = JY.Person[0][str[a]]
  end
  local str2 = {"拳掌功夫","指法技巧","御剑能力","耍刀技巧","特殊兵器"}
  for b = 1, #str2 do
	  JY.Person[642][str2[b]] = math.modf(JY.Person[0][str2[b]]/3)
  end
end

--摧心掌余沧海
PNLBD[311] = function()
  JY.Person[24]["生命"] = 2200
  JY.Person[24]["生命最大值"] = 2200
  JY.Person[24]["内力"] = 4000
  JY.Person[24]["内力最大值"] = 4000
  JY.Person[24]["攻击力"] = 130
  JY.Person[24]["防御力"] = 100
  JY.Person[24]["轻功"] = 130
  JY.Person[24]["实战"] = 300
end

PNLBD[51] = function()
  JY.Person[24]["生命"] = 2200
  JY.Person[24]["生命最大值"] = 2200
  JY.Person[24]["内力"] = 3000
  JY.Person[24]["内力最大值"] = 3000
  JY.Person[24]["攻击力"] = 110
  JY.Person[24]["防御力"] = 100
  JY.Person[24]["轻功"] = 110
  JY.Person[24]["实战"] = 500
end

  
--终极挑战
PNLBD[312] = function()
  --雷震
  JY.Person[670]["生命"] = 6300
  JY.Person[670]["生命最大值"] = 6300
  JY.Person[670]["内力"] = 9999
  JY.Person[670]["内力最大值"] = 9999
  JY.Person[670]["攻击力"] = 350
  JY.Person[670]["防御力"] = 250
  JY.Person[670]["轻功"] = 350
  JY.Person[670]["实战"] = 500
  JY.Person[670]["医疗能力"] = 500

  JY.Person[670]["拳掌功夫"] = 320
  JY.Person[670]["指法技巧"] = 320
  JY.Person[670]["御剑能力"] = 320
  JY.Person[670]["耍刀技巧"] = 320
  JY.Person[670]["特殊兵器"] = 320
  JY.Person[670]["防具"] = 327
  JY.Person[670]["武器"] = 345
  
  JY.Person[670]["武功1"] = 197  
  JY.Person[670]["武功等级1"] = 999
  JY.Person[670]["武功2"] = 108
  JY.Person[670]["武功等级2"] = 999
  JY.Person[670]["武功3"] = 49
  JY.Person[670]["武功等级3"] = 999
  JY.Person[670]["武功4"] = 66
  JY.Person[670]["武功等级4"] = 999
  JY.Person[670]["武功5"] = 26
  JY.Person[670]["武功等级5"] = 999
  JY.Person[670]["武功6"] = 80
  JY.Person[670]["武功等级6"] = 999
  JY.Person[670]["武功7"] = 147
  JY.Person[670]["武功等级7"] = 999
  JY.Person[670]["天赋内功"] = 108
  JY.Person[670]["天赋轻功"] = 147
  JY.Person[670]["出战"]=1
  
  
  --无名
  JY.Person[671]["生命"] = 4500
  JY.Person[671]["生命最大值"] = 4500
  JY.Person[671]["内力"] = 9999
  JY.Person[671]["内力最大值"] = 9999
  JY.Person[671]["攻击力"] = 350
  JY.Person[671]["防御力"] = 200
  JY.Person[671]["轻功"] = 350
  JY.Person[671]["实战"] = 500
  JY.Person[671]["医疗能力"] = 500
  JY.Person[671]["武器"] = 353

  JY.Person[671]["拳掌功夫"] = 200
  JY.Person[671]["指法技巧"] = 200
  JY.Person[671]["御剑能力"] = 999
  JY.Person[671]["耍刀技巧"] = 200
  JY.Person[671]["特殊兵器"] = 200
  
  JY.Person[671]["武功2"] = 167
  JY.Person[671]["武功等级2"] = 999
  JY.Person[671]["武功3"] = 168
  JY.Person[671]["武功等级3"] = 999
  JY.Person[671]["武功4"] = 46
  JY.Person[671]["武功等级4"] = 999
  JY.Person[671]["武功5"] = 45
  JY.Person[671]["武功等级5"] = 999
  JY.Person[671]["武功6"] = 198
  JY.Person[671]["武功等级6"] = 999
 
  --贝克汉姆
  JY.Person[681]["生命"] = 6000
  JY.Person[681]["生命最大值"] = 6000
  JY.Person[681]["内力"] = 9999
  JY.Person[681]["内力最大值"] = 9999
  JY.Person[681]["攻击力"] = 380
  JY.Person[681]["防御力"] = 320
  JY.Person[681]["轻功"] = 520
  JY.Person[681]["实战"] = 500
  JY.Person[681]["武学常识"] = 100
  JY.Person[681]["拳掌功夫"] = 100
  JY.Person[681]["指法技巧"] = 100
  JY.Person[681]["御剑能力"] = 100
  JY.Person[681]["耍刀技巧"] = 320
  JY.Person[681]["特殊兵器"] = 100
  JY.Person[681]["品德"] = 6
  JY.Person[681]["武器"] = 360
  WAR.MXD[681] = 30
  
  --李逍遥
  JY.Person[655]["生命"] = 3000
  JY.Person[655]["生命最大值"] = 3000
  JY.Person[655]["内力"] = 9999
  JY.Person[655]["内力最大值"] = 9999
  JY.Person[655]["攻击力"] = 200
  JY.Person[655]["防御力"] = 200
  JY.Person[655]["轻功"] = 280
  JY.Person[655]["实战"] = 500
  JY.Person[655]["御剑能力"] = 100
  
  --华英雄
  JY.Person[675]["生命"] = 6000
  JY.Person[675]["生命最大值"] = 6000
  JY.Person[675]["内力"] = 6000
  JY.Person[675]["内力最大值"] = 6000
  JY.Person[675]["攻击力"] = 300
  JY.Person[675]["防御力"] = 200
  JY.Person[675]["轻功"] = 200
  JY.Person[675]["实战"] = 500
  JY.Person[675]["御剑能力"] = 210
  JY.Person[675]["拳掌功夫"] = 180
  if JY.Base["畅想"] ~= 675 then
     JY.Person[675]["声望"] = 600
	 JY.Person[675]["品德"] = 6
  end	 
  
  --?
  JY.Person[654]["生命"] = 6500
  JY.Person[654]["生命最大值"] = 6500
  JY.Person[654]["实战"] = 500
  
  --张家辉
  JY.Person[651]["生命"] = 5000
  JY.Person[651]["生命最大值"] = 5000
  JY.Person[651]["内力"] = 5000
  JY.Person[651]["内力最大值"] = 5000
  JY.Person[651]["攻击力"] = 240
  JY.Person[651]["防御力"] = 200
  JY.Person[651]["轻功"] = 280
  JY.Person[651]["实战"] = 500
  JY.Person[651]["御剑能力"] = 100
  
  --豪鬼
  JY.Person[673]["生命"] = 4800
  JY.Person[673]["生命最大值"] = 4800
  JY.Person[673]["内力"] = 8000
  JY.Person[673]["内力最大值"] = 8000
  JY.Person[673]["攻击力"] = 520
  JY.Person[673]["防御力"] = 300
  JY.Person[673]["轻功"] = 400
  JY.Person[673]["实战"] = 500
  JY.Person[673]["医疗能力"] = 0
  JY.Person[673]["暗器技巧"] = 200
  JY.Person[673]["武功5"] = 210
  JY.Person[673]["武功等级5"] = 999

  JY.Person[673]["拳掌功夫"] = 333
  JY.Person[673]["指法技巧"] = 100
  JY.Person[673]["御剑能力"] = 0
  JY.Person[673]["耍刀技巧"] = 0
  JY.Person[673]["特殊兵器"] = 0
  WAR.SYBD[673] = 100
  if JY.Base["畅想"] ~= 673 then
  if JY.Person[673]["外号2"] == "小子" then
  if math.random(2) == 1 then
     JY.Person[673]["外号2"] = "怒"
  else	 
     JY.Person[673]["外号2"] = "烈"
  end
  end
  JY.Person[673]["天1"] = math.random(2)
  end
  --武僧
  JY.Person[676]["生命"] = 6000
  JY.Person[676]["生命最大值"] = 6000
  JY.Person[676]["内力"] = 8000
  JY.Person[676]["内力最大值"] = 8000
  JY.Person[676]["实战"] = 500
  JY.Person[676]["武学常识"] = 150
  JY.Person[676]["拳掌功夫"] = 200
  JY.Person[676]["指法技巧"] = 100
  JY.Person[676]["御剑能力"] = 100
  JY.Person[676]["耍刀技巧"] = 100
  JY.Person[676]["特殊兵器"] = 100
  
  JY.Person[676]["防具"] = 355
  JY.Person[676]["武器"] = 354
  
  JY.Person[676]["武功1"] = 1  
  JY.Person[676]["武功等级1"] = 999
  JY.Person[676]["武功2"] = 24
  JY.Person[676]["武功等级2"] = 999
  JY.Person[676]["武功3"] = 22
  JY.Person[676]["武功等级3"] = 999
  JY.Person[676]["武功4"] = 186
  JY.Person[676]["武功等级4"] = 999
  JY.Person[676]["武功5"] = 144
  JY.Person[676]["武功等级5"] = 999
  JY.Person[676]["武功6"] = 96
  JY.Person[676]["武功等级6"] = 999
  JY.Person[676]["武功7"] = 182
  JY.Person[676]["武功等级7"] = 999
  JY.Person[676]["天赋内功"] = 108
  JY.Person[676]["天赋轻功"] = 182

  if JY.Base["畅想"] ~= 676 then
  for i = 1, 4 do
	 if JY.Person[676]["天"..i] == 0 then
        JY.Person[676]["天"..i] = math.random(2)
	 end
  end
  end
  
  if JY.Base["畅想"] ~= 634 then
  for i = 1, 4 do
	 if JY.Person[634]["天"..i] == 0 then
        JY.Person[634]["天"..i] = math.random(2)
	 end
  end
  JY.Person[634]["天4"] = 1
  end

end

PNLBD[316] = function()
  --雷震
  if JY.Person[241]["品德"] == 50 then
  JY.Person[670]["防具"] = 327
  JY.Person[670]["生命最大值"] = math.min(JY.Person[0]["生命最大值"], 6000)
  JY.Person[670]["生命"] = JY.Person[670]["生命最大值"]
  JY.Person[670]["内力"] = 6000
  JY.Person[670]["内力最大值"] = 6000
  JY.Person[670]["防御力"] = 250
  else
  JY.Person[670]["防具"] = 356
  JY.Person[670]["生命最大值"] = math.min(JY.Person[0]["生命最大值"], 6000)
  JY.Person[670]["生命"] = JY.Person[670]["生命最大值"]
  JY.Person[670]["内力"] = 9999
  JY.Person[670]["内力最大值"] = 9999
  JY.Person[670]["防御力"] = 350
  end
  
  
  JY.Person[670]["攻击力"] = 260
  
  JY.Person[670]["轻功"] = 300
  JY.Person[670]["实战"] = 500
  JY.Person[670]["武学常识"] = 120
  JY.Person[670]["医疗能力"] = 500

  JY.Person[670]["拳掌功夫"] = 320
  JY.Person[670]["指法技巧"] = 320
  JY.Person[670]["御剑能力"] = 320
  JY.Person[670]["耍刀技巧"] = 320
  JY.Person[670]["特殊兵器"] = 320
  
  JY.Person[670]["武器"] = 345
  
  JY.Person[670]["武功1"] = 197  
  JY.Person[670]["武功等级1"] = 999
  JY.Person[670]["武功2"] = 108
  JY.Person[670]["武功等级2"] = 999
  JY.Person[670]["武功3"] = 49
  JY.Person[670]["武功等级3"] = 999
  JY.Person[670]["武功4"] = 66
  JY.Person[670]["武功等级4"] = 999
  JY.Person[670]["武功5"] = 26
  JY.Person[670]["武功等级5"] = 999
  JY.Person[670]["武功6"] = 80
  JY.Person[670]["武功等级6"] = 999
  JY.Person[670]["武功7"] = 147
  JY.Person[670]["武功等级7"] = 999
  JY.Person[670]["天赋内功"] = 108
  JY.Person[670]["天赋轻功"] = 147
  JY.Person[670]["出战"]=1

end

PNLBD[317] = function() 
  --无名
  JY.Person[671]["生命"] = 5500
  JY.Person[671]["生命最大值"] = 5500
  JY.Person[671]["内力"] = 9999
  JY.Person[671]["内力最大值"] = 9999
  JY.Person[671]["攻击力"] = 300
  JY.Person[671]["防御力"] = 100
  JY.Person[671]["轻功"] = 200
  JY.Person[671]["实战"] = 500
  JY.Person[671]["武学常识"] = 200
  JY.Person[671]["医疗能力"] = 500

  JY.Person[671]["拳掌功夫"] = 100
  JY.Person[671]["指法技巧"] = 100
  JY.Person[671]["御剑能力"] = 500
  JY.Person[671]["耍刀技巧"] = 100
  JY.Person[671]["特殊兵器"] = 100
  JY.Person[671]["武器"] = 353
  
  JY.Person[671]["武功2"] = 167
  JY.Person[671]["武功等级2"] = 999
  JY.Person[671]["武功3"] = 168
  JY.Person[671]["武功等级3"] = 999
  JY.Person[671]["武功4"] = 46
  JY.Person[671]["武功等级4"] = 999
  JY.Person[671]["武功5"] = 45
  JY.Person[671]["武功等级5"] = 999
  JY.Person[671]["武功6"] = 198
  JY.Person[671]["武功等级6"] = 999
 

end

PNLBD[318] = function()
  --豪鬼
  JY.Person[673]["生命"] = 5800
  JY.Person[673]["生命最大值"] = 5800
  JY.Person[673]["内力"] = 7000
  JY.Person[673]["内力最大值"] = 7000
  JY.Person[673]["攻击力"] = 320
  JY.Person[673]["防御力"] = 300
  JY.Person[673]["轻功"] = 400
  JY.Person[673]["实战"] = 500
  JY.Person[673]["武学常识"] = 200
  JY.Person[673]["医疗能力"] = 0
  JY.Person[673]["暗器技巧"] = 0
  JY.Person[673]["武功5"] = 210
  JY.Person[673]["武功等级5"] = 999

  JY.Person[673]["拳掌功夫"] = 333
  JY.Person[673]["指法技巧"] = 100
  JY.Person[673]["御剑能力"] = 0
  JY.Person[673]["耍刀技巧"] = 0
  JY.Person[673]["特殊兵器"] = 0
  WAR.SYBD[673] = 100
  if JY.Base["畅想"] ~= 673 then
  if JY.Person[673]["外号2"] == "小子" then
  if math.random(2) == 1 then
     JY.Person[673]["外号2"] = "怒"
  else	 
     JY.Person[673]["外号2"] = "烈"
  end
  end
  JY.Person[673]["天1"] = math.random(2)
  end

end

PNLBD[319] = function()
  --ws
  if JY.Person[244]["品德"] == 50 then
  JY.Person[676]["生命"] = 3000
  JY.Person[676]["生命最大值"] = 3000
  JY.Person[676]["内力"] = 5000
  JY.Person[676]["内力最大值"] = 5000
  JY.Person[676]["攻击力"] = 220
  JY.Person[676]["防御力"] = 220
  JY.Person[676]["轻功"] = 200
  JY.Person[676]["实战"] = 500
  JY.Person[676]["武学常识"] = 100
  JY.Person[676]["天赋内功"] = 108
  JY.Person[676]["天赋轻功"] = 182
  JY.Person[676]["防具"] = 352
  JY.Person[676]["武功1"] = 1  
  JY.Person[676]["武功等级1"] = 999
  JY.Person[676]["武功2"] = 108
  JY.Person[676]["武功等级2"] = 999
  JY.Person[676]["武功3"] = 22
  JY.Person[676]["武功等级3"] = 999
  else
  JY.Person[676]["生命"] = 6000
  JY.Person[676]["生命最大值"] = 6000
  JY.Person[676]["内力"] = 8000
  JY.Person[676]["内力最大值"] = 8000
  JY.Person[676]["实战"] = 500
  JY.Person[676]["武学常识"] = 150
  JY.Person[676]["拳掌功夫"] = 200
  JY.Person[676]["指法技巧"] = 100
  JY.Person[676]["御剑能力"] = 100
  JY.Person[676]["耍刀技巧"] = 100
  JY.Person[676]["特殊兵器"] = 100
  
  JY.Person[676]["防具"] = 355
  JY.Person[676]["武器"] = 354
  
  JY.Person[676]["武功1"] = 1  
  JY.Person[676]["武功等级1"] = 999
  JY.Person[676]["武功2"] = 24
  JY.Person[676]["武功等级2"] = 999
  JY.Person[676]["武功3"] = 22
  JY.Person[676]["武功等级3"] = 999
  JY.Person[676]["武功4"] = 186
  JY.Person[676]["武功等级4"] = 999
  JY.Person[676]["武功5"] = 144
  JY.Person[676]["武功等级5"] = 999
  JY.Person[676]["武功6"] = 96
  JY.Person[676]["武功等级6"] = 999
  JY.Person[676]["武功7"] = 182
  JY.Person[676]["武功等级7"] = 999
  JY.Person[676]["天赋内功"] = 108
  JY.Person[676]["天赋轻功"] = 182
  end
  if JY.Base["畅想"] ~= 676 then
  for i = 1, 4 do
	 if JY.Person[676]["天"..i] == 0 then
        JY.Person[676]["天"..i] = math.random(2)
	 end
  end
  end
end

PNLBD[320] = function()
  --ws
  if JY.Person[245]["品德"] == 50 then
  JY.Person[677]["生命"] = 3000
  JY.Person[677]["生命最大值"] = 3000
  JY.Person[677]["内力"] = 5000
  JY.Person[677]["内力最大值"] = 5000
  JY.Person[677]["攻击力"] = 220
  JY.Person[677]["防御力"] = 220
  JY.Person[677]["轻功"] = 200
  JY.Person[677]["实战"] = 500
  JY.Person[677]["武学常识"] = 100
  JY.Person[677]["天赋内功"] = 105
  JY.Person[677]["武功1"] = 48  
  JY.Person[677]["武功等级1"] = 999
  JY.Person[677]["武功2"] = 105
  JY.Person[677]["武功等级2"] = 999
  else
  JY.Person[677]["生命"] = 6000
  JY.Person[677]["生命最大值"] = 6000
  JY.Person[677]["内力"] = 8000
  JY.Person[677]["内力最大值"] = 8000
  JY.Person[677]["实战"] = 500
  JY.Person[677]["武学常识"] = 100
  JY.Person[677]["拳掌功夫"] = 100
  JY.Person[677]["指法技巧"] = 100
  JY.Person[677]["御剑能力"] = 100
  JY.Person[677]["耍刀技巧"] = 100
  JY.Person[677]["特殊兵器"] = 100
  
  JY.Person[677]["武功1"] = 215  
  JY.Person[677]["武功等级1"] = 999
  JY.Person[677]["武功2"] = 214
  JY.Person[677]["武功等级2"] = 999
  JY.Person[677]["武功3"] = 48
  JY.Person[677]["武功等级3"] = 999
  JY.Person[677]["武功4"] = 26
  JY.Person[677]["武功等级4"] = 999
  JY.Person[677]["武功5"] = 102
  JY.Person[677]["武功等级5"] = 999
  JY.Person[677]["武功6"] = 106
  JY.Person[677]["武功等级6"] = 999
  end
  if JY.Base["畅想"] ~= 677 then
  for i = 1, 4 do
	 if JY.Person[677]["天"..i] == 0 then
        JY.Person[677]["天"..i] = math.random(2)
	 end
  end
  end
end

PNLBD[323] = function()
if JY.Person[247]["品德"] == 50 then
  JY.Person[681]["生命"] = 5000
  JY.Person[681]["生命最大值"] = 5000
  JY.Person[681]["内力"] = 8000
  JY.Person[681]["内力最大值"] = 8000
  JY.Person[681]["攻击力"] = 320
  JY.Person[681]["防御力"] = 220
  JY.Person[681]["轻功"] = 400
  JY.Person[681]["实战"] = 500
  JY.Person[681]["耍刀技巧"] = 220
  JY.Person[681]["武学常识"] = 50
  JY.Person[681]["品德"] = 3
  JY.Person[681]["武器"] = 360
  else
  JY.Person[681]["生命"] = 6000
  JY.Person[681]["生命最大值"] = 6000
  JY.Person[681]["内力"] = 9999
  JY.Person[681]["内力最大值"] = 9999
  JY.Person[681]["攻击力"] = 380
  JY.Person[681]["防御力"] = 320
  JY.Person[681]["轻功"] = 520
  JY.Person[681]["实战"] = 500
  JY.Person[681]["武学常识"] = 100
  JY.Person[681]["拳掌功夫"] = 100
  JY.Person[681]["指法技巧"] = 100
  JY.Person[681]["御剑能力"] = 100
  JY.Person[681]["耍刀技巧"] = 320
  JY.Person[681]["特殊兵器"] = 100
  JY.Person[681]["品德"] = 6
  JY.Person[681]["武器"] = 360
  WAR.MXD[681] = 30
  end
   
end
PNLBD[328] = function()
  JY.Person[682]["生命"] = 6000
  JY.Person[682]["生命最大值"] = 6000
  JY.Person[682]["内力"] = 9999
  JY.Person[682]["内力最大值"] = 9999
  JY.Person[682]["攻击力"] = 480
  JY.Person[682]["防御力"] = 320
  JY.Person[682]["轻功"] = 320
  JY.Person[682]["实战"] = 500
  JY.Person[682]["武学常识"] = 100
  JY.Person[682]["拳掌功夫"] = 300
  JY.Person[682]["指法技巧"] = 80
  JY.Person[682]["御剑能力"] = 300
  JY.Person[682]["耍刀技巧"] = 70
  JY.Person[682]["特殊兵器"] = 70
  JY.Person[682]["武功1"] = 221  
  JY.Person[682]["武功等级1"] = 999
  JY.Person[682]["武功2"] = 222
  JY.Person[682]["武功等级2"] = 999
  JY.Person[682]["武器"] = 362 
end

PNLBD[330] = function()
  JY.Person[690]["生命"] = 6000 - JY.Person[249]["声望"]*800
  JY.Person[690]["生命最大值"] = 6000 - JY.Person[249]["声望"]*800
  JY.Person[690]["内力"] = 6000 - JY.Person[249]["声望"]*800
  JY.Person[690]["内力最大值"] = 6000 - JY.Person[249]["声望"]*800
  WAR.SWKY[690] = 120 - JY.Person[249]["声望"]*5 
  JY.Person[689]["生命"] = 9999 - JY.Person[249]["声望"]*800
  JY.Person[689]["生命最大值"] = 9999 - JY.Person[249]["声望"]*800
  JY.Person[689]["内力"] = 9999 - JY.Person[249]["声望"]*800
  JY.Person[689]["内力最大值"] = 9999 - JY.Person[249]["声望"]*800
  JY.Person[689]["攻击力"] = 520 - JY.Person[249]["声望"]*60
  JY.Person[689]["防御力"] = 520 - JY.Person[249]["声望"]*60
  JY.Person[689]["轻功"] = 520 - JY.Person[249]["声望"]*60
  JY.Person[689]["实战"] = 500
  JY.Person[689]["拳掌功夫"] = 101 - JY.Person[249]["声望"]*20
  JY.Person[689]["指法技巧"] = 101 - JY.Person[249]["声望"]*20
  JY.Person[689]["御剑能力"] = 101 - JY.Person[249]["声望"]*20
  JY.Person[689]["耍刀技巧"] = 101 - JY.Person[249]["声望"]*20
  JY.Person[689]["特殊兵器"] = 101 - JY.Person[249]["声望"]*20
  JY.Person[689]["资质"] = 50
  JY.Person[689]["左右互搏"] = 1
  JY.Person[689]["出战"] = 1
  WAR.YLMB[689] = 89 - JY.Person[249]["声望"]*17
  for i = 1, 10 do
  JY.Person[689]["武功"..i] = 225+i  
  JY.Person[689]["武功等级"..i] = 999
  end
  JY.Person[689]["武功2"] = 228
  JY.Person[689]["武功5"] = 238
  JY.Person[689]["武功8"] = 235
  if JY.Base["畅想"] ~= 689 then
  JY.Person[689]["天1"] = 10 - JY.Person[249]["声望"]
  JY.Person[689]["天2"] = 10 - JY.Person[249]["声望"]
  JY.Person[689]["天3"] = 10 - JY.Person[249]["声望"]
  JY.Person[689]["声望"] = 2
  for i = 1, 4 do
  JY.Person[690]["天"..i] = math.random(2)
  end
  JY.Person[690]["品德"] = math.random(2)
  end
end

PNLBD[271] = function()
  if JY.Person[616]["生命最大值"] > 4000 then
     JY.Person[616]["生命最大值"] = 4000
  end	 
  JY.Person[616]["生命"] = JY.Person[616]["生命最大值"]
  JY.Person[616]["防御力"] = 75
  JY.Person[616]["轻功"] = 75
end

PNLBD[262] = function()
  JY.Person[149]["攻击力"] = 200
  JY.Person[149]["防御力"] = 200
  JY.Person[149]["拳掌功夫"] = 100
end

PNLBD[322] = function()
dofile(CC.Acvmts)
	dark()
	light()
	local id = Achievements.pChar[1000].CharTd
	if id > 1000 then
	   id = 677
	end
	WAR.Data["敌人1"] = id
		for i = 1, 15 do
		JY.Person[id]["武功"..i] = Achievements.pChar[1000].CharWg[i]
		JY.Person[id]["武功等级"..i] = 999
		end
		if JY.Base["畅想"] ~= id then
		for i = 1, 4 do
		    if JY.Person[id]["天"..i] == 0 then
		JY.Person[id]["天"..i] = Achievements.pChar[1000].CharTf[i]
		    end
		end
		end
		JY.Person[id]["攻击力"] = Achievements.pChar[1000].CharTn
		for i = 1, 4 do
		JY.Person[id]["天赋外功"..i] = Achievements.pChar[1000].CharTw[i]
		end
		JY.Person[id]["资质"] = Achievements.pChar[1000].CharZz
		JY.Person[id]["左右互搏"] = Achievements.pChar[1000].CharHb
		JY.Person[id]["出战"] = Achievements.pChar[1000].CharDz
		JY.Person[id]["洗髓"] = Achievements.pChar[1000].CharXs
		JY.Person[id]["攻击力"] = Achievements.pChar[1000].CharAt
		JY.Person[id]["防御力"] = Achievements.pChar[1000].CharDe
		JY.Person[id]["轻功"] = Achievements.pChar[1000].CharAg
		JY.Person[id]["拳掌功夫"] = Achievements.pChar[1000].CharQz
		JY.Person[id]["指法技巧"] = Achievements.pChar[1000].CharZf
		JY.Person[id]["御剑能力"] = Achievements.pChar[1000].CharYj
		JY.Person[id]["耍刀技巧"] = Achievements.pChar[1000].CharSd
		JY.Person[id]["特殊兵器"] = Achievements.pChar[1000].CharQm
		JY.Person[id]["武学常识"] = Achievements.pChar[1000].CharWc
		JY.Person[id]["生命最大值"] = Achievements.pChar[1000].CharHp
		JY.Person[id]["内力最大值"] = Achievements.pChar[1000].CharMp
		JY.Person[id]["天赋内功"] = Achievements.pChar[1000].CharZn
		JY.Person[id]["天赋轻功"] = Achievements.pChar[1000].CharZq
		JY.Person[id]["内力"] = JY.Person[id]["内力最大值"]
		JY.Person[id]["生命"] = JY.Person[id]["生命最大值"]
		JY.Person[id]["专1"] = Achievements.pChar[1000].CharZj1
		JY.Person[id]["专2"] = Achievements.pChar[1000].CharZj2
		if id == 673 then
		   WAR.SYBD[673] = 50
           if JY.Base["畅想"] ~= 673 then
		   if JY.Person[673]["外号2"] == "小子" then
           if math.random(2) == 1 then
              JY.Person[673]["外号2"] = "怒"
           else	 
              JY.Person[673]["外号2"] = "烈"
           end
		   end
		   JY.Person[673]["天1"] = math.random(2)
           end
		end
		if id == 675 then
            JY.Person[675]["声望"] = 600
	        JY.Person[675]["品德"] = 6
        end 
		
end

PNLBD[314] = function()
  --苗人凤
  JY.Person[3]["武功2"] = 67
  JY.Person[3]["武功等级2"] = 999
  
  --郭靖
	JY.Person[55]["生命"] = 5200
	JY.Person[55]["生命最大值"] = 5200
	JY.Person[55]["内力"] = 7500
    JY.Person[55]["内力最大值"] = 7500
	JY.Person[55]["实战"] = 500
	JY.Person[55]["武功1"] = 15
    JY.Person[55]["武功等级1"] = 999
	JY.Person[55]["武功2"] = 26
    JY.Person[55]["武功等级2"] = 999
	
  --石破天
  JY.Person[38]["生命"] = 9999
  JY.Person[38]["生命最大值"] = 9999
  JY.Person[38]["内力"] = 9999
  JY.Person[38]["内力最大值"] = 9999
  JY.Person[38]["攻击力"] = 350
  JY.Person[38]["防御力"] = 250
  JY.Person[38]["轻功"] = 330
  JY.Person[38]["受伤程度"] = 0
  JY.Person[38]["中毒程度"] = 0
  JY.Person[38]["武功等级1"] = 999
  JY.Person[38]["武功2"] = 102
  JY.Person[38]["武功等级2"] = 999
  JY.Person[38]["天赋内功"] = 102
  JY.Person[38]["天赋外功1"] = 102
  JY.Person[38]["实战"] = 500
  
  --一指z江南
  JY.Person[138]["生命"] = 4000
  JY.Person[138]["生命最大值"] = 4000
  JY.Person[138]["内力"] = 4000
  JY.Person[138]["内力最大值"] = 4000
  JY.Person[138]["攻击力"] = 120
  JY.Person[138]["防御力"] = 120
  JY.Person[138]["轻功"] = 120
  
  --鳌拜
  JY.Person[603]["生命"] = 5555
  JY.Person[603]["生命最大值"] = 5555
  JY.Person[603]["内力"] = 5500
  JY.Person[603]["内力最大值"] = 5500
  JY.Person[603]["攻击力"] = 200
  JY.Person[603]["防御力"] = 520
  JY.Person[603]["轻功"] = 120
  
  --东方不败
  JY.Person[27]["生命"] = 8500
  JY.Person[27]["生命最大值"] = 8500
  JY.Person[27]["攻击力"] = 350
  JY.Person[27]["防御力"] = 250
  JY.Person[27]["轻功"] = 400
  JY.Person[27]["实战"] = 500
  
  --局座
  JY.Person[80]["生命"] = 5800
	JY.Person[80]["生命最大值"] = 5800
	JY.Person[80]["内力"] = 4300
    JY.Person[80]["内力最大值"] = 4300
	JY.Person[80]["武功2"] = 16
	JY.Person[80]["武功等级2"] = 999
	JY.Person[80]["武功3"] = 46
	JY.Person[80]["武功等级3"] = 999
	JY.Person[80]["武功4"] = 99
	JY.Person[80]["武功等级4"] = 999
	JY.Person[80]["武功5"] = 171
	JY.Person[80]["武功等级5"] = 999
  
  --金轮
  JY.Person[62]["生命"] = 7500
	JY.Person[62]["生命最大值"] = 7500
	JY.Person[62]["内力"] = 7500
	JY.Person[62]["内力最大值"] = 7500
	JY.Person[62]["武功2"] = 169
	JY.Person[62]["武功等级2"] = 999
	JY.Person[62]["实战"] = 500
	
  --丁典
  JY.Person[672]["生命"] = 6700
  JY.Person[672]["生命最大值"] = 6700
  JY.Person[672]["内力"] = 8000
  JY.Person[672]["内力最大值"] = 8000
  JY.Person[672]["攻击力"] = 250
  JY.Person[672]["防御力"] = 350
  JY.Person[672]["轻功"] = 250
  JY.Person[672]["实战"] = 500

  JY.Person[672]["拳掌功夫"] = 110
  JY.Person[672]["指法技巧"] = 90
  JY.Person[672]["御剑能力"] = 110
  JY.Person[672]["耍刀技巧"] = 80
  JY.Person[672]["特殊兵器"] = 60
  
  JY.Person[672]["武功2"] = 114
  JY.Person[672]["武功等级2"] = 999
  
  JY.Person[672]["声望"] = 100
  if JY.Base["畅想"] ~= 672 then
  if math.random(2) == 1 then
     JY.Person[672]["品德"] = 100
  else
     JY.Person[672]["品德"] = 70
  end
  end
end

--论剑丁典
--丁典
PNLBD[266] = function()
  JY.Person[672]["生命"] = 3500
  JY.Person[672]["生命最大值"] = 3500
  JY.Person[672]["内力"] = 6500
  JY.Person[672]["内力最大值"] = 6500
  JY.Person[672]["攻击力"] = 220
  JY.Person[672]["防御力"] = 200
  JY.Person[672]["轻功"] = 220
  JY.Person[672]["实战"] = 300

  JY.Person[672]["拳掌功夫"] = 110
  JY.Person[672]["指法技巧"] = 70
  JY.Person[672]["御剑能力"] = 90
  JY.Person[672]["耍刀技巧"] = 60
  JY.Person[672]["特殊兵器"] = 50
  
  JY.Person[672]["武功2"] = 114
  JY.Person[672]["武功等级2"] = 999
  
  JY.Person[672]["声望"] = 100
  if JY.Base["畅想"] ~= 672 then
  if math.random(2) == 1 then
     JY.Person[672]["品德"] = 100
  else
     JY.Person[672]["品德"] = 70
  end
  end
end

--侠正李白
PNLBD[302] = function()
  JY.Person[636]["生命"] = 4400
  JY.Person[636]["生命最大值"] = 4400
  JY.Person[636]["内力"] = 9999
  JY.Person[636]["内力最大值"] = 9999
  JY.Person[636]["攻击力"] = 200
  JY.Person[636]["防御力"] = 200
  JY.Person[636]["轻功"] = 200
  JY.Person[636]["受伤程度"] = 0
  JY.Person[636]["实战"] = 500
end

--天正游坦之
PNLBD[197] = function()
  JY.Person[48]["生命"] = 3400
  JY.Person[48]["生命最大值"] = 3400
  JY.Person[48]["内力"] = 4000
  JY.Person[48]["内力最大值"] = 4000
  JY.Person[48]["攻击力"] = 150
  JY.Person[48]["防御力"] = 130
  JY.Person[48]["轻功"] = 100
  JY.Person[48]["受伤程度"] = 0
  JY.Person[48]["中毒程度"] = 0
  JY.Person[48]["武功等级1"] = 999
  JY.Person[48]["武功等级2"] = 999
  JY.Person[48]["武功2"] = 108
  if JY.Base["畅想"] ~= 48 then
	 if JY.Person[48]["天1"] == 0 then
        JY.Person[48]["天1"] = 2
	 end
	 if JY.Person[48]["天3"] == 0 then
        JY.Person[48]["天3"] = 1
	 end
	end	
end

--天正慕容复
PNLBD[198] = function()
	JY.Person[51]["生命"] = 3000
	JY.Person[51]["生命最大值"] = 3000
	JY.Person[51]["内力"] = 4000
	JY.Person[51]["内力最大值"] = 4000
	JY.Person[51]["攻击力"] = 180
	JY.Person[51]["防御力"] = 160
	JY.Person[51]["轻功"] = 120
	JY.Person[51]["受伤程度"] = 0
	JY.Person[51]["中毒程度"] = 0
	JY.Person[51]["武功等级1"] = 999
end

--天正鸠摩智
PNLBD[200] = function()
  JY.Person[103]["内力"] = 5000
  JY.Person[103]["内力最大值"] = 5000
end

--天正第五战慕容复
PNLBD[81] = function()
 	JY.Person[51]["武功2"] = 15
	JY.Person[51]["武功等级2"] = 999
	JY.Person[51]["武功3"] = 16
	JY.Person[51]["武功等级3"] = 999
end

PNLBD[202] = function()
	JY.Person[118]["内力"]=2333
	JY.Person[118]["生命"]=2333
end

--天邪二
PNLBD[250] = function()
	--段誉
	JY.Person[53]["生命"] = 3000
	JY.Person[53]["生命最大值"] = 3000
	JY.Person[53]["内力"] = 9999
	JY.Person[53]["内力最大值"] = 9999
	JY.Person[53]["攻击力"] = 160
	JY.Person[53]["防御力"] = 150
	JY.Person[53]["轻功"] = 120
	JY.Person[53]["武功1"] = 85
	JY.Person[53]["武功等级1"] = 999
	JY.Person[53]["武功2"] = 147
	JY.Person[53]["武功等级2"] = 999
	JY.Person[53]["武功3"] = 49
	JY.Person[53]["武功等级3"] = 999
end	

--天邪三
PNLBD[251] = function()
	--虚竹
	JY.Person[49]["生命"] = 3200
	JY.Person[49]["生命最大值"] = 3200
	JY.Person[49]["内力"] = 8500
	JY.Person[49]["内力最大值"] = 8500
	JY.Person[49]["攻击力"] = 150
	JY.Person[49]["防御力"] = 170
	JY.Person[49]["轻功"] = 80
	JY.Person[49]["受伤程度"] = 0
	JY.Person[49]["中毒程度"] = 0
	JY.Person[49]["武功1"] = 8
	JY.Person[49]["武功等级1"] = 999
	JY.Person[49]["武功2"] = 98
	JY.Person[49]["武功等级2"] = 999
	JY.Person[49]["武功3"] = 14
	JY.Person[49]["武功等级3"] = 999
	JY.Person[49]["武功4"] = 101
	JY.Person[49]["武功等级4"] = 999
	JY.Person[49]["武功5"] = 85
	JY.Person[49]["武功等级5"] = 999
	for i = 6 , JY.Person[671]["品德"] do
		JY.Person[49]["武功"..i] = 0
		JY.Person[49]["武功等级"..i] = 0
	end
	JY.Person[49]["个人觉醒"] = 1
	JY.Person[49]["左右互搏"] = 0
	JY.Person[49]["性别"] = 0
end	

--连邪水笙，花铁杆
PNLBD[42] = function()
	JY.Person[589]["生命"] = 1000
	JY.Person[589]["生命最大值"] = 1000
	JY.Person[52]["生命"] = 1200
	JY.Person[52]["生命最大值"] = 1200
end

PNLBD[252] = function()
	JY.Person[589]["生命最大值"] = 2600
	JY.Person[589]["生命"] = 2600
	JY.Person[589]["内力最大值"] = 2500
	JY.Person[589]["内力"] = 2500
	JY.Person[589]["防御力"] = 130
	JY.Person[589]["轻功"] = 120
	JY.Person[589]["武功等级1"] = 999
end	

--倚邪张无忌
PNLBD[288] = function()
	JY.Person[9]["生命最大值"] = 4000
	JY.Person[9]["生命"] = 4000
	JY.Person[9]["内力最大值"] = 6000
	JY.Person[9]["内力"] = 6000
	JY.Person[9]["攻击力"] = 220
	JY.Person[9]["防御力"] = 200
	JY.Person[9]["轻功"] = 200
	JY.Person[9]["武功等级1"] = 999
	JY.Person[9]["武功等级2"] = 999
	JY.Person[9]["武功3"] = 97
	JY.Person[9]["武功等级3"] = 900
	JY.Person[9]["武功4"] = 16
	JY.Person[9]["武功等级4"] = 999
	JY.Person[9]["武功5"] = 46
	JY.Person[9]["武功等级5"] = 999
	JY.Person[9]["武功6"] = 93
	JY.Person[9]["武功等级6"] = 900
	JY.Person[9]["携带物品1"] = -1
	JY.Person[9]["携带物品数量1"] = 0
end

--何铁手
--正线
PNLBD[162] = function()
  JY.Person[83]["生命"] = 2400
  JY.Person[83]["生命最大值"] = 2400
  JY.Person[83]["内力"] = 3500
  JY.Person[83]["内力最大值"] = 3500
end
--邪线
PNLBD[164] = function()
  JY.Person[83]["生命"] = 2400
  JY.Person[83]["生命最大值"] = 2400
  JY.Person[83]["内力"] = 3500
  JY.Person[83]["内力最大值"] = 3500
end

--书正张召重
PNLBD[142] = function()
	JY.Person[80]["生命"] = 2800
	JY.Person[80]["生命最大值"] = 2800
end
--书正张召重
PNLBD[143] = function()
	JY.Person[80]["生命"] = 2800
	JY.Person[80]["生命最大值"] = 2800
	JY.Person[80]["武功2"] = 16
	JY.Person[80]["武功等级2"] = 999
	JY.Person[80]["武功3"] = 46
	JY.Person[80]["武功等级3"] = 999
	JY.Person[80]["武功4"] = 99
	JY.Person[80]["武功等级4"] = 999
	JY.Person[80]["武功5"] = 171
	JY.Person[80]["武功等级5"] = 999
end

--书邪霍青桐
PNLBD[140] = function()
	JY.Person[74]["生命"] = 2000
	JY.Person[74]["生命最大值"] = 2000
	JY.Person[74]["内力"] = 1500
	JY.Person[74]["内力最大值"] = 1500
end

--鸳邪萧中慧
PNLBD[132] = function()
	JY.Person[77]["生命"] = 2000
	JY.Person[77]["生命最大值"] = 2000
	JY.Person[77]["内力"] = 1500
	JY.Person[77]["内力最大值"] = 1500
	JY.Person[77]["武功等级1"] = 999
  if JY.Base["畅想"] == 29 then
  JY.Person[77]["生命"] = 3300
  JY.Person[77]["生命最大值"] = 3300
  JY.Person[77]["内力"] = 3000
  JY.Person[77]["内力最大值"] = 3000
  JY.Person[77]["攻击力"] = 150
  JY.Person[77]["防御力"] = 100
  JY.Person[77]["轻功"] = 150
  JY.Person[77]["实战"] = 500
  JY.Person[77]["耍刀技巧"] = 90
  JY.Person[77]["武功2"] = 62
  JY.Person[77]["武功等级2"] = 999
  end
end

--迷之少女挑战刀剑双绝
PNLBD[280] = function()
	--苗人凤
	JY.Person[3]["武功2"] = 67
	JY.Person[3]["武功等级2"] = 999
	JY.Person[3]["携带物品1"] = -1
	JY.Person[3]["携带物品2"] = -1
	JY.Person[3]["携带物品3"] = -1
	JY.Person[3]["携带物品数量1"] = 0
	JY.Person[3]["携带物品数量2"] = 0
	JY.Person[3]["携带物品数量3"] = 0
end

--射邪一灯居
PNLBD[68] = function()
	--郭靖
	JY.Person[55]["生命"] = 3200
	JY.Person[55]["生命最大值"] = 3200
	--黄蓉
	JY.Person[56]["生命"] = 2800
	JY.Person[56]["生命最大值"] = 2800
	JY.Person[56]["内力"] = 3200
	JY.Person[56]["内力最大值"] = 3200
	JY.Person[56]["携带物品1"] = -1
	JY.Person[56]["携带物品2"] = -1
	JY.Person[56]["携带物品3"] = -1
	JY.Person[56]["携带物品数量1"] = 0
	JY.Person[56]["携带物品数量2"] = 0
	JY.Person[56]["携带物品数量3"] = 0
end

--神正杨过单金轮
PNLBD[275] = function()
	JY.Person[62]["生命"] = 5000
	JY.Person[62]["生命最大值"] = 5000
	JY.Person[62]["内力"] = 7999
	JY.Person[62]["内力最大值"] = 7999
	JY.Person[62]["武功2"] = 169
	JY.Person[62]["武功等级2"] = 999
end

--战四大山
PNLBD[290] = function()
    JY.Person[642]["武功1"] = 173
	JY.Person[642]["武功2"] = 172
	JY.Person[642]["武功3"] = 192
	--远古神蛤
	JY.Person[190]["姓名"] = "远古神蛤"
	JY.Person[190]["生命"] = 8000
	JY.Person[190]["生命最大值"] = 8000
	JY.Person[190]["内力"] = 9999
	JY.Person[190]["内力最大值"] = 9999
	JY.Person[190]["内力性质"] = 0
	JY.Person[190]["攻击力"] = 300
	JY.Person[190]["防御力"] = 300
	JY.Person[190]["轻功"] = 250
	JY.Person[190]["武功1"] = 22
	JY.Person[190]["武功等级1"] = 999
	JY.Person[190]["武功2"] = 108
	JY.Person[190]["武功等级2"] = 999
	JY.Person[190]["武功3"] = 145
	JY.Person[190]["武功等级3"] = 999
	JY.Person[190]["武功4"] = 96
	JY.Person[190]["武功等级4"] = 999
	JY.Person[190]["武功5"] = 144
	JY.Person[190]["武功等级5"] = 999
	JY.Person[190]["天赋外功1"] = 22
	JY.Person[190]["天赋内功"] = 108
	JY.Person[190]["天赋轻功"] = 145
	JY.Person[190]["实战"] = 500
	--亿年雪人
	JY.Person[429]["姓名"] = "亿年雪人"
	JY.Person[429]["生命"] = 8000
	JY.Person[429]["生命最大值"] = 8000
	JY.Person[429]["内力"] = 9999
	JY.Person[429]["内力最大值"] = 9999
	JY.Person[429]["内力性质"] = -3
	JY.Person[429]["攻击力"] = 400
	JY.Person[429]["防御力"] = 250
	JY.Person[429]["轻功"] = 200
	JY.Person[429]["武功1"] = 156
	JY.Person[429]["武功等级1"] = 999
	JY.Person[429]["武功2"] = 107
	JY.Person[429]["武功等级2"] = 999
	JY.Person[429]["武功3"] = 148
	JY.Person[429]["武功等级3"] = 999
	JY.Person[429]["武功4"] = 104
	JY.Person[429]["武功等级4"] = 999
	JY.Person[429]["武功5"] = 92
	JY.Person[429]["武功等级5"] = 999
	JY.Person[429]["天赋外功1"] = 156
	JY.Person[429]["天赋内功"] = 107
	JY.Person[429]["天赋轻功"] = 148
	JY.Person[429]["实战"] = 500
	--蜘蛛尊者
	JY.Person[439]["姓名"] = "蜘蛛尊者"
	JY.Person[439]["生命"] = 8000
	JY.Person[439]["生命最大值"] = 8000
	JY.Person[439]["内力"] = 9999
	JY.Person[439]["内力最大值"] = 9999
	JY.Person[439]["内力性质"] = 3
	JY.Person[439]["攻击力"] = 250
	JY.Person[439]["防御力"] = 400
	JY.Person[439]["轻功"] = 200
	JY.Person[439]["武功1"] = 66
	JY.Person[439]["武功等级1"] = 999
	JY.Person[439]["武功2"] = 106
	JY.Person[439]["武功等级2"] = 999
	JY.Person[439]["武功3"] = 147
	JY.Person[439]["武功等级3"] = 999
	JY.Person[439]["武功4"] = 169
	JY.Person[439]["武功等级4"] = 999
	JY.Person[439]["武功5"] = 103
	JY.Person[439]["武功等级5"] = 999
	JY.Person[439]["天赋外功1"] = 66
	JY.Person[439]["天赋内功"] = 106
	JY.Person[439]["天赋轻功"] = 147
	JY.Person[439]["实战"] = 500
end

--剑魔剑仙
PNLBD[291] = function()
	--阿青
	JY.Person[604]["内力"] = 9999
	JY.Person[604]["内力最大值"] = 9999
	JY.Person[604]["防御力"] = 300
	JY.Person[604]["轻功"] = 400
	JY.Person[604]["御剑能力"] = 320
end

--十五大
PNLBD[133] = function()
	JY.Person[62]["武功3"] = 169
	JY.Person[62]["武功等级3"] = 999
	JY.Person[62]["天赋内功"] = 169
	JY.Person[62]["生命"] = 3600
	JY.Person[62]["生命最大值"] = 3600
	JY.Person[62]["内力"] = 5000
	JY.Person[62]["内力最大值"] = 5000
end

--二十大
PNLBD[289] = function()
	--王重阳
	JY.Person[129]["生命"] = 6000
	JY.Person[129]["生命最大值"] = 6000
	JY.Person[129]["武功2"] = 107
	
	--黄药师
	JY.Person[57]["生命"] = 6000
	JY.Person[57]["生命最大值"] = 6000
	JY.Person[57]["武功2"] = 107
	JY.Person[57]["武功等级2"] = 999
	JY.Person[57]["武功3"] = 12
	JY.Person[57]["武功等级3"] = 999
	JY.Person[57]["武功4"] = 38
	JY.Person[57]["武功等级4"] = 999
	JY.Person[57]["内力"] = 5000
	JY.Person[57]["内力最大值"] = 5000
	--欧阳锋
	JY.Person[60]["生命"] = 6000
	JY.Person[60]["生命最大值"] = 6000
	JY.Person[60]["武功3"] = 81
	JY.Person[60]["武功等级3"] = 999
	JY.Person[60]["武功4"] = 107
	JY.Person[60]["武功等级4"] = 999
	JY.Person[60]["内力"] = 5000
	JY.Person[60]["内力最大值"] = 5000
	--一灯
	JY.Person[65]["生命"] = 6000
	JY.Person[65]["生命最大值"] = 6000
	JY.Person[65]["武功3"] = 107
	JY.Person[65]["武功等级3"] = 999
	JY.Person[65]["内力"] = 5000
	JY.Person[65]["内力最大值"] = 5000
	--洪七公
	JY.Person[69]["生命"] = 6000
	JY.Person[69]["生命最大值"] = 6000
	JY.Person[69]["武功3"] = 107
	JY.Person[69]["武功等级3"] = 999
	JY.Person[69]["内力"] = 5000
	JY.Person[69]["内力最大值"] = 5000
	--周伯通
	JY.Person[64]["生命"] = 6000
	JY.Person[64]["生命最大值"] = 6000
	JY.Person[64]["武功等级2"] = 999
	JY.Person[64]["武功3"] = 16
	JY.Person[64]["武功等级3"] = 999
	--风清扬
	JY.Person[140]["生命"] = 6000
	JY.Person[140]["生命最大值"] = 6000
	JY.Person[140]["武功3"] = 108
	JY.Person[140]["武功等级3"] = 999
	--金轮
	JY.Person[62]["武功3"] = 158
	JY.Person[62]["武功等级3"] = 999
	JY.Person[62]["生命"] = 6000
	JY.Person[62]["生命最大值"] = 6000
	JY.Person[62]["内力"] = 5000
	JY.Person[62]["内力最大值"] = 5000
	--张三丰
	JY.Person[5]["生命"] = 6000
	JY.Person[5]["生命最大值"] = 6000
	JY.Person[5]["内力"] = 7000
	JY.Person[5]["内力最大值"] = 7000
	--慕容博
	JY.Person[113]["生命"] = 6000
	JY.Person[113]["生命最大值"] = 6000
	JY.Person[113]["攻击力"] = 150
	JY.Person[113]["防御力"] = 150
	JY.Person[113]["武功2"] = 136
	JY.Person[113]["武功等级2"] = 999
	JY.Person[113]["武功3"] = 137
	JY.Person[113]["武功等级3"] = 999
	JY.Person[113]["武功4"] = 133
	JY.Person[113]["武功等级4"] = 999
	JY.Person[113]["武功5"] = 132
	JY.Person[113]["武功等级5"] = 999
	JY.Person[113]["天赋内功"] = 108
	--萧远山
	JY.Person[112]["生命"] = 6000
	JY.Person[112]["生命最大值"] = 6000
	JY.Person[112]["武功3"] = 108
	JY.Person[112]["武功等级3"] = 999
	JY.Person[112]["内力"] = 6000
	JY.Person[112]["内力最大值"] = 6000
	--鸠摩智
	JY.Person[103]["生命"] = 6000
	JY.Person[103]["生命最大值"] = 6000
	JY.Person[103]["武功3"] = 108
	JY.Person[103]["武功等级3"] = 999
	JY.Person[103]["内力"] = 6000
	JY.Person[103]["内力最大值"] = 6000
	JY.Person[103]["生命"] = 4000
	JY.Person[103]["生命最大值"] = 4000
	--乔峰
	JY.Person[50]["生命"] = 6000
	JY.Person[50]["生命最大值"] = 6000
	JY.Person[50]["武功3"] = 108
	JY.Person[50]["武功等级3"] = 999
	--扫地老僧
	JY.Person[114]["生命"] = 6000
	JY.Person[114]["生命最大值"] = 6000
end

PNLBD[218] = function()
JY.Person[70]["姓名"] = "方生"
JY.Person[169]["姓名"] = "方闻"
JY.Person[170]["姓名"] = "方性"
end
PNLBD[223] = function()
JY.Person[170]["姓名"] = "空性"
end
PNLBD[149] = function()
JY.Person[170]["姓名"] = "空性"
end
PNLBD[134] = function()
JY.Person[70]["姓名"] = "玄慈"
JY.Person[169]["姓名"] = "空闻"
JY.Person[170]["姓名"] = "空性"
end
PNLBD[80] = function()
JY.Person[70]["姓名"] = "玄慈"
JY.Person[169]["姓名"] = "玄闻"
JY.Person[170]["姓名"] = "玄性"
end
--笑正
PNLBD[297] = function()
	--左冷禅
	JY.Person[22]["生命"] = 3200
	JY.Person[22]["生命最大值"] = 3200
	JY.Person[22]["武功2"] = 30
	JY.Person[22]["武功等级2"] = 999
	JY.Person[22]["武功3"] = 31
	JY.Person[22]["武功等级3"] = 999
	JY.Person[22]["武功4"] = 32
	JY.Person[22]["武功等级4"] = 999
	JY.Person[22]["武功5"] = 34
	JY.Person[22]["武功等级5"] = 999
	JY.Person[22]["武功6"] = 175
	JY.Person[22]["武功等级6"] = 900
	--林平之
	JY.Person[36]["生命"] = 2800
	JY.Person[36]["生命最大值"] = 2800
	JY.Person[36]["内力"] = 4800
	JY.Person[36]["内力最大值"] = 4800
	JY.Person[36]["武功等级1"] = 999
	if JY.Base["畅想"] ~= 36 then
	 if JY.Person[36]["天1"] == 0 then
        JY.Person[36]["天1"] = math.random(2)
	 end
	 if JY.Person[36]["天2"] == 0 then
        JY.Person[36]["天2"] = 2
	 end
	 if JY.Person[36]["天3"] == 0 then
        JY.Person[36]["天3"] = math.random(2)
	 end
        JY.Person[36]["天4"] = 1
	end	
end

PNLBD[305] = function()
	--达摩
	JY.Person[652]["武功3"] = 96
	JY.Person[652]["武功等级3"] = 999
	JY.Person[652]["武功4"] = 144
	JY.Person[652]["武功等级4"] = 999
end

--三挑岳不群
PNLBD[298] = function()
	JY.Person[19]["生命"] = 3600
	JY.Person[19]["生命最大值"] = 3600
	JY.Person[19]["攻击力"] = 250
	JY.Person[19]["防御力"] = 250
	JY.Person[19]["轻功"] = 270
	JY.Person[19]["天赋内功"] = 105
	JY.Person[19]["武功3"] = 175
	JY.Person[19]["武功等级3"] = 900
end

--大战神雕
PNLBD[304] = function()
	JY.Person[628]["生命"] = 3200
	JY.Person[628]["生命最大值"] = 3200
end

--圆月弯刀
PNLBD[308] = function()
	if JY.Person[654]["品德"] == 90 then
		JY.Person[654]["生命"] = 2400
		JY.Person[654]["生命最大值"] = 2400
		JY.Person[654]["内力"] = 3000
		JY.Person[654]["内力最大值"] = 3000
		JY.Person[654]["攻击力"] = 120
		JY.Person[654]["防御力"] = 120
		JY.Person[654]["轻功"] = 100
	elseif JY.Person[654]["品德"] == 91 then
		JY.Person[654]["生命"] = 2800
		JY.Person[654]["生命最大值"] = 2800
		JY.Person[654]["内力"] = 5000
		JY.Person[654]["内力最大值"] = 5000
		JY.Person[654]["攻击力"] = 200
		JY.Person[654]["防御力"] = 200
		JY.Person[654]["轻功"] = 150
	elseif JY.Person[654]["品德"] == 92 then
		JY.Person[654]["生命"] = 3200
		JY.Person[654]["生命最大值"] = 3200
		JY.Person[654]["内力"] = 7000
		JY.Person[654]["内力最大值"] = 7000
		JY.Person[654]["攻击力"] = 300
		JY.Person[654]["防御力"] = 300
		JY.Person[654]["轻功"] = 200
		JY.Person[654]["天赋内功"] = 160
		JY.Person[654]["武功2"] = 160
		JY.Person[654]["武功等级2"] = 999
	end
	if JY.Base["畅想"] == 691 then
		JY.Person[654]["生命最大值"] = math.modf(JY.Person[654]["生命最大值"]*0.66)
		JY.Person[654]["内力最大值"] = math.modf(JY.Person[654]["内力最大值"]*0.66)
		JY.Person[654]["生命"] = JY.Person[654]["生命最大值"]
		JY.Person[654]["内力"] = JY.Person[654]["内力最大值"]
	end
end


--黄蓉：奇门遁甲
function WarNewLand(id, x, y)
	if WAR.ZDDH == 226 then
		return 
	end
	local r = JYMsgBox("奇门遁甲", "是否要开启奇门遁甲？", {"否","是"}, 2, WAR.tmp[5000+id])
	if r == 1 then
		return 
	end
	local s = WAR.CurID
	WAR.CurID =  id
	--1绿色，2红色，3蓝色，4紫色
	CleanWarMap(6,-1);
	    	
	local QMDJ = {"休","生","伤","杜","景","死","惊","开"}
				
	--在自身周围绘制奇阵
	SetWarMap(x, y, 6, math.random(4));
	    		
	for j=1, 2 do
	    SetWarMap(x + math.random(6), y + math.random(6), 6, math.random(4));
		for i = 30, 40 do
			NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			if i == 40 then
				lib.Delay(300)
				Cls()
			else
				lib.Delay(1)
			end
		end
	end
				
	for j=3, 4 do
		SetWarMap(x + math.random(6), y - math.random(6), 6, math.random(4));
		for i = 30, 40 do
			NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			if i == 40 then
				lib.Delay(300)
				Cls()
			else
				lib.Delay(1)
			end
		end
	end
				
	for j=5, 6 do
	    SetWarMap(x - math.random(6), y - math.random(6), 6, math.random(4));
		for i = 30, 40 do
			NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			if i == 40 then
				lib.Delay(300)
				Cls()
			else
				lib.Delay(1)
			end
		end
	end
				
	for j=7, 8 do
		SetWarMap(x - math.random(6), y + math.random(6), 6, math.random(4));
		for i = 30, 40 do
			NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			if i == 40 then
				lib.Delay(300)
				Cls()
			else
				lib.Delay(1)
			end
		end
	end
	
	WAR.CurID =  s
end
		
--战斗主函数
function WarMain(warid, isexp)
	WarLoad(warid)			--初始化战斗数据
	WarSelectTeam_Enhance()	--选择我方（优化版）
	WarSelectEnemy()		--选择敌人
 
	if JY.Restart == 1 then
		return false
	end
	
	CleanMemory()
	lib.PicInit()
	lib.ShowSlow(20, 1)
	WarLoadMap(WAR.Data["地图"])	--加载战斗地图
	
	--默认在当前场景战斗
	local BattleField = JY.SubScene
	
	--倚天正线拿九阳战斗/潮汐四连
	if WAR.ZDDH == 287 or WAR.ZDDH == 310 or WAR.ZDDH == 313 or WAR.ZDDH > 315 and WAR.ZDDH < 324 and WAR.ZDDH ~= 321 or WAR.ZDDH == 328 or WAR.ZDDH == 329 or WAR.ZDDH == 330 then
		BattleField = 116
	end

	for i = 0, CC.WarWidth-1 do
		for j = 0, CC.WarHeight-1 do
			lib.SetWarMap(i, j, 0, lib.GetS(BattleField, i, j, 0))
			lib.SetWarMap(i, j, 1, lib.GetS(BattleField, i, j, 1))
		end
	end
  
	--雪山落花流水战役
	if WAR.ZDDH == 42 then
		SetS(2, 24, 31, 1, 0)
		SetS(2, 30, 34, 1, 0)
		SetS(2, 27, 27, 1, 0)
	end
	
	--[[最终战
	if WAR.ZDDH == 312 or WAR.ZDDH == 314 then
	    WAR.ZZZ = {}
	    if JY.Base["单通"] == 1 then
	       WAR.ZZZZ = JY.Person[0]["生命最大值"]
           JY.Person[0]["生命"] = JY.Person[0]["生命"]*2
           JY.Person[0]["生命最大值"] = JY.Person[0]["生命最大值"]*2
        else 
           for i = 0, WAR.PersonNum - 1 do
		   local id = WAR.Person[i]["人物编号"]
		   WAR.ZZZ[id] = JY.Person[id]["生命最大值"]
		   if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] then
			if JY.Base["畅想"] == 673 and id == 0 then
			   JY.Person[id]["生命"] = JY.Person[id]["生命"]+JY.Base["难度"]*140
               JY.Person[id]["生命最大值"] = JY.Person[id]["生命最大值"]+JY.Base["难度"]*140
			else
               JY.Person[id]["生命"] = JY.Person[id]["生命"]+JY.Base["难度"]*200
               JY.Person[id]["生命最大值"] = JY.Person[id]["生命最大值"]+JY.Base["难度"]*200		
			end   
		   end
           end
        end
	end]]
	
		
  
	--旧版华山论剑的擂台
	if WAR.ZDDH == 238 then
		for x = 24, 34 do
			for y = 24, 34 do
				lib.SetWarMap(x, y, 0, 1030)
			end
		end
		for y = 23, 35 do
			lib.SetWarMap(23, y, 1, 1174)
			lib.SetWarMap(35, y, 1, 1174)
		end
		for x = 24, 35 do
			lib.SetWarMap(x, 35, 1, 1174)
			lib.SetWarMap(x, 23, 1, 1174)
		end
		lib.SetWarMap(23, 23, 0, 1174)
		lib.SetWarMap(35, 35, 0, 1174)
		lib.SetWarMap(23, 35, 0, 1174)
		lib.SetWarMap(35, 23, 0, 1174)
		lib.SetWarMap(23, 23, 1, 2960)
		lib.SetWarMap(35, 35, 1, 2960)
		lib.SetWarMap(23, 35, 1, 2960)
		lib.SetWarMap(35, 23, 1, 2960)
	end
	
	--20大高手，修正地形
	if WAR.ZDDH == 289 then
		lib.SetWarMap(39, 29, 1, 1417*2)
		lib.SetWarMap(39, 30, 1, 1416*2)
		lib.SetWarMap(39, 31, 1, 1416*2)
		lib.SetWarMap(39, 32, 1, 1417*2)
		for i = 40, 43 do
			lib.SetWarMap(i, 30, 0, 35*2)
			lib.SetWarMap(i, 31, 0, 35*2)
			lib.SetWarMap(i, 32, 0, 35*2)
			lib.SetWarMap(i, 30, 1, 0)
			lib.SetWarMap(i, 32, 1, 0)
		end
		for i = 30, 32 do
			lib.SetWarMap(40, i, 0, 76*2)
			lib.SetWarMap(41, i, 0, 72*2)
		end
		lib.SetWarMap(15, 19, 1, 1843*2)
		lib.SetWarMap(15, 20, 1, 1843*2)
	end
	
	--战四大山，修正地形
	if WAR.ZDDH == 290 then
		for i = 5, 34 do
			lib.SetWarMap(7, i, 1, 0)
			lib.SetWarMap(9, i, 1, 0)
			lib.SetWarMap(54, i, 1, 0)
			lib.SetWarMap(56, i, 1, 0)
		end
	end
  
	--杀东方不败
	if WAR.ZDDH == 54 then
		lib.SetWarMap(11, 36, 1, 2)
	end
  
	--改变游戏状态
	JY.Status = GAME_WMAP
	  
	--加载贴图文件
	lib.PicLoadFile(CC.WMAPPicFile[1], CC.WMAPPicFile[2], 0)						--战场贴图，内存区域0
	
	lib.LoadPNGPath(CC.HeadPath, 1, CC.HeadNum, limitX(CC.ScreenW/936*100,0,100))	--人物大头像，内存区域1
	
	lib.PicLoadFile(CC.ThingPicFile[1], CC.ThingPicFile[2], 2, 100, 100)			--物品贴图，内存区域2
	
	lib.PicLoadFile(CC.EFTFile[1], CC.EFTFile[2], 3)								--特效贴图，内存区域3
	
	lib.LoadPNGPath(CC.PTPath, 95, CC.PTNum, limitX(CC.ScreenW/936*100,0,100))
	
	lib.LoadPNGPath(CC.UIPath, 96, CC.UINum, limitX(CC.ScreenW/936*100,0,100))
	
	lib.LoadPNGPath(CC.IconPath, 98, CC.IconNum, limitX(CC.ScreenW/936*100,0,100))	--状态图标，内存区域98
	
	lib.LoadPNGPath(CC.HeadPath, 99, CC.HeadNum, 26.923076923)						--人物小头像，用于集气条，内存区域99

	--无酒不欢：随机战斗音乐
	local zdyy = math.random(10) + 99
	
	--15大固定
	if WAR.ZDDH == 133 or WAR.ZDDH == 134 then
		zdyy = 27
	end
	
	--VS少林诸僧战固定
	if WAR.ZDDH == 80 then
		zdyy = 22
	end
	
	--葵花尊者战固定
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 then
		zdyy = 112
	end

	--侠客邪固定
	if WAR.ZDDH == 170 then
		zdyy = 119
	end
	
	--蒙哥战固定
	if WAR.ZDDH == 278 then
		zdyy = 110
	end
	
	--武当战三丰固定
	if WAR.ZDDH == 22 then
		zdyy = 113
	end
	
	--20大高手战固定
	if WAR.ZDDH == 289 then
		zdyy = 115
	end
	
	--战四大山固定
	if WAR.ZDDH == 290 then
		zdyy = 117
	end
	
	--剑魔剑仙固定
	if WAR.ZDDH == 291 then
		zdyy = 118
	end
	
	if JY.Base["畅想"] == 692 then
	if WAR.ZDDH > 311 and WAR.ZDDH < 316 or WAR.ZDDH == 321 or WAR.ZDDH == 289 or WAR.ZDDH == 133 or WAR.ZDDH == 134 then
		zdyy = 126
	end
	end
	
	if JY.Base["畅想"] == 693 and JY.Person[693]["阶"] >= 1 and math.random(100) >= 50 then
		zdyy = 127
	end
	
	if WAR.ZDDH == 315 or WAR.ZDDH == 313 then
		zdyy = 125
	end
	
	if WAR.ZDDH == 318 then
	   if math.random(2) == 1 then
	   zdyy = 123
	   else
	   zdyy = 124
	   end
	end
	
	PlayMIDI(zdyy)
	
	--PlayMIDI(WAR.Data["音乐"])  
	  
	local warStatus = nil		 --战斗状态
  
	WarPersonSort()			--按轻功排序
	CleanWarMap(2, -1)
	CleanWarMap(6, -2)
	  

	for i = 0, WAR.PersonNum - 1 do
		
		if i == 0 then
		  WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"] = WE_xy(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"])
		else
		  WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"] = WE_xy(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], i)
		end
		
		SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 2, i)
		
		local pid = WAR.Person[i]["人物编号"]
		lib.PicLoadFile(string.format(CC.FightPicFile[1], JY.Person[pid]["头像代号"]), string.format(CC.FightPicFile[2], JY.Person[pid]["头像代号"]), 4 + i)	--人物战斗动作贴图，内存区域4-29（一场战斗上限26人）
		
		--Alungky 用5000数组来保存头像数据
		--主角的数据要特殊处理
		if pid == 0 and JY.Base["畅想"] == 0 then
			if JY.Base["标准"] > 0 then
				if JY.Person[0]["性别"] == 0 then
					WAR.tmp[5000+i] = 280 + JY.Base["标准"]
				else
					WAR.tmp[5000+i] = 500 + JY.Base["标准"]
				end
			--特殊
			elseif JY.Base["特殊"] == 1 then
				if JY.Person[0]["性别"] == 0 then
					WAR.tmp[5000+i] = 290
				else
					WAR.tmp[5000+i] = 368
				end
			else
				WAR.tmp[5000+i] = JY.Person[pid]["头像代号"]
			end
		else
			WAR.tmp[5000+i] = JY.Person[pid]["头像代号"]
		end
	end
	  
	--轻功对移动格子的计算
	--x为战场轻功，y为体力
	local function getnewmove(x, y)
		local mob = x + y
		if mob > 578 then
			return 10
		elseif mob > 478 then
			return 9
		elseif mob > 378 then
			return 8
		elseif mob > 293 then
			return 7
		elseif mob > 228 then
			return 6
		elseif mob > 178 then
			return 5
		elseif mob > 148 then
			return 4
		elseif mob > 126 then
			return 3
		elseif mob > 116 then
			return 2
		else
			return 1
		end
	end
	local function getdelay(x, y)
		return math.modf(1.5 * (x / y + y - 3))
	end
	
	for i = 0, WAR.PersonNum - 1 do
		WAR.Person[i]["贴图"] = WarCalPersonPic(i)
	end
	WarSetPerson()
	WAR.CurID = 0
	WarDrawMap(0)
	lib.ShowSlow(20, 0)
	  
	--无酒不欢：设置人物的初始集气位置
	for i = 0, WAR.PersonNum - 1 do
		WAR.Person[i].Time = 800 - i * 1000 / WAR.PersonNum
		
		if JY.Base["难度"]==7 and WAR.Person[i]["我方"] == true and WAR.ZDDH ~= 329 then
			WAR.Person[i].Time = 0
		elseif JY.Base["难度"]==8 and WAR.Person[i]["我方"] == true and WAR.ZDDH ~= 329 then
		    WAR.Person[i].Time = -200
		end
		if JY.Base["难度"]<7 and JY.Base["难度"] >= 3 and WAR.Person[i]["我方"] == true and WAR.ZDDH ~= 329 then
			WAR.Person[i].Time = WAR.Person[i].Time	- JY.Base["难度"]*20
		end
				
		--岳灵珊 每个剑法+50点初始集气
		if match_ID(WAR.Person[i]["人物编号"], 79) then
			local JF = 0
			local bh = WAR.Person[i]["人物编号"]
			for i = 1, JY.Person[671]["品德"] do
				if JY.Wugong[JY.Person[bh]["武功" .. i]]["武功类型"] == 3 then
					JF = JF + 1
				end
			end
			WAR.Person[i].Time = WAR.Person[i].Time + (JF) * 50
		end
		
		if WAR.Person[i].Time > 990 then
			WAR.Person[i].Time = 990
		end
		
		--令狐冲，一觉之后，初始满集气
		if match_ID_awakened(WAR.Person[i]["人物编号"], 35, 1) then
			WAR.Person[i].Time = WAR.Person[i].Time + 498
		end
		
		--无酒不欢，至高无上
		if JY.Base["特殊"] ==1 and JY.Person[28]["血量翻倍"]==1 and WAR.Person[i]["人物编号"]==0 then
			WAR.Person[i].Time = WAR.Person[i].Time + 250
		end
		
		--独孤求败，初始满集气
		if match_ID(WAR.Person[i]["人物编号"], 592) then
			WAR.Person[i].Time = WAR.Person[i].Time + 499
		end
		
		--血刀老祖 初始集气900
		if match_ID(WAR.Person[i]["人物编号"], 97) then
			WAR.Person[i].Time = WAR.Person[i].Time + 400
		end
		
		--太监初始集气-200	
		if JY.Person[WAR.Person[i]["人物编号"]]["性别"] == 2 then
			WAR.Person[i].Time = WAR.Person[i].Time - 200	
		end
		
		--林平之 初始集气900
		if match_ID(WAR.Person[i]["人物编号"], 36) then
			WAR.Person[i].Time = WAR.Person[i].Time + 400
		end
		
		--木桩的初始集气
		if WAR.Person[i]["人物编号"] == 591 and WAR.ZDDH == 226 then
			WAR.Person[i].Time = 0
		end
		
		--圣火神功 初始集气加200和100随机
		local id = WAR.Person[i]["人物编号"]
		if PersonKF(id, 93) then
			WAR.Person[i].Time = WAR.Person[i].Time + 300
		end
		if WAR.Person[i].Time > 990 then
			WAR.Person[i].Time = 990
		end	
		if WAR.Person[i].Time < -450 then
			WAR.Person[i].Time = -450
		end
		
		--豪鬼，初始集气
	    if match_ID(WAR.Person[i]["人物编号"], 673) and WAR.Person[i]["人物编号"] == 0 then
		   WAR.Person[i].Time = 500
	    end
		
		if match_ID(WAR.Person[i]["人物编号"], 66) and JY.Person[66]["阶"] >= 2 then
		   if WAR.Person[i].Time < 700 then
		      WAR.Person[i].Time = 700
		   end
	    end
		
		--论剑打赢阿凡提奖励，绝对先手，且全场敌方位置-500
		if WAR.Person[i]["人物编号"] == 0 and JY.Person[606]["论剑奖励"] == 1 then
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] then
					WAR.Person[j].Time = WAR.Person[j].Time - 75 + math.modf(JY.Person[124]["天1"]*2.1)
				else
					WAR.Person[j].Time = WAR.Person[j].Time - 500 + JY.Person[124]["天1"]*10
				end
				if WAR.Person[j].Time < -450 then
					WAR.Person[j].Time = -450
				end
				if WAR.Person[j].Time > 990 then
					WAR.Person[j].Time = 990
				end
			end
			WAR.Person[i].Time = WAR.Person[i].Time + 1005 - JY.Person[124]["天1"]*30
		end
		
		if match_ID(WAR.Person[i]["人物编号"], 692) and JY.Person[692]["天1"] == 2 then
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] then
					WAR.Person[j].Time = WAR.Person[j].Time - 10
				else
					WAR.Person[j].Time = WAR.Person[j].Time - 200
				end
				if WAR.Person[j].Time < -450 then
					WAR.Person[j].Time = -450
				end
				if WAR.Person[j].Time > 990 then
					WAR.Person[j].Time = 990
				end
			end
			WAR.Person[i].Time = WAR.Person[i].Time + 1005
	    end
	
		--移动步数在此
		WAR.Person[i]["移动步数"] = math.modf(getnewmove(WAR.Person[i]["轻功"], JY.Person[id]["体力"]) - JY.Person[id]["中毒程度"] / 50 - JY.Person[id]["受伤程度"] / 50)
		if WAR.Person[i]["移动步数"] < 1 then
			WAR.Person[i]["移动步数"] = 1
		end
	end
  
	--携带物品的初始化
	for a = 0, WAR.PersonNum - 1 do
		for s = 1, 4 do
			if JY.Person[WAR.Person[a]["人物编号"]]["携带物品数量" .. s] == nil or JY.Person[WAR.Person[a]["人物编号"]]["携带物品数量" .. s] < 1 then
				JY.Person[WAR.Person[a]["人物编号"]]["携带物品" .. s] = -1
				JY.Person[WAR.Person[a]["人物编号"]]["携带物品数量" .. s] = 0;
			end
		end
	end
	
	--笑傲邪线，黑木崖如果单挑东方不败，则东方会以葵花尊者形态出战
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 then
		local dfid;
		for i = 0, WAR.PersonNum - 1 do
			local id = WAR.Person[i]["人物编号"]
			if id == 27 then
				dfid = i;
				break
			end
		end
		local orid = WAR.CurID
		WAR.CurID = dfid
		
		Cls()
		local KHZZ = {"面对本座","对方竟敢单独出战","伤自尊啊"}
		
		for i = 1, #KHZZ do
			lib.GetKey()
			DrawString(-1, -1, KHZZ[i], C_GOLD, CC.Fontsmall)
			ShowScreen()
			Cls()
			lib.Delay(1000)
		end
		
		CurIDTXDH(WAR.CurID, 7, 1)
		
		lib.Background(0,200,CC.ScreenW,400,78)
		NewDrawString(CC.ScreenW, CC.ScreenH/2 + 160, "葵花诀尊者形态", C_GOLD, 80)
		NewDrawString(CC.ScreenW, CC.ScreenH/2 + 360, "看吧 东方在赤红的燃烧", C_RED, 70)
		
		ShowScreen()
		Cls()
		lib.Delay(2000)
		
		local KHZZ2 = {"不知死活的"..JY.Person[0]["外号2"],"好好体验一下死亡的恐怖吧"}
		
		for i = 1, #KHZZ2 do
			lib.GetKey()
			DrawString(-1, -1, KHZZ2[i], C_GOLD, CC.Fontsmall)
			ShowScreen()
			Cls()
			lib.Delay(1000)
		end
		
		WAR.CurID = orid
	end
	  
	--圣火三使战开局的文字特效
	if WAR.ZDDH == 14 then
		say("Ｇ１妙风使！", 173, 0)
		say("Ｇ１流云使！", 174, 1)
		say("Ｇ１辉月使！Ｈ圣火三绝阵！", 175, 5)
		for i = 15, 35 do
			lib.GetKey()
			NewDrawString(-1, -1, "圣火三绝阵", C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			Cls()
			if i == 35 then
				lib.Delay(500)
			else
				lib.Delay(5)
			end
		end
	end
	
	--单挑谢无悠开局的文字特效
	if WAR.ZDDH == 245 and JY.Person[596]["姓名"]=="谢无悠" then
		for i = 15, 35 do
			lib.GetKey()
			NewDrawString(-1, -1, "九天一流 世间无悠", C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			Cls()
			if i == 35 then
				lib.Delay(500)
			else
				lib.Delay(5)
			end
		end
	end
	
	--单挑无酒不欢开局的文字特效
	if WAR.ZDDH == 245 and JY.Person[596]["姓名"]=="无酒不欢" then
		say("Ｄ２御剑乘风来，除魔天地间，有酒乐逍遥，无酒我亦癫。", 290, 0,"无酒不欢")
	end
	
	--侠客正太玄战李白对话
	if WAR.ZDDH == 302 then
		say("Ｄ２蓬莱文章建安骨，中间小谢又清发。", 361, 0,"李白")
		say("Ｄ２俱怀逸兴壮思飞，欲上青天览明月。", 0, 1)
		say("Ｄ２抽刀断水水更流，举杯消愁愁更愁。", 361, 0,"李白")
		say("Ｄ２人生在世不称意，明朝散发弄扁舟。", 0, 1)
	end
	
	--天正第五战慕容复开局幻梦 慕容博 丁春秋参战
	if WAR.ZDDH == 81 then
		local dfid
		for i = 0, WAR.PersonNum - 1 do
			local id = WAR.Person[i]["人物编号"]
			if id == 51 then
				dfid = i
				break
			end
		end
		local orid = WAR.CurID
		WAR.CurID = dfid
		Cls()
		say("Ｒ２＜今日一战，如果败了，我慕容复还有何颜面再苟活于世？定要殊死一搏！＞", 51, 0)
		WAR.TZ_MRF = 1
		CurIDTXDH(WAR.CurID, 127,1, "顾盼子孙贤 铭记复国志", C_GOLD)
		WAR.CurID = orid
		say("Ｒ２＜大燕国当年慕容、慕容恪、慕容垂、慕容德、慕容龙城何等英雄，却不料都变成了断种绝代的无后之人！＞", 113, 0)
		NewWARPersonZJ(113, false, 50, 24, false, 2)
				JY.Person[113]["主运内功"]=190
				JY.Person[113]["主运轻功"]=191
				JY.Person[113]["生命"] = 4000
				JY.Person[113]["生命最大值"] = 4000
				JY.Person[113]["内力"] = 6000
				JY.Person[113]["内力最大值"] = 6000
				JY.Person[113]["武功2"] = 136
				JY.Person[113]["武功等级2"] = 999
				JY.Person[113]["武功3"] = 137
				JY.Person[113]["武功等级3"] = 999
				JY.Person[113]["武功4"] = 133
				JY.Person[113]["武功等级4"] = 999
				JY.Person[113]["武功5"] = 132
				JY.Person[113]["武功等级5"] = 999
		say("１Ｌ突然有人放开喉咙，高声唱了起来：“星河老仙，德配天地，威震寰宇，古今无比！””Ｗ", 206, 0,"星河门人")  --对话
		say("１Ｌ猛听得锣鼓丝竹响起，星河派门人大声欢呼，颂场星河老仙之声，响彻云霄，种种歌功颂德、肉麻不堪的言辞，直非常人所能想象.Ｗ", 206, 0,"星河门人")  --对话
		say("１Ｌ总之日月无星河老仙之明、天地无星宿老仙之大，自盘古氏开天辟地以来，更无第二人能有星河老仙的威德。Ｗ", 206, 0,"星河门人")  --对话
		say("１Ｌ周公、孔子、佛祖、老君，以及玉皇大帝、十殿阎王，无不甘拜下风。Ｗ", 206, 0,"星河门人")  --对话
		NewWARPersonZJ(46, false, 51, 24, false, 2)
		say("１Ｌ星河老仙，你不是死了吗？Ｗ",0,1,JY.Person[0]["姓名"])  --对话
		say("１Ｌ原来北冥神功可以重生，不打死我的话，我还不知道呢。Ｗ", 46, 1,"丁春秋")  --对话
				JY.Person[46]["主运内功"]=87
				JY.Person[46]["主运轻功"]=191
				JY.Person[46]["生命"] = 4000
				JY.Person[46]["生命最大值"] =4000
				JY.Person[46]["内力"] = 6000
				JY.Person[46]["内力最大值"] = 6000
	end
	
		--天邪第五战萧远山参战
	if WAR.ZDDH == 251 then
		local dfid
		for i = 0, WAR.PersonNum - 1 do
			local id = WAR.Person[i]["人物编号"]
			if id == 50 then
				dfid = i
				break
			end
		end
		Cls()
		say("Ｒ２＜你……你是我爹爹……＞", 50, 0)
		say("Ｒ２＜好孩子，好孩儿，我正是你的爹爹。咱爷儿俩一般的身形相貌，不用记认，谁都知道我是你的老子。＞", 112, 0)
		NewWARPersonZJ(112, false, 24, 42, false, 2)
				JY.Person[112]["主运内功"]=160
				JY.Person[112]["主运轻功"]=191
	end

	--倚正成昆居成昆呼叫小弟
	if WAR.ZDDH == 13 then
		local dfid
		for i = 0, WAR.PersonNum - 1 do
			local id = WAR.Person[i]["人物编号"]
			if id == 18 then
				dfid = i
				break
			end
		end
		Cls()	
		say("１Ｌ＜跟这些邪门歪道，不用讲什么江湖道义，大伙一起上！＞Ｗ", 18, 0,"成昆")  --对话
				NewWARPersonZJ(643, false, 28, 37, false, 2)
				NewWARPersonZJ(644, false, 28, 38, false, 2)
				NewWARPersonZJ(645, false, 29, 37, false, 2)
				NewWARPersonZJ(647, false, 29, 38, false, 2)
				NewWARPersonZJ(648, false, 30, 37, false, 2)
				JY.Person[643]["主运内功"]=190
				JY.Person[643]["主运轻功"]=191
				JY.Person[644]["主运内功"]=190
				JY.Person[644]["主运轻功"]=191
				JY.Person[645]["主运内功"]=190
				JY.Person[645]["主运轻功"]=191
				JY.Person[647]["主运内功"]=190
				JY.Person[647]["主运轻功"]=191
				JY.Person[648]["主运内功"]=190
				JY.Person[648]["主运轻功"]=191
	end
	
	--黯然开场前激活提示
	local zjid
	for i = 0, WAR.PersonNum - 1 do
		local id = WAR.Person[i]["人物编号"]
		if id == 0 then
			zjid = i
			local orid = WAR.CurID
			WAR.CurID = zjid
			for j = 1, JY.Person[671]["品德"] do
				if JY.Person[id]["武功" .. j] == 25 then
					if JY.Person[id]["受伤程度"] >= 70 or JY.Person[id]["生命"] <= (JY.Person[id]["生命最大值"] * 0.3) then
						Cls()
						CurIDTXDH(WAR.CurID, 129,1, "莫道黯然销魂，何处柳暗花明", LightPurple)
						WAR.CurID = orid
					end
				elseif JY.Person[id]["武功" .. j] < 1 then
					break
				end
			end
		end
	end
	for i = 0, WAR.PersonNum - 1 do
	local id = WAR.Person[i]["人物编号"]
		if match_ID(id, 688) and id == 0 then
			Cls()
			CurIDTXDH(i, 129,1, "勇猛无敌，七进七出", C_RED)
		end
	end

  
	--密道成昆战，我方集气全体为0
	if WAR.ZDDH == 237 then
		for a = 0, WAR.PersonNum - 1 do
			if WAR.Person[a]["我方"] == true then
				WAR.Person[a].Time = 0
			end
			if JY.Base["难度"]==7 and WAR.Person[a]["我方"] == true then
				WAR.Person[a].Time = -200
			elseif JY.Base["难度"]==8 and WAR.Person[a]["我方"] == true then
			    WAR.Person[a].Time = -400
			end
		end
	end
	
	--四大山
	if WAR.ZDDH == 315 then
		for a = 0, WAR.PersonNum - 1 do
			if WAR.Person[a]["我方"] == true then
				WAR.Person[a].Time = 0
			end
			if JY.Base["难度"]==7 and WAR.Person[a]["我方"] == true then
				WAR.Person[a].Time = -200
			elseif JY.Base["难度"]==8 and WAR.Person[a]["我方"] == true then
			    WAR.Person[a].Time = -400
			end
		end
	end
	
	--拿玄铁战神雕，我方集气全体为0
	if WAR.ZDDH == 304 or WAR.ZDDH == 330 then
		for a = 0, WAR.PersonNum - 1 do
			if WAR.Person[a]["我方"] == true then
				WAR.Person[a].Time = 0
			end
			if JY.Base["难度"]==7 and WAR.Person[a]["我方"] == true then
				WAR.Person[a].Time = -200
			elseif JY.Base["难度"]==8 and WAR.Person[a]["我方"] == true then
			    WAR.Person[a].Time = -400
			end
		end
	end
	
	--四大山
	if WAR.ZDDH >= 324 and WAR.ZDDH <= 327 then
		for a = 0, WAR.PersonNum - 1 do
			if WAR.Person[a]["我方"] == true then
				WAR.Person[a].Time = WAR.Person[a].Time - 500
				if WAR.Person[a].Time < -500 then
				   WAR.Person[a].Time = -500
				end   
			end
		end
	end
	
	for i = 0, WAR.PersonNum - 1 do
	local id = WAR.Person[i]["人物编号"]
		if match_ID(id, 689) and not match_ID(id, 642) and id == 0 then
			Cls()
			WAR.Person[i].Time = WAR.Person[i].Time + math.random(500,700)
			PlayWavAtk(144+math.random(11))
			CurIDTXDH(i, 126, 1)
		end
		if JY.Person[id]["人18"] == 1 then
		    Cls()
			WAR.Person[i].Time = WAR.Person[i].Time + 200
			CurIDTXDH(i, 153, 1)
		end
	end
	
  
	--全真七子，天罡北斗阵
	if WAR.ZDDH == 73 then
		for i = 15, 35 do
			lib.GetKey()
			NewDrawString(-1, -1, "天罡北斗阵", C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			Cls()
			if i == 35 then
				lib.Delay(500)
			else
				lib.Delay(5)
			end
		end
	end
	
	--金刚伏魔圈
	if WAR.ZDDH == 253 then
		for i = 15, 35 do
			lib.GetKey()
			NewDrawString(-1, -1, "金刚伏魔圈", C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			Cls()
			if i == 35 then
				lib.Delay(500)
			else
				lib.Delay(5)
			end
		end
	end
	
	--落花流水
	if WAR.ZDDH == 42 then
		for i = 15, 35 do
			lib.GetKey()
			NewDrawString(-1, -1, "落花流水", C_GOLD, CC.DefaultFont+i*2)
			NewDrawString(CC.ScreenW / 2 * 3 - 170, CC.ScreenH + 120, "气攻+500 气防+500", C_GOLD, 50)	
			ShowScreen()
			Cls()
			if i == 35 then
				lib.Delay(500)
			else
				lib.Delay(5)
			end
		end
	end

	--桃谷六仙
		if JY.Base["畅想"]==147 then
		for i = 15, 35 do
			lib.GetKey()
			lib.LoadPNG(1, JY.Person[147]["头像代号"]*2, CC.ScreenW / 4 - 80, CC.ScreenH / 2 - 35, 1)
			NewDrawString(-1, -1, "桃谷六仙", C_GOLD, CC.DefaultFont+i*2)
			NewDrawString(CC.ScreenW / 2 * 3 - 170, CC.ScreenH + 120, "气防+600", C_GOLD, 50)	
			ShowScreen()
			Cls()
			if i == 35 then
				lib.Delay(500)
			else
				lib.Delay(5)
			end
		end
	end
	
	--组合动画显示
	if CC.CoupleDisplay == 1 then
		local function fightcombo()
			local combo = {}
			for i = 1, #CC.COMBO do
				combo[i] = {CC.COMBO[i][1], CC.COMBO[i][2], CC.COMBO[i][3],0}
			end
			for i = 0, WAR.PersonNum - 1 do
				local t = WAR.Person[i]["人物编号"]
				for j = 1, #combo do
					lib.GetKey()
					if match_ID(t, combo[j][1]) then
						for z = 0, WAR.PersonNum - 1 do
							local t2 = WAR.Person[z]["人物编号"]
							if match_ID(t2, combo[j][2]) and WAR.Person[i]["我方"] == WAR.Person[z]["我方"] then
								combo[j][4] = 1
								break
							end
						end
					end
				end
			end
			for i = 1, #combo do
				if combo[i][4] == 1 then
					local t1 = combo[i][1]
					local t2 = combo[i][2]
					for j = 0, 10 do
						lib.GetKey()
						local str = JY.Person[t1]["姓名"].."＆"..JY.Person[t2]["姓名"]
						local str2 = combo[i][3]
						Cls()
						DrawBox(150, CC.ScreenH / 3 + 30, CC.ScreenW - 150, CC.ScreenH / 3 * 2 - 20, C_BLACK)
						lib.LoadPNG(1, JY.Person[t1]["头像代号"]*2, CC.ScreenW / 4 - 80, CC.ScreenH / 2 - 35, 1)
						lib.LoadPNG(1, JY.Person[t2]["头像代号"]*2, CC.ScreenW / 4 + 50, CC.ScreenH / 2 - 35, 1)
						NewDrawString(CC.ScreenW / 2 * 3 - 170, CC.ScreenH + 120, str, C_ORANGE, 25)	
						NewDrawString(CC.ScreenW / 2 * 3 - 170, -1, str2, C_GOLD, 50 + j)
						ShowScreen()							
						lib.Delay(30)	
					end		
					lib.Delay(400)	
				end
			end
		end
		fightcombo()
	end
	
	--四帮主之战，乔峰用铁掌
	if WAR.ZDDH == 83 then
		JY.Person[50]["武功1"] = 13
    end
  	
	warStatus = 0
	buzhen()
	
	--黄蓉奇门遁甲，我方才触发
	for j = 0, WAR.PersonNum - 1 do
		if match_ID(WAR.Person[j]["人物编号"], 56) and WAR.Person[j]["我方"] == true then
			WarNewLand(j, WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"])
			break
		end
	end
	
	--张角
	for j = 0, WAR.PersonNum - 1 do
		if match_ID(WAR.Person[j]["人物编号"], 694) and JY.Person[694]["阶"] >= 3 then
		local pid = WAR.Person[j]["人物编号"]
		   for d = 0, WAR.PersonNum - 1 do
		       local did = WAR.Person[d]["人物编号"]
		       WarDrawMap(0)
		  if JY.Person[694]["阶"] >= 1 then
	      if WAR.ZJJQ[pid] == nil then
		     WAR.ZJJQ[pid] = 1
		  else
		     WAR.ZJJQ[pid] = WAR.ZJJQ[pid] + 1
		  end	 
	      end
							local dam = math.modf(JY.Person[WAR.Person[d]["人物编号"]]["生命最大值"]*0.05 + 500 + 1.55^JY.Base["天书数量"]) + math.random(10)
							if JY.Person[694]["天4"] == 1 then
							   dam = dam + math.modf(JY.Person[WAR.Person[d]["人物编号"]]["生命最大值"]*0.05)
							end
							if JY.Person[694]["天3"] == 1 then
							   dam = math.modf(dam*1.3)
							end
							if WAR.Person[j]["我方"] ~= WAR.Person[d]["我方"] then
							SetWarMap(WAR.Person[d]["坐标X"], WAR.Person[d]["坐标Y"], 4, 1)
							SetWarMap(WAR.Person[d]["坐标X"], WAR.Person[d]["坐标Y"], 4, 4)
							WAR.Person[d]["Life_Before_Hit"] = JY.Person[WAR.Person[d]["人物编号"]]["生命"]
							--WAR.Person[d]["特效动画"] = 131
							WAR.Person[d]["生命点数"] = (WAR.Person[d]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[d]["人物编号"], "生命", -dam)
							if JY.Person[694]["天3"] == 1 then
							WAR.Person[d].TimeAdd = WAR.Person[d].TimeAdd - 300
							end
		                    end
		end
		War_ShowFight(pid, 0, 0, 0, 0, 0, 131, -1)
		local z = WAR.CurID
		WAR.CurID = j
		War_ExecuteMenu_Sub(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5)
		WAR.CurID = z
		end
		break
	end
	
	WAR.Delay = GetJiqi()
	local startt, endt = lib.GetTime()
  
 
  --战斗主循环
  while true do
	if JY.Restart == 1 then
		return false
	end
    WarDrawMap(0)
    WAR.ShowHead = 0
    DrawTimeBar()
    
    lib.GetKey()
    ShowScreen()
    if WAR.ZYHB == 1 then
		WAR.ZYHB = 2
    end
	if WAR.CLBF == 1 then
		WAR.CLBF = 2
    end
	if WAR.HSSD == 1 then
	   WAR.HSSD = 2
	end   
    
    for p = 0, WAR.PersonNum - 1 do
		lib.GetKey()

		if WAR.Person[p]["死亡"] == false and WAR.Person[p].Time > 1000 then
		local id = WAR.Person[p]["人物编号"]
		local yin, yang, tg = NeiL(id)
		local fx = yin + yang
		local times = 1
		--霍青桐: 军神再临
		if WAR.HQT_JSZL and WAR.HQT_JSZL[id] then
			times = 2
		end
		for i = 1, times do
			WarDrawMap(0)
			ShowScreen()
			local keypress = lib.GetKey()
			if WAR.AutoFight == 1 and (keypress == VK_SPACE or keypress == VK_RETURN) then
				WAR.AutoFight = 0
			end	   
			
			--左右触发之后，不可移动
			if WAR.ZYHB == 2 then
				WAR.Person[p]["移动步数"] = 0
			--特效：不可移动
			elseif WAR.HKHL[WAR.Person[p]["人物编号"]] ~= nil then
				WAR.Person[p]["移动步数"] = 0
			elseif WAR.L_NOT_MOVE[WAR.Person[p]["人物编号"]] ~= nil and WAR.L_NOT_MOVE[WAR.Person[p]["人物编号"]] == 1 then
				WAR.Person[p]["移动步数"] = 0
				WAR.L_NOT_MOVE[WAR.Person[p]["人物编号"]] = nil
			--白万剑	
			elseif Bwj1() and not inteam(id) and (JY.Person[id]["内力"] < 2000 or WAR.JQSDXS[id] < 80) then
			WAR.Person[p]["移动步数"] = 0
			elseif Bwj2() and inteam(id) and (JY.Person[id]["内力"] < 2000 or WAR.JQSDXS[id] < 80) then
			WAR.Person[p]["移动步数"] = 0
			else
				--计算移动步数
				WAR.Person[p]["移动步数"] = math.modf(getnewmove(WAR.Person[p]["轻功"], JY.Person[id]["体力"]) - JY.Person[id]["中毒程度"] / 50 - JY.Person[id]["受伤程度"] / 50)
				
				--毒王中毒移动能力补偿
				if id == 0 and JY.Base["标准"] == 9 then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + math.modf(JY.Person[id]["中毒程度"] / 50)
				end
				for j = 0, WAR.PersonNum - 1 do
					--小昭，敌人移步数少三格
					if match_ID(WAR.Person[j]["人物编号"], 66) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[p]["我方"] then
						WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 3
					end
				end
				--无影神拳
				if WAR.WYSQ[WAR.Person[p]["人物编号"]] ~= nil then
				   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 5
				end
				--天罗地网，柔网势，敌人移动减一格
				if WAR.TLDW[WAR.Person[p]["人物编号"]] ~= nil and WAR.TLDW[WAR.Person[p]["人物编号"]] == 1 then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 1
					WAR.TLDW[WAR.Person[p]["人物编号"]] = nil
				end
				--张家辉的麻痹戒指，减少敌人移动
				if WAR.MBJZ[WAR.Person[p]["人物编号"]] ~= nil then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - WAR.MBJZ[WAR.Person[p]["人物编号"]]
					WAR.MBJZ[WAR.Person[p]["人物编号"]] = nil
				end
				if WAR.Person[p]["移动步数"] < 1 then
					WAR.Person[p]["移动步数"] = 1
				end
				--令狐冲，灭绝，血刀老祖，阿凡提，神雕移动+3格
				if match_ID(id, 35) or match_ID(id, 6) or match_ID(id, 97) or match_ID(id, 606) or match_ID(id, 628) or match_ID(id, 67) then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 3
				end
				--张三丰，移动至少8格
				if match_ID(id, 5) and WAR.Person[p]["移动步数"] < 8 then
					WAR.Person[p]["移动步数"] = 8
				end
				--谢烟客，擒龙控鹤
				if match_ID(id, 164) then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
					if JY.Person[164]["阶"] >= 2 then
					   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
					end
					if PersonKF(id, 188) then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
					end
				end   
				for j = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[j]["人物编号"], 164) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[p]["我方"] then
						WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 1
						if JY.Person[164]["阶"] >= 2 then
						   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 1
						end
						if PersonKF(WAR.Person[j]["人物编号"], 188) then
						   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 1
						end
					end
				end
				--畅想渡厄，移动力一格
				--[[if id == 0 and JY.Base["畅想"] == 597 then
					WAR.Person[p]["移动步数"]=1
				end	]]
				--主运飞天，凌波，天罗，登萍，螺旋移动+1
				if Curr_QG(id,145) or Curr_QG(id,147) or Curr_QG(id,148) or Curr_QG(id,179) or Curr_QG(id,181) then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
				end
				--主运神行，瞬息，暗香，踏雪移动+2
				if Curr_QG(id,146) or Curr_QG(id,150) or Curr_QG(id,180) or Curr_QG(id,178) then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 2
				end
				if JY.Base["标准"] == 5 and id == 0 and JY.Person[0]["阶"] >= 1 then
				   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
				end
				--梯云
				if PersonKF(id,149) and JY.Person[id]["专1"] == 149 then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 3
				end
				if match_ID(id, 682) then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 3
				end
				--登萍渡水
				if PersonKF(id,179) and JY.Person[id]["专1"] == 179 then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 2
				end
				--主角学会迷踪步后，移动+1
				if id == 0 and JY.Person[615]["论剑奖励"] == 1 then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
				end
				--孤独求败，移动锁定10格
				if match_ID(id, 592) then
					WAR.Person[p]["移动步数"] = 10
				end
				--寒冰之墙
				if GetWarMap(WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"],6) == 5 and (not match_ID(id, 689) and id ~= 690) then
				   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - math.modf(JY.Person[689]["天1"])
				   if WAR.Person[p]["移动步数"] < 0 then
				      WAR.Person[p]["移动步数"] = 0
				   end				   
				end
			end
			
			--最大移动步数10
			if WAR.Person[p]["移动步数"] > 10 then
				WAR.Person[p]["移动步数"] = 10
			end
			if JY.Person[id]["人25"] == 1 then
	           WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 2
	        end
			if JY.Person[id]["人32"] == 1 then
	           WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
	        end
			--广目无边
			if JY.Person[id]["防具"] == 324 or JY.Person[id]["防具"] == 327 then
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + math.modf(JY.Base["天书数量"]/3)
			end
			if PersonKF(id,129) and JY.Person[id]["专1"] == 129 then
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 4
			end
			if Curr_QG(id, 216) then
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 3
			end
			if WAR.SYBD[id] ~= nil and JY.Person[673]["外号2"] == "烈" then
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 5
			end
			if WAR.MXD[id] ~= nil then
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 3
			end
			if WAR.LSF[id] ~= nil then
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 5
			end		
			if JY.Person[id]["地5"] == 8 then
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 5
			end
			if JY.Person[634]["天3"] == 2 and match_ID(id, 634) then
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 20
			end
			if match_ID(id, 14) then
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + math.modf(JY.Person[id]["实战"]*0.02)
			end
			if JY.Person[692]["声望"] == 1 and match_ID(id, 692) then
	           WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 3
	        end
			
			WAR.ShowHead = 0
			WarDrawMap(0)
			WAR.Effect = 0
			WAR.CurID = p
			WAR.Person[p].TimeAdd = 0
			local r = nil
			local pid = WAR.Person[WAR.CurID]["人物编号"]
			WAR.Defup[pid] = nil
			
			--逍遥御风，行动前恢复
			--左右第二下不会清0
			if pid == 0 and WAR.XYYF[pid] and WAR.XYYF[pid] == 11 and WAR.ZYHB ~= 2 and WAR.CLBF ~= 2 and WAR.HSSD ~= 2 then
				WAR.XYYF[pid] = nil
			end
			
			--段誉的指令，行动前恢复
			if match_ID(pid, 53) then
				WAR.TZ_DY = 0
			end
			
			--慕容复的指令，行动前恢复，天正第五战永久有效
			if match_ID(pid, 51) and WAR.ZDDH ~= 81 then
				WAR.TZ_MRF = 0
			end
			
			--阿青，行动前内伤中毒清0
			if match_ID(pid, 604) then
				JY.Person[pid]["受伤程度"] = 0
				JY.Person[pid]["中毒程度"] = 0
			end
			
			--阿九，行动开始前，60%几率降低敌方集气100点
			if match_ID(pid, 629) and JLSD(20,80,pid) then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
						WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
					end
				end
				DrawTimeBar2()
			end
			
			--博览群书
			if JY.Person[pid]["地2"] == 7 then
				JY.Person[pid]["武功1"] = math.random(240)
				JY.Person[pid]["武功等级1"] = 999
			end
			if JY.Person[637]["声望"] >= 2 and match_ID(pid, 637) then
			local wg = {11,164,201}
				JY.Person[pid]["武功16"] = wg[math.random(3)]
				JY.Person[pid]["武功等级16"] = 999
			end
			--花铁干
			if match_ID(pid, 52) and JY.Person[52]["阶"] >= 3 then
			   if math.random(100) < 51 then
			      JY.Person[pid]["武功2"] = 241
			   end
			end
			--铁拳
			if match_ID(pid, 693) and math.random(100) <= 35 + JY.Base["天书数量"]*2 + math.modf(JY.Person[pid]["实战"]*0.05) then
			   local t = math.random(3)
			   if t == 1 then
			   WarDrawMap(0)		
			   CurIDTXDH(WAR.CurID, 120,1, "攻击之气", PinkRed)
			   WAR.TQGJ[pid] = 30
			   elseif t == 2 then
			   WarDrawMap(0)		
			   CurIDTXDH(WAR.CurID, 136,1, "防御之气", M_DeepSkyBlue)
			   WAR.TQFY[pid] = 30
			   else
			   WarDrawMap(0)		
			   CurIDTXDH(WAR.CurID, 126,1, "灵巧之气", C_GOLD)
			   WAR.TQLQ[pid] = 30
			   end
			end
			
			--黯然战斗中行动前激活提示
			if match_ID(pid, 0) then
				for i = 1, JY.Person[671]["品德"] do
					if JY.Person[pid]["武功" .. i] == 25 then
						if JY.Person[pid]["受伤程度"] >= 70 or (JY.Person[pid]["生命"] <= JY.Person[pid]["生命最大值"] * 0.3) then
							WarDrawMap(0); --不加这条则动画位置无法正常显示
							CurIDTXDH(WAR.CurID, 129,1, "莫道黯然销魂，何处柳暗花明", LightPurple)
						end
					end
				end
			end
			
			--无酒不欢 运筹帷幄
			if JY.Base["特殊"] ==1 and JY.Person[32]["血量翻倍"]==1 and pid==0 and JLSD(20,50,pid) then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
						WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
					end
				end
				DrawTimeBar2()
			end
			
			--先天调息，60%几率休息
			if Curr_NG(pid, 100) and JLSD(20,80,pid) then
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 19,1,"先天调息",C_ORANGE);
				WAR.XTTX = 1
				War_RestMenu()
				WAR.XTTX = 0
			end
			
			--佛本是道 行动开始前，提升我方100集气
			if ((PersonKF(id, 100) and PersonKF(id, 96)) or match_ID(id, 65)) and JY.Person[id]["生命"] > 0 then
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 104,1,"高卧九重云，蒲团了道真",LimeGreen);
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
						WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd + 100
					end
				end
				DrawTimeBar2()
			end
			
			--龙象般若功，自动蓄力
			if Curr_NG(pid, 103) then
				War_ActupMenu()
			end
			
			--除却四相
			if ChuQueSX(id) ~= nil and ChuQueSX(id)>=3 and JY.Person[id]["生命"]> 0 then 
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 78,1,"除却四相",C_ORANGE);
				JY.Person[id]["中毒程度"] =0
				JY.Person[id]["受伤程度"] =0
				JY.Person[id]["冰封程度"] =0
				JY.Person[id]["灼烧程度"] =0
				--流血
				if WAR.LXZT[id] ~= nil then
					WAR.LXZT[id] = nil
				end
				--业火
				if WAR.WMYH[id] ~= nil then
					WAR.WMYH[id] = nil
				end
				if ChuQueSX(id)>=4 then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
						WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
					end
				end				
				DrawTimeBar2()
				end
			end
			
		if match_ID(id,658) and JY.Person[id]["生命"]> 0 then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				local loss = math.modf(JY.Person[WAR.Person[j]["人物编号"]]["生命"]*0.05)
				--无酒不欢：记录人物血量
				WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - loss
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - loss
				WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "中毒程度", 100)
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				--沉睡状态的敌人会醒来
				if WAR.CSZT[WAR.Person[j]["人物编号"]] ~= nil then
					WAR.CSZT[WAR.Person[j]["人物编号"]] = nil
				end
			end
		end
		CurIDTXDH(WAR.CurID, 64,1,"万蛊蚀天",C_ORANGE);
		end

		--慕容博走火入魔
		if match_ID(id,113) and JY.Person[id]["生命"]> 0 and 100 < WAR.SXTJ then
			CurIDTXDH(WAR.CurID, 124,1,"走火入魔",C_GOLD);
			if WAR.ZHRM[id]== nil then
			WAR.ZHRM[id]= 5
			else
			WAR.ZHRM[id]=WAR.ZHRM[id]+1
			end
			WAR.PJZT[id] = WAR.ZHRM[id]
			if WAR.PJJL[id] == nil then
			WAR.PJJL[id] = JY.Person[id]["主运内功"]
			end
			JY.Person[id]["主运内功"] = 0
		end

		--萧远山杀破狼
		if match_ID(id,112) and JY.Person[id]["生命"]> 0 and WAR.ZHRM[id]== nil then
		    if WAR.XYS == 0 and JY.Person[112]["阶"] >= 3 and math.random(100) < 51 then
			   WAR.XYS = 3
			end
			if WAR.XYS == 3 then
			   WarDrawMap(0); --不加这条则动画位置无法正常显示				
			   CurIDTXDH(WAR.CurID, 122,1, "杀破狼", M_DeepSkyBlue, 50);
			   WAR.LQZ[id] = 100
			   WarDrawMap(0); --不加这条则动画位置无法正常显示		
			   if WAR.LQZ[id] ~= nil and WAR.LQZ[id] == 100 then
			   CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
			   end
			end
		end
			
			--战三渡时，超过100时序，周芷若领悟左右
			if WAR.ZDDH == 253 and match_ID(pid, 631) and WAR.ZZRZY == 0 and 100 < WAR.SXTJ then
				say("１Ｌ＜这三人心意相通，如攻其一人，则其余两人立即回护，这样如何能够破阵？ｗ……若能分心二用，同时攻击两方，且他们如何应对＞Ｗ", 357, 0,"周芷若")  --对话
				if JY.Base["畅想"] == 631 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 631 or JY.Person[685]["天2"] == 631 or JY.Person[685]["天3"] == 631)) then
					JY.Person[0]["左右互搏"] = 1
				else
					JY.Person[631]["左右互搏"] = 1
				end
				WAR.ZZRZY = 1
			end
			
			--神邪战，蒙哥招小弟
			if WAR.ZDDH == 278 and WAR.Person[WAR.CurID]["死亡"] == false and WAR.Person[WAR.CurID]["我方"] == false and WAR.ZZRZY4 == 0 and JY.Base["单通"] ==0 then
				say("１Ｌ＜来人，护驾！＞Ｗ", 354, 0,"蒙哥")  --对话
				CurIDTXDH(WAR.CurID, 72,1, "宁教我负天下人，休教天下人负我", M_DeepSkyBlue, 50);
				NewWARPersonZJ(62, false, 21, 27, false, 2)
				NewWARPersonZJ(157, false, 33, 26, false, 2)
				NewWARPersonZJ(158, false, 36, 28, false, 2)
				NewWARPersonZJ(159, false, 27, 26, false, 2)
				NewWARPersonZJ(160, false, 24, 28, false, 2)
				NewWARPersonZJ(84, false, 30, 28, false, 2)
				JY.Person[62]["主运内功"]=103
				JY.Person[62]["天赋外功1"]=158
				JY.Person[62]["生命"] = 8000
				JY.Person[62]["生命最大值"] = 8000
				JY.Person[62]["内力"] = 9999
				JY.Person[62]["内力最大值"] = 9999
				JY.Person[62]["武功2"] = 169
				JY.Person[62]["武功等级2"] = 999
				JY.Person[62]["武功3"] = 158
				JY.Person[62]["武功等级3"] = 999
				JY.Person[157]["生命"] = 4000
				JY.Person[157]["生命最大值"] = 4000
				JY.Person[157]["内力"] = 6000
				JY.Person[157]["内力最大值"] = 6000
				JY.Person[158]["生命"] = 4000
				JY.Person[158]["生命最大值"] = 4000
				JY.Person[158]["内力"] = 6000
				JY.Person[158]["内力最大值"] = 6000
				JY.Person[159]["生命"] = 4000
				JY.Person[159]["生命最大值"] = 4000
				JY.Person[159]["内力"] = 6000
				JY.Person[159]["内力最大值"] = 6000
				JY.Person[160]["主运内功"]=103
				JY.Person[160]["生命"] = 3400
				JY.Person[160]["生命最大值"] = 3400
				JY.Person[160]["内力"] = 5000
				JY.Person[160]["内力最大值"] = 5000
				JY.Person[84]["主运内功"]=103
				JY.Person[84]["生命"] = 3400
				JY.Person[84]["生命最大值"] = 3400
				JY.Person[84]["内力"] = 5000
				JY.Person[84]["内力最大值"] = 5000
				WAR.ZZRZY4 = 1
			end
			
				--倚邪战，张无忌招后宫
			if WAR.ZDDH == 288 and WAR.Person[WAR.CurID]["死亡"] == false and WAR.Person[WAR.CurID]["我方"] == false and WAR.ZZRZY4 == 0 then				
				say("１Ｌ万载千世谁狂勇，号令世间天赞颂！Ｗ", 9, 0,"张无忌")  --对话
				NewWARPersonZJ(66, false, 30, 17, false, 2)
				NewWARPersonZJ(609, false, 30, 16, false, 2)
				NewWARPersonZJ(646, false, 30, 15, false, 2)
				JY.Person[66]["主运内功"]=93
				JY.Person[66]["主运轻功"]=191
				JY.Person[66]["攻击力"]=200
				JY.Person[66]["防御力"]=200
				JY.Person[66]["轻功"]=200
				JY.Person[62]["生命"] = 3000
				JY.Person[62]["生命最大值"] = 3000
				JY.Person[62]["内力"] = 4000
				JY.Person[62]["内力最大值"] = 4000
				JY.Person[62]["武功2"] = 97
				JY.Person[62]["武功等级2"] = 999
				
				JY.Person[609]["主运内功"]=160
				JY.Person[609]["主运轻功"]=191
				JY.Person[609]["攻击力"]=200
				JY.Person[609]["防御力"]=200
				JY.Person[609]["轻功"]=200
				JY.Person[609]["生命"] = 3000
				JY.Person[609]["生命最大值"] = 3000
				JY.Person[609]["内力"] = 4000
				JY.Person[609]["内力最大值"] = 4000
				JY.Person[609]["武功2"] = 60
				JY.Person[609]["武功等级2"] = 999

				if JY.Base["畅想"] ==82 and JY.Person[631]["品德"] == 100 then
				say("１Ｌ怎么忍心怪你犯了错，是我给你自由过了火Ｗ", 82, 0,"宋青书")  --对话
				NewWARPersonZJ(631, false, 32, 18, false, 2)	
				JY.Person[631]["主运内功"]=106
				JY.Person[631]["主运轻功"]=181
				JY.Person[631]["攻击力"]=200
				JY.Person[631]["防御力"]=200
				JY.Person[631]["轻功"]=200
				JY.Person[631]["生命"] = 3000
				JY.Person[631]["生命最大值"] = 3000
				JY.Person[631]["内力"] = 4000
				JY.Person[631]["内力最大值"] = 4000
				JY.Person[631]["武功1"] = 11
				JY.Person[631]["武功等级1"] = 999
				end
				
				JY.Person[646]["主运内功"]=87
				JY.Person[646]["主运轻功"]=181
				JY.Person[646]["攻击力"]=200
				JY.Person[646]["防御力"]=200
				JY.Person[646]["轻功"]=200
				JY.Person[646]["生命"] = 3000
				JY.Person[646]["生命最大值"] = 3000
				JY.Person[646]["内力"] = 4000
				JY.Person[646]["内力最大值"] = 4000
				JY.Person[646]["武功1"] = 183
				JY.Person[646]["武功等级1"] = 999
				
				WAR.ZZRZY4 = 1
			end
			
			--射邪，郭黄参战
			if WAR.ZDDH == 185 and WAR.Person[WAR.CurID]["死亡"] == false and WAR.Person[WAR.CurID]["我方"] == false and WAR.ZZRZY4 == 0 and 100 < WAR.SXTJ and JY.Base["单通"] ==0 then
				say("１Ｌ射雕引弓塞外奔驰", 55, 0,"郭靖")  --对话
				say("１Ｌ猛风沙野茫茫", 56, 1,"黄蓉")  --对话
				say("１Ｌ笑傲此生无厌倦", 55, 0,"郭靖")  --对话
				say("１Ｌ藤树两缠绵", 56, 1,"黄蓉")  --对话
				NewWARPersonZJ(55, false, 40, 30, false, 2)
				NewWARPersonZJ(56, false, 42, 30, false, 2)
				JY.Person[55]["主运内功"]=107
				JY.Person[55]["主运轻功"]=181
				JY.Person[56]["主运内功"]=107
				JY.Person[55]["主运轻功"]=181
				WAR.ZZRZY4 = 1
			end
			
			--神邪，金轮帮忙
			if WAR.ZDDH == 75 and WAR.Person[WAR.CurID]["死亡"] == false and WAR.Person[WAR.CurID]["我方"] == false and WAR.ZZRZY4 == 0 and JY.Base["单通"] ==0 then
				say("１Ｌ金轮国师，咱们的帐是今日算呢，还是留待异日？Ｗ", 58, 0,"杨过")  --对话
				say("１Ｌ过儿，你给我找一把剑，咱们……咱们……一起……一起使玉女素心剑法打他。Ｗ", 59, 0,"小龙女")  --对话
				say("１Ｌ金轮国师整一整袍袖，金银铜铁铅五轮一齐持，心知这一战关涉生死荣辱，丝毫大意不得，神色间却仍似漫不在乎，缓步而出。Ｗ", 62, 1,"金轮国师")  --对话
				if 	 JY.Base["畅想"] ~=62 then
				NewWARPersonZJ(62, true, 28, 30, false, 2)
				elseif 	 JY.Base["畅想"] ~=157 then
				NewWARPersonZJ(157, true, 33, 14, false, 2)
				elseif 	 JY.Base["畅想"] ~=158 then
				NewWARPersonZJ(158, true, 34, 12, false, 2)
				elseif 	 JY.Base["畅想"] ~=159 then
				NewWARPersonZJ(159, true, 27, 16, false, 2)
				elseif 	 JY.Base["畅想"] ~=160 then
				NewWARPersonZJ(160, true, 26, 28, false, 2)
				elseif 	 JY.Base["畅想"] ~=82 then
				NewWARPersonZJ(84, true, 32, 28, false, 2)
				end
				JY.Person[62]["主运内功"]=103
				JY.Person[62]["生命"] = 4000
				JY.Person[62]["生命最大值"] = 4000
				JY.Person[62]["内力"] = 5000
				JY.Person[62]["内力最大值"] = 5000
				JY.Person[62]["武功2"] = 169
				JY.Person[62]["武功等级2"] = 999
				JY.Person[62]["武功3"] = 158
				JY.Person[62]["武功等级3"] = 999
				JY.Person[157]["生命"] = 2400
				JY.Person[157]["生命最大值"] = 2400
				JY.Person[158]["生命"] = 2200
				JY.Person[158]["生命最大值"] = 2200
				JY.Person[159]["生命"] = 2600
				JY.Person[159]["生命最大值"] = 2600
				JY.Person[160]["主运内功"]=103
				JY.Person[160]["生命"] = 2000
				JY.Person[160]["生命最大值"] = 2000
				JY.Person[84]["主运内功"]=103
				JY.Person[84]["生命"] = 2000
				JY.Person[84]["生命最大值"] = 2000
				WAR.ZZRZY4 = 1
			end
			
			--神邪战，郭靖黄蓉帮忙
			if WAR.ZDDH == 278 and WAR.Person[WAR.CurID]["我方"] == true and WAR.ZZRZY5 == 0 and JY.Base["单通"] ==0 then
				say("１Ｌ＜蜀将何在！＞Ｗ", 0, 0)  --对话
				CurIDTXDH(WAR.CurID, 74,1, "惟贤惟德，能服于人", C_RED, 50);
				if 	 JY.Base["畅想"] ~=55 then
				NewWARPersonZJ(612, true, 35, 31, false, 2)
				elseif 	 JY.Base["畅想"] ~=56 then
				NewWARPersonZJ(613, true, 27, 31, false, 2)
				end
				JY.Person[612]["主运内功"]=107
				JY.Person[612]["主运轻功"]=181
				JY.Person[613]["主运内功"]=107
				JY.Person[613]["主运轻功"]=181
				WAR.ZZRZY5 = 1
				local function fightcombo()
				local combo = {}
				for i = 1, #CC.COMBO do
					combo[i] = {CC.COMBO[i][1], CC.COMBO[i][2], CC.COMBO[i][3],0}
				end
				for i = 0, WAR.PersonNum - 1 do
					local t = WAR.Person[i]["人物编号"]
					for j = 1, #combo do
						lib.GetKey()
						if match_ID(t, combo[j][1]) then
							for z = 0, WAR.PersonNum - 1 do
								local t2 = WAR.Person[z]["人物编号"]
								if match_ID(t2, combo[j][2]) and WAR.Person[i]["我方"] == WAR.Person[z]["我方"] then
									combo[j][4] = 1
									break
								end
							end
						end
					end
				end
				for i = 1, #combo do
					if combo[i][4] == 1 then
						local t1 = combo[i][1]
						local t2 = combo[i][2]
						for j = 0, 10 do
							lib.GetKey()
							local str = JY.Person[t1]["姓名"].."＆"..JY.Person[t2]["姓名"]
							local str2 = combo[i][3]
							Cls()
							DrawBox(150, CC.ScreenH / 3 + 30, CC.ScreenW - 150, CC.ScreenH / 3 * 2 - 20, C_BLACK)
							lib.LoadPNG(1, JY.Person[t1]["头像代号"]*2, CC.ScreenW / 4 - 80, CC.ScreenH / 2 - 35, 1)
							lib.LoadPNG(1, JY.Person[t2]["头像代号"]*2, CC.ScreenW / 4 + 50, CC.ScreenH / 2 - 35, 1)
							NewDrawString(CC.ScreenW / 2 * 3 - 170, CC.ScreenH + 120, str, C_ORANGE, 25)	
							NewDrawString(CC.ScreenW / 2 * 3 - 170, -1, str2, C_GOLD, 50 + j)
							ShowScreen()							
							lib.Delay(30)	
						end		
						lib.Delay(400)	
					end
				end
			end
			fightcombo()
			end
			
			--神正战，杨过帮忙
			if WAR.ZDDH == 74 and WAR.Person[WAR.CurID]["死亡"] == false and WAR.Person[WAR.CurID]["我方"] == true and WAR.ZZRZY3 == 0 and JY.Base["单通"] ==0 then
				say("１Ｌ尹志平见小龙女不知如何竟尔突然失了战意，心中大急，眼见这一轮便要将她砸死，奋不顾身的扑了上去，叫道：“龙姑娘，小心！”Ｗ", 82, 0,"尹志平")  --对话
				say("１Ｌ小龙女一呆，这才醒悟，原来是他救了自己性命，见他背遭轮砸，胸中剑刺，一x那间，满腔憎恨之心尽化成了怜悯，柔声道：“你何苦如此？”Ｗ", 59, 0,"小龙女")  --对话
				say("１Ｌ尹志平命在垂危，忽然听到这“你何苦如此”五字，不禁大喜若狂，说道：“龙姑娘，我实……实在对你不起，罪不容诛，你……你原谅了我么？”Ｗ", 82, 0,"尹志平")  --对话
				say("１Ｌ突然之间，小龙女一声大叫，双颊全无血色，呛啷、呛啷两声，手中双剑落地，呆呆的望着青松畔的那丛玫瑰，叫道：“过儿，当真是你吗？”Ｗ", 59, 0,"小龙女")  --对话
		
				local x, y = WE_xy(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] -1)
				if 	 JY.Base["畅想"] ~=58 then
				NewWARPersonZJ(614, true, x, y, false, 2)
				end
				JY.Person[614]["主运内功"]=107
				WAR.XK = 2
				say("１Ｒ龙儿－－－－－－！Ｈ５啊－－－－４－－－－３－－－－２－－－－１－－－－－－－－！！！", 58,0)
				WAR.ZZRZY3 = 1
			end
			
			--灵鹫宫，童姥帮忙
			if WAR.ZDDH == 202 and WAR.Person[WAR.CurID]["死亡"] == false and WAR.Person[WAR.CurID]["我方"] == true and WAR.ZZRZY3 == 0 and JY.Base["单通"] ==0 then
				say("１Ｌ李秋水，逍遥派掌门人有令，命你跪下，听由吩咐。Ｗ", 117, 0,"天山童姥")  --对话
				say("１Ｌ掌门人能由你自己封的吗？多半……多半是你暗害了他，偷得这只七宝指环。Ｗ", 118, 1,"李秋水")  --对话
				say("１Ｌ你不奉掌门人的号令，意欲背叛本门，是不是？Ｗ", 117, 0,"天山童姥")  --对话
				say("１Ｌ师姊，你到底怎生害他，还是跟小妹说了吧。小妹对你情义深重，决不会过份令你难堪。Ｗ", 118, 1,"李秋水")  --对话
				say("１Ｌ突见李秋水衣袖轻拂，"..JY.Person[0]["姓名"].."双膝腿弯登时一麻，全身气血逆行，翻倒于地，叫道：“喂，喂，你干什么？我又没得罪你，怎……怎么连我……也”Ｗ", 0, 0,JY.Person[0]["姓名"])  --对话
				local x, y = WE_xy(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] -1)
				if 	 JY.Base["畅想"] ~=117 then
				NewWARPersonZJ(117, true, x, y, false, 2)
				end
				JY.Person[117]["内力"]=2333
				JY.Person[118]["内力"]=2333
				JY.Person[117]["生命"]=2333
				JY.Person[118]["生命"]=2333
				JY.Person[117]["主运内功"]=101
				JY.Person[117]["主运轻功"]=147
				WAR.ZZRZY3 = 1
			end

			--神正战，五绝帮忙		
			if WAR.ZDDH == 275 and WAR.Person[WAR.CurID]["死亡"] == false and WAR.Person[WAR.CurID]["我方"] == false and WAR.ZZRZY7 == 0 and JY.Base["单通"] ==0 then
				say("１Ｌ国师瞧瞧一灯大师、瞧瞧周伯通、又瞧瞧黄药师，说道：“单打独斗，老僧谁也不惧。”Ｗ", 62, 0,"金轮国师")  --对话
				say("１Ｌ不错。今日咱们又不是华山论剑，争那武功天下第一名号，谁来跟你单打独斗？”Ｗ", 64, 0,"周伯通")  --对话
				if 	 JY.Base["畅想"] ~=64 then
				NewWARPersonZJ(64, true, 35, 31, false, 2)
				elseif 	 JY.Base["畅想"] ~=57 then
				NewWARPersonZJ(57, true, 31, 32, false, 2)
				elseif 	 JY.Base["畅想"] ~=65 then
				NewWARPersonZJ(65, true, 27, 33, false, 2)
				end
				WAR.ZZRZY7 = 1	
			end				
			
			--混乱状态，行动前敌我随机
			--只剩一个敌人时不会进行随机
			if WAR.HLZT[pid] ~= nil then
				local EmenyNum = 0
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == false then
						EmenyNum = EmenyNum + 1
					end
				end
				if EmenyNum > 1 then
					if math.random(2) == 1 then
						WAR.Person[p]["我方"] = true
					else
						WAR.Person[p]["我方"] = false
					end
				end
			end
			if WAR.KXS[pid] ~= nil then
				local EmenyNum = 0
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == false then
						EmenyNum = EmenyNum + 1
					end
				end
				if EmenyNum > 1 then
					if math.random(2) == 1 then
						WAR.Person[p]["我方"] = true
					else
						WAR.Person[p]["我方"] = false
					end
				end
			end
		
			--行动时显示血条
			WAR.ShowHP = 1
			WAR.ShowMP = 1
			
			--踏雪无痕的移动记录
			WAR.TXWH[pid] = {WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"],0}
			
			--无酒不欢：行动时，获取指令
			if WAR.HMZT[pid] ~= nil then			--昏迷状态
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 94,1,"昏迷中",C_ORANGE)
				WAR.HMZT[pid] = nil
			elseif WeiXB() and not inteam(pid) and math.random(100) <= 15then			
			elseif inteam(pid) and WAR.Person[p]["我方"] then
			   if WAR.Jiaox[pid] == 1 then
			      if math.random(2) == 1then
				     War_AutoEscape()
				  else
				     War_DefupMenu() 
				  end
			   
			   else
			   if WAR.KJZ[pid] ~= nil then
			    local i = math.random(4)
				if i == 1 then
				War_DefupMenu()
				elseif i == 2 or i == 3 then
			    War_AutoEscape()
				else
				   if WAR.AutoFight == 0 then
					r = War_Manual()
				   elseif JY.Person[pid]["禁用自动"] == 1 then
					r = War_Manual()
				   else
					r = War_Auto()
				   end
				end
				else
				   if WAR.AutoFight == 0 then
					r = War_Manual()
				   elseif JY.Person[pid]["禁用自动"] == 1 then
					r = War_Manual()
				   else
					r = War_Auto()
				   end
			   end
			   end--jiaox
			else
			   if WAR.Jiaox[pid] == 1 then
			      if math.random(2) == 1then
				     War_AutoEscape()
				  else
				     War_DefupMenu() 
				  end
			   else
			    if WAR.KJZ[pid] ~= nil then
				local i = math.random(4)
				   if i == 1 then
				   War_DefupMenu()
				   elseif i == 2 or i == 4 then
			       War_AutoEscape()
				   else
				   r = War_Auto()
				   end
			    else	
				   r = War_Auto()
				end
			   end--jiaox	
			end
			
			if JY.Restart == 1 then
				return false
			end
			
			
			--如果发动左右互搏
			if WAR.ZYHB == 1 then
				for j = 0, WAR.PersonNum - 1 do
					WAR.Person[j].Time = WAR.Person[j].Time - 15
					if WAR.Person[j].Time > 990 then
						WAR.Person[j].Time = 990
					end
					if WAR.Person[j].Time < -500 then
						WAR.Person[j].Time = -500
					end
				end
				WAR.Person[p].Time = 1005
				if WAR.ZHB == 0 then	--周伯通的额外左右这里不再重复记录
					WAR.ZYYD = WAR.Person[p]["移动步数"]
					WAR.XYZD = WAR.Person[p]["移动步数"]
				end
				WAR.ZYHBP = p
				
				--一灯，避免被反死
				if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil and WAR.JESS[65] == nil then
					JY.Person[65]["生命"] = 1
				end
				
				if (JY.Base["畅想"] == 65 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 65 or JY.Person[685]["天2"] == 65 or JY.Person[685]["天3"] == 65))) and JY.Person[0]["生命"] <= 0 and WAR.WCY[0] == nil and WAR.JESS[0] == nil then
					JY.Person[0]["生命"] = 1
				end
				
				--王重阳
				if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil and WAR.JESS[129] == nil then
					JY.Person[129]["生命"] = 1
				end
				
				if (JY.Base["畅想"] == 129 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 129 or JY.Person[685]["天2"] == 129 or JY.Person[685]["天3"] == 129))) and JY.Person[0]["生命"] <= 0 and WAR.CYZX[0] == nil and WAR.JESS[0] == nil then
					JY.Person[0]["生命"] = 1
				end
			  
				--阎基偷钱
				if WAR.YJ > 0 then
					instruct_2(174, WAR.YJ)
					WAR.YJ = 0
				end
			else
				if WAR.ZYHB == 2 then
					WAR.ZYHB = 0
				end
				
				
      --赵灵儿回复
     if match_ID(id,656) and 0 < JY.Person[id]["生命"] then 
		   WarDrawMap(0); --不加这条则动画位置无法正常显示
		   CurIDTXDH(WAR.CurID, 78,1,"五气朝元",C_ORANGE);
		for i = 0, WAR.PersonNum - 1 do
			local id = WAR.Person[i]["人物编号"]
				if  WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == WAR.Person[WAR.CurID]["我方"] then
			   local heal_amount1;
			   local heal_amount;
			   heal_amount1 =  JY.Person[id]["生命最大值"] - JY.Person[id]["生命"]
			   heal_amount = math.modf(heal_amount1 * 0.2)
					if heal_amount < 100 then
					heal_amount = 100
					end
				WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount);
				Cls();
				War_Show_Count(WAR.CurID, "五气朝元恢复生命");
				end
		end
	end

				WAR.Person[p].Time = WAR.Person[p].Time - 1000
				if WAR.Person[p].Time < -500 then
				  WAR.Person[p].Time = -500
				end
				
			--萧远山调息
			if match_ID(id, 112) and WAR.ZHRM[id] ~= nil then
					WarDrawMap(0)
					CurIDTXDH(WAR.CurID, 124,1,"走火入魔",C_GOLD);
					WAR.LRHF[id] = WAR.ZHRM[id]
					WAR.ZHRM[id] = WAR.ZHRM[id]+1
			end
		
				--罗汉伏魔功 每回合回复生命
				if PersonKF(id, 96) and JY.Person[id]["生命"] > 0 then
					local heal_amount;
					heal_amount = JY.Person[id]["生命最大值"] - JY.Person[id]["生命"]
					if Curr_NG(id, 96) then
						heal_amount = math.modf(heal_amount * 0.2)
						if heal_amount > 200 then
						heal_amount = 200
					    end
					else
						heal_amount = math.modf(heal_amount * 0.1)
						if heal_amount > 100 then
						heal_amount = 100
					    end
					end
					if JY.Person[id]["天赋内功"] == 96 then
					   heal_amount = heal_amount + 100
					end  
					
					WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount)
					Cls()
					War_Show_Count(WAR.CurID, "罗汉伏魔功恢复生命")
				end
				--铁拳
	            if WAR.TQJQ[id] ~= nil then
				   WAR.TQJQ[id] = nil
	            end
				--赵云
			    if match_ID(id, 688) and JY.Person[688]["阶"] >= 3 and WAR.QJQC[pid] ~= nil then
				   local wgd = JY.Person[id]["武功等级16"]
				   JY.Person[id]["武功16"] = 253
				   JY.Person[id]["武功等级16"] = 999
				   War_Fight_Sub(WAR.CurID, 16)
				   JY.Person[id]["武功16"] = 225
				   JY.Person[id]["武功等级16"] = wgd
			    end
				--胡青牛
				if match_ID(id, 16) and JY.Person[16]["阶"] >= 2 and WAR.Person[WAR.CurID]["死亡"] == false then
				War_AutoDoctor()
				end
				--张角
				if match_ID(id, 694) and JY.Person[694]["天4"] == 2 and WAR.Person[WAR.CurID]["死亡"] == false then
				War_Incantation()
				end
				--医生
				if JY.Person[0]["阶"] >= 3 and JY.Base["标准"] == 8 and id == 0 and WAR.Person[WAR.CurID]["死亡"] == false then
				local jl = 30
				jl = jl + math.modf(50*(JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])/JY.Person[id]["生命最大值"])
				    if math.random(100) < jl then
					   War_AutoDoctor()
					   WAR.Person[p].Time = WAR.Person[p].Time + 300
					end
				end
				--花铁干
				if match_ID(pid, 52) and JY.Person[52]["阶"] >= 3 then
			      JY.Person[pid]["武功2"] = WAR.HTG
			    end
	
	            --何铁手
				if match_ID(pid, 83) and JY.Person[83]["阶"] >= 3 and War_isEnd() == 0 and WAR.AutoFight == 0 then
				War_CalMoveStep(WAR.CurID, math.modf(JY.Person[pid]["暗器技巧"] / 15) + 1, 1)
				local x1, y1 = War_SelectMove(1)
			    if x1 == nil then
		           lib.GetKey()
		           Cls()
	            else
		           War_ExecuteMenu_Sub(x1, y1, 4, 371)
	            end
			    end

				--赵半山
				if match_ID(pid, 153) and War_isEnd() == 0 and WAR.AutoFight == 0 then
				while math.random(100) > 59 and (WAR.FYYS ~= 0 or WAR.HLB ~= 0) do
				
				if math.random(100) < 20 + JY.Person[pid]["暗器技巧"]*0.1 and WAR.FYYS ~= 0 then
				  WAR.HLB = -math.abs(WAR.HLB)
				  CurIDTXDH(WAR.CurID, 125,1, "飞燕银梭", MilkWhite)
				  War_CalMoveStep(WAR.CurID, math.modf(JY.Person[pid]["暗器技巧"] / 15) + 5, 1)
				  local x1, y1 = War_SelectMove()
			      if x1 == nil then
		             lib.GetKey()
		             Cls()
	              else
		             War_ExecuteMenu_Sub(x1, y1, 4, math.abs(WAR.HLB))
	              end
				  WAR.HLB = math.abs(WAR.HLB)
				else
				  WAR.FYYS = math.abs(WAR.FYYS)
				  CurIDTXDH(WAR.CurID, 137,1, "回龙璧", C_GOLD)
				  War_CalMoveStep(WAR.CurID, math.modf(JY.Person[pid]["暗器技巧"] / 15) + 1, 1)
				  local x1, y1 = War_SelectMove()
			      if x1 == nil then
		             lib.GetKey()
		             Cls()
	              else
		             War_ExecuteMenu_Sub(x1, y1, 4, math.abs(WAR.FYYS))
	              end
				  WAR.FYYS = -math.abs(WAR.FYYS)
			    end
				
				end--while
				WAR.HLB = 0
				WAR.FYYS = 0
				end
				
				--李寻欢
				if match_ID(pid, 684) and WAR.XLFD ~= 0 and JY.Person[684]["天4"] == 1 and War_isEnd() == 0 and WAR.AutoFight == 0  then
				while math.random(100) < Person_LJ(pid) and WAR.XLFD >= 1 do
				CurIDTXDH(WAR.CurID, 3,1, "小李飞刀", C_GOLD)
				War_CalMoveStep(WAR.CurID, math.modf(JY.Person[pid]["暗器技巧"] / 15) + 1, 1)
				local x1, y1 = War_SelectMove()
			    if x1 == nil then
		           lib.GetKey()
		           Cls()
	            else
		           War_ExecuteMenu_Sub(x1, y1, 4, 29)
	            end
				WAR.XLFD = WAR.XLFD - 1
				end--while
				WAR.XLFD = 0
				end
				--小龙女
				if match_ID(pid, 59) and JY.Person[59]["阶"] >= 2 then
			      WAR.XLN[pid] = JY.Person[59]["阶"] - 1
			    end
				
				--医专
				if Yiliao() and inteam(id) and JY.Person[id]["生命"] > 0 then
					local heal_amount;
					heal_amount = JY.Person[id]["生命最大值"] - JY.Person[id]["生命"]
					heal_amount = math.modf(heal_amount * 0.15)					
					WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount)
					Cls()
					War_Show_Count(WAR.CurID, " ")
				end
				
				--丁典，正
				if match_ID(id, 672) and JY.Person[id]["生命"] > 0 and JY.Person[672]["品德"] == 100 then
					local heal_amount = JY.Person[id]["生命最大值"]
					heal_amount = math.modf(heal_amount * 0.05)+100
					WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount)
					Cls()
					War_Show_Count(WAR.CurID, " ")
				end
				
				if match_ID(id, 676) and JY.Base["天书数量"] >= 3 and JY.Person[id]["生命"] > 0 then
				   local jl = 20 + JY.Person[id]["实战"]/25
				   if JY.Person[id]["生命"] < JY.Person[id]["生命最大值"]*0.3 then
				      jl = jl + 30
				   end  
				   War_RestMenu()
				end 

				if WAR.SPbuff[id] ~= nil then
				   WAR.SPbuff[id] = 1
				end
				--张角
				if JY.Person[694]["天1"] == 2 and ZhangJ() and not inteam(id) then
				   local n = math.modf(JY.Person[id]["内力"]*0.05)
				   local m = math.modf(JY.Person[id]["生命"]*0.05)
				   WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", -n)
				   WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", -m)
				   Cls()
				   War_Show_Count(WAR.CurID, " ")
				end
				
				--紫霞神功行动后，回复内力
				if PersonKF(id, 89) then
					local HN  
					if Curr_NG(id, 89) then
						HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])*0.2)
					else
						HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])*0.1)
					end
					if JY.Person[id]["天赋内功"] == 89 then
					   HN = HN + 666
					end
					if tg ~= 1 then
	                   if fx < 0 then
			              HN = HN - fx*50
			           end
	                else
			           HN = HN - yin*50
			        end
					WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN)
					Cls()
					War_Show_Count(WAR.CurID, "紫霞神功回复内力")
				end
				
				if WAR.KJZ[id] ~= nil then
				   WAR.KJZ[id] = nil
				end
				
				if WAR.PTGJ[id] ~= nil then
				   WAR.PTGJ[id] = WAR.PTGJ[id] - 1
				   if WAR.PTGJ[id] <= 0 then
				      WAR.PTGJ[id] = nil
				   end	  
				end
			    
				if WAR.Jiaox[id] ~= nil then
				   WAR.Jiaox[id] = nil
				end
				--混元功行动后，减少内伤
				if PersonKF(id, 90) then
					local NS;
					NS = 5 + math.modf(JY.Person[id]["受伤程度"]/10)
					WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(id, "受伤程度", -NS)
					Cls();
					War_Show_Count(WAR.CurID, "混元功回复内伤");
				end
				
				--鳄皮护甲 每回合解毒
				if JY.Person[id]["防具"] == 61 and JY.Person[id]["中毒程度"] > 0 then
					local JD = 25 + 10 * (JY.Thing[61]["装备等级"]-1)
					if JY.Person[id]["中毒程度"] < JD then
						JD = JY.Person[id]["中毒程度"]
					end
					WAR.Person[WAR.CurID]["解毒点数"] = -AddPersonAttrib(id, "中毒程度", -JD)
					Cls();
					War_Show_Count(WAR.CurID, "鳄皮护甲生化解毒");
				end

				--化功大法
		if Curr_NG(pid, 87) and JY.Person[id]["生命"]> 0 then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and JY.Person[WAR.Person[j]["人物编号"]]["生命"]>0 and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				if JY.Person[WAR.Person[j]["人物编号"]]["中毒程度"] >0 then				
				WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - JY.Person[WAR.Person[j]["人物编号"]]["中毒程度"]
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - (JY.Person[WAR.Person[j]["人物编号"]]["中毒程度"] or 0)
							if JY.Person[WAR.Person[j]["人物编号"]]["生命"] < 1 then
							JY.Person[WAR.Person[j]["人物编号"]]["生命"] = 1
							end
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end
				--沉睡状态的敌人会醒来
				if WAR.CSZT[WAR.Person[j]["人物编号"]] ~= nil then
					WAR.CSZT[WAR.Person[j]["人物编号"]] = nil
				end
			end
		end
		CurIDTXDH(WAR.CurID, 64,1,"荼毒生灵",C_ORANGE);
		end
				--张角
				if match_ID(id, 694) and JY.Person[694]["阶"] >= 2 then
				local jl = 25
				jl = jl + JY.Base["天书数量"]*2
				   if math.random(100) < jl then
				   local JQ = {}
				      for j = 0, WAR.PersonNum - 1 do
					      JQ[j+1] = WAR.Person[j].Time
					  end
					  local k = math.random(#JQ)
					  if WAR.Person[p].Time < WAR.Person[k-1].Time then
					  local zj = WAR.Person[p].Time
					  local z = WAR.CurID
					  WAR.CurID = p
					  WarDrawMap(0)
	                  CurIDTXDH(WAR.CurID, 88,1,"鬼道",LightPurple)
					  WarDrawMap(0)
					     WAR.Person[p].Time = WAR.Person[k-1].Time					  
						 WAR.Person[k-1].Time = zj
					  WAR.CurID = z 
					  end
				   end
				end
				
				--无酒不欢：等待
				if WAR.Wait[id] == 1 then
					WAR.Wait[id] = 0
					WAR.Person[p].Time = WAR.Person[p].Time + 400
				end
				
			    if (PersonKF(id, 100) and PersonKF(id, 96)) or match_ID(id, 65) then
				WAR.Person[p].Time = WAR.Person[p].Time + 100
			    end
				
				
				--蛤蟆蓄力
				if WAR.HMGXL[id] == 1 then
					WAR.HMGXL[id] = 0
					WAR.Person[p].Time = WAR.Person[p].Time + 300
					if JY.Person[id]["专1"] == 95 then
					   WAR.Person[p].Time = WAR.Person[p].Time + 300
					end
				end
				
				--林平之根据伤害回气
				if match_ID_awakened(id, 36, 1) and WAR.LPZ > 0 then
					WAR.Person[p].Time = WAR.Person[p].Time + WAR.LPZ
					WAR.LPZ = 0
				end
				
				--无想流舞
				if match_ID(id, 686) and WAR.WXLW > 0 then
					WAR.Person[p].Time = WAR.Person[p].Time + WAR.WXLW
					WAR.WXLW = 0
				end
				
				--虚竹福泽加护
				if WAR.XZZ == 1 then
					WAR.XZZ = 0
					WAR.Person[p].Time = WAR.Person[p].Time + 200
				end
				if WAR.LBHQ ~= nil and WAR.LBHQ > 0 then
					WAR.Person[p].Time = WAR.Person[p].Time + 200 + 100*WAR.LBHQ
					WAR.LBHQ = 0
				end
				if match_ID(id, 688) and WAR.QJQC[id] ~= nil then
				   WAR.Person[p].Time = WAR.Person[p].Time + 700
				end
				if WAR.PG == 1 then
					WAR.PG = 0
					WAR.Person[p].Time = WAR.Person[p].Time + 200
				end
				
				--张三丰万法自然
				if match_ID(id, 5) and WAR.ZSF == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time + 500
					WAR.ZSF = 0
				end
				--神杖
				if match_ID(id, 689) and JY.Person[690]["天4"] == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time + math.random(400, 600)
				end	
				--豪鬼，集气提前
				if match_ID(id, 673) then
					WAR.Person[p].Time = WAR.Person[p].Time + 300
				end

				--七宝指环
				if JY.Person[id]["武器"]==200 then
					WAR.Person[p].Time = WAR.Person[p].Time + 100
				end
				
				--封不平狂风快剑
				if match_ID(id, 142) and WAR.KFKJ == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time + 300
					WAR.KFKJ = 0
				end
				
				--标准剑法
				if id == 0 and WAR.JZSJ == 1 then
				   WAR.Person[p].Time = WAR.Person[p].Time + 500
				   WAR.JZSJ = 0
				end
				
				if match_ID(id, 683) and WAR.XMKFJ == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time + 350
					WAR.XMKFJ = 0
				end
				
				--九剑真传，荡剑式，回气200
				if WAR.JJDJ == 1 and id == 0 then
					WAR.JJDJ = 0
					WAR.Person[p].Time = WAR.Person[p].Time + 200
				end
				
				--主运飞天回气200
				if Curr_QG(id,145) then
					WAR.Person[p].Time = WAR.Person[p].Time + 200
				end
				if PersonKF(id,145) and JY.Person[id]["专1"] == 145 then
					WAR.Person[p].Time = WAR.Person[p].Time + 150
				end
				
				if match_ID(id, 66) and JY.Person[66]["阶"] >= 2 then
					WAR.Person[p].Time = 300
				end
				
				--一灯，避免被反死
				if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil and WAR.JESS[65] == nil then
					JY.Person[65]["生命"] = 1
				end
				
				if (JY.Base["畅想"] == 65 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 65 or JY.Person[685]["天2"] == 65 or JY.Person[685]["天3"] == 65))) and JY.Person[0]["生命"] <= 0 and WAR.WCY[0] == nil and WAR.JESS[0] == nil then
					JY.Person[0]["生命"] = 1
				end
				
				--王重阳
				if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil and WAR.JESS[129] == nil then
					JY.Person[129]["生命"] = 1
				end
				
				if (JY.Base["畅想"] == 129 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 129 or JY.Person[685]["天2"] == 129 or JY.Person[685]["天3"] == 129))) and JY.Person[0]["生命"] <= 0 and WAR.CYZX[0] == nil and WAR.JESS[0] == nil then
					JY.Person[0]["生命"] = 1
				end
				
				--杨过，行动后集气初始位置额外增加
				--生命少过二分之一时每少100增加行动后集气位置加100
				if match_ID(id, 58) and JY.Person[id]["生命"] < JY.Person[id]["生命最大值"]/2 then
					WAR.Person[p].Time = WAR.Person[p].Time + math.floor(JY.Person[id]["生命最大值"]/2 - JY.Person[id]["生命"])
				end

				--无酒不欢 走投无路
				if JY.Base["特殊"] ==1 and JY.Person[29]["血量翻倍"]==1 and id==0 and JY.Person[id]["生命"] < JY.Person[id]["生命最大值"]/4 then
					WAR.Person[p].Time = WAR.Person[p].Time + math.floor(JY.Person[id]["生命最大值"]/4 - JY.Person[id]["生命"])
				end
				  
				--阎基偷钱
				if WAR.YJ > 0 then
					instruct_2(174, WAR.YJ)
					WAR.YJ = 0
				end
				
				--盲目状态恢复
				--[[
				if WAR.KHCM[pid] == 2 then
					WAR.KHCM[pid] = 0
					Cls()
					DrawStrBox(-1, -1, "盲目状态恢复", C_ORANGE, CC.DefaultFont)
					ShowScreen()
					lib.Delay(500)
				end]]
				
				--宋远桥使用太极拳或太极剑攻击后自动进入防御状态
				if match_ID(id, 171) and WAR.WDRX == 1 then
					War_DefupMenu()
					WAR.WDRX = 0
				end

				--阿二使用龙爪手攻击后自动进入蓄力状态				
				if match_ID(id, 644) and WAR.AER == 1 then
					War_ActupMenu()
					WAR.AER = 0
				end  
				
				if WAR.Actup[id] ~= nil then
					if WAR.ZXXS[id] ~= nil then				--紫霞蓄势状态，蓄力不减
						WAR.ZXXS[id] = WAR.ZXXS[id] - 1
						if WAR.ZXXS[id] == 0 then
							WAR.ZXXS[id] = nil
						end
					else
						WAR.Actup[id] = WAR.Actup[id] - 1	--蓄力，行动一次减1
					end
				end
				
				if WAR.Actup[id] == 0 then
					WAR.Actup[id] = nil
				end
				
				if WAR.SLSX[pid] ~= nil then
					WAR.SLSX[pid] = WAR.SLSX[pid] - 1
					if WAR.SLSX[pid] == 0 then
						WAR.SLSX[pid] = nil
					end
				end
				
				--集中状态
				if WAR.Focus[id] ~= nil then
					WAR.Focus[id] = nil
				end
				
				--行动后漏出破绽
				WAR.Weakspot[id] = 0
				
				--辟邪冷却时间恢复
				if WAR.BXLQ[id] then
					for i = 1, 6 do
						WAR.BXLQ[id][i] = WAR.BXLQ[id][i] - 1
						if WAR.BXLQ[id][i] < 0 then
							WAR.BXLQ[id][i] = 0
						end
					end
				end
				
				--傲寒六诀
				if WAR.AHLQ[id] then
					for i = 1, 6 do
						WAR.AHLQ[id][i] = WAR.AHLQ[id][i] - 1
						if WAR.AHLQ[id][i] < 0 then
							WAR.AHLQ[id][i] = 0
						end
					end
				end
				
				--莫名剑法冷却时间恢复
			    if WAR.MMLQ[id] then
				    for i = 1, 15 do
					   WAR.MMLQ[id][i] = WAR.MMLQ[id][i] - 1
					   if WAR.MMLQ[id][i] < 0 then
						    WAR.MMLQ[id][i] = 0
					   end
				    end
			    end
				--kflq
				if WAR.KungfuLQ[id] then
				    for i = 1, 252 do
					 if WAR.KungfuLQ[id][i] then
					   WAR.KungfuLQ[id][i] = WAR.KungfuLQ[id][i] - 1
					   if WAR.KungfuLQ[id][i] < 0 then
						    WAR.KungfuLQ[id][i] = nil
					   end
					 end					 
				    end
			    end
				if WAR.WGJY[id] then
				   WAR.WGJY[id] = nil
				end
				if WAR.WGJY2[id] then
				   WAR.WGJY2[id] = WAR.WGJY2[id] - 1
				   if WAR.WGJY2[id] <= 0 then
					  WAR.WGJY2[id] = nil
				   end
				end
				
				if WAR.LMLQ[id] then
				    for i = 1, 6 do
					   WAR.LMLQ[id][i] = WAR.LMLQ[id][i] - 1
					   if WAR.LMLQ[id][i] < 0 then
						    WAR.LMLQ[id][i] = 0
					   end
				    end
			    end
				
				if WAR.SFLQ[id] then
					for i = 1, 4 do
						WAR.SFLQ[id][i] = WAR.SFLQ[id][i] - 1
						if WAR.SFLQ[id][i] < 0 then
							WAR.SFLQ[id][i] = 0
						end
					end
				end
				if WAR.YSZLQ[id] then
					for i = 1, 4 do
						WAR.YSZLQ[id][i] = WAR.YSZLQ[id][i] - 1
						if WAR.YSZLQ[id][i] < 0 then
							WAR.YSZLQ[id][i] = 0
						end
					end
				end
				if WAR.YSJLQ[id] then
					for i = 1, 4 do
						WAR.YSJLQ[id][i] = WAR.YSJLQ[id][i] - 1
						if WAR.YSJLQ[id][i] < 0 then
							WAR.YSJLQ[id][i] = 0
						end
					end
				end
				
				
				--乔峰的铁掌名字恢复
				JY.Wugong[13]["名称"] = "铁掌"
				
				--斩流剑术名字恢复
				JY.Wugong[151]["名称"] = "斩流剑术"

				--全真剑法玉女剑法名字恢复
				JY.Wugong[39]["名称"] = "全真剑法"
				JY.Wugong[42]["名称"] = "玉女剑法"
				
				--周伯通，每行动一次，攻击时伤害一+10%
				if match_ID(id, 64) then
					WAR.ZBT = WAR.ZBT + 1
				end

				--无酒不欢持之以恒
				if JY.Base["特殊"] ==1 and JY.Person[31]["血量翻倍"]==1 and pid==0 then
					WAR.WJBH = WAR.WJBH + 1
				end
				
				--王重阳北斗七闪状态减少
				if match_ID(id, 129) and WAR.CYZX[id] ~= nil and WAR.BDQS > 0 then
					WAR.BDQS = WAR.BDQS - 1
					if WAR.BDQS == 0 then
						CurIDTXDH(WAR.CurID, 126,1,"北斗七闪・收招",C_GOLD);
					end
				end
				
				if match_ID(id, 688) and WAR.QJQC[id] ~= nil then
					WAR.QJQC[id] = WAR.QJQC[id] - 1
					if WAR.QJQC[id] == 0 then
					   WAR.QJQC[id] = nil
						CurIDTXDH(WAR.CurID, 35,1,"七进七出・完",PinkRed);
					end
				end
				
				--萧远山 走火入魔
				if match_ID(id, 112) and WAR.XYS > 0 then
					WAR.XYS = WAR.XYS - 1
					if JY.Person[112]["阶"] >= 3 then
					else
					if WAR.XYS == 0 then
						CurIDTXDH(WAR.CurID, 124,1,"走火入魔",C_GOLD);
						WAR.ZHRM[id]=5
					end
					end
				end
				
				--暴怒恢复
				if WAR.LQZ[id] == 100 then
					--王重阳北斗七闪状态行动后暴怒不减 文泰来行动后暴怒不减
					if not (match_ID(id, 129) and WAR.CYZX[id] ~= nil and WAR.BDQS > 0) then
					if not (match_ID(id, 112) and WAR.ZHRM[id] == nil and WAR.XYS > 0) then
					if not match_ID(id, 673) then --豪鬼怒气
					if not match_ID(id, 151) then
					if not match_ID(id, 693) then
						WAR.LQZ[id] = 0
					end
				end
				end
				end
				end
				end
				
				--吸星大法给自己加怒气
				if	WAR.BMSGXL > 0 and id == 0	and WAR.XXDFCS==0 then
					WAR.XXDFCS=WAR.XXDFCS+1
					WAR.BMSGXL = 0
				end
				
				if id == 0 and WAR.XXDFCS>0 then
				WAR.LQZ[id] =(WAR.LQZ[id] or 0)+20
					if WAR.LQZ[id] > 100 then
					WAR.LQZ[id] = 100
				if (match_ID(id, 114) or match_ID(id, 652) or match_ID(id, 149)) and WAR.LQZ[id] ~= nil and WAR.LQZ[id] == 100 then
				   CurIDTXDH(WAR.CurID, 104, 1, "业由心生，回转有道", C_RED)
				   if WAR.FXDS[id] ~= nil then
					WAR.FXDS[id] = nil
					WAR.FXXS[id] = nil
				   end
				   WAR.LQZ[id] = nil
				   JY.Person[id]["受伤程度"] = 0
				   WAR.YYXS[id] = 15
				   
				elseif WAR.LQZ[id] ~= nil and WAR.LQZ[id] == 100 then
				CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
					end
				end		
				end
				
				--刀主大招，行动后恢复怒气
				if id == 0 and JY.Base["标准"] == 4 and WAR.YZHYZ > 0 then
					WAR.LQZ[id] = limitX((WAR.LQZ[id] or 0) + WAR.YZHYZ, 0, 100)
					WAR.YZHYZ = 0
					if WAR.LQZ[id] ~= nil and WAR.LQZ[id] == 100 then
						CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
					end
				end
				--文泰来
				if WAR.WTL == 1 then
					for j = 0, WAR.PersonNum - 1 do
						if match_ID(WAR.Person[j]["人物编号"], 151) and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
							WAR.Person[j].Time = 980
							say("你打赢就算了，还想取人性命。你是不是不把我奔雷手文泰来放在眼里！", 521,0,"奔雷手文泰来")
							WAR.WTL = 0
						end
					end
				end
				--胡斐
	            if JY.Person[1]["阶"] >= 3 then
					local z = WAR.CurID
					local m = 0
					for j = 0, WAR.PersonNum - 1 do
						if WAR.Person[j]["死亡"] == false and match_ID(WAR.Person[j]["人物编号"], 1) then
							WAR.CurID = j
							m = 1
							break
						end
					end
					if m == 1 and WAR.AutoFight == 0 and math.random(100) > 70 then
						War_CalMoveStep(WAR.CurID, 3, 2)
						local x, y = nil, nil
						while 1 do
							if JY.Restart == 1 then
								break
							end
							x, y = War_SelectMove()
							if x ~= nil then
								WAR.ShowHead = 0
								War_MovePerson(x, y)
								break;
							end
						end
					end
					WAR.CurID = z
	            end
				--胡青牛
	            if JY.Person[16]["阶"] >= 3 then
					local z = WAR.CurID
					local m = 0
					for j = 0, WAR.PersonNum - 1 do
						if WAR.Person[j]["死亡"] == false and match_ID(WAR.Person[j]["人物编号"], 16) then
							WAR.CurID = j
							m = 1
							break
						end
					end
					if m == 1 and math.random(100) < 10 + math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["实战"]*0.05) then
						War_AutoDoctor()
					end
					WAR.CurID = z
	            end
				--xyz
				if WAR.XYZ == 1 then
					for j = 0, WAR.PersonNum - 1 do
						if match_ID(WAR.Person[j]["人物编号"], 634) and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
						   WAR.Person[j].Time = 999
						   local s = WAR.CurID
							WAR.CurID = j
							Cls()
							CurIDTXDH(WAR.CurID, 121,1,"逍遥御风，以游无穷",M_RoyalBlue)
							WAR.CurID = s
							
							WAR.XYZ = 0
						end
					end
				end
				
				if WAR.KAEL == 1 then
					for j = 0, WAR.PersonNum - 1 do
						if WAR.Person[j]["人物编号"]== 689 and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
						   WAR.Person[j].Time = 999
						   local s = WAR.CurID
							WAR.CurID = j
							WAR.CurID = s
							
							WAR.KAEL = 0
						end
					end
				end

				--杨过 吼  龙儿~~
				if WAR.XK == 1 then
					for j = 0, WAR.PersonNum - 1 do
						if WAR.Person[j]["人物编号"] == 58 and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
							WAR.Person[j].Time = 980
							say("１Ｒ龙儿－－－－－－！Ｈ５啊－－－－４－－－－３－－－－２－－－－１－－－－－－－－！！！", 58,0)
							WAR.XK = 2
						end
					end
				end
				
				if WAR.XK == 1 then
					for j = 0, WAR.PersonNum - 1 do
						if WAR.Person[j]["人物编号"] == 614 and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
							WAR.Person[j].Time = 980
							say("１Ｒ龙儿－－－－－－！Ｈ５啊－－－－４－－－－３－－－－２－－－－１－－－－－－－－！！！", 58,0)
							WAR.XK = 2
						end
					end
				end
				
				--发动 难知如阴
				if WAR.FLHS5 == 1 then
					local z = WAR.CurID
					for j = 0, WAR.PersonNum - 1 do
						if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
							WAR.FLHS5 = 2
							WAR.CurID = j
						end
					end
					if WAR.FLHS5 == 2 and WAR.AutoFight == 0 then
						WAR.Person[WAR.CurID]["移动步数"] = 6
						War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
						local x, y = nil, nil
						while 1 do
							if JY.Restart == 1 then
								break
							end
							x, y = War_SelectMove()
							if x ~= nil then
								WAR.ShowHead = 0
								War_MovePerson(x, y)
								break;
							end
						end
					end
					WAR.FLHS5 = 0
					WAR.CurID = z
				end
				
				--圣火神功 攻击后可移动
				if ((WAR.Person[p]["移动步数"] > 0 or 0 < WAR.ZYYD) or JY.Person[WAR.Person[p]["人物编号"]]["专1"] == 93) and WAR.Person[p]["我方"] == true and inteam(id) and WAR.AutoFight == 0 and PersonKF(id, 93) and 0 < JY.Person[id]["生命"] then
				   if JY.Person[WAR.Person[p]["人物编号"]]["专1"] == 93 then
					if 0 < WAR.ZYYD then
						WAR.Person[p]["移动步数"] = WAR.ZYYD
						if JY.Person[WAR.Person[p]["人物编号"]]["专1"] == 93 then
						   WAR.ZYYD = WAR.ZYYD + 3
						end
						War_CalMoveStep(p, WAR.ZYYD, 0)
					else
					    if JY.Person[WAR.Person[p]["人物编号"]]["专1"] == 93 then
						   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 3
						end
						War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
					end
					
				   else
				    if 0 < WAR.ZYYD then
						WAR.Person[p]["移动步数"] = WAR.ZYYD
						War_CalMoveStep(p, WAR.ZYYD, 0)
					else
						War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
					end
				   end
					local x, y = nil, nil
					while 1 do
						if JY.Restart == 1 then
							break
						end
						x, y = War_SelectMove()
						if x ~= nil then
							WAR.ShowHead = 0
							War_MovePerson(x, y)
							break;
						end 
					end
				end
				
				--逍遥子
				if JY.Person[634]["天1"] == 1 and (WAR.Person[p]["移动步数"] > 0 or 0 < WAR.XYZD) and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] then
				    if WAR.XYZD > 0 then
					War_CalMoveStep(p, WAR.XYZD, 0)
					else
					War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
					end
					local x, y = nil, nil
					while 1 do
						if JY.Restart == 1 then
							break
						end
						x, y = War_SelectMove()
						if x ~= nil then
							WAR.ShowHead = 0
							War_MovePerson(x, y)
							break;
						end 
					end
				end
				
				--无酒不欢：无论是否触发了圣火再移动，这个变量都应该在这一步清除，否则会影响到下一个人的圣火判定
				--触发周伯通左右补偿不清除
				if WAR.ZHB == 0 then
					WAR.ZYYD = 0
					WAR.XYZD = 0
				end
				
				--周伯通的追加互搏判定
				if WAR.ZHB == 1 then
					WAR.ZHB = 0
				end
				
				--阿凡提 攻击后可移动
				if match_ID(id,606) and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] then
					WAR.Person[p]["移动步数"] = 10
					War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
					local x, y = nil, nil
					while 1 do
						if JY.Restart == 1 then
							break
						end
						x, y = War_SelectMove()
						if x ~= nil then
							WAR.ShowHead = 0
							War_MovePerson(x, y)
							break;
						end 
					end
				end
				
				
				--攻击后可移动
				if id == 0 and JY.Person[0]["天3"] == 1 and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] then
					WAR.Person[p]["移动步数"] = 2
					War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
					local x, y = nil, nil
					while 1 do
						if JY.Restart == 1 then
							break
						end
						x, y = War_SelectMove()
						if x ~= nil then
							WAR.ShowHead = 0
							War_MovePerson(x, y)
							break;
						end 
					end
				end
				
				if JY.Person[id]["地4"] == 6 and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] then
					WAR.Person[p]["移动步数"] = 5
					War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
					local x, y = nil, nil
					while 1 do
						if JY.Restart == 1 then
							break
						end
						x, y = War_SelectMove()
						if x ~= nil then
							WAR.ShowHead = 0
							War_MovePerson(x, y)
							break;
						end 
					end
				end
				
				if JY.Person[id]["人26"] == 1 and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] then
					WAR.Person[p]["移动步数"] = 6
					War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
					local x, y = nil, nil
					while 1 do
						if JY.Restart == 1 then
							break
						end
						x, y = War_SelectMove()
						if x ~= nil then
							WAR.ShowHead = 0
							War_MovePerson(x, y)
							break;
						end 
					end
				end
								
				--逍遥游
				if WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] and WAR.XYYD == 1 then
					WAR.Person[p]["移动步数"] = 6
					War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
					local x, y = nil, nil
					while 1 do
						if JY.Restart == 1 then
							break
						end
						x, y = War_SelectMove()
						if x ~= nil then
							WAR.ShowHead = 0
							War_MovePerson(x, y)
							break;
						end 
					end
					WAR.XYYD = 0
				end
				
				--攻击后可移动
				if match_ID(id,675) and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] and WAR.CWMM == 1 then
					WAR.Person[p]["移动步数"] = 10
					War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
					local x, y = nil, nil
					while 1 do
						if JY.Restart == 1 then
							break
						end
						x, y = War_SelectMove()
						if x ~= nil then
							WAR.ShowHead = 0
							War_MovePerson(x, y)
							break;
						end 
					end
					WAR.CWMM = 0
				end
				
				--雪山上杀血刀老祖后，恢复我方人物
				if WAR.ZDDH == 7 then
					for x = 0, WAR.PersonNum - 1 do
						if WAR.Person[x]["人物编号"] == 97 and JY.Person[97]["生命"] <= 0 then
							for xx = 0, WAR.PersonNum - 1 do
								if WAR.Person[xx]["人物编号"] ~= 97 then
									WAR.Person[xx]["我方"] = true
								end
							end
						end
					end
				end
				
				--无酒不欢：、、、
				if WAR.ZDDH == 54 and lib.GetWarMap(11, 36, 1) == 2 and inteam(WAR.Person[p]["人物编号"]) and WAR.Person[p]["坐标X"] == 12 and WAR.Person[p]["坐标Y"] == 36 then
					lib.SetWarMap(11, 36, 1, 5420)
					WarDrawMap(0)
					say("AA")
					say("OHMYGO", 27)
					lib.SetWarMap(11, 36, 1, 0)
				end
				
				--九剑破招减少集气
				if WAR.JJPZ[id] == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time - 400
					WAR.JJPZ[id] = nil
				end
				
				--太空卸劲减少集气
				if WAR.TKJQ[id] == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time - 200
					WAR.TKJQ[id] = nil
				end
				--以静制动
				if WAR.YJZD[id] == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time - 200
					WAR.YJZD[id] = nil
				end
				
				--借气回元
				if WAR.JQHY[id] == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time - WAR.JQJQ
					WAR.JQHY[id] = nil
				end
				
				--其疾如风，集气500，LiangJC:如风移动这里修复圣火移动不显示问题
				if WAR.FLHS1[id] == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time + 500
					WAR.FLHS1[id] = nil
				end
				
				--行动后回气的效果上限600点
				if 600 < WAR.Person[p].Time then
					WAR.Person[p].Time = 600
				end
				
				--衡山五神剑
                if WAR.YHZR == 1 then
				   War_ActupMenu()
				   War_DefupMenu()
				   WAR.YHZR = 0
                   WAR.Person[p].Time = WAR.Person[p].Time + 700
                end	
				--秋风卷叶
                if WAR.QFJY == 1 then
				   WAR.QFJY = 0
                   WAR.Person[p].Time = WAR.Person[p].Time + 800
                end
				
				if 800 < WAR.Person[p].Time then
					WAR.Person[p].Time = 800
				end
				
				if 1000 < WAR.Person[p].Time then
					WAR.Person[p].Time = 1000
				end
				
				--逍遥御风
				if WAR.XYYF_10 == 1 then
					WAR.XYYF_10 = 0
					for j = 0, WAR.PersonNum - 1 do
						if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] and WAR.XYYF[WAR.Person[j]["人物编号"]] and WAR.XYYF[WAR.Person[j]["人物编号"]] == 11 then
							WAR.Person[j].Time = 999
							
							--封穴清0
							if WAR.FXDS[WAR.Person[j]["人物编号"]] ~= nil then
								WAR.FXDS[WAR.Person[j]["人物编号"]] = nil
							end
							
							local s = WAR.CurID
							WAR.CurID = j
							Cls()
							CurIDTXDH(WAR.CurID, 105,1,"乘天地之正 御六气之辩",C_GOLD)
							WAR.CurID = s
						end
					end
				end
				
				--豪鬼，炽烈爆发
				if match_ID(id, 673) and WAR.CLBF == 1 and War_isEnd() == 0 then	
					WAR.Person[WAR.CurID].Time = 1005					
				end
				
				if match_ID(id, 688) and WAR.HSSD == 1 and War_isEnd() == 0 then	
					WAR.Person[WAR.CurID].Time = 1005					
				end
				
				if match_ID(id, 36) and WAR.XFXY == 1 and War_isEnd() == 0 then	
					WAR.Person[WAR.CurID].Time = 1005
				end
				
				--无酒不欢：袁承志，碧血长风，杀人后再动
				if match_ID(id, 54) and WAR.BXCF == 1 and War_isEnd() == 0 then	
					for i = 12, 24 do
						NewDrawString(-1, -1, "碧血长风", C_RED, 25 + i)
						ShowScreen()
						if i == 24 then
							Cls()
							NewDrawString(-1, -1, "碧血长风", C_RED, 25 + i)
							ShowScreen()
							lib.Delay(500)
						else
							lib.Delay(1)
						end
					end
					for j = 0, WAR.PersonNum - 1 do
						WAR.Person[j].Time = WAR.Person[j].Time - 10
						if 995 < WAR.Person[j].Time then
							WAR.Person[j].Time = 995
						end
					end
					WAR.Person[WAR.CurID].Time = 1005
						
					WAR.BXCF = 0		
				end
				
				if JY.Person[id]["地9"] == 8 and War_isEnd() == 0 then	
				local jl = 40
	                  if WAR.LQZ[id] ~= nil then
	                     jl = jl + WAR.LQZ[id]*0.2
	                  end
				if math.random(100) < jl then
					for j = 0, WAR.PersonNum - 1 do
						WAR.Person[j].Time = WAR.Person[j].Time - 10
						if 995 < WAR.Person[j].Time then
							WAR.Person[j].Time = 995
						end
					end
					WAR.Person[WAR.CurID].Time = 1005
				end	
							
				end
				
				if match_ID(id, 636) and WAR.YBYS == 1 then
				   WAR.Person[WAR.CurID].Time = 1005
				   WAR.YBYS = 0
				end
				
				--资质越高发动几率越高
				local pz = math.modf(JY.Person[0]["资质"] / 10)
				local zj = 0
	            --emu
	            if WAR.ZDDH == 322 then
	               dofile(CC.Acvmts)
	               local tf = Achievements.pChar[1000].CharTd
	               if tf > 1000 then
	                  tf = tf - 1677
	               end
	               if tf < 10 then
                   local zj = tf
	               end   
	            end
				--主角医生大招，直接再次行动
				if (id == 0 and JY.Base["标准"] == 8 or (id == 0 and JY.Person[246]["品德"] == 100 and JLSD(25, 30, id)) or (id == 677 and zj == 8 and JLSD(25, 60 + pz, id))) and JY.Person[pid]["六如觉醒"] > 0 then
					if 50 < JY.Person[0]["体力"] then
						if WAR.HTSS == 0 and JLSD(25, 60 + pz, 0) and 0 < JY.Person[0]["武功9"] then
							CurIDTXDH(WAR.CurID, 91, 1)
							Cls()
							  
							ShowScreen()
							lib.Delay(40)
							for i = 12, 24 do
								NewDrawString(-1, -1, ZJTF[8] .. TFSSJ[8], C_GOLD, 25 + i)
								ShowScreen()
								if i == 24 then
									Cls()
									NewDrawString(-1, -1, ZJTF[8] .. TFSSJ[8], C_GOLD, 25 + i)
									ShowScreen()
									lib.Delay(500)
								else
									lib.Delay(1)
								end
							end
							for j = 0, WAR.PersonNum - 1 do
								WAR.Person[j].Time = WAR.Person[j].Time - 10
								if 995 < WAR.Person[j].Time then
									WAR.Person[j].Time = 995
								end
							end
							WAR.Person[WAR.CurID].Time = 1005
							JY.Person[0]["体力"] = JY.Person[0]["体力"] - 10
							--有低概率再次发动
							if JLSD(45, 50, 0) then
								WAR.HTSS = 0        
							else
								WAR.HTSS = 1
							end
						end
					else
						WAR.HTSS = 0
					end
				end
				  
				--成昆密道 100时序就跑
				if WAR.ZDDH == 237 and 100 < WAR.SXTJ then
					for i = 0, WAR.PersonNum - 1 do
						if WAR.Person[i]["我方"] == false then
							WAR.Person[i]["死亡"] = true
						end
					end
					say("１Ｌ＜嗯，没功夫跟这"..JY.Person[0]["外号2"].."纠缠了＞Ｗ哈哈哈，"..JY.Person[0]["外号2"].."，算你走运！老夫还有要事待办，这次就放你一马！", 18,0)
				end
				
				--张三丰 太极神功100时序
				if WAR.ZDDH == 22 and 100 < WAR.SXTJ then
					for i = 0, WAR.PersonNum - 1 do
						if WAR.Person[i]["我方"] == false then
							WAR.Person[i]["死亡"] = true
						end
					end
					if JY.Person[0]["性别"] == 0 then
						TalkEx("小兄弟年纪轻轻，武功就已到如此境界，实属难得。今日就到此为止。", 5, 0)  --对话
					else
						TalkEx("小姑娘年纪轻轻，武功就已到如此境界，实属难得。今日就到此为止。", 5, 0)  --对话
					end			
				end
				
		
				--飞正苗人凤100时序
				if WAR.ZDDH == 4 and 100 < WAR.SXTJ then
					for i = 0, WAR.PersonNum - 1 do
						if WAR.Person[i]["我方"] == false then
							WAR.Person[i]["死亡"] = true
						end
					end
					if JY.Person[0]["性别"] == 0 then
						TalkEx("小兄弟武艺高强，苗某佩服。这本《飞狐外传》就交给你啦。", 3, 0)  --对话
					else
						TalkEx("小姑娘武艺高强，苗某佩服。这本《飞狐外传》就交给你啦。", 3, 0)  --对话
					end			
				end	 
				  
				--冰糖恋：正十五大20时序胜利
				if WAR.ZDDH == 134 and 20 < WAR.SXTJ and GetS(87,31,32,5) == 1 then
					for i = 0, WAR.PersonNum - 1 do
						if WAR.Person[i]["我方"] == false then
							WAR.Person[i]["死亡"] = true
						end
					end
					TalkEx("恭喜"..JY.Person[0]["外号"].."挺过20时序，成功过关。",269,0);
				end
		
				--冰糖恋：邪十五大20时序胜利
				if WAR.ZDDH == 133 and 20 < WAR.SXTJ and GetS(87,31,31,5) == 1 then
					for i = 0, WAR.PersonNum - 1 do
						if WAR.Person[i]["我方"] == false then
							WAR.Person[i]["死亡"] = true
						end
					end
					TalkEx("恭喜"..JY.Person[0]["外号"].."挺过20时序，成功过关。",269,0);
				end
				
				--踏雪无痕的移动记录
				local TXWH_X,TXWH_Y = WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]
				local TXYD_X = math.abs(TXWH_X - WAR.TXWH[pid][1])
				local TXYD_Y = math.abs(TXWH_Y - WAR.TXWH[pid][2])
				WAR.TXWH[pid][3] = TXYD_X + TXYD_Y
				
				--登萍渡水的集气
				if Curr_QG(pid, 179) then
					WAR.DPJQ[pid] = (WAR.DPJQ[pid] or 0) + 1
				end
			end
			if WAR.CLBF == 2 then
				WAR.CLBF = 0
			end
			if WAR.HSSD == 2 then
			   WAR.HSSD = 0
			end   
			local war_Status = War_isEnd()   --战斗是否结束？   0继续，1赢，2输
			if 0 < war_Status then
				break
			end
			--军神再临第二次行动的集气
			if times > 1 and i ~= times then
				WAR.Person[WAR.CurID].Time = 1001
			end
		end
		break
	end
	    --[[
		warStatus = War_isEnd()   --战斗是否结束？   0继续，1赢，2输
		if 0 < warStatus then
			break
		end
		CleanMemory()]]
    end
	CleanMemory()
	warStatus = War_isEnd()   --战斗是否结束？   0继续，1赢，2输
    if 0 < warStatus then
		if warStatus == 1 and WAR.ZDDH == 310 then
			if JY.Person[665]['声望'] == 0 then
				JY.Person[665]['声望'] = JY.Person[665]['声望'] + 1
				NewWARPersonZJ(666, false, 21, 26, false, 1)
				JY.Person[666]["主运轻功"] = 180
				JY.Person[666]["主运内功"] = 105
			elseif JY.Person[665]['声望'] == 1 then
				JY.Person[665]['声望'] = JY.Person[665]['声望'] + 2
				NewWARPersonZJ(667, false, 21, 26, false, 1)
				JY.Person[667]["主运轻功"] = 181
				JY.Person[667]["主运内功"] = 186
--[[			elseif JY.Person[665]['声望'] == 2 then
				JY.Person[665]['声望'] = JY.Person[665]['声望'] + 1
				NewWARPersonZJ(668, false, 21, 26, false, 1)
				JY.Person[668]["主运轻功"] = 182
				JY.Person[668]["主运内功"] = 106
				JY.Person[668]["生命最大值"] = 20000
				JY.Person[668]["内力最大值"] = 20000--]]
			elseif JY.Person[665]['声望'] == 3 then
				JY.Person[665]['声望'] = JY.Person[665]['声望'] + 1
				break
			end
		else
			break
		end
    end
    WarPersonSort(1)
    WAR.Delay = GetJiqi()
    startt = lib.GetTime()
    collectgarbage("step", 0)
  end
  local r = nil
  WAR.ShowHead = 0
 
	--战斗结束后的奖励
	if WAR.ZDDH == 238 then
		PlayMIDI(111)
		PlayWavAtk(41)
		DrawStrBoxWaitKey("论剑结束", C_WHITE, CC.DefaultFont)
		DrawStrBoxWaitKey("武功天下第一者：" .. JY.Person[WAR.NO1]["姓名"], C_RED, CC.DefaultFont)
		if WAR.NO1 == 0 then
		  r = true
		else
		  r = false
		end
	--战斗胜利
	elseif warStatus == 1 then
		PlayMIDI(111)
		PlayWavAtk(41)
		--DrawStrBoxWaitKey("战斗胜利", C_WHITE, CC.DefaultFont)
		lib.LoadPNG(1, 998 * 2 , 295, 295, 1)
		ShowScreen();
		WaitKey();
		if WAR.ZDDH == 76 then
			DrawStrBoxWaitKey("特殊奖励：主角五系兵器值提升十点", C_GOLD, CC.DefaultFont)
			AddPersonAttrib(0, "拳掌功夫", 10)
			AddPersonAttrib(0, "指法技巧", 10)
			AddPersonAttrib(0, "御剑能力", 10)
			AddPersonAttrib(0, "耍刀技巧", 10)
			AddPersonAttrib(0, "特殊兵器", 10)
		elseif WAR.ZDDH == 15 or WAR.ZDDH == 80 or WAR.ZDDH == 170 then
			DrawStrBoxWaitKey("特殊奖励：主角五系兵器值提升十点", C_RED, CC.DefaultFont,nil,C_GOLD)
			AddPersonAttrib(0, "拳掌功夫", 10)
			AddPersonAttrib(0, "指法技巧", 10)
			AddPersonAttrib(0, "御剑能力", 10)
			AddPersonAttrib(0, "耍刀技巧", 10)
			AddPersonAttrib(0, "特殊兵器", 10)
		elseif WAR.ZDDH == 165 then
			DrawStrBoxWaitKey("特殊奖励：主角攻击力提升二十点", C_GOLD, CC.DefaultFont)
			AddPersonAttrib(0, "攻击力", 20)
		elseif WAR.ZDDH == 100 or WAR.ZDDH == 0 then
			DrawStrBoxWaitKey("特殊奖励：主角攻击力防御力轻功各提升十点", C_GOLD, CC.DefaultFont)
			AddPersonAttrib(0, "攻击力", 10)
			AddPersonAttrib(0, "防御力", 10)
			AddPersonAttrib(0, "轻功", 10)
		elseif WAR.ZDDH == 77 then
			DrawStrBoxWaitKey("特殊奖励：获得瞬息千里秘籍一本", C_GOLD, CC.DefaultFont)
			instruct_2(297,1)	--瞬息千里
		elseif WAR.ZDDH == 173 then
			local hqjl = JYMsgBox("特殊奖励", "你完成了奖励战**请选择一项兵器值进行提高", {"拳法","指法","剑法","刀法","奇门"}, 5, 60)
			if hqjl == 1 then
				AddPersonAttrib(0, "拳掌功夫", 10)
				DrawStrBoxWaitKey("你的拳掌功夫提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 2 then
				AddPersonAttrib(0, "指法技巧", 10)
				DrawStrBoxWaitKey("你的指法技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 3 then
				AddPersonAttrib(0, "御剑能力", 10)
				DrawStrBoxWaitKey("你的御剑能力提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 4 then
				AddPersonAttrib(0, "耍刀技巧", 10)
				DrawStrBoxWaitKey("你的耍刀技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 5 then
				AddPersonAttrib(0, "特殊兵器", 10)
				DrawStrBoxWaitKey("你的特殊兵器提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			end
		elseif WAR.ZDDH == 188 then
			local hqjl = JYMsgBox("特殊奖励", "你完成了奖励战**请选择一项兵器值进行提高", {"拳法","指法","剑法","刀法","奇门"}, 5, 69)
			if hqjl == 1 then
				AddPersonAttrib(0, "拳掌功夫", 10)
				DrawStrBoxWaitKey("你的拳掌功夫提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 2 then
				AddPersonAttrib(0, "指法技巧", 10)
				DrawStrBoxWaitKey("你的指法技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 3 then
				AddPersonAttrib(0, "御剑能力", 10)
				DrawStrBoxWaitKey("你的御剑能力提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 4 then
				AddPersonAttrib(0, "耍刀技巧", 10)
				DrawStrBoxWaitKey("你的耍刀技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 5 then
				AddPersonAttrib(0, "特殊兵器", 10)
				DrawStrBoxWaitKey("你的特殊兵器提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			end
		elseif WAR.ZDDH == 292 then
			local hqjl = JYMsgBox("特殊奖励", "你完成了奖励战**请选择一项兵器值进行提高", {"拳法","指法","剑法","刀法","奇门"}, 5, 6)
			if hqjl == 1 then
				AddPersonAttrib(0, "拳掌功夫", 10)
				DrawStrBoxWaitKey("你的拳掌功夫提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 2 then
				AddPersonAttrib(0, "指法技巧", 10)
				DrawStrBoxWaitKey("你的指法技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 3 then
				AddPersonAttrib(0, "御剑能力", 10)
				DrawStrBoxWaitKey("你的御剑能力提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 4 then
				AddPersonAttrib(0, "耍刀技巧", 10)
				DrawStrBoxWaitKey("你的耍刀技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 5 then
				AddPersonAttrib(0, "特殊兵器", 10)
				DrawStrBoxWaitKey("你的特殊兵器提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			end
		elseif WAR.ZDDH == 211 then
			DrawStrBoxWaitKey("特殊奖励：主角防御力和轻功各提升十点", C_GOLD, CC.DefaultFont)
			AddPersonAttrib(0, "防御力", 10)
			AddPersonAttrib(0, "轻功", 10)
		elseif WAR.ZDDH == 86 then
			instruct_2(66, 1)
		elseif WAR.ZDDH == 4 then
			if JY.Person[0]["实战"] < 500 then
				QZXS(string.format("%s 实战增加%s点",JY.Person[0]["姓名"],30));
				JY.Person[0]["实战"] = JY.Person[0]["实战"] + 30
				if JY.Person[0]["实战"] > 500 then
					JY.Person[0]["实战"] = 500
				end
			end
		elseif WAR.ZDDH == 77 then
			if JY.Person[0]["实战"] < 500 then
				QZXS(string.format("%s 实战增加%s点",JY.Person[0]["姓名"],20));
				JY.Person[0]["实战"] = JY.Person[0]["实战"] + 20
				if JY.Person[0]["实战"] > 500 then
					JY.Person[0]["实战"] = 500
				end
			end
		elseif WAR.ZDDH > 42 and  WAR.ZDDH < 47 then
			if JY.Person[0]["实战"] < 500 then
				QZXS(string.format("%s 实战增加%s点",JY.Person[0]["姓名"],10));
				JY.Person[0]["实战"] = JY.Person[0]["实战"] + 10
				if JY.Person[0]["实战"] > 500 then
					JY.Person[0]["实战"] = 500
				end
			end
		elseif WAR.ZDDH == 161 then
			if JY.Person[0]["实战"] < 500 then
				QZXS(string.format("%s 实战增加%s点",JY.Person[0]["姓名"],30));
				JY.Person[0]["实战"] = JY.Person[0]["实战"] + 30
				if JY.Person[0]["实战"] > 500 then
					JY.Person[0]["实战"] = 500
				end
			end
		--战胜海大富
		elseif WAR.ZDDH == 259 then
			DrawStrBoxWaitKey("特殊奖励：获得化骨绵掌秘籍一本", C_GOLD, CC.DefaultFont)
			instruct_32(275,1)
		--新论剑奖励 根据敌人不同奖励不同
		elseif WAR.ZDDH == 266 then
			--老周
			if GetS(85, 40, 38, 4) == 64 then
				DrawStrBoxWaitKey("特殊奖励：你的体内消耗永久降低了65% ", LimeGreen, 36,nil, C_GOLD)
				JY.Person[64]["论剑奖励"] = 1
			--老王
			elseif GetS(85, 40, 38, 4) == 129 then
				DrawStrBoxWaitKey("特殊奖励：你的武学常识提高了100点 ", LimeGreen, 36,nil, C_GOLD)
				AddPersonAttrib(0, "武学常识", 100)
				JY.Person[129]["论剑奖励"] = 1
			--林朝英
			elseif GetS(85, 40, 38, 4) == 605 then
				DrawStrBoxWaitKey("特殊奖励：你的连击暴击永久提高了50% ", LimeGreen, 36,nil, C_GOLD)
				JY.Person[605]["论剑奖励"] = 1
			--阿青
			elseif GetS(85, 40, 38, 4) == 604 then
				DrawStrBoxWaitKey("特殊奖励：你的攻击无法闪避", LimeGreen, 36,nil, C_GOLD)
				JY.Person[604]["论剑奖励"] = 1
				--instruct_32(278,1)
			--风清扬
			elseif GetS(85, 40, 38, 4) == 140 then
				if PersonKF(0, 47) then
					DrawStrBoxWaitKey("特殊奖励：你获得了独孤九剑的真传", LimeGreen, 36,nil, C_GOLD)
					JY.Person[592]["论剑奖励"] = 1
				else
					DrawStrBoxWaitKey("你似乎错过了一项奖励……", LimeGreen, 36,nil, C_GOLD)
				end
			--东方不败
			elseif GetS(85, 40, 38, 4) == 27 then
				DrawStrBoxWaitKey("特殊奖励：你的集气速度永久提高了15点", LimeGreen, 36,nil, C_GOLD)
				JY.Person[27]["论剑奖励"] = 1
			--扫地
			elseif GetS(85, 40, 38, 4) == 114 then
				DrawStrBoxWaitKey("特殊奖励：你受到的伤害减少20%", LimeGreen, 36,nil, C_GOLD)
				JY.Person[114]["论剑奖励"] = 1
			--三丰
			elseif GetS(85, 40, 38, 4) == 5 then
				DrawStrBoxWaitKey("特殊奖励：你的武学感悟提高了", LimeGreen, 36,nil, C_GOLD)
				JY.Person[5]["论剑奖励"] = 1
				JY.Person[0]["感悟"] = JY.Person[0]["感悟"] + 150
				AddPersonAttrib(0, "拳掌功夫", 20)
				AddPersonAttrib(0, "指法技巧", 20)
				AddPersonAttrib(0, "御剑能力", 20)
				AddPersonAttrib(0, "耍刀技巧", 20)
				AddPersonAttrib(0, "特殊兵器", 20)
			--阿凡提
			elseif GetS(85, 40, 38, 4) == 606 then
				DrawStrBoxWaitKey("特殊奖励：你获得了绝对先手的能力", LimeGreen, 36,nil, C_GOLD)
				if 100 > WAR.SXTJ then
				instruct_2(279, 1)
				end
				JY.Person[606]["论剑奖励"] = 1
			--丁典
			elseif GetS(85, 40, 38, 4) == 672 then
			    say("无影神拳，不堪一击！",0,1)
				if JY.Person[673]["外号2"] == "怒" then
				DrawStrBoxWaitKey("特殊奖励：拳法提升100点，领悟绝技瞬狱杀", LimeGreen, 36,nil, C_GOLD)
				instruct_35(0, 2, 204, 999)
				else
				DrawStrBoxWaitKey("特殊奖励：拳法提升100点，领悟绝技赤鸦空裂破", LimeGreen, 36,nil, C_GOLD)
				instruct_35(0, 2, 205, 999)
				end
				say("笑止，千万！",0,1)
				AddPersonAttrib(0, "拳掌功夫", 100)
				--JY.Person[672]["论剑奖励"] = 1	
			end
		elseif WAR.ZDDH == 308 and JY.Person[654]['品德'] == 90 then
			JY.Person[654]['品德'] = 91
			AddPersonAttrib(0, "耍刀技巧", 10)
			DrawStrBoxWaitKey("你的耍刀技巧提高了10点", LimeGreen, CC.DefaultFont, nil, C_GOLD)
			if JY.Base["畅想"] == 29 then
			say("好刀法！",0,1)
			end
		elseif WAR.ZDDH == 308 and JY.Person[654]['品德'] == 91 then
			JY.Person[654]['品德'] = 92
			AddPersonAttrib(0, "耍刀技巧", 20)
			DrawStrBoxWaitKey("你的耍刀技巧提高了20点", LimeGreen, CC.DefaultFont, nil, C_GOLD)
			if JY.Base["畅想"] == 29 then
			say("好刀法！",0,1)
			end
			if JY.Base["畅想"]== 691 then
		       instruct_35(691, 1, 237,999)  --设置人物武功
			   AddPersonAttrib(0, "攻击力", 30)
			   AddPersonAttrib(0, "防御力", 30)
			   AddPersonAttrib(0, "轻功", 30)
		       AddPersonAttrib(0, "耍刀技巧", 30)
		       SetTianNei(691, 237)	
            end
		elseif WAR.ZDDH == 308 and JY.Person[654]['品德'] == 92 then
		    if JY.Base["畅想"] == 29 then
			say("好刀法！",0,1)
			end
			
			JY.Person[654]['品德'] = 93
		end
		--赵半山战斗胜利获得暗器
		if (JY.Base["畅想"] == 153 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 153 or JY.Person[685]["天2"] == 153 or JY.Person[685]["天3"] == 153))) and WAR.ZDDH ~= 226 then
			local anqi = math.random(28,35)
			local num = math.random(3)
			instruct_2(anqi,num)
		end
		if (JY.Base["畅想"] == 54 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 54 or JY.Person[685]["天2"] == 54 or JY.Person[685]["天3"] == 54))) and WAR.ZDDH ~= 226 and JY.Person[54]["阶"] >= 3 then
			instruct_2(30,math.random(2,6))
		end
		if JY.Person[0]["专2"] == 995 and WAR.ZDDH ~= 226 then
			local anqi = math.random(28,35)
			local num = math.random(3)
			instruct_2(anqi,num)
		end
		if WAR.ZDDH == 321 then
		    local anqi1 = math.random(28,35)
			local anqi2 = math.random(28,35)
			local num = math.random(2) 
			local t = math.modf(JY.Person[124]["天1"]*2.1)
			instruct_2(anqi1,num + math.random(t/10+1))
			instruct_2(anqi2,num + math.random(t/10+1))
			local med1 = math.random(0,8)
			local med2 = math.random(1,7)
			local med3 = math.random(3,13)
			instruct_2(med1,math.random(t/11+1))
			instruct_2(med2,math.random(t/13+1))
			instruct_2(med3,math.random(t/15+1))
			if math.random(100) < 11 then
			instruct_2(340,math.random(2))
			end
			local m,n = math.modf(JY.Person[124]["天1"]/3)
			local wp = {344,345,346,347,348,349,350,351,352,353,354,355,356,337,338,321,322,323,324,325,326,327,319,300,301,302,303,304,279,284,276,262,264,230,217,218,
			202,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63}
			      if (m > 0 and n == 0) or math.random(100) < 8 + JY.Person[124]["天1"]/3 then
				     instruct_2(wp[math.random(#wp)],1)
				  end
			local token = JY.Person[124]["天1"] + 12 + math.random(2)				
			JY.Person[0]["积分"] = JY.Person[0]["积分"] + token
			DrawStrBoxWaitKey("获得正义值:"..token, C_GOLD, CC.Fontbig, nil, C_GOLD)
		end	
		r = true
	--战斗失败
	elseif warStatus == 2 then
		--DrawStrBoxWaitKey("战斗失败", C_WHITE, CC.DefaultFont)
		lib.LoadPNG(1, 999 * 2 , 295, 295, 1)
		ShowScreen()
		WaitKey()
		r = false
	end
	
	War_EndPersonData(isexp, warStatus)
	
	if WAR.ZDDH ~= 226 and WAR.ZDDH < 312 and (JY.Person[0]["生命"]/JY.Person[0]["生命最大值"]) < 0.3 and JY.Dream == 0 and JY.Person[654]['品德'] ~= 93 and math.random(100) < 31 then
		for i = 0, WAR.PersonNum - 1 do
			local pid = WAR.Person[i]["人物编号"]
			JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
			JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
			JY.Person[pid]["体力"] = CC.PersonAttribMax["体力"]
			JY.Person[pid]["受伤程度"] = 0
			JY.Person[pid]["中毒程度"] = 0
			JY.Person[pid]["冰封程度"] = 0
			JY.Person[pid]["灼烧程度"] = 0
		end
		PlayMIDI(JY.Scene[125]["进门音乐"])
		S_Event_YYWD()
	elseif JY.Dream == 1 then
		JY.Dream = 0
		if JY.Person[654]['品德'] ~= 93 then
			return r
		end
	end
	
	
	--无酒不欢：战后状态恢复
	for i = 0, WAR.PersonNum - 1 do
		local pid = WAR.Person[i]["人物编号"]
		JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
		JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
		JY.Person[pid]["体力"] = CC.PersonAttribMax["体力"]
		JY.Person[pid]["受伤程度"] = 0
		JY.Person[pid]["中毒程度"] = 0
		JY.Person[pid]["冰封程度"] = 0
		JY.Person[pid]["灼烧程度"] = 0
		--JY.Person[pid]["出战"] = JY.Person[pid]["出战"] + 1
		if JY.Base["畅想"] == 692 and pid == 0 and JY.Person[692]["天3"] == 1 then
		   JY.Person[0]["姓名"] = "苏灿"
		end
	end
	
	lib.ShowSlow(20, 1)
	if 0 <= JY.Scene[JY.SubScene]["进门音乐"] then
		PlayMIDI(JY.Scene[JY.SubScene]["进门音乐"])
	else
		PlayMIDI(0)
	end
	CleanMemory()
	--杀意
	WAR.NLZ = {}
	--战斗结束，重新加载场景贴图
	lib.PicInit()
	lib.PicLoadFile(CC.SMAPPicFile[1], CC.SMAPPicFile[2], 0)	--子场景贴图，内存区域0
	lib.LoadPNGPath(CC.HeadPath, 1, CC.HeadNum, limitX(CC.ScreenW/936*100,0,100))	--人物头像，内存区域1
	lib.LoadPNGPath(CC.UIPath, 96, CC.UINum, limitX(CC.ScreenW/936*100,0,100))
	lib.PicLoadFile(CC.ThingPicFile[1], CC.ThingPicFile[2], 2, 100, 100)	--物品贴图，内存区域2
	JY.Status = GAME_SMAP
	return r
end

--萧中慧，布阵
function buzhen()
	if not inteam(77) then
		return 
	end
	if WAR.ZDDH == 226 then
		return 
	end
	local line = "要布置阵型吗？";
	local tiles = 2;
	if (WAR.ZDDH == 133 or WAR.ZDDH == 134) and WAR.MCRS == 1 then
		if JY.Person[0]["性别"] == 0 then
			line = "哥哥你真勇敢，一个人挑战十五大高手，请千万小心。"
		else
			line = "姐姐你真勇敢，一个人挑战十五大高手，请千万小心。"
		end
		tiles = 4
	end
	say(line, 77,0,JY.Person[77]["姓名"])
	if not DrawStrBoxYesNo(-1, -1, "要布置阵型吗？", C_WHITE, CC.DefaultFont) then
		return 
	end
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["我方"] then
			WAR.CurID = i
			WAR.ShowHead = 1
			--布阵统一为2格
			War_CalMoveStep(WAR.CurID, tiles, 0)
			local x, y = nil, nil
			while true do
				if JY.Restart == 1 then
					break
				end
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					War_MovePerson(x, y)
					break;
				end
			end
		end
	end
end

--无酒不欢：在自身位置播放动画的函数
function CurIDTXDH(id, eft, order, str, strColor, endFrame)
	--增加文字颜色控制
	if strColor == nil then
		strColor = C_GOLD
	end
	--增加强制结束帧
	if endFrame == nil then
		endFrame = CC.Effect[eft]
	end
	local x0, y0 = WAR.Person[id]["坐标X"], WAR.Person[id]["坐标Y"]
	local hb = GetS(JY.SubScene, x0, y0, 4)
	local starteft = 0
	
	if eft == 125 and WAR.SYS == 1 then
	for i = 0, eft - math.random(-5, 6) do
		starteft = starteft + CC.Effect[i]
	end
	else
	for i = 0, eft - 1 do
		starteft = starteft + CC.Effect[i]
	end
	end
	
	local px = 0
	local py = 0

	--狮王咆哮动画位置
	if eft == 118 then
		py = CC.YScale * 4
	end	
	
	--玉石俱焚动画位置
	if eft == 124 then
		py = CC.YScale * 3
	end
	
	--倾国动画位置
	if eft == 149 then
		py = CC.YScale * 11
	end
	
	--喵姐的免疫攻击动画位置
	if eft == 135 then
		py = CC.YScale * 2
	end
	
	--集中动画位置
	if eft == 151 then
		py = CC.YScale * 6
	end
	
	--五岳剑诀，以剑御气动画位置
	if eft == 137 then
		py = CC.YScale * 18
	end
	
	--梯云纵动画位置
	if eft == 153 then
		py = CC.YScale * 18
	end
	
	
	local ssid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	for ii = 1, endFrame, order do
		lib.GetKey()
		lib.PicLoadCache(3, (starteft + ii) * 2, CC.ScreenW / 2, CC.ScreenH / 2 - hb + py, 2, 192)
		if str ~= nil then
			DrawString(-1, CC.ScreenH / 2 - hb, str, strColor, CC.DefaultFont)
		end
		ShowScreen()
		lib.Delay(CC.BattleDelay)
		lib.LoadSur(ssid, 0, 0)
	end
	lib.FreeSur(ssid)
	Cls()
end


function WE_xy(x, y, id)
  if id ~= nil then
    War_CalMoveStep(id, 128, 0)
  else
    CleanWarMap(3, 0)
  end
  if GetWarMap(x, y, 3) ~= 255 and War_CanMoveXY(x, y, 0) then
    return x, y
  else
    for s = 1, 128 do
      for i = 1, s do
        local j = s - i
        if x + i < 63 and y + j < 63 and GetWarMap(x + i, y + j, 3) ~= 255 and War_CanMoveXY(x + i, y + j, 0) then
          return x + i, y + j
        end
        if x + j < 63 and y - i > 0 and GetWarMap(x + j, y - i, 3) ~= 255 and War_CanMoveXY(x + j, y - i, 0) then
          return x + j, y - i
        end
        if x - i > 0 and y - j > 0 and GetWarMap(x - i, y - j, 3) ~= 255 and War_CanMoveXY(x - i, y - j, 0) then
          return x - i, y - j
        end
        if x - j > 0 and y + i < 63 and GetWarMap(x - j, y + i, 3) ~= 255 and War_CanMoveXY(x - j, y + i, 0) then
          return x - j, y + i
        end
      end
    end
  end
  for s = 1, 128 do
    for i = 1, s do
      local j = s - i
      if x + i < 63 and y + j < 63 and War_CanMoveXY(x + i, y + j, 0) then
        return x + i, y + j
      end
      if x + j < 63 and y - i > 0 and War_CanMoveXY(x + j, y - i, 0) then
        return x + j, y - i
      end
      if x - i > 0 and y - j > 0 and War_CanMoveXY(x - i, y - j, 0) then
        return x - i, y - j
      end
      if x - j > 0 and y + i < 63 and War_CanMoveXY(x - j, y + i, 0) then
        return x - j, y + i
      end
    end
  end
  return x, y
end

--计算暗器伤害
function War_AnqiHurt(pid, emenyid, thingid, emeny)
	local num = nil
	local dam = nil
	if JY.Person[emenyid]["受伤程度"] == 0 then
		num = JY.Thing[thingid]["加生命"] / 2 - Rnd(3)
	elseif JY.Person[emenyid]["受伤程度"] <= 33 then
		num = math.modf(JY.Thing[thingid]["加生命"] *2 / 3) - Rnd(3)
	elseif JY.Person[emenyid]["受伤程度"] <= 66 then
		num = JY.Thing[thingid]["加生命"] - Rnd(3)
	else
		num = math.modf(JY.Thing[thingid]["加生命"] *4 / 3) - Rnd(3)
	end
	  
	num = - math.modf(num - JY.Person[pid]["暗器技巧"]/4 + JY.Person[emenyid]["暗器技巧"]/4)
	WAR.Person[emeny]["内伤点数"] = AddPersonAttrib(emenyid, "受伤程度", math.modf(-num / 6))
	dam = num * WAR.AQBS * -1
	
	if WAR.HLB > 0 then
	   dam = dam*0.6
	end
	if WAR.FYYS < 0 then
	   dam = dam*2
	end

	if dam > 300 then
	   dam = -((dam-300)^0.9 + 300)
	end   
	--暗器
	
	if JY.Person[pid]["暗器1"] == 100 then
	   dam = dam - JY.Person[pid]["暗器技巧"]^0.65
	end
	if thingid == 31 and match_ID(pid, 677) then
	   dam = dam*1.35
	end 
	if thingid == 29 and match_ID(pid, 684) and math.random(100) < Person_BJ(pid) then
	   dam = dam*2
	end 
	if JY.Person[pid]["地7"] == 6 and math.random(100) < JY.Person[pid]["暗器技巧"]*0.22 then
	   dam = dam * 2
	end
	for i = 1, #NAN2 do
	    if WAR.Person[emeny]["人物编号"] == NAN2[i] then
		   dam = dam*0.8
		end
	end
	for i = 1, #NAN3 do
	    if WAR.Person[emeny]["人物编号"] == NAN3[i] then
		   dam = dam*0.25
		end
	end
	if WAR.Person[emeny]["人物编号"] == 642 then
		   dam = dam*0.35
	end
	if WAR.Person[emeny]["人物编号"] == 689 then
		   dam = 0
	end
	if JY.Person[pid]["专2"] == 995 then
	   dam = dam*2
	   if dam > -250 then
	      dam = -250
	   end
	end
	if match_ID(pid, 54) and JY.Person[54]["阶"] >= 3 then
	   dam = dam - 200
	end
	dam = math.modf(dam)
	local r = AddPersonAttrib(emenyid, "生命", math.modf(dam))
	if (emenyid == 129 or emenyid == 65) and JY.Person[emenyid]["生命"] <= 0 and WAR.JESS[emenyid] == nil then
		JY.Person[emenyid]["生命"] = 1
	end
	if JY.Person[emenyid]["生命"] <= 0 then
		WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + JY.Person[emenyid]["等级"] * 5
	end
	if JY.Thing[thingid]["加中毒解毒"] > 0 then
		num = math.modf(JY.Thing[thingid]["加中毒解毒"] + JY.Person[pid]["暗器技巧"] / 4)
		num = num - JY.Person[emenyid]["抗毒能力"]
		num = limitX(num, 0, CC.PersonAttribMax["用毒能力"])
		WAR.Person[emeny]["中毒点数"] = AddPersonAttrib(emenyid, "中毒程度", num)
	end
	--冰魄
	if thingid == 34 then
	   JY.Person[WAR.Person[emeny]["人物编号"]]["冰封程度"] = JY.Person[WAR.Person[emeny]["人物编号"]]["冰封程度"] + 20 + math.random(25)
	   WAR.BFXS[WAR.Person[emeny]["人物编号"]] = 1
			if 100 < JY.Person[WAR.Person[emeny]["人物编号"]]["冰封程度"] then
				JY.Person[WAR.Person[emeny]["人物编号"]]["冰封程度"] = 100
			end
	end
	if thingid == 31 then
	   JY.Person[WAR.Person[emeny]["人物编号"]]["灼烧程度"] = JY.Person[WAR.Person[emeny]["人物编号"]]["灼烧程度"] + 10 + math.random(10)
	   WAR.ZSXS[WAR.Person[emeny]["人物编号"]] = 1
			if 100 < JY.Person[WAR.Person[emeny]["人物编号"]]["灼烧程度"] then
				JY.Person[WAR.Person[emeny]["人物编号"]]["灼烧程度"] = 50
			end
	end
	
	--沉睡状态的敌人会醒来
	if WAR.CSZT[emenyid] ~= nil then
		WAR.CSZT[emenyid] = nil
	end
	if r > -1 then
	   r = -1
	end
	return r
end

--计算从(x,y)开始攻击最多能够击中几个敌人
function War_AutoCalMaxEnemy(x, y, wugongid, level)
  local wugongtype = JY.Wugong[wugongid]["攻击范围"]
  local movescope = JY.Wugong[wugongid]["移动范围" .. level]
  local fightscope = JY.Wugong[wugongid]["杀伤范围" .. level]
  local maxnum = 0
  local xmax, ymax = nil, nil
  if wugongtype == 0 or wugongtype == 3 then
    local movestep = War_CalMoveStep(WAR.CurID, movescope, 1)	--计算武功移动步数
    for i = 1, movescope do
      local step_num = movestep[i].num
      if step_num == 0 then
        break;
      end
      for j = 1, step_num do
        local xx = movestep[i].x[j]
        local yy = movestep[i].y[j]
        local enemynum = 0
        for n = 0, WAR.PersonNum - 1 do
          if n ~= WAR.CurID and WAR.Person[n]["死亡"] == false and WAR.Person[n]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
            local x = math.abs(WAR.Person[n]["坐标X"] - xx)
            local y = math.abs(WAR.Person[n]["坐标Y"] - yy)
          end
          if x <= fightscope and y <= fightscope then
            enemynum = enemynum + 1
          end
        end
        if maxnum < enemynum then
          maxnum = enemynum
          xmax = xx
          ymax = yy
        end
      end
    end
  elseif wugongtype == 1 then
    for direct = 0, 3 do
      local enemynum = 0
      for i = 1, movescope do
        local xnew = x + CC.DirectX[direct + 1] * i
        local ynew = y + CC.DirectY[direct + 1] * i
        if xnew >= 0 and xnew < CC.WarWidth and ynew >= 0 and ynew < CC.WarHeight then
          local id = GetWarMap(xnew, ynew, 2)
        end
        if id >= 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[id]["我方"] then
          enemynum = enemynum + 1
        end
      end
      if maxnum < enemynum then
        maxnum = enemynum
        xmax = x + CC.DirectX[direct + 1]
        ymax = y + CC.DirectY[direct + 1]
      end
    end
  elseif wugongtype == 2 then
    local enemynum = 0
    for direct = 0, 3 do
      for i = 1, movescope do
        local xnew = x + CC.DirectX[direct + 1] * i
        local ynew = y + CC.DirectY[direct + 1] * i
        if xnew >= 0 and xnew < CC.WarWidth and ynew >= 0 and ynew < CC.WarHeight then
          local id = GetWarMap(xnew, ynew, 2)
        end
        if id >= 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[id]["我方"] then
          enemynum = enemynum + 1
        end
      end
    end
  end
  if enemynum > 0 then
    maxnum = enemynum
    xmax = x
    ymax = y
  end
  return maxnum, xmax, ymax
end


--得到可以走到攻击到敌人的最近位置。
--scope可以攻击的范围
--返回 x,y。如果无法走到攻击位置，返回空
function War_AutoCalMaxEnemyMap(wugongid, level)
  local wugongtype = JY.Wugong[wugongid]["攻击范围"]
  local movescope = JY.Wugong[wugongid]["移动范围" .. level]
  local fightscope = JY.Wugong[wugongid]["杀伤范围" .. level]
  local x0 = WAR.Person[WAR.CurID]["坐标X"]
  local y0 = WAR.Person[WAR.CurID]["坐标Y"]
  CleanWarMap(4, 0)
  if wugongtype == 0 or wugongtype == 3 then
    for n = 0, WAR.PersonNum - 1 do
      if n ~= WAR.CurID and WAR.Person[n]["死亡"] == false and WAR.Person[n]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
        local xx = WAR.Person[n]["坐标X"]
        local yy = WAR.Person[n]["坐标Y"]
        local movestep = War_CalMoveStep(n, movescope, 1)
        for i = 1, movescope do
          local step_num = movestep[i].num
	        if step_num == 0 then
	          
	        else
	          for j = 1, step_num do
	            SetWarMap(movestep[i].x[j], movestep[i].y[j], 4, 1)
	          end
	        end
	      end
      end
    end
  elseif wugongtype == 1 or wugongtype == 2 then
    for n = 0, WAR.PersonNum - 1 do
      if n ~= WAR.CurID and WAR.Person[n]["死亡"] == false and WAR.Person[n]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
        local xx = WAR.Person[n]["坐标X"]
        local yy = WAR.Person[n]["坐标Y"]
        for direct = 0, 3 do
          for i = 1, movescope do
            local xnew = xx + CC.DirectX[direct + 1] * i
            local ynew = yy + CC.DirectY[direct + 1] * i
            if xnew >= 0 and xnew < CC.WarWidth and ynew >= 0 and ynew < CC.WarHeight then
              local v = GetWarMap(xnew, ynew, 4)
              SetWarMap(xnew, ynew, 4, v + 1)
            end
          end
        end
      end
    end
  end
end

--自动医疗
function War_AutoDoctor()
  local x1 = WAR.Person[WAR.CurID]["坐标X"]
  local y1 = WAR.Person[WAR.CurID]["坐标Y"]
  War_ExecuteMenu_Sub(x1, y1, 3, -1)
end

--自动吃药
--flag=2 生命，3内力；4体力  6 解毒
function War_AutoEatDrug(flag)
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local life = JY.Person[pid]["生命"]
	local maxlife = JY.Person[pid]["生命最大值"]
	local selectid = nil
	local minvalue = math.huge
	local shouldadd, maxattrib, str = nil, nil, nil
	if flag == 2 then
		maxattrib = JY.Person[pid]["生命最大值"]
		shouldadd = maxattrib - JY.Person[pid]["生命"]
		str = "加生命"
	elseif flag == 3 then
		maxattrib = JY.Person[pid]["内力最大值"]
		shouldadd = maxattrib - JY.Person[pid]["内力"]
		str = "加内力"
	elseif flag == 4 then
		maxattrib = CC.PersonAttribMax["体力"]
		shouldadd = maxattrib - JY.Person[pid]["体力"]
		str = "加体力"
	elseif flag == 6 then
		maxattrib = CC.PersonAttribMax["中毒程度"]
		shouldadd = JY.Person[pid]["中毒程度"]
		str = "加中毒解毒"
	else
		return 
	end
	local function Get_Add(thingid)
		if flag == 6 then
		  return -JY.Thing[thingid][str] / 2
		else
		  return JY.Thing[thingid][str]
		end
	end
  
	--在队
	if inteam(pid) and WAR.Person[WAR.CurID]["我方"] == true then
		local extra = 0
		for i = 1, CC.MyThingNum do
			local thingid = JY.Base["物品" .. i]
			if thingid >= 0 then
				local add = Get_Add(thingid)
				if JY.Thing[thingid]["类型"] == 3 and add > 0 then
					local v = shouldadd - add
					if v < 0 then
						extra = 1
					elseif v < minvalue then
						minvalue = v
						selectid = thingid
					end
				end
			end
		end
		if extra == 1 then
			minvalue = math.huge
			for i = 1, CC.MyThingNum do
				local thingid = JY.Base["物品" .. i]
				if thingid >= 0 then
					local add = Get_Add(thingid)
					if JY.Thing[thingid]["类型"] == 3 and add > 0 then
						local v = add - shouldadd
						if v >= 0 and v < minvalue then
							minvalue = v
							selectid = thingid
						end
					end
				end
			end
		end
		--使用物品
		if UseThingEffect(selectid, pid) == 1 then
			instruct_32(selectid, -1)
		end
	--不在队
	else
		local extra = 0
		for i = 1, 4 do
			local thingid = JY.Person[pid]["携带物品" .. i]
			local tids = JY.Person[pid]["携带物品数量" .. i]
			if thingid >= 0 and tids > 0 then
				local add = Get_Add(thingid)
				if JY.Thing[thingid]["类型"] == 3 and add > 0 then
					local v = shouldadd - add
					if v < 0 then		--可以加满生命, 用其他方法找合适药品
						extra = 1
					elseif v < minvalue then
						minvalue = v
						selectid = thingid
					end
				end
			end
		end
		if extra == 1 then
			minvalue = math.huge
			for i = 1, 4 do
				local thingid = JY.Person[pid]["携带物品" .. i]
				local tids = JY.Person[pid]["携带物品数量" .. i]
				if thingid >= 0 and tids > 0 then
					local add = Get_Add(thingid)
					if JY.Thing[thingid]["类型"] == 3 and add > 0 then
						local v = add - shouldadd
						if v >= 0 and v < minvalue then
							minvalue = v
							selectid = thingid
						end
					end
				end 
			end
		end
		--NPC使用物品
		if UseThingEffect(selectid, pid) == 1 then
			instruct_41(pid, selectid, -1)
		end
	end
	lib.Delay(500)
end

--自动逃跑
function War_AutoEscape()
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  if JY.Person[pid]["体力"] <= 5 then
    return 
  end
  local x, y = nil, nil
  War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)		 --计算移动步数
  WarDrawMap(1)
  ShowScreen()
  local array = {}
  local num = 0
  
  for i = 0, CC.WarWidth - 1 do
    for j = 0, CC.WarHeight - 1 do
      if GetWarMap(i, j, 3) < 128 then
        local minDest = math.huge
        for k = 0, WAR.PersonNum - 1 do
          if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[k]["我方"] and WAR.Person[k]["死亡"] == false then
            local dx = math.abs(i - WAR.Person[k]["坐标X"])
            local dy = math.abs(j - WAR.Person[k]["坐标Y"])
	          if dx + dy < minDest then		--计算当前距离敌人最近的位置
	            minDest = dx + dy
	          end
          end
        end
        num = num + 1
        array[num] = {}
        array[num].x = i
        array[num].y = j
        array[num].p = minDest
      end
    end
  end
  
  for i = 1, num - 1 do
    for j = i, num do
      if array[i].p < array[j].p then
        array[i], array[j] = array[j], array[i]
      end
    end
  end
  for i = 2, num do
    if array[i].p < array[1].p / 2 then
      num = i - 1
      break;
    end
  end
  for i = 1, num do
    array[i].p = array[i].p * 5 + GetMovePoint(array[i].x, array[i].y, 1)
  end
  for i = 1, num - 1 do
    for j = i, num do
      if array[i].p < array[j].p then
        array[i], array[j] = array[j], array[i]
      end
    end
  end
  x = array[1].x
  y = array[1].y

  War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
  War_MovePerson(x, y)	--移动到相应的位置
end


--自动执行战斗，此时的位置一定可以打到敌人
function War_AutoExecuteFight(wugongnum)
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  local x0 = WAR.Person[WAR.CurID]["坐标X"]
  local y0 = WAR.Person[WAR.CurID]["坐标Y"]
  local wugongid = JY.Person[pid]["武功" .. wugongnum]
  local level = math.modf(JY.Person[pid]["武功等级" .. wugongnum] / 100) + 1
  local maxnum, x, y = War_AutoCalMaxEnemy(x0, y0, wugongid, level)
  if x ~= nil then
    War_Fight_Sub(WAR.CurID, wugongnum, x, y)
    WAR.Person[WAR.CurID].Action = {"atk", x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
  end
end

--自动战斗
function War_AutoMenu()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	WAR.AutoFight = 1
	WAR.ShowHead = 0
	Cls()
	if JY.Person[pid]["禁用自动"] == 1 then
		return 0
	else
		War_Auto()
		return 1
	end
end

--计算可移动步数
--id 战斗人id，
--stepmax 最大步数，
--flag=0  移动，物品不能绕过，1 武功，用毒医疗等，不考虑挡路。
--flag=2  无视建筑
function War_CalMoveStep(id, stepmax, flag)
  CleanWarMap(3, 255)
  --spirit walk
  if JY.Person[id]["地5"] == 8 then
     flag = 2
  end
  local x = WAR.Person[id]["坐标X"]
  local y = WAR.Person[id]["坐标Y"]
  local steparray = {}
  for i = 0, stepmax do
    steparray[i] = {}
    steparray[i].bushu = {}
    steparray[i].x = {}
    steparray[i].y = {}
  end
  SetWarMap(x, y, 3, 0)
  steparray[0].num = 1
  steparray[0].bushu[1] = stepmax
  steparray[0].x[1] = x
  steparray[0].y[1] = y
  War_FindNextStep(steparray, 0, flag, id)
  return steparray
end

--判断x,y是否为可移动位置
function War_CanMoveXY(x, y, flag)
	if flag == 2 then
		return true
	end
	if GetWarMap(x, y, 1) > 0 then
		return false
	end
	if flag == 0 then
		if CC.WarWater[GetWarMap(x, y, 0)] ~= nil then
			return false
		end
		if GetWarMap(x, y, 2) >= 0 then
			return false
		end
	end
	return true
end

--解毒菜单
function War_DecPoisonMenu()
	WAR.ShowHead = 0
	local r = War_ExecuteMenu(2)
	WAR.ShowHead = 1
	Cls()
	return r
end

--判断攻击后面对的方向
function War_Direct(x1, y1, x2, y2)
	local x = x2 - x1
	local y = y2 - y1
	if x == 0 and y == 0 then
		return WAR.Person[WAR.CurID]["人方向"]
	end
	if math.abs(x) < math.abs(y) then
		if y > 0 then
			return 3
		else
			return 0
		end
	else 
		if x > 0 then
			return 1
		else
			return 2
		end
	end
end

--医疗菜单
function War_DoctorMenu()
	WAR.ShowHead = 0
	local r = War_ExecuteMenu(3)
	WAR.ShowHead = 1
	Cls()
	return r
end

--祝由菜单
function War_Incantation()
    local pid = WAR.Person[WAR.CurID]["人物编号"]
	local step = nil
	local sts =  nil
    if JY.Person[694]["天4"] == 2 then
	   if JY.Person[694]["阶"] >= 1 then
	      if WAR.ZJJQ[pid] == nil then
		     WAR.ZJJQ[pid] = 1
		  else
		     WAR.ZJJQ[pid] = WAR.ZJJQ[pid] + 1
		  end	 
	   end
	   return War_ExecuteMenu_Sub(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5)
	else
    
	step = math.modf((JY.Person[pid]["解毒能力"] + JY.Person[pid]["用毒能力"] + JY.Person[pid]["医疗能力"])/80)
	War_CalMoveStep(WAR.CurID, step, 1)
	local x1, y1 = War_SelectMove(sts)
	if x1 == nil then
		lib.GetKey()
		Cls()
		return 0
	else
	    if JY.Person[694]["阶"] >= 1 then
	      if WAR.ZJJQ[pid] == nil then
		     WAR.ZJJQ[pid] = 1
		  else
		     WAR.ZJJQ[pid] = WAR.ZJJQ[pid] + 1
		  end	 
	    end
		return War_ExecuteMenu_Sub(x1, y1, 5)
	end
	end
end

---执行医疗，解毒用毒
---flag=1 用毒， 2 解毒，3 医疗 4 暗器
---thingid 暗器物品id
function War_ExecuteMenu(flag, thingid)
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local step = nil
	local sts =  nil
	if flag == 1 then
		step = math.modf(JY.Person[pid]["用毒能力"] / 40)
	elseif flag == 2 then
		step = math.modf(JY.Person[pid]["解毒能力"] / 40)
	elseif flag == 3 then
		step = math.modf(JY.Person[pid]["医疗能力"] / 40)
	elseif flag == 4 then
		step = math.modf(JY.Person[pid]["暗器技巧"] / 15) + 1
	end
	War_CalMoveStep(WAR.CurID, step, 1)
	--增加部分人物的7*7显示
	if pid == 0 and JY.Base["标准"] == 8 and flag == 3 then
		sts = 1
	elseif pid == 0 and JY.Base["标准"] == 9 and flag == 1 then 
		sts = 1
	elseif flag == 4 and (match_ID(pid, 83) or JY.Person[pid]["暗器3"] == 100) then 
		sts = 1
	end
	local x1, y1 = War_SelectMove(sts)
	if x1 == nil then
		lib.GetKey()
		Cls()
		return 0
	else
		return War_ExecuteMenu_Sub(x1, y1, flag, thingid)
	end
end

--选择武功的函数，手动和AI都经过这里
function War_FightSelectType(movefanwei, atkfanwei, x, y,wugong)
	local x0 = WAR.Person[WAR.CurID]["坐标X"]
	local y0 = WAR.Person[WAR.CurID]["坐标Y"]
	if x == nil and y == nil then
		x, y = War_KfMove(movefanwei, atkfanwei,wugong)
		if x == nil then
			lib.GetKey()
			Cls()
			return 
		end
	--无酒不欢：AI也显示选择范围
	else
		WarDrawAtt(x, y, atkfanwei, 4)
		WarDrawMap(1, x, y)
		ShowScreen()
		--张无忌逆转乾坤
		if JY.Person[614]["品德"] == 90 then
			local z = WAR.CurID
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
					WAR.CurID = j
					break
				end
			end
			Cls()
			CurIDTXDH(WAR.CurID, 114,1,"逆转乾坤",C_ORANGE);
			WAR.CurID = z
			local ori_x, ori_y = x, y
			local min_x, min_y,max_x, max_y = x-2, y-2, x+2, y+2
			Cls()
			CleanWarMap(3, 255)
			local ssx = 0
			for i = min_x+1, max_x-1 do
				for j = min_y+1, max_y-1 do
					SetWarMap(i, j, 3, 0)
				end
			end
			SetWarMap(min_x, y, 3, 0)
			SetWarMap(max_x, y, 3, 0)
			SetWarMap(x, min_y, 3, 0)
			SetWarMap(x, max_y, 3, 0)
			WarDrawMap(1, x, y)
			ShowScreen()
			while true do
				if JY.Restart == 1 then
					break
				end
				local key, ktype, mx, my = WaitKey(1)
				if key == VK_UP then
					if (y > min_y + 1 and x > min_x and x < max_x) or (x == ori_x and y > min_y) then
						y = y - 1
					end
				elseif key == VK_DOWN then
					if (y < max_y - 1 and x > min_x and x < max_x) or (x == ori_x and y < max_y) then
						y = y + 1
					end
				elseif key == VK_LEFT then
					if (x > min_x + 1 and y > min_y and y < max_y) or (y == ori_y and x > min_x) then
						x = x - 1
					end
				elseif key == VK_RIGHT then
					if (x < max_x - 1 and y > min_y and y < max_y) or (y == ori_y and x < max_x) then
						x = x + 1
					end
				elseif key == VK_ESCAPE then
					x, y = ori_x, ori_y
					WAR.NZQK = 1
					CleanWarMap(7, 0)
					WarDrawAtt(x, y, atkfanwei, 4)
					WarDrawMap(1, x, y)
					ShowScreen()
					break
				elseif (key == VK_SPACE or key == VK_RETURN) then
					--内力大于等于300才能使用
					if JY.Person[0]["内力"] >= 300 then
						JY.Person[0]["内力"] = JY.Person[0]["内力"] - 300
						WAR.NZQK = 2
						break
					else
						x, y = ori_x, ori_y
						WAR.NZQK = 1
						CleanWarMap(7, 0)
						WarDrawAtt(x, y, atkfanwei, 4)
						WarDrawMap(1, x, y)
						ShowScreen()
						break
					end
				end
				CleanWarMap(7, 0)
				WarDrawAtt(x, y, atkfanwei, 4)
				WarDrawMap(1, x, y)
				ShowScreen()
			end
			JY.Person[614]["品德"] = 80
		end
		--主角，迷踪步躲避攻击
		if JY.Person[606]["品德"] == 90 then
			local z = WAR.CurID
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
					WAR.CurID = j
					break
				end
			end
			Cls()
			CurIDTXDH(WAR.CurID, 129,1,"迷踪步",Violet);
		
			WAR.Person[WAR.CurID]["移动步数"] = 6
			War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
			local x, y = nil, nil
			while 1 do
				if JY.Restart == 1 then
					break
				end
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					War_MovePerson(x, y)
					break;
				end
			end
			WAR.CurID = z
			JY.Person[606]["品德"] = 80
		end
		--fwjt
		if JY.Person[678]["品德"] == 90 then
			local z = WAR.CurID
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
					WAR.CurID = j
					break
				end
			end
			Cls()
			CurIDTXDH(WAR.CurID, 120,1,"凤舞九天",PinkRed);
		
			WAR.Person[WAR.CurID]["移动步数"] = 8
			War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
			local x, y = nil, nil
			while 1 do
				if JY.Restart == 1 then
					break
				end
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					War_MovePerson(x, y)
					break;
				end
			end
			WAR.CurID = z
			JY.Person[678]["品德"] = 80
		end
		--阿修罗闪空
		if JY.Person[673]["品德"] == 90 then
		    WAR.AXLSK = 1
			local z = WAR.CurID
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
					WAR.CurID = j
					break
				end
			end
			if math.random(3) == 1 then
			WAR.Person[WAR.CurID].Time = 999
			end
			Cls()
			CurIDTXDH(WAR.CurID, 129,1,"阿修罗闪空",PinkRed);
		
			WAR.Person[WAR.CurID]["移动步数"] = 6
			War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 1)
			local nx, ny = nil, nil
			while 1 do
				if JY.Restart == 1 then
					break
				end
			while true do	
				nx, ny = War_SelectMove()
				
				if nx ~= nil then
		          if (lib.GetWarMap(nx, ny, 2) > 0 or lib.GetWarMap(nx, ny, 5) > 0) and (nx == WAR.Person[WAR.CurID]["坐标X"] and ny == WAR.Person[WAR.CurID]["坐标Y"]) == false then
	      	      elseif CC.SceneWater[lib.GetWarMap(nx, ny, 0)] ~= nil then
	       	      else
	       		  break
	              end
	            end
			end
				
				if nx ~= nil then
					WAR.ShowHead = 0
					War_MovePerson(nx, ny)
					break
				end
			end
			WAR.CurID = z
			JY.Person[673]["品德"] = 80
			WAR.AXLSK = 0
			
		end
		--雷震，虚空藏
		if JY.Person[670]["品德"] == 90 then
			local z = WAR.CurID
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
					WAR.CurID = j
					break
				end
			end
			Cls()
			if JY.Person[0]["特殊兵器"] >= 320 then
			   CurIDTXDH(WAR.CurID, 129,1,"妙法・虚空藏",LightSlateBlue);
            else
               CurIDTXDH(WAR.CurID, 129,1,"虚空藏",PinkRed);
            end			   
			WAR.Person[WAR.CurID]["移动步数"] = 2 + math.modf(JY.Person[0]["特殊兵器"]*0.015)
			if JY.Person[0]["特殊兵器"] >= 320 then
			   WAR.Person[WAR.CurID]["移动步数"] = WAR.Person[WAR.CurID]["移动步数"] + 5
			end
			War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
			
			local x, y = nil, nil
			while 1 do
				if JY.Restart == 1 then
					break
				end
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					War_MovePerson(x, y)
					break;
				end
			end
			WAR.CurID = z
			JY.Person[670]["品德"] = 91
		end
		--小昭影步
		if JY.Person[66]["品德"] == 90 then
			JY.Person[66]["品德"] = 50
			if WAR.XZ_YB[1] ~= nil then
				local z = WAR.CurID
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
						WAR.CurID = j
						break
					end
				end
				WAR.XZYB = 1
				WAR.XZYB_Z = {WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]} 
				Cls()
				WarDrawMap(0)
				CurIDTXDH(WAR.CurID, 122,1, "接引离斯毒火海", C_RED)
				lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
				lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
				WarDrawMap(0)
				War_Fight_Sub(WAR.CurID, 1)
				WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = WAR.XZ_YB[1], WAR.XZ_YB[2]
				WarDrawMap(0)
				CurIDTXDH(WAR.CurID, 122,1, "幻光游世常自在", C_RED)
				lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
				lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
				WarDrawMap(0)
				WAR.XZ_YB[1]=nil
				WAR.XZ_YB[2]=nil
				WAR.CurID = z
				WAR.XZYB = 0
			end
		end
		CleanWarMap(7,0)
		lib.Delay(200)
	end
	if not War_Direct(x0, y0, x, y) then
		WAR.Person[WAR.CurID]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
	else
		WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x, y)
	end
	SetWarMap(x, y, 4, 1)
	WAR.EffectXY = {}
	return x, y
end

--设置下一步可移动的坐标
function War_FindNextStep(steparray, step, flag, id)
	local num = 0
	local step1 = step + 1
  
	--ZOC判定
	local fujinnum = function(tx, ty)
		if flag ~= 0 or id == nil then
			return 0
		end
		local tnum = 0
		local wofang = WAR.Person[id]["我方"]
		local tv = nil
		tv = GetWarMap(tx + 1, ty, 2)
		if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
			tnum = 9999
		end
		tv = GetWarMap(tx - 1, ty, 2)
		if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
			tnum = 999
		end
		tv = GetWarMap(tx, ty + 1, 2)
		if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
			tnum = 999
		end
		tv = GetWarMap(tx, ty - 1, 2)
		if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
			tnum = 999
		end
		return tnum
	end
  
  for i = 1, steparray[step].num do
    if steparray[step].bushu[i] > 0 then
      steparray[step].bushu[i] = steparray[step].bushu[i] - 1
      local x = steparray[step].x[i]
      local y = steparray[step].y[i]
      if x + 1 < CC.WarWidth - 1 then
        local v = GetWarMap(x + 1, y, 3)
        if v == 255 and War_CanMoveXY(x + 1, y, flag) == true then
	        num = num + 1
	        steparray[step1].x[num] = x + 1
	        steparray[step1].y[num] = y
	        SetWarMap(x + 1, y, 3, step1)
	        steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x + 1, y)
      	end
      end
      
      if x - 1 > 0 then
        local v = GetWarMap(x - 1, y, 3)
        if v == 255 and War_CanMoveXY(x - 1, y, flag) == true then
	        num = num + 1
	        steparray[step1].x[num] = x - 1
	        steparray[step1].y[num] = y
	        SetWarMap(x - 1, y, 3, step1)
	        steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x - 1, y)
	      end
      end
      
      if y + 1 < CC.WarHeight - 1 then
        local v = GetWarMap(x, y + 1, 3)
        if v == 255 and War_CanMoveXY(x, y + 1, flag) == true then
	        num = num + 1
	        steparray[step1].x[num] = x
	        steparray[step1].y[num] = y + 1
	        SetWarMap(x, y + 1, 3, step1)
	        steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x, y + 1)
	      end
      end
      
      if y - 1 > 0 then
	      local v = GetWarMap(x, y - 1, 3)
	      if v == 255 and War_CanMoveXY(x, y - 1, flag) == true then
		      num = num + 1
		      steparray[step1].x[num] = x
		      steparray[step1].y[num] = y - 1
		      SetWarMap(x, y - 1, 3, step1)
		      steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x, y - 1)
	    	end
    	end
    end
  end
  if num == 0 then
    return 
  end
  steparray[step1].num = num
  War_FindNextStep(steparray, step1, flag, id)
end

--判断是否能打到敌人
function War_GetCanFightEnemyXY()
	local num, x, y = nil, nil, nil
	num, x, y = War_realjl(WAR.CurID)
	if num == -1 then
		return 
	end
	return x, y
end

--移动
function War_MoveMenu()
  if WAR.Person[WAR.CurID]["人物编号"] ~= -1 then
    WAR.ShowHead = 0
    if WAR.Person[WAR.CurID]["移动步数"] <= 0 then
      return 0
    end
    War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
    local r = nil
    local x, y = War_SelectMove()
    if x ~= nil then
      War_MovePerson(x, y, 1)
      r = 1
    else
      r = 0
      WAR.ShowHead = 1
      Cls()
    end
    lib.GetKey()
    return r
  else
    local ydd = {}
    local n = 1
    for i = 0, WAR.PersonNum - 1 do
      if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
        ydd[n] = i
        n = n + 1
      end
    end
    local dx = ydd[math.random(n - 1)]
    local DX = WAR.Person[dx]["坐标X"]
    local DY = WAR.Person[dx]["坐标Y"]
    local YDX = {DX + 1, DX - 1, DX}
    local YDY = {DY + 1, DY - 1, DY}
    local ZX = YDX[math.random(3)]
    local ZY = YDY[math.random(3)]
    if not SceneCanPass(ZX, ZY) or GetWarMap(ZX, ZY, 2) < 0 then
      SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
      SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
      WAR.Person[WAR.CurID]["坐标X"] = ZX
      WAR.Person[WAR.CurID]["坐标Y"] = ZY
      SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
      SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
    end
  end
  return 1
end

--人物移动
function War_MovePerson(x, y, flag)
  local x1 = x
  local y1 = y
  if not flag then
    flag = 0
  end
  local movenum = GetWarMap(x, y, 3)
  local movetable = {}
  for i = movenum, 1, -1 do
    movetable[i] = {}
    movetable[i].x = x
    movetable[i].y = y
    if GetWarMap(x - 1, y, 3) == i - 1 then
      x = x - 1
      movetable[i].direct = 1
    elseif GetWarMap(x + 1, y, 3) == i - 1 then
      x = x + 1
      movetable[i].direct = 2
    elseif GetWarMap(x, y - 1, 3) == i - 1 then
      y = y - 1
      movetable[i].direct = 3
    elseif GetWarMap(x, y + 1, 3) == i - 1 then
      y = y + 1
      movetable[i].direct = 0
    end
  end
	--减少移动步数
	movetable.num = movenum
	movetable.now = 0
	WAR.Person[WAR.CurID].Move = movetable
	if WAR.Person[WAR.CurID]["移动步数"] < movenum then
		movenum = WAR.Person[WAR.CurID]["移动步数"]
		WAR.Person[WAR.CurID]["移动步数"] = 0
	else
		WAR.Person[WAR.CurID]["移动步数"] = WAR.Person[WAR.CurID]["移动步数"] - movenum
	end
	--移动人物
	--标主的特殊显示
	--七夕龙女的论剑奖励代表是否学有迷踪步
	if WAR.Person[WAR.CurID]["人物编号"] == 0 and (JY.Base["标准"] > 0 and JY.Person[615]["论剑奖励"] == 1 or WAR.AXLSK == 1 or WAR.SYS == 1 or WAR.CLBF == 2 or JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["地5"] == 8 or (WAR.Person[WAR.CurID]["人物编号"] == 0 and JY.Person[246]["品德"] == 100)) and movenum > 2 then
		local a = 0
		local gender = 0
		if JY.Person[0]["性别"] > 0 then
			gender = 1
		end
		for i = 1, movenum do
			local t1 = lib.GetTime()
			if a == 6 then
				a = 0
			end
			if i == 1 then
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
			end
			if i > 3 then
				SetWarMap(movetable[i-3].x, movetable[i-3].y, 2, -1)
				SetWarMap(movetable[i-3].x, movetable[i-3].y, 5, -1)
			end
			if i == movenum then
				SetWarMap(movetable[i-2].x, movetable[i-2].y, 2, -1)
				SetWarMap(movetable[i-2].x, movetable[i-2].y, 5, -1)
				SetWarMap(movetable[i-1].x, movetable[i-1].y, 2, -1)
				SetWarMap(movetable[i-1].x, movetable[i-1].y, 5, -1)
			end
			WAR.Person[WAR.CurID]["坐标X"] = movetable[i].x
			WAR.Person[WAR.CurID]["坐标Y"] = movetable[i].y
			WAR.Person[WAR.CurID]["人方向"] = movetable[i].direct
			if i < movenum then
				WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic2(WAR.CurID, gender) + (a)*2
			else
				WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
			end
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
			WarDrawMap(0)
			ShowScreen()
			a = a + 1
			local t2 = lib.GetTime()
			if i < movenum and t2 - t1 < CC.BattleDelay then
			  lib.Delay(CC.BattleDelay - (t2 - t1))
			end
		end
	--谢无悠，剑步谜影
	elseif WAR.Person[WAR.CurID]["人物编号"] == 596 then
		CleanWarMap(3, 255)
		WarDrawMap(0)
		CurIDTXDH(WAR.CurID, 153, 1)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
		WarDrawMap(0)
		if movetable[movenum] == nil then	--LiangJC:修复谢无悠跳出BUG
			return
		end
		WAR.Person[WAR.CurID]["坐标X"] = movetable[movenum].x
		WAR.Person[WAR.CurID]["坐标Y"] = movetable[movenum].y
		WAR.Person[WAR.CurID]["人方向"] = movetable[movenum].direct
		WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
		WarDrawMap(0)
		CurIDTXDH(WAR.CurID, 153, 1)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
		WarDrawMap(0)
	else
		for i = 1, movenum do
			local t1 = lib.GetTime()
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
			WAR.Person[WAR.CurID]["坐标X"] = movetable[i].x
			WAR.Person[WAR.CurID]["坐标Y"] = movetable[i].y
			WAR.Person[WAR.CurID]["人方向"] = movetable[i].direct
			WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
			WarDrawMap(0)
			ShowScreen()
			local t2 = lib.GetTime()
			if i < movenum and t2 - t1 < 2 * CC.BattleDelay then
			  lib.Delay(2 * CC.BattleDelay - (t2 - t1))
			end
		end
	end
	--主运轻功的话遇到ZOC移动不清0，反之清0
	if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["主运轻功"] == 0 then
		local fujinnum = function(tx, ty)
			local tnum = 0
			local wofang = WAR.Person[WAR.CurID]["我方"]
			local tv = nil
			tv = GetWarMap(tx + 1, ty, 2)
			if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
				tnum = 999
			end
			tv = GetWarMap(tx - 1, ty, 2)
			if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
				tnum = 999
			end
			tv = GetWarMap(tx, ty + 1, 2)
			if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
				tnum = 999
			end
			tv = GetWarMap(tx, ty - 1, 2)
			if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
				tnum = 999
			end
			return tnum
		end
		if fujinnum(WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]) ~= 0 then
			WAR.Person[WAR.CurID]["移动步数"] = 0
		end	
	end
end

---用毒菜单
function War_PoisonMenu()
	WAR.ShowHead = 0
	local r = War_ExecuteMenu(1)
	WAR.ShowHead = 1
	Cls()
	return r
end

--战斗休息
function War_RestMenu()
	if WAR.CurID and WAR.CurID >= 0  then
		local pid = WAR.Person[WAR.CurID]["人物编号"]
		--走火不能休息
		if WAR.tmp[1000 + pid] == 1 then
			return 1
		end
		if WAR.CLBF == 2 or WAR.XFXY == 1 then
			return 1
		end
		local vv = math.modf(JY.Person[pid]["体力"] / 100 - JY.Person[pid]["受伤程度"] / 50 - JY.Person[pid]["中毒程度"] / 50) + 2
		if WAR.Person[WAR.CurID]["移动步数"] > 0 then
			vv = vv + 2
		end
		if inteam(pid) then
			vv = vv + math.random(3)
		else
			vv = vv + 3 + math.random(0,3)
		end
		vv = (vv) / 120
		local v = 3 + Rnd(3)
		local bs = 1
		--主运葵花，天人化生解除全异常状态，且休息效果翻倍
		if Curr_NG(pid, 105) then
			bs = 2
			JY.Person[pid]["中毒程度"] = 0
			JY.Person[pid]["受伤程度"] = 0
			JY.Person[pid]["冰封程度"] = 0
			JY.Person[pid]["灼烧程度"] = 0
			--流血
			if WAR.LXZT[pid] ~= nil then
				WAR.LXZT[pid] = nil
				WAR.LXXS[pid] = nil
			end
			--封穴
			if WAR.FXDS[pid] ~= nil then
				WAR.FXDS[pid] = nil
				WAR.FXXS[pid] = nil
			end
			Cls()
			CurIDTXDH(WAR.CurID, 141,1,"天人化生",M_Pink,10)
		end
		if match_ID(pid, 676) and JY.Base["天书数量"] >= 3 then
		if XueDao() and WAR.XHTT[pid] ~= nil then
		else
		local hl = math.modf((JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"])*0.1)
		WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", hl)
		end
		WAR.Person[WAR.CurID]["体力点数"] = AddPersonAttrib(pid, "体力", 25)
		Cls()
		CurIDTXDH(WAR.CurID, 91,1,"回天息",C_GOLD,10)
		end
		WAR.Person[WAR.CurID]["体力点数"] = AddPersonAttrib(pid, "体力", v*bs)
		if JY.Person[pid]["体力"] > 0 then
		if XueDao() and WAR.XHTT[pid] ~= nil then
		else
			v = 3 + math.modf(JY.Person[pid]["生命最大值"] * vv / 2)
			WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", v*bs)
		end	
			v = 3 + math.modf(JY.Person[pid]["内力最大值"] * vv)
			WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(pid, "内力", v*bs)
		end
		
		War_Show_Count(WAR.CurID);		--显示当前控制人的点数
		
		--阿凡提休息带蓄力+防御
		if match_ID(pid, 606) then
			Cls()
			WAR.Actup[pid] = 2;
			WAR.Defup[pid] = 1
			CurIDTXDH(WAR.CurID, 85,1);
			DrawStrBox(-1, -1, "踏沙无痕・进退自如", LimeGreen, CC.DefaultFont,C_GOLD)
			ShowScreen()
			lib.Delay(400)
			return 1;	
		--NPC休息会自动蓄力
		--先天调息不触发
		elseif not inteam(pid) and WAR.XTTX == 0 then
			if math.modf(JY.Person[pid]["生命最大值"] / 2) < JY.Person[pid]["生命"] then
				Cls()
				return War_ActupMenu()
			else
				Cls()
				return War_DefupMenu()
			end
		else
			return 1
		end
	end
end

--战斗查看状态
function War_StatusMenu()
	WAR.ShowHead = 0
	Menu_Status()
	WAR.ShowHead = 1
	Cls()
end

function War_StatusMenu2()
    WAR.ZTCK = 1
	War_CalMoveStep(WAR.CurID, 50, 2)
	local x,y = War_SelectMove()
	WAR.ZTCK = 0
end

--战斗物品菜单
function War_ThingMenu()
	WAR.ShowHead = 0
	local thing = {}
	local thingnum = {}
	for i = 0, CC.MyThingNum - 1 do
		thing[i] = -1
		thingnum[i] = 0
	end
	local num = 0
	for i = 0, CC.MyThingNum - 1 do
		local id = JY.Base["物品" .. i + 1]
		if id >= 0 and (JY.Thing[id]["类型"] == 1 or JY.Thing[id]["类型"] == 3 or JY.Thing[id]["类型"] == 4) then
			thing[num] = id
			thingnum[num] = JY.Base["物品数量" .. i + 1]
			num = num + 1
		end
	end
	local r = SelectThing(thing, thingnum)
	Cls()
	local rr = 0
	if r >= 0 and UseThing(r) == 1 then
		rr = 1
	end
	WAR.ShowHead = 1
	Cls()
	return rr
end


--自动战斗判断是否能医疗
function War_ThinkDoctor()
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  if JY.Person[pid]["体力"] < 50 or JY.Person[pid]["医疗能力"] < 20 then
    return -1
  end
  if JY.Person[pid]["医疗能力"] + 20 < JY.Person[pid]["受伤程度"] then
    return -1
  end
  local rate = -1
  local v = JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"]
  if JY.Person[pid]["医疗能力"] < v / 4 then
    rate = 30
  elseif JY.Person[pid]["医疗能力"] < v / 3 then
      rate = 50
  elseif JY.Person[pid]["医疗能力"] < v / 2 then
      rate = 70
  else
    rate = 90
  end
  if Rnd(100) < rate then
    return 5
  end
  return -1
end

--能否吃药增加参数
--flag=2 生命，3内力；4体力  6 解毒
function War_ThinkDrug(flag)
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  local str = nil
  local r = -1
  if flag == 2 then
    str = "加生命"
  elseif flag == 3 then
    str = "加内力"
  elseif flag == 4 then
    str = "加体力"
  elseif flag == 6 then
    str = "加中毒解毒"
  else
    return r
  end
  local function Get_Add(thingid)
    if flag == 6 then
      return -JY.Thing[thingid][str]
    else
      return JY.Thing[thingid][str]
    end
  end
  
  --身上是否有药品
  if inteam(pid) and WAR.Person[WAR.CurID]["我方"] == true then
    for i = 1, CC.MyThingNum do
      local thingid = JY.Base["物品" .. i]
      if thingid >= 0 and JY.Thing[thingid]["类型"] == 3 and Get_Add(thingid) > 0 then
        r = flag
        break;
      end
    end
  else
    for i = 1, 4 do
      local thingid = JY.Person[pid]["携带物品" .. i]
      if thingid >= 0 and JY.Thing[thingid]["类型"] == 3 and Get_Add(thingid) > 0 then
        r = flag
        break;
      end
    end
  end
  return r
end

--使用暗器
function War_UseAnqi(id)
	return War_ExecuteMenu(4, id)
end

--初始化战斗数据
function WarLoad(warid)
	WarSetGlobal()
	local data = Byte.create(CC.WarDataSize)
	Byte.loadfile(data, CC.WarFile, warid * CC.WarDataSize, CC.WarDataSize)
	LoadData(WAR.Data, CC.WarData_S, data)
	WAR.ZDDH = warid
end

--加载战斗地图
function WarLoadMap(mapid)
	lib.Debug(string.format("load war map %d", mapid))
	lib.LoadWarMap(CC.WarMapFile[1], CC.WarMapFile[2], mapid, 8, CC.WarWidth, CC.WarHeight)
end


function GetWarMap(x, y, level)
	if x > 63 or x < 0 or y > 63 or y < 0 then
		return 
	end
	return lib.GetWarMap(x, y, level)
end

function SetWarMap(x, y, level, v)
	if x > 63 or x < 0 or y > 63 or y < 0 then
		return 
	end
	lib.SetWarMap(x, y, level, v)
end

function CleanWarMap(level, v)
	lib.CleanWarMap(level, v)
end

--设置人物贴图
function WarSetPerson()
	CleanWarMap(2, -1)
	CleanWarMap(5, -1)
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 2, i)
			SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 5, WAR.Person[i]["贴图"])
		end
	end
	--郭襄的诸天化身步
	if WAR.ZTHSB == 1 then
		lib.SetWarMap(WAR.Person[WAR.ZT_id]["坐标X"], WAR.Person[WAR.ZT_id]["坐标Y"], 5, -1)
	end
	--小昭影步
	if WAR.XZYB == 1 then
		lib.SetWarMap(WAR.XZYB_Z[1], WAR.XZYB_Z[2], 2, -1)
		lib.SetWarMap(WAR.XZYB_Z[1], WAR.XZYB_Z[2], 5, -1)
	end
end

--显示武功动画，人物受伤动画，音效等
function War_ShowFight(pid, wugong, wugongtype, level, x, y, eft, ZHEN_ID)
local yin, yang, tg = NeiL(pid)
local fx = yin + yang
	--千剑归宗不显示特效文字
	if wugong == 187 or wugong== 194 or wugong == 204 then
		WAR.Person[WAR.CurID]["特效文字0"] = nil
		WAR.Person[WAR.CurID]["特效文字1"] = nil
		WAR.Person[WAR.CurID]["特效文字2"] = nil
		WAR.Person[WAR.CurID]["特效文字3"] = nil
		WAR.Person[WAR.CurID]["特效文字4"] = nil
		WAR.Person[WAR.CurID]["特效文字8"] = nil
		WAR.Person[WAR.CurID]["特效动画"] = -1
	end
			
	--攻击时不显示血条
	WAR.ShowHP = 0
	WAR.ShowMP = 0
	
	--没有合击
	if not ZHEN_ID then
		ZHEN_ID = -1
	end
	--内功
	if wugongtype == 6 then
		wugongtype = WAR.NGXS
	end
	
	--无酒不欢：设置一下新的动画顺序
	if wugongtype == 2 then
		wugongtype = 1
	elseif wugongtype > 2 and wugongtype < 6 then
		wugongtype = wugongtype - 1
	end
  
	local x0 = WAR.Person[WAR.CurID]["坐标X"]
	local y0 = WAR.Person[WAR.CurID]["坐标Y"]

	
	local starteft = 0
	
	if pid > -1 then
	
	local using_anqi = 0
	local anqi_name;
	--暗器动画
	if wugongtype == -1 then
		using_anqi = 1
		anqi_name = JY.Thing[eft]["名称"]
		--何铁手含沙射影
		if match_ID(pid, 83) or JY.Person[pid]["暗器2"] == 100 then
			anqi_name = "含沙射影・"..anqi_name
		end
		eft = JY.Thing[eft]["暗器动画编号"]
	end
	
	if match_ID(pid, 673) and WAR.QHTRG == 1 then
	   eft = 38
	end
	
	--雷震，动画
	if match_ID(pid, 670) and WAR.ZLPK == 2 and JY.Wugong[wugong]["武功类型"] == 2 then
	    eft = 134
	end
	
	if match_ID(pid, 670) and WAR.BLJY == 1 then
	    eft = 33
	end
	
	if match_ID(pid, 670) and JY.Wugong[wugong]["武功类型"] == 4 and WAR.ACT == 3 and JY.Person[pid]["耍刀技巧"] >= 180 then
	   eft = 154
	end
	
	if (JY.Person[pid]["专2"] == 239 or (match_ID(pid, 85) and JY.Person[85]["阶"] >= 1)) and wugong == 239 then
	   eft = 163
	end
	
	if match_ID(pid, 670) and WAR.TNSF == 2 then
	   eft = 7
	end
	
	--[[if wugong == 1 then
	   eft = 168
	end]]
	
	
	--丁典
	if match_ID(pid, 672) and WAR.DDSQ == 1 then
	   if JY.Person[672]["品德"] == 70 then
	   eft = 148
	   elseif JY.Person[672]["品德"] == 100 then
	   eft = 10
	   end
	end
	
	--豪鬼,灭杀豪波动
	if wugong == 202 and WAR.MSHBD == 1 then
	   if JY.Person[673]["外号2"] == "怒" then
	   eft = 134
	   else
	   eft = 154
	   end
	end
	
	if wugong == 203 and WAR.MSHSL == 1 then
	   if JY.Person[673]["外号2"] == "怒" then
	   eft = 154
	   else
	   eft = 157
	   end
	end
	
	
	--无名
	if match_ID(pid, 671) and wugong == 198 then
	   local n = 0
	   for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				n = n + 1
			end
	   end
	   if n == 1 then
	      eft = 132
	   end
	end
	
	if wugong == 199 then
	   if WAR.MMZS == 1 then
	      eft = 16-------------------------------------一剑成名
	   elseif WAR.MMZS == 2 then
	      eft = 45-------------------------------------莫名其妙
	   elseif WAR.MMZS == 3 then
	      eft = 41                                  -- 名动一时
       elseif WAR.MMZS == 4 then
	      eft = 66
       elseif WAR.MMZS == 5 then
	      eft = 53
       elseif WAR.MMZS == 6 then
	      if WAR.LQZ[pid] == 100 and match_ID(pid, 671) then
	         eft = 154
		  else
		     eft = 65
		  end
       elseif WAR.MMZS == 7 then
	      eft = 24
       elseif WAR.MMZS == 8 then
	      eft = 51
       elseif WAR.MMZS == 9 then
	      eft = 9
       elseif WAR.MMZS == 10 then
	      eft = 54
       end
    end

    if wugong == 217 then
	   if WAR.AHZS == 1 then
	      eft = 140-------------------------------------一剑成名
	   elseif WAR.AHZS == 2 then
	      eft = 66-------------------------------------莫名其妙
	   elseif WAR.AHZS == 3 then
	      eft = 67                                  -- 名动一时
       elseif WAR.AHZS == 4 then
	      eft = 50
       elseif WAR.AHZS == 5 then
	      eft = 139
       elseif WAR.AHZS == 6 then
		  eft = 69
       end
    end
	
	if wugong == 225 then
	local mx = Xishu_max(pid)
	if TrueQZ(pid) == mx then
	eft = 1
	elseif TrueZF(pid) == mx then
	eft = 27
	elseif TrueYJ(pid) == mx then
	eft = 24
	elseif TrueSD(pid) == mx then
	eft = 34
	elseif TrueTS(pid) == mx then
	eft = 27
	end
	end
	
	if wugong == 49 and match_ID(pid, 687) then
	   if WAR.LMZS == 1 then
	      eft = 25
	   elseif WAR.LMZS == 2 then
	      eft = 40
	   elseif WAR.LMZS == 3 then
	      eft = 50
       elseif WAR.LMZS == 5 then
	      eft = 26
       elseif WAR.LMZS == 6 then
		  eft = 39
       end
    end 
	
	--须弥山神掌
	if wugong == 24 and WAR.LQZ[pid] ~= 100 and WAR.SYBD[pid] == nil then
	   eft = 31
	end
	
	--扫地老僧  随机动画
	if match_ID(pid, 114) then
		eft = math.random(100)
	end
	
	--黯然极意动画
	if wugong == 25 and WAR.ARJY == 1 then
		eft = 7
	end
	--破颜拳
	if wugong == 223 then
		eft = math.random(140)
	end
	
	--江山如画
	if wugong == 142 and WAR.QQSH2 == 2 then
		eft = 116
	end
	
	--金蛇奥义动画
	if wugong == 40 and WAR.JSAY == 1 then
		eft = 44
	end
	
	--进阶万花
	if wugong == 30 and PersonKF(pid,175) then
		eft = 139
	end
	--进阶泰山
	if wugong == 31 and PersonKF(pid,175) then
		eft = 138
	end
	--进阶云雾
	if wugong == 32 and PersonKF(pid,175) then
		eft = 142
	end
	--进阶万岳
	if wugong == 33 and PersonKF(pid,175) then
		eft = 140
	end
	--进阶太岳
	if wugong == 34 and PersonKF(pid,175) then
		eft = 141
	end
	
	--无酒不欢的特效动画
	if pid == 0 and JY.Base["特殊"] == 1 then
		if JY.Person[0]["性别"] == 0 then
			eft = 65
		else
			eft = 8
		end
	end
	
	--杨康的杨家枪法
	if match_ID(pid,650) and wugong == 68 and JY.Person[650]["天1"] == 1 then
		eft = 150
	end
	
	if wugong == 65 and WAR.NGJL > 0 then
		eft = JY.Wugong[WAR.NGJL]["武功动画&音效"]
	end
	
	--无招胜有招动画
	if wugong == 47 and WAR.FQY == 1 then
		eft = 84
	end
	
	local ex, ey = -1, -1;
	
	--测试动画
	--eft = 110;
	
	--主角有几率出随机动画
	if pid == 0 and GetS(53, 0, 4, 5) == 1 and JLSD(0,30,pid)  then
		eft = 110;
	end
	
	--指定XY，那么只显示在一个点显示动画
	if eft == 110 then
		ex, ey = x, y;
	end
  
	--六脉神剑的类型设置为拳法
	if wugong == 49 then
		wugongtype = 1
	end
  
	--合击动画
	local ZHEN_pid, ZHEN_type, ZHEN_startframe, ZHEN_fightframe = nil, nil, nil, nil
	if ZHEN_ID >= 0 then
		ZHEN_pid = WAR.Person[ZHEN_ID]["人物编号"]
		ZHEN_type = wugongtype
		ZHEN_startframe = 0
		ZHEN_fightframe = 0
	end
  
	local fightdelay, fightframe, sounddelay = nil, nil, nil
	if wugongtype >= 0 then
		fightdelay = JY.Person[pid]["出招动画延迟" .. wugongtype + 1]
		fightframe = JY.Person[pid]["出招动画帧数" .. wugongtype + 1]
		sounddelay = JY.Person[pid]["武功音效延迟" .. wugongtype + 1]
	else
		fightdelay = 0
		fightframe = -1
		sounddelay = -1
	end
  
	if fightdelay == 0 or fightframe == 0 then
		for i = 1, 5 do
			if JY.Person[pid]["出招动画帧数" .. i] ~= 0 then
				fightdelay = JY.Person[pid]["出招动画延迟" .. i]
				fightframe = JY.Person[pid]["出招动画帧数" .. i]
				sounddelay = JY.Person[pid]["武功音效延迟" .. i]
				wugongtype = i - 1
			end
		end
	end

	if ZHEN_ID >= 0 then
		if JY.Person[ZHEN_pid]["出招动画帧数" .. ZHEN_type + 1] == 0 then
			for i = 1, 5 do
				if JY.Person[ZHEN_pid]["出招动画帧数" .. i] ~= 0 then
					ZHEN_type = i - 1
					ZHEN_fightframe = JY.Person[ZHEN_pid]["出招动画帧数" .. i]
				end
			end
		else
			ZHEN_fightframe = JY.Person[ZHEN_pid]["出招动画帧数" .. ZHEN_type + 1]
		end
	end
  
	local framenum = fightdelay + CC.Effect[eft]
	local startframe = 0
	if wugongtype >= 0 then
		for i = 0, wugongtype - 1 do
			startframe = startframe + 4 * JY.Person[pid]["出招动画帧数" .. i + 1]
		end
	end
	if ZHEN_ID >= 0 and ZHEN_type >= 0 then
		for i = 0, ZHEN_type - 1 do
			ZHEN_startframe = ZHEN_startframe + 4 * JY.Person[ZHEN_pid]["出招动画帧数" .. i + 1]
		end
	end
  
	--local starteft = 0
	for i = 0, eft - 1 do
		starteft = starteft + CC.Effect[i]
	end

	WAR.Person[WAR.CurID]["贴图类型"] = 0
	WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
	if ZHEN_ID >= 0 then
		WAR.Person[ZHEN_ID]["贴图类型"] = 0
		WAR.Person[ZHEN_ID]["贴图"] = WarCalPersonPic(ZHEN_ID)
	end
  
	local oldpic = WAR.Person[WAR.CurID]["贴图"] / 2		--当前贴图的位置
	local oldpic_type = 0
	local oldeft = -1
	local kfname = JY.Wugong[wugong]["名称"]
	local showsize = CC.FontBig
	local showx = CC.ScreenW / 2 - showsize * string.len(kfname) / 4
	local hb = GetS(JY.SubScene, x0, y0, 4)
  
	--显示武功，放到特效文字4
	if wugong ~= 0 then
		if WAR.LHQ_BNZ == 1 then
			kfname = "般若掌"
		end
		if WAR.JGZ_DMZ == 1 then
			kfname = "达摩掌"
		end
		if WAR.FMZ_BFSC == 1 then
			kfname = "八法神禅"
		end
		if WAR.YZC_MKZ == 1 then
			kfname = "摩柯指"
		end
		if WAR.WD_CLSZ == 1 then
			kfname = "赤练神掌"
		end
		if WAR.LHQ_YKDD == 1 then
			kfname = "般若掌"		
		end
	end
	
	--独孤求败的反击文字
	if WAR.hit_DGQB == 1 then
		kfname = "无我无剑"
	end
	
	if WAR.hit_XWXG == 1 then
		kfname = WAR.XWXGNAME
	end
	
	if WAR.hit_AHLJ == 1 then
		kfname = "傲寒六诀・冷刃冰心"
	end
	
	if WAR.hit_LHLJ == 1 then
		kfname = "睡梦罗汉拳"
	end
	
	
	--金蛇奥义
	if WAR.JSAY == 1 then
		kfname = "奥义・金蛇狂舞"
	end
	
	--何铁手五毒显示倍数
	if wugong == 3 and match_ID(pid, 83) and WAR.HTS > 0 then
	local t = WAR.HTS
	if JY.Person[83]["阶"] >= 1 then
	   t = t*2
	end
		kfname = kfname.." X "..t
	end
	
	if match_ID(pid, 184) and wugong == 161 and WAR.HTS > 0 then
		kfname = kfname.." 第 "..WAR.HTS.." 式 "
	end
	
	if match_ID(pid, 629) and wugong == 161 and WAR.HTS > 0 then
		kfname = kfname.." 第 "..WAR.HTS.." 式 "
	end
	
	--松风剑法真传	
	if wugong == 27 and WAR.HTS > 0 then
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, "青城绝学，松风剑法", C_RED, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, "青城绝学，松风剑法", C_RED, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
					ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, "如松之劲，如风之迅", C_RED, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, "如松之劲，如风之迅", C_RED, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
			ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, "三陕以西，剑法第一", C_RED, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, "三陕以西，剑法第一", C_RED, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
	end
	
	--内功显示随机到的系
	if WAR.NGXS > 0 then
		local display = {"土拳","火指","木剑","金刀","水奇"}
		kfname = kfname.."・"..display[WAR.NGXS]
	end
  
	if ZHEN_ID >= 0 and ZHEN_ID ~= WAR.CurID then
		kfname = "双人合击・"..kfname
	end
  
	--特效文字4和武功名称显示
	if wugong > 0 or WAR.hit_DGQB == 1 or WAR.hit_XWXG == 1 or WAR.hit_AHLJ == 1 or WAR.hit_LHLJ == 1 then				--使用武功时才显示，独孤求败反击也显示
		if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
			for i=1, 25 do
				local n, strs = Split(WAR.Person[WAR.CurID]["特效文字4"], "・");
				local len = string.len(WAR.Person[WAR.CurID]["特效文字4"]);
				local color = RGB(255,40,10);
				local off = 0;
				for j=1, n do
					if strs[j] == "连击" or strs[j] == "天赋外功.炉火纯青" 
					or strs[j] == "碧箫声里双鸣凤" or strs[j] == "英雄无双风流婿" or strs[j] == "刀光掩映孔雀屏" 
					or strs[j] == "太极之形.圆转不断" then
						color = M_LightBlue;
					elseif strs[j] == "左右互搏" then
						color = M_DarkOrange
					elseif strs[j] == "炽烈爆发" or strs[j] == "灭之绝之" then
					    color = C_ORANGE
					else
						color = RGB(255,40,10);
					end
					if j > 1 then
						strs[j] = strs[j];
						off = off + 42
					end		
					DrawStrBox(-1, 10 + off, strs[j], color, 10+i) 
					--off = off + string.len(strs[j])*(CC.DefaultFont+i/2)/4 + (CC.DefaultFont+i/2)*3/2;
				end
				ShowScreen()		  
				lib.Delay(10)
				if i == 20 then
					lib.Delay(30)
				end
				Cls()
			end
		end
		--武功显示
		if wugong ~= 204 then
		local clr = C_GOLD
		if wugong == 209 then
		   clr = LimeGreen
		elseif wugong > 225 and wugong < 236 or wugong == 238 then
		   clr = PinkRed
		end   
		for i = 5, 10 do
			KungfuString(kfname, CC.ScreenW / 2 -#kfname/2, CC.ScreenH / 3 - 20 - hb  , clr, CC.FontBig+i, CC.FontName, 0)
			ShowScreen()  
			lib.Delay(2)
			if i == 10 then
				lib.Delay(300)
			end
			Cls()
		end
		end
	end
	
	--暗器显示
	if using_anqi == 1 then
		for i = 5, 10 do
			if WAR.KHSZ == 1 then
				KungfuString("葵花神针", CC.ScreenW / 2 -#anqi_name/2, CC.ScreenH / 3 - 20 - hb  , C_RED, CC.FontBig+i, CC.FontName, 0)
			else
				KungfuString(anqi_name.."×"..WAR.AQBS, CC.ScreenW / 2 -#anqi_name/2, CC.ScreenH / 3 - 20 - hb  , C_GOLD, CC.FontBig+i, CC.FontName, 0)
			end
			ShowScreen()
			  
			lib.Delay(2)
			if i == 10 then
				lib.Delay(300)
			end
			Cls()
		end
	end
	
	for k = 0,WAR.PersonNum -1 do
	    local xxx,yyy = WAR.Person[k]['坐标X'],WAR.Person[k]['坐标Y']
		if WAR.Person[k]['死亡'] == false and WAR.Miss[WAR.Person[k]['人物编号']] == 1 then
		   if GetWarMap(xxx,yyy,5) ~= nil then
		      WAR.PIC[WAR.Person[k]['人物编号']] = GetWarMap(xxx,yyy,5)
		   end	  
		end   
	end
  
  --显示攻击动画
  for i = 0, framenum - 1 do
	if JY.Restart == 1 then
		break
	end
    local tstart = lib.GetTime()
    local mytype = nil
    if fightframe > 0 then
      WAR.Person[WAR.CurID]["贴图类型"] = 1
      mytype = 4 + WAR.CurID
      if i < fightframe then
        WAR.Person[WAR.CurID]["贴图"] = (startframe + WAR.Person[WAR.CurID]["人方向"] * fightframe + i) * 2
      end
    else
      WAR.Person[WAR.CurID]["贴图类型"] = 0
      WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
      mytype = 0
    end

    if ZHEN_ID >= 0 then
      if ZHEN_fightframe > 0 then
        WAR.Person[ZHEN_ID]["贴图类型"] = 1
        if i < ZHEN_fightframe and i < framenum - 1 then
          WAR.Person[ZHEN_ID]["贴图"] = (ZHEN_startframe + WAR.Person[ZHEN_ID]["人方向"] * ZHEN_fightframe + i) * 2
        else
          WAR.Person[ZHEN_ID]["贴图"] = WarCalPersonPic(ZHEN_ID)
        end
      else
        WAR.Person[ZHEN_ID]["贴图类型"] = 0
        WAR.Person[ZHEN_ID]["贴图"] = WarCalPersonPic(ZHEN_ID)
      end
      SetWarMap(WAR.Person[ZHEN_ID]["坐标X"], WAR.Person[ZHEN_ID]["坐标Y"], 5, WAR.Person[ZHEN_ID]["贴图"])
    end
	
	if wugong == 225 then
	local mx = Xishu_max(pid)
	if TrueQZ(pid) == mx then
	JY.Wugong[wugong]["出招音效"] = 1
	elseif TrueZF(pid) == mx then
	JY.Wugong[wugong]["出招音效"] = 4
	elseif TrueYJ(pid) == mx then
	JY.Wugong[wugong]["出招音效"] = 6
	elseif TrueSD(pid) == mx then
	JY.Wugong[wugong]["出招音效"] = 5
	elseif TrueTS(pid) == mx then
	JY.Wugong[wugong]["出招音效"] = 6
	end
	end
    
    if i == sounddelay then
      PlayWavAtk(JY.Wugong[wugong]["出招音效"])	
    end
    
    if i == fightdelay then
      PlayWavE(eft)
    end
    
	--六脉神剑的音效
    if i == 1 and WAR.LMSJwav == 1 then
		PlayWavAtk(31)
		WAR.LMSJwav = 0
    end
	
	if i == 1 and WAR.NJDJ==1 then
		PlayWavAtk(44)
		WAR.NJDJ = 0
    end   
	
    
    local pic = WAR.Person[WAR.CurID]["贴图"] / 2
    
    lib.SetClip(0, 0, 0, 0)
    
    oldpic = pic
    oldpic_type = mytype
	
	local B_Delay = CC.BattleDelay
	local atk_Delay = 30
	if pid == 596 then
		B_Delay = 20
		atk_Delay = 10
	end
    
    --无酒不欢：攻击特效文字显示 8-3
    if i < fightdelay then
		WarDrawMap(4, pic * 2, mytype, -1)
		
		--袁承志暴击倍数显示
		--仅限我方
		if inteam(pid) and using_anqi == 0 and WAR.BJ == 1 and WAR.hit_DGQB == 0 then
			local fac = 1.5
			--怒涛海潮，会心一击暴击效果+50%
			if (Curr_NG(pid, 177) or PersonKF(pid, 172)) and WAR.HXZYJ == 1 then
				fac = fac + 0.5
			end
			if match_ID(pid, 678) and JY.Person[678]["天2"] == 2 and JY.Wugong[wugong]["武功类型"] == 2 then
				fac = fac + JY.Person[pid]["指法技巧"]*0.001
			end
			if JY.Base["标准"] == 4 and pid == 0 and JY.Wugong[wugong]["武功类型"] == 4 and JY.Person[0]["阶"] >= 3 then
			   fac = fac + 1
			end

			--四大恶人，暴击效果+50%
			if match_ID(pid, 44) or match_ID(pid, 98) or match_ID(pid, 99) or match_ID(pid, 100) then
				fac = fac + 0.5
			end
			
			--袁承志，暴击效果随天书数量提高，仅限我方
			if match_ID(pid, 54) and inteam(pid) then
				fac = fac + 0.1 * JY.Base["天书数量"]
			end
			if match_ID(pid, 677) and JY.Person[677]["天2"] == 1 then
				fac = fac + math.modf(((JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"])/JY.Person[pid]["生命最大值"])*50)/100
			end
			
			--逆运经脉，暴击效果+20%
			if Curr_NG(pid, 104) then
		        fac = fac + 0.2
				if JY.Person[pid]["天赋内功"] == 104 then
					 fac = fac + 0.2
				end	
				if tg ~= 1 then
				   if fx < 0 then
				      fac = fac - fx*0.01
				   end
				else
				      fac = fac - yin*0.01
				end   
	        end
			if JY.Person[pid]["专2"] == 104 and PersonKF(pid, 104) then
		       fac = fac + 0.2
		    end
			if JY.Person[60]["阶"] >= 3 and match_ID(pid, 60) then
		        fac = fac + 0.5
		    end
			if JY.Person[81]["阶"] >= 1 and match_ID(pid, 81) then
		        fac = fac + 0.1*JY.Person[81]["阶"]^2 + 0.2
		    end
			if JY.Person[pid]["人33"] == 1 then
	           fac = fac + 0.20
	        end
			if JY.Person[pid]["地2"] == 8 then
                fac = fac + 0.01*JY.Person[124]["天1"] + 0.3
		    end
			if PersonKF(pid, 104) and PersonKF(pid, 95) then
				fac = fac + 0.1
			end
			if CONFIG.Zoom==100 and match_ID_awakened(pid, 81, 1)==false then
			KungfuString("暴击×"..fac, CC.ScreenW -230 +i*2, CC.ScreenH / 3 - 50 - hb -i*2, C_RED, CC.FontBig+i*2, CC.FontName, 0)
			end
  		end
		
		if i == 1 and WAR.Person[WAR.CurID]["特效动画"] ~= -1 then
			local theeft = WAR.Person[WAR.CurID]["特效动画"]
			local sf = 0
			for ii = 0, theeft - 1 do
				sf = sf + CC.Effect[ii]
			end
			local ssid = lib.SaveSur(CC.ScreenW/2 - 11 * CC.XScale, CC.ScreenH/2 - hb - 28 * CC.YScale, CC.ScreenW/2 + 11 * CC.XScale, CC.ScreenH/2 - hb + 5 * CC.YScale)
       
			for ii = 1, CC.Effect[theeft] do
				lib.GetKey()
				lib.PicLoadCache(3, (sf+ii) * 2, CC.ScreenW/2 , CC.ScreenH/2  - hb, 2, 192, nil, 0, 0)
				if WAR.Person[WAR.CurID]["特效文字5"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字5"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, LightGreen, CC.Fontsmall, CC.FontName, 5)
				end
				if WAR.Person[WAR.CurID]["特效文字6"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字6"], CC.ScreenW / 2, (CC.ScreenH / 2 - hb)*1.2, LightSlateBlue, CC.FontSmall, CC.FontName, 6)
				end	
				if WAR.Person[WAR.CurID]["特效文字0"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字0"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_ORANGE, CC.Fontsmall, CC.FontName, 4)
				end
				if WAR.Person[WAR.CurID]["特效文字1"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字1"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_RED, CC.Fontsmall, CC.FontName, 3)
				end
				if WAR.Person[WAR.CurID]["特效文字2"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字2"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_GOLD, CC.Fontsmall, CC.FontName, 2)
				end
				if WAR.Person[WAR.CurID]["特效文字3"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字3"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_WHITE, CC.Fontsmall, CC.FontName, 1)
				end
				ShowScreen()
				lib.Delay(atk_Delay)
				lib.LoadSur(ssid, CC.ScreenW/2 - 11 * CC.XScale, CC.ScreenH/2 - hb - 28 * CC.YScale)
			  
			end
			lib.FreeSur(ssid)
			WAR.Person[WAR.CurID]["特效动画"] = -1
		else
			if WAR.Person[WAR.CurID]["特效文字0"] ~= nil or WAR.Person[WAR.CurID]["特效文字1"] ~= nil or WAR.Person[WAR.CurID]["特效文字2"] ~= nil or WAR.Person[WAR.CurID]["特效文字3"] ~= nil then
				KungfuString(WAR.Person[WAR.CurID]["特效文字5"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, LightGreen, CC.Fontsmall, CC.FontName, 5)
				KungfuString(WAR.Person[WAR.CurID]["特效文字6"], CC.ScreenW / 2, (CC.ScreenH / 2 - hb)*1.2, LightSlateBlue, CC.FontSmall*1.5, CC.FontName, 6)
				KungfuString(WAR.Person[WAR.CurID]["特效文字0"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_ORANGE, CC.Fontsmall, CC.FontName, 4)
				KungfuString(WAR.Person[WAR.CurID]["特效文字1"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_RED, CC.Fontsmall, CC.FontName, 3)
				KungfuString(WAR.Person[WAR.CurID]["特效文字2"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_GOLD, CC.Fontsmall, CC.FontName, 2)
				KungfuString(WAR.Person[WAR.CurID]["特效文字3"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_WHITE, CC.Fontsmall, CC.FontName, 1)
				lib.Delay(atk_Delay)
			end
		end
    else
		starteft = starteft + 1
      
        lib.SetClip(0, 0, 0, 0)
		
		--郭襄的诸天化身步
		if WAR.ZTHSB == 1 then
			lib.SetWarMap(WAR.Person[WAR.ZT_id]["坐标X"], WAR.Person[WAR.ZT_id]["坐标Y"], 5, -1)
		end
     
        WarDrawMap(4, pic * 2, mytype, (starteft) * 2, nil, 3, ex, ey)
		
		--郭襄的诸天化身步
		if WAR.ZTHSB == 1 then
			local dx = WAR.ZT_X - x0
			local dy = WAR.ZT_Y - y0
			local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
			local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
			lib.PicLoadCache(0, 3862*2, rx+i*3, ry+i*3, 2, 200-i*5)
			lib.PicLoadCache(0, 3863*2, rx-i*3, ry-i*3, 2, 200-i*5)
			lib.PicLoadCache(0, 3861*2, rx+i*3, ry-i*3, 2, 200-i*5)
			lib.PicLoadCache(0, 3864*2, rx-i*3, ry+i*3, 2, 200-i*5)
		elseif WAR.Dodge == 1 then
			for ii = 0,WAR.PersonNum -1 do 
				local xxx,yyy = WAR.Person[ii]['坐标X'],WAR.Person[ii]['坐标Y']
				local pc = WAR.PIC[WAR.Person[ii]['人物编号']]
				local x0 = WAR.Person[WAR.CurID]["坐标X"];
				local y0 = WAR.Person[WAR.CurID]["坐标Y"];
				local dx = xxx - x0
				local dy = yyy - y0
				local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
				local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
						
				local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
				ry = ry - hb
				if WAR.Person[ii]['死亡'] == false and WAR.Miss[WAR.Person[ii]['人物编号']] == 1 then 
				   SetWarMap(xxx,yyy,5,-1)
				   if GetWarMap(xxx,yyy,4) <= 10 then 
					  SetWarMap(xxx,yyy,4,11)
				   else 
					  SetWarMap(xxx,yyy,4,1+GetWarMap(xxx,yyy,4))
				   end	
				   local gt = GetWarMap(xxx,yyy,4)		
				   if gt <= 20 then 
					  lib.PicLoadCache(0, pc, rx+(gt-10)*2, ry+(gt-10)*2, 10, 250-(gt-10)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx-(gt-10)*2, ry-(gt-10)*2, 10, 250-(gt-10)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx+(gt-10)*2, ry-(gt-10)*2, 10, 250-(gt-10)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx-(gt-10)*2, ry+(gt-10)*2, 10, 250-(gt-10)*25,nil,0,0)
				   else 
					  lib.PicLoadCache(0, pc, rx+(30-gt)*2, ry+(30-gt)*2, 10, (gt-20)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx-(30-gt)*2, ry-(30-gt)*2, 10, (gt-20)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx+(30-gt)*2, ry-(30-gt)*2, 10, (gt-20)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx-(30-gt)*2, ry+(30-gt)*2, 10, (gt-20)*25,nil,0,0)
				   end	  
				end
			end
		end

		oldeft = starteft
      
		local estart = lib.GetTime()
		if B_Delay - (estart - tstart) > 0 then
			lib.Delay(B_Delay - (estart - tstart))
		end
    end

	ShowScreen()
    lib.SetClip(0, 0, 0, 0)
    local tend = lib.GetTime()
    if B_Delay - (tend - tstart) > 0 then
    	lib.Delay(B_Delay - (tend - tstart))
    end
	lib.GetKey()
  end
	for k = 0,WAR.PersonNum -1 do
	    local xxx,yyy = WAR.Person[k]['坐标X'],WAR.Person[k]['坐标Y']
		if WAR.Person[k]['死亡'] == false and WAR.Miss[WAR.Person[k]['人物编号']] == 1 then
		   if WAR.PIC[WAR.Person[k]['人物编号']] ~= nil then 
			  SetWarMap(xxx,yyy,5,WAR.PIC[WAR.Person[k]['人物编号']])
			  WAR.PIC[WAR.Person[k]['人物编号']] = nil
		   end
		end   
	end
  lib.SetClip(0, 0, 0, 0)
  WAR.Person[WAR.CurID]["贴图类型"] = 0
  WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
  
  --无酒不欢：命中的人物用白色表示
  WarSetPerson()
  WarDrawMap(0)
  ShowScreen()
  lib.Delay(200)
  WarDrawMap(2)
  ShowScreen()
  lib.Delay(200)
  WarDrawMap(0)
  ShowScreen()
  
  end

  --计算攻击到的人
  local HitXY = {}
  local HitXYNum = 0
  local hnum = 13;		--HitXY的长度个数
  for i = 0, WAR.PersonNum - 1 do
    local x1 = WAR.Person[i]["坐标X"]
    local y1 = WAR.Person[i]["坐标Y"]
	--被特效击中的也显示
    if WAR.Person[i]["死亡"] == false and (GetWarMap(x1, y1, 4) > 1 or WAR.TXXS[WAR.Person[i]["人物编号"]] == 1) then
		local dx = 0
		if GetWarMap(x1, y1, 4) > 1 then
			dx = 1
		end
      SetWarMap(x1, y1, 4, 1)
      --local n = WAR.Person[i]["点数"]
      local hp = WAR.Person[i]["生命点数"];
      local mp = WAR.Person[i]["内力点数"];
      local tl = WAR.Person[i]["体力点数"];
      local ed = WAR.Person[i]["中毒点数"];
      local dd = WAR.Person[i]["解毒点数"];
      local ns = WAR.Person[i]["内伤点数"];
	
      
      HitXY[HitXYNum] = {x1, y1, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil};		--x, y, 生命, 内力, 体力, 封穴, 流血, 中毒, 解毒, 内伤，冰封，灼烧
	  
		if hp ~= nil and (dx == 1 or hp ~= 0) then
			if hp == 0 then			--显示受到的生命
				if WAR.Miss[WAR.Person[i]["人物编号"]] ~= nil then
					
					WAR.Miss[WAR.Person[i]["人物编号"]] = nil
					--一lershan
					if match_ID(WAR.Person[i]["人物编号"], 688) and JY.Person[688]["天3"] == 2 then
					
							WarDrawMap(0)
							local z = WAR.CurID
							local wg = JY.Person[WAR.Person[i]["人物编号"]]["武功16"]
							JY.Person[WAR.Person[i]["人物编号"]]["武功16"] = 208
							for j = 0, WAR.PersonNum - 1 do
								if WAR.Person[j]["人物编号"] == WAR.Person[i]["人物编号"] and 0 < JY.Person[j]["生命"] then
									WAR.CurID = j
									if WAR.Person[WAR.CurID]["人物编号"] ~= 0 then
									local x1 = WAR.Person[WAR.CurID]["坐标X"]
					                local y1 = WAR.Person[WAR.CurID]["坐标Y"]
									local x2 = WAR.Person[z]["坐标X"]
									local y2 = WAR.Person[z]["坐标Y"]
									local X, Y = 1, 1
	                                local s0 = math.abs(x1 - x2+1) + math.abs(y1 - y2+1)
									    for a = -1,1 do
										   for b = -1,1 do
										       local s = math.abs(x1 - x2 + a) + math.abs(y1 - y2 + b)
											   if s < s0 then
											      s0 = s
												  X = a
												  Y = b
											   end
										   end
										end   
									War_Fight_Sub(WAR.CurID, 16, x1+X, y1+Y)
									else
									War_Fight_Sub(WAR.CurID, 16)
									WAR.CurID = z
									end
									break
								end		  	 			
							end
							JY.Person[WAR.Person[i]["人物编号"]]["武功16"] = wg
							HitXY[HitXYNum][3] = "雷闪"
							--张角
					elseif match_ID(WAR.Person[WAR.CurID]["人物编号"], 694) and (WAR.Person[WAR.CurID].Time == 1001 or WAR.DZXY == 1) then
					        WarDrawMap(0)
							if JY.Person[694]["阶"] >= 1 then
	      if WAR.ZJJQ[pid] == nil then
		     WAR.ZJJQ[pid] = 1
		  else
		     WAR.ZJJQ[pid] = WAR.ZJJQ[pid] + 1
		  end	 
	   end
							if WAR.ZJTL ~= 1 then
							CurIDTXDH(WAR.CurID, 25,1, "天雷", M_DeepSkyBlue)
							WAR.ZJTL = 1
							end
							WarDrawMap(0)
							local dam = math.modf(JY.Person[WAR.Person[i]["人物编号"]]["生命最大值"]*0.05 + 100 + 1.52^JY.Base["天书数量"]) + math.random(10)
							if JY.Person[694]["天4"] == 1 then
							   dam = dam + math.modf(JY.Person[WAR.Person[i]["人物编号"]]["生命最大值"]*0.05)
							end
							if JY.Person[694]["天3"] == 1 then
							   dam = math.modf(dam*1.3)
							end
							if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[i]["我方"] then
							WAR.Person[i]["Life_Before_Hit"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"]
							WAR.Person[i]["特效动画"] = 131
							WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "生命", -dam)
							if JY.Person[694]["天3"] == 1 then
							WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 300
							end
							HitXY[HitXYNum][3] = -dam
							end
					else
						HitXY[HitXYNum][3] = "闪避"		
					end
					--张角闪避
					if match_ID(WAR.Person[i]["人物编号"], 694) then
					        if WAR.ZJSB[WAR.Person[i]["人物编号"]] ~= nil then
							   WAR.ZJSB[WAR.Person[i]["人物编号"]] = WAR.ZJSB[WAR.Person[i]["人物编号"]] - 30
							   if WAR.ZJSB[WAR.Person[i]["人物编号"]] <= 0 then
							      WAR.ZJSB[WAR.Person[i]["人物编号"]] = nil
							   end
							end
							if JY.Person[694]["阶"] >= 1 then
	      if WAR.ZJJQ[pid] == nil then
		     WAR.ZJJQ[pid] = 1
		  else
		     WAR.ZJJQ[pid] = WAR.ZJJQ[pid] + 1
		  end	 
	   end
							-------------------------
							--驱雷策电
							
							local hit_LHLJ
		local eid
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 694) then
							hit_LHLJ = emeny
							eid = WAR.Person[emeny]["人物编号"]
							break;
						end
					end
				end
			end
			if hit_LHLJ ~= nil then
				break;
			end
			
		end
		
		if hit_LHLJ ~= nil then
			local pre_target_list = {}
			local pre_target_num = 0
			local tx_1 = WAR.Person[WAR.CurID]["特效文字0"] or nil
			local tx_2 = WAR.Person[WAR.CurID]["特效文字1"] or nil
			local tx_3 = WAR.Person[WAR.CurID]["特效文字2"] or nil
			local tx_4 = WAR.Person[WAR.CurID]["特效文字3"] or nil
			local tx_5 = WAR.Person[WAR.CurID]["特效文字4"] or nil
			local tx_6 = WAR.Person[WAR.CurID]["特效文字5"] or nil
			local tx_8 = WAR.Person[WAR.CurID]["特效文字6"] or nil
			local tx_7 = WAR.Person[WAR.CurID]["特效动画"]
			WAR.Person[WAR.CurID]["特效文字0"] = nil
			WAR.Person[WAR.CurID]["特效文字1"] = nil
			WAR.Person[WAR.CurID]["特效文字2"] = nil
			WAR.Person[WAR.CurID]["特效文字3"] = nil
			WAR.Person[WAR.CurID]["特效文字4"] = nil
			WAR.Person[WAR.CurID]["特效文字8"] = nil
			WAR.Person[WAR.CurID]["特效动画"] = -1
			WAR.Person[hit_LHLJ]["特效动画"] = 25
			for i = 0, CC.WarWidth - 1 do
				for j = 0, CC.WarHeight - 1 do
					local pre_effect = GetWarMap(i, j, 4)
					if pre_effect > 0 then
						local pre_target = GetWarMap(i, j, 2)
						pre_target_num = pre_target_num + 1
						pre_target_list[pre_target_num] = {i, j, pre_target, pre_effect}
					end
				end
			end
			CleanWarMap(4, 0)
			local s1 = WAR.CurID
			WAR.CurID = hit_LHLJ
			local pid = WAR.Person[WAR.CurID]["人物编号"]
				local dam = math.modf(JY.Person[WAR.Person[s1]["人物编号"]]["生命最大值"]*0.1 + 100 + 1.52^JY.Base["天书数量"]) + math.random(10)
				if JY.Person[694]["天3"] == 1 then
					dam = math.modf(dam*1.3)
				end
				if JY.Person[694]["天4"] == 1 then
				SetWarMap(WAR.Person[s1]["坐标X"], WAR.Person[s1]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				WAR.Person[s1]["生命点数"] = (WAR.Person[s1]["生命点数"] or 0) - dam
				--无酒不欢：记录人物血量
				WAR.Person[s1]["Life_Before_Hit"] = JY.Person[WAR.Person[s1]["人物编号"]]["生命"]	
				JY.Person[WAR.Person[s1]["人物编号"]]["生命"] = JY.Person[WAR.Person[s1]["人物编号"]]["生命"] - dam
				if JY.Person[694]["阶"] >= 1 then
	      if WAR.ZJJQ[pid] == nil then
		     WAR.ZJJQ[pid] = 1
		  else
		     WAR.ZJJQ[pid] = WAR.ZJJQ[pid] + 1
		  end	 
	   end
				if JY.Person[694]["天3"] == 1 then
					WAR.Person[s1].TimeAdd = WAR.Person[s1].TimeAdd - 300
				end
			local eft = 131
			War_ShowFight(WAR.Person[hit_LHLJ]["人物编号"], 0, 0, 0, 0, 0, eft, -1)
			end
			--祝由
			local x1, y1 = WAR.Person[hit_LHLJ]["坐标X"], WAR.Person[hit_LHLJ]["坐标Y"]
			War_ExecuteMenu_Sub(x1, y1, 5)
			WAR.Person[hit_LHLJ]["特效动画"] = -1
			
			--如果被上一步反击死亡，那么该人物的攻击就结束了
			if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] <= 1 then
			   WAR.Person[s1]["死亡"] = true
				return 1
			else		
				WAR.CurID = s1
				CleanWarMap(4, 0)
				WAR.Effect = 0
				for i = 1, pre_target_num do
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 2, pre_target_list[i][3])
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 4, pre_target_list[i][4])
				end
				WAR.Person[WAR.CurID]["特效文字0"] = tx_1
				WAR.Person[WAR.CurID]["特效文字1"] = tx_2
				WAR.Person[WAR.CurID]["特效文字2"] = tx_3
				WAR.Person[WAR.CurID]["特效文字3"] = tx_4
				WAR.Person[WAR.CurID]["特效文字4"] = tx_5
				WAR.Person[WAR.CurID]["特效文字5"] = tx_6
				WAR.Person[WAR.CurID]["特效文字6"] = tx_8
				WAR.Person[WAR.CurID]["特效动画"] =  tx_7
			end
		end
							end
							----------------------------
					if JY.Person[WAR.Person[i]["人物编号"]]["人36"] == 1 and WAR.Person[WAR.CurID]["我方"] == false then
					   WAR.ACT = 10
					   WAR.YJZD[WAR.Person[WAR.CurID]["人物编号"]] = 1
					   WAR.Person[i]["特效动画"] = 9
					end
					if JY.Person[WAR.Person[i]["人物编号"]]["人18"] == 1 then
					   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 300
					end
					if JY.Base["标准"] == 5 and WAR.Person[i]["人物编号"] == 0 and JY.Person[0]["阶"] >= 2 then
					   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 200
					end
				else
					HitXY[HitXYNum][3] = hp
				end
			elseif hp > 0 then
				HitXY[HitXYNum][3] = "+"..hp;
			else
				HitXY[HitXYNum][3] = hp;
			end
	    end
      
      if mp ~= nil then			--显示内力变化
      	if mp > 0 then
      		HitXY[HitXYNum][5] = "内力+"..mp;
      	elseif mp ==  0 then
      		HitXY[HitXYNum][5] = nil;			--变化为0时不显示
      	else
      		HitXY[HitXYNum][5] = "内力"..mp;
      	end
      end
      
      if tl ~= nil then			--显示体力变化
      	if tl > 0 then
      		HitXY[HitXYNum][6] = "体力+"..tl;
      	elseif tl == 0 then
      		HitXY[HitXYNum][6] = nil;
      	else
      		HitXY[HitXYNum][6] = "体力"..tl;
      	end
      end
      
      if WAR.FXXS[WAR.Person[i]["人物编号"]] ~= nil and WAR.FXXS[WAR.Person[i]["人物编号"]] == 1 and WAR.FXDS[WAR.Person[i]["人物编号"]] ~= nil then			--显示是否封穴
       	HitXY[HitXYNum][7] = "封穴 "..WAR.FXDS[WAR.Person[i]["人物编号"]];
       	WAR.FXXS[WAR.Person[i]["人物编号"]] = 0
      end
      
      if WAR.LXXS[WAR.Person[i]["人物编号"]] ~=nil and WAR.LXXS[WAR.Person[i]["人物编号"]] == 1 and WAR.LXZT[WAR.Person[i]["人物编号"]] ~= nil then		--显示是否被流血
      	HitXY[HitXYNum][8] = "流血 "..WAR.LXZT[WAR.Person[i]["人物编号"]];
        WAR.LXXS[WAR.Person[i]["人物编号"]] = 0
      end
         
      if ed ~= nil then				--显示中毒
      	if ed == 0 then
      		HitXY[HitXYNum][9] = nil;
      	else
      		HitXY[HitXYNum][9] = "中毒↑"..ed;
      	end
      end
      
      if dd ~= nil then			--显示解毒
      	if dd  == 0 then
      		HitXY[HitXYNum][4] = nil;
      	else
      		HitXY[HitXYNum][4] = "中毒↓"..dd;
      	end
      end
      
      if ns ~= nil then		--显示内伤
      	if ns == 0 then
      		HitXY[HitXYNum][10] = nil;
      	elseif ns > 0 then
      		HitXY[HitXYNum][10] = "内伤↑"..ns;
      	else
      		HitXY[HitXYNum][10] = "内伤↓"..ns;
      	end
      end
	  
		if WAR.BFXS[WAR.Person[i]["人物编号"]] == 1 then		--显示是否被冰封
			HitXY[HitXYNum][11] = "冰封 "..JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"];
			WAR.BFXS[WAR.Person[i]["人物编号"]] = 0
		end
		
		if WAR.ZSXS[WAR.Person[i]["人物编号"]] == 1 then		--显示是否被灼烧
			HitXY[HitXYNum][12] = "灼烧 "..JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"];
			WAR.ZSXS[WAR.Person[i]["人物编号"]] = 0
		end
		
		HitXYNum = HitXYNum + 1
    end
    
		--偷东西，斗转不可偷
		if WAR.TD > -1 then
			if WAR.TD == 118 then
				say("１想要从我慕容复手中偷东西？哼哼，下辈子吧！", 51,0)
			else
				instruct_2(WAR.TD, WAR.TDnum)
				Cls()
			end
			WAR.TD = -1
		end
	end
	WAR.ZJTL = 0
  
	local minx = 0;
	local maxx = CC.ScreenW;
	local miny = 0;
	local maxy = CC.ScreenH;
  
	local sssid = lib.SaveSur(minx, miny, maxx, maxy)
	--挨打特效文字显示
	local zt_count = 0
	for ii = 1, 20 do
		if JY.Restart == 1 then
			break
		end
		local yanshi = false
		local yanshi2 = false		--无动画时的延迟
		
		local _,ys = math.modf(ii/2)
		if ys == 0 then
			zt_count = zt_count + 1
		end
		for i = 0, WAR.PersonNum - 1 do
			lib.GetKey()
			if WAR.Person[i]["死亡"] == false then
				local theeft = WAR.Person[i]["特效动画"]
				--郭襄的诸天化身步
				if i ~= WAR.ZT_id and WAR.ZTHSB == 1 then

					local dx = WAR.Person[i]["坐标X"] - x0
					local dy = WAR.Person[i]["坐标Y"] - y0
					local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
					local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
					
					lib.PicLoadCache(4+WAR.ZT_id, (0+zt_count)*2, rx-80+ii*4, ry+80-ii*4, 2, 100+ii*5)
					lib.PicLoadCache(4+WAR.ZT_id, (11+zt_count)*2, rx-80+ii*4, ry-80+ii*4, 2, 100+ii*5)
					lib.PicLoadCache(4+WAR.ZT_id, (22+zt_count)*2, rx+80-ii*4, ry+80-ii*4, 2, 100+ii*5)
					lib.PicLoadCache(4+WAR.ZT_id, (33+zt_count)*2, rx+80-ii*4, ry-80+ii*4, 2, 100+ii*5)
					yanshi = true
				elseif theeft ~= -1 and ii < CC.Effect[theeft] then
					local dx = WAR.Person[i]["坐标X"] - x0
					local dy = WAR.Person[i]["坐标Y"] - y0
					local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
					local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
					local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
					
					local py = 0
					
					ry = ry - hb
					starteft = ii
					for i = 0, WAR.Person[i]["特效动画"] - 1 do
						starteft = starteft + CC.Effect[i]
					end
					
					--剑胆琴心动画位置
					if theeft == 125 then
						py = CC.YScale * 5
					end
					
					--喵姐的免疫攻击动画位置
					if theeft == 135 then
						py = CC.YScale * 2
					end

					--五岳剑诀，以剑御气动画位置
					if theeft == 137 then
						py = CC.YScale * 18
						starteft = starteft + 12
					end
					
					--倾国动画位置
					if theeft == 149 then
						py = CC.YScale * 11
					end
					
					--混沦太玄动画位置
					if theeft == 147 then
						py = CC.YScale * 20
					end
					
					--梯云纵动画位置
					if theeft == 153 then
						py = CC.YScale * 18
					end
					
					--剑步谜影动画位置
					if theeft == 155 then
						py = CC.YScale * 11
					end
					
					lib.PicLoadCache(3, (starteft) * 2, rx, ry + py, 2, 192, nil, 0, 0)
	
					--无酒不欢：特效文字一起出，不再用依次显示的方式
					--if ii < TPXS[i] * TP and (TPXS[i] - 1) * TP < ii then	
						KungfuString(WAR.Person[i]["特效文字3"], rx, ry, C_WHITE, CC.Fontsmall, CC.FontName, 1)
						KungfuString(WAR.Person[i]["特效文字2"], rx, ry, C_GOLD, CC.Fontsmall, CC.FontName, 2)
						KungfuString(WAR.Person[i]["特效文字1"], rx, ry, C_RED, CC.Fontsmall, CC.FontName, 3)
						KungfuString(WAR.Person[i]["特效文字0"], rx, ry, C_ORANGE, CC.Fontsmall, CC.FontName, 4)
						KungfuString(WAR.Person[i]["特效文字5"], rx, ry, LightGreen, CC.Fontsmall, CC.FontName, 5)
						KungfuString(WAR.Person[i]["特效文字6"], rx, ry, LightSlateBlue, CC.FontSmall, CC.FontName, 6)
						yanshi = true
					--end
				else
					--蓝烟清： 修正无动画时不显示文字的BUG
					if i~= WAR.CurID and theeft == -1 and ((WAR.Person[i]["特效文字1"] ~= nil and WAR.Person[i]["特效文字1"] ~= "  ") or (WAR.Person[i]["特效文字2"] ~= nil and WAR.Person[i]["特效文字2"] ~= "  ")  or (WAR.Person[i]["特效文字3"] ~= nil and WAR.Person[i]["特效文字3"] ~= "  ") ) then
						local dx = WAR.Person[i]["坐标X"] - x0
						local dy = WAR.Person[i]["坐标Y"] - y0
						local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
						local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
						local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

						ry = ry - hb
						
						KungfuString(WAR.Person[i]["特效文字3"], rx, ry, C_WHITE, CC.Fontsmall, CC.FontName, 1)
						KungfuString(WAR.Person[i]["特效文字2"], rx, ry, C_GOLD, CC.Fontsmall, CC.FontName, 2)
						KungfuString(WAR.Person[i]["特效文字1"], rx, ry, C_RED, CC.Fontsmall, CC.FontName, 3)
						KungfuString(WAR.Person[i]["特效文字0"], rx, ry, C_ORANGE, CC.Fontsmall, CC.FontName, 4)
						KungfuString(WAR.Person[i]["特效文字5"], rx, ry, LightGreen, CC.Fontsmall, CC.FontName, 5)
						KungfuString(WAR.Person[i]["特效文字6"], rx, ry, LightSlateBlue, CC.FontSmall, CC.FontName, 6)
						yanshi2 = true
					end
				end
			end
		end
		if yanshi then
		  lib.ShowSurface(0)
		  lib.LoadSur(sssid, minx, miny)
		  lib.Delay(30)
		elseif yanshi2 then
		  lib.ShowSurface(0)
		  lib.LoadSur(sssid, minx, miny)
		  lib.Delay(10)
		end
	end
	lib.FreeSur(sssid)
	Cls()	--显示点数前清空动画残影
	
	--郭襄的诸天化身步
	if WAR.ZTHSB == 1 then
		lib.SetWarMap(WAR.Person[WAR.ZT_id]["坐标X"], WAR.Person[WAR.ZT_id]["坐标Y"], 5, WAR.Person[WAR.ZT_id]["贴图"])
	end
  
	--无酒不欢：挨打时的掉血和状态显示
	if HitXYNum > 0 then
		local clips = {}
		for i = 0, HitXYNum - 1 do
			local dx = HitXY[i][1] - x0
			local dy = HitXY[i][2] - y0
			local hb = GetS(JY.SubScene, HitXY[i][1], HitXY[i][2], 4)		--海拔
		  
			local ll = 4;
			for y=3, hnum do
				if HitXY[i][y] ~= nil then
					ll = string.len(HitXY[i][y]);
					break;
				end
			end
			local w = ll * CC.DefaultFont / 2 + 1
			clips[i] = {x1 = CC.XScale * (dx - dy) + CC.ScreenW / 2, y1 = CC.YScale * (dx + dy) + CC.ScreenH / 2 - hb, x2 = CC.XScale * (dx - dy) + CC.ScreenW / 2 + w, y2 = CC.YScale * (dx + dy) + CC.ScreenH / 2 + CC.DefaultFont + 1}
		end
		
		local clip = clips[0]
		for i = 1, HitXYNum - 1 do
			clip = MergeRect(clip, clips[i])
		end
		
		local area = (clip.x2 - clip.x1) * (clip.y2 - clip.y1)		--绘画的范围
		local surid = lib.SaveSur(minx, miny, maxx, maxy)		--绘画句柄
		--显示点数
		--无酒不欢：一次显示两种状态
		for y = 3, hnum-2, 2 do
			if JY.Restart == 1 then
				break
			end
			local flag = false;
			for i = 5, 15 do
				local tstart = lib.GetTime()
				local y_off = i * 2 + CC.DefaultFont + CC.RowPixel
				
				lib.SetClip(0, 0, CC.ScreenW, CC.ScreenH)
				lib.LoadSur(surid, minx, miny)
				for j = 0, HitXYNum - 1 do
					if HitXY[j][y] ~= nil or HitXY[j][y+1] ~= nil then	
						local c = y - 1;
						--无酒不欢：这里用字符串的首位判定是否为掉血
						if y == 3 and HitXY[j][y] ~= nil and string.sub(HitXY[j][y],1,1) == "-" then
							if CONFIG.HPDisplay == 1 then
								HP_Display_When_Hit(i) --无酒不欢：实时显血
							end   
							if -500 < HitXY[j][y] and HitXY[j][y] <= -1 then
							   DrawString(clips[j].x1 - string.len(HitXY[j][y])*CC.DefaultFont/4, clips[j].y1 - y_off, HitXY[j][y], Color_Hurt1, CC.DefaultFont) 
							elseif -999 < HitXY[j][y] and HitXY[j][y] <= -500 then
							   DrawString(clips[j].x1 - string.len(HitXY[j][y])*CC.DefaultFont/4, clips[j].y1 - y_off, HitXY[j][y], RGB(228,100,0), CC.DefaultFont)   
							elseif -1999 < HitXY[j][y] and HitXY[j][y] <= -999 then
							   DrawString(clips[j].x1 - string.len(HitXY[j][y])*CC.DefaultFont/4, clips[j].y1 - y_off, HitXY[j][y], RGB(255,60,0), CC.DefaultFont)
							elseif -2999 < HitXY[j][y] and HitXY[j][y] <= -1999 then
							   DrawString(clips[j].x1 - string.len(HitXY[j][y])*CC.DefaultFont/4, clips[j].y1 - y_off, HitXY[j][y], RGB(250,0,0), CC.DefaultFont)
							else
							   DrawString(clips[j].x1 - string.len(HitXY[j][y])*CC.DefaultFont/4, clips[j].y1 - y_off, HitXY[j][y], RGB(255,255,255), CC.DefaultFont)
							end
						elseif y == 3 and HitXY[j][y] == 0 then
						    DrawString(clips[j].x1 - string.len(HitXY[j][y])*CC.DefaultFont/4, clips[j].y1 - y_off, HitXY[j][y], C_WHITE, CC.DefaultFont)
						else
							--无酒不欢：双排显示暂时这样写了
							local spacing = 0
							if HitXY[j][y] ~= nil then
								DrawString(clips[j].x1 - string.len(HitXY[j][y])*CC.DefaultFont/4, clips[j].y1 - y_off, HitXY[j][y], WAR.L_EffectColor[c], CC.DefaultFont)
								spacing = CC.DefaultFont
							end
							if HitXY[j][y+1] ~= nil then
								DrawString(clips[j].x1 - string.len(HitXY[j][y+1])*CC.DefaultFont/4, clips[j].y1 + spacing - y_off, HitXY[j][y+1], WAR.L_EffectColor[c+1], CC.DefaultFont)
							end
						end
							
						flag = true;
					end
				end
                
				if flag then
					ShowScreen(1)
					lib.SetClip(0, 0, 0, 0)
					local tend = lib.GetTime()
					if tend - tstart < CC.BattleDelay then
						lib.Delay(CC.BattleDelay - (tend - tstart))
					end
				end
			end
		end
		lib.FreeSur(surid)
	end
	
	--动画后恢复血条
	WAR.ShowHP = 1
	WAR.ShowMP = 1
	--清除点数
	for i = 0, HitXYNum - 1 do
		local id = GetWarMap(HitXY[i][1], HitXY[i][2], 2);
		WAR.Person[id]["生命点数"] = nil;
		WAR.Person[id]["内力点数"] = nil;
		WAR.Person[id]["体力点数"] = nil;
		WAR.Person[id]["中毒点数"] = nil;
		WAR.Person[id]["解毒点数"] = nil;
		WAR.Person[id]["内伤点数"] = nil;
		WAR.Person[id]["Life_Before_Hit"] = 0;
	end
  
	--清除特效文字
	for i = 0, WAR.PersonNum - 1 do
		WAR.Person[i]["特效动画"] = -1
		WAR.Person[i]["特效文字0"] = nil
		WAR.Person[i]["特效文字1"] = nil
		WAR.Person[i]["特效文字2"] = nil
		WAR.Person[i]["特效文字3"] = nil
		WAR.Person[i]["特效文字4"] = nil
		WAR.Person[i]["特效文字5"] = nil
		WAR.Person[i]["特效文字6"] = nil
	end
	lib.SetClip(0, 0, 0, 0)
	WarDrawMap(0)
	ShowScreen()
end


---执行医疗，解毒用毒暗器的子函数，自动医疗也可调用
function War_ExecuteMenu_Sub(x1, y1, flag, thingid)
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local x0 = WAR.Person[WAR.CurID]["坐标X"]
	local y0 = WAR.Person[WAR.CurID]["坐标Y"]
	CleanWarMap(4, 0)
	WAR.ShowHP = 0
	WAR.ShowMP = 0
	WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
	SetWarMap(x1, y1, 4, 1)
	local emeny = GetWarMap(x1, y1, 2)
	if emeny >= 0 then
		if flag == 1 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
			WAR.Person[emeny]["中毒点数"] = War_PoisonHurt(pid, WAR.Person[emeny]["人物编号"])
			if JY.Person[0]["阶"] >= 1 and JY.Base["标准"] == 9 and pid == 0 and WAR.Person[emeny]["人物编号"] ~= pid then
	           WAR.Person[emeny]["生命点数"] = AddPersonAttrib(WAR.Person[emeny]["人物编号"], "生命", -math.modf(JY.Person[WAR.Person[emeny]["人物编号"]]["生命"]*0.15))
	        end
			SetWarMap(x1, y1, 4, 5)
			WAR.Effect = 5
		elseif flag == 2 then--and WAR.Person[WAR.CurID]["我方"] == WAR.Person[emeny]["我方"] then
			WAR.Person[emeny]["解毒点数"] = ExecDecPoison(pid, WAR.Person[emeny]["人物编号"])
			SetWarMap(x1, y1, 4, 6)
			WAR.Effect = 6
		elseif flag == 3 then
			--医生单独判定
			--if WAR.Person[WAR.CurID]["人物编号"] == 0 and JY.Base["标准"] == 8 then
			  
			--elseif WAR.Person[WAR.CurID]["我方"] == WAR.Person[emeny]["我方"] then
			  WAR.Person[emeny]["生命点数"] = ExecDoctor(pid, WAR.Person[emeny]["人物编号"])
			  SetWarMap(x1, y1, 4, 4)
			  WAR.Effect = 4
			--end
		elseif flag == 5 then
		       if WAR.Person[WAR.CurID]["我方"] == WAR.Person[emeny]["我方"] then
			      WAR.Person[emeny]["生命点数"] = War_IncantationHeal(pid, WAR.Person[emeny]["人物编号"])
				  if JY.Person[694]["天3"] == 2 then
				     WAR.ZJbuff[WAR.Person[emeny]["人物编号"]] = 20
				  end
			      SetWarMap(x1, y1, 4, 4)
			      WAR.Effect = 4
			   elseif WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
			      WAR.Person[emeny]["中毒点数"] = War_IncantationPoison(pid, WAR.Person[emeny]["人物编号"])
			      SetWarMap(x1, y1, 4, 5)
			      WAR.Effect = 5
				  WAR.Person[emeny]["生命点数"] = War_IncantationHurt(pid, WAR.Person[emeny]["人物编号"])
				  if JY.Person[694]["天3"] == 2 then
				     WAR.ZJDbuff[WAR.Person[emeny]["人物编号"]] = 20
				  end
			   end
		--暗器
		elseif flag == 4 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
		    --赵半山
		    if match_ID(pid, 153) and WAR.HLB == 0 then
			   WAR.HLB = thingid
			   if JY.Person[153]["阶"] >= 3 then
			      WAR.FYYS = -thingid
			   end
			end
			--李寻欢
		    if match_ID(pid, 684) and thingid == 29 and WAR.XLFD == 0 then
			   WAR.XLFD = 3
			end
			--葵花尊者反击暗器
			if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and WAR.Person[emeny]["人物编号"] == 27 and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
				CleanWarMap(4, 0)
				local orid = WAR.CurID
				WAR.CurID = emeny
				
				WAR.Person[WAR.CurID]["人方向"] = War_Direct(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], x0, y0)
				
				Cls()
				local KHZZ = {"无知的"..JY.Person[0]["外号2"],"竟然想班门弄斧","吃我的葵花神针"}
				
				for i = 1, #KHZZ do
					lib.GetKey()
					DrawString(-1, -1, KHZZ[i], C_GOLD, CC.Fontsmall)
					ShowScreen()
					Cls()
					lib.Delay(1000)
				end
				
				SetWarMap(x0, y0, 4, 1)
				
				WAR.Person[orid]["生命点数"] = (WAR.Person[orid]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[orid]["人物编号"], "生命", -300)
				WAR.Person[orid]["中毒点数"] = (WAR.Person[orid]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[orid]["人物编号"], "中毒程度", 100)
				WAR.TXXS[WAR.Person[orid]["人物编号"]] = 1
				
				WAR.KHSZ = 1
				
				War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, -1, 0, x0, y0, 35)
				
				WAR.KHSZ = 0
				
				WAR.CurID = orid
				return 1
			end
			--独孤求败免疫暗器
			if match_ID(WAR.Person[emeny]["人物编号"],592) and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
				local orid = WAR.CurID
				WAR.CurID = emeny
				Cls()
				CurIDTXDH(WAR.CurID, 137,1, "料敌先机・破针式", C_GOLD)
				WAR.CurID = orid
				return 1
			end
			--谢无悠免疫暗器
			if match_ID(WAR.Person[emeny]["人物编号"],596) and WAR.JESS[WAR.Person[emeny]["人物编号"]] == nil then
				return 1
			end
			
			if not match_ID(pid, 83) then
				--暗器随机伤害倍数
				local m = 3
				if JY.Person[pid]["暗器2"] == 100 then
				m = m + 2
				end
				if JY.Person[pid]["暗器1"] == 100 then
			        WAR.AQBS = math.random(m) + 1
		        else
		            WAR.AQBS = math.random(m)
		        end
				--袁承志用金蛇锥必定三倍
				if match_ID(pid, 54) and thingid == 30 then
					WAR.AQBS = m
					if JY.Person[pid]["暗器1"] == 100 then
			            WAR.AQBS = m + 1
		            end
				end
				
				WAR.Person[emeny]["Life_Before_Hit"] = JY.Person[WAR.Person[emeny]["人物编号"]]["生命"]
				WAR.Person[emeny]["生命点数"] = War_AnqiHurt(pid, WAR.Person[emeny]["人物编号"], thingid, emeny)
				SetWarMap(x1, y1, 4, 2)
				WAR.Effect = 2
			end
		end
	end
	--张角
	if flag == 5 and JY.Person[694]["天4"] == 2 then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
			local a, b = WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"]
				SetWarMap(a, b, 4, 1)
				SetWarMap(a, b, 4, 4)
				if GetWarMap(a, b, 2) ~= nil and GetWarMap(a, b, 2) > -1 then
				WAR.Person[j]["生命点数"] = War_IncantationHeal(pid, WAR.Person[j]["人物编号"])
				WAR.Effect = 4
				if JY.Person[694]["天3"] == 2 then
				   WAR.ZJbuff[WAR.Person[j]["人物编号"]] = 20
				end
				end
			end
		end	
	end
	
	if flag == 5 and JY.Person[694]["天4"] == 2 then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
			local a, b = WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"]
				SetWarMap(a, b, 4, 1)
				SetWarMap(a, b, 4, 5)
				if GetWarMap(a, b, 2) ~= nil and GetWarMap(a, b, 2) > -1 then
				WAR.Person[j]["中毒点数"] = War_IncantationPoison(pid, WAR.Person[j]["人物编号"])
			      SetWarMap(a, b, 4, 5)
			      WAR.Effect = 5
				WAR.Person[j]["生命点数"] = War_IncantationHurt(pid, WAR.Person[j]["人物编号"])
				  if JY.Person[694]["天3"] == 2 then
				     WAR.ZJDbuff[WAR.Person[j]["人物编号"]] = 20
				  end
				end
			end
		end	
	end
	--主角医生方阵医疗
	if flag == 3 and pid == 0 and JY.Base["标准"] == 8 then
		for ex = x1 - 3, x1 + 3 do
			for ey = y1 - 3, y1 + 3 do
				SetWarMap(ex, ey, 4, 1)
				if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
					local ep = GetWarMap(ex, ey, 2)
					if WAR.Person[WAR.CurID]["我方"] == WAR.Person[ep]["我方"] then
						WAR.Person[ep]["生命点数"] = ExecDoctor(pid, WAR.Person[ep]["人物编号"])
						SetWarMap(ex, ey, 4, 4)
						WAR.Effect = 4
					end
				end        
			end
		end
	end
	--主角毒王方阵上毒，可以给自己上毒
	if flag == 1 and pid == 0 and JY.Base["标准"] == 9 then
		for ex = x1 - 3, x1 + 3 do
			for ey = y1 - 3, y1 + 3 do
				SetWarMap(ex, ey, 4, 1)
				if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
					local ep = GetWarMap(ex, ey, 2)
					if (WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"]) or ep == WAR.CurID then
						WAR.Person[ep]["中毒点数"] = War_PoisonHurt(pid, WAR.Person[ep]["人物编号"])
						if JY.Person[0]["阶"] >= 1 and WAR.Person[ep]["人物编号"] ~= pid then
	                       WAR.Person[ep]["生命点数"] = AddPersonAttrib(WAR.Person[ep]["人物编号"], "生命", -math.modf(JY.Person[WAR.Person[ep]["人物编号"]]["生命"]*0.15))
	                    end
						SetWarMap(ex, ey, 4, 5)
						WAR.Effect = 5
					end
				end        
			end
		end
	end
	--何铁手使用暗器为7*7方阵
	if flag == 4 and (match_ID(pid, 83) or JY.Person[pid]["暗器3"] == 100) then
		--暗器随机伤害倍数
		local m = 3
		if JY.Person[pid]["暗器2"] == 100 then
			m = m + 2
		end
		if JY.Person[pid]["暗器1"] == 100 then
			WAR.AQBS = math.random(m) + 1
		else
		    WAR.AQBS = math.random(m)
		end
		if match_ID(pid, 54) and thingid == 30 then
			WAR.AQBS = m
			if JY.Person[pid]["暗器1"] == 100 then
			WAR.AQBS = m + 1
			end
		else
		end
		for ex = x1 - 3, x1 + 3 do
			for ey = y1 - 3, y1 + 3 do
				SetWarMap(ex, ey, 4, 1)
				if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
					local ep = GetWarMap(ex, ey, 2)
					if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] then
						WAR.Person[ep]["生命点数"] = War_AnqiHurt(pid, WAR.Person[ep]["人物编号"], thingid, ep)
						SetWarMap(ex, ey, 4, 4)
						WAR.Effect = 2
					end
				end
			end
		end
	end
	--霹雳弹
	if flag == 4 and thingid == 31 and JY.Person[pid]["暗器4"] == 100 then
		--暗器随机伤害倍数
		local m = 3
		if JY.Person[pid]["暗器2"] == 100 then
			m = m + 2
		end
		if JY.Person[pid]["暗器1"] == 100 then
			WAR.AQBS = math.random(m) + 1
		else
		    WAR.AQBS = math.random(m)
		end
		for ex = x1 - 5, x1 + 5 do
			for ey = y1 - 5, y1 + 5 do
				SetWarMap(ex, ey, 4, 1)
				if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
					local ep = GetWarMap(ex, ey, 2)
					if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] then
						WAR.Person[ep]["生命点数"] = War_AnqiHurt(pid, WAR.Person[ep]["人物编号"], thingid, ep)
						SetWarMap(ex, ey, 4, 4)
						WAR.Effect = 2
					end
				end
			end
		end
	end
	WAR.EffectXY = {}
	WAR.EffectXY[1] = {x1, y1}
	WAR.EffectXY[2] = {x1, y1}
	if flag == 1 then
		War_ShowFight(pid, 0, 0, 0, x1, y1, 30)
	elseif flag == 2 then
		War_ShowFight(pid, 0, 0, 0, x1, y1, 36)
	elseif flag == 3 then
		War_ShowFight(pid, 0, 0, 0, x1, y1, 0)
	elseif flag == 4 and (emeny >= 0 or (match_ID(pid, 83) or JY.Person[pid]["暗器3"] == 100)) then
		War_ShowFight(pid, 0, -1, 0, x1, y1, thingid)
	elseif flag == 4 and (emeny >= 0 or thingid == 31 and JY.Person[pid]["暗器4"] == 100) then
		War_ShowFight(pid, 0, -1, 0, x1, y1, thingid)	
	elseif flag == 5 then
	    if JY.Person[694]["天4"] == 2 then
			War_ShowFight(pid, 0, 0, 0, x1, y1, 78)
		else
	    War_ShowFight(pid, 0, 0, 0, x1, y1, 78)
		end
	end
	--for i = 0, WAR.PersonNum - 1 do
		--WAR.Person[i]["点数"] = 0
	--end
	if flag == 4 then
		if emeny >= 0 or (match_ID(pid, 83) or JY.Person[pid]["暗器3"] == 100) or JY.Person[pid]["暗器4"] == 100 then
			instruct_32(thingid, -1)
			--张家辉的隐身戒指
			if JY.Person[pid]["防具"] == 304 then
				local cd = 40
				if JY.Thing[304]["装备等级"] >=5 then
					cd = 20
				elseif JY.Thing[304]["装备等级"] >=3 then
					cd = 30
				end
				WAR.YSJZ = cd
			end
			return 1
		else
			return 0
		end
	else
		WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + 1
		if match_ID(pid, 16) and JY.Person[16]["阶"] >= 1 then
		elseif JY.Base["标准"] == 8 and pid == 0 and JY.Person[0]["阶"] >= 2 then
		else
		AddPersonAttrib(pid, "体力", -2)
		end
	end
  
	if inteam(pid) then
	    if match_ID(pid, 16) and JY.Person[16]["阶"] >= 1 then
		elseif JY.Base["标准"] == 8 and pid == 0 and JY.Person[0]["阶"] >= 2 then
		else
		AddPersonAttrib(pid, "体力", -4)
		end
	end
	return 1
end

--无酒不欢：挨打后，绘画动态集气条的判定
function DrawTimeBar2()
	local x1,x2,y = CC.ScreenW * 1 / 2 - 34, CC.ScreenW * 19 / 20 - 2, CC.ScreenH/10 + 29
	local draw = false
	local heal_amount;
	
	--这三个是固定的，只需要加载一次就可以了
	--无酒不欢：这里也要判定是否有需要draw，如无需要则不加载
	local drawframe = false
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			if WAR.Person[i].TimeAdd ~= 0 then
				drawframe =  true
				break
			end
		end
	end
	if drawframe == true then
		DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
		DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
		DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
		lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
		lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
	end
	
	local surid = lib.SaveSur(x1 - (10 + (x2 - x1) / 2), 0, x2 + 10 + 20 + 30, y * 2 + 18 + 25)
  
	while true do
		if JY.Restart == 1 then
			break
		end
		lib.GetKey()
		draw = false
		for i = 0, WAR.PersonNum - 1 do
			lib.GetKey()
			local pid = WAR.Person[i]["人物编号"];
			local yin, yang, tg = NeiL(pid)
			local fx = yin + yang
			--首先判定人物是否活着
			if WAR.Person[i]["死亡"] == false then
				--这里TimeAdd小于0代表集气位置要减少，数值为减少总量
				if WAR.Person[i].TimeAdd < 0 then
					draw = true
					--减量以20为单位循环增加，增加到超过0时，判定将不再成立，既停止减少集气位置
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
					if WAR.Person[i].TimeAdd > 0 then
						WAR.Person[i].TimeAdd = 0;
					end					
					--如果人物的集气位置没有达到-500，则减少20，向-500靠近
					if WAR.Person[i].Time > -500 then
					local x = 0
					if tg ~= 1 then
					   if fx > 0 then
					      x = fx*20
					   end
					else
					   x = yang*20
					end
						--如果主运瑜伽，则不会低于300
						if Curr_NG(pid, 169)  then
							if WAR.Person[i].Time > 300 then
								WAR.Person[i].Time = WAR.Person[i].Time - 20
								if WAR.Person[i].Time <= 300 + x*20 then
									WAR.Person[i].Time = 300 + x*20
									if WAR.Person[i].Time > 500 then
									   WAR.Person[i].Time = 500
									end   
									WAR.Person[i].TimeAdd = 0
								end
							end
						--被动瑜伽，不低于0
						elseif PersonKF(pid, 169) then
							if WAR.Person[i].Time > 0 then
								WAR.Person[i].Time = WAR.Person[i].Time - 20
								if WAR.Person[i].Time <= 0 + x*20 then
									WAR.Person[i].Time = 0 + x*20
									if WAR.Person[i].Time > 200 then
									   WAR.Person[i].Time = 200
									end
									WAR.Person[i].TimeAdd = 0
								end
							end
						else
							WAR.Person[i].Time = WAR.Person[i].Time - 20
						end
					--如果人物的集气位置已经达到-500，则集气位置不再减少，而是转换为内伤
					else
						if JY.Person[pid]["受伤程度"] < 100 then
							AddPersonAttrib(pid, "受伤程度", math.random(3))
						end
						if PersonKF(pid, 100) then	--练了先天功后，当集气被杀到-500，内伤直接清0
							WAR.Person[i].TimeAdd = 0	
							JY.Person[pid]["受伤程度"] = 0;
							Cls()
							War_Show_Count(WAR.CurID, "先天疗伤")
						end
					end
				--大于0代表集气位置要增加，
				elseif WAR.Person[i].TimeAdd > 0 then
					draw = true
					--增量以20为单位循环减少，减少到低于0时，判定将不再成立，既停止增加集气位置
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 20
					--人物的集气位置以20为单位增加，如果集气位置超过995，则强制定为995
					WAR.Person[i].Time = WAR.Person[i].Time + 20
					if WAR.Person[i].Time > 995 then
						WAR.Person[i].Time = 995;
					end
				end
			end
		end
						
		if draw then
			lib.LoadSur(surid, x1 - (10 + (x2 - x1) / 2), 0)
			DrawTimeBar_sub(x1, x2, y, 1)
			ShowScreen()
			lib.Delay(8)
		else
			break;
		end
	end
	lib.Delay(100)
	lib.FreeSur(surid)
end

--绘制集气条
function DrawTimeBar()
	
	local x1,x2,y = CC.ScreenW * 1 / 2 - 34, CC.ScreenW * 19 / 20 - 2, CC.ScreenH/10 + 29
	local xunhuan = true
    local px,py = nil,nil
	for i = 0,WAR.PersonNum -1 do 
	    if WAR.Person[i]['人物编号'] == 0 and WAR.Person[i]['死亡'] == false then
			px,py = WAR.Person[i]['坐标X'],WAR.Person[i]['坐标Y']
			break
		end
	end
	--这三个是固定的，只需要加载一次就可以了
	DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
	DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
	DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
	lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
	lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
  
	lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
	local surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)	--无酒不欢：修复杀到-500后集气条小头像刷新问题
	while xunhuan do
		if JY.Restart == 1 then
			break
		end
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["死亡"] == false then
				local jqid = WAR.Person[i]["人物编号"]
				local yin, yang, tg = NeiL(jqid)
				local fx = yin + yang
				local jq = WAR.Person[i].TimeAdd	--人物集气速度
				local MpR = 0
				local HpR = 0
				local MpR2 = 0
				local HpR2 = 0
				local SpR = 0
				local ix,iy = WAR.Person[i]['坐标X'],WAR.Person[i]['坐标Y']
				--无酒不欢：每25点内伤-1集气，每25点中毒-1集气，玩家与NPC一样
				local ns_factor = math.modf(JY.Person[jqid]["受伤程度"] / 25)
				local zd_factor = 1-JY.Person[jqid]["中毒程度"]*0.001
				--九阴摄魂
				local jysh = false
				local ylmb = false
				local xwdsh = false
				if px ~= nil and jqid ~= 0 then 
					local p = GetWarMap(px,py,2)
					if p >= 0 and WAR.Person[i]['我方'] ~= WAR.Person[p]['我方'] then
						if math.abs(ix-px) + math.abs(iy-py) <= 14 and Curr_NG(0, 193) then
							jysh = true
						end	 
					end
				end
				if px ~= nil and jqid ~= 0 then 
					local p = GetWarMap(px,py,2)
					if p >= 0 and WAR.Person[i]['我方'] ~= WAR.Person[p]['我方'] then
						if math.abs(ix-px) + math.abs(iy-py) <= 7 and WAR.YLMB[0] ~= nil then
							ylmb = true
						end	 
					end
				end
				if px ~= nil and jqid ~= 0 then 
					local p = GetWarMap(px,py,2)
					if p >= 0 and WAR.Person[i]['我方'] ~= WAR.Person[p]['我方'] then
						if math.abs(ix-px) + math.abs(iy-py) <= 9 and JY.Person[690]["天1"] == 2 and not inteam(WAR.Person[i]["人物编号"]) then
							xwdsh = true
						end	 
					end
				end
				if XueDao() then
				   if not match_ID(jqid, 97) then
				   WAR.XHTT[jqid] = JY.Person[jqid]["生命"]
				   end
				end
				--毒王中毒反而增加集气
				if jqid == 0 and JY.Base["标准"] == 9 then
					zd_factor = 2-zd_factor
				end
				--冰封也减少
				local bf_factor = 0;
				if JY.Person[jqid]["冰封程度"] >= 50 then
					bf_factor = 6
				elseif JY.Person[jqid]["冰封程度"] > 0 then
					bf_factor = 3
				end				   
				--何太冲的铁琴减少集气，一层减少1%
				local HTC_tq = 0
				if WAR.QYZT[jqid] ~= nil then
					HTC_tq = math.modf(jq * 0.01 * WAR.QYZT[jqid])
				end
				--怨忿莫名
				if WAR.YFMM[jqid] ~= nil then
				   jq = math.modf(jq*0.66)  
				end
				--李秋水集气不受状态影响
				if match_ID(jqid, 118) == false and Curr_QG(jqid,145) == false and match_ID(jqid, 673) == false and match_ID(jqid, 682) == false and (jqid == 0 and JY.Person[0]["天4"] == 3) == false then
					jq = math.modf((jq - ns_factor - bf_factor - HTC_tq)*zd_factor)
				end
				
				if ylmb == true then
				   jq = jq - (JY.Person[689]["天1"])*6
				end
				if xwdsh == true then
				   jq = math.modf(jq*0.8)
				end
				
				if ((JY.Base["畅想"] == 147 and jqid >= 143 and jqid <= 148) or (JY.Base["畅想"] == 41 and jqid == 42)) and JY.Person[0]["等级"] ~= 30 then
				   jq = 0
				end
				
				if jq < 0 then
					jq = 0
				end
				
				if WAR.LQZ[jqid] == 100 and match_ID(jqid, 673) == false and match_ID(jqid, 151) == false and match_ID(jqid, 693) == false then
				    jq = math.modf(jq * 2.5)
				    if jysh == true then
						jq = math.modf(jq * 0.75)
					end
					if Curr_QG(jqid,150) then	--运功瞬息千里，暴怒4倍集气 文泰来无效
						jq = math.modf(jq * 1.4)
					end
					if PersonKF(jqid, 150) and JY.Person[jqid]["专1"] == 150 then
					   jq = math.modf(jq*1.15)
					end
					if JY.Person[jqid]["防具"] == 327 then
					    jq = math.modf(jq*1.5) + JY.Base["天书数量"]*5
					end
					if match_ID(jqid, 36) and JY.Person[36]["阶"] >= 3 then
					   jq = math.modf(jq*1.5)
					end
					
					if jq > 400 then
					   jq = 400 + math.modf((jq-400)^0.85)
					end
					
				end
				if WAR.LQZ[jqid] == 100 and match_ID(jqid, 693) and JY.Person[693]["天2"] == 1 then
				   jq = math.modf(jq*1.7)
				end
				--沉睡的敌人，无法集气
				if WAR.CSZT[jqid] == 1 then
					jq = 0
					if ((match_ID(jqid, 688) and JY.Person[688]["天1"] == 1) or JY.Person[jqid]["人27"] == 1) and WAR.JESS[jqid] == nil then
				      jq = 30	
				      WAR.Person[i].Time = WAR.Person[i].Time + jq   
				    end
				--被无招胜有招击中的人，无法集气
				elseif WAR.WZSYZ[jqid] ~= nil then
					jq = 0
					if ((match_ID(jqid, 688) and JY.Person[688]["天1"] == 1) or JY.Person[jqid]["人27"] == 1) and WAR.JESS[jqid] == nil then
				      jq = 30	
				      WAR.Person[i].Time = WAR.Person[i].Time + jq   
				    end
					WAR.WZSYZ[jqid] = WAR.WZSYZ[jqid] - 1
					if WAR.WZSYZ[jqid] < 1 then
						WAR.WZSYZ[jqid] = nil
					end
				--冻结的敌人，无法集气				
				elseif WAR.LRHF[jqid] ~= nil then
					jq = 0
					if ((match_ID(jqid, 688) and JY.Person[688]["天1"] == 1) or JY.Person[jqid]["人27"] == 1) and WAR.JESS[jqid] == nil then
				      jq = 30	
				      WAR.Person[i].Time = WAR.Person[i].Time + jq   
				    end
					WAR.LRHF[jqid] = WAR.LRHF[jqid] - 1
					if WAR.LRHF[jqid] < 1 then
						WAR.LRHF[jqid] = nil
					end
				--剑二十三	
				elseif WAR.JESS[jqid] ~= nil then
				    jq = 0
					WAR.JESS[jqid] = WAR.JESS[jqid] - 1
					if WAR.JESS[jqid] < 1 then
						WAR.JESS[jqid] = nil
					end	
				--没有封穴的情况下，可以集气
				elseif WAR.FXDS[jqid] == nil then
					--欧阳锋会跳气
					if match_ID(jqid, 60) and math.random(10) == 8 then
						jq = jq + math.random(10, 30);
					end	
					if Curr_NG(jqid,95) and JLSD(20, 25, jqid) then
						jq = jq + math.random(5, 15);
					end
					if PersonKF(jqid, 104) and PersonKF(jqid, 95) and JLSD(20, 25, jqid) then
						jq = jq + math.random(5, 10);
					end	
					if (match_ID(jqid, 634) and JY.Person[634]["天4"] == 1 and (math.random(100)==13 or math.random(100)==66)) or (jqid==689 and (math.random(100)==23 or math.random(100)==44))  then
					   WAR.Person[i].Time = 999
					end
					if WAR.TGLX[jqid] ~= nil then
					   if math.random(6) == 2 then
							WAR.Person[i].Time = WAR.Person[i].Time - jq*3
						else
							WAR.Person[i].Time = WAR.Person[i].Time + jq
						end
					end
					if WAR.GDG[jqid] ~= nil then
					   if math.random(5) == 2 then
							WAR.Person[i].Time = WAR.Person[i].Time - jq
						else
							WAR.Person[i].Time = WAR.Person[i].Time + jq
						end
					end
					
					if JY.Person[49]["阶"] >= 1 then
					if WAR.TZ_XZ_SSH[jqid] ~= nil then
					   if math.random(5) == 2 then
							WAR.Person[i].Time = WAR.Person[i].Time - jq
						else
							WAR.Person[i].Time = WAR.Person[i].Time + jq
						end
					end
					end
					
					if WAR.LSQ[jqid] ~= nil then	--被灵蛇拳击中，集气波动20时序
						if math.random(3) == 1 then
							WAR.Person[i].Time = WAR.Person[i].Time - jq
						else
							WAR.Person[i].Time = WAR.Person[i].Time + jq
						end
						WAR.LSQ[jqid] = WAR.LSQ[jqid] - 1
						if WAR.LSQ[jqid] == 0 then
							WAR.LSQ[jqid] = nil
						end
					end
					if WAR.BBSJ[jqid] ~= nil then	--八臂神剑，集气负面效果双倍扣时序
						WAR.Person[i].Time = math.modf(WAR.Person[i].Time + jq  - ns_factor - bf_factor)*zd_factor
						WAR.BBSJ[jqid] = WAR.BBSJ[jqid] - 1
						if WAR.BBSJ[jqid] == 0 then
							WAR.BBSJ[jqid] = nil
						end
					end
					if WAR.YKDD1[jqid] ~= nil then	--一空到底1，集气倒扣10时序
						WAR.Person[i].Time = WAR.Person[i].Time - jq
						WAR.YKDD1[jqid] = WAR.YKDD1[jqid] - 1
						if WAR.YKDD1[jqid] == 0 then
							WAR.YKDD1[jqid] = nil
						end
					end
					if WAR.YKDD2[jqid] ~= nil then	--一空到底2，集气倒扣10时序
						WAR.Person[i].Time = WAR.Person[i].Time - jq
						WAR.YKDD2[jqid] = WAR.YKDD2[jqid] - 1
						if WAR.YKDD2[jqid] == 0 then
							WAR.YKDD2[jqid] = nil
						end
					end
					if WAR.JQDT[jqid] ~= nil then	--集气倒扣
						WAR.Person[i].Time = WAR.Person[i].Time - jq
						WAR.JQDT[jqid] = WAR.JQDT[jqid] - 1
						if WAR.JQDT[jqid] == 0 then
							WAR.JQDT[jqid] = nil
						end
					end
					
					if WAR.LSQ[jqid] == nil and WAR.BBSJ[jqid] == nil and WAR.YKDD1[jqid] == nil and  WAR.YKDD2[jqid] == nil and WAR.JQDT[jqid] == nil then
						WAR.Person[i].Time = WAR.Person[i].Time + jq
					end
					if ((match_ID(jqid, 688) and JY.Person[688]["天1"] == 1) or JY.Person[jqid]["人27"] == 1) and WAR.JESS[jqid] == nil and 
					(WAR.LSQ[jqid] ~= nil or WAR.BBSJ[jqid] ~= nil or WAR.YKDD1[jqid] ~= nil or WAR.YKDD2[jqid] ~= nil or WAR.JQDT[jqid] ~= nil) then
					  if jq < 30 then
				      jq = 30	
					  end
				      WAR.Person[i].Time = WAR.Person[i].Time + jq   
				   end
				--被封穴的话，不会集气，时序减少封穴
				else
				    if ((match_ID(jqid, 688) and JY.Person[688]["天1"] == 1) or JY.Person[jqid]["人27"] == 1) and WAR.JESS[jqid] == nil then
				      jq = 30	
				      WAR.Person[i].Time = WAR.Person[i].Time + jq   
				    end
					if WAR.LJXS[jqid] ~= nil then	--集气倒扣
						WAR.Person[i].Time = WAR.Person[i].Time - 15
						if WAR.Person[i].Time < -500 then
						   WAR.Person[i].Time = -500
						end   
					end
				    if WAR.JESS[jqid] == nil then
					   WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
					   if WAR.LJXS[jqid] ~= nil then
					   WAR.LJXS[jqid] = WAR.LJXS[jqid] - 1
					   end
					end
			  
					--易筋经 封穴回复+1
					if PersonKF(jqid, 108) and WAR.JESS[jqid] == nil then
						WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
						if WAR.LJXS[jqid] ~= nil then
					       WAR.LJXS[jqid] = WAR.LJXS[jqid] - 1
					    end
					end
					
					if match_ID(jqid, 637) and JY.Person[637]["声望"] >= 4 and WAR.JESS[jqid] == nil then
						WAR.FXDS[jqid] = WAR.FXDS[jqid] - 2
						if WAR.LJXS[jqid] ~= nil then
					       WAR.LJXS[jqid] = WAR.LJXS[jqid] - 2
					    end
					end
					
					--先天+玉女，封穴回复+1
					if PersonKF(jqid, 100) and PersonKF(jqid, 154) and WAR.JESS[jqid] == nil then
						WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
						if WAR.LJXS[jqid] ~= nil then
					    WAR.LJXS[jqid] = WAR.LJXS[jqid] - 1
					    end
					end

					--九阳7时序解除封穴
					if PersonKF(jqid, 106) and WAR.JESS[jqid] == nil then
						if WAR.JYFX[jqid] == nil then
							WAR.JYFX[jqid] = 1
						elseif WAR.JYFX[jqid] < 7 then
							WAR.JYFX[jqid] = WAR.JYFX[jqid] + 1
						else
							WAR.JYFX[jqid] = nil
							WAR.FXDS[jqid] = 0
							WAR.LJXS[jqid] = nil
						end
					end
					
					--暴怒时解穴速度加倍
					if WAR.LQZ[jqid] == 100 and WAR.JESS[jqid] == nil then
						WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
						if WAR.LJXS[jqid] ~= nil then
					    WAR.LJXS[jqid] = WAR.LJXS[jqid] - 1
					    end
					end
					if WAR.LJXS[jqid] ~= nil and WAR.LJXS[jqid] < 1 then
						WAR.LJXS[jqid] = nil
					end
					if WAR.FXDS[WAR.Person[i]["人物编号"]] < 1 then
						WAR.FXDS[WAR.Person[i]["人物编号"]] = nil
					end
				end
				if JY.Person[jqid]["人27"] == 1 and WAR.SPbuff[jqid] ~= nil and WAR.JESS[jqid] == nil then
		           WAR.SPbuff[jqid] = WAR.SPbuff[jqid] + 2
		        end
				
				if JY.Person[jqid]["人13"] == 1 and WAR.JESS[jqid] == nil then
				   MpR = MpR + (JY.Person[jqid]["内力最大值"] - JY.Person[jqid]["内力"])*0.01
				end
				
				if match_ID(jqid, 693) and WAR.JESS[jqid] == nil then
				   MpR = MpR + JY.Person[jqid]["内力最大值"]*0.01
				   HpR = HpR + (JY.Person[jqid]["生命最大值"] - JY.Person[jqid]["生命"])*0.005
				end
				
				if match_ID(jqid, 694) and WAR.JESS[jqid] == nil then
				local hp_rate = JY.Person[jqid]["生命"]/JY.Person[jqid]["生命最大值"]
				local mp_rate = JY.Person[jqid]["内力"]/JY.Person[jqid]["内力最大值"]
				if mp_rate < hp_rate then
				   MpR = MpR + (JY.Person[jqid]["内力最大值"] - JY.Person[jqid]["内力"])*0.01
				elseif mp_rate > hp_rate then  
				   HpR = HpR + (JY.Person[jqid]["生命最大值"] - JY.Person[jqid]["生命"])*0.01
				end
				end
				
				if JY.Person[637]["声望"] >= 2 and match_ID(jqid, 637) then
				   HpR = HpR + 1
				   JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
				end
				
				--刚柔并济
			    if GangRBJ(jqid) > 0 and WAR.JESS[jqid] == nil then
			    local x = GangRBJ(jqid)
			       HpR = HpR + x
				   MpR = MpR + x
			    end
			
				--九阳神功回内
				if PersonKF(jqid, 106) and WAR.JESS[jqid] == nil then
					MpR = MpR + 9
					if fx > 0 or tg == 1 then
					   MpR = MpR + math.min(fx,9)
					end   
					if JY.Person[jqid]["天赋内功"] == 106 then
					HpR = HpR + (JY.Person[jqid]["生命最大值"] - JY.Person[jqid]["生命"])*0.005
					end
				end
				
				if fx == 0 and WAR.JESS[jqid] == nil then
				   MpR = MpR + yang + 1
				end
				
				if WAR.LSF[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   MpR = MpR + 15
				end   
			
				--九阴神功回血
				if PersonKF(jqid, 107) and WAR.JESS[jqid] == nil then
				   HpR = HpR + 2
				    if fx < 0 or tg == 1 then
					HpR = HpR - math.max(-9,fx)
					end
				end
				--自强不息
				if jqid == 0 and JY.Person[0]["天1"] == 2 and WAR.JESS[jqid] == nil then
				   local re = 1 + math.modf((JY.Person[jqid]["生命最大值"]-JY.Person[jqid]["生命"])*(10+JY.Base["天书数量"])/JY.Person[jqid]["生命最大值"])
		           HpR = HpR + re
		        end
				
				if match_ID(jqid, 85) and WAR.JESS[jqid] == nil then
				   HpR = HpR + 2
				end
				
				if match_ID(jqid, 132) and JY.Person[jqid]["动物"] == 262 and WAR.JESS[jqid] == nil then
				   HpR = HpR + 15
				end
				
				--豪鬼，罗汉
				if match_ID(jqid, 673) and WAR.LHHF[jqid] ~= nil and WAR.JESS[jqid] == nil then
				    HpR = HpR + math.modf(WAR.LHHF[jqid]/3) + 1
				    WAR.LHHF[jqid] = WAR.LHHF[jqid] - math.modf(WAR.LHHF[jqid]/3) - 1
					if WAR.LHHF[jqid] < 1 then
					   WAR.LHHF[jqid] = nil
					end
				end
				
				if match_ID(jqid, 673) and jqid ~= 0 and WAR.JESS[jqid] == nil then
				    WAR.NLZ[jqid] = (WAR.NLZ[jqid] or 0) + 2
				end
				
				--无影神拳！
				if WAR.WYSQ[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   HpR = HpR - math.modf(math.min(20, (JY.Person[jqid]["生命最大值"] - JY.Person[jqid]["生命"])*0.02)) - 15
				end
				--化骨绵掌
				if WAR.HGMZ[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.005)-1
				end
				if WAR.LSQ2[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.03)
				end
				if WAR.LSQ3[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   MpR = MpR - math.modf(JY.Person[jqid]["内力"]*0.08)
				end
				--魔刀
				if WAR.MDLX[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.02) - 5
				    WAR.MDLX[jqid] = WAR.MDLX[jqid] - 1
					if WAR.MDLX[jqid] < 1 then
						WAR.MDLX[jqid] = nil
					end
				end
				
				--雷震，易筋经回体
				if match_ID(jqid, 670) and JY.Person[jqid]["天赋内功"] == 108 and Curr_NG(jqid, 108) and WAR.JESS[jqid] == nil then
				    SpR = SpR + math.random(0, 1)	
				end
				if JY.Base["标准"] == 8 and jqid == 0 and JY.Person[0]["阶"] >= 1 then
				   SpR = SpR + 1
				end
				if match_ID(jqid, 676) and JY.Person[676]["天2"] == 1 and WAR.JESS[jqid] == nil then
				    MpR = MpR + 6	
				end
				
				if match_ID(jqid, 89) and JY.Person[89]["阶"] >= 2 and WAR.JESS[jqid] == nil then
				    MpR = MpR + math.modf(JY.Person[jqid]["体力"]/2)
				end
				if match_ID(jqid, 89) and JY.Person[89]["阶"] >= 3 and WAR.JESS[jqid] == nil then
				    HpR = HpR + math.modf(JY.Person[jqid]["体力"]/2)
				end
				
				--雷震，蚀
				if WAR.LZ_S[jqid] ~= nil and WAR.JESS[jqid] == nil then
				    HpR = HpR - JY.Person[jqid]["中毒程度"]	
				end
				
				--噬魂
				if WAR.SHMY[jqid] == 1 and WAR.JESS[jqid] == nil then
				    HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.04) - 10			   
				end
				
				if JY.Person[49]["阶"] >= 1 and WAR.JESS[jqid] == nil then
				  if WAR.TZ_XZ_SSH[jqid] == 1 then
				     HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.01)
				  end
				end
				
				--sdd
				if WAR.SDD[jqid] == 1 and WAR.JESS[jqid] == nil then
				    HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.01) - 1			   
				end
				
				if WAR.SDD2[jqid] ~= nil and WAR.JESS[jqid] == nil then
				    HpR = HpR - JY.Person[jqid]["中毒程度"]	- 1
					WAR.SDD2[jqid] = WAR.SDD2[jqid] - 1
					if WAR.SDD2[jqid] < 1 then
					   WAR.SDD2[jqid] = nil
					end   
				end
				
				--蛊毒"蛇蛊","金蚕蛊","蔑片蛊","石头蛊","泥瞅蛊","惘蛊","肿蛊","癫蛊","姑蛊"
				if (WAR.GSG[jqid] == 1 or WAR.GJCG[jqid] == 1 or WAR.GMPG[jqid] == 1
				   or WAR.GSTG[jqid] == 1 or WAR.GNQG[jqid] == 1 or WAR.GWG[jqid] == 1 or WAR.GZG[jqid] == 1
				   or WAR.GDG[jqid] == 1 or WAR.GGG[jqid] == 1) and WAR.JESS[jqid] == nil then
				   local n = 0
				   if WAR.GSG[jqid] == 1 then
				      n = n + 1
				   end
				   if WAR.GJCG[jqid] == 1 then
				      n = n + 3
				   end
				   if WAR.GMPG[jqid] == 1 then
				      n = n + 1
				   end
				   if WAR.GSTG[jqid] == 1 then
				      n = n + 1
				   end
				   if WAR.GNQG[jqid] == 1 then
				      n = n + 1
				   end
				   if WAR.GWG[jqid] == 1 then
				      n = n + 1
				   end
				   if WAR.GZG[jqid] == 1 then
				      n = n + 1
				   end
				   if WAR.GDG[jqid] == 1 then
				      n = n + 1
				   end
				   if WAR.GGG[jqid] == 1 then
				      n = n + 1
				   end
				   HpR = HpR - n^2
				end   
				
				if WAR.NQK[jqid] ~= nil and WAR.NQK[jqid] > 0 and WAR.JESS[jqid] == nil then
				   if WAR.JQSDXS[jqid] ~= nil then
					   HpR = HpR - math.modf(WAR.JQSDXS[jqid]*0.04)*WAR.NQK[jqid]^2 - math.modf(JY.Person[jqid]["生命"]*0.01)*WAR.NQK[jqid]	
				   end
				end
				
				--天怒十方，消耗
				if JY.Person[jqid]["防具"] == 327 and JY.Person[jqid]["内力"] >= 1500 and JY.Person[jqid]["生命"] >= JY.Person[jqid]["生命最大值"]*0.2 and WAR.JESS[jqid] == nil then
				    MpR = MpR - math.modf(JY.Person[jqid]["内力"]*0.002)
					HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.01) - JY.Base["天书数量"]
					if WAR.LQZ[jqid] == 100 then
					elseif WAR.JQSDXS[jqid] ~= nil then
					   HpR = HpR - math.modf(WAR.JQSDXS[jqid]*0.1)				
					end
				end
				
				if JY.Person[jqid]["防具"] == 324 and JY.Person[jqid]["内力"] >= 1500 and JY.Person[jqid]["生命"] >= JY.Person[jqid]["生命最大值"]*0.2 and WAR.JESS[jqid] == nil then --广目无边
				    MpR = MpR - math.modf(JY.Person[jqid]["内力"]*0.001)
					if WAR.LQZ ~= 100 then
					   HpR = HpR - 1
					end
				end
				
				if JY.Person[jqid]["防具"] == 325 and JY.Person[jqid]["内力"] >= 1500 and JY.Person[jqid]["生命"] >= JY.Person[jqid]["生命最大值"]*0.2 and WAR.JESS[jqid] == nil then --增长无量
					HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.01)
				end
				
				if JY.Person[jqid]["防具"] == 326 and JY.Person[jqid]["内力"] >= 1500 and JY.Person[jqid]["生命"] >= JY.Person[jqid]["生命最大值"]*0.2 and WAR.JESS[jqid] == nil then --持国无敌
				    MpR = MpR - math.modf(JY.Person[jqid]["内力"]*0.003)
				end
			
				--先天功回血回内
				if PersonKF(jqid, 100) and WAR.JESS[jqid] == nil then
					MpR = MpR + 4
					HpR = HpR + 2
					if fx > 9 or tg == 1 then
					   MpR = MpR + 4
					end
                    if fx < -9 or tg == 1 then
					   HpR = HpR + 2
					end					
				end
				
				--丁典，神照
				if Curr_NG(jqid, 94) and match_ID(jqid, 672) and WAR.JESS[jqid] == nil then
					MpR = MpR + 3
					HpR = HpR + 3
				end
				
				--阴内或调和的枯禅, 回内30
				if Curr_NG(jqid, 186) and (fx <= 0 or tg == 1) and WAR.JESS[jqid] == nil then
					MpR = MpR + 8
					local s = 2
					if JY.Person[jqid]["天赋内功"] == 186 then
					   s = s + 2
					end
					if yin < 0 and fx <= 0 then   
                       MpR = MpR - yin * s					
					end   
				end
				
				--阳内或调和的枯禅, 回血10
				if Curr_NG(jqid, 186) and (fx >= 0 or tg == 1) and WAR.JESS[jqid] == nil then
					HpR = HpR + 4
					local s = 1
					if JY.Person[jqid]["天赋内功"] == 186 then
					   s = s + 1
					end 
					if fx >= 0 and yang > 0 then 
                       HpR = HpR + yang * s					
					end
				end
				
				if JY.Person[jqid]["地7"] == 1 and WAR.JESS[jqid] == nil then
				   MpR = MpR + 80
				end
				
				if JY.Person[jqid]["地7"] == 5 and WAR.JESS[jqid] == nil then
				   HpR = HpR + 20
				end
				
				--易筋经主运
				if Curr_NG(jqid, 108) and PersonKF(jqid, 186) and WAR.JESS[jqid] == nil then
				   --阴内或调和的枯禅, 回内30
				   if fx <= 0 and yin < 0 then
					MpR = MpR + 4
					if JY.Person[jqid]["天赋内功"] == 186 then
					   MpR = MpR + 4
					end
					end
				
				--阳内或调和的枯禅, 回血10
				    if fx >= 0 and yang > 0 then
					HpR = HpR + 2
					if JY.Person[jqid]["天赋内功"] == 186 then
					   HpR = HpR + 2
					end
					end
				end
				   
				if Curr_NG(jqid, 218) and WAR.JESS[jqid] == nil then
					HpR = HpR + 1
					MpR = MpR + 1
				end

				--八荒
				if PersonKF(jqid, 101) and JY.Person[jqid]["专1"] == 101 and WAR.JESS[jqid] == nil then
					HpR = HpR + 5
					MpR = MpR + 5
				end
				if PersonKF(jqid, 96) and JY.Person[jqid]["专1"] == 96 and WAR.JESS[jqid] == nil then
					HpR = HpR + 2
				end
				
				--我方运功时，内力低于500，停运
				if JY.Person[jqid]["主运内功"] > 0 and JY.Person[jqid]["内力"] < 500 and inteam(jqid) then
					JY.Person[jqid]["主运内功"] = 0
				end
				
				if JY.Person[jqid]["主运轻功"] > 0 and JY.Person[jqid]["内力"] < 500 and inteam(jqid) then
					JY.Person[jqid]["主运轻功"] = 0
				end
				
				--运功时，体力低于10，停运
				if JY.Person[jqid]["主运内功"] > 0 and JY.Person[jqid]["体力"] < 10 and inteam(jqid) then
					JY.Person[jqid]["主运内功"] = 0
				end
				
				if JY.Person[jqid]["主运轻功"] > 0 and JY.Person[jqid]["体力"] < 10 and inteam(jqid) then
					JY.Person[jqid]["主运轻功"] = 0
				end
					
				--我方运功耗内
				if JY.Person[jqid]["主运内功"] > 0 and inteam(jqid) and JY.Person[jqid]["主运内功"] ~= 190 and WAR.JESS[jqid] == nil then
					--主运天内
					if JY.Person[jqid]["主运内功"] == JY.Person[jqid]["天赋内功"] then
						MpR = MpR - 5 + math.modf(JY.Person[jqid]["资质"]/21)
					--非主运天内，耗10
					else
						MpR = MpR - 10 + math.modf(JY.Person[jqid]["资质"]/21)
					end
					if JY.Person[jqid]["主运内功"] == 213 then
					   MpR = MpR - 32
					end 
					if match_ID(jqid, 682) and JY.Person[682]["天4"] == 1 then
					   MpR = MpR - 10*(NeiNum(jqid)-1)
					end
				end
				--托奇
				if match_ID(jqid, 686) and WAR.XLT[jqid] == nil and WAR.JESS[jqid] == nil then
				   HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.01)
				end
				
				if PersonKF(jqid, 100) and JY.Person[jqid]["专1"] == 100 and WAR.JESS[jqid] == nil then
				   HpR = HpR + 2
				   MpR = MpR + 4
				   SpR = SpR + 1	  
	            end
				
				if MoDao() and WAR.JESS[jqid] == nil and WAR.JESS[jqid] == nil then
				   for e = 0, WAR.PersonNum-1 do
				       if match_ID(WAR.Person[e]["人物编号"], 691) and WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] ~= WAR.Person[e]["我方"] then
					      if WAR.LXZT[jqid] == nil then
						     WAR.LXZT[jqid] = 2
						  else 
						     WAR.LXZT[jqid] = WAR.LXZT[jqid] + 2
						  end
						  if WAR.LXZT[jqid] > 100 then
						     WAR.LXZT[jqid] = 100
						  end
						  if WAR.LXZT[jqid] ~= nil then
						     HpR = HpR - 2
						  end	 
					   end
				   end
				end
				
				if Azhu() and not inteam(jqid) and WAR.JESS[jqid] == nil then
				   JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] + math.random(2)
				   if JY.Person[jqid]["中毒程度"] > 100 then
				      JY.Person[jqid]["中毒程度"] = 100
				   end
				   if JY.Person[646]["天1"] == 1 then
				      HpR = HpR - math.modf(JY.Person[jqid]["中毒程度"] / 20)
				   end
				   if JY.Person[646]["阶"] >= 3 then
				      HpR = HpR - math.modf(JY.Person[jqid]["中毒程度"] / 5)
				   end
				end
				
				if match_ID(jqid, 646) and JY.Person[646]["阶"] >= 1 then
				   JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] + 5
				   if JY.Person[jqid]["中毒程度"] > 100 then
				      JY.Person[jqid]["中毒程度"] = 100
				   end
				end
				
				if ZhangJ() and JY.Person[694]["天1"] == 1 and not inteam(jqid) and WAR.JESS[jqid] == nil then
				   JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] + 1
				   if JY.Person[jqid]["中毒程度"] > 100 then
				      JY.Person[jqid]["中毒程度"] = 100
				   end
				   JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] + 1
				   if JY.Person[jqid]["受伤程度"] > 100 then
				      JY.Person[jqid]["受伤程度"] = 100
				   end
				   JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] + 1
				   if JY.Person[jqid]["冰封程度"] > 100 then
				      JY.Person[jqid]["冰封程度"] = 100
				   end
				   JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] + 1
				   if JY.Person[jqid]["灼烧程度"] > 50 then
				      JY.Person[jqid]["灼烧程度"] = 50
				   end
				   if WAR.LXZT[jqid] ~= nil then
				      WAR.LXZT[jqid] = WAR.LXZT[jqid] + 1
					  if WAR.LXZT[jqid] > 100 then
					     WAR.LXZT[jqid] = 100
					  end
				   else
				      WAR.LXZT[jqid] = 1
				   end
				end
				
				if JY.Person[0]["阶"] >= 2 and JY.Base["标准"] == 9 and not inteam(jqid) and WAR.JESS[jqid] == nil then
				   JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] + 3
				   if JY.Person[jqid]["中毒程度"] > 100 then
				      JY.Person[jqid]["中毒程度"] = 100
				   end
				end
				
				if Bwj1() and not inteam(jqid) and WAR.JESS[jqid] == nil then
				   JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] + 5
				   if JY.Person[jqid]["冰封程度"] > 100 then
				      JY.Person[jqid]["冰封程度"] = 100
				   end
				end
				
				if Bwj2() and inteam(jqid) and WAR.JESS[jqid] == nil then
				   JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] + 5
				   if JY.Person[jqid]["冰封程度"] > 100 then
				      JY.Person[jqid]["冰封程度"] = 100
				   end
				end
				
				if BeiM(jqid) and WAR.JESS[jqid] == nil then
				    for a = 0, WAR.PersonNum - 1 do
				       local bid=WAR.Person[a]["人物编号"]
					   if WAR.Person[a]["死亡"] == false and JY.Person[bid]["内力"] > 0 and not inteam(bid) then
					      JY.Person[bid]["内力"] = JY.Person[bid]["内力"] - math.ceil(JY.Person[jqid]["内力最大值"]*0.01)
						  MpR = MpR + math.ceil(JY.Person[jqid]["内力最大值"]*0.01)
					   elseif JY.Person[bid]["内力"] == 0 then
					      JY.Person[bid]["生命"] = JY.Person[bid]["生命"] - 10
						  
						  if JY.Person[bid]["生命"] > 10 then
						     HpR = HpR + 10
						  end 
						  
						  if JY.Person[bid]["生命"] < 1 then
						     JY.Person[bid]["生命"] = 1
						  end 
					   end
				    end
				end
				
				if match_ID(jqid, 117) and JY.Person[117]["阶"] >= 1 and WAR.JESS[jqid] == nil then
				   HpR = HpR + 6
				   MpR = MpR + 8
				   SpR = SpR + 1
				end
				
				if WAR.GSG[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   if WAR.LXZT[jqid] ~= nil then
				      WAR.LXZT[jqid] = WAR.LXZT[jqid] + 2
					  if WAR.LXZT[jqid] > 100 then
					     WAR.LXZT[jqid] = 100
					  end
				   else
				      WAR.LXZT[jqid] = 2
				   end
				end

				--每时序回复1点流血
				if WAR.LXZT[jqid] ~= nil and WAR.JESS[jqid] == nil then
				local dam = math.modf(JY.Person[jqid]["受伤程度"] / 50) + 2
					   
                       if XueHe() then
					   dam = dam*5
					   end
				       if XueDao2() then
				       dam = dam + 5
					       if JY.Person[97]["阶"] >= 3 then
					          dam = dam*2
					       end
				       end
					   if match_ID(jqid, 97) and JY.Person[97]["阶"] >= 1 then
					      dam = 0
					   end
					   HpR = HpR - dam
					
					WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
					
					--主运乾坤，罗汉额外恢复流血
					if Curr_NG(jqid, 97) or Curr_NG(jqid, 96) then
						WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
					end
					
					--易筋经 额外恢复流血
					if PersonKF(jqid, 108) then
						WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
					end
					
					if WAR.LXZT[jqid] < 1 then
						WAR.LXZT[jqid] = nil
					end
				end
				if JY.Person[97]["阶"] >= 2 then
				      
				       for a = 0, WAR.PersonNum - 1 do
				       local lxid=WAR.Person[a]["人物编号"]
					   if WAR.Person[a]["死亡"] == false and WAR.LXZT[lxid] ~= nil and not match_ID(lxid, 97) then
					   local dam = math.modf(JY.Person[lxid]["受伤程度"] / 50) + 2					   
                       if XueHe() then
					   dam = dam*5
					   end
				       if XueDao2() then
				       dam = dam + 5
					       if JY.Person[97]["阶"] >= 3 then
					          dam = dam*2
					       end
				       end
					   if JY.Person[lxid]["生命"] <= 1 then
					      dam = 0
					   end
				           if match_ID(jqid, 97) then
					          HpR = HpR + dam
					       end
				       end
				    end
				end	
				--寒冰之墙
				if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"],6) == 5 and (not match_ID(jqid, 689) and jqid ~= 690) and WAR.JESS[jqid] == nil then
				   HpR = HpR - (5+JY.Person[689]["天1"]*3)
				end
				--中毒状态
				if JY.Person[jqid]["中毒程度"] > 0 and WAR.JESS[jqid] == nil and JY.Base["标准"] ~= 9 then
				    HpR = HpR - math.modf(JY.Person[jqid]["中毒程度"]*0.03)
					if WAR.SDD[jqid] == nil then--可以解毒
					if JY.Person[jqid]["内力"] > 2000 then
					local t = math.modf(JY.Person[jqid]["内力"]/1000)
					   if t > 6 then
					      t = 6
					   end
					   if math.random(9-t) == 1 then
					      JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 1
					   end
					end
					--程灵素
					if match_ID(jqid, 2) then
					   JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - JY.Person[2]["阶"]*5
					end
					--ren23
					if JY.Person[jqid]["人23"] == 1 then
				       JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 3
				    end
					--纯阳，九阳，逆运，易筋经，每时序回复1点中毒
				    if Curr_NG(jqid, 99) or Curr_NG(jqid, 106) or Curr_NG(jqid, 104) or PersonKF(jqid, 108) then	
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 1
				    end
				
				    --任盈盈，每时序回复5点中毒
				    if match_ID(jqid,73) then	
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 5
				    end
					end
				end
				
				
				if match_ID(jqid, 634) and JY.Person[634]["天2"] == 2 and WAR.JESS[jqid] == nil then
				   HpR = HpR + math.modf(JY.Person[jqid]["生命最大值"]*0.005)
				end
				if match_ID(jqid, 634) and JY.Person[634]["天2"] == 1 and WAR.JESS[jqid] == nil then
				   MpR = MpR + 15
				end
				
				if JY.Person[jqid]["防具"] == 368 then
				      if WAR.Siphon[jqid] == nil then
					     WAR.Siphon[jqid] = 5
					  else
					     WAR.Siphon[jqid] = WAR.Siphon[jqid] + math.ceil((1000-WAR.Siphon[jqid])*0.005)
						 if WAR.Siphon[jqid] > 1000 then
						    WAR.Siphon[jqid] = 1000
						 end 	
					  end
				end
				
				if match_ID(jqid, 689) and WAR.JESS[jqid] == nil then
				   HpR = HpR + 2*(1.6^JY.Person[689]["天1"])
				   MpR = MpR + JY.Person[689]["天2"]*5
				   if JY.Person[690]["天2"] == 1 then
				      if WAR.Siphon[jqid] == nil then
					     WAR.Siphon[jqid] = 10
					  else
					     WAR.Siphon[jqid] = WAR.Siphon[jqid] + math.ceil((1000-WAR.Siphon[jqid])*0.0065)
						 if WAR.Siphon[jqid] > 1000 then
						    WAR.Siphon[jqid] = 1000
						 end 	
					  end
				   end
				   if JY.Person[689]["声望"] == 2 then
				      HpR = HpR + math.modf((JY.Person[jqid]["生命最大值"]-JY.Person[jqid]["生命"])*0.008)
				      MpR = MpR + math.modf((JY.Person[jqid]["内力最大值"]-JY.Person[jqid]["内力"])*0.008)
				   end
				end
				
				--每时序回复1点冰封
				if JY.Person[jqid]["冰封程度"] > 0 and WAR.JESS[jqid] == nil then
					--每时序-5内
					MpR = MpR - 3 - math.modf(JY.Person[jqid]["冰封程度"]/7)
					

					JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 1
					
					--主运纯阳，九阳额外恢复冰封
					if Curr_NG(jqid, 99) or Curr_NG(jqid, 106) then
						JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 1
					end
					
					--易筋经 额外额外恢复冰封
					if PersonKF(jqid, 108) then
						JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 1
					end					
					if JY.Person[jqid]["冰封程度"] < 0 then
						JY.Person[jqid]["冰封程度"] = 0
					end
					   
				end	
				
				if WAR.GGG[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] + 2
				   if JY.Person[jqid]["灼烧程度"] > 50 then
					  JY.Person[jqid]["灼烧程度"] = 50
					end
				end
				
				if WAR.GNQG[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] + 3
				   if JY.Person[jqid]["灼烧程度"] > 100 then
					  JY.Person[jqid]["灼烧程度"] = 100
					end
				end
				
				if JY.Person[jqid]["地5"] == 5 and WAR.JESS[jqid] == nil then
	                   JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] + math.random(5) + 3
					   if JY.Person[jqid]["灼烧程度"] > 50 then
					      JY.Person[jqid]["灼烧程度"] = 50
					   end	  
					   JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + 1
	            end
				
				--每时序回复1点灼烧
				if JY.Person[jqid]["灼烧程度"] > 0 and WAR.JESS[jqid] == nil then
					JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
					
					--主运九阴额外恢复灼烧
					if Curr_NG(jqid, 107) then
						JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
					end
					
					--枯荣额外恢复灼烧
					if match_ID(jqid, 102) then
						JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
					end
					
					--易筋经 额外恢复灼烧
					if PersonKF(jqid, 108) then
						JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
					end
					
					--寒冰真气
					if PersonKF(jqid, 207) then
						JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 2
					end
					
					if JY.Person[jqid]["灼烧程度"] < 0 then
						JY.Person[jqid]["灼烧程度"] = 0
					end
				end
				
				--无酒不欢：时序回复内伤的设定
				if JY.Person[jqid]["受伤程度"] > 0 and WAR.JESS[jqid] == nil then
					--3时序回1内伤的判定
					--紫霞，逆运，九阴，金刚，九阳，化功，吸星，北冥，太玄，玉女心经，瑜伽密乘，混元，葵花
					if Curr_NG(jqid, 89) or Curr_NG(jqid, 144) or Curr_NG(jqid, 106) 
					or Curr_NG(jqid, 87) or Curr_NG(jqid, 88) or Curr_NG(jqid, 85) or Curr_NG(jqid, 102)
					or Curr_NG(jqid, 154) or Curr_NG(jqid, 169) or Curr_NG(jqid, 90) or Curr_NG(jqid, 105) then
						if WAR.SSX_Counter == 3 then
							JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
						end
					end					
					if Curr_NG(jqid, 107) then
						if WAR.SSX_Counter == 3 then
							JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
						end
					end					
					if Curr_NG(jqid, 104) then
						if WAR.SSX_Counter == 3 then
							JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
						end
					end

					--5时序回1内伤的判定
					--圣火，八荒，先天，蛤蟆，龙象，小无，血河
					if Curr_NG(jqid, 93) or Curr_NG(jqid, 101) or Curr_NG(jqid, 100) 
					or Curr_NG(jqid, 95) or Curr_NG(jqid, 103) or Curr_NG(jqid, 98) or Curr_NG(jqid, 163) then
						if WAR.WSX_Counter == 5 then
							JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
						end
					end
					
					--主运天赋内功，5时序额外回1内伤
					if JY.Person[jqid]["主运内功"] ~= 0 and JY.Person[jqid]["主运内功"] == JY.Person[jqid]["天赋内功"] then
						if WAR.WSX_Counter == 5 then
							JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
						end
					end
					
					--主运三神功内伤大于50时，额外回复
					if JY.Person[jqid]["受伤程度"] > 50 and (Curr_NG(jqid, 106) or Curr_NG(jqid, 107)) then
						if WAR.SSX_Counter == 3 then
							JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
						end
					end
					
					--易筋经，每时序恢复1点内伤
					if PersonKF(jqid, 108) and WAR.JESS[jqid] == nil then
						JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
					end
				end
				
				
					
				--回复体力
				if JY.Person[jqid]["体力"] < 100 and WAR.JESS[jqid] == nil then
					--被动混元，3时序回1体力
					if PersonKF(jqid, 90) then
						if WAR.SSX_Counter == 3 then
							JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + 1
						end
					end
					--主运九阴，逆运，6时序回1体力
					if Curr_NG(jqid, 107) then
						if WAR.LSX_Counter == 6 then
							JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + 1
						end
					end
					if Curr_NG(jqid, 104) then
						if WAR.LSX_Counter == 6 then
							JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + 1
						end
					end
				end
				
				
				
				--我方运轻功耗体
				if JY.Person[jqid]["主运轻功"] > 0 and inteam(jqid) and WAR.JESS[jqid] == nil and JY.Person[jqid]["主运轻功"]~=191 then
					--天轻
					if JY.Person[jqid]["主运轻功"] == JY.Person[jqid]["天赋轻功"] then
						--每10时序耗1体力
							if WAR.JSX_Counter == 20 then
								JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] - 1
							end
					--非天轻，每5时序耗1体力
					else
						if WAR.LSX_Counter == 10 then
							JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] - 1
						end
					end
				end
				
				if JY.Person[jqid]["主运内功"] > 0 and inteam(jqid) and WAR.JESS[jqid] == nil and JY.Person[jqid]["主运内功"]~=190 then
					--[[天内
					if JY.Person[jqid]["主运内功"] == JY.Person[jqid]["天赋内功"] then
						--每20时序耗1体力
							if WAR.JSX_Counter == 20 then
								SpR = SpR - 1
							end]]
					--非天内，每10时序耗1体力
					--else
						if WAR.LSX_Counter == 20 then
							JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] - 1
						end
					--end
				end
				
				--阿紫曼珠沙华，每时序掉1%血
				if match_ID(jqid, 47) and WAR.JYZT[jqid]~=nil and WAR.JESS[jqid] == nil then
					HpR = HpR - math.modf(JY.Person[jqid]["生命最大值"]*0.01)
				end
				
				--引燃：每时序损失2%当前血量
				if WAR.JHLY[jqid] ~= nil and WAR.JESS[jqid] == nil then
					HpR = HpR - math.modf(JY.Person[jqid]["生命"]*0.02)

					WAR.JHLY[jqid] = WAR.JHLY[jqid] - 1
					
					if WAR.JHLY[jqid] < 1 then
						WAR.JHLY[jqid] = nil
					end
				end
				
				--狂犬病
				if WAR.KQB[jqid] ~= nil and WAR.JESS[jqid] == nil then
					HpR = HpR - WAR.KQB[jqid]
					MpR = MpR - WAR.KQB[jqid]
				end
				--爆裂掌
				if WAR.BLZ[jqid] ~= nil and WAR.JESS[jqid] == nil then
					HpR = HpR - 1
				end
				
				--七伤拳，肺 减速
				if WAR.QSQ[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.QSQ[jqid] = WAR.QSQ[jqid] - 1
					if WAR.QSQ[jqid] < 1 then
						WAR.QSQ[jqid] = nil
					end
				end
				
				--无影神拳
				if WAR.WYSQ[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.WYSQ[jqid] = WAR.WYSQ[jqid] - 1
					if WAR.WYSQ[jqid] < 1 then
						WAR.WYSQ[jqid] = nil
					end
				end
				if WAR.HBZQJS[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.HBZQJS[jqid] = WAR.HBZQJS[jqid] - 1
					if WAR.HBZQJS[jqid] < 1 then
						WAR.HBZQJS[jqid] = nil
						WAR.HBZQDJ[jqid] = nil
					end
				end
				if WAR.JSLQ[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.JSLQ[jqid] = WAR.JSLQ[jqid] - 1
					if WAR.JSLQ[jqid] < 1 then
						WAR.JSLQ[jqid] = nil
					end
				end
				if WAR.YLMB[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.YLMB[jqid] = WAR.YLMB[jqid] - 1
					if WAR.YLMB[jqid] < 1 then
						WAR.YLMB[jqid] = nil
					end
				end
				if WAR.LDXJ[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LDXJ[jqid] = WAR.LDXJ[jqid] - 1
					if WAR.LDXJ[jqid] < 1 then
						WAR.LDXJ[jqid] = nil
					end
				end
				if WAR.SWKY[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.SWKY[jqid] = WAR.SWKY[jqid] - 1
					if WAR.SWKY[jqid] < 1 then
						WAR.SWKY[jqid] = nil
						JY.Person[jqid]["生命"] = 0
					end
				end
				--小灵通
				if WAR.XLT[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   HpR = HpR + math.modf((JY.Person[jqid]["生命最大值"]-JY.Person[jqid]["生命"])*0.01)
					WAR.XLT[jqid] = WAR.XLT[jqid] - 1
					if WAR.XLT[jqid] < 1 then
						WAR.XLT[jqid] = nil
					end
				end
				if WAR.SHK[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.SHK[jqid] = WAR.SHK[jqid] - 1
					if WAR.SHK[jqid] < 1 then
						WAR.SHK[jqid] = nil
					end
				end
				
				if WAR.KXS[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.KXS[jqid] = WAR.KXS[jqid] - 1
					if WAR.KXS[jqid] < 1 then
						WAR.KXS[jqid] = nil
						WAR.Person[i]["我方"] = false
					end
				end
				
				--回转有道
				if WAR.YYXS[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.YYXS[jqid] = WAR.YYXS[jqid] - 1
					if WAR.YYXS[jqid] < 1 then
						WAR.YYXS[jqid] = nil
					end
				end
				
				--龙翔九天
				if WAR.QJJB[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.QJJB[jqid] = WAR.QJJB[jqid] - 1
					if WAR.QJJB[jqid] < 1 then
						WAR.QJJB[jqid] = nil
					end
				end
				
				if WAR.QNFJ[jqid] ~= nil and WAR.JESS[jqid] == nil then
				    if JY.Person[jqid]["防具"] == 355 then
					WAR.QNFJ[jqid] = WAR.QNFJ[jqid] + 1
					if WAR.QNFJ[jqid] > 100 then
						WAR.QNFJ[jqid] = 1
					end
					else
					    WAR.QNFJ[jqid] = nil
					end	
				end
				
				--杀意波动
				if WAR.SYBD[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.SYBD[jqid] = WAR.SYBD[jqid] - 1
					if WAR.SYBD[jqid] < 1 then
						WAR.SYBD[jqid] = nil
						if jqid == 0 then
						PlayMIDI(math.random(10)+99)
						end
					end
				end
				
				--流沙覆
				if WAR.LSF[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LSF[jqid] = WAR.LSF[jqid] - 1
					if WAR.LSF[jqid] < 1 then
						WAR.LSF[jqid] = nil
					end
				end
				--chdlw
				if WAR.HCDLW[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.HCDLW[jqid] = WAR.HCDLW[jqid] - 1
					if WAR.HCDLW[jqid] < 1 then
						WAR.HCDLW[jqid] = nil
					end
				end
				--魔心渡
				if WAR.MXD[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.MXD[jqid] = WAR.MXD[jqid] - 1
					MpR = MpR - 100
					if WAR.MXD[jqid] < 1 then
						WAR.MXD[jqid] = nil
					end
				end
				
				--碧落九重剑：重 减速
				if WAR.LZ_Z[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LZ_Z[jqid] = WAR.LZ_Z[jqid] - 1
					if WAR.LZ_Z[jqid] < 1 then
						WAR.LZ_Z[jqid] = nil
					end
				end
				
				if WAR.LZ_S[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LZ_S[jqid] = WAR.LZ_S[jqid] - 1
					if WAR.LZ_S[jqid] < 1 then
						WAR.LZ_S[jqid] = nil
					end
				end
				
				if WAR.LZ_H[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LZ_H[jqid] = WAR.LZ_H[jqid] - 1
					if WAR.LZ_H[jqid] < 1 then
						WAR.LZ_H[jqid] = nil
						if WAR.LZ_HH[jqid] ~= nil then
						   JY.Person[jqid]["主运轻功"] = WAR.LZ_HH[jqid]
						   WAR.LZ_HH[jqid] = nil
						end
					end
				end
				
				if WAR.LZ_L[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LZ_L[jqid] = WAR.LZ_L[jqid] - 1
					if WAR.LZ_L[jqid] < 1 then
						WAR.LZ_L[jqid] = nil
					end
				end
				if WAR.CZSB[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.CZSB[jqid] = WAR.CZSB[jqid] - 1
					if WAR.CZSB[jqid] < 1 then
						WAR.CZSB[jqid] = nil
					end
				end
				
				
				if WAR.LZ_D[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LZ_D[jqid] = WAR.LZ_D[jqid] - 1
					if WAR.LZ_D[jqid] < 1 then
						WAR.LZ_D[jqid] = nil
					end
				end
				
				if WAR.ZWZX[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.ZWZX[jqid] = WAR.ZWZX[jqid] - 1
					if WAR.ZWZX[jqid] < 1 then
						WAR.ZWZX[jqid] = nil
					end
				end

				--灭绝的玉石俱焚，100时序
				if WAR.YSJF[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.YSJF[jqid] = WAR.YSJF[jqid] - 1
					
					if WAR.YSJF[jqid] < 1 then
						WAR.YSJF[jqid] = nil
					end
				end
				
				--霍青桐固若金汤，100时序
				if WAR.HQT_GRJT and WAR.HQT_GRJT[jqid] and WAR.JESS[jqid] == nil then
					WAR.HQT_GRJT[jqid] = WAR.HQT_GRJT[jqid] - 1
					if WAR.HQT_GRJT[jqid] < 1 then
						WAR.HQT_GRJT[jqid] = nil
					end
				end
				
				--霍青桐军神再临，100时序
				if WAR.HQT_JSZL and WAR.HQT_JSZL[jqid] and WAR.JESS[jqid] == nil then
					WAR.HQT_JSZL[jqid] = WAR.HQT_JSZL[jqid] - 1
					if WAR.HQT_JSZL[jqid] < 1 then
						WAR.HQT_JSZL[jqid] = nil
					end
				end
				
				--被破军打中的敌人，内功停运50时序
				if WAR.PJZT[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.PJZT[jqid] = WAR.PJZT[jqid] - 1
					if WAR.PJZT[jqid] < 1 then
						WAR.PJZT[jqid] = nil
						JY.Person[jqid]["主运内功"] = WAR.PJJL[jqid]
						WAR.PJJL[jqid] = nil
					end
				end

				--花开花落			
				if WAR.HKHL[jqid] ~= nil and WAR.JESS[jqid] == nil then
				WAR.HKHL[jqid] = WAR.HKHL[jqid] - 1
					if WAR.HKHL[jqid] < 1 then	
					WAR.HKHL[jqid] = nil
					end
				end
				if WAR.ZJDbuff[jqid] ~= nil and WAR.JESS[jqid] == nil then
				WAR.ZJDbuff[jqid] = WAR.ZJDbuff[jqid] - 1
					if WAR.ZJDbuff[jqid] < 1 then	
					WAR.ZJDbuff[jqid] = nil
					end
				end
				if WAR.ZJbuff[jqid] ~= nil and WAR.JESS[jqid] == nil then
				WAR.ZJbuff[jqid] = WAR.ZJbuff[jqid] - 1
					if WAR.ZJbuff[jqid] < 1 then	
					WAR.ZJbuff[jqid] = nil
					end
				end
				if WAR.TQLQ[jqid] ~= nil and WAR.JESS[jqid] == nil then
				WAR.TQLQ[jqid] = WAR.TQLQ[jqid] - 1
					if WAR.TQLQ[jqid] < 1 then	
					WAR.TQLQ[jqid] = nil
					end
				end
				if WAR.TQGJ[jqid] ~= nil and WAR.JESS[jqid] == nil then
				WAR.TQGJ[jqid] = WAR.TQGJ[jqid] - 1
					if WAR.TQGJ[jqid] < 1 then	
					WAR.TQGJ[jqid] = nil
					end
				end
				if WAR.TQFY[jqid] ~= nil and WAR.JESS[jqid] == nil then
				WAR.TQFY[jqid] = WAR.TQFY[jqid] - 1
					if WAR.TQFY[jqid] < 1 then	
					WAR.TQFY[jqid] = nil
					end
				end
				
				--混乱状态，解除后，敌人状态恢复
				if WAR.HLZT[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.HLZT[jqid] = WAR.HLZT[jqid] - 1
					if WAR.HLZT[jqid] < 1 then
						WAR.HLZT[jqid] = nil
						WAR.Person[i]["我方"] = false
					end
				end
				
				--意恍惚
				if WAR.QSQ6[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.QSQ6[jqid] = WAR.QSQ6[jqid] - 1
					if WAR.QSQ6[jqid] < 1 then
						WAR.QSQ6[jqid] = nil
					end
				end
				
				--虚弱状态
				if WAR.XRZT[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.XRZT[jqid] = WAR.XRZT[jqid] - 1
					if WAR.XRZT[jqid] < 1 then
						WAR.XRZT[jqid] = nil
					end
				end
				
				if WAR.JJCD[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.JJCD[jqid]=WAR.JJCD[jqid]-1
					if WAR.JJCD[jqid] < 1 then
						WAR.JJCD[jqid] = nil
					end
				end
				
				if WAR.HGMZ[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.HGMZ[jqid] = WAR.HGMZ[jqid] - 1
					if WAR.HGMZ[jqid] < 1 then
						WAR.HGMZ[jqid] = nil
					end
				end
				
				if WAR.LSQ2[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LSQ2[jqid] = WAR.LSQ2[jqid] - 1
					if WAR.LSQ2[jqid] < 1 then
						WAR.LSQ2[jqid] = nil
					end
				end
				if WAR.LSQ3[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LSQ3[jqid] = WAR.LSQ3[jqid] - 1
					if WAR.LSQ3[jqid] < 1 then
						WAR.LSQ3[jqid] = nil
					end
				end
				
				
				
				--无酒不欢：主运蛤蟆功时序增加怒气
				if Curr_NG(jqid, 95) and WAR.JESS[jqid] == nil and match_ID(jqid, 673) == false and WAR.YYXS[jqid] == nil then
					if WAR.LQZ[jqid] == nil then
						WAR.LQZ[jqid] = 1
					elseif WAR.LQZ[jqid] < 100 then
						WAR.LQZ[jqid] = WAR.LQZ[jqid] + 1
						if WAR.LQZ[jqid] == 100 then
							--瞬息暴怒清空封穴
							if Curr_QG(jqid,150) then
								if WAR.FXDS[jqid] ~= nil then
									WAR.FXDS[jqid] = nil
									WAR.FXXS[jqid] = nil
								end
							end
							--冷却减少
			for i = 1, 4 do
			local w = JY.Person[jqid]["天赋外功"..i]
			    if WAR.KungfuLQ[jqid][w] ~= nil then
				   WAR.KungfuLQ[jqid][w] = WAR.KungfuLQ[jqid][w] - 2
				   if WAR.KungfuLQ[jqid][w] <= 0 then
				      WAR.KungfuLQ[jqid][w] = nil
				   end	  
				end
			end
			if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] ~= nil then
				   WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] - 2
				   if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] <= 0 then
				      WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = nil
				   end	  
			end
							--东方不败，葵花秘法・化凤为凰
							local s = WAR.CurID
							local say = "怒气爆发"
							local ani_num = 6
							WAR.CurID = i
							if match_ID(jqid, 27) then
								say = "葵花秘法・化凤为凰"
								ani_num = 7
							end
							if match_ID(jqid, 681) then
								say = "疯血爆发"
								ani_num = 115
							end
							if match_ID(jqid, 114) or match_ID(jqid, 652) or match_ID(jqid, 149) then
			                   ani_num  = 104
							   say = "业由心生，回转有道"
				               if WAR.FXDS[jqid] ~= nil then
					              WAR.FXDS[jqid] = nil
					              WAR.FXXS[jqid] = nil
				               end
				               WAR.LQZ[jqid] = nil
				               JY.Person[jqid]["受伤程度"] = 0
				               WAR.YYXS[jqid] = 15
							end   
							Cls()
							lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
							CurIDTXDH(WAR.CurID, ani_num, 1, say, C_RED)
							WAR.CurID = s
							--恢复之前的画面
							DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
							DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
							DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
							lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
							lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
							lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
							surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						end
					end
				end
				
				--平坦
				if (match_ID(jqid, 36) or match_ID(jqid, 48)) and WAR.JESS[jqid] == nil and WAR.YYXS[jqid] == nil then
					if WAR.LQZ[jqid] == nil then
						WAR.LQZ[jqid] = 1
					elseif WAR.LQZ[jqid] < 100 then
						WAR.LQZ[jqid] = WAR.LQZ[jqid] + 1
						if WAR.LQZ[jqid] == 100 then
							--瞬息暴怒清空封穴
							if Curr_QG(jqid,150) then
								if WAR.FXDS[jqid] ~= nil then
									WAR.FXDS[jqid] = nil
									WAR.FXXS[jqid] = nil
								end
							end
							--冷却减少
			for i = 1, 4 do
			local w = JY.Person[jqid]["天赋外功"..i]
			    if WAR.KungfuLQ[jqid][w] ~= nil then
				   WAR.KungfuLQ[jqid][w] = WAR.KungfuLQ[jqid][w] - 2
				   if WAR.KungfuLQ[jqid][w] <= 0 then
				      WAR.KungfuLQ[jqid][w] = nil
				   end	  
				end
			end
			if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] ~= nil then
				   WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] - 2
				   if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] <= 0 then
				      WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = nil
				   end	  
			end
							--东方不败，葵花秘法・化凤为凰
							local s = WAR.CurID
							local say = "怒气爆发"
							local ani_num = 6
							WAR.CurID = i
							if match_ID(jqid, 27) then
								say = "葵花秘法・化凤为凰"
								ani_num = 7
							end
							if match_ID(jqid, 681) then
								say = "疯血爆发"
								ani_num = 115
							end
							if match_ID(jqid, 114) or match_ID(jqid, 652) or match_ID(jqid, 149) then
			                   ani_num  = 104
							   say = "业由心生，回转有道"
				               if WAR.FXDS[jqid] ~= nil then
					              WAR.FXDS[jqid] = nil
					              WAR.FXXS[jqid] = nil
				               end
				               WAR.LQZ[jqid] = nil
				               JY.Person[jqid]["受伤程度"] = 0
				               WAR.YYXS[jqid] = 15
							end   
							Cls()
							lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
							CurIDTXDH(WAR.CurID, ani_num, 1, say, C_RED)
							WAR.CurID = s
							--恢复之前的画面
							DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
							DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
							DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
							lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
							lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
							lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
							surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						end
					end
				end
				
				--丁鹏
				if match_ID(jqid, 691) and JY.Person[691]["天3"] == 1 and WAR.JESS[jqid] == nil and WAR.YYXS[jqid] == nil then
					if WAR.LQZ[jqid] == nil then
						WAR.LQZ[jqid] = 2
					elseif WAR.LQZ[jqid] < 100 then
						WAR.LQZ[jqid] = WAR.LQZ[jqid] + 2
						if WAR.LQZ[jqid] > 100 then
						   WAR.LQZ[jqid] = 100
						end
						if WAR.LQZ[jqid] == 100 then
							--瞬息暴怒清空封穴
							if Curr_QG(jqid,150) then
								if WAR.FXDS[jqid] ~= nil then
									WAR.FXDS[jqid] = nil
									WAR.FXXS[jqid] = nil
								end
							end
							--冷却减少
			for i = 1, 4 do
			local w = JY.Person[jqid]["天赋外功"..i]
			    if WAR.KungfuLQ[jqid][w] ~= nil then
				   WAR.KungfuLQ[jqid][w] = WAR.KungfuLQ[jqid][w] - 2
				   if WAR.KungfuLQ[jqid][w] <= 0 then
				      WAR.KungfuLQ[jqid][w] = nil
				   end	  
				end
			end
			if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] ~= nil then
				   WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] - 2
				   if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] <= 0 then
				      WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = nil
				   end	  
			end
							--东方不败，葵花秘法・化凤为凰
							local s = WAR.CurID
							local say = "怒气爆发"
							local ani_num = 6
							WAR.CurID = i
							if match_ID(jqid, 27) then
								say = "葵花秘法・化凤为凰"
								ani_num = 7
							end
							if match_ID(jqid, 681) then
								say = "疯血爆发"
								ani_num = 115
							end
							if match_ID(jqid, 114) or match_ID(jqid, 652) or match_ID(jqid, 149) then
			                   ani_num  = 104
							   say = "业由心生，回转有道"
				               if WAR.FXDS[jqid] ~= nil then
					              WAR.FXDS[jqid] = nil
					              WAR.FXXS[jqid] = nil
				               end
				               WAR.LQZ[jqid] = nil
				               JY.Person[jqid]["受伤程度"] = 0
				               WAR.YYXS[jqid] = 15
							end   
							Cls()
							lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
							CurIDTXDH(WAR.CurID, ani_num, 1, say, C_RED)
							WAR.CurID = s
							--恢复之前的画面
							DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
							DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
							DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
							lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
							lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
							lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
							surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						end
					end
				end
				
				--rage
				if JY.Person[jqid]["地9"] == 1 and WAR.JESS[jqid] == nil and WAR.YYXS[jqid] == nil then
					if WAR.LQZ[jqid] == nil then
						WAR.LQZ[jqid] = 8
					elseif WAR.LQZ[jqid] < 100 then
						WAR.LQZ[jqid] = WAR.LQZ[jqid] + 8
						if WAR.LQZ[jqid] > 100 then
						   WAR.LQZ[jqid] = 100
						end
						if WAR.LQZ[jqid] == 100 then
							--瞬息暴怒清空封穴
							if Curr_QG(jqid,150) then
								if WAR.FXDS[jqid] ~= nil then
									WAR.FXDS[jqid] = nil
									WAR.FXXS[jqid] = nil
								end
							end
							--冷却减少
			for i = 1, 4 do
			local w = JY.Person[jqid]["天赋外功"..i]
			    if WAR.KungfuLQ[jqid][w] ~= nil then
				   WAR.KungfuLQ[jqid][w] = WAR.KungfuLQ[jqid][w] - 2
				   if WAR.KungfuLQ[jqid][w] <= 0 then
				      WAR.KungfuLQ[jqid][w] = nil
				   end	  
				end
			end
			if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] ~= nil then
				   WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] - 2
				   if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] <= 0 then
				      WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = nil
				   end	  
			end
							--东方不败，葵花秘法・化凤为凰
							local s = WAR.CurID
							local say = "怒气爆发"
							local ani_num = 6
							WAR.CurID = i
							if match_ID(jqid, 27) then
								say = "葵花秘法・化凤为凰"
								ani_num = 7
							end
							if match_ID(jqid, 681) then
								say = "疯血爆发"
								ani_num = 115
							end
							if match_ID(jqid, 114) or match_ID(jqid, 652) or match_ID(jqid, 149) then
			                   ani_num  = 104
							   say = "业由心生，回转有道"
				               if WAR.FXDS[jqid] ~= nil then
					              WAR.FXDS[jqid] = nil
					              WAR.FXXS[jqid] = nil
				               end
				               WAR.LQZ[jqid] = nil
				               JY.Person[jqid]["受伤程度"] = 0
				               WAR.YYXS[jqid] = 15
							end   
							Cls()
							lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
							CurIDTXDH(WAR.CurID, ani_num, 1, say, C_RED)
							WAR.CurID = s
							--恢复之前的画面
							DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
							DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
							DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
							lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
							lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
							lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
							surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						end
					end
				end
				
				--世仇未报时序增加怒气
				if jqid == 0 and JY.Person[0]["天2"] == 1 and WAR.JESS[jqid] == nil and WAR.YYXS[jqid] == nil then
					if WAR.LQZ[jqid] == nil then
						WAR.LQZ[jqid] = 1
					elseif WAR.LQZ[jqid] < 100 then
					    if math.random(3) > 1 then
						WAR.LQZ[jqid] = WAR.LQZ[jqid] + 1
						end
						if WAR.LQZ[jqid] == 100 then
							--瞬息暴怒清空封穴
							if Curr_QG(jqid,150) then
								if WAR.FXDS[jqid] ~= nil then
									WAR.FXDS[jqid] = nil
									WAR.FXXS[jqid] = nil
								end
							end
							--冷却减少
			for i = 1, 4 do
			local w = JY.Person[jqid]["天赋外功"..i]
			    if WAR.KungfuLQ[jqid][w] ~= nil then
				   WAR.KungfuLQ[jqid][w] = WAR.KungfuLQ[jqid][w] - 2
				   if WAR.KungfuLQ[jqid][w] <= 0 then
				      WAR.KungfuLQ[jqid][w] = nil
				   end	  
				end
			end
			if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] ~= nil then
				   WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] - 2
				   if WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] <= 0 then
				      WAR.KungfuLQ[jqid][JY.Person[jqid]["天赋内功"]] = nil
				   end	  
			end
							--东方不败，葵花秘法・化凤为凰
							local s = WAR.CurID
							local say = "怒气爆发"
							local ani_num = 6
							WAR.CurID = i
							if match_ID(jqid, 27) then
								say = "葵花秘法・化凤为凰"
								ani_num = 7
							end
							if match_ID(jqid, 681) then
								say = "疯血爆发"
								ani_num = 115
							end
							if match_ID(jqid, 114) or match_ID(jqid, 652) or match_ID(jqid, 149) then
			                   ani_num  = 104
							   say = "业由心生，回转有道"
				               if WAR.FXDS[jqid] ~= nil then
					              WAR.FXDS[jqid] = nil
					              WAR.FXXS[jqid] = nil
				               end
				               WAR.LQZ[jqid] = nil
				               JY.Person[jqid]["受伤程度"] = 0
				               WAR.YYXS[jqid] = 15
							end   
							Cls()
							lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
							CurIDTXDH(WAR.CurID, ani_num, 1, say, C_RED)
							WAR.CurID = s
							--恢复之前的画面
							DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
							DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
							DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
							lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
							lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
							lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
							surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						end
					end
				end
				
				--无酒不欢：怒发冲冠
				if JY.Base["特殊"] ==1 and JY.Person[39]["血量翻倍"]==1 and jqid==0 and WAR.JESS[jqid] == nil then
					if WAR.LQZ[jqid] == nil then
						WAR.LQZ[jqid] = 1
					elseif WAR.LQZ[jqid] < 100 then
						WAR.LQZ[jqid] = WAR.LQZ[jqid] + 2
						if WAR.LQZ[jqid] >= 100 then
							WAR.LQZ[jqid] = 100
							--瞬息暴怒清空封穴
							if Curr_QG(jqid,150) then
								if WAR.FXDS[jqid] ~= nil then
									WAR.FXDS[jqid] = nil
									WAR.FXXS[jqid] = nil
								end
							end
							local s = WAR.CurID
							WAR.CurID = i
							Cls()
							lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
							CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
							WAR.CurID = s
							--恢复之前的画面
							DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
							DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
							DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
							lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
							lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
							lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
							surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						end
					end
				end


				--天山童姥：转瞬红颜
				if match_ID(jqid, 117) and  WAR.ZDDH ~= 202 and WAR.JESS[jqid] == nil then
					if WAR.ZSHY[jqid] == nil then
						WAR.ZSHY[jqid] = 1
					else
						WAR.ZSHY[jqid] = WAR.ZSHY[jqid] + 1
					end
					if WAR.ZSHY[jqid] == 100 then
						WAR.ZSHY[jqid] = nil
						local s = WAR.CurID
						WAR.CurID = i
						Cls()
						lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
						CurIDTXDH(WAR.CurID, 104, 1, "红颜弹指老・刹那芳华", PinkRed)
						WAR.CurID = s
						--恢复之前的画面
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						JY.Person[jqid]["生命"] = JY.Person[jqid]["生命最大值"]
						JY.Person[jqid]["内力"] = JY.Person[jqid]["内力最大值"]
						SpR = 100
						JY.Person[jqid]["中毒程度"] = 0
						JY.Person[jqid]["受伤程度"] = 0
						JY.Person[jqid]["冰封程度"] = 0
						JY.Person[jqid]["灼烧程度"] = 0
						--流血
						if WAR.LXZT[jqid] ~= nil then
							WAR.LXZT[jqid] = nil
						end
						--封穴
						if WAR.FXDS[jqid] ~= nil then
							WAR.FXDS[jqid] = nil
						end
					end
				end
				
				--葵花尊者，恢复
				if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and jqid == 27 and WAR.JESS[jqid] == nil then
					HpR = HpR + 5
					MpR = MpR + 10
					SpR = SpR + 1
					if WAR.SDD[jqid] == nil then
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 1
					end
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
					JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 1
					JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
					--流血
					if WAR.LXZT[jqid] ~= nil then
						WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
					end
					--封穴
					if WAR.FXDS[jqid] ~= nil then
						WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
					end
				end
				
				--金轮国师十层龙象
				if (((WAR.ZDDH == 275 or WAR.ZDDH == 277 or WAR.ZDDH == 278) and jqid == 62) or (match_ID(jqid, 62) and JY.Person[62]["阶"] >= 3)) and WAR.JESS[jqid] == nil then
					HpR = HpR + 10
					MpR = MpR + 10
					SpR = SpR + 10
					if WAR.SDD[jqid] == nil then
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 10
					end
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 10
					JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 10
					JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 10
					--流血
					if WAR.LXZT[jqid] ~= nil then
						WAR.LXZT[jqid] = WAR.LXZT[jqid] - 10
					end
					--封穴
					if WAR.FXDS[jqid] ~= nil then
						WAR.FXDS[jqid] = WAR.FXDS[jqid] - 10
					end
				end

				--金轮国师九层龙象				
				if WAR.ZDDH == 75 and jqid == 62 and WAR.JESS[jqid] == nil then
					HpR = HpR + 5
					MpR = MpR + 5
					SpR = SpR + 5
					if WAR.SDD[jqid] == nil then
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 5
					end
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 5
					JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 5
					JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 5
					--流血
					if WAR.LXZT[jqid] ~= nil then
						WAR.LXZT[jqid] = WAR.LXZT[jqid] - 5
					end
					--封穴
					if WAR.FXDS[jqid] ~= nil then
						WAR.FXDS[jqid] = WAR.FXDS[jqid] - 5
					end
				end
				
				if PersonKF(jqid, 90) and WAR.SFGYQ[jqid] ~= nil and WAR.JESS[jqid] == nil then	--混元功三分归元气
					HpR = HpR + 3
					MpR = MpR + 3
					SpR = SpR + 3
					if WAR.SDD[jqid] == nil then
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 3
					end
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 3
					JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 3
					JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 3
					WAR.SFGYQ[jqid] = WAR.SFGYQ[jqid] - 1
				    if WAR.SFGYQ[jqid] == 0 then
					   WAR.SFGYQ[jqid] = nil
					end
				end
					
				if PersonKF(jqid, 90) and PersonKF(jqid, 29) and WAR.QFKDP[jqid] ~= nil and WAR.JESS[jqid] == nil then	--七分靠打拼
					HpR = HpR + 7
					MpR = MpR + 7
					SpR = SpR + 7
					if WAR.SDD[jqid] == nil then
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 7
					end
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 7
					JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 7
					JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 7
					WAR.QFKDP[jqid] = WAR.QFKDP[jqid] - 1
				    if WAR.QFKDP[jqid] == 0 then
					WAR.QFKDP[jqid] = nil
					end
				end
				
				--主角医生回血内，减内伤，减中毒
				if jqid == 0 and JY.Base["标准"] == 8 and WAR.JESS[jqid] == nil then
					HpR = HpR + math.random(10)+JY.Person[jqid]["六如觉醒"]
					MpR = MpR + math.random(10)+JY.Person[jqid]["六如觉醒"]
					if WAR.SDD[jqid] == nil then
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - math.random(10)-JY.Person[jqid]["六如觉醒"]
					end
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - math.random(10)-JY.Person[jqid]["六如觉醒"]
				end
				
				if Yiliao() and inteam(jqid) then
				    HpR = HpR + 5
					if WAR.SDD[jqid] == nil then
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 5
					end
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 5
				end
				
				--雷震，地涌天泉
				if WAR.DYTQ[jqid] ~= nil and WAR.JESS[jqid] == nil then
				   HpR = HpR + math.modf(((JY.Person[jqid]["生命最大值"]-JY.Person[jqid]["生命"])*0.008)) 
				   if JY.Person[jqid]["内力最大值"] >= 9999 then
				      HpR = HpR + 10
				   end
				   if JY.Person[jqid]["防具"] == 327 then
				      HpR = HpR + math.modf(JY.Base["天书数量"]/2)
				   end
				   MpR = MpR + 2 + JY.Base["天书数量"]
				   SpR = SpR + 1
					WAR.DYTQ[jqid] = WAR.DYTQ[jqid] - 1
					if WAR.DYTQ[jqid] < 1 then
						WAR.DYTQ[jqid] = nil
					end
				end
				
				--怨忿莫名
				if WAR.YFMM[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.YFMM[jqid] = WAR.YFMM[jqid] - 1
					if WAR.YFMM[jqid] < 1 then
						WAR.YFMM[jqid] = nil
					end
				end
				
				--隐姓埋名
				if WAR.YXMM[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.YXMM[jqid] = WAR.YXMM[jqid] - 1
					if WAR.YXMM[jqid] < 1 then
						WAR.YXMM[jqid] = nil
					end
				end
				if WAR.PPWQ[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.PPWQ[jqid] = WAR.PPWQ[jqid] - 1
					if WAR.PPWQ[jqid] < 1 then
						WAR.PPWQ[jqid] = nil
					end
				end
				
				--真名神照
				if WAR.ZMSZ[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.ZMSZ[jqid] = WAR.ZMSZ[jqid] - 1
					if WAR.ZMSZ[jqid] < 1 then
						WAR.ZMSZ[jqid] = nil
					end
				end
				
				--无敌
				if WAR.WDZT[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.WDZT[jqid] = WAR.WDZT[jqid] - 1
					if WAR.WDZT[jqid] < 1 then
						WAR.WDZT[jqid] = nil
					end
				end
				
				--毒王时序增加中毒
				if jqid == 0 and JY.Base["标准"] == 9 and WAR.JESS[jqid] == nil then
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] + math.random(5+JY.Person[jqid]["六如觉醒"])
					if JY.Person[jqid]["中毒程度"] > 100 then
						JY.Person[jqid]["中毒程度"] = 100 
					end
				end
				
				--轻云蔽月时序计数
				if WAR.QYBY[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.QYBY[jqid] = WAR.QYBY[jqid] - 1	
					if WAR.QYBY[jqid] < 1 then
						WAR.QYBY[jqid] = nil
					end
				end
				if WAR.XTGQ[jqid] ~= nil then
				local m = WAR.XTGQ[jqid] - 25
				   if m ~= 1 and WAR.XTGQ[jqid] > 1 then
				      WAR.XTGQ[jqid] = WAR.XTGQ[jqid] + 1
				   elseif m == 1 then
				      WAR.XTGQ[jqid] = 1
				   end	  		   
				end
				
				if WAR.DFZR[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.DFZR[jqid] = WAR.DFZR[jqid] - 1	
					if WAR.DFZR[jqid] < 1 then
						WAR.DFZR[jqid] = nil
					end
				end
		
				--进阶泰山，使用后30时序内闪避
				if WAR.TSSB[jqid] ~= nil and WAR.JESS[jqid] == nil then
				    if match_ID(jqid, 23) and JY.Person[23]["阶"] >= 2 then
					else
					WAR.TSSB[jqid] = WAR.TSSB[jqid] - 1
					end
					if WAR.TSSB[jqid] < 1 then
						WAR.TSSB[jqid] = nil
					end
				end
				if WAR.TSSJ[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.TSSJ[jqid] = WAR.TSSJ[jqid] - 1
					if WAR.TSSJ[jqid] < 1 then
						WAR.TSSJ[jqid] = nil
					end
				end
				if WAR.YWSS[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.YWSS[jqid] = WAR.YWSS[jqid] - 1
					if WAR.YWSS[jqid] < 1 then
						WAR.YWSS[jqid] = nil
					end
				end
				
				--南山刀法，使用后10时序内不动如山
				if WAR.NSDF[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.NSDF[jqid] = WAR.NSDF[jqid] - 1
					if WAR.NSDF[jqid] < 1 then
						WAR.NSDF[jqid] = nil
					end
				end
				
				--螺旋九影・破
				if WAR.LXJY_P[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.LXJY_P[jqid] = WAR.LXJY_P[jqid] - 1
					if WAR.LXJY_P[jqid] < 1 then
						WAR.LXJY_P[jqid] = nil
					end
				end
				
				--无明业火状态，耗损使用的内力一半的生命，30时序
				if WAR.WMYH[jqid] ~= nil and WAR.JESS[jqid] == nil then
					WAR.WMYH[jqid] = WAR.WMYH[jqid] - 1
					if WAR.WMYH[jqid] < 1 then
						WAR.WMYH[jqid] = nil
					end
				end
				
				--张家辉的隐身戒指
				if WAR.YSJZ ~= 0 then
					WAR.YSJZ = WAR.YSJZ - 1
				end
		
				--蓝烟清：王难姑指令，按时序中毒
				if WAR.L_WNGZL[jqid] ~= nil and WAR.L_WNGZL[jqid] > 0 and WAR.JESS[jqid] == nil then
					JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] + 1
					WAR.L_WNGZL[jqid] = WAR.L_WNGZL[jqid] -1;
						
					if WAR.L_WNGZL[jqid] <= 0 then
						WAR.L_WNGZL[jqid] = nil;
					end
				end
					
				--brolycjw：胡青牛指令，每个时序回复1%血
				if WAR.L_HQNZL[jqid] ~= nil and WAR.L_HQNZL[jqid] > 0 and WAR.JESS[jqid] == nil then
					HpR = HpR + math.modf(JY.Person[jqid]["生命最大值"]/100);
					if JY.Person[jqid]["受伤程度"] > 50 then
						JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 2;
					else
						JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1;
					end
					WAR.L_HQNZL[jqid] = WAR.L_HQNZL[jqid] -1;
					if WAR.L_HQNZL[jqid] <= 0 then
						WAR.L_HQNZL[jqid] = nil;
					end
				end
				--生命===================================
				--冰封
				if JY.Person[jqid]["冰封程度"] >= 50 then
				   HpR = HpR*0.7
				end
				if Curr_NG(jqid, 163) then
				   HpR = HpR*1.5
				end
				if HpR < 0 then
				   if Curr_NG(jqid, 90) then
				      HpR = HpR*0.8
				   end
				   if PersonKF(jqid, 97) then
				      HpR = HpR*0.9
				   end
				   --化骨绵掌
				   if WAR.HGMZ[jqid] ~= nil then
				      HpR = HpR*1.3
				   end				
				   --魔刀
				   if WAR.MDLX[jqid] ~= nil then
				      HpR = HpR*1.5
				   end
				   if WAR.JHLY[jqid] ~= nil then
				      HpR = HpR*1.2
				   end
				   --流血
				   if WAR.LXZT[jqid] ~= nil then
					  HpR = HpR*1.05
				   end
				   --内伤
				   if JY.Person[jqid]["受伤程度"] > 70 then
					  HpR = HpR*1.3
				   elseif JY.Person[jqid]["受伤程度"] > 35 then
					  HpR = HpR*1.15
				   end
				end
				-----------
				if HpR > 0 then
				if Curr_NG(jqid, 94) then
				   HpR = HpR*2.5
				end
				if JY.Person[jqid]["洗髓"] == 100 then
				   HpR = HpR*1.1
				end
				if Curr_NG(jqid, 90) then
				   HpR = HpR*1.2
				end
				if Curr_NG(jqid, 108) then
				   HpR = HpR*1.25
				end
				if PersonKF(jqid, 97) then
				   HpR = HpR*1.1
				end
				   
				if Curr_NG(jqid, 96) then
				   HpR = HpR*1.2
				end
				
				--地狱铁拳
				if WAR.DYTQ[jqid] ~= nil then
				   HpR = HpR*1.2
				end
				if Curr_NG(jqid, 100) then
				   HpR = HpR*1.6
				end
				if PersonKF(jqid, 107) then
				   HpR = HpR*1.07
				end
				if JY.Person[jqid]["防具"] == 367 then
				   HpR = HpR*1.5
				end
				if JY.Person[jqid]["动物"] == 262 then
				   HpR = HpR*1.1
				end
				if JY.Person[jqid]["地4"] == 7 then
				   HpR = HpR*2
				end
				HpR = HpR*(1-yin*0.01)
				if XueDao() then
				   if not match_ID(jqid, 97) then
				      HpR = 0
				   end
				end
				if WAR.LZ_S[jqid] ~= nil then
				   HpR = 0
				end
				
				--聂风
				if WAR.ZWZX[jqid] ~= nil then
				   HpR = HpR*0.4
				end
				--昏迷
				if WAR.HMZT[jqid] ~= nil then
				   HpR = HpR*0.6
				end
				if WAR.BLZ[jqid] ~= nil then
				   HpR = HpR*0.7
				end
				--无影神拳！
				if WAR.WYSQ[jqid] ~= nil then
				   HpR = HpR*0.3
				end
				
				if WAR.JHLY[jqid] ~= nil then
				   HpR = HpR*0.6
				end
				--中毒-
				if JY.Person[jqid]["中毒程度"] > 70 then
				   HpR = HpR*0.7
				elseif JY.Person[jqid]["受伤程度"] > 35 then
					HpR = HpR*0.9
				end
				--灼烧
				if JY.Person[jqid]["灼烧程度"] >= 0 then
				   HpR = HpR*0.9
				end
				--内伤
				if JY.Person[jqid]["受伤程度"] > 70 then
					HpR = HpR*0.5
				elseif JY.Person[jqid]["受伤程度"] > 35 then
					HpR = HpR*0.8
				end
				
				end
				
				
				--内力=================================
				if MpR < 0 then
				   if JY.Person[jqid]["冰封程度"] >= 50 then
					MpR = MpR*1.3
				   elseif JY.Person[jqid]["冰封程度"] > 0 then
					MpR = MpR*1.15
				   end
				end
				
				
				if MpR > 0 then

				--封穴
				if WAR.FXDS[jqid] ~= nil then
				   MpR = MpR*0.5
				end
				if JY.Person[jqid]["地4"] == 7 then
				   MpR = MpR*2
				end
				MpR = MpR*(1+yang*0.01)

				--地狱铁拳
				if WAR.DYTQ[jqid] ~= nil then
				   MpR = MpR*1.2
				end
				if JY.Person[jqid]["动物"] == 347 then
				   MpR = MpR*1.2
				end
				if PersonKF(jqid, 106) then
				   MpR = MpR*1.1
				end
				if PersonKF(jqid, 99) then
				   MpR = MpR*1.1
				end
				if JY.Person[jqid]["洗髓"] == 100 then
				   MpR = MpR*1.1
				end
				
				if WAR.ZWZX[jqid] ~= nil then
				   MpR = MpR*0.4
				end
				if WAR.LRHF[jqid] ~= nil then
				   MpR = MpR*0.4
				end
				
				
				if JY.Person[jqid]["冰封程度"] >= 50 then
					MpR = MpR*0.3
				elseif JY.Person[jqid]["冰封程度"] > 0 then
					MpR = MpR*0.6
				end
				--中毒-
				if JY.Person[jqid]["中毒程度"] > 70 then
				   MpR = MpR*0.7
				elseif JY.Person[jqid]["中毒程度"] > 35 then
					MpR = MpR*0.9
				end
				--内伤
				if JY.Person[jqid]["受伤程度"] > 70 then
					MpR = MpR*0.5
				elseif JY.Person[jqid]["受伤程度"] > 35 then
					MpR = MpR*0.8
				end
				end
				
				if JY.Person[jqid]["灼烧程度"] > 40 then
				   SpR = SpR - 1
				end
				HpR,HpR2 = math.modf(HpR)
				MpR,MpR2 = math.modf(MpR)
				if WAR.JESS[jqid] == nil then
				local v = 1
				if HpR2 < 0 then
				   v = -1
				end 
				local v2 = 1
				if MpR2 < 0 then
				   v2 = -1
				end
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + HpR
				--小数计算
				if math.abs(HpR2)>=0.55 then
				   if WAR.ESX_Counter == 2 then
					  JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + v
				   end
				elseif math.abs(HpR2)>=0.3 then
                   if WAR.SSX_Counter == 3 then
					  JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + v
				   end
				elseif math.abs(HpR2)>=0.2 then
                   if WAR.WSX_Counter == 5 then
					  JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + v
				   end
				elseif math.abs(HpR2)>=0.15 then
                   if WAR.LSX_Counter == 6 then
					  JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + v
				   end
				elseif math.abs(HpR2)>=0.07 then
                   if WAR.JSX_Counter == 9 then
					  JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + v
				   end   
				end   
				if JY.Person[jqid]["生命"] < 1 then
				   JY.Person[jqid]["生命"] = 1
				end   
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + MpR
				--小数计算
				if math.abs(HpR2)>=0.55 then
				   if WAR.ESX_Counter == 2 then
					  JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + v2
				   end
				elseif math.abs(HpR2)>=0.3 then
                   if WAR.SSX_Counter == 3 then
					  JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + v2
				   end
				elseif math.abs(HpR2)>=0.2 then
                   if WAR.WSX_Counter == 5 then
					  JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + v2
				   end
				elseif math.abs(HpR2)>=0.15 then
                   if WAR.LSX_Counter == 6 then
					  JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + v2
				   end
				elseif math.abs(HpR2)>=0.07 then
                   if WAR.JSX_Counter == 9 then
					  JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + v2
				   end   
				end
				if JY.Person[jqid]["内力"] < 0 then
				   JY.Person[jqid]["内力"] = 0
				end
				JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + SpR
				if JY.Person[jqid]["体力"] < 0 then
				   JY.Person[jqid]["体力"] = 0
				end
				
				end
				
				--无酒不欢：集气读数获取位置
				WAR.JQSDXS[jqid] = jq
		 
				if WAR.Person[i].Time >= 1000 then
					if WAR.ZYHB == 1 then
						if i ~= WAR.ZYHBP then
							WAR.Person[i].Time = 990
						else
							WAR.Person[i].Time = 1001
						end
					end
					xunhuan = false
				end
			end
		end
		
		local warStatus = War_isEnd2()   --战斗是否结束？   0继续，1赢，2输
		if 0 < warStatus then
			break;
		end
	
		DrawTimeBar_sub(x1, x2, nil, 0)
		ShowScreen(1)
		WAR.SXTJ = WAR.SXTJ + 1
		--无酒不欢：三时序，五时序，六时序，九时序的计数器
		WAR.ESX_Counter = WAR.ESX_Counter + 1
		if WAR.ESX_Counter == 3 then
			WAR.ESX_Counter = 1
		end
		WAR.SSX_Counter = WAR.SSX_Counter + 1
		if WAR.SSX_Counter == 4 then
			WAR.SSX_Counter = 1
		end
		WAR.WSX_Counter = WAR.WSX_Counter + 1
		if WAR.WSX_Counter == 6 then
			WAR.WSX_Counter = 1
		end
		WAR.LSX_Counter = WAR.LSX_Counter + 1
		if WAR.LSX_Counter == 11 then
			WAR.LSX_Counter = 1
		end
		WAR.JSX_Counter = WAR.JSX_Counter + 1
		if WAR.JSX_Counter == 21 then
			WAR.JSX_Counter = 1
		end
		lib.Delay(10) -- 无酒不欢：减缓集气条速度	
		
		--集气过程中按空格或回车停止自动
		local keypress = lib.GetKey()
		if (keypress == VK_SPACE or keypress == VK_RETURN) then
			if WAR.AutoFight == 1 then 
				WAR.AutoFight = 0
			end	
		end
	  
		lib.LoadSur(surid, x1 - ((x2 - x1) / 2)-100, 0)	--无酒不欢：修复杀到-500后集气条小头像刷新问题
	end
  
	--时序结束结算
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			WAR.Person[i].TimeAdd = 0
			local jqid=WAR.Person[i]["人物编号"]
			
			--判断是否在正常数据范围之内
			if JY.Person[jqid]["中毒程度"] < 0 then
				JY.Person[jqid]["中毒程度"] = 0;
			end
			if JY.Person[jqid]["受伤程度"] < 0 then
				JY.Person[jqid]["受伤程度"] = 0;
			end
			if JY.Person[jqid]["冰封程度"] < 0 then
				JY.Person[jqid]["冰封程度"] = 0;
			end
			if JY.Person[jqid]["灼烧程度"] < 0 then
				JY.Person[jqid]["灼烧程度"] = 0;
			end
			if JY.Person[jqid]["内力最大值"] < JY.Person[jqid]["内力"] then
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力最大值"]
			end
			if JY.Person[jqid]["生命最大值"] < JY.Person[jqid]["生命"] then
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命最大值"]
			end
			if JY.Person[jqid]["体力"] > 100 then
				JY.Person[jqid]["体力"] = 100
			end
		end
	end
  
	WAR.ZYHBP = -1
	lib.SetClip(0, 0, 0, 0)
	lib.FreeSur(surid)
end

--绘画整体集气条
function DrawTimeBar_sub(x1, x2, y, flag)

	--无酒不欢：绘画部分增加破绽区显示
	if not x2 then
		x2 = CC.ScreenW * 19 / 20 - 2
	end
	if not y then
		y = CC.ScreenH/10 + 29
	end
	if not x1 then
		x1 = CC.ScreenW * 1 / 2 - 34
		DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
		DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
		DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
		lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
		lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)	
	end
  
	for i = 0, WAR.PersonNum - 1 do
		if not WAR.Person[i]["死亡"] then
			--无酒不欢：修正集气条显示，不会飞过1000
			if WAR.Person[i].Time > 1001 then
				WAR.Person[i].Time = 1001
			end
			local id = WAR.Person[i]["人物编号"]
			local cx = x1 + math.modf(WAR.Person[i].Time*(x2 - x1)/1000)
			local headid = WAR.tmp[5000+i];
			if headid == nil then
				headid = JY.Person[id]["头像代号"]
			end
			local w, h = limitX(CC.ScreenW/25,12,35),limitX(CC.ScreenW/25,12,35)
			local jq_color = RGB(195, 58, 248)
			if JY.Person[id]["中毒程度"] == 100 then
				jq_color = RGB(56, 136, 36)
			elseif JY.Person[id]["中毒程度"] >= 50 then
				jq_color = RGB(120, 208, 88)
			end
			if WAR.LQZ[id] == 100 then
				jq_color = C_RED
			end
			
			if WAR.Person[i]["我方"] then
				drawname(cx, 1, id, CC.FontSmall)
				lib.LoadPNG(99, headid*2, cx - w / 2, y - h - 4, 1, 0)
				DrawString(cx-21, y-10-9, string.format("%3d",WAR.JQSDXS[id]), jq_color, CC.FontSMALL)	--集气速度
				if JY.Person[id]["灼烧程度"] ~= 0 then
					DrawString(cx, y-10-33, string.format("%3d",JY.Person[id]["灼烧程度"]), C_ORANGE, CC.FontSMALL)	--灼烧数值
				end
				if WAR.FXDS[id] ~= nil and WAR.FXDS[id] ~= 0 then
					DrawString(cx-21, y-10-33, string.format("%3d",WAR.FXDS[id]), C_GOLD, CC.FontSMALL)	--封穴数值
				end
			else
				drawname(cx, y+h, id, CC.FontSmall)
				lib.LoadPNG(99, headid*2, cx - w / 2, y + 6, 1, 0)
				DrawString(cx-21, y+h-9, string.format("%3d",WAR.JQSDXS[id]), jq_color, CC.FontSMALL*1.1)	--集气速度
				if JY.Person[id]["灼烧程度"] ~= 0 then
					DrawString(cx, y+h-33, string.format("%3d",JY.Person[id]["灼烧程度"]), C_ORANGE, CC.FontSMALL)	--灼烧数值
				end
				if WAR.FXDS[id] ~= nil and WAR.FXDS[id] ~= 0 then
					DrawString(cx-21, y+h-33, string.format("%3d",WAR.FXDS[id]), C_GOLD, CC.FontSMALL)	--封穴数值
				end
			end
			
		end
	end
	DrawString(x2 + 10, y , WAR.SXTJ, C_GOLD, CC.FontSMALL)
end

--绘画集气条上的名字
function drawname(x, y, id, size)
	local name = JY.Person[id]["姓名"]
	local color = C_WHITE
	--名字颜色随冰封和内伤变化
	if JY.Person[id]["受伤程度"] > JY.Person[id]["冰封程度"] then
		if JY.Person[id]["受伤程度"] > 99 then
			color = RGB(232, 32, 44)
		elseif JY.Person[id]["受伤程度"] > 66 then
			color = RGB(244, 128, 32)
		elseif JY.Person[id]["受伤程度"] > 33 then
			color = RGB(236, 200, 40)
		end
	else
		if JY.Person[id]["冰封程度"] >= 50 then
			color = M_RoyalBlue
		elseif JY.Person[id]["冰封程度"] > 0 then
			color = LightSkyBlue
		end
	end
	x = x - math.modf(size / 2)
	local sc_len = 2
	if name == '027' or name == 'weyl' then
		sc_len =1
	end
	local namelen = string.len(name) / sc_len
	local zi = {}
	for i = 1, namelen do
		zi[i] = string.sub(name, (i-1)*sc_len + 1, i * sc_len)
		DrawString(x, y, zi[i], color, size)
		y = y + size
	end
end

--判断两人之间的距离
function RealJL(id1, id2, len)
	if not len then
		len = 1
	end
	local x1, y1 = WAR.Person[id1]["坐标X"], WAR.Person[id1]["坐标Y"]
	local x2, y2 = WAR.Person[id2]["坐标X"], WAR.Person[id2]["坐标Y"]
	local s = math.abs(x1 - x2) + math.abs(y1 - y2)
	if len == nil then
		return s
	end
	if s <= len then
		return true
	else
		return false
	end
end

--计算武功范围
function refw(wugong, level)
  --无酒不欢：参数说明
  --m1为移动范围斜向延伸：
	--0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
  --m2为移动范围直线延伸；
	--数字即等于延伸距离
  --a1为攻击范围类型：
	--0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：d字，9：e字，10：直线，11：正三角，12：倒三角，13：横线
  --a2为攻击范围长度距离：
	--0：点攻，大于0时，距离 = a2
  --a3为攻击范围宽度(偏移1格)距离：
	--0：点攻，大于0时，距离 = a3  
  --a4为攻击范围宽度(偏移2格)距离：
	--0：点攻，大于0时，距离 = a4
  --a5为攻击范围宽度(偏移3格)距离：
	--0：点攻，大于0时，距离 = a5	
	local m1, m2, a1, a2, a3, a4, a5 = nil, nil, nil, nil, nil, nil, nil
	if JY.Wugong[wugong]["攻击范围"] == -1 then
		return JY.Wugong[wugong]["加内力1"], JY.Wugong[wugong]["加内力2"], JY.Wugong[wugong]["未知1"], JY.Wugong[wugong]["未知2"], JY.Wugong[wugong]["未知3"], JY.Wugong[wugong]["未知4"], JY.Wugong[wugong]["未知5"]
	end
	--0：点
	--1：线
	--2：十字
	--3：面
	local fightscope = JY.Wugong[wugong]["攻击范围"]
	local kfkind = JY.Wugong[wugong]["武功类型"]
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	
		
	
	--六脉神剑算剑法的范围
	if wugong == 49 then
		kfkind = 3
	end
	--玄女剑法算奇门的范围
	if wugong == 161 then
		kfkind = 5
	end
	--逍遥神剑算刀法的范围
	if wugong == 168 then
		kfkind = 4
	end
	--阴风刀算剑法的范围
	if wugong == 174 then
		kfkind = 3
	end
	--白虹掌力算剑法的范围
	if wugong == 184 then
		kfkind = 3
	end
	--王语嫣妙法无形
	local MiaofaWX = 0
	for i = 0, WAR.PersonNum - 1 do
		local id = WAR.Person[i]["人物编号"]
		if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] and match_ID(id, 76) and inteam(pid) then
			MiaofaWX = MiaofaWX + 1
			break
		end
	end
	if JY.Person[pid]["出战"] == 1 then
	   MiaofaWX = MiaofaWX + 1
	end
	--标主指法
	if JY.Base["标准"] == 2 and pid == 0 and kfkind == 2 and JY.Person[0]["阶"] >= 1 then
	   MiaofaWX = MiaofaWX + 2
	end
	if JY.Base["标准"] == 5 and pid == 0 and JY.Person[0]["阶"] >= 1 then
	   MiaofaWX = MiaofaWX + 1
	end
	--天罗地网也增加攻击范围
	if Curr_QG(pid,148) then
		MiaofaWX = MiaofaWX + 1
	end
	if JY.Person[pid]["人4"] == 1 then
	    MiaofaWX = MiaofaWX + 1
	end
	if Wush1() or Wush2() then
	    MiaofaWX = MiaofaWX + 1
	end
	if match_ID(pid, 636) then
	   MiaofaWX = MiaofaWX + WAR.LBDIS
	end
	if PersonKF(pid, 148) and JY.Person[pid]["专1"] == 148 then
	   MiaofaWX = MiaofaWX + 1
	end
	if JY.Person[pid]["地10"] == 4 then
	   MiaofaWX = MiaofaWX + 5
	end
	if match_ID(pid, 634) and JY.Person[634]["天4"] == 1 then
	   MiaofaWX = MiaofaWX + 2
	end
	--聂风
	if JY.Person[681]["天4"] == 1 and match_ID(pid, 681) then
	   MiaofaWX = MiaofaWX + 2
	end
	if JY.Person[681]["天4"] == 2 and match_ID(pid, 681) then
	   MiaofaWX = MiaofaWX - 3
	end
	if JY.Person[682]["天3"] == 1 and match_ID(pid, 682) then
	   MiaofaWX = MiaofaWX + 2
	end
	if JY.Person[682]["天3"] == 2 and match_ID(pid, 682) then
	   MiaofaWX = MiaofaWX - 3
	end
	if match_ID(pid, 682) and kfkind == 1 then
	    MiaofaWX = MiaofaWX + 1
		if WAR.LQZ[pid] ~= nil then
		   local add = math.modf(WAR.LQZ[pid]*0.031)
		   MiaofaWX = MiaofaWX + add
		end
	end
	if wugong == 38 and (JY.Person[pid]["专1"] == 38 or (match_ID(pid, 63) and JY.Person[63]["阶"] >= 3)) then
	   MiaofaWX = MiaofaWX + 2
	end
	
	--熔炉
	if match_ID(pid, 690) and wugong == 225 then
	   MiaofaWX = MiaofaWX + math.modf(JY.Person[689]["天1"]*0.6)
	end
	
	if JY.Person[pid]["地1"] == 2 then
	   MiaofaWX = MiaofaWX + 1
	end
			
	--豪鬼，2
	if WAR.SYBD[pid] ~= nil and JY.Person[673]["外号2"] == "烈" then
		MiaofaWX = MiaofaWX + 2
	end
	--气合
	if match_ID(pid, 673) and WAR.QHTR[pid] == 1 then
		MiaofaWX = MiaofaWX + 1 + math.modf(JY.Person[pid]["内力"]/3300)
	end
	
	if WAR.MXD[pid] ~= nil then
	   if kfkind == 4 then
		MiaofaWX = MiaofaWX + 1
	   end
	    MiaofaWX = MiaofaWX + 1
	end
	
	if WAR.LSF[pid] ~= nil and kfkind == 1 then
		MiaofaWX = MiaofaWX + 2
	end
	
	if match_ID(pid, 677) and JY.Person[677]["天3"] == 1 then
	   MiaofaWX = MiaofaWX + 3
	end
	--方证用拳法范围+1
	if match_ID(pid, 149) and kfkind == 1 then
		MiaofaWX = MiaofaWX + 1
	end
	
	if match_ID(pid, 636) and JY.Person[636]["天2"] == 1 and kfkind == 3 then
		MiaofaWX = MiaofaWX + 2
	end
	
	if wugong == 66 and match_ID(pid, 103) and JY.Person[103]["阶"] >= 1 then
	   MiaofaWX = MiaofaWX + 2
	end
	
	if wugong == 155 and match_ID(pid, 601) and JY.Person[601]["阶"] >= 3 then
	   MiaofaWX = MiaofaWX + 10
	end
	
	if match_ID(pid, 678) and kfkind == 2 and JY.Person[678]["天1"] == 2 then
		MiaofaWX = MiaofaWX + 1
	end
	if wugong == 23 and match_ID(pid, 8) and JY.Person[8]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 2
    end
	if wugong == 43 and match_ID(pid, 113) and JY.Person[113]["阶"] >= 2 then
       MiaofaWX = MiaofaWX + 3
    end
	if wugong == 184 and match_ID(pid, 118) and JY.Person[118]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 5
    end
	if (wugong == 26 or wugong == 80) and match_ID(pid, 69) and JY.Person[69]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 3
    end
	if (wugong == 54 or wugong == 62) and match_ID(pid, 77) and JY.Person[77]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 3
    end
	if wugong == 49 and match_ID(pid, 53) and JY.Person[53]["阶"] >= 2 then
       MiaofaWX = MiaofaWX + 5
    end
	if wugong == 35 and match_ID(pid, 43) and JY.Person[43]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 2
    end
	if wugong == 207 and match_ID(pid, 22) and JY.Person[22]["阶"] >= 2 then
       MiaofaWX = MiaofaWX + 5
    end
	if wugong == 30 and match_ID(pid, 21) and JY.Person[21]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 1
    end
	if wugong == 34 and match_ID(pid, 19) and JY.Person[19]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 3
    end
	if wugong == 32 and match_ID(pid, 20) and JY.Person[20]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 2
    end
	if wugong == 19 and match_ID(pid, 18) and JY.Person[18]["阶"] >= 2 then
       MiaofaWX = MiaofaWX + 4
    end
	if wugong == 18 and match_ID(pid, 11) and JY.Person[11]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 5
    end
	if wugong == 92 and match_ID(pid, 13) and JY.Person[13]["阶"] >= 1 then
       MiaofaWX = MiaofaWX + 3
    end
	--摧心掌
	if wugong == 201 and PersonKF(pid, 107) then
		MiaofaWX = MiaofaWX + 1
	end
	
	if wugong == 240 and JY.Person[pid]["洗髓"] == 100 then
	   MiaofaWX = MiaofaWX + 6
	end
	
	if wugong == 17 and match_ID(pid, 687) then
	   MiaofaWX = MiaofaWX + math.modf(JY.Person[687]["声望"]/2000)
	if JY.Person[687]["声望"] == 1000 and JY.Person[687]["天2"] == 1 then
	   MiaofaWX = MiaofaWX + 2
	end
	end
	if wugong == 49 and JY.Person[687]["天2"] == 2 then
	   MiaofaWX = MiaofaWX + 2
	end
	--莫大
	if wugong == 32 and match_ID(pid, 20) then
		MiaofaWX = MiaofaWX + JY.Person[20]["品德"] - 40
	end
	--逍遥游
	if wugong == 2 and JY.Person[pid]["专1"] == 2 then
	   MiaofaWX = MiaofaWX + 3
	end
	if match_ID(pid, 691) and JY.Person[691]["天3"] == 2 then
	   MiaofaWX = MiaofaWX + 3
	end
	if match_ID(pid, 52) and wugong == 70 and JY.Person[pid]["六如觉醒"] >= 6 then
	   MiaofaWX = MiaofaWX + 3
	end
	if wugong == 25 and JY.Person[pid]["专2"] == 25 then
	   MiaofaWX = MiaofaWX + 1
	end
	--参合指
	if wugong == 138 and JY.Person[pid]["专2"] == 138 then
	   MiaofaWX = MiaofaWX + 3
	end
	--修罗刀法
	if wugong == 58 and JY.Person[pid]["专1"] == 58 then
	   MiaofaWX = MiaofaWX + 4
	end
	--万岳朝宗
	if wugong == 33 and JY.Person[pid]["专1"] == 33 then
	   MiaofaWX = MiaofaWX + 3
	end
	--三分
	if PersonKF(pid, 29) and JY.Person[pid]["专1"] == 29 then
	   MiaofaWX = MiaofaWX + 1
	end
	--铁指诀
	if PersonKF(pid, 121) and JY.Person[pid]["专1"] == 121 then
	   MiaofaWX = MiaofaWX + 6
	end

	if PersonKF(pid, 122) and JY.Person[pid]["专1"] == 122 then
	   MiaofaWX = MiaofaWX + 4
	end
	if PersonKF(pid, 68) and JY.Person[pid]["专1"] == 68 then
	   MiaofaWX = MiaofaWX + 2
	end
	--夫妻刀法
	if PersonKF(pid, 62) and JY.Person[pid]["专2"] == 62 and JY.Wugong[wugong]["武功类型"] == 4 then
	   MiaofaWX = MiaofaWX + 2
	end
	if match_ID(pid, 691) and JY.Wugong[wugong]["武功类型"] == 4 then
	   MiaofaWX = MiaofaWX + 1
	   if JY.Person[pid]["武器"] == 319 and wugong == 189 then
	      MiaofaWX = MiaofaWX + 1
	   end
	end
	--松风剑法
	if wugong == 27 and JY.Person[pid]["专1"] == 27 then
	   MiaofaWX = MiaofaWX + 3
	end
	--吸星大法
	if wugong == 88 and JY.Person[pid]["专1"] == 88 then
	   MiaofaWX = MiaofaWX + 1
	end
	--天山折梅手
	if wugong == 14 and JY.Person[pid]["专2"] == 14 then
	   MiaofaWX = MiaofaWX + 3
	end
	if wugong == 184 and JY.Person[pid]["专2"] == 184 then
	   MiaofaWX = MiaofaWX + 1
	end
	--倚天屠龙功
	if wugong == 84 and JY.Person[pid]["专2"] == 84 then
	   MiaofaWX = MiaofaWX + 2
	end

	if wugong == 157 and JY.Person[pid]["专2"] == 157 then
	   MiaofaWX = MiaofaWX + 5
	end
	--连城剑法
	if wugong == 114 and JY.Person[pid]["专2"] == 114 then
	   MiaofaWX = MiaofaWX + 3
	end
	--海叟
	if wugong == 76 and JY.Person[pid]["专1"] == 76 then
	   MiaofaWX = MiaofaWX + 10
	end
	--袖中
	if wugong == 125 and JY.Person[pid]["专1"] == 125 then
	   MiaofaWX = MiaofaWX + 4
	end
	--玄铁
	if wugong == 45 and JY.Person[pid]["专2"] == 45 then
	   MiaofaWX = MiaofaWX + 1
	end
	--六脉神剑
	if wugong == 49 and JY.Person[pid]["专2"] == 49 then
	   MiaofaWX = MiaofaWX + 1
	end
	--一阳指
	if wugong == 17 and JY.Person[pid]["专2"] == 17 then
	   MiaofaWX = MiaofaWX + 3
	end
	--幻阴指
	if wugong == 19 and JY.Person[pid]["专2"] == 19 then
	   MiaofaWX = MiaofaWX + 2
	end
	--七伤拳
	if wugong == 23 and JY.Person[pid]["专2"] == 23 then
	   MiaofaWX = MiaofaWX + 2
	end
	--降龙十八掌
	if wugong == 26 and JY.Person[pid]["专2"] == 26 then
	   MiaofaWX = MiaofaWX + 1
	end
	--须弥山神掌
	if wugong == 24 and (JY.Person[pid]["专2"] == 24 or (match_ID(pid, 147) and JY.Person[147]["阶"] >= 1)) then
	   MiaofaWX = MiaofaWX + 3
	end
	--黄沙万里
	if wugong == 78 and (JY.Person[pid]["专2"] == 78 or (match_ID(pid, 25) and JY.Person[25]["阶"] >= 1)) then
	   MiaofaWX = MiaofaWX + 1
	end
	--美女拳法
	if wugong == 6 and JY.Person[pid]["专1"] == 6 then
	   MiaofaWX = MiaofaWX + 5
	end
	--玄天
	if wugong == 130 and JY.Person[pid]["专1"] == 130 then
	   MiaofaWX = MiaofaWX + 4
	end
	--擒龙功, 根据敌我血量差距增伤
	if PersonKF(pid, 188) and JY.Person[pid]["天赋内功"] == 188 then
       MiaofaWX = MiaofaWX + 1
	end
	--丁典，邪
	if match_ID(pid, 672) and JY.Person[672]["品德"] == 70 and wugong == 94 then
		MiaofaWX = MiaofaWX + 2
	end
	
	--雷震，奇门范围
	if match_ID(pid, 670) and JY.Person[pid]["特殊兵器"] >= 80 then  
       MiaofaWX = MiaofaWX + 1
	   if JY.Person[pid]["特殊兵器"] >= 200 then
	      MiaofaWX = MiaofaWX + 1
	   end
	   if JY.Person[pid]["特殊兵器"] >= 320 then
	      MiaofaWX = MiaofaWX + 1
	   end
    end
	
	--谢烟客，擒龙控鹤
	if match_ID(pid, 164) then
	   MiaofaWX = MiaofaWX + 1
	   if JY.Person[164]["阶"] >= 2 then
			MiaofaWX = MiaofaWX - 1
		end
	   if PersonKF(pid, 188) then
	      MiaofaWX = MiaofaWX + 1
	   end
	end
	for j = 0, WAR.PersonNum - 1 do
			if match_ID(WAR.Person[j]["人物编号"], 164) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				MiaofaWX = MiaofaWX - 1
				if JY.Person[164]["阶"] >= 2 then
					MiaofaWX = MiaofaWX - 1
				end
				if PersonKF(WAR.Person[j]["人物编号"], 188) then
				   MiaofaWX = MiaofaWX - 1
				end
			end
	end
	for j = 0, WAR.PersonNum - 1 do
		if match_ID(WAR.Person[j]["人物编号"], 39) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
			MiaofaWX = MiaofaWX + 2
		end
	end
	for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["人物编号"] == 0 and match_ID(WAR.Person[j]["人物编号"], 39) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			MiaofaWX = MiaofaWX - 1
		end
	end
	for j = 0, WAR.PersonNum - 1 do
		if match_ID(WAR.Person[j]["人物编号"], 40) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			MiaofaWX = MiaofaWX + 1
		end
	end
	for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["人物编号"] == 0 and match_ID(WAR.Person[j]["人物编号"], 40) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			MiaofaWX = MiaofaWX - 2
		end
	end
	
	for j = 0, WAR.PersonNum - 1 do
		if (JY.Person[WAR.Person[j]["人物编号"]]["专2"] == 82 and PersonKF(WAR.Person[j]["人物编号"], 82) or match_ID(WAR.Person[j]["人物编号"], 597) or match_ID(WAR.Person[j]["人物编号"], 598) or match_ID(WAR.Person[j]["人物编号"], 599)) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			MiaofaWX = MiaofaWX - 1
		end
	end
	
	for j = 0, WAR.PersonNum - 1 do
		if JY.Person[WAR.Person[j]["人物编号"]]["专2"] == 188 and PersonKF(WAR.Person[j]["人物编号"], 188) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			MiaofaWX = MiaofaWX - 1
		end
	end
	
	--无名，剑法+2
    if match_ID(pid, 671) and JY.Wugong[wugong]["武功类型"] == 3 and wugong ~= 199 then
       MiaofaWX = MiaofaWX + 1
    end
	
	--雷震，天佛降世范围变化
	if wugong == 197 and match_ID(pid, 670) then
	    if WAR.LQZ[pid] == nil then
		   WAR.LQZ[pid] = 0
		end
	    local n = math.modf(WAR.LQZ[pid]*0.045)
		local m = math.modf(TrueQZ(pid)*0.015)
		MiaofaWX = MiaofaWX + n + m
	end
	
	if Curr_NG(pid, 213) and JY.Wugong[wugong]["武功类型"] == 3 then
	      MiaofaWX = MiaofaWX + 2
	end
	
	--六脉
	if wugong == 49 and match_ID(pid, 670) then
	   MiaofaWX = MiaofaWX + 1
	end
	
	--闪电貂和妙手空空范围不增加
	if wugong == 113 or wugong == 116 then
		MiaofaWX = 0
	end
	--点
	if fightscope == 0 then
		if level > 10 then
			m1 = 1
			m2 = JY.Wugong[wugong]["移动范围" .. 10]
			a1 = 1
			a2 = 3 + MiaofaWX
			a3 = 3 + MiaofaWX
		else
			m1 = 0
			m2 = JY.Wugong[wugong]["移动范围" .. level]
			a1 = 1
			a2 = math.modf(level / 5) + MiaofaWX
			a3 = math.modf(level / 8) + MiaofaWX
		end
	--线
	elseif fightscope == 1 then
		--拳指
		if kfkind == 1 or kfkind == 2 then
			a1 = 12
			if level > 10 then
				m1 = 3
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
			else
				m1 = 2
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. level] - 1 + MiaofaWX
			end
		--剑
		elseif kfkind == 3 then
			a1 = 10
			if level > 10 then
				m1 = 3
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] + MiaofaWX
				a3 = a2 - 1
				a4 = a3 - 1
			else
				m1 = 2
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. level] + MiaofaWX
			end
			if level > 7 then
				a3 = a2 - 1
			end
		--刀
		elseif kfkind == 4 then
			a1 = 11
			if level > 10 then
				m1 = 3
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
			else
				m1 = 2
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. level] - 1 + MiaofaWX
			end
		--奇
		elseif kfkind == 5 then
			m1 = 2
			if level > 10 then
				m2 = JY.Wugong[wugong]["移动范围" .. 10] - 1
				a1 = 7
				--田字斗转时不会增加范围
				if WAR.DZXY == 0 then
					a2 = 1 + math.modf(level / 3) + MiaofaWX
				else
					a2 = 1 + math.modf(level / 3)
				end
				a3 = a2
			else
				m2 = JY.Wugong[wugong]["移动范围" .. level] - 1
				a1 = 1
				a2 = 1 + math.modf(level / 3) + MiaofaWX
			end
		else
			a1 = 11
			if level > 10 then
				m1 = 3
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
			else
				m1 = 2
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. level] - 1 + MiaofaWX
			end
		end
	--十字
	elseif fightscope == 2 then
		m1 = 0
		m2 = 0
		--刀
		if kfkind == 4 then
			if level > 10 then
				a1 = 6
				a2 = JY.Wugong[wugong]["移动范围" .. 10] + MiaofaWX
			else
				a1 = 8
				a2 = JY.Wugong[wugong]["移动范围" .. level] + MiaofaWX
			end
		--到极的非刀
		elseif level > 10 then
			--拳指
			if kfkind == 1 or kfkind == 2 then
				a1 = 5
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
				a3 = a2 - 3
			--剑
			elseif kfkind == 3 then
				a1 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
				a3 = a2
			else
				a1 = 2
				a2 = 1 + math.modf(JY.Wugong[wugong]["移动范围" .. 10] / 2) + MiaofaWX
			end
		--不到极的非刀
		else
			  a1 = 1
			  a2 = JY.Wugong[wugong]["移动范围" .. level] + MiaofaWX
			  a3 = 0
		end
	--面
	elseif fightscope == 3 then
		m1 = 0
		a1 = 3
		if level > 10 then
			m2 = JY.Wugong[wugong]["移动范围" .. 10] + 1
			a2 = JY.Wugong[wugong]["杀伤范围" .. 10] + MiaofaWX
			a3 = a2
		else
			m2 = JY.Wugong[wugong]["移动范围" .. level]
			a2 = JY.Wugong[wugong]["杀伤范围" .. level] + MiaofaWX
		end
	end
	
	--太极神功范围随着蓄力变化
	--斗转时范围不变化
	if (wugong == 16 or wugong == 46) and WAR.tmp[3000 + pid] ~= nil and WAR.tmp[3000 + pid] > 0  and WAR.DZXY == 0 then
		if WAR.tmp[3000 + pid] > 600 then
			m1 = 0
			m2 = 4
			a1 = 3
			a2 = 4 + MiaofaWX
			a3 = a2
		elseif WAR.tmp[3000 + pid] > 500 then
			m1 = 0
			m2 = 4
			a1 = 3
			a2 = 3 + MiaofaWX
			a3 = a2			
		elseif WAR.tmp[3000 + pid] > 300 then
			a2 = a2 + 2
			a3 = a3 + 2
		else
			a2 = a2 + 1
			a3 = a3 + 1
		end
	end

	if wugong == 67 then
		if PersonKF(pid,44) then
			a1 = 3
			m1 = 1
			m2 = 5
			a2 = 3
			a3 = 3
		else
			a1 = 6
			m1 = 1
			m2 = 5
			a2 = 3
			a3 = 3
		end	
	end

	if wugong == 44 then
		if PersonKF(pid,67) then
			a1 = 3
			m1 = 1
			m2 = 5
			a2 = 3
			a3 = 3
		else
			a1 = 6
			m1 = 1
			m2 = 5
			a2 = 3
			a3 = 3
		end	
	end
	
		--苗人凤，苗剑范围随御剑系数增加
	if match_ID(pid, 3) and wugong == 44 then
		a3 = a3 + MiaofaWX + math.modf(TrueYJ(pid)/100)
		a2 = a2 + MiaofaWX + math.modf(TrueYJ(pid)/100)
	end
	
	if wugong == 156 and match_ID(pid, 136) then
		a1=math.random(1,12)
	end
	
	--丁典，剑法
	if match_ID(pid, 672) and kfkind == 3 then
	   a1 = 1
	   if a2 ~= nil then
	   a2 = a2 + 2
	   end
	   if a3 ~= nil then
	   a3 = a3 + 1
	   else
	   a3 = a2 - 1
	   end
	   m1 = 1
	   m2 = m2 + 1
	end
	--iron fist
	--skill--lotus whip,dragon's touch,surging fist,dragon tail,crescent heel,twin snake,rising fang*,wall of kun-lun*,iron rage**,volcanic roar**,dragon's prey***
	--m1为移动范围斜向延伸：
	--0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
  --m2为移动范围直线延伸；
	--数字即等于延伸距离
  --a1为攻击范围类型：
	--0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：d字，9：e字，10：直线，11：正三角，12：倒三角，13：横线
  --a2为攻击范围长度距离：
	--0：点攻，大于0时，距离 = a2
  --a3为攻击范围宽度(偏移1格)距离：
	--0：点攻，大于0时，距离 = a3  
  --a4为攻击范围宽度(偏移2格)距离：
	--0：点攻，大于0时，距离 = a4
  --a5为攻击范围宽度(偏移3格)距离：
	--0：点攻，大于0时，距离 = a5
	--
	
	if wugong == 242 then
	   a1 = 1
	   a2 = 4 + MiaofaWX
	   a3 = 3 + MiaofaWX
	   m1 = 1
	   m2 = 3
	end
	if wugong == 243 then--touch
	   m1 = 3
	   a1 = 0
	end
	if wugong == 244 then--surging
	   m1 = 1
	   m2 = 4
	   a1 = 3
	   a2 = 1
	   a3 = 1
	end
	if wugong == 245 then--tail
	   m1 = 3
	   a1 = 11
	   a2 = 5
	end
	if wugong == 246 then--heel
	   m1 = 3
	   a1 = 12
	   a2 = 4
	end
	if wugong == 247 then--snake
	   m1 = 3
	   a1 = 2
	   a2 = 3
	end
	if wugong == 248 then--fang
	   m1 = 3
	   a1 = 10
	   a2 = 6
	   a3 = 6
	   a4 = 6
	end
	if wugong == 249 then--wall
	   m1 = 1
	   m2 = 2
	   a1 = 3
	   a2 = 1
	   a3 = 1
	end
	if wugong == 250 then--rage
	   m1 = 3
	   a1 = 10
	   a2 = 9
	   a3 = 9
	   a4 = 9
	   a5 = 9
	   if JY.Person[693]["天3"] == 1 then
	   a2 = 14
	   a3 = 14
	   a4 = 14
	   a5 = 14
	   end
	end
	if wugong == 251 then--roar
	   m1 = 2
	   m2 = 0
	   a1 = 2
	   a2 = 6
	   a3 = 6
	   if JY.Person[693]["天3"] == 2 then
	   a2 = 8
	   a3 = 8
	   end
	end
	if wugong == 252 then
	   m1 = 1
	   m2 = 2
	   a1 = 0
	   if JY.Person[693]["天3"] == 3 then
	   m2 = 4
	   end
	end
	if wugong == 226 then--急速冷却
	   m1 = 1
	   m2 = 9
	   a1 = 3
	   a2 = 1
	   a3 = 1
	   if JY.Person[pid]["专1"] == 226 then
		a2 = 3
	    a3 = 3
	   end
	end 
	if wugong == 227 then--ylmb
	   m1 = 2
	   m2 = 0
	   a1 = 0
	end
	if wugong == 228 then--强袭飓风
	   m1 = 3
	   a1 = 10
	   a2 = 9 + JY.Person[689]["天2"]
	   a3 = 9 + JY.Person[689]["天2"]
	   a4 = 9 + JY.Person[689]["天2"]
	   if JY.Person[pid]["专1"] == 228 then
		  a2 = a2 + 3
	      a3 = a3 + 3
	      a4 = a4 + 3
		  a5 = a4
	   end
	end
	if wugong == 229 then--电磁脉冲
	   m1 = 1
	   m2 = 5
	   a1 = 2
	   a2 = 5
	   a3 = 5
	   if JY.Person[pid]["专1"] == 229 then
		  a2 = a2 + 1
	      a3 = a3 + 1
	   end
	end
	if wugong == 230 then--灵动迅捷
	   m1 = 2
	   m2 = 0
	   a1 = 0
	end
	if wugong == 231 then--混沌陨石
	   m1 = 1
	   m2 = 7
	   a1 = 3
	   a2 = 2+math.modf(JY.Person[689]["天3"]*0.3)
	   a3 = 2+math.modf(JY.Person[689]["天3"]*0.3)
	end
	if wugong == 232 or wugong == 238 then--阳炎冲击
	   m1 = 1
	   m2 = 18+JY.Person[689]["天3"]
	   a1 = 3
	   a2 = 1
	   a3 = 1
	end
	if wugong == 233 then--熔炉
	   m1 = 1
	   m2 = 5
	   a1 = 0
	end
	if wugong == 234 then--寒冰之墙
	   m1 = 1
	   m2 = 5
	   a1 = 3
	   a2 = 1+math.modf(JY.Person[689]["天1"]*0.5)
	   a3 = 6+JY.Person[689]["天1"]
	   if JY.Person[pid]["专1"] == 234 or not inteam(pid) then
	      a2 = a3
	   end	  
	end
	if wugong == 235 then
	   m1 = 3
	   a1 = 10
	   a2 = 10+math.modf(JY.Person[689]["天2"]*0.8)
	   a3 = 9+math.modf(JY.Person[689]["天2"]*0.8)
	   a4 = 8+math.modf(JY.Person[689]["天2"]*0.8)
	   a5 = 7
	   if JY.Person[690]["天3"] == 2 then
	   m1 = 2
	   m2 = 0
	   a1 = 0
	   end
	end
	
	--神刀斩
	if wugong == 189 or (match_ID(pid, 691) and JY.Person[pid]["武器"] == 319 and kfkind == 4) then
		m1 = 3
		a1 = 10
		a2 = 10 + MiaofaWX
		a3 = 9 + MiaofaWX
		a4 = 8 + MiaofaWX
		a5 = 7 + MiaofaWX
	end
	
	--龙啸
	if wugong == 208 then
		m1 = 3
		a1 = 10
		a2 = 9 + MiaofaWX
		a3 = 9 + MiaofaWX
		a4 = 9 + MiaofaWX
		--a5 = 9 + MiaofaWX
	end
	if wugong == 155 then
	   a1 = 0
	end
	if wugong == 23 and match_ID(pid, 8) and JY.Person[8]["阶"] >= 2 then
	   m2 = m2 + 3
    end
	if wugong == 55 and match_ID(pid, 29) and JY.Person[29]["阶"] >= 3 then
	   m2 = m2 + math.modf(WAR.JQSDXS[pid]/10)
    end
	if wugong == 47 and match_ID(pid, 35) and JY.Person[35]["阶"] >= 3 then
	   m1 = 1
	   m2 = 8
    end
	if wugong == 35 and match_ID(pid, 43) and JY.Person[43]["阶"] >= 1 then
	   m1 = 1
	   m2 = 5
    end
	if wugong == 13 and match_ID(pid, 67) and JY.Person[67]["阶"] >= 2 then
	   a1 = 3
    end
	if wugong == 7 and match_ID(pid, 82) and JY.Person[82]["阶"] >= 3 then
	   a1 = 3
    end
	if wugong == 117 and ((match_ID(pid, 147) and JY.Person[147]["阶"] >= 2)  or (
	(match_ID(pid, 143) or match_ID(pid, 144) or match_ID(pid, 145) or match_ID(pid, 146) or match_ID(pid, 147) or match_ID(pid, 148)) and JY.Person[147]["阶"] >= 3
	)) then
	   a1 = 3
    end
	if wugong == 70 and match_ID(pid, 52) and JY.Person[52]["阶"] >= 1 then
	   m1 = 1
	   m2 = 4
	   a1 = 2
	   a2 = 5 + MiaofaWX
	   a3 = 5 + MiaofaWX
    end
	if wugong == 38 and match_ID(pid, 63) and JY.Person[63]["阶"] >= 1 then
	   m1 = 1
	   m2 = 4
	   a1 = 2
	   a2 = 3 + MiaofaWX
	   a3 = 3 + MiaofaWX
    end
	if wugong == 241 then
	   m1=3
	   a1=10
	   a2=11+MiaofaWX
	   a3=12+MiaofaWX
	   a4=13+MiaofaWX
	   a5=13+MiaofaWX
	end
	--m1为移动范围斜向延伸：
	--0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
  --m2为移动范围直线延伸；
	--数字即等于延伸距离
  --a1为攻击范围类型：
	--0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：d字，9：e字，10：直线，11：正三角，12：倒三角，13：横线
  --a2为攻击范围长度距离：
	--0：点攻，大于0时，距离 = a2
  --a3为攻击范围宽度(偏移1格)距离：
	--0：点攻，大于0时，距离 = a3  
  --a4为攻击范围宽度(偏移2格)距离：
	--0：点攻，大于0时，距离 = a4
  --a5为攻击范围宽度(偏移3格)距离：
	--0：点攻，大于0时，距离 = a5
	--
	if wugong == 225 then
	if not inteam(pid) then
	   MiaofaWX = MiaofaWX + 1
	end 
	if JY.Person[pid]["地1"] == 7 then
	   MiaofaWX = MiaofaWX + 2
	end
	local mx = Xishu_max(pid)
	if TrueQZ(pid) == mx then
	m1 = 1
	m2 = 3 + MiaofaWX
	a1 = 1
	a2 = 2 + MiaofaWX
	a3 = 2 + MiaofaWX
	elseif TrueZF(pid) == mx then
	m1 = 3
	a1 = 12
	a2 = 4 + MiaofaWX
	elseif TrueYJ(pid) == mx then
	    m1 = 3
		a1 = 10
		a2 = 6 + MiaofaWX
		a3 = 5 + MiaofaWX
		a4 = 4 + MiaofaWX
	elseif TrueSD(pid) == mx then
	m1 = 3
	a1 = 11
	a2 = 4 + MiaofaWX
	elseif TrueTS(pid) == mx then
	m1 = 0
	m2 = 3 + MiaofaWX
	a1 = 7
	a2 = 3 + MiaofaWX
	a3 = a2
	end
	
	--buff
	if JY.Person[0]["天2"] == 4 then
	      m1 = 1
		  m2 = 6
		  a1 = 3
		  a2 = 2
		  a3 = 2
	end
	end
	
	if wugong == 224 then
	    m1 = 3
		a1 = 10
		a2 = 9 + MiaofaWX
		a3 = 9 + MiaofaWX
	end
	
	--雷震，打狗
	if wugong == 80 and match_ID(pid, 670) then
			MiaofaWX = MiaofaWX -1
			a1 = 3
	end
	if wugong == 126 and JY.Person[pid]["专1"] == 126 then
	   a1 = 3
	end
	
	--玉箫剑法，配合桃花绝技范围增加
	if wugong == 38 and level == 11 and TaohuaJJ(pid) then
		a2 = 8 + MiaofaWX
		a3 = a2 - 1
		a4 = a3 - 1
	end
	--落英神剑掌，配合桃花绝技可移动
	if wugong == 12 and level == 11 and TaohuaJJ(pid) then
		m1 = 0
		m2 = 6
	end
	--玄铁可移动
	if wugong == 45 then
		m1 = 1
		m2 = 5
	end
	
	--雪山剑法
	if wugong == 35 and JY.Person[pid]["专1"] == 35 then
		m1 = 0
		m2 = 6
	end

	--[[降龙不可移动
	if wugong == 26 then
		m1 = 2
		m2 = 0
	end]]
	
	--须弥山神掌
	if wugong == 24 and level == 11 then
	   if (WAR.LQZ[pid] == 100 and match_ID(pid, 673) == false) or ((match_ID(pid, 673) and WAR.SYBD[pid] ~= nil)) then
	      m1 = 1
		  m2 = 5
		  a1 = 3
		  a2 = 5
		  a3 = 5
	   else
          m1 = 1
		  m2 = 15
		  a1 = 0
		  a2 = 1	   
	   end
	end
	--黑风
	if wugong == 131 and JY.Person[pid]["专1"] == 131 then
	      m1 = 1
		  m2 = 0
		  a1 = 3
		  a2 = 6
		  a3 = 6
	end
	if wugong == 133 and JY.Person[pid]["专2"] == 133 then
	      m1 = 1
		  m2 = 5
		  a1 = 3
		  a2 = 4 + MiaofaWX
		  a3 = 4 + MiaofaWX
	end
	if wugong == 76 then
	   m1 = 1
	   m2 = 6 + MiaofaWX
	   a1 = 2
	   a2 = MiaofaWX
	   if MiaofaWX > 3 then
	   a2 = 3
	   end
	   a3 = a2
	end
	
	--ahlj
	if wugong == 219 then
          m1 = 1
		  m2 = 10
		  a1 = 0
		  a2 = 1	   
	end
	if wugong == 223 then
	   m1 = 3
		a1 = 10
		a2 = 10 + MiaofaWX
		a3 = 9 + MiaofaWX
		a4 = 9 + MiaofaWX
	end
	
	--黯然
	if wugong == 25 and level == 11 then
	      m1 = 1
		  m2 = 5
		  a1 = 3
		  a2 = 3
		  a3 = 3
	end
	
	--m1为移动范围斜向延伸：
	--0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
  --m2为移动范围直线延伸；
	--数字即等于延伸距离
  --a1为攻击范围类型：
	--0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：d字，9：e字，10：直线，11：正三角，12：倒三角，13：横线
  --a2为攻击范围长度距离：
	--0：点攻，大于0时，距离 = a2
  --a3为攻击范围宽度(偏移1格)距离：
	--0：点攻，大于0时，距离 = a3  
  --a4为攻击范围宽度(偏移2格)距离：
	--0：点攻，大于0时，距离 = a4
  --a5为攻击范围宽度(偏移3格)距离：
	--0：点攻，大于0时，距离 = a5
	--
	if wugong == 9 and JY.Person[pid]["专1"] == 9 then
	   a1 = 3
	   a2 = a2 + 1 + MiaofaWX
	   a3 = a3 + 1 + MiaofaWX
	   
	end
	--野球拳
	if wugong == 214 then
          m1 = 2
		  m2 = 1
		  a1 = 0	   
	end
	
	--霹雳刀法
	if wugong == 215 then
          m1 = 0
		  m2 = 7
		  a1 = 2
          a2 = 7
          a3 = 7		  
	end
	
	if wugong == 31 and match_ID(pid, 23) and JY.Person[23]["阶"] >= 1 then
          m1 = 0
		  m2 = 5
		  a1 = 3
          a2 = 5
          a3 = 5		  
	end
	
	--噬魂
	if wugong == 209 then
          m1 = 1
		  m2 = 11
		  a1 = 0
		  a2 = 1	   
	end
	--金刚国裂斩
	if wugong == 210 then
          m1 = 1
		  m2 = 0
		  a1 = 2
		  a2 = 9
		  a3 = 9	   
	end
	
	--豪鬼
	if wugong == 203 then
	a1 = 0
	m1 = 1
	m2 = 3
	--豪升龙
	if WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 50 then
	    m2 = m2 + 6 + MiaofaWX
       if JY.Person[673]["外号2"] == "怒" then
	    m2 = m2 + 6
	   else
        a1 = 3
	    m1 = 1
	    m2 = 5
	    a2 = 3 + MiaofaWX
        a3 = 3 + MiaofaWX
       end
    end
	end
	
	--豪鬼
	if wugong == 202 then
	a1 = 3
	m1 = 1
	m2 = 7
	a2 = 2
    a3 = 2
	--灭杀豪波动
	if WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 50 then
	   if JY.Person[673]["外号2"] == "怒" then
	    m1 = 3
		a1 = 10
		a2 = 14 + MiaofaWX
		a3 = 14 + MiaofaWX
		a4 = 14 + MiaofaWX
		a5 = 14 + MiaofaWX
	   else
         a2 = 3 + MiaofaWX
         a3 = 3 + MiaofaWX
       end		 
    end
	end
	if wugong == 205 then
	   a1 = 2
	   a2 = 4
	   a3 = 4
	end

	if Curr_NG(pid, 213) then	  
	   m2 = m2 + 3
	end
   
	
	--瞬狱杀
	if wugong == 204 then
	   m1 = 2
	   m2 = 10
	   a1 = 0
	end

	--乔峰降龙可移动	
	if match_ID(pid, 50) and wugong == 26 then
		m1 = 1
		m2 = 5
	end	
		
	--进阶万花，范围+1
	if wugong == 30 and PersonKF(pid,175) then
		a2 = a2 + 1
		a3 = a2
	end
	if wugong == 49 and match_ID(pid, 687) and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		m1, m2, a1, a2, a3, a4 = LiuMaiZhaoShi(pid,MiaofaWX)
	end
	--莫名剑法手动选择范围
	if wugong == 199 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		m1, m2, a1, a2, a3, a4 = MoMing(pid,MiaofaWX)
	end
	--辟邪剑法手动选择范围
	if wugong == 48 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		m1, m2, a1, a2, a3, a4 = BiXieZhaoShi(pid,MiaofaWX)
	end
	--云十掌
	if wugong == 221 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		m1, m2, a1, a2, a3, a4 = YunShiZ(pid,MiaofaWX)
	end
	if wugong == 222 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		m1, m2, a1, a2, a3, a4 = YunShiJ(pid,MiaofaWX)
	end
	--傲寒六诀
	if wugong == 217 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		m1, m2, a1, a2, a3, a4 = AoHanZhaoShi(pid,MiaofaWX)
	end
	if wugong == 217 and not inteam(pid) then
	    m1 = 3
		a1 = 10
		a2 = 10 + MiaofaWX
		a3 = 10 + MiaofaWX
		a4 = 10 + MiaofaWX
		a5 = 10 + MiaofaWX
	end
	
	if wugong == 29 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and WAR.AXFJ == 0 then
		m1, m2, a1, a2, a3, a4 = SanFenZhaoShi(pid,MiaofaWX)
	end
	--太玄神功手动选择系数
	if wugong == 102 and (match_ID_awakened(pid, 38, 1) or JY.Person[pid]["专2"] == 102) and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 then
		TaiXuanZhaoShi()
	end
	if JY.Wugong[wugong]["武功类型"] == 4 and JY.Person[pid]["专2"] == 215 then
          m1 = 0
		  m2 = 7
		  a1 = 2
          a2 = 7
          a3 = 7		  
	end
	if JY.Person[681]["天4"] == 2 and match_ID(pid, 681) then
	   m2 = m2 + MiaofaWX
	end
	if JY.Person[682]["天3"] == 2 and match_ID(pid, 682) then
	   m2 = m2 + MiaofaWX
	end

	if m2 ~= nil and m2 < 0 then
	   m2 = 0
	end
	if a2 ~= nil and a2 < 1 then
	   a2 = 0
	end
	if a3 ~= nil and a3 < 1 then
	   a3 = 0
	end
	if a4 ~= nil and a4 < 1 then
	   a4 = 0
	end
	if a5 ~= nil and a5 < 1 then
	   a5 = 0
	end
	return m1, m2, a1, a2, a3, a4, a5
end

--用CC表判断人物是否为队友，不管在不在队
function isteam(p)
	local r = false
	for i,v in pairs(CC.PersonExit) do
		if v[1] == p then
			r = true
			break;
		end
	end
	if p == 0 then
		r = true
	end
	return r;
end

--判断人物是否有某种武功
function PersonKF(p, kf)
	for i = 1, JY.Person[671]["品德"] do
		if JY.Person[p]["武功" .. i] <= 0 then
			return false;
		elseif JY.Person[p]["武功" .. i] == kf then
			return true
		end
	end
	return false
end

--判断人物是否有某种武功，并且等级为极
function PersonKFJ(p, kf)
	for i = 1, JY.Person[671]["品德"] do
		if JY.Person[p]["武功" .. i] == -1 then
			return false;
		elseif JY.Person[p]["武功" .. i] == kf and JY.Person[p]["武功等级" .. i] == 999 then
			return true
		end
	end
	return false
end

--判断触发机率
function myrandom(p, id)
	--生命越低，几率越高，最多10
	p = p + math.modf((JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])/100 + 1)
	
	--体力越高，几率越高，最多10
	p = p + math.modf(JY.Person[id]["体力"] / 10)
	
	--林朝英+10
	if match_ID(id, 605) then
		p = p + 10
	end

	--逆运走火+20
	if WAR.tmp[1000 + id] == 1 then
		p = p + 20
	end

	--每25点实战+1，上限20
	local jp = math.modf(JY.Person[id]["实战"] / 25 + 1)
	if jp > 20 then
		jp = 20
	end
	p = p + jp

	--每500内力+1，最多20
	p = p + limitX(math.modf(JY.Person[id]["内力"] / 500), 0, 20)
	
	--每50点攻击力+1，最多10
	p = p + limitX(math.modf(JY.Person[id]["攻击力"] / 50), 0, 10)
	
	--每50点防御力+1，最多10
	p = p + limitX(math.modf(JY.Person[id]["防御力"] / 50), 0, 10)
	
	--每50点轻功+1，最多10
	p = p + limitX(math.modf(JY.Person[id]["轻功"] / 50), 0, 10)
	
	--基础判定次数为一次
	local times = 1
	--如果是我方
	if inteam(id) then
		--我方天书增加几率
		p = p + JY.Base["天书数量"]
		--50%几率二次判定
		if math.random(2) == 2 then
			times = 2
		end
		--石破天必定二次判定
		if (match_ID(id, 38) or match_ID(id, 677) or match_ID(id, 684) or match_ID(id, 636) or (JY.Person[601]["阶"] >= 1 and match_ID(pid, 601))) and times == 1 then
			times = 2
		end
		if JY.Person[642]["血量翻倍"] == 1 then
			times = 3
			p = p + 60
		end
	--NPC默认为三次判定且几率+60
	else
		times = 3
		p = p + 60
	end
	if JY.Person[id]["地10"] == 2 then
	   times = 4
	end

	for i = 1, times do
		local bd = math.random(120)
		if bd <= p then
			return true
		end
	end
	return false
end


--自动选择敌人
function War_AutoSelectEnemy()
	local enemyid = War_AutoSelectEnemy_near()
	WAR.Person[WAR.CurID]["自动选择对手"] = enemyid
	return enemyid
end

--选择最近敌人
function War_AutoSelectEnemy_near()
	War_CalMoveStep(WAR.CurID, 100, 1)			--标记每个位置的步数
	local maxDest = math.huge
	local nearid = -1
	for i = 0, WAR.PersonNum - 1 do		--查找最近步数的敌人
		if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false then
			local step = GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 3)
			if step < maxDest then
				nearid = i
				maxDest = step
			end
		end
	end
	return nearid
end

--无酒不欢：判定合击用的函数
function between(num_1, num_2, num_3, flag)
    if not flag then
		flag = 0
    end
    if num_3 < num_2 then
		num_2, num_3 = num_3, num_2
    end
    if flag == 0 and num_2 < num_1 and num_1 < num_3 then
		return true
    elseif flag == 1 and num_2 <= num_1 and num_1 <= num_3 then
		return true
    else
		return false
    end
end


--无酒不欢：独孤求败反击的伤害判定
function First_strike_dam_DG(pid, eid)
	local dam;
	local YJ_dif = (TrueYJ(pid)* 1.5 - TrueYJ(eid))*5/1000
	local p_wc = JY.Person[pid]["武学常识"]
	local e_wc = JY.Person[eid]["武学常识"]
	if p_wc < e_wc then
		p_wc = e_wc
	end
	dam = (JY.Person[pid]["攻击力"]-JY.Person[eid]["防御力"])+(p_wc-e_wc)+(getnl(pid)/50-getnl(eid)/50)
	dam = math.modf(dam * YJ_dif)
	if dam < 30 then
	   dam = 30
	end
	if not inteam(pid) and dam > 290 then
	   dam = 290 + math.random(10)
	end
	if JY.Person[pid]["专2"] == 187 then
	   dam = dam + 10
	end
	if dam > 499 then
	   dam = 499 + math.modf((dam - 499)^0.98)
	    if dam > 999 then
		   dam = 999 + math.modf((dam - 999)^0.9)
		   if dam > 1999 then
		      dam = 1999 + math.modf((dam - 1999)^0.95)
		   end
		end
	end
	return dam
end
--西门吹雪
function First_strike_dam_XM(pid, eid)
   local dam
   local yjc = TrueYJ(pid)*2 - TrueYJ(eid)
   if yjc < 1 then
      yjc = 1
   end
   local atkb = JY.Person[pid]["攻击力"]*1.5-JY.Person[eid]["防御力"]
   dam = yjc + atkb
   if dam < 150 then
	  dam = 150
   end
   dam = dam + math.random(20)
   return dam
end

function First_strike_dam_WJJ(pid, eid)
	local dam;
	local YJ_dif = TrueYJ(pid)
	dam = JY.Person[pid]["攻击力"]+getnl(pid)/50+YJ_dif
	dam = math.modf(dam*0.5)
	if dam<30 then
	dam=30
	end
	if JY.Person[pid]["专2"] == 194 then
	   dam = dam + 100
	end
	return dam
end

--万剑归宗
function First_strike_dam_WM(pid, eid)  
	local dam = (TrueYJ(pid) - TrueYJ(eid))*0.02
	if dam > 10 then
	   dam = 10 + (TrueYJ(pid) - TrueYJ(eid) - 500)*0.01
	end
	if dam < 4 then
	   dam = 4
	end
	if JY.Person[pid]["专1"] == 198 then
	   dam = dam + 7
	end
	if not inteam(pid) then
	   dam = dam*0.7
	end
	dam = math.modf(dam)
	return dam
end

--伤害公式中的内力，当前内力和最大内力都参与计算
function getnl(id)
	return (JY.Person[id]["内力"] * 2 + JY.Person[id]["内力最大值"]) / 3
end

--战斗中查看敌方简易信息
function MapWatch()
	local x = WAR.Person[WAR.CurID]["坐标X"];
	local y = WAR.Person[WAR.CurID]["坐标Y"];
	WAR.ShowHead = 0
	War_CalMoveStep(WAR.CurID,128,1);
	WarDrawMap(1,x,y);
	ShowScreen();
	x,y=War_SelectMove()
	if x == nil then
		return
	end
	WAR.ShowHead = 1
end

--无酒不欢：等待指令
function War_Wait()
	local id = WAR.Person[WAR.CurID]["人物编号"]
	WAR.Wait[id] = 1
	Cls()
  	CurIDTXDH(WAR.CurID, 72, 1, "伺机待发", LightGreen, 15)
	--穆人清等待时蓄力
	if match_ID(id, 185) then
		WAR.Actup[id] = 2
	end
  	return 1
end

--集中指令
function War_Focus()
	local id = WAR.Person[WAR.CurID]["人物编号"]
	WAR.Focus[id] = 1
	Cls()
  	CurIDTXDH(WAR.CurID, 151, 1, "心念合一", C_GOLD)
  	return 20
end

--无酒不欢：撤退
function War_Retreat()
	local id = WAR.Person[WAR.CurID]["人物编号"]
	local r = JYMsgBox(JY.Person[id]["姓名"], "确定要我撤退吗？", {"否","是"}, 2, WAR.tmp[5000+WAR.CurID])
	if r == 2 then
		WAR.Person[WAR.CurID]["死亡"] = true
		return 1
	end
end

--无酒不欢：常态血条显示
function HP_Display_When_Idle()
    local x0 = WAR.Person[WAR.CurID]["坐标X"];
    local y0 = WAR.Person[WAR.CurID]["坐标Y"];
	for k = 0, WAR.PersonNum - 1 do
		local tmppid = WAR.Person[k]["人物编号"]
		if WAR.Person[k]["死亡"] == false then
			local dx = WAR.Person[k]["坐标X"] - x0
			local dy = WAR.Person[k]["坐标Y"] - y0

			local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
			local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
	 
			local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
					ry = ry - hb - CC.YScale*7
					
			local pid = WAR.Person[k]["人物编号"]

			local Color = RGB(238,44, 44)
			local Color2 = RGB(255,255, 200)
			local Color3 = RGB(151,255, 246)
			--local Color1 = RGB(30, 144, 255)
			
			local HP_MAX = JY.Person[pid]["生命最大值"]
			
			local Current_HP = JY.Person[pid]["生命"]
			
			if Current_HP < 0 then
				Current_HP = 0
			end

			--友军NPC显示为绿色血条
			if WAR.Person[k]["我方"] == true then
				Color = RGB(0, 238, 0)
			end

			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx+CC.XScale*1.4, ry-CC.YScale*15/9,grey21)	--背景
			if WAR.LHHF[pid] ~= nil and match_ID(pid, 673) then
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx-CC.XScale*1.4+((WAR.LHHF[pid]+Current_HP)/HP_MAX)*(2.8*CC.XScale), ry-CC.YScale*15/9, Color2)
			end
			if WAR.Siphon[pid] ~= nil then
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*25/9, rx-CC.XScale*1.4+(WAR.Siphon[pid]/1000)*(2.8*CC.XScale), ry-CC.YScale*19/9, Color3)---------siphon
			DrawBox3(rx-CC.XScale*1.4, ry-CC.YScale*25/9, rx+CC.XScale*1.4, ry-CC.YScale*19/9, C_BLACK)
			end
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx-CC.XScale*1.4+(Current_HP/HP_MAX)*(2.8*CC.XScale), ry-CC.YScale*15/9, Color)  --生命
			
			DrawBox3(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx+CC.XScale*1.4, ry-CC.YScale*15/9, C_BLACK)
			
			
		end
	end
end

--内力显示
function MP_Display_When_Idle()
    local x0 = WAR.Person[WAR.CurID]["坐标X"];
    local y0 = WAR.Person[WAR.CurID]["坐标Y"];
	for k = 0, WAR.PersonNum - 1 do
		local tmppid = WAR.Person[k]["人物编号"]
		if WAR.Person[k]["死亡"] == false then
			local dx = WAR.Person[k]["坐标X"] - x0
			local dy = WAR.Person[k]["坐标Y"] - y0

			local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
			local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
	 
			local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
					ry = ry - hb - CC.YScale*7
					
			local pid = WAR.Person[k]["人物编号"]

			local Color = RGB(100, 216, 230)
			
			
			local MP_MAX = JY.Person[pid]["内力最大值"]
			      if MP_MAX <= 0 then
				     MP_MAX = 1
				  end
			
			local Current_MP = JY.Person[pid]["内力"]
			
			local nq = WAR.LQZ[pid]
			if nq == nil then
			   nq = 0
			end   
			local Color1 = RGB(255, math.modf(255-nq*2), 0)
			if Current_MP < 0 then
				Current_MP = 0
			end

			if WAR.Person[k]["我方"] == true then
				Color = RGB(0, 0, 238)
			end

			
			
			if JY.Person[125]["天2"] == 0 then
			if JY.Person[125]["天1"] == 1 then
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*15/9, rx+CC.XScale*1.4, ry-CC.YScale*12/9,grey21)	--背景
			
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*15/9, rx-CC.XScale*1.4+(nq/100)*(2.8*CC.XScale), ry-CC.YScale*12/9, Color1) --nq
			
			DrawBox3(rx-CC.XScale*1.4, ry-CC.YScale*15/9, rx+CC.XScale*1.4, ry-CC.YScale*12/9, C_BLACK)
			else
			
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*12/9, rx+CC.XScale*1.4, ry-CC.YScale,grey21)	--背景
			
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*12/9, rx-CC.XScale*1.4+(nq/100)*(2.8*CC.XScale), ry-CC.YScale, Color1) --nq
			
			DrawBox3(rx-CC.XScale*1.4, ry-CC.YScale*12/9, rx+CC.XScale*1.4, ry-CC.YScale, C_BLACK)
			end
			end
			
			if JY.Person[125]["天1"] == 0 then
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*15/9, rx+CC.XScale*1.4, ry-CC.YScale*12/9,grey21)	--背景
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*15/9, rx-CC.XScale*1.4+(Current_MP/MP_MAX)*(2.8*CC.XScale), ry-CC.YScale*12/9, Color)  --内力
		
			DrawBox3(rx-CC.XScale*1.4, ry-CC.YScale*15/9, rx+CC.XScale*1.4, ry-CC.YScale*12/9, C_BLACK)
			end
		end
	end
end

function NewWARPersonZJ(id, dw, x, y, life, fx)
	WAR.Person[WAR.PersonNum]["人物编号"] = id
	WAR.Person[WAR.PersonNum]["我方"] = dw
	WAR.Person[WAR.PersonNum]["坐标X"] = x
	WAR.Person[WAR.PersonNum]["坐标Y"] = y
	WAR.Person[WAR.PersonNum]["死亡"] = life
	WAR.Person[WAR.PersonNum]["人方向"] = fx
	WAR.Person[WAR.PersonNum]["贴图"] = WarCalPersonPic(WAR.PersonNum)
	lib.PicLoadFile(string.format(CC.FightPicFile[1], JY.Person[id]["头像代号"]), string.format(CC.FightPicFile[2], JY.Person[id]["头像代号"]), 4 + WAR.PersonNum)
	WAR.tmp[5000+WAR.PersonNum] =  JY.Person[id]["头像代号"]
	WAR.JQSDXS[id] = 0
	SetWarMap(x, y, 2, WAR.PersonNum)
	SetWarMap(x, y, 5, WAR.Person[WAR.PersonNum]["贴图"])
	WAR.PersonNum = WAR.PersonNum + 1
	JY.Person[id]["受伤程度"] = 0
	JY.Person[id]["中毒程度"] = 0
	JY.Person[id]["冰封程度"] = 0
	JY.Person[id]["灼烧程度"] = 0
	WAR.FXXS[id]=0
	WAR.LXXS[id]=0
end

--无酒不欢：挨打掉血显示
function HP_Display_When_Hit(ssxx)
    local x0 = WAR.Person[WAR.CurID]["坐标X"];
    local y0 = WAR.Person[WAR.CurID]["坐标Y"];
	--掉血渐变显示			
	ssxx = ssxx - 4
	for k = 0, WAR.PersonNum - 1 do
		local tmppid = WAR.Person[k]["人物编号"]
		--血量有变化才显示
		if WAR.Person[k]["死亡"] == false and WAR.Person[k]["生命点数"] ~= nil and WAR.Person[k]["生命点数"] ~= 0 then
			local dx = WAR.Person[k]["坐标X"] - x0
			local dy = WAR.Person[k]["坐标Y"] - y0

			local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
			local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
	 
			local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
					ry = ry - hb - CC.YScale*7
					
			local pid = WAR.Person[k]["人物编号"]

			local Color = RGB(238,44, 44)
			--local Color1 = RGB(30, 144, 255)
			
			--计算掉血
			local HP_MAX = JY.Person[pid]["生命最大值"]
			
			local HP_AfterHit = JY.Person[pid]["生命"]
			
			if HP_AfterHit < 0 then
				HP_AfterHit = 0
			end
				
			local HP_BeforeHit = WAR.Person[k]["Life_Before_Hit"] or 0

			local HP_Loss = HP_BeforeHit - HP_AfterHit
			
			local Gradual_HP_Loss;
			local Gradual_HP_Display;
			
			Gradual_HP_Loss = HP_Loss*(ssxx/11)
			Gradual_HP_Display = HP_BeforeHit - Gradual_HP_Loss
			
			
			--友军NPC显示为绿色血条
			if WAR.Person[k]["我方"] == true then
				Color = RGB(0, 238, 0)
			end
			
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx+CC.XScale*1.4, ry-CC.YScale*15/9,grey21)	--背景
			
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx-CC.XScale*1.4+(HP_AfterHit/HP_MAX)*(2.8*CC.XScale), ry-CC.YScale*15/9, Color)  --生命
			
			--掉血显示
			if HP_Loss > 0 then
				lib.FillColor(rx-CC.XScale*1.4+(HP_AfterHit/HP_MAX)*(2.8*CC.XScale), ry-CC.YScale*20/9, rx-CC.XScale*1.4+(Gradual_HP_Display/HP_MAX)*(2.8*CC.XScale), ry-CC.YScale*15/9, Color)  --失去生命
			end
		
			DrawBox3(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx+CC.XScale*1.4, ry-CC.YScale*15/9, C_BLACK)
		end
	end
end

--苍天泰坦：被战场显血函数调用
function DrawBox3(x1, y1, x2, y2, color)
	lib.DrawRect(x1, y1, x2, y1, color)
	lib.DrawRect(x1, y2, x2, y2, color)
	lib.DrawRect(x1, y1, x1, y2, color)
	lib.DrawRect(x2, y1, x2, y2, color)
	--无酒不欢：生命和内力的分隔线
	--lib.DrawRect(x1, y1+(y2-y1)/2+1, x2, y1+(y2-y1)/2+1, color)
end

WE_xy = function(x, y, id)				-- 看看xy位置是否可以放一个人物
	if id ~= nil then
		War_CalMoveStep(id, 128, 0)
	else
		CleanWarMap(3, 0)
	end
	if GetWarMap(x, y, 3) ~= 255 and War_CanMoveXY(x, y, 0) then	-- 255代表移动不过去，War_CanMoveXY代表土地层该位置有建筑物或水，或人物层该位置有人
		return x, y
	else
		for s = 1, 128 do
			for i = 1, s do
				local j = s - i
				if x + i < 63 and y + j < 63 and GetWarMap(x + i, y + j, 3) ~= 255 and War_CanMoveXY(x + i, y + j, 0) then
					return x + i, y + j
				end
				if x + j < 63 and y - i > 0 and GetWarMap(x + j, y - i, 3) ~= 255 and War_CanMoveXY(x + j, y - i, 0) then
					return x + j, y - i
				end
				if x - i > 0 and y - j > 0 and GetWarMap(x - i, y - j, 3) ~= 255 and War_CanMoveXY(x - i, y - j, 0) then
					return x - i, y - j
				end
				if x - j > 0 and y + i < 63 and GetWarMap(x - j, y + i, 3) ~= 255 and War_CanMoveXY(x - j, y + i, 0) then
					return x - j, y + i
				end
			end
		end
	end
	for s = 1, 128 do
		for i = 1, s do
			local j = s - i
			if x + i < 63 and y + j < 63 and War_CanMoveXY(x + i, y + j, 0) then
				return x + i, y + j
			end
			if x + j < 63 and y - i > 0 and War_CanMoveXY(x + j, y - i, 0) then
				return x + j, y - i
			end
			if x - i > 0 and y - j > 0 and War_CanMoveXY(x - i, y - j, 0) then
				return x - i, y - j
			end
			if x - j > 0 and y + i < 63 and War_CanMoveXY(x - j, y + i, 0) then
				return x - j, y + i
			end
		end
	end
	return x, y
end

--显示出招动画的选择出战人物界面
function WarSelectTeam_Enhance()
	if JY.Restart == 1 then
		do return end
	end
	local T_Num=GetTeamNum();
	--无酒不欢：高度以3为单位增加
	local h_factor = 3
	if T_Num > 12 then
		h_factor = 15
	elseif T_Num > 9 then
		h_factor = 12
	elseif T_Num > 6 then
		h_factor = 9
	elseif T_Num > 3 then
		h_factor = 6
	end
	local p={};
	local pic_w=CC.ScreenW/6--160;
	local pic_h=CC.ScreenW/6*3/4--128;
	local width=pic_w*3+CC.DefaultFont*5+4*8;
	local height=math.max((h_factor+2)*(CC.DefaultFont+4)+4*3,pic_h*math.modf((h_factor+1)/4))+CC.FontBig;
	local x=(CC.ScreenW-width)/2;
	local y=(CC.ScreenH-height-4*2)/2+CC.FontBig/2+8;
	local x0=x+4*4;
	local x1=x0+4;
	local y1=(CC.ScreenH-((T_Num+2)*(CC.DefaultFont+4)+4*3))/2;
	local x2=x0+4*3+CC.DefaultFont*5+pic_w/2
	local y2=y;
	local ts=(width-(CC.FontBig*4+16)*2)/3;
	local tx1=x+ts+4;
	local tx2=tx1+(CC.FontBig*4+16)+ts;
	local ty=y+pic_h+30+CC.DefaultFont;
	
		for h=1,6 do
			local wd = WAR.Data["自动选择参战人" .. h]	
			if wd > 0 then
				--畅想的情况，畅想主角会取代强制出战的队友
				if wd == JY.Base["畅想"] then
			       WAR.Data["自动选择参战人" .. h] = -1
				end
				if wd > 0 and JY.Base["单通"] ~= 1 then
				   local wh = JYMsgBox("是否使用主角代替出战", "               ",{"是","否"},2,JY.Person[0]["头像代号"])
				   if wh == 1 then
				   WAR.Data["自动选择参战人1"] = 0
				     for i = 2, 6 do
			           WAR.Data["自动选择参战人" .. i] = -1
		             end
				   end
				   break
				end
			end		
		end	
	
	--单通模式
	if JY.Base["单通"] == 1 and WAR.ZDDH ~= 330 then
		WAR.Data["自动选择参战人1"] = 0
		for i = 2, 6 do
			WAR.Data["自动选择参战人" .. i] = -1
		end
			if JY.Base["畅想"]==147 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 147 or JY.Person[685]["天2"] == 147 or JY.Person[685]["天3"] == 147)) then
			WAR.Data["自动选择参战人2"] = 143
			WAR.Data["自动选择参战人3"] = 144
			WAR.Data["自动选择参战人4"] = 145
			WAR.Data["自动选择参战人5"] = 146
			WAR.Data["自动选择参战人6"] = 148	
	        end
			if JY.Base["畅想"]== 41 or (JY.Base["畅想"] == 685 and (JY.Person[685]["天1"] == 41 or JY.Person[685]["天2"] == 41 or JY.Person[685]["天3"] == 41)) then
			WAR.Data["自动选择参战人2"] = 42	
	        end

	end
			if WAR.ZDDH == 329 then
			local dy = {}
            for i = 1, 20 do
            if JY.Person[250+i]["声望"] > 0 then
               table.insert(dy,JY.Person[250+i]["声望"])
	        end
            end
            for i = 1, #dy do
                 WAR.Data["自动选择参战人"..i] = dy[i]
            end
            end
	
	--剪裁的背景图
	--没有自动选择出战人时才显示
	--单挑陈达海战特殊判定
	if WAR.Data["自动选择参战人1"] == -1 and not (WAR.ZDDH == 92 and GetS(87,31,33,5) == 1) then
		Clipped_BgImg((CC.ScreenW - width) / 2,(CC.ScreenH - height) / 2,(CC.ScreenW + width) / 2,(CC.ScreenH + height) / 2,1000)
		Clipped_BgImg((CC.ScreenW - (CC.DefaultFont+4)*4) / 2,(CC.ScreenH - height) / 2-(CC.DefaultFont+4)/2,(CC.ScreenW + (CC.DefaultFont+4)*4) / 2,(CC.ScreenH - height) / 2+(CC.DefaultFont+4)/2,1000)
	end
	for i=1,T_Num do
		local pid=JY.Base["队伍"..i];
		if pid <0 then
			break;
		end
	  
	  --冰糖恋：单挑陈达海
		if WAR.ZDDH == 92 and GetS(87,31,33,5) == 1 then
			WAR.Data["自动选择参战人1"] = 0;
			WAR.Data["我方X1"] = 33
			WAR.Data["我方Y1"] = 24
		end
		
		--战三渡，如果周芷若在队则周芷若必出战
		if WAR.ZDDH == 253 and inteam(631) and JY.Base["单通"] ==0 then
			WAR.Data["手动选择参战人2"] = 631
		end
		
		--畅想杨过绝情谷两战
		if (WAR.ZDDH == 272 or WAR.ZDDH == 273) and JY.Base["畅想"] == 58 and JY.Base["单通"] ==0 then
			WAR.Data["自动选择参战人2"] = 59
			WAR.Data["自动选择参战人3"] = 628
		end
		
		if WAR.ZDDH == 275 and JY.Base["单通"] ==0 then
			if JY.Base["畅想"] == 58 then
			WAR.Data["自动选择参战人1"] = 0
			WAR.Data["自动选择参战人2"] = 59
			WAR.Data["自动选择参战人3"] = 628
			else
			WAR.Data["自动选择参战人1"] = 0
			WAR.Data["自动选择参战人2"] = 59
			WAR.Data["自动选择参战人3"] = 58
			end		
		end	

			
		for i = 1, 6 do
			local id = WAR.Data["自动选择参战人" .. i]
			if id >= 0 then
				--畅想的情况，畅想主角会取代强制出战的队友
				
				if id == JY.Base["畅想"] then
					WAR.Person[WAR.PersonNum]["人物编号"] = 0
				else
					WAR.Person[WAR.PersonNum]["人物编号"] = id
				end
				WAR.Person[WAR.PersonNum]["我方"] = true
				WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["我方X" .. i]
				WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["我方Y" .. i]
				WAR.Person[WAR.PersonNum]["死亡"] = false
				WAR.Person[WAR.PersonNum]["人方向"] = 2
				--无酒不欢：调整战斗初始面向
				--战海大富
				if WAR.ZDDH == 259 then
					WAR.Person[WAR.PersonNum]["人方向"] = 1
				end
				--双挑公孙止
				if WAR.ZDDH == 273 then
					WAR.Person[WAR.PersonNum]["人方向"] = 1
				end
				--杨过单金轮
				if WAR.ZDDH == 275 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--战杨龙
				if WAR.ZDDH == 75 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--蒙哥
				if WAR.ZDDH == 278 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--周芷若夺掌门
				if WAR.ZDDH == 279 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--单挑赵敏
				if WAR.ZDDH == 293 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--玄冥二老
				if WAR.ZDDH == 295 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--三挑岳不群
				if WAR.ZDDH == 298 then
					WAR.Person[WAR.PersonNum]["人方向"] = 1
				end
				--侠客邪
				if WAR.ZDDH == 170 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--拿洗髓
				if WAR.ZDDH == 305 then
					WAR.Person[WAR.PersonNum]["人方向"] = 1
				end
				WAR.PersonNum = WAR.PersonNum + 1
				WAR.MCRS = WAR.MCRS + 1
			end
		end

		if WAR.PersonNum > 0 and WAR.ZDDH ~= 235 then
			return 
		end

		lib.PicLoadFile(string.format(CC.FightPicFile[1],JY.Person[pid]["头像代号"]),
		string.format(CC.FightPicFile[2],JY.Person[pid]["头像代号"]), 4+i);
		local n=0;
		local m=0;
		for j=1,5 do
			if JY.Person[pid]['出招动画帧数'..j]>0 then
				if j>1 then
					m=j;
					break;
				end
				n=n+JY.Person[pid]['出招动画帧数'..j]
			end
		end
		p[i]= {id=pid, name=JY.Person[pid]["姓名"]; 
		Pic=n*8+JY.Person[pid]['出招动画帧数'..m]*6, PicNum=JY.Person[pid]['出招动画帧数'..m], idx=0, 
		x=x2+((i+3)%4)*pic_w, y=y2+math.modf((i+3)/4)*pic_h, x=x2+((i+2)%3)*pic_w, y=y2+math.modf((i+2)/3)*pic_h, picked=0,
		};
		--无酒不欢：强制出战的队友
		for j = 1, 6 do
			if WAR.Data["手动选择参战人" .. j] == p[i].id then
				p[i].picked = 1
				WAR.MCRS = WAR.MCRS + 1
			end
		end
	end
	
	--战三渡
	if WAR.ZDDH == 253 then
		WAR.MCRS = WAR.MCRS + 3
	end
	
	--逍遥御风 天池怪侠 太白诗仙 古墓黄杉 金蛇郎君
	--限定1人
	if WAR.ZDDH == 281 or WAR.ZDDH == 283 or WAR.ZDDH == 284 or WAR.ZDDH == 285 or WAR.ZDDH == 286 then
		WAR.MCRS = WAR.MCRS + 5
	end
	
	--刀剑合璧
	--限定2人
	if WAR.ZDDH == 280 then
		WAR.MCRS = WAR.MCRS + 4
	end
	if WAR.ZDDH >= 316 and WAR.ZDDH < 320 then
		WAR.MCRS = WAR.MCRS + 3
	end
 
	p[0]={name="全部选择"};

	if T_Num>6 then
		p[0]={name="自动选择"}
	end

	p[T_Num+1]={name="开始战斗"};
	local leader=-1;
	--无酒不欢：强制出战的预设leader
	for i=1,T_Num do
		if p[i].picked == 1 then
			leader = i
			break
		end
	end
	DrawBoxTitle(width,height,'出战准备',C_ORANGE);
	local select=1;
	local sid=lib.SaveSur(0,0,CC.ScreenW,CC.ScreenH);
	local function redraw(zdrs)
		lib.LoadSur(sid,0,0);
		DrawBox(x0,y1,x0+CC.DefaultFont*5+4*2,y1+CC.DefaultFont*(T_Num+2)+4*(T_Num+3),C_WHITE);
		for i=0,T_Num+1 do
			local str = p[i].name;
			--选中时的名字显示
			--小于7人，名字前显示√表示已选择
			--大于等于7人，名字前显示×表示需要取消方可开始战斗
			if i > 0 and i < T_Num+1 and p[i].picked > 0 then
				if zdrs < 7 then
					str="√"..str;
				else
					str="×"..str
				end
			--未选中的只显示名字
			else
				str=" "..str;
			end
			if select==i then
				lib.Background(x1,y1+(CC.DefaultFont+4)*(i)+4,x1+CC.DefaultFont*5,y1+(CC.DefaultFont+4)*(i+1),128,C_ORANGE)
				DrawString(x1,y1+(CC.DefaultFont+4)*(i)+4,str,C_WHITE,CC.DefaultFont,C_ORANGE);
			elseif i>0 and i<=T_Num then
				DrawString(x1,y1+(CC.DefaultFont+4)*(i)+4,str,C_ORANGE,CC.DefaultFont);
			else
				DrawString(x1,y1+(CC.DefaultFont+4)*(i)+4,str,C_GOLD,CC.DefaultFont);
			end
		end
		for i=1,T_Num do
			local color;
			if p[i].picked > 0 then
				--DrawString(p[i].x-CC.DefaultFont,p[i].y-CC.DefaultFont/2,"出战",C_WHITE,CC.DefaultFont*2/3)
				color=C_WHITE;
				lib.PicLoadCache(4+i,p[i].Pic+p[i].idx*2,p[i].x,p[i].y)
				p[i].idx=p[i].idx+1;
				if p[i].idx>=p[i].PicNum then
					p[i].idx=0;
				end
			else
				color=M_Gray;
				lib.PicLoadCache(4+i,p[i].Pic,p[i].x,p[i].y)
				lib.PicLoadCache(4+i,p[i].Pic,p[i].x,p[i].y,6,180)
			end
		end
	end
	
	--local zdrs=0
	while true do
		if JY.Restart == 1 then
			break
		end
		redraw(WAR.MCRS);
		ShowScreen();
		lib.Delay(65);
		local k=lib.GetKey();
		if k==VK_UP then
			select=select-1;
		elseif k==VK_DOWN then
			select=select+1;
		elseif k==VK_SPACE or k==VK_RETURN then
			if select==0 then
				if p[0].name=="全部选择" or p[0].name=="自动选择" then
					local zrs=T_Num
					if zrs>6 then
						zrs=6
					end
					for i=1,zrs do
						if p[i].picked == 0 then
							p[i].picked=2;
							WAR.MCRS=WAR.MCRS+1
						end
					end
					if leader<0 then
						leader=1;
					end
					p[0].name="全部取消";
				elseif p[0].name=="全部取消" then
					for i=1,T_Num do
						if p[i].picked == 2 then
							p[i].picked=0;
							WAR.MCRS=WAR.MCRS-1
						end
					end
					leader=-1;
					--无酒不欢：强制出战的预设leader
					for i=1,T_Num do
						if p[i].picked == 1 then
							leader = i
							break
						end
					end
					p[0].name="全部选择"

					if T_Num>6 then
						p[0].name="自动选择"
					end
				end
			elseif select==T_Num+1 then
				if leader<0 then
					select=1;
				elseif WAR.MCRS>6 then
					select=1
				else
					local px={}
					local wz=0
					for i=1,T_Num do
						if p[i].picked > 0 then
							wz=wz+1
							px[wz]=i
						end
					end

					for i=1,wz do
						if px[i]~=nil then
							WAR.Person[WAR.PersonNum]["人物编号"]=JY.Base["队伍" ..px[i]]
							WAR.Person[WAR.PersonNum]["我方"]=true
							WAR.Person[WAR.PersonNum]["坐标X"]=WAR.Data["我方X"..i]
							WAR.Person[WAR.PersonNum]["坐标Y"]=WAR.Data["我方Y"..i]
							WAR.Person[WAR.PersonNum]["死亡"]=false
							WAR.Person[WAR.PersonNum]["人方向"]=2
							--无酒不欢：调整战斗初始面向
							--战海大富
							if WAR.ZDDH == 259 then
								WAR.Person[WAR.PersonNum]["人方向"] = 1
							end
							--双挑公孙止
							if WAR.ZDDH == 273 then
								WAR.Person[WAR.PersonNum]["人方向"] = 1
							end
							--杨过单金轮
							if WAR.ZDDH == 275 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--战杨龙
							if WAR.ZDDH == 75 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--蒙哥
							if WAR.ZDDH == 278 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--周芷若夺掌门
							if WAR.ZDDH == 279 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--单挑赵敏
							if WAR.ZDDH == 293 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--玄冥二老
							if WAR.ZDDH == 295 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--三挑岳不群
							if WAR.ZDDH == 298 then
								WAR.Person[WAR.PersonNum]["人方向"] = 1
							end
							--侠客邪
							if WAR.ZDDH == 170 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--拿洗髓
							if WAR.ZDDH == 305 then
								WAR.Person[WAR.PersonNum]["人方向"] = 1
							end
							WAR.PersonNum=WAR.PersonNum+1
						end
					end
					break;
				end
			else
				if p[select].picked == 2 then
					p[select].picked=0;
					WAR.MCRS=WAR.MCRS-1
					if leader==select then
						leader=-1;
						for i=1,T_Num do
							if p[i].picked > 0 then
								leader=i;
								break;
							end
						end
					end
					if leader==-1 then
						p[0].name="全部选择"

						if T_Num>6 then
							p[0].name="自动选择"
						end
					end
				elseif p[select].picked == 0 then
					p[select].picked=2;
					WAR.MCRS=WAR.MCRS+1
					if leader<0 then
						leader=select;
					end
					for i=1,T_Num do
						if p[i].picked == 0 then
							break;
						end
						if i==T_Num then
							p[0].name="全部取消";
						end
					end
				end
			end
		end
		if select<0 then
			select=T_Num+1;
		elseif select>T_Num+1 then
			select=0;
		end
	end
	lib.FreeSur(sid);
end

--葵花魅影
function kuihuameiying()
    if JY.Person[0]["防具"] == 304 or WAR.YLMB[0] ~= nil or WAR.PPWQ[0] ~= nil then
	   return false
	end
	local x, y
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["人物编号"] == 0 then
			x, y = WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]
			break
		end
	end
	local function vacant(x,y)
		local r = true
		if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
			r = false
	    elseif CC.SceneWater[lib.GetWarMap(x, y, 0)] ~= nil then
	       	r = false
	    end
		if x < 1 or x > 63 then
			r = false
		end
		if y < 1 or y > 63 then
			r = false
		end
		return r
	end
	local telx, tely = 0, 0
	local can_tele = 0
	for i = -3, 3 do
		for j = -3, 3 do
			if vacant(x+i,y+j) then
				telx, tely = x+i, y+j
				can_tele = 1
			end
		end
	end
	if can_tele == 1 then
		WarDrawMap(0)
		CurIDTXDH(WAR.CurID, 120, 1, "葵花魅影", C_GOLD)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
		WarDrawMap(0)
		WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = telx, tely
		WarDrawMap(0)
		CurIDTXDH(WAR.CurID, 120, 1, "葵花魅影", C_GOLD)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
		WarDrawMap(0)
		return true
	else
		return false
	end
end

--辟邪招式
function BiXieZhaoShi(id,MiaofaWX)
local yin, yang, tg = NeiL(id)
	WAR.BXZS = 0
	if not WAR.BXLQ[id] then
		WAR.BXLQ[id] = {0,0,0,0,0,0}
	end
	local add = 0
	if yang > 0 then
	   add = math.modf(yang/5)
	end   
	local zs={
	{name="指打奸邪",Usable=true,m1=1,m2=1,a1=1,a2=3+MiaofaWX+add,a3=3+MiaofaWX+add},
	{name="飞燕穿柳",Usable=true,m1=3,m2=1,a1=10,a2=8+MiaofaWX+add,a3=7+MiaofaWX+add,a4=6+MiaofaWX+add},
	{name="花开见佛",Usable=true,m1=0,m2=0,a1=5,a2=6+MiaofaWX+add,a3=3+MiaofaWX+add},
	{name="锺馗抉目",Usable=true,m1=0,m2=5,a1=2,a2=4+MiaofaWX+add},
	{name="扫荡群魔",Usable=true,m1=3,m2=1,a1=11,a2=7+MiaofaWX+add},
	{name="紫气东来",Usable=true,m1=0,m2=6,a1=3,a2=4+MiaofaWX+add,a3=4+MiaofaWX+add},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	if not PersonKF(id,105) then
		zs[5].Usable=false
		zs[6].Usable=false
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if WAR.BXLQ[id][i] > 0 then
				zs[i].Usable=false
			end
			if WAR.BXCD[i] == 0 then
			   zs[i].Usable=true
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(500, 520, "招式气攻："..CC.KFMove[48][choice][2], C_WHITE, size)
		if WAR.BXCD[choice] == 0 or match_ID(id, 36) then
			DrawString(500, 570, "冷却时间：无", C_WHITE, size)
		else
			DrawString(500, 570, "冷却时间："..WAR.BXCD[choice].."回合", C_WHITE, size)
		end
		if (choice == 6 or choice == 5) and not PersonKF(id,105) then
			DrawString(500, 620, "习得葵花神功后方可使用", C_WHITE, size)
		elseif WAR.BXLQ[id][choice] > 0 then
		local cd = WAR.BXLQ[id][choice]
		if WAR.BXLQ[id][choice] > WAR.BXCD[choice] then
		   cd = WAR.BXCD[choice]
		end
			DrawString(500, 620, "冷却中，"..cd.."回合后可再次使用", C_WHITE, size)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.BXZS = choice
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end

--傲寒六诀
function AoHanZhaoShi(id,MiaofaWX)
local pid = WAR.Person[WAR.CurID]["人物编号"]
local yin, yang, tg = NeiL(id)
local fx = yin + yang		   
	WAR.AHZS = 0
	if not WAR.AHLQ[id] then
		WAR.AHLQ[id] = {0,0,0,0,0,0}
	end  
	local zs={
	{name="惊寒一瞥",Usable=true,m1=3,m2=1,a1=10,a2=8+MiaofaWX,a3=7+MiaofaWX,a4=6+MiaofaWX},
	{name="冰封三尺",Usable=true,m1=0,m2=3+MiaofaWX,a1=1,a2=3+MiaofaWX,a3=3+MiaofaWX,a4=3+MiaofaWX},
	{name="红杏出墙",Usable=true,m1=0,m2=5,a1=2,a2=4+MiaofaWX,a3=4+MiaofaWX},
	{name="桃枝夭夭",Usable=true,m1=3,m2=1,a1=11,a2=7+MiaofaWX},
	{name="踏雪寻梅",Usable=true,m1=0,m2=5,a1=12,a2=4+MiaofaWX},
	{name="冷刃冰心",Usable=true,m1=1,m2=8,a1=0,a2=1},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	if JY.Base["天书数量"] < 1 then
			zs[3].Usable=false
	end
	if JY.Base["天书数量"] < 3 then
			zs[4].Usable=false
	end
	if JY.Base["天书数量"] < 5 then
			zs[5].Usable=false
	end
	if JY.Base["天书数量"] < 7 then
			zs[6].Usable=false
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if WAR.AHLQ[id][i] > 0 then
				zs[i].Usable=false
			end
			if WAR.AHCD[i] == 0 then
			   zs[i].Usable=true
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		local xs = 0
		local ng = 0
		local str
		if choice == 1 then
		   ng = math.ceil(JY.Person[pid]["耍刀技巧"]+600)
		   xs = math.ceil(JY.Person[pid]["耍刀技巧"]*2+500)
		   str = "寒绝，霸绝，直截了当的一招。"
		elseif choice == 2 then
		       ng = math.ceil(JY.Person[pid]["内力最大值"]*0.1+300)
			   if tg ~= 1 then
		          if fx < 0 then
		          ng = ng - fx*100
		          end
	           else
	              ng = ng - yin*100
	           end
		       xs = JY.Person[pid]["内力"]*0.1+JY.Person[pid]["耍刀技巧"]*0.8+300
		       str = "刀劲凝冰，厚逾三尺。"
		elseif choice == 3 then
	           ng = math.ceil(JY.Person[pid]["耍刀技巧"]+JY.Person[pid]["攻击力"]*1.5)
			   if WAR.LQZ[pid] ~= nil then
		       xs = JY.Person[pid]["耍刀技巧"]+750*(WAR.LQZ[pid]/75)^4 + 200
			   else
			   xs = JY.Person[pid]["耍刀技巧"]
               end
		       str = "刀恨意更恨。"
		elseif choice == 4 then
		       ng = math.ceil(JY.Person[pid]["耍刀技巧"]*0.3+500)
		       xs = JY.Person[pid]["耍刀技巧"]*2.2
               str = "刀招枭若冷雪桃枝，似柔实刚。"
		elseif choice == 5 then
	           ng = math.ceil(JY.Person[pid]["轻功"]*2)
		       xs = JY.Person[pid]["轻功"]*1.8+JY.Person[pid]["耍刀技巧"]*1.8 
			   str = "以腿御刀，刀腿并用，回异难测。"  
		elseif choice == 6 then
	           ng = 900 + JY.Person[pid]["耍刀技巧"]
		       xs = JY.Person[pid]["耍刀技巧"]+600 
  			   str = "以静制动的一招至高无上一式。"   
		end
		if JY.Person[681]["天4"] == 1 then
		   xs = xs*1.25
		   if WAR.MXD[id] ~= nil then
		      xs = xs*1.25
		   end
		end
		xs = math.ceil(xs)
		DrawString(500, 510, str, C_GOLD, size*0.9)
		DrawString(500, 545, "招式气功："..ng, C_WHITE, size)
		DrawString(500, 580, "招式威力："..xs, C_WHITE, size)
		if WAR.AHCD[choice] == 0 or (match_ID(id, 681) and JY.Base["天书数量"] >= 10) then
			DrawString(500, 615, "冷却时间：无", C_WHITE, size)
		else
			DrawString(500, 615, "冷却时间："..WAR.AHCD[choice].."回合", C_WHITE, size)
		end
		if choice > 2 and JY.Base["天书数量"] < (choice - 2)*2-1 then
			DrawString(500, 650, -1+2*(choice - 2).."书后方可使用", C_WHITE, size)	
		elseif WAR.AHLQ[id][choice] > 0 then
		local cd = WAR.AHLQ[id][choice]
		if WAR.AHLQ[id][choice] > WAR.AHCD[choice] then
		   cd = WAR.AHCD[choice]
		end
			DrawString(500, 650, "冷却中，"..cd.."回合后可再次使用", C_WHITE, size)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.AHZS = choice
	if WAR.AHZS == 5 then
	local r = math.modf(JY.Person[pid]["轻功"]*0.02)+1
	if r > 10 then
	   r = 10
	end
	WAR.Person[WAR.CurID]["移动步数"] = r
	War_CalMoveStep(WAR.CurID, r, 0)
		local x, y = nil, nil
		while 1 do
		if JY.Restart == 1 then
			break
		end
		x, y = War_SelectMove()
		if x ~= nil then
		WAR.ShowHead = 0
		War_MovePerson(x, y)
		break;
		end 
		end
	end
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end

function YunShiZ(id,MiaofaWX)
	WAR.YSZZS = 0
	if not WAR.YSZLQ[id] then
		WAR.YSZLQ[id] = {0,0,0,0}
	end
	
	local zs={
	{name="雷霆无尽",Usable=true,m1=1,m2=4+MiaofaWX,a1=3,a2=2,a3=2},
	{name="风火无边",Usable=true,m1=0,m2=5,a1=2,a2=3+MiaofaWX,a3=3+MiaofaWX},
	{name="五情无敌",Usable=true,m1=1,m2=4,a1=1,a2=3+MiaofaWX,a3=3+MiaofaWX},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if WAR.YSZLQ[id][i] > 0 then
				zs[i].Usable=false
			end
			if WAR.YSZCD[i] == 0 then
			   zs[i].Usable=true
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		local str
		if choice == 1 then
		   str = "强制杀气200。"
		elseif choice == 2 then
		       str = "必灼烧，无视闪避。"
		elseif choice == 3 then
		       str = "连击伤害提高65%。"
		end
		DrawString(500, 510, str, C_WHITE, size)
		DrawString(500, 545, "招式气攻："..CC.KFMove[221][choice][2], C_WHITE, size)
		DrawString(500, 580, "冷却时间："..WAR.YSZCD[choice].."回合", C_WHITE, size)
        if WAR.YSZLQ[id][choice] > 0 then
		local cd = WAR.YSZLQ[id][choice]
		if WAR.YSZLQ[id][choice] > WAR.YSZCD[choice] then
		   cd = WAR.YSZCD[choice]
		end
			DrawString(500, 615, "冷却中，"..cd.."回合后可再次使用", C_WHITE, size)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.YSZZS = choice
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end

function YunShiJ(id,MiaofaWX)
	WAR.YSJZS = 0
	if not WAR.YSJLQ[id] then
		WAR.YSJLQ[id] = {0,0,0,0}
	end
	local zs={
	{name="剑留痕",Usable=true,m1=1,m2=2,a1=1,a2=2+MiaofaWX,a3=2+MiaofaWX},
	{name="剑流云",Usable=true,m1=3,m2=1,a1=10,a2=8+MiaofaWX,a3=7+MiaofaWX,a4=7+MiaofaWX},
	{name="剑流星",Usable=true,m1=0,m2=0,a1=5,a2=6+MiaofaWX,a3=5+MiaofaWX},
	{name="无极云十剑",Usable=true,m1=0,m2=5,a1=3,a2=2,a3=2},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if WAR.YSJLQ[id][i] > 0 then
				zs[i].Usable = false
			end
			if WAR.YSJCD[i] == 0 then
			   zs[i].Usable=true
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		local str
		if choice == 1 then
		   str = "额外附带200伤害。"
		elseif choice == 2 then
		       str = "攻击后可以移动6格。"
		elseif choice == 3 then
		       str = "额外范围。"
		elseif choice == 4 then
		       str = "三剑合一，伤害提高35%。"	   
		end
		DrawString(500, 510, str, C_WHITE, size)
		DrawString(500, 545, "招式气攻："..CC.KFMove[222][choice][2], C_WHITE, size)
		DrawString(500, 580, "冷却时间："..WAR.YSJCD[choice].."回合", C_WHITE, size)
        if WAR.YSJLQ[id][choice] > 0 then
		local cd = WAR.YSJLQ[id][choice]
		if WAR.YSJLQ[id][choice] > WAR.YSJCD[choice] then
		   cd = WAR.YSJCD[choice]
		end
			DrawString(500, 615, "冷却中，"..cd.."回合后可再次使用", C_WHITE, size)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.YSJZS = choice
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end

function SanFenZhaoShi(id,MiaofaWX)
	WAR.SFZS = 0
	if not WAR.SFLQ[id] then
		WAR.SFLQ[id] = {0,0,0,0}
	end
	local zs={
	{name="云无常",Usable=true,m1=1,m2=1,a1=1,a2=3+MiaofaWX,a3=3+MiaofaWX},
	{name="风无相",Usable=true,m1=3,m2=1,a1=10,a2=8+MiaofaWX,a3=7+MiaofaWX,a4=6+MiaofaWX},
	{name="霜无痕",Usable=true,m1=0,m2=0,a1=5,a2=6+MiaofaWX,a3=3+MiaofaWX},
	{name="摩诃无量",Usable=true,m1=0,m2=6,a1=3,a2=4+MiaofaWX,a3=4+MiaofaWX},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	if not PersonKF(id,90) then
		zs[4].Usable=false
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if WAR.SFLQ[id][i] > 0 then
				zs[i].Usable=false
			end
			if WAR.SFCD[i] == 0 then
			   zs[i].Usable=true
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(500, 520, "招式气攻："..CC.KFMove[29][choice][2], C_WHITE, size)
		if WAR.SFCD[choice] == 0 or match_ID(id, 74) then
			DrawString(500, 570, "冷却时间：无", C_WHITE, size)
		else
			DrawString(500, 570, "冷却时间："..WAR.SFCD[choice].."回合", C_WHITE, size)
		end
		if choice > 3 and not PersonKF(id,90) then
			DrawString(500, 620, "习得混元功后方可使用", C_WHITE, size)
		elseif WAR.SFLQ[id][choice] > 0 then
		local cd = WAR.SFLQ[id][choice]
		if WAR.SFLQ[id][choice] > WAR.SFCD[choice] then
		   cd = WAR.SFCD[choice]
		end
			DrawString(500, 620, "冷却中，"..cd.."回合后可再次使用", C_WHITE, size)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.SFZS = choice
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end

--无名，莫名剑法招式
function MoMing(id,MiaofaWX)
local pid = WAR.Person[WAR.CurID]["人物编号"]
	WAR.MMZS = 0
	if not WAR.MMLQ[id] then
		WAR.MMLQ[id] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
	end
	
	
	
	if WAR.LQZ[pid] == nil then
	   WAR.LQZ[pid] = 0 
	end
	local n = math.modf(WAR.LQZ[pid]*0.09)
	local zs={
	{name="一剑成名",Usable=true,m1=1,m2=2,a1=10,a2=20+MiaofaWX,a3=3},
	{name="莫名其妙",Usable=true,m1=0,m2=4,a1=5,a2=4+MiaofaWX,a3=3+MiaofaWX},
	{name="名动一时",Usable=true,m1=3,m2=1,a1=10,a2=7,a3=8+MiaofaWX,a4=7+MiaofaWX,a5=6+MiaofaWX},
	{name="悲痛莫名",Usable=true,m1=1,m2=4,a1=3,a2=2+MiaofaWX,a3=2+MiaofaWX},
	{name="隐姓埋名",Usable=true,m1=0,m2=0,a1=2,a2=3+MiaofaWX},
	{name="剑火无名",Usable=true,m1=3,m2=15,a1=10,a2=4+MiaofaWX+n,a3=4+MiaofaWX+n,a4=3+MiaofaWX+n,a5=2+MiaofaWX+n},
	{name="名不经传",Usable=true,m1=0,m2=5,a1=3,a2=2,a3=2},
	{name="名不虚传",Usable=true,m1=1,m2=4,a1=1,a2=3+MiaofaWX,a3=3+MiaofaWX},
	{name="名动江湖",Usable=true,m1=0,m2=10,a1=3,a2=2+MiaofaWX},
	{name="怨忿莫名",Usable=true,m1=0,m2=5,a1=2,a2=4+MiaofaWX},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	if JY.Base["天书数量"] < 1 then
			zs[1].Usable=false
	end
	--[[if JY.Base["天书数量"] < 2 then
			zs[3].Usable=false
	end]]
	--[[if JY.Base["天书数量"] < 3 then
			zs[5].Usable=false
	end]]
	--[[if JY.Base["天书数量"] < 4 then
			zs[6].Usable=false
	end]]
	if JY.Base["天书数量"] < 5 then
			zs[8].Usable=false
	end
	if JY.Base["天书数量"] < 6 then
			zs[4].Usable=false
	end
	if JY.Base["天书数量"] < 7 then
			zs[9].Usable=false
	end
    if JY.Base["天书数量"] < 10 then
			zs[10].Usable=false
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 560, 1+i*61, 1)
			local color = C_WHITE
			if WAR.MMLQ[id][i] > 0 then
				zs[i].Usable=false
			end
			if WAR.MMCD[i] == 0 then
			   zs[i].Usable=true
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(720, 4+i*61, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(568, 4+i*61, i, color, size*0.7)
			DrawString(592, 4+i*61, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 40, 500, 1)
		
		if WAR.LQZ[pid] == nil then
		   WAR.LQZ[pid] = 0
		end
		local xs
		--一剑成名
		if choice == 1 then
		   local n = JY.Base["天书数量"]*0.2
		   if n > 1.5 then
		      n = 1.5
		   end
		     xs = math.ceil(JY.Person[pid]["御剑能力"]*(1+n)+300)
		  

		  --莫名其妙
		elseif choice == 2 then
             xs = math.ceil(JY.Person[pid]["轻功"]+JY.Person[pid]["御剑能力"]*0.5+300)
		  --名动一时
		elseif choice == 3 then
		     xs= math.ceil(JY.Person[pid]["御剑能力"]*0.5+JY.Person[pid]["攻击力"]*1.2)
		  --悲痛莫名
		elseif choice == 4 then
		  if WAR.LQZ[pid] == 100 then
		     xs = math.ceil(JY.Person[pid]["御剑能力"]*4*(JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])/JY.Person[pid]["生命最大值"]+200)
		  else
		     xs = math.ceil(JY.Person[pid]["御剑能力"]+WAR.LQZ[pid]*3+(JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])*0.2)
		  end
		 
		  --隐姓埋名
		elseif choice == 5 then
		     xs = math.ceil(JY.Person[pid]["攻击力"]+JY.Person[pid]["内力"]*0.05)
		  --剑火无名
		elseif choice == 6 then
		     xs = math.ceil((WAR.LQZ[pid]/50)*JY.Person[pid]["御剑能力"]+700)
          --名不经传		  
		elseif choice == 7 then
		     xs = math.ceil(JY.Person[pid]["攻击力"]+200)
		  --名不虚传
		elseif choice == 8 then
		     xs = math.ceil(JY.Person[pid]["御剑能力"]+500)
		  --名动江湖
		elseif choice == 9 then
		     xs = math.ceil(JY.Person[pid]["御剑能力"]*2*((JY.Base["天书数量"]+1)/15))
		  --怨忿莫名
		elseif choice == 10 then
		     xs = math.ceil(JY.Person[pid]["御剑能力"]+JY.Person[pid]["内力"]*0.07)
		  
		end
		--平衡
		if xs > 1600 then
	      xs = 1600 + (xs - 1600)*0.4
		  if xs > 1800 then
		     xs = 1800 + (xs - 1800)*0.3
			 if xs > 2000 then
			    xs = 2000 + (xs - 2000)*0.2
			 end
		  end
		end
		xs = math.modf(xs)
		
		
		--一剑成名
		if choice == 1 then
		   local n = JY.Base["天书数量"]*0.2
		   if n > 1.5 then
		      n = 1.5
		   end

		     DrawString(50, 510, "招式气攻："..math.ceil(JY.Person[pid]["御剑能力"]*(1+n)), C_WHITE, size)
		     DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  
		  DrawString(50, 580, "只出一剑，一剑成名", C_GOLD, size*0.8)
		  --莫名其妙
		elseif choice == 2 then
		  DrawString(50, 510, "招式气攻："..math.ceil(JY.Person[pid]["轻功"]*1.5+300), C_WHITE, size)
		  DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  DrawString(50, 580, "剑路出乎意料，使敌方无法躲避", C_GOLD, size*0.8)
		  --名动一时
		elseif choice == 3 then
		  DrawString(50, 510, "招式气攻："..math.ceil(JY.Person[pid]["御剑能力"]*0.8+JY.Person[pid]["攻击力"]*1.5), C_WHITE, size)
		  DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  DrawString(50, 580, "以静制动，高几率击中敌方破绽", C_GOLD, size*0.8)
		  --悲痛莫名
		elseif choice == 4 then
		  if WAR.LQZ[pid] == 100 then
		     DrawString(50, 510, "招式气攻："..math.ceil(JY.Person[pid]["御剑能力"]+500), C_WHITE, size)
		     DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  else
		     DrawString(50, 510, "招式气攻："..math.ceil(JY.Person[pid]["御剑能力"]+WAR.LQZ[pid]*3), C_WHITE, size)
		     DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  end
		  DrawString(50, 580, "生命值越低、怒气值越高威力越高", C_GOLD, size*0.8)
		  --隐姓埋名
		elseif choice == 5 then
		  DrawString(50, 510, "招式气攻："..math.ceil(JY.Person[pid]["内力"]*0.1), C_WHITE, size)
		  DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  DrawString(50, 580, "使用后剑气护体，减少受到的伤害和气攻", C_GOLD, size*0.8)
		  DrawString(50, 605, "每受到攻击持续时间减少5时序", M_DeepSkyBlue, size*0.8)
		  DrawString(300, 655, "持续时序：".. math.ceil(50 + JY.Person[pid]["御剑能力"]*0.03), M_DeepSkyBlue, size*0.8)
		  --剑火无名
		elseif choice == 6 then
		  DrawString(50, 510, "招式气攻："..math.ceil((WAR.LQZ[pid]/60)*JY.Person[pid]["御剑能力"]+400), C_WHITE, size)
		  DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  DrawString(50, 580, "威力随怒气提高，怒气80以上附带灼烧", C_GOLD, size*0.8)
		  DrawString(50, 600, "暴怒攻击会点燃目标", C_GOLD, size*0.8)
          --名不经传		  
		elseif choice == 7 then
		  DrawString(50, 510, "招式气攻："..math.ceil(JY.Person[pid]["攻击力"]), C_WHITE, size)
		  DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  DrawString(50, 580, "看似平平无奇，实则剑意披靡", C_GOLD, size*0.8)
		  --名不虚传
		elseif choice == 8 then
		  DrawString(50, 510, "招式气攻："..math.ceil(JY.Person[pid]["御剑能力"]*1.1), C_WHITE, size)
		  DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  DrawString(50, 580, "用伶俐的剑法攻击敌人，必破气防流血", C_GOLD, size*0.8)
		  --名动江湖
		elseif choice == 9 then
		  DrawString(50, 510, "招式气攻："..math.ceil(JY.Person[pid]["御剑能力"]*2), C_WHITE, size)
		  DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  DrawString(50, 580, "一剑一出，四座皆惊", C_GOLD, size*0.8)
		  DrawString(50, 605, "锁定周围八格敌人攻击", C_GOLD, size*0.8)
		  --怨忿莫名
		elseif choice == 10 then
		  DrawString(50, 510, "招式气攻："..math.ceil(2000+JY.Person[pid]["御剑能力"]), C_WHITE, size)
		  DrawString(50, 545, "招式威力："..xs, C_WHITE, size)
		  DrawString(50, 580, "敌方剑灵怨气缠身，集气减慢，怒气减少", C_GOLD, size*0.8)
		  DrawString(300, 655, "持续时序：".. 5 + math.modf(JY.Person[pid]["内力"]*0.0005+JY.Person[pid]["御剑能力"]*0.01), M_DeepSkyBlue, size*0.8)
		  
		end
		if WAR.MMCD[choice] == 0 or JY.Person[id]["专1"] == 199 then
			DrawString(50, 650, "冷却时间：无", C_WHITE, size)
		else
			DrawString(50, 650, "冷却时间："..WAR.MMCD[choice].."回合", C_WHITE, size)
		end
		if choice == 1 and JY.Base["天书数量"] < 1 then --1356849
			DrawString(50, 620, "一书后可使用", C_WHITE, size)
		--[[elseif choice == 3 and JY.Base["天书数量"] < 2 then
			DrawString(50, 620, "两书后可使用", C_WHITE, size)
		elseif choice == 5 and JY.Base["天书数量"] < 3 then
			DrawString(50, 620, "三书后可使用", C_WHITE, size)
		elseif choice == 6 and JY.Base["天书数量"] < 4 then
			DrawString(50, 620, "四书后可使用", C_WHITE, size)]]
		elseif choice == 8 and JY.Base["天书数量"] < 5 then
			DrawString(50, 620, "五书后可使用", C_WHITE, size)	
		elseif choice == 4 and JY.Base["天书数量"] < 6 then
			DrawString(50, 620, "六书后可使用", C_WHITE, size)
		elseif choice == 9 and JY.Base["天书数量"] < 7 then
			DrawString(50, 620, "七书后可使用", C_WHITE, size)
		elseif choice == 10 and JY.Base["天书数量"] < 10 then
			DrawString(50, 620, "十书后可使用", C_WHITE, size)
		elseif WAR.MMLQ[id][choice] > 0 then
		local cd = WAR.MMLQ[id][choice]
		if WAR.MMLQ[id][choice] > WAR.MMCD[choice] then
		   cd = WAR.MMCD[choice]
		end
			DrawString(50, 620, "冷却中，"..cd.."回合后可再次使用", C_WHITE, size)
		end
		
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
				WAR.MMZSX = 10
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
				WAR.MMZSX = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.MMZS = choice
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end
--m1为移动范围斜向延伸：
	--0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
  --m2为移动范围直线延伸；
	--数字即等于延伸距离
  --a1为攻击范围类型：
	--0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：d字，9：e字，10：直线，11：正三角，12：倒三角，13：横线
  --a2为攻击范围长度距离：
	--0：点攻，大于0时，距离 = a2
  --a3为攻击范围宽度(偏移1格)距离：
	--0：点攻，大于0时，距离 = a3  
  --a4为攻击范围宽度(偏移2格)距离：
	--0：点攻，大于0时，距离 = a4
  --a5为攻击范围宽度(偏移3格)距离：
	--0：点攻，大于0时，距离 = a5
function LiuMaiZhaoShi(id,MiaofaWX)
local pid = WAR.Person[WAR.CurID]["人物编号"]
	WAR.LMZS = 0
	if not WAR.LMLQ[id] then
		WAR.LMLQ[id] = {0,0,0,0,0,0}
	end
	
	local zs={
	{name="少冲剑",Usable=true,m1=3,a1=10,a2=10+MiaofaWX,a3=10+MiaofaWX,a4=8+MiaofaWX},
	{name="商阳剑",Usable=true,m1=1,m2=6+MiaofaWX,a1=5,a2=2,a3=2},
	{name="中冲剑",Usable=true,m1=3,a1=10,a2=8+MiaofaWX,a3=7+MiaofaWX,a4=6+MiaofaWX,a5=5+MiaofaWX},
	{name="少泽剑",Usable=true,m1=3,a1=10,a2=9+MiaofaWX,a3=9+MiaofaWX},
	{name="关冲剑",Usable=true,m1=1,m2=3,a1=10,a2=5+MiaofaWX,a3=5+MiaofaWX,a4=5+MiaofaWX,a5=5+MiaofaWX},
	{name="少商剑",Usable=true,m1=3,a1=10,a2=6+MiaofaWX,a3=7+MiaofaWX,a4=8+MiaofaWX,a5=9+MiaofaWX},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	if JY.Base["天书数量"] < 4 then
			zs[2].Usable=false
	end
	if JY.Base["天书数量"] < 5 then
			zs[3].Usable=false
	end
	if JY.Base["天书数量"] < 6 then
			zs[4].Usable=false
	end
	if JY.Base["天书数量"] < 7 then
			zs[5].Usable=false
	end
    if JY.Base["天书数量"] < 8 then
			zs[6].Usable=false
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 560, 1+i*61, 1)
			local color = C_WHITE
			if WAR.LMLQ[id][i] > 0 then
				zs[i].Usable=false
			end
			if WAR.LMCD[i] == 0 then
			   zs[i].Usable=true
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(720, 4+i*61, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(568, 4+i*61, i, color, size*0.7)
			DrawString(592, 4+i*61, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 40, 500, 1)
		--少冲剑
		if choice == 1 then
		  DrawString(50, 560, "使用后下回合集气+200", C_GOLD, size*0.8)
		  --商阳剑
		elseif choice == 2 then
		  DrawString(50, 560, "无视闪避，且必定击中破绽", C_GOLD, size*0.8)
		  --中冲剑
		elseif choice == 3 then
		  DrawString(50, 560, "强制杀气300", C_GOLD, size*0.8)
		  --少泽剑
		elseif choice == 4 then
		  DrawString(50, 560, "每次攻击前都可移动一次", C_GOLD, size*0.8)
		  --关冲剑
		elseif choice == 5 then
		  DrawString(50, 560, "使敌方集气降低，如果低于你则将其眩晕", C_GOLD, size*0.8)
		  --少商剑
		elseif choice == 6 then
		  DrawString(50, 560, "无视100%防御和气防", C_GOLD, size*0.8)
		  DrawString(50, 595, "50%几率致残效果10时序", C_GOLD, size*0.8)
		end
		
		if WAR.LMCD[choice] == 0 then
			DrawString(50, 650, "冷却时间：无", C_WHITE, size)
		else
			DrawString(50, 650, "冷却时间："..WAR.LMCD[choice].."回合", C_WHITE, size)
		end
		if choice == 2 and JY.Base["天书数量"] < 4 then
			DrawString(50, 620, "四书后可使用", C_WHITE, size)
		elseif choice == 3 and JY.Base["天书数量"] < 5 then
			DrawString(50, 620, "五书后可使用", C_WHITE, size)	
		elseif choice == 4 and JY.Base["天书数量"] < 6 then
			DrawString(50, 620, "六书后可使用", C_WHITE, size)
		elseif choice == 5 and JY.Base["天书数量"] < 7 then
			DrawString(50, 620, "七书后可使用", C_WHITE, size)
		elseif choice == 6 and JY.Base["天书数量"] < 8 then
			DrawString(50, 620, "八书后可使用", C_WHITE, size)
		elseif WAR.LMLQ[id][choice] > 0 and WAR.LMCD[choice] > 0 then
		  local cd = WAR.LMLQ[id][choice]
		  if WAR.LMLQ[id][choice] > WAR.LMCD[choice] then
		     cd = WAR.LMCD[choice]
		  end
		   DrawString(50, 620, "冷却中，"..cd.."回合后可再次使用", C_WHITE, size)
		end
		
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
				WAR.LMZSX = 10
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
				WAR.LMZSX = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.LMZS = choice
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end

--太玄招式
function TaiXuanZhaoShi()
	WAR.TXZS = 0
	local zs={
	{name="太玄神功・拳"},
	{name="太玄神功・指"},
	{name="太玄神功・剑"},
	{name="太玄神功・刀"},
	{name="太玄神功・奇"}
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)

	local choice = 1

	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE

			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 123+i*50, zs[i].name, color, size*0.9)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(500, 520, CC.KFMove[102][choice][1], C_WHITE, size)

		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			break
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs then
				choice = input
				break
			end
		end
	end
	WAR.TXZS = choice
	return
end

--判定可否使用某武功
function skill_usable(pid, tmp)
	local r = true
	--内功
	if JY.Wugong[tmp]["武功类型"] == 6 then
		if inteam(pid) then
			r = false
		else
			r = true
		end
		if JY.Base["标准"] == 6 and pid == 0 and tmp ~= 144 and tmp ~= 87 and tmp ~= 175 then
		    r = true
		end
	end 

	--斗转星移
	if (WAR.WGJY[pid] == tmp or (WAR.WGJY2[pid] ~= nil and WAR.WGJY3[pid] == tmp)) then
	   r = false
	end   
	
	--轻功无法攻击
	if JY.Wugong[tmp]["武功类型"] == 7 then
		r = false
	end
		   
	--石破天 显示太玄神功
	if tmp == 102 and (match_ID_awakened(pid, 38, 1) or JY.Person[pid]["专2"] == 102) then
		r = true
	end
	--华英雄，显示中华傲诀
	if tmp == 213 and match_ID(pid, 675) then
		r = true
	end
	
	--无名，剑血浮生
	if tmp == 200 and WAR.LQZ[pid] ~= 100 then
		r = false
	elseif tmp == 200 then
	    r = true
	end
		  
	--狄云 显示神经照
	if tmp == 94 and match_ID(pid, 37) then
		r = true
	end
	
	--丁典 显示神经照
	if tmp == 94 and match_ID(pid, 672) then
		r = true
	end
	
	if tmp == 106 and match_ID(pid, 638) then
		r = true
	end
			
	--小昭 显示圣火
	if tmp == 93 and match_ID(pid, 66) then
		r = true
	end
	
	if tmp == 92 and match_ID(pid, 13) and JY.Person[13]["阶"] >= 1 then
		r = true
	end
	
	if tmp == 207 and match_ID(pid, 22) and JY.Person[22]["阶"] >= 2 then
		r = true
	end
	
	--[[独孤九剑
	if tmp == 47 then
	   if match_ID(pid, 140) then
	      r = true
	   else
	      r = false
	   end
	end]]
	
	--黯然掌限制
	if tmp == 25 then
	if ((JY.Person[pid]["受伤程度"] >= 70 or (JY.Person[pid]["生命"] <= JY.Person[pid]["生命最大值"] * 0.3)) or JY.Person[pid]["专2"] == 25) then
		r = true
	elseif JY.Person[58]["阶"] >= 1 and match_ID(pid, 58) then
	    r = true
	else
		r = false
	end
	end
	if tmp == 221 and WAR.YSZLQ[pid] ~= nil then
	local s = 0
       for i = 1,#WAR.YSZCD do
	       if WAR.YSZLQ[pid][i] >= WAR.YSZCD[i] then
		      s = s + 1
		   end	  
	   end
	if s >= #WAR.YSZCD then
	   r = false
	end
        	
	end
	--云十剑
	if tmp == 222 and WAR.YSJLQ[pid] ~= nil then
	local s = 0
       for i = 1,#WAR.YSJCD do
	       if WAR.YSJLQ[pid][i] >= WAR.YSJCD[i] then
		      s = s + 1
		   end	  
	   end
	if s >= #WAR.YSJCD then
	   r = false
	end
        	
	end
	--三分
	if tmp == 29 and WAR.SFLQ[pid] ~= nil then
	local s = 0
       for i = 1,#WAR.SFCD do
	       if WAR.SFLQ[pid][i] >= WAR.SFCD[i] then
		      s = s + 1
		   end	  
	   end
	if s >= #WAR.SFCD then
	   r = false
	end
        	
	end
	--[[破颜拳
	if tmp == 223 then
	  if WAR.LQZ[pid] == nil or WAR.LQZ[pid] < 100 or JY.Person[pid]["生命"] > JY.Person[pid]["生命最大值"] * 0.5 then
	     r = false
	  end
	end]]
	--杨过，以袖代掌
	if match_ID(pid, 58) and WAR.ZYHB == 2 and JY.Wugong[tmp]["武功类型"] ~= 1 and tmp ~= 225 then
	   r = false
	end
	
	--瞬狱杀使用限制
	if tmp == 204 and WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 150 and WAR.SYBD[pid] ~= nil and WAR.SYBD[pid] > 85 then
		r = true
	elseif tmp == 204 then
        r = false	
	end
	
	--赤鸦空裂破使用限制
	if tmp == 205 and WAR.NLZ[pid] ~= nil and WAR.NLZ[pid] >= 150 then
		r = true
	elseif tmp == 205 then
        r = false	
	end
	
	if (JY.Person[674]["品德"] == 1 or JY.Person[674]["品德"] == 10) and pid == 0 and JY.Wugong[tmp]["武功类型"] < 6 then
	   r = true
	end
	
	--武功冷却
	if WAR.KungfuLQ[pid][tmp] ~= nil then
	   r = false
	end
	
	if WAR.PTGJ[pid] ~= nil and tmp ~= 225 then
	   tmp = false
	end
	
	return r
end

G["NPC内功补完系统"] = function(id)
	local l = {}
	l[1]={"胡氏心法",500}	--胡斐
	l[3]={"金佛功",800}		--苗人凤
	l[6]={"峨眉九阳功",900}	--灭绝
	l[7]={"昆仑心法",700}	--何太冲
	l[8]={"崆峒心法",700}	--唐文亮
	l[12]={"光明心法",700}	--殷天正
	l[14]={"光明心法",700}	--韦一笑
	l[15]={"光明心法",700}	--黛绮丝
	l[20]={"衡山心法",600}	--莫大
	l[21]={"恒山心法",600}	--定闲
	l[22]={"嵩山心法",600}	--左冷禅
	l[23]={"泰山心法",600}	--天门
	l[24]={"青冥玄功",500}	--余沧海
	l[43]={"雪山心法",500}	--白万剑
	l[44]={"吐纳心法",600}	--岳老三
	l[46]={"龟息功",1000}	--丁春秋
	l[51]={"慕容心法",800}	--慕容复
	l[68]={"全真内功",800}	--丘处机
	l[72]={"天龙心法",500}	--田归农
	l[75]={"天池心法",800}	--陈家洛
	l[98]={"天南易阳决",800}--段延庆
	l[99]={"吐纳心法",600}	--叶二娘
	l[100]={"吐纳心法",600}	--云中鹤
	l[107]={"华山心法",700}	--矮老者
	l[108]={"华山心法",700}	--高老者
	l[109]={"华山心法",700}	--鲜于通
	l[119]={"天南易阳决",800}	--点苍渔隐
	l[120]={"天南易阳决",800}	--樵夫
	l[121]={"天南易阳决",800}	--武三通
	l[122]={"天南易阳决",800}	--朱子柳
	l[123]={"全真内功",800}
	l[124]={"全真内功",800}
	l[125]={"全真内功",800}
	l[126]={"全真内功",800}
	l[127]={"全真内功",800}
	l[128]={"全真内功",800}
	l[141]={"华山心法",700} --成不忧
	l[142]={"华山心法",700}	--封不平
	l[150]={"昆仑心法",700}	--冯锡范
	l[151]={"红花心法",500}
	l[152]={"红花心法",500}
	l[153]={"红花心法",500}
	l[154]={"红花心法",500}
	l[155]={"红花心法",500}
	l[156]={"红花心法",500}
	l[157]={"鬼王心经",1000}	--潇湘子
	l[158]={"波斯内功",1000}	--尹克西
	l[159]={"释迦掷象功",1000}	--尼摩星
	l[162]={"丁氏心法",500} --丁不三
	l[163]={"丁氏心法",500} --丁不四
	--何红药，华山众咸鱼
	for i = 176, 183 do
		l[i]={"培息功",500}
	end
	l[41]={"培息功",500}
	l[42]={"培息功",500}
	l[186]={"培息功",500}
	l[187]={"培息功",500}
	l[188]={"培息功",500}
	--其他咸鱼
	for i = 130, 139 do
		l[i]={"养元功",500}
	end
	--其他咸鱼
	for i = 31, 34 do
		l[i]={"养元功",500}
	end
	if l[id] then
		return l[id][1], l[id][2]
	else
		return nil
	end
end

--圆月弯刀的世界
function S_Event_YYWD()
	JY.Dream = 1
	CleanMemory()
	lib.PicInit()
	lib.PicLoadFile(CC.SMAPPicFile[1], CC.SMAPPicFile[2], 0)	--子场景贴图，内存区域0
	lib.LoadPNGPath(CC.HeadPath, 1, CC.HeadNum, limitX(CC.ScreenW/936*100,0,100))	--人物头像，内存区域1
	lib.LoadPNGPath(CC.UIPath, 96, CC.UINum, limitX(CC.ScreenW/936*100,0,100))
	lib.PicLoadFile(CC.ThingPicFile[1], CC.ThingPicFile[2], 2, 100, 100)	--物品贴图，内存区域2
	JY.Status = GAME_SMAP
	lib.FillColor(0, 0, 0, 0, 0)
	DrawString(CC.ScreenW/2-210, CC.ScreenH/2-80, '你在战斗中受了重伤……', C_WHITE, 40)
	DrawString(CC.ScreenW/2-300, CC.ScreenH/2, '恍惚中似乎来到了另一个世界……', C_WHITE, 40)
	ShowScreen()
	lib.Delay(1000)
	dark()
	local old_SubSceneID = JY.SubScene
	local old_RX = JY.Base["人X1"]
	local old_RY = JY.Base["人Y1"]
	local old_Direct = JY.Base["人方向"]
	local old_oldDPass = JY.OldDPass
	local old_oldSmapX = JY.oldSMapX
	local old_oldSmapY = JY.oldSMapY
	local old_D_Valid = JY.D_Valid
	local old_SubSceneX = JY.SubSceneX
	local old_SubSceneY = JY.SubSceneY
	local old_CurrentD = JY.CurrentD
	JY.SubSceneX=0
	JY.SubSceneY=0
	JY.SubScene = 125
	JY.Base["人X1"] = 16
	JY.Base["人Y1"] = 44
	JY.Base["人方向"] = 0
	stands()
	light()
	while 1 do
		if JY.Restart == 1 then
			JY.Dream = 0
			break
		end
		local t1=lib.GetTime()
		JY.Mytick=JY.Mytick+1    --20个节拍无击键，则主角变为站立状态
		if JY.Mytick%20==0 then
			JY.MyCurrentPic=0
		end
		if JY.Mytick%1000==0 then
			JY.MYtick=0
		end
		DrawSMap()
		if CC.ShowXY==1 then
			DrawString(10,CC.ScreenH-60,string.format("%s %d %d",JY.Scene[JY.SubScene]["名称"],JY.Base["人X1"],JY.Base["人Y1"]) ,C_GOLD,CC.Fontsmall)
		end
		DrawTimer()
		JYZTB()
		ShowScreen()
		local d_pass=GetS(JY.SubScene,JY.Base["人X1"],JY.Base["人Y1"],3)   --当前路过事件
		if d_pass>=0 then
			if d_pass ~=JY.OldDPass then     --避免重复触发
				EventExecute(d_pass,3)       --路过触发事件
				JY.OldDPass=d_pass
				JY.oldSMapX=-1
				JY.oldSMapY=-1
				JY.D_Valid=nil
			end
			JY.OldDPass=-1
		end
		local x,y
		local direct = -1
		local keypress, ktype, mx, my = lib.GetKey()
		--先检测跟上次不同的方向是否被按下
		for i = VK_RIGHT,VK_UP do
			if i ~= CC.PrevKeypress and lib.GetKeyState(i) ~=0 then
				keypress = i
			end
		end 
		--如果与上次不同的方向未被按下，则检测与上次相同的方向是否被按下
		if keypress==-1 and	lib.GetKeyState(CC.PrevKeypress) ~=0 then
			keypress = CC.PrevKeypress
		end
		CC.PrevKeypress = keypress
		if keypress==VK_UP then
			direct=0;
			JY.WalkCount = JY.WalkCount + 1
		elseif keypress==VK_DOWN then
			direct=3;
			JY.WalkCount = JY.WalkCount + 1
		elseif keypress==VK_LEFT then
			direct=2;
			JY.WalkCount = JY.WalkCount + 1
		elseif keypress==VK_RIGHT then
			direct=1;
			JY.WalkCount = JY.WalkCount + 1
		else
			JY.WalkCount = 0
		end
		if ktype == 1 then
			JY.Mytick=0
			if keypress==VK_SPACE or keypress==VK_RETURN then       --空格触发事件
				if JY.Base["人方向"]>=0 then
					local d_num=GetS(JY.SubScene,JY.Base["人X1"]+CC.DirectX[JY.Base["人方向"]+1],JY.Base["人Y1"]+CC.DirectY[JY.Base["人方向"]+1],3)
					if d_num>=0 then
						EventExecute(d_num,1)
					end
				end
			elseif keypress == VK_ESCAPE then
				DrawStrBoxWaitKey("当前场景无法使用菜单！", C_RED, CC.DefaultFont)
			elseif keypress == VK_S then
				DrawStrBoxWaitKey("当前场景无法存档！", C_RED, CC.DefaultFont)
			elseif keypress == VK_L then
				DrawStrBoxWaitKey("当前场景无法读档！", C_RED, CC.DefaultFont)
			end
		elseif ktype == 3 then
			AutoMoveTab = {[0]=0}
			local x0 = JY.Base["人X1"]
			local y0 = JY.Base["人Y1"]
			local px=x0
			local py=y0
			if CONFIG.Zoom == 100 then
				--无酒不欢：修正在地图边界自动寻路错误的问题
				px=limitX(x0,13,46)
				py=limitX(y0,13,46)
			else
				px=x0
				py=y0
			end
			mx = mx + (px-py)*CC.XScale - CC.ScreenW/2
			my = my + (px+py)*CC.YScale - CC.ScreenH/2
			local xx = (mx/CC.XScale + my/CC.YScale)/2;
			local yy = (my/CC.YScale - mx/CC.XScale)/2;	
			if xx - math.modf(xx) > 0 then
				xx = math.modf(xx)
			end
			if yy - math.modf(yy) > 0 then
				yy = math.modf(yy)
			end	
			if CONFIG.Zoom ~= 100 then		--无酒不欢：不知道什么毛病，反正不加就是有毛病
				xx = xx + 1
				yy = yy + 1
			end
			if xx > 0 and xx < CC.SWidth and yy > 0 and yy < CC.SHeight then
				walkto(xx - x0,yy - y0)
			end
		end
		if JY.Dream == 0 then
			JY.SubScene = old_SubSceneID
			JY.Base["人X1"] = old_RX
			JY.Base["人Y1"] = old_RY
			JY.Base["人方向"] = old_Direct
			JY.OldDPass=old_oldDPass
			JY.oldSMapX=old_oldSmapX
			JY.oldSMapY=old_oldSmapY
			JY.D_Valid=old_D_Valid
			JY.SubSceneX=old_SubSceneX
			JY.SubSceneY=old_SubSceneY
			JY.CurrentD = old_CurrentD
			break
		end
		
		--无酒不欢：有标记事件坐标，且自动走到前面一格才会触发事件
		if CC.AutoMoveEvent[1] ~= 0 and 
		(JY.Base["人X1"] == CC.AutoMoveEvent[1] or JY.Base["人X1"] - 1 == CC.AutoMoveEvent[1] or JY.Base["人X1"] + 1 == CC.AutoMoveEvent[1]) and 
		(JY.Base["人Y1"] == CC.AutoMoveEvent[2] or JY.Base["人Y1"] - 1 == CC.AutoMoveEvent[2] or JY.Base["人Y1"] + 1 == CC.AutoMoveEvent[2]) then
			CC.AutoMoveEvent[0] = 1			--鼠标操作触发事件
		end
		
		if AutoMoveTab[0] ~= 0 then			--鼠标自动走动
			if direct == -1 then
				direct = AutoMoveTab[AutoMoveTab[0]]
				AutoMoveTab[AutoMoveTab[0]] = nil
				AutoMoveTab[0] = AutoMoveTab[0] - 1
			end
		else
			AutoMoveTab = {[0] = 0}
			if CC.AutoMoveEvent[0] == 1 then
				EventExecute(GetS(JY.SubScene,CC.AutoMoveEvent[1],CC.AutoMoveEvent[2],3),1);
				CC.AutoMoveEvent[0] = 0
				CC.AutoMoveEvent[1] = 0
				CC.AutoMoveEvent[2] = 0
			end
		end
		
		if direct ~= -1 then
			AddMyCurrentPic()
			x=JY.Base["人X1"]+CC.DirectX[direct+1]
			y=JY.Base["人Y1"]+CC.DirectY[direct+1]
			JY.Base["人方向"]=direct
			if JY.WalkCount == 1 then
				lib.Delay(90)
			end
		else
			x=JY.Base["人X1"]
			y=JY.Base["人Y1"]
		end
		JY.MyPic=GetMyPic()
		DtoSMap()
		if SceneCanPass(x,y)==true then          --新的坐标可以走过去
			JY.Base["人X1"]=x
			JY.Base["人Y1"]=y
		end
		JY.Base["人X1"]=limitX(JY.Base["人X1"],1,CC.SWidth-2)
		JY.Base["人Y1"]=limitX(JY.Base["人Y1"],1,CC.SHeight-2)
		
		collectgarbage("step", 0)
		local t2=lib.GetTime()
		if t2-t1<CC.Frame then
			lib.Delay(CC.Frame-(t2-t1))
		end
	end
end



